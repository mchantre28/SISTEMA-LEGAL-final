<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Legal - Gest√£o Jur√≠dica</title>
    <meta name="theme-color" content="#111827">
    
    <!-- Meta Tags B√°sicas -->
    <meta name="description" content="Sistema completo de gest√£o jur√≠dica para Solicitadores">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #000000;
            --secondary-color: #374151;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #3b82f6;
        }

        /* Modo Escuro */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #1f2937;
                --secondary-color: #4b5563;
            }
        }

        [data-theme="dark"] {
            --primary-color: #1f2937;
            --secondary-color: #4b5563;
        }

        [data-theme="dark"] body {
            background-color: #111827;
            color: #f9fafb;
        }

        [data-theme="dark"] .card {
            background-color: #1f2937;
            border-color: #374151;
            color: #f9fafb;
        }

        [data-theme="dark"] .sidebar {
            background: #111827 !important;
        }

        [data-theme="dark"] .main-content {
            background-color: #111827;
        }

        [data-theme="dark"] .table-responsive {
            background-color: #1f2937;
        }

        [data-theme="dark"] .table-responsive th,
        [data-theme="dark"] .table-responsive td {
            border-color: #374151;
            color: #f9fafb;
        }

        [data-theme="dark"] .modal-content {
            background-color: #1f2937;
            color: #f9fafb;
        }

        [data-theme="dark"] .btn {
            color: #f9fafb;
        }

        [data-theme="dark"] .btn-primary {
            background: #3b82f6;
        }

        [data-theme="dark"] .btn-secondary {
            background: #6b7280;
        }

        [data-theme="dark"] .btn-success {
            background: #10b981;
        }

        [data-theme="dark"] .btn-warning {
            background: #f59e0b;
        }

        [data-theme="dark"] .btn-error {
            background: #ef4444;
        }

        [data-theme="dark"] .btn-info {
            background: #3b82f6;
        }

        .sidebar { 
            background: var(--primary-color) !important; 
            min-height: 100vh !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 280px !important;
            min-width: 280px !important;
            max-width: 280px !important;
            z-index: 1000 !important;
            transition: all 0.3s ease;
            overflow-y: auto;
        }
        
        /* FOR√áAR LARGURA EM DESKTOP */
        @media (min-width: 1025px) {
            .sidebar {
                width: 280px !important;
                min-width: 280px !important;
                max-width: 280px !important;
            }
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
                transform: translateX(-100%);
                overflow-y: auto;
                max-height: 100vh;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 180px;
            }
        }
        
        @media (max-width: 480px) {
            .sidebar {
                width: 160px;
            }
            
            .sidebar-item {
                padding: 6px 8px;
                font-size: 12px;
            }
            
            .sidebar h2 {
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            .sidebar-item i {
                width: 16px;
                height: 16px;
                margin-right: 8px;
            }
        }

        .sidebar-item { 
            color: #ffffff !important; 
            transition: all 0.2s ease;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 4px 8px;
            display: flex;
            align-items: center;
            text-decoration: none;
            cursor: pointer;
        }
        
        @media (max-width: 1024px) {
            .sidebar-item {
                padding: 10px 14px;
                font-size: 14px;
                margin: 2px 6px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar-item {
                padding: 8px 12px;
                font-size: 13px;
                margin: 2px 4px;
            }
        }
        
        @media (max-width: 1024px) {
            .sidebar h2 {
                font-size: 18px;
                padding: 16px 20px 8px 20px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar h2 {
                font-size: 16px;
                padding: 12px 16px 6px 16px;
            }
        }

        .sidebar-item:hover { 
            background: rgba(255, 255, 255, 0.1); 
            transform: translateX(4px);
        }
        
        .sidebar-item.active { 
            background: var(--secondary-color); 
            border-left: 4px solid #6b7280;
        }

        .main-content {
            margin-left: 280px;
            transition: margin-left 0.3s ease;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                margin-left: 0;
            }
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 1024px) {
            .mobile-menu-btn {
                display: block;
            }
        }

        @media (max-width: 1024px) {
            .mobile-menu-btn {
                display: block;
            }
            
            .sidebar {
                transform: translateX(-100%);
                width: 100% !important;
                max-width: 320px !important;
                z-index: 1000;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0 !important;
                padding-top: 80px;
            }
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .main-content {
                padding: 10px;
            }
            
            .card {
                margin-bottom: 16px;
                padding: 16px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            /* Tabelas responsivas */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table-responsive table {
                min-width: 600px;
            }
            
            /* Modais mobile */
            .modal-content {
                margin: 10px;
                max-height: calc(100vh - 20px);
                overflow-y: auto;
            }
            
            /* Bot√µes de a√ß√£o menores */
            .btn-sm {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            /* Grid responsivo */
            .grid-cols-1 {
                grid-template-columns: 1fr !important;
            }
            
            .md\\:grid-cols-3 {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 5px;
            }
            
            .card {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .btn {
                padding: 10px 14px;
                font-size: 13px;
            }
            
            .sidebar-item {
                padding: 10px 12px;
                font-size: 14px;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }

        .card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-error {
            background: var(--error-color);
            color: white;
        }

        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--error-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pendente {
            background: #fef3c7;
            color: #92400e;
        }

        .status-pago {
            background: #d1fae5;
            color: #065f46;
        }

        .status-vencido {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-ativo {
            background: #d1fae5;
            color: #065f46;
        }

        .status-inativo {
            background: #e5e7eb;
            color: #374151;
        }

        .status-suspenso {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Status das √Åreas de Execu√ß√£o */
        .status-pendente {
            background: #fef3c7;
            color: #92400e;
        }

        .status-em_andamento {
            background: #fef3c7;
            color: #92400e;
        }

        .status-concluido {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Status de Prioridade dos Prazos */
        .status-baixa {
            background: #f3f4f6;
            color: #374151;
        }

        .status-media {
            background: #fef3c7;
            color: #92400e;
        }

        .status-alta {
            background: #fed7aa;
            color: #c2410c;
        }

        .status-critica {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-aberta {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-concluida {
            background: #d1fae5;
            color: #065f46;
        }

        .calendario-item {
            padding: 2px 6px;
            border-radius: 6px;
            border-left: 4px solid #e5e7eb;
            background: #f9fafb;
        }

        .calendario-prioridade-baixa {
            border-left-color: #9ca3af;
            background: #f3f4f6;
        }

        .calendario-prioridade-media {
            border-left-color: #f59e0b;
            background: #fef3c7;
        }

        .calendario-prioridade-alta {
            border-left-color: #f97316;
            background: #fed7aa;
        }

        .calendario-prioridade-critica {
            border-left-color: #ef4444;
            background: #fee2e2;
        }

        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .table-responsive table {
            width: 100%;
            border-collapse: collapse;
        }

        .table-responsive th,
        .table-responsive td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .table-responsive th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .table-responsive tbody tr:hover {
            background-color: #f9fafb;
        }
        
        /* Corre√ß√£o definitiva para alinhamento das colunas */
        .tabela-migracao th,
        .tabela-migracao td {
            vertical-align: top !important;
        }
        
        .tabela-migracao th:nth-child(1),
        .tabela-migracao td:nth-child(1) {
            width: 20% !important;
            min-width: 150px !important;
        }
        
        .tabela-migracao th:nth-child(2),
        .tabela-migracao td:nth-child(2) {
            width: 15% !important;
            min-width: 120px !important;
        }
        
        .tabela-migracao th:nth-child(3),
        .tabela-migracao td:nth-child(3) {
            width: 20% !important;
            min-width: 150px !important;
        }
        
        .tabela-migracao th:nth-child(4),
        .tabela-migracao td:nth-child(4) {
            width: 15% !important;
            min-width: 120px !important;
        }
        
        .tabela-migracao th:nth-child(5),
        .tabela-migracao td:nth-child(5) {
            width: 12% !important;
            min-width: 100px !important;
        }
        
        .tabela-migracao th:nth-child(6),
        .tabela-migracao td:nth-child(6) {
            width: 10% !important;
            min-width: 100px !important;
        }
        
        .tabela-migracao th:nth-child(7),
        .tabela-migracao td:nth-child(7) {
            width: 8% !important;
            min-width: 80px !important;
        }


        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .space-x-2 > * + * { margin-left: 8px; }
        .space-x-4 > * + * { margin-left: 16px; }
        .text-center { text-align: center; }
        .font-semibold { font-weight: 600; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-800 { color: #1f2937; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Sistema de Notifica√ß√µes -->
    <div id="notificationContainer"></div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()">
        <i data-lucide="menu" class="w-5 h-5"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="p-6">
            <h2 class="text-white text-xl font-bold mb-6">Sistema Legal</h2>
            <nav class="space-y-2">
                <a href="#" onclick="carregarSecao('dashboard')" class="sidebar-item active" id="nav-dashboard">
                    <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                    Vis√£o Geral
                </a>
                <a href="#" onclick="carregarSecao('clientes')" class="sidebar-item" id="nav-clientes">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                    Clientes
                </a>
                <a href="#" onclick="carregarSecao('honorarios')" class="sidebar-item" id="nav-honorarios">
                    <i data-lucide="dollar-sign" class="w-5 h-5 mr-3"></i>
                    Honor√°rios
                </a>
                <a href="#" onclick="carregarSecao('contratos')" class="sidebar-item" id="nav-contratos">
                    <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                    Contratos
                </a>
                <a href="#" onclick="carregarSecao('herancas')" class="sidebar-item" id="nav-herancas">
                    <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                    Heran√ßas
                </a>
                <a href="#" onclick="carregarSecao('migracoes')" class="sidebar-item" id="nav-migracao">
                    <i data-lucide="users-2" class="w-5 h-5 mr-3"></i>
                    Migra√ß√£o
                </a>
                <a href="#" onclick="carregarSecao('registos')" class="sidebar-item" id="nav-registos">
                    <i data-lucide="book-open" class="w-5 h-5 mr-3"></i>
                    Registos
                </a>
                <a href="#" onclick="carregarSecao('prazos')" class="sidebar-item" id="nav-prazos">
                    <i data-lucide="clock" class="w-5 h-5 mr-3"></i>
                    Prazos
                </a>
                <a href="#" onclick="carregarSecao('tarefas')" class="sidebar-item" id="nav-tarefas">
                    <i data-lucide="check-square" class="w-5 h-5 mr-3"></i>
                    Tarefas
                </a>
                <a href="#" onclick="carregarSecao('calendario')" class="sidebar-item" id="nav-calendario">
                    <i data-lucide="calendar-days" class="w-5 h-5 mr-3"></i>
                    Calend√°rio
                </a>
                <a href="#" onclick="carregarSecao('notificacoes')" class="sidebar-item" id="nav-notificacoes">
                    <i data-lucide="bell" class="w-5 h-5 mr-3"></i>
                    Notifica√ß√µes
                    <span id="badgeNotificacoes" class="hidden bg-red-500 text-white text-xs rounded-full px-2 py-1 ml-2">0</span>
                </a>
            <a href="#" onclick="carregarSecao('documentos')" class="sidebar-item" id="nav-documentos">
                <i data-lucide="folder" class="w-5 h-5 mr-3"></i>
                Documentos
            </a>
            <a href="#" onclick="carregarSecao('relatorios')" class="sidebar-item" id="nav-relatorios">
                <i data-lucide="bar-chart-3" class="w-5 h-5 mr-3"></i>
                Relat√≥rios
            </a>
            <a href="#" onclick="carregarSecao('backup')" class="sidebar-item" id="nav-backup">
                <i data-lucide="database" class="w-5 h-5 mr-3"></i>
                Backup
            </a>
            <a href="#" onclick="carregarSecao('historico')" class="sidebar-item" id="nav-historico">
                <i data-lucide="history" class="w-5 h-5 mr-3"></i>
                Hist√≥rico
            </a>
            <a href="#" onclick="carregarSecao('convidados')" class="sidebar-item" id="nav-convidados" style="display: none;">
                <i data-lucide="user-plus" class="w-5 h-5 mr-3"></i>
                Gest√£o de Convidados
            </a>
            </nav>
        </div>
    </div>

    <!-- Menu Mobile -->
    <button id="menuHamburguer" class="fixed top-4 left-4 z-50 lg:hidden bg-black text-white p-2 rounded">
        <i data-lucide="menu" class="w-6 h-6"></i>
    </button>

    <!-- Conte√∫do Principal -->
    <div class="main-content min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="px-6 py-4">
                <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
                    <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:gap-6">
                        <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Sistema Legal</h1>
                        <div id="globalSearchContainer" class="relative w-full max-w-xl">
                            <input id="globalSearchInput" type="text" placeholder="Pesquisa global: clientes, processos, contratos e prazos..." class="form-control w-full pl-10">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                                <i data-lucide="search" class="w-4 h-4"></i>
                            </span>
                            <div id="globalSearchResults" class="hidden absolute z-50 mt-2 w-full rounded-lg border border-gray-200 bg-white shadow-lg"></div>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-3">
                        <!-- Bot√£o PWA removido -->
                        <button onclick="exportarDadosCompletos()" class="btn btn-primary">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Exportar Base de Dados
                        </button>
                        <button onclick="importarDadosCompletos()" class="btn btn-success">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                            Importar
                        </button>
                        <button onclick="logout()" class="btn btn-danger">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conte√∫do Din√¢mico -->
        <main class="p-6">
            <div id="conteudoDinamico">
                <!-- Dashboard ser√° carregado aqui -->
            </div>
        </main>
    </div>

    <!-- Modais -->
    <div id="modalContainer"></div>

    <script>
        // === SISTEMA LEGAL CORRIGIDO ===
        
        // SISTEMA DE LOGIN
        const USUARIO_PADRAO = 'admin';
        const SENHA_PADRAO = 'APM2024!';
        
        function verificarLogin() {
            const usuarioLogado = localStorage.getItem('usuarioLogado');
            if (!usuarioLogado) {
                mostrarTelaLogin();
                return false;
            }
            return true;
        }
        
        function mostrarTelaLogin() {
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex flex-col items-center justify-center py-8">
                    <div class="mb-6">
                        <img src="ana.jpg" alt="Ana Paula Medina Solicitadora" class="mx-auto w-24 h-24 object-contain">
                    </div>
                    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-900">Sistema Legal</h1>
                            <p class="text-lg font-semibold text-blue-600 mt-2">ANA PAULA MEDINA - SOLICITADORA</p>
                            <p class="text-gray-600 mt-2">Selecione o tipo de acesso</p>
                        </div>
                        
                        <div class="space-y-4">
                            <button onclick="mostrarLoginAdmin()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center justify-center">
                                <i data-lucide="shield-check" class="w-5 h-5 mr-2"></i>
                                Administrador
                            </button>
                            
                            <button onclick="mostrarLoginConvidado()" class="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 flex items-center justify-center">
                                <i data-lucide="user" class="w-5 h-5 mr-2"></i>
                                Convidado
                            </button>
                        </div>
                        
                        <div class="mt-6 text-center text-sm text-gray-600">
                            <p><strong>Administrador:</strong> Acesso total ao sistema</p>
                            <p><strong>Convidado:</strong> Acesso limitado a clientes autorizados</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Renderizar √≠cones
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }
        
        function mostrarLoginAdmin() {
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex flex-col items-center justify-center py-8">
                    <div class="mb-6">
                        <img src="ana.jpg" alt="Ana Paula Medina Solicitadora" class="mx-auto w-24 h-24 object-contain">
                    </div>
                    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-900">Sistema Legal</h1>
                            <p class="text-lg font-semibold text-blue-600 mt-2">ANA PAULA MEDINA - SOLICITADORA</p>
                            <p class="text-gray-600 mt-2">Login Administrador - Acesso total ao sistema</p>
                        </div>
                        
                        <form id="formLoginAdmin" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Usu√°rio</label>
                                <input type="text" id="usuario" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite seu usu√°rio" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                                <input type="password" id="senha" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite sua senha" required>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button type="button" onclick="mostrarTelaLogin()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                                    Voltar
                                </button>
                                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                    Entrar
                                </button>
                            </div>
                        </form>
                        
                        <div class="mt-6 text-center text-sm text-gray-600">
                            <p><strong>üîí Acesso Restrito</strong></p>
                            <p>Entre em contato com o administrador para obter as credenciais</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('formLoginAdmin').addEventListener('submit', function(e) {
                e.preventDefault();
                const usuario = document.getElementById('usuario').value;
                const senha = document.getElementById('senha').value;
                
                if (usuario === USUARIO_PADRAO && senha === SENHA_PADRAO) {
                    localStorage.setItem('usuarioLogado', 'true');
                    localStorage.setItem('usuarioNome', usuario);
                    localStorage.setItem('tipoUsuario', 'admin');
                    location.reload();
                } else {
                    alert('Usu√°rio ou senha incorretos!');
                }
            });
        }
        
        function mostrarLoginConvidado() {
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex flex-col items-center justify-center py-8">
                    <div class="mb-6">
                        <img src="ana.jpg" alt="Ana Paula Medina Solicitadora" class="mx-auto w-24 h-24 object-contain">
                    </div>
                    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-900">Sistema Legal</h1>
                            <p class="text-lg font-semibold text-blue-600 mt-2">ANA PAULA MEDINA - SOLICITADORA</p>
                            <p class="text-gray-600 mt-2">Login Convidado - Acesso limitado a clientes autorizados</p>
                        </div>
                        
                        <form id="formLoginConvidado" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Convidado</label>
                                <input type="text" id="nomeConvidado" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Digite seu nome" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">C√≥digo de Acesso</label>
                                <input type="text" id="codigoAcesso" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Digite o c√≥digo de acesso" required>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button type="button" onclick="mostrarTelaLogin()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                                    Voltar
                                </button>
                                <button type="submit" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                                    Entrar
                                </button>
                            </div>
                        </form>
                        
                        <div class="mt-6 text-center text-sm text-gray-600">
                            <p>Pe√ßa o c√≥digo de acesso ao administrador</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('formLoginConvidado').addEventListener('submit', function(e) {
                e.preventDefault();
                const nome = document.getElementById('nomeConvidado').value;
                const codigo = document.getElementById('codigoAcesso').value;
                
                // Verificar se o c√≥digo existe e est√° ativo
                const convidados = JSON.parse(localStorage.getItem('convidados') || '[]');
                const convidado = convidados.find(c => c.codigo === codigo && c.ativo);
                
                if (convidado) {
                    localStorage.setItem('usuarioLogado', 'true');
                    localStorage.setItem('usuarioNome', nome);
                    localStorage.setItem('tipoUsuario', 'convidado');
                    localStorage.setItem('convidadoId', convidado.id);
                    location.reload();
                } else {
                    alert('C√≥digo de acesso inv√°lido ou inativo!');
                }
            });
        }
        
        function logout() {
            localStorage.removeItem('usuarioLogado');
            localStorage.removeItem('usuarioNome');
            localStorage.removeItem('tipoUsuario');
            localStorage.removeItem('convidadoId');
            location.reload();
        }
        
        // FUN√á√ÉO PARA GERAR C√ìDIGOS DE ACESSO SEGUROS
        function gerarCodigoAcesso() {
            const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let codigo = '';
            for (let i = 0; i < 8; i++) {
                codigo += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
            }
            return codigo;
        }
        
        // FUN√á√ÉO PARA LIMPEZA PROFISSIONAL
        function limparDadosParaUsoProfissional() {
            if (!exigirAdmin('limpeza profissional')) {
                return;
            }
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° APAGAR TODOS os dados do sistema!\n\nIsso inclui:\n- Todos os clientes\n- Todos os honor√°rios\n- Todos os contratos\n- Todas as heran√ßas\n- Todas as migra√ß√µes\n- Todos os registos\n- Todos os convidados\n\nTem certeza que deseja continuar?')) {
                if (confirm('üö® CONFIRMA√á√ÉO FINAL:\n\nEsta a√ß√£o √© IRREVERS√çVEL!\n\nTodos os dados ser√£o permanentemente apagados.\n\nDeseja realmente continuar?')) {
                    // Limpar todos os dados do localStorage
                    localStorage.removeItem('clientes');
                    localStorage.removeItem('honorarios');
                    localStorage.removeItem('contratos');
                    localStorage.removeItem('herancas');
                    localStorage.removeItem('migracoes');
                    localStorage.removeItem('registos');
                    localStorage.removeItem('convidados');
                    localStorage.removeItem('prazos');
                    localStorage.removeItem('notificacoes');
                    
                    // Limpar vari√°veis globais
                    clientes = [];
                    honorarios = [];
                    contratos = [];
                    herancas = [];
                    migracoes = [];
                    registos = [];
                    prazos = [];
                    notificacoes = [];
                    
                    // Marcar que os dados foram limpos - n√£o recriar dados de exemplo
                    localStorage.setItem('dadosLimpos', 'true');
                    registrarAuditoria('limpar', 'sistema', 'Limpeza profissional executada');
                    
                    mostrarNotificacao('‚úÖ Sistema limpo com sucesso! Pronto para uso profissional. Voc√™ pode editar tudo agora.', 'success');
                    
                    // Recarregar p√°gina ap√≥s 2 segundos
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }
            }
        }
        
        // SISTEMA DE GEST√ÉO DE CONVIDADOS
        function criarConvidado(nome, clientesAutorizados) {
            const convidados = JSON.parse(localStorage.getItem('convidados') || '[]');
            const codigo = gerarCodigoAcesso(); // Usar fun√ß√£o de c√≥digo seguro
            
            const novoConvidado = {
                id: Date.now(),
                nome: nome,
                codigo: codigo,
                clientesAutorizados: clientesAutorizados || [],
                ativo: true,
                dataCriacao: new Date().toISOString()
            };
            
            convidados.push(novoConvidado);
            localStorage.setItem('convidados', JSON.stringify(convidados));
            
            return novoConvidado;
        }
        
        function obterConvidados() {
            return JSON.parse(localStorage.getItem('convidados') || '[]');
        }
        
        function ativarDesativarConvidado(id, ativo) {
            const convidados = obterConvidados();
            const convidado = convidados.find(c => c.id === id);
            if (convidado) {
                convidado.ativo = ativo;
                localStorage.setItem('convidados', JSON.stringify(convidados));
            }
        }
        
        // FUN√á√ÉO RECRIADA PARA CORRIGIR PROBLEMA
        function editarPermissoesConvidado(id, clientesAutorizados) {
            console.log('üöÄ IN√çCIO da fun√ß√£o editarPermissoesConvidado');
            console.log('üîß Par√¢metros recebidos:', { id, clientesAutorizados });
            
            // Carregar convidados diretamente
            const convidados = JSON.parse(localStorage.getItem('convidados') || '[]');
            console.log('üîß Convidados carregados:', convidados.length);
            
            // Buscar convidado
            const convidado = convidados.find(c => c.id === id);
            console.log('üîß Buscando convidado com ID:', id);
            
            if (convidado) {
                console.log('üîß Convidado encontrado:', convidado.nome);
                console.log('üîß Clientes autorizados antes:', convidado.clientesAutorizados);
                
                // Verificar se h√° novos clientes autorizados
                const clientesAntigos = convidado.clientesAutorizados || [];
                const novosClientes = clientesAutorizados.filter(id => !clientesAntigos.includes(id));
                
                // Atualizar permiss√µes
                convidado.clientesAutorizados = clientesAutorizados;
                localStorage.setItem('convidados', JSON.stringify(convidados));
                
                console.log('üîß Clientes autorizados depois:', convidado.clientesAutorizados);
                console.log('üîß Dados salvos no localStorage');
                
                // Criar notifica√ß√µes autom√°ticas para novos clientes
                if (novosClientes.length > 0) {
                    const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
                    novosClientes.forEach(clienteId => {
                        const cliente = clientes.find(c => c.id === clienteId);
                        if (cliente) {
                            criarNotificacao({
                                tipo: 'cliente_autorizado',
                                titulo: 'Novo Cliente Autorizado',
                                mensagem: `O cliente "${cliente.nome}" foi autorizado para voc√™.`,
                                prioridade: 'media',
                                referenciaId: clienteId,
                                destinatarioId: id,
                                acao: 'ver_cliente'
                            });
                        }
                    });
                }
                
                // Recarregar se√ß√£o
                setTimeout(() => {
                    console.log('üîß Recarregando se√ß√£o convidados...');
                    carregarSecao('convidados');
                }, 100);
            } else {
                console.error('‚ùå Convidado n√£o encontrado com ID:', id);
                console.log('üîß IDs dispon√≠veis:', convidados.map(c => c.id));
            }
        }
        
        // VERIFICA√á√ÉO DE PERMISS√ïES
        function verificarPermissaoCliente(clienteId) {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            
            if (tipoUsuario === 'admin') {
                return true; // Admin tem acesso total
            }
            
            if (tipoUsuario === 'convidado') {
                const convidadoId = localStorage.getItem('convidadoId');
                const convidados = obterConvidados();
                const convidado = convidados.find(c => c.id === parseInt(convidadoId));
                
                if (convidado && convidado.ativo) {
                    return convidado.clientesAutorizados.includes(parseInt(clienteId));
                }
            }
            
            return false;
        }

        function exigirAdmin(acao = 'esta opera√ß√£o') {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            if (tipoUsuario !== 'admin') {
                mostrarNotificacao(`Acesso restrito: somente administrador pode executar ${acao}.`, 'error');
                return false;
            }
            return true;
        }

        function obterNomeEntidade(tipo) {
            const nomes = {
                cliente: 'cliente',
                honorario: 'honor√°rio',
                contrato: 'contrato',
                heranca: 'heran√ßa',
                migracao: 'migra√ß√£o',
                registo: 'registo',
                prazo: 'prazo',
                documento: 'documento'
            };
            return nomes[tipo] || tipo || 'item';
        }

        function exigirPermissaoAcao(acao, entidade) {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            if (tipoUsuario === 'admin') {
                return true;
            }
            mostrarNotificacao(`Acesso restrito: perfil n√£o pode ${acao} ${obterNomeEntidade(entidade)}.`, 'error');
            return false;
        }
        
        // Verificar login ap√≥s o DOM estar carregado
        document.addEventListener('DOMContentLoaded', function() {
            // Garantir que n√£o existe service worker antigo a servir cache
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then((regs) => {
                    regs.forEach((reg) => reg.unregister());
                }).catch(() => {});
            }
            if ('caches' in window) {
                caches.keys().then((keys) => {
                    keys.forEach((key) => caches.delete(key));
                }).catch(() => {});
            }
            if (!verificarLogin()) {
                // A p√°gina ser√° substitu√≠da pela tela de login
                // O resto do c√≥digo n√£o ser√° executado
                return;
            }
            // Se login OK, configurar interface baseada no tipo de usu√°rio
            configurarInterfaceUsuario();
            // For√ßar largura do sidebar
            forcarLarguraSidebar();
            // Aplicar novamente ap√≥s um delay
            setTimeout(forcarLarguraSidebar, 1000);
            setTimeout(forcarLarguraSidebar, 2000);
            // Inicializar sistema normalmente
            init();
        });
        
        function forcarLarguraSidebar() {
            // Tentar m√∫ltiplas formas de encontrar o sidebar
            const sidebar = document.getElementById('sidebar');
            const sidebarClass = document.querySelector('.sidebar');
            
            if (sidebar) {
                sidebar.style.width = '300px';
                sidebar.style.minWidth = '300px';
                sidebar.style.maxWidth = '300px';
                sidebar.style.setProperty('width', '300px', 'important');
                sidebar.style.setProperty('min-width', '300px', 'important');
                sidebar.style.setProperty('max-width', '300px', 'important');
                console.log('üîß Largura do sidebar for√ßada para 300px (ID)');
            }
            
            if (sidebarClass) {
                sidebarClass.style.width = '300px';
                sidebarClass.style.minWidth = '300px';
                sidebarClass.style.maxWidth = '300px';
                sidebarClass.style.setProperty('width', '300px', 'important');
                sidebarClass.style.setProperty('min-width', '300px', 'important');
                sidebarClass.style.setProperty('max-width', '300px', 'important');
                console.log('üîß Largura do sidebar for√ßada para 300px (CLASS)');
            }
            
            // Aplicar tamb√©m no conte√∫do principal
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.style.marginLeft = '300px';
                mainContent.style.setProperty('margin-left', '300px', 'important');
                console.log('üîß Margem do conte√∫do principal ajustada para 300px');
            }
        }
        
        function configurarInterfaceUsuario() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const navConvidados = document.getElementById('nav-convidados');
            
            if (tipoUsuario === 'admin' && navConvidados) {
                navConvidados.style.display = 'block';
            } else if (navConvidados) {
                navConvidados.style.display = 'none';
            }
            
            // OCULTAR SE√á√ïES PARA CONVIDADOS
            if (tipoUsuario === 'convidado') {
                ocultarSecoesConvidado();
            } else {
                mostrarTodasSecoes();
            }
        }
        
        function ocultarSecoesConvidado() {
            // Ocultar todas as se√ß√µes exceto clientes
            const secoesParaOcultar = [
                'nav-dashboard',
                'nav-honorarios',
                'nav-contratos', 
                'nav-herancas',
                'nav-migracao',
                'nav-registos',
                'nav-prazos',
                'nav-calendario',
                'nav-documentos',
                'nav-relatorios',
                'nav-backup',
                'nav-historico',
                'nav-convidados'
            ];
            
            secoesParaOcultar.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.style.display = 'none';
                }
            });
            
            // Manter apenas a se√ß√£o de clientes vis√≠vel
            const navClientes = document.getElementById('nav-clientes');
            if (navClientes) {
                navClientes.style.display = 'block';
            }
        }
        
        function mostrarTodasSecoes() {
            // Mostrar todas as se√ß√µes para administradores
            const todasSecoes = [
                'nav-dashboard',
                'nav-clientes',
                'nav-honorarios',
                'nav-contratos', 
                'nav-herancas',
                'nav-migracao',
                'nav-registos',
                'nav-prazos',
                'nav-tarefas',
                'nav-calendario',
                'nav-notificacoes',
                'nav-documentos',
                'nav-relatorios',
                'nav-backup',
                'nav-historico',
                'nav-convidados'
            ];
            
            todasSecoes.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.style.display = 'block';
                }
            });
        }
        
        // Dados globais
        let clientes = [];
        let honorarios = [];
        let contratos = [];
        let prazos = [];
        let notificacoes = [];
        let herancas = [];
        let migracoes = [];
        let registos = [];
        let documentos = [];
        let tarefas = [];
        let calendarioModo = 'mensal';
        let calendarioDataRef = new Date();
        let calendarioFiltroCliente = '';
        let calendarioFiltroStatus = '';
        let calendarioFiltroTipo = '';
        let calendarioFiltroPrioridade = '';
        let secaoAtiva = 'dashboard';
        let relatorioAvancadoUltimosResultados = [];
        
        // Garantir que as vari√°veis est√£o definidas globalmente
        window.clientes = clientes;
        window.honorarios = honorarios;
        window.contratos = contratos;
        window.prazos = prazos;
        window.notificacoes = notificacoes;
        window.herancas = herancas;
        window.migracoes = migracoes;
        window.registos = registos;
        window.documentos = documentos;
        window.tarefas = tarefas;
        window.calendarioModo = calendarioModo;
        window.calendarioDataRef = calendarioDataRef;
        window.calendarioFiltroCliente = calendarioFiltroCliente;
        window.calendarioFiltroStatus = calendarioFiltroStatus;
        window.calendarioFiltroTipo = calendarioFiltroTipo;
        window.calendarioFiltroPrioridade = calendarioFiltroPrioridade;
        window.relatorioAvancadoUltimosResultados = relatorioAvancadoUltimosResultados;

        // === FUN√á√ÉO DE TESTE ===
        function testarBotao() {
            alert('BOT√ÉO FUNCIONANDO!');
            console.log('BOT√ÉO FUNCIONANDO!');
        }

        // === FUN√á√ïES DE EDI√á√ÉO DIRETA ===
        function editarContratoDireto(id) {
            console.log('üîß EDITANDO CONTRATO ID:', id);
            
            const contrato = contratos.find(c => c.id === id);
            if (contrato) {
                console.log('‚úÖ Contrato encontrado:', contrato);
                
                // Fechar qualquer modal aberto primeiro
                fecharModalRobusto();
                
                // Aguardar um pouco para garantir que o modal anterior foi fechado
                setTimeout(() => {
                    console.log('üöÄ Abrindo modal de edi√ß√£o...');
                    abrirModalEdicaoContrato(contrato);
                    console.log('‚úÖ Modal de edi√ß√£o aberto!');
                }, 200);
            } else {
                console.error('‚ùå Contrato n√£o encontrado com ID:', id);
                mostrarNotificacao('Contrato n√£o encontrado!', 'error');
            }
        }

        function editarHonorarioDireto(id) {
            console.log('üîß EDITANDO HONOR√ÅRIO ID:', id);
            console.log('üîß Tipo do ID:', typeof id);
            
            // Carregar honor√°rios do localStorage
            const honorariosSalvos = localStorage.getItem('honorarios');
            let honorarios = [];
            if (honorariosSalvos) {
                honorarios = JSON.parse(honorariosSalvos);
                console.log('üîß Honor√°rios carregados do localStorage:', honorarios.length);
                console.log('üîß IDs dos honor√°rios:', honorarios.map(h => ({ id: h.id, tipo: typeof h.id })));
            } else {
                console.warn('‚ö†Ô∏è Nenhum honor√°rio encontrado no localStorage');
            }
            
            // Converter ID para n√∫mero se necess√°rio
            const honorarioId = typeof id === 'string' ? parseInt(id) : id;
            console.log('üîß Procurando honor√°rio com ID:', honorarioId);
            
            const honorario = honorarios.find(h => {
                const hId = typeof h.id === 'string' ? parseInt(h.id) : h.id;
                return hId === honorarioId;
            });
            
            if (honorario) {
                console.log('‚úÖ Honor√°rio encontrado:', honorario);
                
                // Fechar qualquer modal aberto primeiro
                fecharModalRobusto();
                
                // Aguardar um pouco para garantir que o modal anterior foi fechado
                setTimeout(() => {
                    console.log('üöÄ Abrindo modal de edi√ß√£o...');
                    abrirModalEdicaoHonorario(honorario);
                    console.log('‚úÖ Modal de edi√ß√£o aberto!');
                }, 200);
            } else {
                console.error('‚ùå Honor√°rio n√£o encontrado com ID:', honorarioId);
                console.error('‚ùå Honor√°rios dispon√≠veis:', honorarios);
                mostrarNotificacao('Honor√°rio n√£o encontrado!', 'error');
            }
        }

        function excluirHonorarioDireto(id) {
            console.log('üîß excluirHonorarioDireto chamado com ID:', id);
            
            if (confirm('Tem certeza que deseja excluir este honor√°rio? Esta a√ß√£o n√£o pode ser desfeita.')) {
                // Carregar dados dos honor√°rios
                const honorariosSalvos = localStorage.getItem('honorarios');
                let honorarios = [];
                if (honorariosSalvos) {
                    honorarios = JSON.parse(honorariosSalvos);
                }
                
                console.log('üîß Honor√°rios antes da exclus√£o:', honorarios.length);
                
                // Filtrar honor√°rio a ser exclu√≠do
                const honorariosAtualizados = honorarios.filter(h => h.id !== parseInt(id));
                
                console.log('üîß Honor√°rios ap√≥s exclus√£o:', honorariosAtualizados.length);
                
                // Salvar dados atualizados
                localStorage.setItem('honorarios', JSON.stringify(honorariosAtualizados));
                window.honorarios = honorariosAtualizados;
                
                console.log('‚úÖ Honor√°rios salvos no localStorage');
                
                mostrarNotificacao('Honor√°rio exclu√≠do com sucesso!', 'success');
                
                // Recarregar se√ß√£o
                setTimeout(() => {
                    console.log('üîß Recarregando se√ß√£o honorarios');
                    carregarSecao('honorarios');
                    if (typeof atualizarListaHonorarios === 'function') {
                        atualizarListaHonorarios(honorariosAtualizados);
                    }
                }, 100);
            }
        }

        function editarClienteDireto(id) {
            console.log('EDITANDO CLIENTE ID:', id);
            
            const cliente = clientes.find(c => c.id === id);
            if (cliente) {
                console.log('Cliente encontrado:', cliente);
                
                // Fechar qualquer modal aberto primeiro
                fecharModal();
                
                // Aguardar um pouco para garantir que o modal anterior foi fechado
                setTimeout(() => {
                    abrirModalEdicaoCliente(cliente);
                }, 100);
            } else {
                console.error('Cliente n√£o encontrado com ID:', id);
                mostrarNotificacao('Cliente n√£o encontrado!', 'error');
            }
        }

        // Inicializa√ß√£o
        function init() {
            console.log('üöÄ Sistema Legal - Vers√£o Profissional');
            
            // CARREGAR DADOS DO LOCALSTORAGE (N√ÉO LIMPAR - PRESERVA DADOS DO USU√ÅRIO)
            carregarDados();
            carregarDadosExemplo();
            
            // Verificar tipo de usu√°rio para carregar se√ß√£o apropriada
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            if (tipoUsuario === 'convidado') {
                carregarSecao('clientes');
            } else {
                carregarSecao('dashboard');
            }
            
            configurarEventos();
            inicializarPesquisaGlobal();
            atualizarInterface();
            iniciarSistemaNotificacoes();
            iniciarSistemaBackup();
            configurarMonitorizacaoErros();
            
            // Inicializar funcionalidades mobile
            // inicializarPWA(); // REMOVIDO - PWA desativado
            // inicializarModoEscuro(); // REMOVIDO
            inicializarGestosTouch();
            
            
            // Calcular juros autom√°ticos na inicializa√ß√£o
            // calcularJurosAutomaticos(); // REMOVIDO
        }

        function inicializarPesquisaGlobal() {
            const input = document.getElementById('globalSearchInput');
            const results = document.getElementById('globalSearchResults');
            const container = document.getElementById('globalSearchContainer');
            if (!input || !results || !container) return;
            
            let timer = null;
            const fecharResultados = () => {
                results.classList.add('hidden');
                results.innerHTML = '';
            };
            
            const renderizar = (termo) => {
                const resultados = executarPesquisaGlobal(termo);
                if (resultados.length === 0) {
                    results.innerHTML = `
                        <div class="px-4 py-3 text-sm text-gray-500">
                            Nenhum resultado encontrado para "${termo}".
                        </div>
                    `;
                    results.classList.remove('hidden');
                    return;
                }
                
                const itens = resultados.map(item => `
                    <button class="w-full text-left px-4 py-3 hover:bg-gray-50 border-b border-gray-100 last:border-b-0" data-secao="${item.secao}">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm font-semibold text-gray-800">${item.titulo}</div>
                                <div class="text-xs text-gray-500">${item.subtitulo || ''}</div>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">${item.tipo}</span>
                        </div>
                    </button>
                `).join('');
                
                results.innerHTML = `
                    <div class="px-4 py-2 text-xs text-gray-400 border-b border-gray-100">
                        Resultados: ${resultados.length}
                    </div>
                    <div class="max-h-80 overflow-y-auto">${itens}</div>
                `;
                results.classList.remove('hidden');
            };
            
            input.addEventListener('input', () => {
                const termo = input.value.trim();
                if (timer) clearTimeout(timer);
                if (termo.length < 2) {
                    fecharResultados();
                    return;
                }
                timer = setTimeout(() => renderizar(termo), 250);
            });
            
            input.addEventListener('focus', () => {
                const termo = input.value.trim();
                if (termo.length >= 2) {
                    renderizar(termo);
                }
            });
            
            results.addEventListener('click', (event) => {
                const botao = event.target.closest('[data-secao]');
                if (!botao) return;
                const secao = botao.getAttribute('data-secao');
                if (secao) {
                    carregarSecao(secao);
                }
                fecharResultados();
            });
            
            document.addEventListener('click', (event) => {
                if (!container.contains(event.target)) {
                    fecharResultados();
                }
            });
            
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    fecharResultados();
                }
            });
        }

        function executarPesquisaGlobal(termo) {
            const termoLower = termo.toLowerCase();
            const resultados = [];
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            
            const clientePermitido = (clienteId) => {
                if (tipoUsuario !== 'convidado') return true;
                if (!clienteId) return false;
                return verificarPermissaoCliente(clienteId);
            };
            
            const clientesParaPesquisar = Array.isArray(clientes) ? clientes : [];
            clientesParaPesquisar.forEach(cliente => {
                if (!clientePermitido(cliente.id)) return;
                const haystack = [
                    cliente.nome,
                    cliente.email,
                    cliente.telefone,
                    cliente.nif
                ].filter(Boolean).join(' ').toLowerCase();
                if (haystack.includes(termoLower)) {
                    resultados.push({
                        tipo: 'Cliente',
                        titulo: cliente.nome,
                        subtitulo: [cliente.email, cliente.telefone].filter(Boolean).join(' ‚Ä¢ '),
                        secao: 'clientes'
                    });
                }
            });
            
            const contratosParaPesquisar = Array.isArray(contratos) ? contratos : [];
            contratosParaPesquisar.forEach(contrato => {
                if (contrato.clienteId && !clientePermitido(contrato.clienteId)) return;
                const clienteNome = contrato.cliente || contrato.clienteNome || obterNomeClienteRelatorio(contrato);
                const haystack = [
                    contrato.tipo,
                    contrato.descricao,
                    contrato.status,
                    contrato.valor,
                    clienteNome
                ].filter(Boolean).join(' ').toLowerCase();
                if (haystack.includes(termoLower)) {
                    resultados.push({
                        tipo: 'Contrato',
                        titulo: contrato.tipo || contrato.descricao || 'Contrato',
                        subtitulo: [clienteNome, contrato.status].filter(Boolean).join(' ‚Ä¢ '),
                        secao: 'contratos'
                    });
                }
            });
            
            const registosParaPesquisar = Array.isArray(registos) ? registos : [];
            registosParaPesquisar.forEach(registo => {
                if (registo.clienteId && !clientePermitido(registo.clienteId)) return;
                const clienteNome = registo.cliente || registo.clienteNome || obterNomeClienteRelatorio(registo);
                const haystack = [
                    registo.tipo,
                    registo.descricao,
                    registo.status,
                    registo.valor,
                    clienteNome
                ].filter(Boolean).join(' ').toLowerCase();
                if (haystack.includes(termoLower)) {
                    resultados.push({
                        tipo: 'Processo',
                        titulo: registo.tipo || registo.descricao || 'Processo',
                        subtitulo: [clienteNome, registo.status].filter(Boolean).join(' ‚Ä¢ '),
                        secao: 'registos'
                    });
                }
            });
            
            const prazosParaPesquisar = Array.isArray(prazos) ? prazos : [];
            prazosParaPesquisar.forEach(prazo => {
                if (prazo.clienteId && !clientePermitido(prazo.clienteId)) return;
                const clienteNome = prazo.clienteNome || prazo.cliente || obterNomeClienteRelatorio(prazo);
                const haystack = [
                    prazo.descricao,
                    prazo.tipo,
                    prazo.status,
                    prazo.dataLimite,
                    clienteNome
                ].filter(Boolean).join(' ').toLowerCase();
                if (haystack.includes(termoLower)) {
                    const data = extrairDataRelatorio(prazo);
                    resultados.push({
                        tipo: 'Prazo',
                        titulo: prazo.descricao || prazo.tipo || 'Prazo',
                        subtitulo: [clienteNome, data ? formatarDataRelatorio(data) : null].filter(Boolean).join(' ‚Ä¢ '),
                        secao: 'prazos'
                    });
                }
            });
            
            return resultados.slice(0, 20);
        }



        // Fun√ß√£o robusta para fechar modais
        function fecharModalRobusto() {
            console.log('üîß fecharModalRobusto chamado - SOLU√á√ÉO DEFINITIVA FINAL');
            
            // SOLU√á√ÉO DEFINITIVA FINAL - BASEADA NA FUN√á√ÉO fecharModal() QUE FUNCIONA
            try {
                // M√âTODO 1: REMOVER MODAIS COM CLASSES fixed e inset-0 (PRIORIDADE M√ÅXIMA - √â O MODAL QUE N√ÉO FECHAVA)
                console.log('üéØ M√âTODO 1: Removendo modais com classes fixed e inset-0...');
                const modalsFixedInset = document.querySelectorAll('.fixed.inset-0');
                console.log('üéØ Encontrados', modalsFixedInset.length, 'modais com .fixed.inset-0');
                modalsFixedInset.forEach((modal, index) => {
                    console.log(`üéØ Removendo modal ${index + 1}:`, modal);
                    if (modal.parentNode) {
                        modal.remove();
                        console.log(`‚úÖ Modal ${index + 1} removido`);
                    } else {
                        console.log(`‚ö†Ô∏è Modal ${index + 1} j√° n√£o tem parentNode`);
                    }
                });
                
                // M√âTODO 2: REMOVER TODOS OS MODAIS COM CLASSE 'modal'
                console.log('üéØ M√âTODO 2: Removendo modais com classe .modal...');
                const todosModais = document.querySelectorAll('.modal');
                console.log('üéØ Encontrados', todosModais.length, 'modais com .modal');
                todosModais.forEach((modal, index) => {
                    console.log(`üéØ Removendo modal ${index + 1}:`, modal.className);
                    if (modal.parentNode) {
                        modal.remove();
                        console.log(`‚úÖ Modal ${index + 1} removido`);
                    } else {
                        console.log(`‚ö†Ô∏è Modal ${index + 1} j√° n√£o tem parentNode`);
                    }
                });
                
                // M√âTODO 3: REMOVER ELEMENTOS COM POSITION FIXED QUE S√ÉO MODAIS (EXCLUINDO SIDEBAR)
                console.log('üéØ M√âTODO 3: Removendo elementos fixed que s√£o modais (excluindo sidebar)...');
                let count = 0;
                document.querySelectorAll('div').forEach(div => {
                    const computedStyle = getComputedStyle(div);
                    // Verificar se √© fixed e N√ÉO √© a sidebar ou outros elementos importantes
                    if ((computedStyle.position === 'fixed' || div.style.position === 'fixed') &&
                        div.id !== 'sidebar' && 
                        !div.classList.contains('sidebar') &&
                        !div.id.includes('header') &&
                        !div.id.includes('nav')) {
                        
                        // Verificar se parece ser um modal (tem classes de modal ou backdrop)
                        if (div.classList.contains('modal') ||
                            div.classList.contains('backdrop') ||
                            div.classList.contains('bg-black') ||
                            div.classList.contains('bg-opacity') ||
                            div.getAttribute('onclick')?.includes('fecharModal')) {
                            
                            count++;
                            console.log(`üéØ Removendo div fixed (modal) ${count}:`, div);
                            if (div.parentNode) {
                                div.remove();
                                console.log(`‚úÖ Div fixed (modal) ${count} removido`);
                            }
                        } else {
                            console.log(`‚è≠Ô∏è Div fixed ignorado (n√£o √© modal):`, div.id || div.className);
                        }
                    }
                });
                console.log(`‚úÖ Total de ${count} divs fixed (modais) removidos`);
                
                // M√âTODO 4: REMOVER ELEMENTOS COM Z-INDEX ALTO QUE S√ÉO MODAIS (EXCLUINDO BOT√ïES E SIDEBAR)
                console.log('üéØ M√âTODO 4: Removendo elementos com z-index alto que s√£o modais (excluindo bot√µes)...');
                let zIndexCount = 0;
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    // Verificar se tem z-index alto e N√ÉO √© bot√£o, sidebar ou header
                    if (parseInt(style.zIndex) >= 50 &&
                        el.id !== 'sidebar' &&
                        el.id !== 'mobileMenuBtn' &&
                        el.id !== 'menuHamburguer' &&
                        !el.classList.contains('sidebar') &&
                        !el.classList.contains('header') &&
                        el.tagName !== 'BUTTON') {
                        
                        // Verificar se parece ser um modal ou backdrop
                        if (el.classList.contains('modal') ||
                            el.classList.contains('backdrop') ||
                            el.classList.contains('bg-black') ||
                            el.classList.contains('bg-opacity') ||
                            el.classList.contains('fixed') && el.classList.contains('inset-0')) {
                            
                            zIndexCount++;
                            console.log(`üéØ Removendo elemento z-index alto (modal) ${zIndexCount}:`, el, 'z-index:', style.zIndex);
                            if (el.parentNode) {
                                el.remove();
                                console.log(`‚úÖ Elemento z-index alto (modal) ${zIndexCount} removido`);
                            }
                        } else {
                            console.log(`‚è≠Ô∏è Elemento z-index alto ignorado (n√£o √© modal):`, el.id || el.className);
                        }
                    }
                });
                console.log(`‚úÖ Total de ${zIndexCount} elementos com z-index alto (modais) removidos`);
                
                // LIMPAR modalContainer (COMO A FUN√á√ÉO QUE FUNCIONA)
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.classList.remove('show');
                    modalContainer.innerHTML = '';
                    console.log('‚úÖ modalContainer limpo');
                }
                
                // RESTAURAR SCROLL
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // BLUR ELEMENTO ATIVO
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('‚úÖ fecharModalRobusto executado - SOLU√á√ÉO DEFINITIVA FINAL');
                
            } catch (e) {
                console.warn('‚ùå Erro na solu√ß√£o definitiva final:', e);
            }
        }

        // Fun√ß√£o simples para fechar modal (backup)
        function fecharModalSimples() {
            console.log('üîß fecharModalSimples chamado');
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
                console.log('‚úÖ Modal removido (m√©todo simples)');
            }
        }

        // Fun√ß√£o de teste para modal
        function testarModal() {
            console.log('üîß Testando modal...');
            
            // Remover modais existentes primeiro
            fecharModalRobusto();
            
            // Criar modal de teste simples
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background-color: rgba(0, 0, 0, 0.8) !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 99999 !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    max-width: 400px;
                    width: 90%;
                    text-align: center;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                ">
                    <h2 style="color: #1f2937; margin-bottom: 20px;">üß™ TESTE DE MODAL</h2>
                    <p style="color: #6b7280; margin-bottom: 20px;">Se v√™s esta mensagem, o modal est√° a funcionar!</p>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="fecharModalRobusto()" style="
                            background: #3b82f6;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 16px;
                        ">Fechar Robusto</button>
                        <button onclick="fecharModalSimples()" style="
                            background: #10b981;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 16px;
                        ">Fechar Simples</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('‚úÖ Modal de teste criado');
            
            // Verificar se foi adicionado
            setTimeout(() => {
                const modalTeste = document.querySelector('.modal');
                if (modalTeste) {
                    console.log('‚úÖ Modal encontrado no DOM');
                } else {
                    console.log('‚ùå Modal n√£o encontrado no DOM');
                }
            }, 100);
        }

        // Fun√ß√£o ultra-simples para modal
        function modalUltraSimples() {
            console.log('üîß Modal ultra-simples...');
            
            // Criar div simples
            const div = document.createElement('div');
            div.id = 'modal-teste';
            div.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 999999;
                display: flex;
                justify-content: center;
                align-items: center;
            `;
            
            div.innerHTML = `
                <div style="
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 300px;
                    text-align: center;
                ">
                    <h3>üéØ MODAL ULTRA-SIMPLES</h3>
                    <p>Se v√™s isto, o modal funciona!</p>
                    <button onclick="document.getElementById('modal-teste').remove()" style="
                        background: #ef4444;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 4px;
                        cursor: pointer;
                    ">Fechar</button>
                </div>
            `;
            
            document.body.appendChild(div);
            console.log('‚úÖ Modal ultra-simples criado');
        }

        // Modo Escuro
        function inicializarModoEscuro_REMOVED() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                ativarModoEscuro();
            } else {
                desativarModoEscuro();
            }
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            
            if (isDark) {
                desativarModoEscuro();
            } else {
                ativarModoEscuro();
            }
        }

        function ativarModoEscuro() {
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
            
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            
            if (icon) icon.setAttribute('data-lucide', 'sun');
            if (text) text.textContent = 'Modo Claro';
            
            // Re-renderizar √≠cones
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        function desativarModoEscuro() {
            document.documentElement.removeAttribute('data-theme');
            localStorage.setItem('theme', 'light');
            
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            
            if (icon) icon.setAttribute('data-lucide', 'moon');
            if (text) text.textContent = 'Modo Escuro';
            
            // Re-renderizar √≠cones
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        // Gestos Touch
        function inicializarGestosTouch() {
            let startX, startY, endX, endY;
            
            document.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            });
            
            document.addEventListener('touchend', (e) => {
                endX = e.changedTouches[0].clientX;
                endY = e.changedTouches[0].clientY;
                
                const deltaX = endX - startX;
                const deltaY = endY - startY;
                
                // Swipe horizontal (mudan√ßa de se√ß√£o)
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                    if (deltaX > 0) {
                        // Swipe direita - se√ß√£o anterior
                        navegarSecaoAnterior();
                    } else {
                        // Swipe esquerda - pr√≥xima se√ß√£o
                        navegarProximaSecao();
                    }
                }
                
                // Swipe vertical (fechar modais)
                if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > 100) {
                    if (deltaY > 0) {
                        // Swipe para baixo - fechar modal
                        fecharModal();
                    }
                }
            });
            
            // Pull to refresh
            let pullStartY = 0;
            let isPulling = false;
            
            document.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0) {
                    pullStartY = e.touches[0].clientY;
                    isPulling = true;
                }
            });
            
            document.addEventListener('touchmove', (e) => {
                if (isPulling && window.scrollY === 0) {
                    const pullDistance = e.touches[0].clientY - pullStartY;
                    if (pullDistance > 100) {
                        // Pull to refresh
                        window.location.reload();
                        isPulling = false;
                    }
                }
            });
        }

        function navegarSecaoAnterior() {
            const secoes = ['dashboard', 'clientes', 'honorarios', 'contratos', 'herancas', 'migracoes', 'registos', 'prazos', 'tarefas', 'calendario', 'notificacoes', 'documentos', 'relatorios', 'backup', 'historico'];
            const indiceAtual = secoes.indexOf(secaoAtiva);
            if (indiceAtual > 0) {
                carregarSecao(secoes[indiceAtual - 1]);
            }
        }

        function navegarProximaSecao() {
            const secoes = ['dashboard', 'clientes', 'honorarios', 'contratos', 'herancas', 'migracoes', 'registos', 'prazos', 'tarefas', 'calendario', 'notificacoes', 'documentos', 'relatorios', 'backup', 'historico'];
            const indiceAtual = secoes.indexOf(secaoAtiva);
            if (indiceAtual < secoes.length - 1) {
                carregarSecao(secoes[indiceAtual + 1]);
            }
        }

        // Notifica√ß√µes Push
        function solicitarPermissaoNotificacoes() {
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then((permission) => {
                        if (permission === 'granted') {
                            console.log('‚úÖ Permiss√£o para notifica√ß√µes concedida');
                            mostrarNotificacao('Notifica√ß√µes ativadas!', 'success');
                        }
                    });
                }
            }
        }

        function enviarNotificacaoPush(titulo, corpo, icone) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(titulo, {
                    body: corpo,
                    icon: icone || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMzYjgyZjYiLz4KPHBhdGggZD0iTTk2IDQ4QzY5LjQ5IDQ4IDQ4IDY5LjQ5IDQ4IDk2UzY5LjQ5IDE0NCA5NiAxNDRTMTQ0IDEyMi41MSAxNDQgOTZTMTIyLjUxIDQ4IDk2IDQ4Wk05NiAxMjhDNzMuOTA5IDEyOCA1NiAxMTAuMDkgNTYgODhTNzMuOTA5IDQ4IDk2IDQ4UzEzNiA2NS45MSAxMzYgODhTMTE4LjA5IDEyOCA5NiAxMjhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K',
                    badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTYiIGhlaWdodD0iOTYiIHZpZXdCb3g9IjAgMCA5NiA5NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9Ijk2IiBoZWlnaHQ9Ijk2IiByeD0iMTIiIGZpbGw9IiNmNTk5MGIiLz4KPHBhdGggZD0iTTQ4IDI0QzM0Ljc0IDI0IDI0IDM0Ljc0IDI0IDQ4UzM0Ljc0IDcyIDQ4IDcyUzcyIDYxLjI2IDcyIDQ4UzYxLjI2IDI0IDQ4IDI0Wk00OCA2NEM0MC4yNyA2NCAzNCA1Ny43MyAzNCA1MFM0MC4yNyAzNiA0OCAzNlM2MiA0Mi4yNyA2MiA1MFM1NS73MyA2NCA0OCA2NFoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',
                    vibrate: [200, 100, 200],
                    requireInteraction: true
                });

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
        }





        function calcularJurosAutomaticos_REMOVED() {
            console.log('üîß Fun√ß√£o calcularJurosAutomaticos chamada');
            console.log('üí∞ Calculando juros autom√°ticos...');
            
            const honorariosVencidos = honorarios.filter(h => {
                if (h.status === 'pago') return false;
                const dataVencimento = new Date(h.vencimento);
                return dataVencimento < new Date();
            });
            
            honorariosVencidos.forEach(honorario => {
                const diasAtraso = Math.ceil((new Date() - new Date(honorario.vencimento)) / (1000 * 60 * 60 * 24));
                const taxaJuros = 0.0005; // 0.05% ao dia
                const juros = parseFloat(honorario.valor) * taxaJuros * diasAtraso;
                
                if (juros > 0) {
                    honorario.jurosCalculados = juros;
                    honorario.diasAtraso = diasAtraso;
                    honorario.valorComJuros = parseFloat(honorario.valor) + juros;
                    
                    // Criar notifica√ß√£o de juros
                    criarNotificacao({
                        titulo: `Juros calculados - ${honorario.clienteNome}`,
                        descricao: `Juros de ‚Ç¨${juros.toFixed(2)} calculados (${diasAtraso} dias de atraso)`,
                        tipo: 'warning',
                        categoria: 'juros_calculados',
                        referenciaId: honorario.clienteId
                    });
                }
            });
            
            // Verificar se a fun√ß√£o existe antes de chamar
            if (typeof salvarHonorarios === 'function') {
                console.log('üîß Chamando salvarHonorarios...');
                salvarHonorarios();
            } else {
                console.error('‚ùå Fun√ß√£o salvarHonorarios n√£o encontrada!');
                // Fallback: salvar diretamente
                try {
                    localStorage.setItem('honorarios', JSON.stringify(honorarios));
                    console.log('‚úÖ Honor√°rios salvos via fallback');
                } catch (error) {
                    console.error('‚ùå Erro no fallback:', error);
                }
            }
        }

        // 3. GERA√á√ÉO AUTOM√ÅTICA DE FATURAS
        function gerarFaturaAutomatica(honorarioId) {
            const honorario = honorarios.find(h => h.id === honorarioId);
            if (!honorario) return;
            
            const cliente = clientes.find(c => c.id === honorario.clienteId);
            if (!cliente) return;
            
            const fatura = {
                id: Date.now(),
                numero: `FAT-${new Date().getFullYear()}-${String(Date.now()).slice(-6)}`,
                clienteId: honorario.clienteId,
                clienteNome: honorario.clienteNome,
                honorarioId: honorarioId,
                data: new Date().toISOString().split('T')[0],
                valor: honorario.valorComJuros || honorario.valor,
                juros: honorario.jurosCalculados || 0,
                status: 'pendente',
                observacoes: `Fatura gerada automaticamente para ${honorario.descricao}`
            };
            
            // Adicionar fatura
            const faturas = obterFaturas();
            faturas.push(fatura);
            localStorage.setItem('faturas', JSON.stringify(faturas));
            
            // Criar notifica√ß√£o
            criarNotificacao({
                titulo: `Fatura gerada - ${cliente.nome}`,
                descricao: `Fatura ${fatura.numero} gerada automaticamente`,
                tipo: 'success',
                categoria: 'fatura_gerada',
                referenciaId: cliente.id
            });
            
            console.log('üìÑ Fatura gerada automaticamente:', fatura);
            return fatura;
        }

        // 4. SINCRONIZA√á√ÉO COM CALEND√ÅRIO
        function sincronizarComCalendario_REMOVED() {
            console.log('üîß Fun√ß√£o sincronizarComCalendario chamada');
            console.log('üìÖ Sincronizando com calend√°rio...');
            
            const eventos = [];
            
            // Adicionar prazos
            prazos.forEach(prazo => {
                if (prazo.status === 'ativo' && prazo.dataLimite) {
                    eventos.push({
                        titulo: `üìã Prazo: ${prazo.descricao}`,
                        data: prazo.dataLimite,
                        tipo: 'prazo',
                        cliente: prazo.clienteNome,
                        descricao: prazo.observacoes || 'Prazo importante do Sistema Legal'
                    });
                }
            });
            
            // Adicionar vencimentos de honor√°rios
            honorarios.forEach(honorario => {
                if (honorario.status === 'pendente' && honorario.vencimento) {
                    eventos.push({
                        titulo: `üí∞ Vencimento: ${honorario.descricao}`,
                        data: honorario.vencimento,
                        tipo: 'vencimento',
                        cliente: honorario.clienteNome,
                        valor: honorario.valor,
                        descricao: `Honor√°rio de ‚Ç¨${parseFloat(honorario.valor).toFixed(2)}`
                    });
                }
            });
            
            // Adicionar contratos com vencimento
            contratos.forEach(contrato => {
                if (contrato.vencimento) {
                    eventos.push({
                        titulo: `üìÑ Contrato: ${contrato.descricao}`,
                        data: contrato.vencimento,
                        tipo: 'contrato',
                        cliente: contrato.clienteNome,
                        descricao: `Contrato - ${contrato.tipo}`
                    });
                }
            });
            
            // Adicionar heran√ßas com prazo
            herancas.forEach(heranca => {
                if (heranca.prazo) {
                    eventos.push({
                        titulo: `‚öñÔ∏è Heran√ßa: ${heranca.descricao}`,
                        data: heranca.prazo,
                        tipo: 'heranca',
                        cliente: heranca.clienteNome,
                        descricao: `Processo de heran√ßa - ${heranca.tipo}`
                    });
                }
            });
            
            console.log('üìÖ Eventos encontrados:', eventos.length);
            
            if (eventos.length === 0) {
                mostrarNotificacao('Nenhum evento encontrado para exportar!', 'info');
                return;
            }
            
            // Gerar arquivo ICS para importar no calend√°rio
            gerarArquivoICS(eventos);
        }

        function gerarArquivoICS(eventos) {
            console.log('üìÖ Gerando arquivo ICS com', eventos.length, 'eventos');
            
            // Fun√ß√£o para formatar data no formato ICS
            function formatarDataICS(data) {
                return data.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            }
            
            // Fun√ß√£o para escapar texto para ICS
            function escaparTextoICS(texto) {
                return texto
                    .replace(/\\/g, '\\\\')
                    .replace(/;/g, '\\;')
                    .replace(/,/g, '\\,')
                    .replace(/\n/g, '\\n')
                    .replace(/\r/g, '');
            }
            
            let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Sistema Legal//Sistema Legal//PT
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:Sistema Legal - Prazos e Vencimentos
X-WR-CALDESC:Calend√°rio do Sistema Legal com prazos e vencimentos
X-WR-TIMEZONE:Europe/Lisbon`;

            eventos.forEach((evento, index) => {
                const dataInicio = new Date(evento.data);
                const dataFim = new Date(dataInicio.getTime() + (24 * 60 * 60 * 1000)); // +1 dia
                
                // Gerar UID √∫nico
                const uid = `sistema-legal-${Date.now()}-${index}@sistemalegal.com`;
                
                // Formatar datas
                const dtstart = formatarDataICS(dataInicio);
                const dtend = formatarDataICS(dataFim);
                const dtstamp = formatarDataICS(new Date());
                
                // Escapar textos
                const summary = escaparTextoICS(evento.titulo);
                const description = escaparTextoICS(`Cliente: ${evento.cliente}${evento.valor ? `\\nValor: ‚Ç¨${evento.valor}` : ''}\\n\\nSistema Legal - ANA PAULA MEDINA`);
                const location = escaparTextoICS('Sistema Legal');
                
                icsContent += `
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dtstamp}
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:${summary}
DESCRIPTION:${description}
LOCATION:${location}
STATUS:CONFIRMED
TRANSP:OPAQUE
SEQUENCE:0
END:VEVENT`;
            });

            icsContent += `
END:VCALENDAR`;

            console.log('üìÖ Conte√∫do ICS gerado:', icsContent.substring(0, 200) + '...');
            
            // Criar e baixar arquivo
            const blob = new Blob([icsContent], { 
                type: 'text/calendar;charset=utf-8',
                endings: 'native'
            });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Sistema_Legal_Calendario_${new Date().toISOString().split('T')[0]}.ics`;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao(`Arquivo de calend√°rio gerado com sucesso! (${eventos.length} eventos)`, 'success');
        }

        // 5. INTEGRA√á√ÉO COM SISTEMAS EXTERNOS
        function inicializarIntegracoes() {
            console.log('üîó Inicializando integra√ß√µes externas...');
            
            // Verificar se h√° integra√ß√µes configuradas
            const integracoes = obterIntegracoes();
            
            integracoes.forEach(integracao => {
                if (integracao.ativa) {
                    switch(integracao.tipo) {
                        case 'email':
                            configurarIntegracaoEmail(integracao);
                            break;
                        case 'calendario':
                            configurarIntegracaoCalendario(integracao);
                            break;
                        case 'contabilidade':
                            configurarIntegracaoContabilidade(integracao);
                            break;
                    }
                }
            });
        }

        function configurarIntegracaoEmail(config) {
            console.log('üìß Configurando integra√ß√£o de email:', config);
            // Aqui voc√™ integraria com Gmail API, Outlook API, etc.
        }

        function configurarIntegracaoCalendario(config) {
            console.log('üìÖ Configurando integra√ß√£o de calend√°rio:', config);
            // Aqui voc√™ integraria com Google Calendar, Outlook Calendar, etc.
        }

        function configurarIntegracaoContabilidade(config) {
            console.log('üí∞ Configurando integra√ß√£o de contabilidade:', config);
            // Aqui voc√™ integraria com sistemas de contabilidade
        }



        function obterFaturas() {
            console.log('üîß Fun√ß√£o obterFaturas chamada');
            const faturas = localStorage.getItem('faturas');
            const resultado = faturas ? JSON.parse(faturas) : [];
            console.log('üîß Faturas obtidas:', resultado.length);
            return resultado;
        }

        function obterIntegracoes() {
            console.log('üîß Fun√ß√£o obterIntegracoes chamada');
            const integracoes = localStorage.getItem('integracoes');
            const resultado = integracoes ? JSON.parse(integracoes) : [];
            console.log('üîß Integra√ß√µes obtidas:', resultado.length);
            return resultado;
        }

        function salvarIntegracoes(integracoes) {
            localStorage.setItem('integracoes', JSON.stringify(integracoes));
        }

        // Fun√ß√£o para salvar honor√°rios (CORRIGIDA - v2.0)
        function salvarHonorarios() {
            console.log('üîß Fun√ß√£o salvarHonorarios chamada - v2.0');
            try {
                localStorage.setItem('honorarios', JSON.stringify(honorarios));
                console.log('‚úÖ Honor√°rios salvos com sucesso - v2.0');
            } catch (error) {
                console.error('‚ùå Erro ao salvar honor√°rios:', error);
                mostrarNotificacao('Erro ao salvar honor√°rios!', 'error');
            }
        }





        function gerarFaturasAutomaticas() {
            console.log('üîß Fun√ß√£o gerarFaturasAutomaticas chamada');
            const honorariosComJuros = honorarios.filter(h => h.jurosCalculados && h.jurosCalculados > 0);
            
            if (honorariosComJuros.length === 0) {
                mostrarNotificacao('Nenhum honor√°rio com juros encontrado!', 'info');
                return;
            }
            
            let faturasGeradas = 0;
            honorariosComJuros.forEach(honorario => {
                if (!obterFaturas().find(f => f.honorarioId === honorario.id)) {
                    gerarFaturaAutomatica(honorario.id);
                    faturasGeradas++;
                }
            });
            
            mostrarNotificacao(`${faturasGeradas} faturas geradas automaticamente!`, 'success');
            carregarSecao('dashboard');
        }

        // Fun√ß√µes para gerenciar lembretes
        function editarLembrete(lembreteId) {
            const lembretes = obterLembretes();
            const lembrete = lembretes.find(l => l.id === lembreteId);
            
            if (!lembrete) {
                mostrarNotificacao('Lembrete n√£o encontrado!', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Editar Lembrete</h3>
                        <button onclick="fecharModalRobusto()" class="btn btn-sm btn-secondary">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <form onsubmit="atualizarLembrete(event, ${lembreteId})">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Cliente</label>
                                <select name="clienteId" required class="w-full p-2 border rounded-lg">
                                    <option value="">Selecione um cliente</option>
                                    ${clientes.map(c => `<option value="${c.id}" ${c.id === lembrete.clienteId ? 'selected' : ''}>${c.nome}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">T√≠tulo</label>
                                <input type="text" name="titulo" required class="w-full p-2 border rounded-lg" 
                                       value="${lembrete.titulo}" placeholder="T√≠tulo do lembrete">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Data/Hora</label>
                                <input type="datetime-local" name="data" required class="w-full p-2 border rounded-lg" 
                                       value="${lembrete.data}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Descri√ß√£o</label>
                                <textarea name="descricao" class="w-full p-2 border rounded-lg" rows="3" 
                                          placeholder="Descri√ß√£o do lembrete">${lembrete.descricao}</textarea>
                            </div>
                            <div class="flex space-x-3">
                                <button type="submit" class="btn btn-primary">Atualizar Lembrete</button>
                                <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">Cancelar</button>
                            </div>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function atualizarLembrete(event, lembreteId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const lembretes = obterLembretes();
            const lembreteIndex = lembretes.findIndex(l => l.id === lembreteId);
            
            if (lembreteIndex === -1) {
                mostrarNotificacao('Lembrete n√£o encontrado!', 'error');
                return;
            }
            
            lembretes[lembreteIndex] = {
                ...lembretes[lembreteIndex],
                clienteId: parseInt(formData.get('clienteId')),
                titulo: formData.get('titulo'),
                data: formData.get('data'),
                descricao: formData.get('descricao'),
                atualizadoEm: new Date().toISOString()
            };
            
            localStorage.setItem('lembretes', JSON.stringify(lembretes));
            
            fecharModal();
            mostrarNotificacao('Lembrete atualizado com sucesso!', 'success');
            carregarSecao('dashboard');
        }

        function desativarLembrete(lembreteId) {
            if (!confirm('Tem certeza que deseja desativar este lembrete?')) {
                return;
            }
            
            const lembretes = obterLembretes();
            const lembreteIndex = lembretes.findIndex(l => l.id === lembreteId);
            
            if (lembreteIndex === -1) {
                mostrarNotificacao('Lembrete n√£o encontrado!', 'error');
                return;
            }
            
            lembretes[lembreteIndex].ativo = false;
            lembretes[lembreteIndex].desativadoEm = new Date().toISOString();
            
            localStorage.setItem('lembretes', JSON.stringify(lembretes));
            
            mostrarNotificacao('Lembrete desativado com sucesso!', 'success');
            carregarSecao('dashboard');
        }

        // Fun√ß√£o para configurar integra√ß√µes
        function configurarIntegracoes() {
            console.log('üîß Fun√ß√£o configurarIntegracoes chamada');
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Configurar Integra√ß√µes</h3>
                        <button onclick="fecharModalRobusto()" class="btn btn-sm btn-secondary">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Integra√ß√£o de Email -->
                        <div class="card p-4">
                            <h4 class="font-semibold mb-3">üìß Integra√ß√£o de Email</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Servidor SMTP</label>
                                    <input type="text" id="smtpServer" class="w-full p-2 border rounded-lg" 
                                           placeholder="smtp.gmail.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Porta</label>
                                    <input type="number" id="smtpPort" class="w-full p-2 border rounded-lg" 
                                           placeholder="587" value="587">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Email</label>
                                    <input type="email" id="smtpEmail" class="w-full p-2 border rounded-lg" 
                                           placeholder="seu@email.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Senha</label>
                                    <input type="password" id="smtpPassword" class="w-full p-2 border rounded-lg" 
                                           placeholder="Senha do email">
                                </div>
                                <button onclick="salvarIntegracaoEmail()" class="btn btn-primary">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                    Salvar Configura√ß√£o
                                </button>
                            </div>
                        </div>

                        <!-- Integra√ß√£o de Calend√°rio -->
                        <div class="card p-4">
                            <h4 class="font-semibold mb-3">üìÖ Integra√ß√£o de Calend√°rio</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Tipo de Calend√°rio</label>
                                    <select id="calendarioTipo" class="w-full p-2 border rounded-lg">
                                        <option value="google">Google Calendar</option>
                                        <option value="outlook">Outlook Calendar</option>
                                        <option value="apple">Apple Calendar</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">API Key</label>
                                    <input type="text" id="calendarioApiKey" class="w-full p-2 border rounded-lg" 
                                           placeholder="Chave da API">
                                </div>
                                <button onclick="salvarIntegracaoCalendario()" class="btn btn-primary">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                    Salvar Configura√ß√£o
                                </button>
                            </div>
                        </div>

                        <!-- Integra√ß√£o de Contabilidade -->
                        <div class="card p-4">
                            <h4 class="font-semibold mb-3">üí∞ Integra√ß√£o de Contabilidade</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Sistema</label>
                                    <select id="contabilidadeSistema" class="w-full p-2 border rounded-lg">
                                        <option value="sap">SAP</option>
                                        <option value="oracle">Oracle</option>
                                        <option value="custom">Sistema Personalizado</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">URL da API</label>
                                    <input type="url" id="contabilidadeUrl" class="w-full p-2 border rounded-lg" 
                                           placeholder="https://api.exemplo.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Token de Acesso</label>
                                    <input type="text" id="contabilidadeToken" class="w-full p-2 border rounded-lg" 
                                           placeholder="Token de autentica√ß√£o">
                                </div>
                                <button onclick="salvarIntegracaoContabilidade()" class="btn btn-primary">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                    Salvar Configura√ß√£o
                                </button>
                            </div>
                        </div>

                        <div class="flex space-x-3">
                            <button onclick="fecharModalRobusto()" class="btn btn-secondary">Fechar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function salvarIntegracaoEmail() {
            const config = {
                tipo: 'email',
                servidor: document.getElementById('smtpServer').value,
                porta: document.getElementById('smtpPort').value,
                email: document.getElementById('smtpEmail').value,
                senha: document.getElementById('smtpPassword').value,
                ativa: true,
                configuradaEm: new Date().toISOString()
            };
            
            const integracoes = obterIntegracoes();
            const index = integracoes.findIndex(i => i.tipo === 'email');
            
            if (index >= 0) {
                integracoes[index] = config;
            } else {
                integracoes.push(config);
            }
            
            salvarIntegracoes(integracoes);
            mostrarNotificacao('Configura√ß√£o de email salva com sucesso!', 'success');
        }

        function salvarIntegracaoCalendario() {
            const config = {
                tipo: 'calendario',
                sistema: document.getElementById('calendarioTipo').value,
                apiKey: document.getElementById('calendarioApiKey').value,
                ativa: true,
                configuradaEm: new Date().toISOString()
            };
            
            const integracoes = obterIntegracoes();
            const index = integracoes.findIndex(i => i.tipo === 'calendario');
            
            if (index >= 0) {
                integracoes[index] = config;
            } else {
                integracoes.push(config);
            }
            
            salvarIntegracoes(integracoes);
            mostrarNotificacao('Configura√ß√£o de calend√°rio salva com sucesso!', 'success');
        }

        function salvarIntegracaoContabilidade() {
            const config = {
                tipo: 'contabilidade',
                sistema: document.getElementById('contabilidadeSistema').value,
                url: document.getElementById('contabilidadeUrl').value,
                token: document.getElementById('contabilidadeToken').value,
                ativa: true,
                configuradaEm: new Date().toISOString()
            };
            
            const integracoes = obterIntegracoes();
            const index = integracoes.findIndex(i => i.tipo === 'contabilidade');
            
            if (index >= 0) {
                integracoes[index] = config;
            } else {
                integracoes.push(config);
            }
            
            salvarIntegracoes(integracoes);
            mostrarNotificacao('Configura√ß√£o de contabilidade salva com sucesso!', 'success');
        }

        function carregarDados() {
            try {
                const clientesSalvos = localStorage.getItem('clientes');
                if (clientesSalvos) {
                    clientes = JSON.parse(clientesSalvos);
                    window.clientes = clientes;
                }

                const honorariosSalvos = localStorage.getItem('honorarios');
                if (honorariosSalvos) {
                    honorarios = JSON.parse(honorariosSalvos);
                    window.honorarios = honorarios;
                }

                const contratosSalvos = localStorage.getItem('contratos');
                if (contratosSalvos) {
                    contratos = JSON.parse(contratosSalvos);
                    window.contratos = contratos;
                }

                const prazosSalvos = localStorage.getItem('prazos');
                if (prazosSalvos) {
                    prazos = JSON.parse(prazosSalvos);
                    window.prazos = prazos;
                }

                const notificacoesSalvas = localStorage.getItem('notificacoes');
                if (notificacoesSalvas) {
                    notificacoes = JSON.parse(notificacoesSalvas);
                    window.notificacoes = notificacoes;
                }

                const herancasSalvas = localStorage.getItem('herancas');
                if (herancasSalvas) {
                    herancas = JSON.parse(herancasSalvas);
                    window.herancas = herancas;
                }

                const migracoesSalvas = localStorage.getItem('migracoes');
                if (migracoesSalvas) {
                    migracoes = JSON.parse(migracoesSalvas);
                    window.migracoes = migracoes;
                }

                const registosSalvos = localStorage.getItem('registos');
                if (registosSalvos) {
                    registos = JSON.parse(registosSalvos);
                    window.registos = registos;
                }

                const documentosSalvos = localStorage.getItem('documentos');
                if (documentosSalvos) {
                    documentos = JSON.parse(documentosSalvos);
                    window.documentos = documentos;
                }

                const tarefasSalvas = localStorage.getItem('tarefas');
                if (tarefasSalvas) {
                    tarefas = JSON.parse(tarefasSalvas);
                    window.tarefas = tarefas;
                }

                console.log('‚úÖ Dados carregados com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                mostrarNotificacao('Erro ao carregar dados salvos', 'error');
            }
        }

        function carregarDadosExemplo() {
            // Verificar se os dados foram limpos - se sim, n√£o recriar dados de exemplo
            const dadosLimpos = localStorage.getItem('dadosLimpos');
            if (dadosLimpos === 'true') {
                console.log('üîß Dados foram limpos - n√£o recriando dados de exemplo');
                return;
            }
            
            if (clientes.length === 0) {
                clientes = [
                    {
                        id: 1,
                        nome: 'Jo√£o Silva',
                        email: 'joao@email.com',
                        telefone: '123456789',
                        nif: '123456789',
                        endereco: 'Rua das Flores, 123',
                        status: 'ativo',
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        nome: 'Maria Santos',
                        email: 'maria@email.com',
                        telefone: '987654321',
                        nif: '987654321',
                        endereco: 'Av. Principal, 456',
                        status: 'ativo',
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('clientes', clientes);
            }

            if (honorarios.length === 0) {
                honorarios = [
                    {
                        id: 1,
                        cliente: 'Jo√£o Silva',
                        servico: 'Consulta Jur√≠dica',
                        valor: 150.00,
                        status: 'pago',
                        vencimento: new Date().toISOString().split('T')[0],
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        cliente: 'Maria Santos',
                        servico: 'Elabora√ß√£o de Contrato',
                        valor: 300.00,
                        status: 'pendente',
                        vencimento: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('honorarios', honorarios);
            }

            if (contratos.length === 0) {
                contratos = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'Jo√£o Silva',
                        tipo: 'Presta√ß√£o de Servi√ßos',
                        descricao: 'Assessoria jur√≠dica empresarial',
                        valor: 5000.00,
                        iva: 23,
                        valorIVA: 1150.00,
                        valorTotal: 6150.00,
                        dataInicio: new Date().toISOString().split('T')[0],
                        dataFim: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'ativo',
                        observacoes: 'Contrato de assessoria jur√≠dica anual',
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Consultoria',
                        descricao: 'Consultoria em direito trabalhista',
                        valor: 2500.00,
                        iva: 23,
                        valorIVA: 575.00,
                        valorTotal: 3075.00,
                        dataInicio: new Date().toISOString().split('T')[0],
                        dataFim: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'ativo',
                        observacoes: 'Consultoria espec√≠fica para quest√µes trabalhistas',
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('contratos', contratos);
            }

            if (prazos.length === 0) {
                prazos = [
                    {
                        id: 1,
                        honorarioId: 1,
                        clienteId: 1,
                        clienteNome: 'Jo√£o Silva',
                        tipo: 'Vencimento',
                        descricao: 'Vencimento de honor√°rio - Consultoria jur√≠dica',
                        dataLimite: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
                        status: 'ativo',
                        prioridade: 'alta',
                        notificacoes: [],
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        honorarioId: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Lembrete',
                        descricao: 'Lembrete de pagamento - Elabora√ß√£o de contrato',
                        dataLimite: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                        status: 'ativo',
                        prioridade: 'media',
                        notificacoes: [],
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('prazos', prazos);
            }

            if (notificacoes.length === 0) {
                notificacoes = [];
                salvarDados('notificacoes', notificacoes);
            }

            // Heran√ßas, Migra√ß√µes e Registos sem dados de teste (uso profissional)

        }

        function salvarDados(chave, dados) {
            console.log('üîß salvarDados chamado:', chave, dados);
            try {
                // Verificar se os dados s√£o v√°lidos
                if (!dados || !Array.isArray(dados)) {
                    console.error('‚ùå Dados inv√°lidos para salvar:', dados);
                    mostrarNotificacao('Erro: Dados inv√°lidos', 'error');
                    return;
                }
                
                // Salvar no localStorage
                const dadosString = JSON.stringify(dados);
                localStorage.setItem(chave, dadosString);
                console.log('‚úÖ Dados salvos no localStorage:', chave, dadosString.length, 'caracteres');
                
                // Atualizar vari√°veis globais
                if (chave === 'clientes') {
                    clientes = dados;
                    window.clientes = clientes;
                } else if (chave === 'honorarios') {
                    honorarios = dados;
                    window.honorarios = honorarios;
                } else if (chave === 'contratos') {
                    contratos = dados;
                    window.contratos = contratos;
                } else if (chave === 'prazos') {
                    prazos = dados;
                    window.prazos = prazos;
                } else if (chave === 'notificacoes') {
                    notificacoes = dados;
                    window.notificacoes = notificacoes;
                } else if (chave === 'herancas') {
                    herancas = dados;
                    window.herancas = herancas;
                } else if (chave === 'migracoes') {
                    migracoes = dados;
                    window.migracoes = migracoes;
                } else if (chave === 'registos') {
                    registos = dados;
                    window.registos = registos;
                }
                
                console.log(`‚úÖ Dados ${chave} salvos com sucesso - ${dados.length} itens`);
                
                // Verificar se foi salvo corretamente
                const dadosSalvos = localStorage.getItem(chave);
                if (dadosSalvos) {
                    console.log('‚úÖ Verifica√ß√£o: Dados confirmados no localStorage');
                } else {
                    console.error('‚ùå Verifica√ß√£o: Dados n√£o encontrados no localStorage');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar dados:', error);
                mostrarNotificacao('Erro ao salvar dados: ' + error.message, 'error');
            }
        }

        // === AUDITORIA E LOGS ===
        function obterAuditoria() {
            try {
                return JSON.parse(localStorage.getItem('auditoria') || '[]');
            } catch (error) {
                console.error('‚ùå Erro ao carregar auditoria:', error);
                return [];
            }
        }

        function registrarAuditoria(acao, entidade, descricao, dadosAntes = null, dadosDepois = null) {
            try {
                const tipoUsuario = localStorage.getItem('tipoUsuario') || 'desconhecido';
                const usuarioLogado = localStorage.getItem('usuarioLogado') || 'N/D';
                const auditoria = obterAuditoria();
                auditoria.unshift({
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    usuario: usuarioLogado,
                    tipoUsuario,
                    acao,
                    entidade,
                    descricao,
                    dadosAntes,
                    dadosDepois
                });
                localStorage.setItem('auditoria', JSON.stringify(auditoria.slice(0, 200)));
            } catch (error) {
                console.error('‚ùå Erro ao registrar auditoria:', error);
            }
        }

        function exportarAuditoria() {
            const auditoria = obterAuditoria();
            const blob = new Blob([JSON.stringify(auditoria, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `auditoria_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            mostrarNotificacao('Auditoria exportada com sucesso!', 'success');
        }

        function limparAuditoria() {
            if (!confirm('Deseja limpar o hist√≥rico de auditoria?')) return;
            localStorage.removeItem('auditoria');
            mostrarNotificacao('Auditoria limpa com sucesso!', 'success');
        }

        function escaparHtml(texto) {
            return String(texto)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatarAuditoriaJson(dados) {
            if (!dados) {
                return '<span class="text-xs text-gray-500">Sem dados</span>';
            }
            const json = JSON.stringify(dados, null, 2);
            return `<pre class="text-xs bg-gray-50 border border-gray-200 rounded p-3 overflow-x-auto">${escaparHtml(json)}</pre>`;
        }

        function gerarHistoricoDetalhado() {
            const auditoria = obterAuditoria();
            const usuarios = [...new Set(auditoria.map(item => item.usuario).filter(Boolean))].sort();
            const entidades = [...new Set(auditoria.map(item => item.entidade).filter(Boolean))].sort();
            const acoes = [...new Set(auditoria.map(item => item.acao).filter(Boolean))].sort();
            const tiposUsuario = [...new Set(auditoria.map(item => item.tipoUsuario).filter(Boolean))].sort();
            
            return `
                <div class="space-y-6">
                    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
                        <div>
                            <h2 class="text-2xl font-bold">Hist√≥rico de Altera√ß√µes</h2>
                            <p class="text-sm text-gray-600">Quem mudou o qu√™, quando e em qual sec√ß√£o.</p>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            <button onclick="exportarAuditoria()" class="btn btn-secondary">
                                <i data-lucide="clipboard" class="w-4 h-4"></i>
                                Exportar
                            </button>
                            <button onclick="limparAuditoria()" class="btn btn-danger">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                Limpar
                            </button>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Filtros</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pesquisa</label>
                                <input id="filtroHistoricoTexto" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: cliente, contrato, prazo...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Usu√°rio</label>
                                <select id="filtroHistoricoUsuario" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Todos</option>
                                    ${usuarios.map(u => `<option value="${u}">${u}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo usu√°rio</label>
                                <select id="filtroHistoricoTipoUsuario" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Todos</option>
                                    ${tiposUsuario.map(t => `<option value="${t}">${t}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">A√ß√£o</label>
                                <select id="filtroHistoricoAcao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Todas</option>
                                    ${acoes.map(a => `<option value="${a}">${a}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Entidade</label>
                                <select id="filtroHistoricoEntidade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Todas</option>
                                    ${entidades.map(e => `<option value="${e}">${e}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Per√≠odo</label>
                                <select id="filtroHistoricoPeriodo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Todos</option>
                                    <option value="hoje">Hoje</option>
                                    <option value="semana">Esta semana</option>
                                    <option value="mes">Este m√™s</option>
                                </select>
                            </div>
                            <div class="flex items-end gap-2">
                                <button onclick="aplicarFiltrosHistorico()" class="btn btn-primary">
                                    <i data-lucide="filter" class="w-4 h-4"></i>
                                    Aplicar filtros
                                </button>
                                <button onclick="limparFiltrosHistorico()" class="btn btn-secondary">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                    Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-600" id="historicoResumo"></div>
                    <div id="listaHistoricoDetalhado" class="space-y-3"></div>
                </div>
            `;
        }

        function limparFiltrosHistorico() {
            const campos = [
                'filtroHistoricoTexto',
                'filtroHistoricoUsuario',
                'filtroHistoricoTipoUsuario',
                'filtroHistoricoAcao',
                'filtroHistoricoEntidade',
                'filtroHistoricoPeriodo'
            ];
            campos.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            aplicarFiltrosHistorico();
        }

        function aplicarFiltrosHistorico() {
            const auditoria = obterAuditoria();
            const texto = (document.getElementById('filtroHistoricoTexto')?.value || '').toLowerCase();
            const usuario = document.getElementById('filtroHistoricoUsuario')?.value || '';
            const tipoUsuario = document.getElementById('filtroHistoricoTipoUsuario')?.value || '';
            const acao = document.getElementById('filtroHistoricoAcao')?.value || '';
            const entidade = document.getElementById('filtroHistoricoEntidade')?.value || '';
            const periodo = document.getElementById('filtroHistoricoPeriodo')?.value || '';
            
            let filtrados = auditoria;
            if (usuario) filtrados = filtrados.filter(item => item.usuario === usuario);
            if (tipoUsuario) filtrados = filtrados.filter(item => item.tipoUsuario === tipoUsuario);
            if (acao) filtrados = filtrados.filter(item => item.acao === acao);
            if (entidade) filtrados = filtrados.filter(item => item.entidade === entidade);
            if (texto) {
                filtrados = filtrados.filter(item => {
                    const alvo = [
                        item.usuario,
                        item.tipoUsuario,
                        item.acao,
                        item.entidade,
                        item.descricao
                    ].filter(Boolean).join(' ').toLowerCase();
                    return alvo.includes(texto);
                });
            }
            if (periodo) {
                const agora = new Date();
                const hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
                const inicioSemana = new Date(hoje);
                inicioSemana.setDate(hoje.getDate() - hoje.getDay());
                const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);
                filtrados = filtrados.filter(item => {
                    if (!item.timestamp) return false;
                    const data = new Date(item.timestamp);
                    if (periodo === 'hoje') return data >= hoje;
                    if (periodo === 'semana') return data >= inicioSemana;
                    if (periodo === 'mes') return data >= inicioMes;
                    return true;
                });
            }
            
            renderizarHistoricoDetalhado(filtrados);
        }

        function renderizarHistoricoDetalhado(itens) {
            const resumo = document.getElementById('historicoResumo');
            const container = document.getElementById('listaHistoricoDetalhado');
            if (resumo) {
                resumo.textContent = `Registos: ${itens.length}`;
            }
            if (!container) return;
            if (itens.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-500">Nenhuma altera√ß√£o encontrada.</div>';
                return;
            }
            
            container.innerHTML = itens.slice(0, 200).map(item => `
                <div class="card p-4">
                    <div class="flex flex-col gap-2 lg:flex-row lg:items-start lg:justify-between">
                        <div>
                            <div class="text-sm font-semibold text-gray-800">${(item.acao || '').toUpperCase()} ${item.entidade || ''}</div>
                            <div class="text-xs text-gray-600">${item.descricao || ''}</div>
                            <div class="text-xs text-gray-500">${item.timestamp ? new Date(item.timestamp).toLocaleString('pt-PT') : ''}</div>
                        </div>
                        <div class="text-xs text-gray-500">${item.usuario || 'N/D'} (${item.tipoUsuario || 'N/D'})</div>
                    </div>
                    <details class="mt-3">
                        <summary class="text-sm text-blue-600 cursor-pointer">Ver detalhes</summary>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                            <div>
                                <div class="text-xs font-semibold text-gray-600 mb-1">Antes</div>
                                ${formatarAuditoriaJson(item.dadosAntes)}
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-gray-600 mb-1">Depois</div>
                                ${formatarAuditoriaJson(item.dadosDepois)}
                            </div>
                        </div>
                    </details>
                </div>
            `).join('');
        }

        function registrarErro(contexto, erro, detalhe = null) {
            try {
                const erros = JSON.parse(localStorage.getItem('errosSistema') || '[]');
                erros.unshift({
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    contexto,
                    mensagem: erro?.message || String(erro),
                    detalhe
                });
                localStorage.setItem('errosSistema', JSON.stringify(erros.slice(0, 200)));
            } catch (error) {
                console.error('‚ùå Erro ao registrar erro do sistema:', error);
            }
        }

        function configurarMonitorizacaoErros() {
            window.addEventListener('error', (event) => {
                registrarErro('window.onerror', event.error || event.message, {
                    arquivo: event.filename,
                    linha: event.lineno,
                    coluna: event.colno
                });
            });
            window.addEventListener('unhandledrejection', (event) => {
                registrarErro('unhandledrejection', event.reason);
            });
        }

        // === VALIDA√á√ïES ===
        function validarEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        function normalizarTelefone(telefone) {
            return telefone.replace(/[\s-]/g, '').trim();
        }

        function validarTelefone(telefone) {
            const limpo = normalizarTelefone(telefone);
            return /^[0-9]{9,15}$/.test(limpo);
        }

        function validarNIF(nif) {
            const limpo = (nif || '').replace(/\D/g, '');
            if (!/^\d{9}$/.test(limpo)) return false;
            const prefixosValidos = ['1', '2', '3', '5', '6', '8', '9'];
            if (!prefixosValidos.includes(limpo[0])) return false;
            const soma = limpo
                .split('')
                .slice(0, 8)
                .reduce((acc, digito, idx) => acc + parseInt(digito, 10) * (9 - idx), 0);
            const resto = soma % 11;
            const digitoControle = resto < 2 ? 0 : 11 - resto;
            return digitoControle === parseInt(limpo[8], 10);
        }

        function configurarEventos() {
            document.getElementById('menuHamburguer')?.addEventListener('click', () => {
                toggleSidebar();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    fecharModal();
                }
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
        }

        function carregarSecao(secao) {
            console.log('üîß carregarSecao chamado para:', secao);
            
            // Verificar se √© convidado e redirecionar para clientes se necess√°rio
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            if (tipoUsuario === 'convidado') {
                const secoesPermitidas = ['clientes', 'notificacoes', 'documentos', 'tarefas'];
                if (!secoesPermitidas.includes(secao)) {
                    secao = 'clientes'; // Redirecionar para clientes
                }
            }
            
            // Fechar qualquer modal aberto antes de carregar nova se√ß√£o
            fecharModal();
            
            // Recarregar dados do localStorage antes de gerar conte√∫do
            carregarDados();
            
            secaoAtiva = secao;
            atualizarNavegacao();
            atualizarTitulo(secao);
            
            const conteudo = gerarConteudoSecao(secao);
            console.log('üîß Conte√∫do gerado:', conteudo ? 'SIM' : 'N√ÉO');
            const conteudoElement = document.getElementById('conteudoDinamico');
            if (conteudoElement) {
                conteudoElement.innerHTML = conteudo;
                console.log('‚úÖ Conte√∫do inserido no DOM');
                
                // Atualizar badge de notifica√ß√µes se for a se√ß√£o de notifica√ß√µes
                if (secao === 'notificacoes') {
                    atualizarBadgeNotificacoes();
                }
            } else {
                console.error('‚ùå Elemento conteudoDinamico n√£o encontrado');
            }
            
            inicializarSecao(secao);
            
            // Inicializar filtros para se√ß√µes espec√≠ficas
            if (secao === 'migracoes') {
                setTimeout(() => {
                    aplicarFiltrosMigracoes();
                }, 100);
            }
            
            if (secao === 'contratos') {
                setTimeout(() => {
                    aplicarFiltrosContratos();
                }, 100);
            }
            
            if (secao === 'honorarios') {
                setTimeout(() => {
                    aplicarFiltrosHonorarios();
                }, 100);
            }
            
            if (secao === 'prazos') {
                setTimeout(() => {
                    aplicarFiltrosPrazos();
                    lucide.createIcons();
                }, 100);
            }
            
            if (secao === 'tarefas') {
                setTimeout(() => {
                    aplicarFiltrosTarefas();
                }, 100);
            }
            
            if (secao === 'calendario') {
                setTimeout(() => {
                    inicializarCalendarioPrazos();
                }, 100);
            }
            
            if (secao === 'herancas') {
                console.log('üîß Carregando se√ß√£o herancas');
                console.log('üîß herancas array:', herancas);
                console.log('üîß herancas length:', herancas ? herancas.length : 'undefined');
                setTimeout(() => {
                    if (typeof atualizarListaHerancas === 'function') {
                        console.log('üîß Chamando atualizarListaHerancas');
                        atualizarListaHerancas(herancas);
                    } else {
                        console.log('‚ùå atualizarListaHerancas n√£o √© uma fun√ß√£o');
                    }
                }, 100);
                
                // FOR√áAR CHAMADA ADICIONAL
                setTimeout(() => {
                    console.log('üîß FOR√áANDO CHAMADA ADICIONAL atualizarListaHerancas');
                    if (typeof atualizarListaHerancas === 'function') {
                        atualizarListaHerancas(herancas);
                    }
                }, 500);
                
                // Sem testes diretos no console
            }
            
            if (secao === 'registos') {
                console.log('üîß Carregando se√ß√£o registos');
                console.log('üîß registos array:', registos);
                console.log('üîß registos length:', registos ? registos.length : 'undefined');
                
                // FOR√áAR CHAMADA IMEDIATA
                console.log('üîß FOR√áANDO CHAMADA IMEDIATA atualizarListaRegistos');
                console.log('üîß registos dispon√≠veis:', registos);
                if (typeof atualizarListaRegistos === 'function') {
                    try {
                        atualizarListaRegistos(registos);
                        console.log('‚úÖ atualizarListaRegistos executado imediatamente');
                    } catch (error) {
                        console.error('‚ùå ERRO ao executar atualizarListaRegistos:', error);
                    }
                } else {
                    console.error('‚ùå atualizarListaRegistos n√£o √© uma fun√ß√£o!');
                }
                
                setTimeout(() => {
                    if (typeof atualizarListaRegistos === 'function') {
                        console.log('üîß Chamando atualizarListaRegistos');
                        atualizarListaRegistos(registos);
                    } else {
                        console.log('‚ùå atualizarListaRegistos n√£o √© uma fun√ß√£o');
                    }
                }, 100);
                
                // FOR√áAR CHAMADA ADICIONAL
                setTimeout(() => {
                    console.log('üîß FOR√áANDO CHAMADA ADICIONAL atualizarListaRegistos');
                    if (typeof atualizarListaRegistos === 'function') {
                        atualizarListaRegistos(registos);
                    }
                }, 500);
                
                // Sem testes diretos no console
            }
            
            console.log('‚úÖ Se√ß√£o carregada:', secao);
            
            // Sem execu√ß√£o de testes autom√°ticos para heran√ßas/registos
            
            // S√≥ tentar fechar sidebar se estiver no sistema principal
            if (window.innerWidth <= 1024 && document.getElementById('sidebar')) {
                toggleSidebar();
            }
            
            // Criar gr√°ficos avan√ßados se for a se√ß√£o dashboard
            if (secao === 'dashboard') {
                setTimeout(() => {
                    criarGraficosAvancados();
                }, 500);
            }
        }

        function atualizarNavegacao() {
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            if (sidebarItems.length > 0) {
                sidebarItems.forEach(item => {
                    item.classList.remove('active');
                });
                const activeItem = document.getElementById(`nav-${secaoAtiva}`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }
        }

        function atualizarTitulo(secao) {
            console.log('üîß atualizarTitulo chamado para:', secao);
            
            const titulos = {
                dashboard: 'Vis√£o Geral',
                clientes: 'Gest√£o de Clientes',
                honorarios: 'Gest√£o de Honor√°rios',
                contratos: 'Gest√£o de Contratos',
                prazos: 'Gest√£o de Prazos',
                notificacoes: 'Central de Notifica√ß√µes',
                herancas: 'Gest√£o de Heran√ßas',
                migracoes: 'Gest√£o de Migra√ß√£o',
                registos: 'Gest√£o de Registos',
                documentos: 'Gest√£o de Documentos',
                tarefas: 'Sistema de Tarefas',
                calendario: 'Calend√°rio de Prazos',
                relatorios: 'Gest√£o de Relat√≥rios',
                backup: 'Sistema de Backup',
                historico: 'Hist√≥rico de Altera√ß√µes',
            };
            
            const tituloElement = document.getElementById('tituloSecao');
            const subtituloElement = document.getElementById('subtituloSecao');
            const pageTitleElement = document.getElementById('pageTitle');
            
            console.log('üîß Elementos encontrados:', {
                tituloSecao: tituloElement ? 'SIM' : 'N√ÉO',
                subtituloSecao: subtituloElement ? 'SIM' : 'N√ÉO',
                pageTitle: pageTitleElement ? 'SIM' : 'N√ÉO'
            });
            
            const titulo = titulos[secao] || 'Sistema Legal';
            
            if (tituloElement) {
                tituloElement.textContent = titulo;
                console.log('‚úÖ tituloSecao atualizado para:', titulo);
            }
            if (subtituloElement) {
                subtituloElement.textContent = 'Vis√£o geral do sistema';
            }
            if (pageTitleElement) {
                pageTitleElement.textContent = titulo;
                console.log('‚úÖ pageTitle atualizado para:', titulo);
            }
        }

        function gerarConteudoSecao(secao) {
            console.log('üîß gerarConteudoSecao chamado para:', secao);
            console.log('üîß migracoes array antes:', migracoes);
            
            // Garantir que migracoes existe
            if (!migracoes) {
                migracoes = [];
                console.log('üîß migracoes inicializado como array vazio');
            }

            try {
                const conteudos = {
                    dashboard: gerarDashboard(),
                    clientes: gerarClientes(),
                    honorarios: gerarHonorarios(),
                    contratos: gerarContratos(),
                    prazos: gerarPrazos(),
                    notificacoes: gerarNotificacoes(),
                    herancas: gerarHerancas(),
                    convidados: gerarConvidados(),
                    migracoes: gerarMigracao(),
                    registos: gerarRegistos(),
                documentos: gerarDocumentos(),
                tarefas: gerarTarefas(),
                calendario: gerarCalendarioPrazos(),
                    relatorios: gerarRelatorios(),
                    backup: gerarBackup(),
                historico: gerarHistoricoDetalhado(),
                };
                
                console.log('üîß Conte√∫dos dispon√≠veis:', Object.keys(conteudos));
                console.log('üîß Conte√∫do para migracoes:', conteudos.migracoes ? 'EXISTE' : 'N√ÉO EXISTE');
                console.log('üîß Conte√∫do migracoes:', conteudos.migracoes);
                
                return conteudos[secao] || '<p>Se√ß√£o n√£o encontrada</p>';
            } catch (error) {
                console.error('‚ùå Erro ao gerar conte√∫do da se√ß√£o:', secao, error);
                return `
                    <div class="p-6 bg-red-50 border border-red-200 rounded-lg text-red-700">
                        Ocorreu um erro ao carregar esta se√ß√£o. Atualize a p√°gina (Ctrl+F5).
                    </div>
                `;
            }
        }

        function gerarRelatorioCompleto() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            let clientesParaMostrar = clientes;
            let honorariosParaMostrar = honorarios;
            let herancasParaMostrar = herancas;
            let migracoesParaMostrar = migracoes;
            let registosParaMostrar = registos;
            let contratosParaMostrar = contratos;
            let prazosParaMostrar = prazos;
            
            // Filtrar dados para convidados
            if (tipoUsuario === 'convidado') {
                const convidadoId = localStorage.getItem('convidadoId');
                const convidados = obterConvidados();
                const convidado = convidados.find(c => c.id === parseInt(convidadoId));
                
                if (convidado && convidado.ativo) {
                    const clientesAutorizados = convidado.clientesAutorizados;
                    clientesParaMostrar = clientes.filter(c => clientesAutorizados.includes(c.id));
                    honorariosParaMostrar = honorarios.filter(h => clientesAutorizados.includes(h.clienteId));
                    herancasParaMostrar = herancas.filter(h => clientesAutorizados.includes(h.clienteId));
                    migracoesParaMostrar = migracoes.filter(m => clientesAutorizados.includes(m.clienteId));
                    registosParaMostrar = registos.filter(r => clientesAutorizados.includes(r.clienteId));
                    contratosParaMostrar = contratos.filter(c => clientesAutorizados.includes(c.clienteId));
                    prazosParaMostrar = prazos.filter(p => clientesAutorizados.includes(p.clienteId));
                } else {
                    clientesParaMostrar = [];
                    honorariosParaMostrar = [];
                    herancasParaMostrar = [];
                    migracoesParaMostrar = [];
                    registosParaMostrar = [];
                    contratosParaMostrar = [];
                    prazosParaMostrar = [];
                }
            }
            
            const valorTotalHonorarios = honorariosParaMostrar.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            const valorTotalHerancas = herancasParaMostrar.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            const valorTotalMigracoes = migracoesParaMostrar.reduce((sum, m) => sum + (parseFloat(m.valor) || 0), 0);
            const valorTotalRegistos = registosParaMostrar.reduce((sum, r) => sum + (parseFloat(r.valor) || 0), 0);
            const valorTotalContratos = contratosParaMostrar.reduce((sum, c) => sum + (parseFloat(c.valor) || 0), 0);
            const valorTotalGeral = valorTotalHonorarios + valorTotalHerancas + valorTotalMigracoes + valorTotalRegistos + valorTotalContratos;
            
            const relatorio = `
RELAT√ìRIO COMPLETO - SISTEMA LEGAL
Data: ${new Date().toLocaleDateString('pt-PT')} ${new Date().toLocaleTimeString('pt-PT')}

=== RESUMO GERAL ===
Total de Clientes: ${clientesParaMostrar.length}
Total de Honor√°rios: ${honorariosParaMostrar.length}
Total de Heran√ßas: ${herancasParaMostrar.length}
Total de Migra√ß√µes: ${migracoesParaMostrar.length}
Total de Registos: ${registosParaMostrar.length}
Total de Contratos: ${contratosParaMostrar.length}

=== RESUMO FINANCEIRO ===
Valor Total Honor√°rios: ‚Ç¨${(Math.round(valorTotalHonorarios * 100) / 100).toFixed(2)}
Valor Total Heran√ßas: ‚Ç¨${(Math.round(valorTotalHerancas * 100) / 100).toFixed(2)}
Valor Total Migra√ß√µes: ‚Ç¨${(Math.round(valorTotalMigracoes * 100) / 100).toFixed(2)}
Valor Total Registos: ‚Ç¨${(Math.round(valorTotalRegistos * 100) / 100).toFixed(2)}
Valor Total Contratos: ‚Ç¨${(Math.round(valorTotalContratos * 100) / 100).toFixed(2)}
VALOR TOTAL GERAL: ‚Ç¨${(Math.round(valorTotalGeral * 100) / 100).toFixed(2)}

=== STATUS DOS HONOR√ÅRIOS ===
Pagos: ${honorariosParaMostrar.filter(h => h.status === 'pago').length}
Pendentes: ${honorariosParaMostrar.filter(h => h.status === 'pendente').length}
Vencidos: ${honorariosParaMostrar.filter(h => {
                if (!h.vencimento) return false;
                const dataVencimento = new Date(h.vencimento);
                const hoje = new Date();
                return dataVencimento < hoje && h.status === 'pendente';
            }).length}

=== PRAZOS PR√ìXIMOS (7 dias) ===
${prazos.filter(p => {
                if (!p.dataLimite) return false;
                const dataLimite = new Date(p.dataLimite);
                const hoje = new Date();
                const diferencaDias = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));
                return diferencaDias <= 7 && diferencaDias >= 0 && p.status === 'ativo';
            }).map(p => `- ${p.descricao} (${p.clienteNome}) - ${p.tipo} - ${Math.ceil((new Date(p.dataLimite) - new Date()) / (1000 * 60 * 60 * 24))} dias`).join('\n') || 'Nenhum prazo pr√≥ximo'}

=== TOP 5 CLIENTES POR VALOR ===
${clientesParaMostrar.map(cliente => {
                const valorCliente = honorariosParaMostrar
                    .filter(h => h.clienteId === cliente.id)
                    .reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
                return { ...cliente, valorTotal: valorCliente };
            }).sort((a, b) => b.valorTotal - a.valorTotal).slice(0, 5).map((cliente, index) => 
                `${index + 1}. ${cliente.nome} - ‚Ç¨${(Math.round(cliente.valorTotal * 100) / 100).toFixed(2)}`
            ).join('\n')}

=== RELAT√ìRIO GERADO AUTOMATICAMENTE ===
Sistema Legal - ANA PAULA MEDINA
            `;
            
            // Criar e baixar arquivo
            const blob = new Blob([relatorio], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `relatorio_completo_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('Relat√≥rio completo gerado com sucesso!', 'success');
        }

        // NOVA FUN√á√ÉO: Relat√≥rio personalizado por cliente
        function gerarRelatorioCliente() {
            console.log('üîß Gerando relat√≥rio personalizado por cliente...');
            
            // Verificar se j√° existe um modal aberto
            const modalExistente = document.querySelector('.modal');
            if (modalExistente) {
                console.log('‚ö†Ô∏è Modal j√° existe, removendo...');
                modalExistente.remove();
            }
            
            // Verificar se h√° clientes
            if (!clientes || clientes.length === 0) {
                mostrarNotificacao('Nenhum cliente encontrado para gerar relat√≥rio!', 'warning');
                return;
            }
            
            console.log('‚úÖ Clientes encontrados:', clientes.length);
            
            // Criar modal para sele√ß√£o de cliente
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background-color: rgba(0, 0, 0, 0.7) !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 99999 !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                ">
                    <div class="modal-header" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid #e5e7eb;
                    ">
                        <h3 style="margin: 0; color: #1f2937;">üìä Relat√≥rio Personalizado por Cliente</h3>
                        <button class="close-btn" onclick="fecharModalRobusto()" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #6b7280;
                        ">&times;</button>
                    </div>
                    <div class="modal-body" style="margin-bottom: 20px;">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="clienteSelecionado" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Selecione o Cliente:</label>
                            <select id="clienteSelecionado" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="">-- Escolha um cliente --</option>
                                ${clientes.map(cliente => 
                                    `<option value="${cliente.nome}">${cliente.nome} (${cliente.email})</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="tipoRelatorio" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Tipo de Relat√≥rio:</label>
                            <select id="tipoRelatorio" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="completo">Relat√≥rio Completo</option>
                                <option value="honorarios">Apenas Honor√°rios</option>
                                <option value="contratos">Apenas Contratos</option>
                                <option value="herancas">Apenas Heran√ßas</option>
                                <option value="migracoes">Apenas Migra√ß√µes</option>
                                <option value="registos">Apenas Registos</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="periodoRelatorio" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Per√≠odo:</label>
                            <select id="periodoRelatorio" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="todos">Todos os dados</option>
                                <option value="mes">√öltimo m√™s</option>
                                <option value="trimestre">√öltimo trimestre</option>
                                <option value="ano">√öltimo ano</option>
                                <option value="personalizado">Per√≠odo personalizado</option>
                            </select>
                        </div>
                        <div id="periodoPersonalizado" class="form-group" style="display: none; margin-bottom: 15px;">
                            <label for="dataInicio" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de In√≠cio:</label>
                            <input type="date" id="dataInicio" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                                margin-bottom: 10px;
                            ">
                            <label for="dataFim" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de Fim:</label>
                            <input type="date" id="dataFim" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                        </div>
                    </div>
                    <div class="modal-footer" style="
                        display: flex;
                        justify-content: flex-end;
                        gap: 10px;
                        padding-top: 15px;
                        border-top: 1px solid #e5e7eb;
                    ">
                        <button class="btn btn-secondary" onclick="fecharModalRobusto()" style="
                            padding: 8px 16px;
                            background-color: #6b7280;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                        ">Cancelar</button>
                        <button class="btn btn-primary" onclick="gerarRelatorioClienteSelecionado()" style="
                            padding: 8px 16px;
                            background-color: #3b82f6;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            display: flex;
                            align-items: center;
                            gap: 5px;
                        ">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Gerar Relat√≥rio
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('‚úÖ Modal criado e adicionado ao DOM');
            
            // Verificar se o modal foi criado corretamente
            setTimeout(() => {
                const modalTeste = document.querySelector('.modal');
                if (modalTeste) {
                    console.log('‚úÖ Modal encontrado no DOM');
                    // For√ßar visibilidade do modal
                    modalTeste.style.display = 'flex';
                    modalTeste.style.visibility = 'visible';
                    modalTeste.style.opacity = '1';
                    console.log('‚úÖ Modal for√ßado a ser vis√≠vel');
                } else {
                    console.log('‚ùå Modal n√£o encontrado no DOM');
                }
            }, 100);
            
            // Event listener para per√≠odo personalizado
            setTimeout(() => {
                const periodoSelect = document.getElementById('periodoRelatorio');
                if (periodoSelect) {
                    periodoSelect.addEventListener('change', function() {
                        const periodoPersonalizado = document.getElementById('periodoPersonalizado');
                        if (this.value === 'personalizado') {
                            periodoPersonalizado.style.display = 'block';
                        } else {
                            periodoPersonalizado.style.display = 'none';
                        }
                    });
                    console.log('‚úÖ Event listener adicionado');
                } else {
                    console.log('‚ùå Elemento periodoRelatorio n√£o encontrado');
                }
            }, 100);
        }

        function gerarRelatorioClienteSelecionado() {
            console.log('üîß Iniciando gera√ß√£o de relat√≥rio...');
            
            const clienteSelecionado = document.getElementById('clienteSelecionado').value;
            const tipoRelatorio = document.getElementById('tipoRelatorio').value;
            const periodoRelatorio = document.getElementById('periodoRelatorio').value;
            
            console.log('üìä Dados selecionados:', {
                cliente: clienteSelecionado,
                tipo: tipoRelatorio,
                periodo: periodoRelatorio
            });
            
            if (!clienteSelecionado) {
                mostrarNotificacao('Por favor, selecione um cliente!', 'warning');
                return;
            }
            
            console.log('üîß Gerando relat√≥rio para cliente:', clienteSelecionado);
            
            // Filtrar dados por cliente
            const dadosCliente = {
                honorarios: honorarios ? honorarios.filter(h => h.cliente === clienteSelecionado) : [],
                contratos: contratos ? contratos.filter(c => c.cliente === clienteSelecionado) : [],
                herancas: herancas ? herancas.filter(h => h.cliente === clienteSelecionado) : [],
                migracoes: migracoes ? migracoes.filter(m => m.cliente === clienteSelecionado) : [],
                registos: registos ? registos.filter(r => r.cliente === clienteSelecionado) : []
            };
            
            // Aplicar filtro de per√≠odo se necess√°rio
            if (periodoRelatorio !== 'todos') {
                const agora = new Date();
                let dataLimite = new Date();
                
                switch (periodoRelatorio) {
                    case 'mes':
                        dataLimite.setMonth(agora.getMonth() - 1);
                        break;
                    case 'trimestre':
                        dataLimite.setMonth(agora.getMonth() - 3);
                        break;
                    case 'ano':
                        dataLimite.setFullYear(agora.getFullYear() - 1);
                        break;
                    case 'personalizado':
                        const dataInicio = document.getElementById('dataInicio').value;
                        const dataFim = document.getElementById('dataFim').value;
                        if (!dataInicio || !dataFim) {
                            mostrarNotificacao('Por favor, selecione as datas do per√≠odo personalizado!', 'warning');
                            return;
                        }
                        // Aplicar filtro personalizado
                        Object.keys(dadosCliente).forEach(tipo => {
                            dadosCliente[tipo] = dadosCliente[tipo].filter(item => {
                                const dataItem = new Date(item.data);
                                return dataItem >= new Date(dataInicio) && dataItem <= new Date(dataFim);
                            });
                        });
                        break;
                }
                
                if (periodoRelatorio !== 'personalizado') {
                    Object.keys(dadosCliente).forEach(tipo => {
                        dadosCliente[tipo] = dadosCliente[tipo].filter(item => {
                            const dataItem = new Date(item.data);
                            return dataItem >= dataLimite;
                        });
                    });
                }
            }
            
            // Gerar relat√≥rio
            let relatorio = `RELAT√ìRIO PERSONALIZADO - ${clienteSelecionado.toUpperCase()}\n`;
            relatorio += '==========================================\n\n';
            relatorio += `Cliente: ${clienteSelecionado}\n`;
            relatorio += `Data: ${new Date().toLocaleDateString('pt-PT')}\n`;
            relatorio += `Hora: ${new Date().toLocaleTimeString('pt-PT')}\n`;
            relatorio += `Tipo: ${tipoRelatorio.toUpperCase()}\n`;
            relatorio += `Per√≠odo: ${periodoRelatorio.toUpperCase()}\n\n`;
            
            // Adicionar se√ß√µes baseadas no tipo de relat√≥rio
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'honorarios') {
                relatorio += 'HONOR√ÅRIOS:\n';
                relatorio += '-----------\n';
                if (dadosCliente.honorarios.length > 0) {
                    let totalHonorarios = 0;
                    dadosCliente.honorarios.forEach((honorario, index) => {
                        relatorio += `${index + 1}. ${honorario.descricao}\n`;
                        relatorio += `   Valor: ‚Ç¨${honorario.valor}\n`;
                        relatorio += `   Status: ${honorario.status}\n`;
                        relatorio += `   Data: ${honorario.data}\n\n`;
                        totalHonorarios += parseFloat(honorario.valor) || 0;
                    });
                    relatorio += `TOTAL HONOR√ÅRIOS: ‚Ç¨${totalHonorarios.toFixed(2)}\n\n`;
                } else {
                    relatorio += 'Nenhum honor√°rio encontrado.\n\n';
                }
            }
            
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'contratos') {
                relatorio += 'CONTRATOS:\n';
                relatorio += '----------\n';
                if (dadosCliente.contratos.length > 0) {
                    dadosCliente.contratos.forEach((contrato, index) => {
                        relatorio += `${index + 1}. ${contrato.tipo}\n`;
                        relatorio += `   Valor: ‚Ç¨${contrato.valor}\n`;
                        relatorio += `   Status: ${contrato.status}\n`;
                        relatorio += `   Data: ${contrato.data}\n\n`;
                    });
                } else {
                    relatorio += 'Nenhum contrato encontrado.\n\n';
                }
            }
            
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'herancas') {
                relatorio += 'HERAN√áAS:\n';
                relatorio += '---------\n';
                if (dadosCliente.herancas.length > 0) {
                    dadosCliente.herancas.forEach((heranca, index) => {
                        relatorio += `${index + 1}. ${heranca.tipo}\n`;
                        relatorio += `   Valor: ‚Ç¨${heranca.valor}\n`;
                        relatorio += `   Status: ${heranca.status}\n`;
                        relatorio += `   Data: ${heranca.data}\n\n`;
                    });
                } else {
                    relatorio += 'Nenhuma heran√ßa encontrada.\n\n';
                }
            }
            
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'migracoes') {
                relatorio += 'MIGRA√á√ïES:\n';
                relatorio += '----------\n';
                if (dadosCliente.migracoes.length > 0) {
                    dadosCliente.migracoes.forEach((migracao, index) => {
                        relatorio += `${index + 1}. ${migracao.tipo}\n`;
                        relatorio += `   Valor: ‚Ç¨${migracao.valor}\n`;
                        relatorio += `   Status: ${migracao.status}\n`;
                        relatorio += `   Data: ${migracao.data}\n\n`;
                    });
                } else {
                    relatorio += 'Nenhuma migra√ß√£o encontrada.\n\n';
                }
            }
            
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'registos') {
                relatorio += 'REGISTOS:\n';
                relatorio += '---------\n';
                if (dadosCliente.registos.length > 0) {
                    dadosCliente.registos.forEach((registo, index) => {
                        relatorio += `${index + 1}. ${registo.tipo}\n`;
                        relatorio += `   Valor: ‚Ç¨${registo.valor}\n`;
                        relatorio += `   Status: ${registo.status}\n`;
                        relatorio += `   Data: ${registo.data}\n\n`;
                    });
                } else {
                    relatorio += 'Nenhum registo encontrado.\n\n';
                }
            }
            
            relatorio += '==========================================\n';
            relatorio += 'Relat√≥rio personalizado gerado automaticamente\n';
            relatorio += 'Sistema Legal - Gest√£o Jur√≠dica\n';
            
            // Download do relat√≥rio
            const blob = new Blob([relatorio], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_${clienteSelecionado.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            // Fechar modal - SOLU√á√ÉO ROBUSTA
            setTimeout(() => {
                // Tentar m√∫ltiplas formas de fechar o modal
                const modal = document.querySelector('.modal');
                if (modal) {
                    modal.remove();
                    console.log('‚úÖ Modal de relat√≥rio cliente fechado (m√©todo 1)');
                }
                
                // Tentar fechar todos os modais
                const todosModais = document.querySelectorAll('.modal');
                todosModais.forEach(modal => {
                    modal.remove();
                    console.log('‚úÖ Modal removido (m√©todo 2)');
                });
                
                // Tentar fechar por classe
                const modaisPorClasse = document.querySelectorAll('[class*="modal"]');
                modaisPorClasse.forEach(modal => {
                    modal.remove();
                    console.log('‚úÖ Modal removido por classe (m√©todo 3)');
                });
                
                // For√ßar fechamento
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' && div.style.zIndex === '99999') {
                        div.remove();
                        console.log('‚úÖ Modal removido por estilo (m√©todo 4)');
                    }
                });
                
                console.log('‚úÖ Todos os m√©todos de fechamento executados');
            }, 100);
            
            mostrarNotificacao(`Relat√≥rio personalizado para ${clienteSelecionado} gerado com sucesso!`, 'success');
        }

        // NOVA FUN√á√ÉO: Relat√≥rio financeiro personalizado por cliente
        function gerarRelatorioFinanceiroCliente() {
            console.log('üîß Gerando relat√≥rio financeiro personalizado por cliente...');
            
            // Verificar se j√° existe um modal aberto
            const modalExistente = document.querySelector('.modal');
            if (modalExistente) {
                console.log('‚ö†Ô∏è Modal j√° existe, removendo...');
                modalExistente.remove();
            }
            
            // Verificar se h√° clientes
            if (!clientes || clientes.length === 0) {
                mostrarNotificacao('Nenhum cliente encontrado para gerar relat√≥rio!', 'warning');
                return;
            }
            
            console.log('‚úÖ Clientes encontrados:', clientes.length);
            
            // Criar modal para sele√ß√£o de cliente
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background-color: rgba(0, 0, 0, 0.7) !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 99999 !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                ">
                    <div class="modal-header" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid #e5e7eb;
                    ">
                        <h3 style="margin: 0; color: #1f2937;">üí∞ Relat√≥rio Financeiro Personalizado</h3>
                        <button class="close-btn" onclick="fecharModalRobusto()" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #6b7280;
                        ">&times;</button>
                    </div>
                    <div class="modal-body" style="margin-bottom: 20px;">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="clienteFinanceiroSelecionado" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Selecione o Cliente:</label>
                            <select id="clienteFinanceiroSelecionado" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="">-- Escolha um cliente --</option>
                                ${clientes.map(cliente => 
                                    `<option value="${cliente.nome}">${cliente.nome} (${cliente.email})</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="tipoRelatorioFinanceiro" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Tipo de Relat√≥rio Financeiro:</label>
                            <select id="tipoRelatorioFinanceiro" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="completo">Relat√≥rio Financeiro Completo</option>
                                <option value="honorarios">Apenas Honor√°rios</option>
                                <option value="receitas">Apenas Receitas</option>
                                <option value="pendentes">Apenas Pendentes</option>
                                <option value="pagos">Apenas Pagos</option>
                                <option value="vencidos">Apenas Vencidos</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="periodoRelatorioFinanceiro" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Per√≠odo:</label>
                            <select id="periodoRelatorioFinanceiro" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="todos">Todos os dados</option>
                                <option value="mes">√öltimo m√™s</option>
                                <option value="trimestre">√öltimo trimestre</option>
                                <option value="ano">√öltimo ano</option>
                                <option value="personalizado">Per√≠odo personalizado</option>
                            </select>
                        </div>
                        <div id="periodoPersonalizadoFinanceiro" class="form-group" style="display: none; margin-bottom: 15px;">
                            <label for="dataInicioFinanceiro" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de In√≠cio:</label>
                            <input type="date" id="dataInicioFinanceiro" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                                margin-bottom: 10px;
                            ">
                            <label for="dataFimFinanceiro" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de Fim:</label>
                            <input type="date" id="dataFimFinanceiro" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                        </div>
                    </div>
                    <div class="modal-footer" style="
                        display: flex;
                        justify-content: flex-end;
                        gap: 10px;
                        padding-top: 15px;
                        border-top: 1px solid #e5e7eb;
                    ">
                        <button class="btn btn-secondary" onclick="fecharModalRobusto()" style="
                            padding: 8px 16px;
                            background-color: #6b7280;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                        ">Cancelar</button>
                        <button class="btn btn-primary" onclick="gerarRelatorioFinanceiroClienteSelecionado()" style="
                            padding: 8px 16px;
                            background-color: #10b981;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            display: flex;
                            align-items: center;
                            gap: 5px;
                        ">
                            <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                            Gerar Relat√≥rio
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('‚úÖ Modal financeiro criado e adicionado ao DOM');
            
            // Verificar se o modal foi criado corretamente
            setTimeout(() => {
                const modalTeste = document.querySelector('.modal');
                if (modalTeste) {
                    console.log('‚úÖ Modal financeiro encontrado no DOM');
                    // For√ßar visibilidade do modal
                    modalTeste.style.display = 'flex';
                    modalTeste.style.visibility = 'visible';
                    modalTeste.style.opacity = '1';
                    console.log('‚úÖ Modal financeiro for√ßado a ser vis√≠vel');
                } else {
                    console.log('‚ùå Modal financeiro n√£o encontrado no DOM');
                }
            }, 100);
            
            // Event listener para per√≠odo personalizado
            setTimeout(() => {
                const periodoSelect = document.getElementById('periodoRelatorioFinanceiro');
                if (periodoSelect) {
                    periodoSelect.addEventListener('change', function() {
                        const periodoPersonalizado = document.getElementById('periodoPersonalizadoFinanceiro');
                        if (this.value === 'personalizado') {
                            periodoPersonalizado.style.display = 'block';
                        } else {
                            periodoPersonalizado.style.display = 'none';
                        }
                    });
                    console.log('‚úÖ Event listener financeiro adicionado');
                } else {
                    console.log('‚ùå Elemento periodoRelatorioFinanceiro n√£o encontrado');
                }
            }, 100);
        }

        function gerarRelatorioFinanceiroClienteSelecionado() {
            console.log('üîß Iniciando gera√ß√£o de relat√≥rio financeiro...');
            
            const clienteSelecionado = document.getElementById('clienteFinanceiroSelecionado').value;
            const tipoRelatorio = document.getElementById('tipoRelatorioFinanceiro').value;
            const periodoRelatorio = document.getElementById('periodoRelatorioFinanceiro').value;
            
            console.log('üí∞ Dados financeiros selecionados:', {
                cliente: clienteSelecionado,
                tipo: tipoRelatorio,
                periodo: periodoRelatorio
            });
            
            if (!clienteSelecionado) {
                mostrarNotificacao('Por favor, selecione um cliente!', 'warning');
                return;
            }
            
            console.log('üîß Gerando relat√≥rio financeiro para cliente:', clienteSelecionado);
            
            // Filtrar dados financeiros por cliente
            const dadosFinanceiros = {
                honorarios: honorarios ? honorarios.filter(h => h.cliente === clienteSelecionado) : [],
                contratos: contratos ? contratos.filter(c => c.cliente === clienteSelecionado) : [],
                herancas: herancas ? herancas.filter(h => h.cliente === clienteSelecionado) : [],
                migracoes: migracoes ? migracoes.filter(m => m.cliente === clienteSelecionado) : [],
                registos: registos ? registos.filter(r => r.cliente === clienteSelecionado) : []
            };
            
            // Aplicar filtro de per√≠odo se necess√°rio
            if (periodoRelatorio !== 'todos') {
                const agora = new Date();
                let dataLimite = new Date();
                
                switch (periodoRelatorio) {
                    case 'mes':
                        dataLimite.setMonth(agora.getMonth() - 1);
                        break;
                    case 'trimestre':
                        dataLimite.setMonth(agora.getMonth() - 3);
                        break;
                    case 'ano':
                        dataLimite.setFullYear(agora.getFullYear() - 1);
                        break;
                    case 'personalizado':
                        const dataInicio = document.getElementById('dataInicioFinanceiro').value;
                        const dataFim = document.getElementById('dataFimFinanceiro').value;
                        if (!dataInicio || !dataFim) {
                            mostrarNotificacao('Por favor, selecione as datas do per√≠odo personalizado!', 'warning');
                            return;
                        }
                        // Aplicar filtro personalizado
                        Object.keys(dadosFinanceiros).forEach(tipo => {
                            dadosFinanceiros[tipo] = dadosFinanceiros[tipo].filter(item => {
                                const dataItem = new Date(item.data);
                                return dataItem >= new Date(dataInicio) && dataItem <= new Date(dataFim);
                            });
                        });
                        break;
                }
                
                if (periodoRelatorio !== 'personalizado') {
                    Object.keys(dadosFinanceiros).forEach(tipo => {
                        dadosFinanceiros[tipo] = dadosFinanceiros[tipo].filter(item => {
                            const dataItem = new Date(item.data);
                            return dataItem >= dataLimite;
                        });
                    });
                }
            }
            
            // Calcular totais financeiros
            let totalHonorarios = 0;
            let totalContratos = 0;
            let totalHerancas = 0;
            let totalMigracoes = 0;
            let totalRegistos = 0;
            
            dadosFinanceiros.honorarios.forEach(h => totalHonorarios += parseFloat(h.valor) || 0);
            dadosFinanceiros.contratos.forEach(c => totalContratos += parseFloat(c.valor) || 0);
            dadosFinanceiros.herancas.forEach(h => totalHerancas += parseFloat(h.valor) || 0);
            dadosFinanceiros.migracoes.forEach(m => totalMigracoes += parseFloat(m.valor) || 0);
            dadosFinanceiros.registos.forEach(r => totalRegistos += parseFloat(r.valor) || 0);
            
            const totalGeral = totalHonorarios + totalContratos + totalHerancas + totalMigracoes + totalRegistos;
            
            // Gerar relat√≥rio financeiro
            let relatorio = `RELAT√ìRIO FINANCEIRO PERSONALIZADO - ${clienteSelecionado.toUpperCase()}\n`;
            relatorio += '==================================================\n\n';
            relatorio += `Cliente: ${clienteSelecionado}\n`;
            relatorio += `Data: ${new Date().toLocaleDateString('pt-PT')}\n`;
            relatorio += `Hora: ${new Date().toLocaleTimeString('pt-PT')}\n`;
            relatorio += `Tipo: ${tipoRelatorio.toUpperCase()}\n`;
            relatorio += `Per√≠odo: ${periodoRelatorio.toUpperCase()}\n\n`;
            
            // Resumo financeiro
            relatorio += 'RESUMO FINANCEIRO:\n';
            relatorio += '==================\n';
            relatorio += `Total Geral: ‚Ç¨${totalGeral.toFixed(2)}\n`;
            relatorio += `Honor√°rios: ‚Ç¨${totalHonorarios.toFixed(2)}\n`;
            relatorio += `Contratos: ‚Ç¨${totalContratos.toFixed(2)}\n`;
            relatorio += `Heran√ßas: ‚Ç¨${totalHerancas.toFixed(2)}\n`;
            relatorio += `Migra√ß√µes: ‚Ç¨${totalMigracoes.toFixed(2)}\n`;
            relatorio += `Registos: ‚Ç¨${totalRegistos.toFixed(2)}\n\n`;
            
            // Adicionar se√ß√µes baseadas no tipo de relat√≥rio
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'honorarios') {
                relatorio += 'HONOR√ÅRIOS:\n';
                relatorio += '-----------\n';
                if (dadosFinanceiros.honorarios.length > 0) {
                    let totalHonorariosCliente = 0;
                    dadosFinanceiros.honorarios.forEach((honorario, index) => {
                        relatorio += `${index + 1}. ${honorario.descricao || honorario.servico}\n`;
                        relatorio += `   Valor: ‚Ç¨${honorario.valor}\n`;
                        relatorio += `   Status: ${honorario.status}\n`;
                        relatorio += `   Data: ${honorario.data}\n`;
                        if (honorario.vencimento) {
                            relatorio += `   Vencimento: ${honorario.vencimento}\n`;
                        }
                        relatorio += `\n`;
                        totalHonorariosCliente += parseFloat(honorario.valor) || 0;
                    });
                    relatorio += `TOTAL HONOR√ÅRIOS: ‚Ç¨${totalHonorariosCliente.toFixed(2)}\n\n`;
                } else {
                    relatorio += 'Nenhum honor√°rio encontrado.\n\n';
                }
            }
            
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'receitas') {
                relatorio += 'RECEITAS (Contratos, Heran√ßas, Migra√ß√µes, Registos):\n';
                relatorio += '==================================================\n';
                
                if (dadosFinanceiros.contratos.length > 0) {
                    relatorio += 'CONTRATOS:\n';
                    dadosFinanceiros.contratos.forEach((contrato, index) => {
                        relatorio += `${index + 1}. ${contrato.tipo}\n`;
                        relatorio += `   Valor: ‚Ç¨${contrato.valor}\n`;
                        relatorio += `   Status: ${contrato.status}\n`;
                        relatorio += `   Data: ${contrato.data}\n\n`;
                    });
                }
                
                if (dadosFinanceiros.herancas.length > 0) {
                    relatorio += 'HERAN√áAS:\n';
                    dadosFinanceiros.herancas.forEach((heranca, index) => {
                        relatorio += `${index + 1}. ${heranca.tipo}\n`;
                        relatorio += `   Valor: ‚Ç¨${heranca.valor}\n`;
                        relatorio += `   Status: ${heranca.status}\n`;
                        relatorio += `   Data: ${heranca.data}\n\n`;
                    });
                }
                
                if (dadosFinanceiros.migracoes.length > 0) {
                    relatorio += 'MIGRA√á√ïES:\n';
                    dadosFinanceiros.migracoes.forEach((migracao, index) => {
                        relatorio += `${index + 1}. ${migracao.tipo}\n`;
                        relatorio += `   Valor: ‚Ç¨${migracao.valor}\n`;
                        relatorio += `   Status: ${migracao.status}\n`;
                        relatorio += `   Data: ${migracao.data}\n\n`;
                    });
                }
                
                if (dadosFinanceiros.registos.length > 0) {
                    relatorio += 'REGISTOS:\n';
                    dadosFinanceiros.registos.forEach((registo, index) => {
                        relatorio += `${index + 1}. ${registo.tipo}\n`;
                        relatorio += `   Valor: ‚Ç¨${registo.valor}\n`;
                        relatorio += `   Status: ${registo.status}\n`;
                        relatorio += `   Data: ${registo.data}\n\n`;
                    });
                }
            }
            
            // An√°lise por status
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'pendentes' || tipoRelatorio === 'pagos' || tipoRelatorio === 'vencidos') {
                relatorio += 'AN√ÅLISE POR STATUS:\n';
                relatorio += '==================\n';
                
                const honorariosPendentes = dadosFinanceiros.honorarios.filter(h => h.status === 'pendente');
                const honorariosPagos = dadosFinanceiros.honorarios.filter(h => h.status === 'pago');
                const honorariosVencidos = dadosFinanceiros.honorarios.filter(h => h.status === 'vencido');
                
                relatorio += `Honor√°rios Pendentes: ${honorariosPendentes.length} (‚Ç¨${honorariosPendentes.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0).toFixed(2)})\n`;
                relatorio += `Honor√°rios Pagos: ${honorariosPagos.length} (‚Ç¨${honorariosPagos.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0).toFixed(2)})\n`;
                relatorio += `Honor√°rios Vencidos: ${honorariosVencidos.length} (‚Ç¨${honorariosVencidos.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0).toFixed(2)})\n\n`;
            }
            
            relatorio += '==================================================\n';
            relatorio += 'Relat√≥rio financeiro personalizado gerado automaticamente\n';
            relatorio += 'Sistema Legal - Gest√£o Jur√≠dica\n';
            
            // Download do relat√≥rio
            const blob = new Blob([relatorio], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_financeiro_${clienteSelecionado.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            // Fechar modal - SOLU√á√ÉO ROBUSTA
            setTimeout(() => {
                // Tentar m√∫ltiplas formas de fechar o modal
                const modal = document.querySelector('.modal');
                if (modal) {
                    modal.remove();
                    console.log('‚úÖ Modal de relat√≥rio financeiro fechado (m√©todo 1)');
                }
                
                // Tentar fechar todos os modais
                const todosModais = document.querySelectorAll('.modal');
                todosModais.forEach(modal => {
                    modal.remove();
                    console.log('‚úÖ Modal removido (m√©todo 2)');
                });
                
                // Tentar fechar por classe
                const modaisPorClasse = document.querySelectorAll('[class*="modal"]');
                modaisPorClasse.forEach(modal => {
                    modal.remove();
                    console.log('‚úÖ Modal removido por classe (m√©todo 3)');
                });
                
                // For√ßar fechamento
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' && div.style.zIndex === '99999') {
                        div.remove();
                        console.log('‚úÖ Modal removido por estilo (m√©todo 4)');
                    }
                });
                
                console.log('‚úÖ Todos os m√©todos de fechamento executados');
            }, 100);
            
            mostrarNotificacao(`Relat√≥rio financeiro personalizado para ${clienteSelecionado} gerado com sucesso!`, 'success');
        }

        // NOVA FUN√á√ÉO: Relat√≥rio geral personalizado por cliente
        function gerarRelatorioGeralCliente() {
            console.log('üîß Gerando relat√≥rio geral personalizado por cliente...');
            
            // Verificar se j√° existe um modal aberto
            const modalExistente = document.querySelector('.modal');
            if (modalExistente) {
                console.log('‚ö†Ô∏è Modal j√° existe, removendo...');
                modalExistente.remove();
            }
            
            // Verificar se h√° clientes
            if (!clientes || clientes.length === 0) {
                mostrarNotificacao('Nenhum cliente encontrado para gerar relat√≥rio!', 'warning');
                return;
            }
            
            console.log('‚úÖ Clientes encontrados:', clientes.length);
            
            // Criar modal para sele√ß√£o de cliente
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background-color: rgba(0, 0, 0, 0.7) !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 99999 !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                ">
                    <div class="modal-header" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid #e5e7eb;
                    ">
                        <h3 style="margin: 0; color: #1f2937;">üìä Relat√≥rio Geral Personalizado</h3>
                        <button class="close-btn" onclick="fecharModalRobusto()" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #6b7280;
                        ">&times;</button>
                    </div>
                    <div class="modal-body" style="margin-bottom: 20px;">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="clienteGeralSelecionado" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Selecione o Cliente:</label>
                            <select id="clienteGeralSelecionado" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="">-- Escolha um cliente --</option>
                                ${clientes.map(cliente => 
                                    `<option value="${cliente.nome}">${cliente.nome} (${cliente.email})</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="tipoRelatorioGeral" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Tipo de Relat√≥rio Geral:</label>
                            <select id="tipoRelatorioGeral" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="completo">Relat√≥rio Geral Completo</option>
                                <option value="dados_pessoais">Apenas Dados Pessoais</option>
                                <option value="honorarios">Apenas Honor√°rios</option>
                                <option value="contratos">Apenas Contratos</option>
                                <option value="herancas">Apenas Heran√ßas</option>
                                <option value="migracoes">Apenas Migra√ß√µes</option>
                                <option value="registos">Apenas Registos</option>
                                <option value="documentos">Apenas Documentos</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="periodoRelatorioGeral" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Per√≠odo:</label>
                            <select id="periodoRelatorioGeral" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="todos">Todos os dados</option>
                                <option value="mes">√öltimo m√™s</option>
                                <option value="trimestre">√öltimo trimestre</option>
                                <option value="ano">√öltimo ano</option>
                                <option value="personalizado">Per√≠odo personalizado</option>
                            </select>
                        </div>
                        <div id="periodoPersonalizadoGeral" class="form-group" style="display: none; margin-bottom: 15px;">
                            <label for="dataInicioGeral" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de In√≠cio:</label>
                            <input type="date" id="dataInicioGeral" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                                margin-bottom: 10px;
                            ">
                            <label for="dataFimGeral" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de Fim:</label>
                            <input type="date" id="dataFimGeral" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                        </div>
                    </div>
                    <div class="modal-footer" style="
                        display: flex;
                        justify-content: flex-end;
                        gap: 10px;
                        padding-top: 15px;
                        border-top: 1px solid #e5e7eb;
                    ">
                        <button class="btn btn-secondary" onclick="fecharModalRobusto()" style="
                            padding: 8px 16px;
                            background-color: #6b7280;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                        ">Cancelar</button>
                        <button class="btn btn-primary" onclick="gerarRelatorioGeralClienteSelecionado()" style="
                            padding: 8px 16px;
                            background-color: #6366f1;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            display: flex;
                            align-items: center;
                            gap: 5px;
                        ">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                            Gerar Relat√≥rio
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('‚úÖ Modal geral criado e adicionado ao DOM');
            
            // Verificar se o modal foi criado corretamente
            setTimeout(() => {
                const modalTeste = document.querySelector('.modal');
                if (modalTeste) {
                    console.log('‚úÖ Modal geral encontrado no DOM');
                    // For√ßar visibilidade do modal
                    modalTeste.style.display = 'flex';
                    modalTeste.style.visibility = 'visible';
                    modalTeste.style.opacity = '1';
                    console.log('‚úÖ Modal geral for√ßado a ser vis√≠vel');
                } else {
                    console.log('‚ùå Modal geral n√£o encontrado no DOM');
                }
            }, 100);
            
            // Event listener para per√≠odo personalizado
            setTimeout(() => {
                const periodoSelect = document.getElementById('periodoRelatorioGeral');
                if (periodoSelect) {
                    periodoSelect.addEventListener('change', function() {
                        const periodoPersonalizado = document.getElementById('periodoPersonalizadoGeral');
                        if (this.value === 'personalizado') {
                            periodoPersonalizado.style.display = 'block';
                        } else {
                            periodoPersonalizado.style.display = 'none';
                        }
                    });
                    console.log('‚úÖ Event listener geral adicionado');
                } else {
                    console.log('‚ùå Elemento periodoRelatorioGeral n√£o encontrado');
                }
            }, 100);
        }

        function gerarRelatorioGeralClienteSelecionado() {
            console.log('üîß Iniciando gera√ß√£o de relat√≥rio geral...');
            
            const clienteSelecionado = document.getElementById('clienteGeralSelecionado').value;
            const tipoRelatorio = document.getElementById('tipoRelatorioGeral').value;
            const periodoRelatorio = document.getElementById('periodoRelatorioGeral').value;
            
            console.log('üìä Dados gerais selecionados:', {
                cliente: clienteSelecionado,
                tipo: tipoRelatorio,
                periodo: periodoRelatorio
            });
            
            if (!clienteSelecionado) {
                mostrarNotificacao('Por favor, selecione um cliente!', 'warning');
                return;
            }
            
            console.log('üîß Gerando relat√≥rio geral para cliente:', clienteSelecionado);
            
            // Filtrar dados gerais por cliente
            const dadosGeral = {
                honorarios: honorarios ? honorarios.filter(h => h.cliente === clienteSelecionado) : [],
                contratos: contratos ? contratos.filter(c => c.cliente === clienteSelecionado) : [],
                herancas: herancas ? herancas.filter(h => h.cliente === clienteSelecionado) : [],
                migracoes: migracoes ? migracoes.filter(m => m.cliente === clienteSelecionado) : [],
                registos: registos ? registos.filter(r => r.cliente === clienteSelecionado) : []
            };
            
            // Encontrar dados do cliente
            const cliente = clientes.find(c => c.nome === clienteSelecionado);
            
            // Aplicar filtro de per√≠odo se necess√°rio
            if (periodoRelatorio !== 'todos') {
                const agora = new Date();
                let dataLimite = new Date();
                
                switch (periodoRelatorio) {
                    case 'mes':
                        dataLimite.setMonth(agora.getMonth() - 1);
                        break;
                    case 'trimestre':
                        dataLimite.setMonth(agora.getMonth() - 3);
                        break;
                    case 'ano':
                        dataLimite.setFullYear(agora.getFullYear() - 1);
                        break;
                    case 'personalizado':
                        const dataInicio = document.getElementById('dataInicioGeral').value;
                        const dataFim = document.getElementById('dataFimGeral').value;
                        if (!dataInicio || !dataFim) {
                            mostrarNotificacao('Por favor, selecione as datas do per√≠odo personalizado!', 'warning');
                            return;
                        }
                        // Aplicar filtro personalizado
                        Object.keys(dadosGeral).forEach(tipo => {
                            dadosGeral[tipo] = dadosGeral[tipo].filter(item => {
                                const dataItem = new Date(item.data);
                                return dataItem >= new Date(dataInicio) && dataItem <= new Date(dataFim);
                            });
                        });
                        break;
                }
                
                if (periodoRelatorio !== 'personalizado') {
                    Object.keys(dadosGeral).forEach(tipo => {
                        dadosGeral[tipo] = dadosGeral[tipo].filter(item => {
                            const dataItem = new Date(item.data);
                            return dataItem >= dataLimite;
                        });
                    });
                }
            }
            
            // Gerar relat√≥rio geral
            let relatorio = `RELAT√ìRIO GERAL PERSONALIZADO - ${clienteSelecionado.toUpperCase()}\n`;
            relatorio += '==================================================\n\n';
            relatorio += `Cliente: ${clienteSelecionado}\n`;
            relatorio += `Data: ${new Date().toLocaleDateString('pt-PT')}\n`;
            relatorio += `Hora: ${new Date().toLocaleTimeString('pt-PT')}\n`;
            relatorio += `Tipo: ${tipoRelatorio.toUpperCase()}\n`;
            relatorio += `Per√≠odo: ${periodoRelatorio.toUpperCase()}\n\n`;
            
            // Dados pessoais do cliente
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'dados_pessoais') {
                relatorio += 'DADOS PESSOAIS DO CLIENTE:\n';
                relatorio += '==========================\n';
                if (cliente) {
                    relatorio += `Nome: ${cliente.nome}\n`;
                    relatorio += `Email: ${cliente.email}\n`;
                    relatorio += `Telefone: ${cliente.telefone}\n`;
                    relatorio += `NIF: ${cliente.nif}\n`;
                    relatorio += `Data de Registo: ${cliente.data}\n`;
                    if (cliente.endereco) {
                        relatorio += `Endere√ßo: ${cliente.endereco}\n`;
                    }
                    if (cliente.observacoes) {
                        relatorio += `Observa√ß√µes: ${cliente.observacoes}\n`;
                    }
                }
                relatorio += '\n';
            }
            
            // Honor√°rios
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'honorarios') {
                relatorio += 'HONOR√ÅRIOS:\n';
                relatorio += '-----------\n';
                if (dadosGeral.honorarios.length > 0) {
                    let totalHonorarios = 0;
                    dadosGeral.honorarios.forEach((honorario, index) => {
                        relatorio += `${index + 1}. ${honorario.descricao || honorario.servico}\n`;
                        relatorio += `   Valor: ‚Ç¨${honorario.valor}\n`;
                        relatorio += `   Status: ${honorario.status}\n`;
                        relatorio += `   Data: ${honorario.data}\n`;
                        if (honorario.vencimento) {
                            relatorio += `   Vencimento: ${honorario.vencimento}\n`;
                        }
                        relatorio += `\n`;
                        totalHonorarios += parseFloat(honorario.valor) || 0;
                    });
                    relatorio += `TOTAL HONOR√ÅRIOS: ‚Ç¨${totalHonorarios.toFixed(2)}\n\n`;
                } else {
                    relatorio += 'Nenhum honor√°rio encontrado.\n\n';
                }
            }
            
            // Contratos
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'contratos') {
                relatorio += 'CONTRATOS:\n';
                relatorio += '----------\n';
                if (dadosGeral.contratos.length > 0) {
                    dadosGeral.contratos.forEach((contrato, index) => {
                        relatorio += `${index + 1}. ${contrato.tipo}\n`;
                        relatorio += `   Valor: ‚Ç¨${contrato.valor}\n`;
                        relatorio += `   Status: ${contrato.status}\n`;
                        relatorio += `   Data: ${contrato.data}\n\n`;
                    });
                } else {
                    relatorio += 'Nenhum contrato encontrado.\n\n';
                }
            }
            
            // Heran√ßas
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'herancas') {
                relatorio += 'HERAN√áAS:\n';
                relatorio += '---------\n';
                if (dadosGeral.herancas.length > 0) {
                    dadosGeral.herancas.forEach((heranca, index) => {
                        relatorio += `${index + 1}. ${heranca.tipo}\n`;
                        relatorio += `   Valor: ‚Ç¨${heranca.valor}\n`;
                        relatorio += `   Status: ${heranca.status}\n`;
                        relatorio += `   Data: ${heranca.data}\n\n`;
                    });
                } else {
                    relatorio += 'Nenhuma heran√ßa encontrada.\n\n';
                }
            }
            
            // Migra√ß√µes
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'migracoes') {
                relatorio += 'MIGRA√á√ïES:\n';
                relatorio += '----------\n';
                if (dadosGeral.migracoes.length > 0) {
                    dadosGeral.migracoes.forEach((migracao, index) => {
                        relatorio += `${index + 1}. ${migracao.tipo}\n`;
                        relatorio += `   Valor: ‚Ç¨${migracao.valor}\n`;
                        relatorio += `   Status: ${migracao.status}\n`;
                        relatorio += `   Data: ${migracao.data}\n\n`;
                    });
                } else {
                    relatorio += 'Nenhuma migra√ß√£o encontrada.\n\n';
                }
            }
            
            // Registos
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'registos') {
                relatorio += 'REGISTOS:\n';
                relatorio += '---------\n';
                if (dadosGeral.registos.length > 0) {
                    dadosGeral.registos.forEach((registo, index) => {
                        relatorio += `${index + 1}. ${registo.tipo}\n`;
                        relatorio += `   Valor: ‚Ç¨${registo.valor}\n`;
                        relatorio += `   Status: ${registo.status}\n`;
                        relatorio += `   Data: ${registo.data}\n\n`;
                    });
                } else {
                    relatorio += 'Nenhum registo encontrado.\n\n';
                }
            }
            
            // Resumo estat√≠stico
            if (tipoRelatorio === 'completo') {
                relatorio += 'RESUMO ESTAT√çSTICO:\n';
                relatorio += '===================\n';
                relatorio += `Total de Honor√°rios: ${dadosGeral.honorarios.length}\n`;
                relatorio += `Total de Contratos: ${dadosGeral.contratos.length}\n`;
                relatorio += `Total de Heran√ßas: ${dadosGeral.herancas.length}\n`;
                relatorio += `Total de Migra√ß√µes: ${dadosGeral.migracoes.length}\n`;
                relatorio += `Total de Registos: ${dadosGeral.registos.length}\n\n`;
            }
            
            relatorio += '==================================================\n';
            relatorio += 'Relat√≥rio geral personalizado gerado automaticamente\n';
            relatorio += 'Sistema Legal - Gest√£o Jur√≠dica\n';
            
            // Download do relat√≥rio
            const blob = new Blob([relatorio], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_geral_${clienteSelecionado.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            // Fechar modal - SOLU√á√ÉO ROBUSTA
            setTimeout(() => {
                // Tentar m√∫ltiplas formas de fechar o modal
                const modal = document.querySelector('.modal');
                if (modal) {
                    modal.remove();
                    console.log('‚úÖ Modal de relat√≥rio geral fechado (m√©todo 1)');
                }
                
                // Tentar fechar todos os modais
                const todosModais = document.querySelectorAll('.modal');
                todosModais.forEach(modal => {
                    modal.remove();
                    console.log('‚úÖ Modal removido (m√©todo 2)');
                });
                
                // Tentar fechar por classe
                const modaisPorClasse = document.querySelectorAll('[class*="modal"]');
                modaisPorClasse.forEach(modal => {
                    modal.remove();
                    console.log('‚úÖ Modal removido por classe (m√©todo 3)');
                });
                
                // For√ßar fechamento
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' && div.style.zIndex === '99999') {
                        div.remove();
                        console.log('‚úÖ Modal removido por estilo (m√©todo 4)');
                    }
                });
                
                console.log('‚úÖ Todos os m√©todos de fechamento executados');
            }, 100);
            
            mostrarNotificacao(`Relat√≥rio geral personalizado para ${clienteSelecionado} gerado com sucesso!`, 'success');
        }

        function mostrarInformacoesCompletasCliente(cliente) {
            console.log('üîß Mostrando informa√ß√µes completas do cliente:', cliente.nome);
            
            // Verificar se j√° existe um modal aberto
            const modalExistente = document.querySelector('.modal');
            if (modalExistente) {
                console.log('‚ö†Ô∏è Modal j√° existe, removendo...');
                modalExistente.remove();
            }
            
            // Buscar todos os dados relacionados ao cliente
            const dadosCliente = {
                honorarios: honorarios ? honorarios.filter(h => h.cliente === cliente.nome) : [],
                contratos: contratos ? contratos.filter(c => c.cliente === cliente.nome) : [],
                herancas: herancas ? herancas.filter(h => h.cliente === cliente.nome) : [],
                migracoes: migracoes ? migracoes.filter(m => m.cliente === cliente.nome) : [],
                registos: registos ? registos.filter(r => r.cliente === cliente.nome) : []
            };
            
            // Criar modal com informa√ß√µes completas
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background-color: rgba(0, 0, 0, 0.7) !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 99999 !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 90%;
                    width: 90%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                ">
                    <div class="modal-header" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid #e5e7eb;
                    ">
                        <h3 style="margin: 0; color: #1f2937;">üë§ ${cliente.nome} - Informa√ß√µes Completas</h3>
                        <button class="close-btn" onclick="fecharModalRobusto()" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #6b7280;
                        ">&times;</button>
                    </div>
                    <div class="modal-body" style="margin-bottom: 20px;">
                        <!-- Dados Pessoais -->
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #3b82f6; padding-bottom: 5px;">üìã Dados Pessoais</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                    <strong>Nome:</strong> ${cliente.nome}
                                </div>
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                                    <strong>Email:</strong> ${cliente.email}
                                </div>
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                    <strong>Telefone:</strong> ${cliente.telefone}
                                </div>
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444;">
                                    <strong>NIF:</strong> ${cliente.nif}
                                </div>
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #06b6d4;">
                                    <strong>Status:</strong> ${cliente.status}
                                </div>
                            </div>
                            ${cliente.endereco ? `
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #6366f1; margin-top: 15px;">
                                    <strong>Endere√ßo:</strong> ${cliente.endereco}
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Resumo Estat√≠stico -->
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #10b981; padding-bottom: 5px;">üìä Resumo Estat√≠stico</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${dadosCliente.honorarios.length}</div>
                                    <div style="font-size: 14px;">Honor√°rios</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${dadosCliente.contratos.length}</div>
                                    <div style="font-size: 14px;">Contratos</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${dadosCliente.herancas.length}</div>
                                    <div style="font-size: 14px;">Heran√ßas</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${dadosCliente.migracoes.length}</div>
                                    <div style="font-size: 14px;">Migra√ß√µes</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${dadosCliente.registos.length}</div>
                                    <div style="font-size: 14px;">Registos</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Honor√°rios -->
                        ${dadosCliente.honorarios.length > 0 ? `
                            <div style="margin-bottom: 30px;">
                                <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #3b82f6; padding-bottom: 5px;">üí∞ Honor√°rios (${dadosCliente.honorarios.length})</h4>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${dadosCliente.honorarios.map((honorario, index) => `
                                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #3b82f6;">
                                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                                <div>
                                                    <strong>${honorario.descricao || honorario.servico}</strong><br>
                                                    <span style="color: #6b7280; font-size: 14px;">Valor: ‚Ç¨${honorario.valor} | Status: ${honorario.status}</span><br>
                                                    <span style="color: #6b7280; font-size: 12px;">Data: ${honorario.data}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Contratos -->
                        ${dadosCliente.contratos.length > 0 ? `
                            <div style="margin-bottom: 30px;">
                                <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #10b981; padding-bottom: 5px;">üìÑ Contratos (${dadosCliente.contratos.length})</h4>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${dadosCliente.contratos.map((contrato, index) => `
                                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #10b981;">
                                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                                <div>
                                                    <strong>${contrato.tipo}</strong><br>
                                                    <span style="color: #6b7280; font-size: 14px;">Valor: ‚Ç¨${contrato.valor} | Status: ${contrato.status}</span><br>
                                                    <span style="color: #6b7280; font-size: 12px;">Data: ${contrato.data}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Heran√ßas -->
                        ${dadosCliente.herancas.length > 0 ? `
                            <div style="margin-bottom: 30px;">
                                <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #f59e0b; padding-bottom: 5px;">üèõÔ∏è Heran√ßas (${dadosCliente.herancas.length})</h4>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${dadosCliente.herancas.map((heranca, index) => `
                                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #f59e0b;">
                                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                                <div>
                                                    <strong>${heranca.tipo}</strong><br>
                                                    <span style="color: #6b7280; font-size: 14px;">Valor: ‚Ç¨${heranca.valor} | Status: ${heranca.status}</span><br>
                                                    <span style="color: #6b7280; font-size: 12px;">Data: ${heranca.data}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Migra√ß√µes -->
                        ${dadosCliente.migracoes.length > 0 ? `
                            <div style="margin-bottom: 30px;">
                                <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #8b5cf6; padding-bottom: 5px;">üåç Migra√ß√µes (${dadosCliente.migracoes.length})</h4>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${dadosCliente.migracoes.map((migracao, index) => `
                                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #8b5cf6;">
                                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                                <div>
                                                    <strong>${migracao.tipo}</strong><br>
                                                    <span style="color: #6b7280; font-size: 14px;">Valor: ‚Ç¨${migracao.valor} | Status: ${migracao.status}</span><br>
                                                    <span style="color: #6b7280; font-size: 12px;">Data: ${migracao.data}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Registos -->
                        ${dadosCliente.registos.length > 0 ? `
                            <div style="margin-bottom: 30px;">
                                <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #ef4444; padding-bottom: 5px;">üìù Registos (${dadosCliente.registos.length})</h4>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${dadosCliente.registos.map((registo, index) => `
                                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #ef4444;">
                                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                                <div>
                                                    <strong>${registo.tipo}</strong><br>
                                                    <span style="color: #6b7280; font-size: 14px;">Valor: ‚Ç¨${registo.valor} | Status: ${registo.status}</span><br>
                                                    <span style="color: #6b7280; font-size: 12px;">Data: ${registo.data}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${dadosCliente.honorarios.length === 0 && dadosCliente.contratos.length === 0 && dadosCliente.herancas.length === 0 && dadosCliente.migracoes.length === 0 && dadosCliente.registos.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: #6b7280;">
                                <i data-lucide="file-x" style="width: 48px; height: 48px; margin: 0 auto 20px; display: block;"></i>
                                <h4 style="margin: 0 0 10px 0;">Nenhum documento encontrado</h4>
                                <p style="margin: 0;">Este cliente ainda n√£o possui documentos associados.</p>
                            </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer" style="
                        display: flex;
                        justify-content: flex-end;
                        gap: 10px;
                        padding-top: 15px;
                        border-top: 1px solid #e5e7eb;
                    ">
                        <button class="btn btn-secondary" onclick="fecharModalRobusto()" style="
                            padding: 8px 16px;
                            background-color: #6b7280;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                        ">Fechar</button>
                        <button class="btn btn-primary" onclick="gerarRelatorioClienteEspecifico('${cliente.nome}')" style="
                            padding: 8px 16px;
                            background-color: #3b82f6;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            display: flex;
                            align-items: center;
                            gap: 5px;
                        ">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Gerar Relat√≥rio
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('‚úÖ Modal de informa√ß√µes completas criado');
            
            // Verificar se o modal foi criado corretamente
            setTimeout(() => {
                const modalTeste = document.querySelector('.modal');
                if (modalTeste) {
                    console.log('‚úÖ Modal de informa√ß√µes encontrado no DOM');
                    // For√ßar visibilidade do modal
                    modalTeste.style.display = 'flex';
                    modalTeste.style.visibility = 'visible';
                    modalTeste.style.opacity = '1';
                    console.log('‚úÖ Modal de informa√ß√µes for√ßado a ser vis√≠vel');
                } else {
                    console.log('‚ö†Ô∏è Modal de informa√ß√µes n√£o encontrado no DOM (pode ter sido fechado)');
                }
            }, 200);
        }

        function gerarRelatorioClienteEspecifico(nomeCliente) {
            console.log('üîß Gerando relat√≥rio para cliente espec√≠fico:', nomeCliente);
            
            // Fechar modal atual
            fecharModalRobusto();
            
            // Simular sele√ß√£o do cliente no relat√≥rio
            setTimeout(() => {
                gerarRelatorioCliente();
                
                // Preencher automaticamente o cliente selecionado
                setTimeout(() => {
                    const selectCliente = document.getElementById('clienteSelecionado');
                    if (selectCliente) {
                        selectCliente.value = nomeCliente;
                        console.log('‚úÖ Cliente pr√©-selecionado:', nomeCliente);
                    }
                }, 200);
            }, 100);
        }

        function gerarDashboard() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            let clientesParaMostrar = Array.isArray(clientes) ? clientes : [];
            let honorariosParaMostrar = Array.isArray(honorarios) ? honorarios : [];
            let contratosParaMostrar = Array.isArray(contratos) ? contratos : [];
            let herancasParaMostrar = Array.isArray(herancas) ? herancas : [];
            let migracoesParaMostrar = Array.isArray(migracoes) ? migracoes : [];
            let registosParaMostrar = Array.isArray(registos) ? registos : [];
            let prazosParaMostrar = Array.isArray(prazos) ? prazos : [];
            
            // Filtrar dados para convidados
            if (tipoUsuario === 'convidado') {
                const convidadoId = localStorage.getItem('convidadoId');
                const convidados = obterConvidados();
                const convidado = convidados.find(c => c.id === parseInt(convidadoId));
                
                if (convidado && convidado.ativo) {
                    const clientesAutorizados = convidado.clientesAutorizados;
                    clientesParaMostrar = clientes.filter(c => clientesAutorizados.includes(c.id));
                    honorariosParaMostrar = honorarios.filter(h => clientesAutorizados.includes(h.clienteId));
                    contratosParaMostrar = contratos.filter(c => clientesAutorizados.includes(c.clienteId));
                    herancasParaMostrar = herancas.filter(h => clientesAutorizados.includes(h.clienteId));
                    migracoesParaMostrar = migracoes.filter(m => clientesAutorizados.includes(m.clienteId));
                    registosParaMostrar = registos.filter(r => clientesAutorizados.includes(r.clienteId));
                    prazosParaMostrar = prazos.filter(p => clientesAutorizados.includes(p.clienteId));
                } else {
                    // Se n√£o h√° permiss√µes, mostrar dados vazios
                    clientesParaMostrar = [];
                    honorariosParaMostrar = [];
                    contratosParaMostrar = [];
                    herancasParaMostrar = [];
                    migracoesParaMostrar = [];
                    registosParaMostrar = [];
                    prazosParaMostrar = [];
                }
            }

            const semDados = clientesParaMostrar.length === 0 &&
                honorariosParaMostrar.length === 0 &&
                contratosParaMostrar.length === 0 &&
                herancasParaMostrar.length === 0 &&
                migracoesParaMostrar.length === 0 &&
                registosParaMostrar.length === 0 &&
                prazosParaMostrar.length === 0 &&
                notificacoes.length === 0;

            if (semDados && tipoUsuario !== 'convidado') {
                return `
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-2">Nenhum dado encontrado</h3>
                        <p class="text-gray-600 mb-4">
                            Parece que o sistema ainda n√£o tem dados. Isso √© normal ap√≥s mudar de dom√≠nio.
                            Importe o backup para restaurar tudo automaticamente.
                        </p>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="importarDadosCompletos()" class="btn btn-success">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                Importar backup completo
                            </button>
                            <button onclick="carregarSecao('backup')" class="btn btn-secondary">
                                Ver op√ß√µes de backup
                            </button>
                            <button onclick="carregarSecao('clientes')" class="btn btn-primary">
                                Criar primeiro cliente
                            </button>
                        </div>
                        <div class="mt-4 text-sm text-gray-500">
                            Dica: use o arquivo ` + '`' + `backup_sistema_YYYY-MM-DD.json` + '`' + ` exportado do link antigo.
                        </div>
                    </div>
                `;
            }

            if (semDados && tipoUsuario === 'convidado') {
                return `
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-2">Sem dados dispon√≠veis</h3>
                        <p class="text-gray-600">
                            O administrador ainda n√£o partilhou dados com o seu acesso. Aguarde a autoriza√ß√£o.
                        </p>
                    </div>
                `;
            }
            
            const totalClientes = clientesParaMostrar.length;
            const totalHonorarios = honorariosParaMostrar.length;
            const valorTotal = honorariosParaMostrar.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            const honorariosPagos = honorariosParaMostrar.filter(h => h.status === 'pago').length;
            const honorariosPendentes = honorariosParaMostrar.filter(h => h.status === 'pendente').length;
            const hoje = new Date();
            const honorariosVencidos = honorariosParaMostrar.filter(h => {
                if (!h.vencimento) return false;
                const dataVencimento = new Date(h.vencimento);
                return dataVencimento < hoje && h.status === 'pendente';
            }).length;
            const clientesComHonorarios = new Set(
                honorariosParaMostrar
                    .map(h => h.clienteId || h.cliente || h.clienteNome)
                    .filter(Boolean)
            ).size;
            const totalHerancas = herancasParaMostrar.length;
            const totalMigracoes = migracoesParaMostrar.length;
            const totalRegistos = registosParaMostrar.length;
            
            // Calcular IVA acumulado trimestral
            const agora = new Date();
            const trimestreAtual = Math.floor(agora.getMonth() / 3);
            const anoAtual = agora.getFullYear();
            const inicioTrimestre = new Date(anoAtual, trimestreAtual * 3, 1);
            const fimTrimestre = new Date(anoAtual, (trimestreAtual + 1) * 3, 0);
            
            // Calcular IVA de todos os itens do trimestre atual
            let ivaAcumuladoTrimestral = 0;
            
            // IVA dos honor√°rios do trimestre
            const honorariosTrimestre = honorariosParaMostrar.filter(h => {
                const dataHonorario = new Date(h.dataCriacao);
                return dataHonorario >= inicioTrimestre && dataHonorario <= fimTrimestre;
            });
            honorariosTrimestre.forEach(h => {
                const valor = parseFloat(h.valor) || 0;
                const iva = parseFloat(h.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            // IVA dos contratos do trimestre
            const contratosTrimestre = contratosParaMostrar.filter(c => {
                const dataContrato = new Date(c.dataCriacao);
                return dataContrato >= inicioTrimestre && dataContrato <= fimTrimestre;
            });
            contratosTrimestre.forEach(c => {
                const valor = parseFloat(c.valor) || 0;
                const iva = parseFloat(c.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            // IVA das heran√ßas do trimestre
            const herancasTrimestre = herancasParaMostrar.filter(h => {
                const dataHeranca = new Date(h.dataCriacao);
                return dataHeranca >= inicioTrimestre && dataHeranca <= fimTrimestre;
            });
            herancasTrimestre.forEach(h => {
                const valor = parseFloat(h.valor) || 0;
                const iva = parseFloat(h.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            // IVA das migra√ß√µes do trimestre
            const migracoesTrimestre = migracoesParaMostrar.filter(m => {
                const dataMigracao = new Date(m.dataCriacao);
                return dataMigracao >= inicioTrimestre && dataMigracao <= fimTrimestre;
            });
            migracoesTrimestre.forEach(m => {
                const valor = parseFloat(m.valor) || 0;
                const iva = parseFloat(m.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            // IVA dos registos do trimestre
            const registosTrimestre = registosParaMostrar.filter(r => {
                const dataRegisto = new Date(r.dataCriacao);
                return dataRegisto >= inicioTrimestre && dataRegisto <= fimTrimestre;
            });
            registosTrimestre.forEach(r => {
                const valor = parseFloat(r.valor) || 0;
                const iva = parseFloat(r.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            const nomeTrimestre = ['1¬∫ Trimestre', '2¬∫ Trimestre', '3¬∫ Trimestre', '4¬∫ Trimestre'][trimestreAtual];
            const prazosHoje = prazosParaMostrar.filter(p => {
                if (!p.dataLimite) return false;
                return new Date(p.dataLimite).toDateString() === hoje.toDateString() && p.status === 'ativo';
            }).length;

            const inicioMes = new Date(anoAtual, agora.getMonth(), 1);
            const fimMes = new Date(anoAtual, agora.getMonth() + 1, 0);
            const inicioMesAnterior = new Date(anoAtual, agora.getMonth() - 1, 1);
            const fimMesAnterior = new Date(anoAtual, agora.getMonth(), 0);
            const calcularTotaisPeriodo = (itens, inicio, fim) => {
                let total = 0;
                let iva = 0;
                itens.forEach((item) => {
                    const dataCriacao = item.dataCriacao ? new Date(item.dataCriacao) : null;
                    if (!dataCriacao || Number.isNaN(dataCriacao.getTime())) return;
                    if (dataCriacao >= inicio && dataCriacao <= fim) {
                        const valor = parseFloat(item.valor) || 0;
                        const ivaPercentual = parseFloat(item.iva) || 0;
                        total += valor;
                        iva += (valor * ivaPercentual / 100);
                    }
                });
                return { total, iva };
            };
            const totaisHonorariosMes = calcularTotaisPeriodo(honorariosParaMostrar, inicioMes, fimMes);
            const totaisContratosMes = calcularTotaisPeriodo(contratosParaMostrar, inicioMes, fimMes);
            const totaisHerancasMes = calcularTotaisPeriodo(herancasParaMostrar, inicioMes, fimMes);
            const totaisMigracoesMes = calcularTotaisPeriodo(migracoesParaMostrar, inicioMes, fimMes);
            const totaisRegistosMes = calcularTotaisPeriodo(registosParaMostrar, inicioMes, fimMes);
            const totalEntradasMes = totaisHonorariosMes.total + totaisContratosMes.total + totaisHerancasMes.total + totaisMigracoesMes.total + totaisRegistosMes.total;
            const ivaMes = totaisHonorariosMes.iva + totaisContratosMes.iva + totaisHerancasMes.iva + totaisMigracoesMes.iva + totaisRegistosMes.iva;
            
            const totaisHonorariosMesAnterior = calcularTotaisPeriodo(honorariosParaMostrar, inicioMesAnterior, fimMesAnterior);
            const totaisContratosMesAnterior = calcularTotaisPeriodo(contratosParaMostrar, inicioMesAnterior, fimMesAnterior);
            const totaisHerancasMesAnterior = calcularTotaisPeriodo(herancasParaMostrar, inicioMesAnterior, fimMesAnterior);
            const totaisMigracoesMesAnterior = calcularTotaisPeriodo(migracoesParaMostrar, inicioMesAnterior, fimMesAnterior);
            const totaisRegistosMesAnterior = calcularTotaisPeriodo(registosParaMostrar, inicioMesAnterior, fimMesAnterior);
            const totalEntradasMesAnterior = totaisHonorariosMesAnterior.total + totaisContratosMesAnterior.total + totaisHerancasMesAnterior.total + totaisMigracoesMesAnterior.total + totaisRegistosMesAnterior.total;
            const ivaMesAnterior = totaisHonorariosMesAnterior.iva + totaisContratosMesAnterior.iva + totaisHerancasMesAnterior.iva + totaisMigracoesMesAnterior.iva + totaisRegistosMesAnterior.iva;
            
            const formatarVariacao = (atual, anterior) => {
                if (anterior === 0 && atual === 0) {
                    return { texto: '0%', classe: 'text-gray-600', icone: 'minus' };
                }
                if (anterior === 0) {
                    return { texto: 'Novo', classe: 'text-emerald-600', icone: 'arrow-up-right' };
                }
                const perc = ((atual - anterior) / anterior) * 100;
                const texto = `${perc > 0 ? '+' : ''}${perc.toFixed(1)}%`;
                return {
                    texto,
                    classe: perc >= 0 ? 'text-emerald-600' : 'text-red-600',
                    icone: perc >= 0 ? 'arrow-up-right' : 'arrow-down-right'
                };
            };
            const variacaoEntradas = formatarVariacao(totalEntradasMes, totalEntradasMesAnterior);
            const variacaoIva = formatarVariacao(ivaMes, ivaMesAnterior);

            const proximoPrazo = prazosParaMostrar
                .filter(p => p.dataLimite && p.status === 'ativo')
                .map(p => ({ ...p, dataLimiteDate: new Date(p.dataLimite) }))
                .filter(p => !Number.isNaN(p.dataLimiteDate.getTime()))
                .sort((a, b) => a.dataLimiteDate - b.dataLimiteDate)
                .find(p => p.dataLimiteDate >= hoje) || null;
            const diasParaProximoPrazo = proximoPrazo
                ? Math.ceil((proximoPrazo.dataLimiteDate - hoje) / (1000 * 60 * 60 * 24))
                : null;

            const movimentosRecentes = [
                ...honorariosParaMostrar.map(h => ({
                    tipo: 'Honor√°rio',
                    cliente: h.cliente || h.clienteNome || 'Cliente',
                    valor: h.valor,
                    data: h.dataCriacao || h.data
                })),
                ...herancasParaMostrar.map(h => ({
                    tipo: 'Heran√ßa',
                    cliente: h.cliente || h.clienteNome || h.requerente || 'Cliente',
                    valor: h.valor,
                    data: h.dataCriacao || h.data
                })),
                ...migracoesParaMostrar.map(m => ({
                    tipo: 'Migra√ß√£o',
                    cliente: m.cliente || m.clienteNome || m.requerente || 'Cliente',
                    valor: m.valor,
                    data: m.dataCriacao || m.data
                })),
                ...registosParaMostrar.map(r => ({
                    tipo: 'Registo',
                    cliente: r.cliente || r.clienteNome || r.requerente || 'Cliente',
                    valor: r.valor,
                    data: r.dataCriacao || r.data
                })),
                ...contratosParaMostrar.map(c => ({
                    tipo: 'Contrato',
                    cliente: c.cliente || c.clienteNome || c.requerente || 'Cliente',
                    valor: c.valor,
                    data: c.dataCriacao || c.data
                }))
            ].filter(m => m.data && !Number.isNaN(new Date(m.data).getTime()))
                .sort((a, b) => new Date(b.data) - new Date(a.data))
                .slice(0, 5);

            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Honor√°rios Vencidos</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosVencidos}</p>
                                </div>
                            </div>
                        </div>
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="calendar-clock" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Prazos Hoje</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosHoje}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Clientes</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalClientes}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Honor√°rios</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalHonorarios}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Pagos</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosPagos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-purple-100 rounded-lg">
                                    <i data-lucide="trending-up" class="w-6 h-6 text-purple-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${(Math.round(valorTotal * 100) / 100).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="receipt" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">IVA Acumulado ${nomeTrimestre}</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${Number(ivaAcumuladoTrimestral).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- M√©tricas Avan√ßadas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-indigo-100 rounded-lg">
                                    <i data-lucide="target" class="w-6 h-6 text-indigo-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Taxa de Convers√£o</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalClientes > 0 ? Math.round((clientesComHonorarios / totalClientes) * 100) : 0}%</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-teal-100 rounded-lg">
                                    <i data-lucide="calculator" class="w-6 h-6 text-teal-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">M√©dia por Cliente</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${totalClientes > 0 ? (Math.round((valorTotal / totalClientes) * 100) / 100).toFixed(2) : '0.00'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-orange-100 rounded-lg">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-orange-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Honor√°rios Vencidos</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosVencidos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-pink-100 rounded-lg">
                                    <i data-lucide="clock" class="w-6 h-6 text-pink-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Prazos Pr√≥ximos</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosParaMostrar.filter(p => {
                                        if (!p.dataLimite) return false;
                                        const dataLimite = new Date(p.dataLimite);
                                        const diferencaDias = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));
                                        return diferencaDias <= 7 && diferencaDias >= 0 && p.status === 'ativo';
                                    }).length}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alertas e Resumos Inteligentes -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">üö® Alertas Urgentes</h3>
                            <div class="space-y-3">
                                ${honorariosParaMostrar.filter(h => {
                                    if (!h.vencimento) return false;
                                    const dataVencimento = new Date(h.vencimento);
                                    const hoje = new Date();
                                    return dataVencimento < hoje && h.status === 'pendente';
                                }).slice(0, 3).map(honorario => `
                                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border-l-4 border-red-500">
                                        <div>
                                            <p class="text-sm font-medium text-red-800">${honorario.cliente}</p>
                                            <p class="text-xs text-red-600">Vencido em ${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}</p>
                                        </div>
                                        <span class="text-red-600 font-bold">‚Ç¨${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</span>
                                    </div>
                                `).join('')}
                                ${honorariosParaMostrar.filter(h => {
                                    if (!h.vencimento) return false;
                                    const dataVencimento = new Date(h.vencimento);
                                    const hoje = new Date();
                                    return dataVencimento < hoje && h.status === 'pendente';
                                }).length === 0 ? `
                                    <div class="text-center py-4">
                                        <i data-lucide="check-circle" class="w-8 h-8 text-green-500 mx-auto mb-2"></i>
                                        <p class="text-sm text-green-600">Nenhum honor√°rio vencido!</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">‚è∞ Prazos Pr√≥ximos</h3>
                            ${proximoPrazo ? `
                                <div class="mb-4 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                                    <p class="text-xs text-blue-600 mb-1">Pr√≥ximo prazo</p>
                                    <p class="text-sm font-medium text-blue-800">${proximoPrazo.descricao}</p>
                                    <p class="text-xs text-blue-600">${proximoPrazo.clienteNome} - ${proximoPrazo.dataLimiteDate.toLocaleDateString('pt-PT')} (${diasParaProximoPrazo} dias)</p>
                                </div>
                            ` : ''}
                            <div class="space-y-3">
                                ${prazosParaMostrar.filter(p => {
                                    if (!p.dataLimite) return false;
                                    const dataLimite = new Date(p.dataLimite);
                                    const diferencaDias = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));
                                    return diferencaDias <= 7 && diferencaDias >= 0 && p.status === 'ativo';
                                }).slice(0, 3).map(prazo => `
                                    <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                                        <div>
                                            <p class="text-sm font-medium text-yellow-800">${prazo.descricao}</p>
                                            <p class="text-xs text-yellow-600">${prazo.clienteNome} - ${Math.ceil((new Date(prazo.dataLimite) - new Date()) / (1000 * 60 * 60 * 24))} dias</p>
                                        </div>
                                        <span class="text-yellow-600 font-bold">${prazo.tipo}</span>
                                    </div>
                                `).join('')}
                                ${prazosParaMostrar.filter(p => {
                                    if (!p.dataLimite) return false;
                                    const dataLimite = new Date(p.dataLimite);
                                    const diferencaDias = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));
                                    return diferencaDias <= 7 && diferencaDias >= 0 && p.status === 'ativo';
                                }).length === 0 ? `
                                    <div class="text-center py-4">
                                        <i data-lucide="check-circle" class="w-8 h-8 text-green-500 mx-auto mb-2"></i>
                                        <p class="text-sm text-green-600">Nenhum prazo pr√≥ximo!</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">üìä Resumo Financeiro</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                    <span class="text-green-800 font-medium">Honor√°rios Pagos</span>
                                    <span class="text-green-600 font-bold">${honorariosPagos}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                                    <span class="text-yellow-800 font-medium">Honor√°rios Pendentes</span>
                                    <span class="text-yellow-600 font-bold">${honorariosPendentes}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                    <span class="text-blue-800 font-medium">Valor Total</span>
                                    <span class="text-blue-600 font-bold">‚Ç¨${(Math.round(valorTotal * 100) / 100).toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-indigo-50 rounded-lg">
                                    <span class="text-indigo-800 font-medium">Entradas do M√™s</span>
                                    <span class="text-indigo-600 font-bold">‚Ç¨${(Math.round(totalEntradasMes * 100) / 100).toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-emerald-50 rounded-lg">
                                    <span class="text-emerald-800 font-medium">IVA do M√™s</span>
                                    <span class="text-emerald-600 font-bold">‚Ç¨${(Math.round(ivaMes * 100) / 100).toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                                    <span class="text-purple-800 font-medium">Taxa de Convers√£o</span>
                                    <span class="text-purple-600 font-bold">${totalClientes > 0 ? Math.round((honorariosParaMostrar.filter(h => h.clienteId).length / totalClientes) * 100) : 0}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">üìà Comparativo Mensal</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-3 bg-indigo-50 rounded-lg">
                                    <div>
                                        <span class="text-indigo-800 font-medium">Entradas do M√™s</span>
                                        <p class="text-xs text-indigo-600">M√™s anterior: ‚Ç¨${(Math.round(totalEntradasMesAnterior * 100) / 100).toFixed(2)}</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-indigo-600 font-bold">‚Ç¨${(Math.round(totalEntradasMes * 100) / 100).toFixed(2)}</span>
                                        <div class="flex items-center justify-end gap-1 text-xs ${variacaoEntradas.classe}">
                                            <i data-lucide="${variacaoEntradas.icone}" class="w-3 h-3"></i>
                                            <span>${variacaoEntradas.texto}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-emerald-50 rounded-lg">
                                    <div>
                                        <span class="text-emerald-800 font-medium">IVA do M√™s</span>
                                        <p class="text-xs text-emerald-600">M√™s anterior: ‚Ç¨${(Math.round(ivaMesAnterior * 100) / 100).toFixed(2)}</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-emerald-600 font-bold">‚Ç¨${(Math.round(ivaMes * 100) / 100).toFixed(2)}</span>
                                        <div class="flex items-center justify-end gap-1 text-xs ${variacaoIva.classe}">
                                            <i data-lucide="${variacaoIva.icone}" class="w-3 h-3"></i>
                                            <span>${variacaoIva.texto}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°ficos Avan√ßados -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">üìä Evolu√ß√£o Temporal dos Honor√°rios</h3>
                            <div class="chart-container">
                                <canvas id="chartEvolucaoTemporal"></canvas>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">üìà Compara√ß√£o Mensal</h3>
                            <div class="chart-container">
                                <canvas id="chartComparacaoMensal"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">ü•ß Distribui√ß√£o por Tipo</h3>
                            <div class="chart-container">
                                <canvas id="chartDistribuicaoTipo"></canvas>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">üìà Top 5 Clientes por Valor</h3>
                            <div class="space-y-3">
                                ${clientesParaMostrar.map(cliente => {
                                    const valorCliente = honorariosParaMostrar
                                        .filter(h => h.clienteId === cliente.id)
                                        .reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
                                    return { ...cliente, valorTotal: valorCliente };
                                }).sort((a, b) => b.valorTotal - a.valorTotal).slice(0, 5).map((cliente, index) => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div class="flex items-center">
                                            <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded-full mr-3">${index + 1}</span>
                                            <div>
                                                <p class="font-medium text-gray-800">${cliente.nome}</p>
                                                <p class="text-xs text-gray-600">${cliente.email}</p>
                                            </div>
                                        </div>
                                        <span class="text-blue-600 font-bold">‚Ç¨${(Math.round(cliente.valorTotal * 100) / 100).toFixed(2)}</span>
                                    </div>
                                `).join('')}
                                ${clientesParaMostrar.length === 0 ? `
                                    <div class="text-center py-4">
                                        <i data-lucide="users" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                                        <p class="text-sm text-gray-500">Nenhum cliente encontrado</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">√öltimos Clientes</h3>
                            <div class="space-y-3">
                                ${clientesParaMostrar.slice(-3).map(cliente => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium">${cliente.nome}</p>
                                            <p class="text-sm text-gray-600">${cliente.email}</p>
                                        </div>
                                        <span class="status-badge status-${cliente.status || 'ativo'}">${cliente.status || 'Ativo'}</span>
                                    </div>
                                `).join('')}
                                ${clientesParaMostrar.length === 0 ? `
                                    <div class="text-center py-4">
                                        <i data-lucide="users" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                                        <p class="text-sm text-gray-500">Nenhum cliente encontrado</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">√öltimos Honor√°rios</h3>
                            <div class="space-y-3">
                                ${honorariosParaMostrar.slice(-3).map(honorario => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium">${honorario.cliente}</p>
                                            <p class="text-sm text-gray-600">‚Ç¨${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</p>
                                        </div>
                                        <span class="status-badge status-${honorario.status}">${honorario.status}</span>
                                    </div>
                                `).join('')}
                                ${honorariosParaMostrar.length === 0 ? `
                                    <div class="text-center py-4">
                                        <i data-lucide="receipt" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                                        <p class="text-sm text-gray-500">Nenhum honor√°rio encontrado</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">√öltimos Movimentos</h3>
                            <div class="space-y-3">
                                ${movimentosRecentes.map(movimento => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium">${movimento.tipo} - ${movimento.cliente}</p>
                                            <p class="text-xs text-gray-600">${new Date(movimento.data).toLocaleDateString('pt-PT')}</p>
                                        </div>
                                        <span class="text-blue-600 font-bold">‚Ç¨${(Math.round((parseFloat(movimento.valor) || 0) * 100) / 100).toFixed(2)}</span>
                                    </div>
                                `).join('')}
                                ${movimentosRecentes.length === 0 ? `
                                    <div class="text-center py-4">
                                        <i data-lucide="activity" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                                        <p class="text-sm text-gray-500">Nenhum movimento encontrado</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- A√ß√µes R√°pidas -->
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">‚ö° A√ß√µes R√°pidas</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                            <button onclick="carregarSecao('honorarios')" class="flex items-center justify-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg border border-blue-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-blue-800">Criar Honor√°rio</p>
                                </div>
                            </button>
                            
                            <button onclick="carregarSecao('prazos')" class="flex items-center justify-center p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg border border-yellow-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="clock" class="w-6 h-6 text-yellow-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-yellow-800">Ver Prazos</p>
                                </div>
                            </button>
                            
                            <button onclick="carregarSecao('clientes')" class="flex items-center justify-center p-4 bg-green-50 hover:bg-green-100 rounded-lg border border-green-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="user-plus" class="w-6 h-6 text-green-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-green-800">Novo Cliente</p>
                                </div>
                            </button>

                            <button onclick="carregarSecao('herancas')" class="flex items-center justify-center p-4 bg-emerald-50 hover:bg-emerald-100 rounded-lg border border-emerald-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="home" class="w-6 h-6 text-emerald-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-emerald-800">Nova Heran√ßa</p>
                                </div>
                            </button>

                            <button onclick="carregarSecao('migracoes')" class="flex items-center justify-center p-4 bg-orange-50 hover:bg-orange-100 rounded-lg border border-orange-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="globe" class="w-6 h-6 text-orange-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-orange-800">Nova Migra√ß√£o</p>
                                </div>
                            </button>

                            <button onclick="carregarSecao('registos')" class="flex items-center justify-center p-4 bg-slate-50 hover:bg-slate-100 rounded-lg border border-slate-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="book-open" class="w-6 h-6 text-slate-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-slate-800">Novo Registo</p>
                                </div>
                            </button>
                            
                            <button onclick="gerarRelatorioCompleto()" class="flex items-center justify-center p-4 bg-purple-50 hover:bg-purple-100 rounded-lg border border-purple-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="download" class="w-6 h-6 text-purple-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-purple-800">Relat√≥rio Geral</p>
                                </div>
                            </button>
                            
                            <button onclick="gerarRelatorioCliente()" class="flex items-center justify-center p-4 bg-indigo-50 hover:bg-indigo-100 rounded-lg border border-indigo-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="user-check" class="w-6 h-6 text-indigo-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-indigo-800">Relat√≥rio Cliente</p>
                                </div>
                            </button>
                            
                        </div>
                    </div>

                    <!-- Novas Se√ß√µes -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="home" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Heran√ßas</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalHerancas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-orange-100 rounded-lg">
                                    <i data-lucide="users-2" class="w-6 h-6 text-orange-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Migra√ß√µes</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalMigracoes}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-indigo-100 rounded-lg">
                                    <i data-lucide="book-open" class="w-6 h-6 text-indigo-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Registos</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalRegistos}</p>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            `;
        }

        function criarGraficosAvancados() {
            // Dados para os gr√°ficos
            const dadosEvolucaoTemporal = calcularEvolucaoTemporal();
            const dadosComparacaoMensal = calcularComparacaoMensal();
            const dadosDistribuicaoTipo = calcularDistribuicaoTipo();
            
            // Gr√°fico de Evolu√ß√£o Temporal
            const ctxEvolucao = document.getElementById('chartEvolucaoTemporal');
            if (ctxEvolucao) {
                new Chart(ctxEvolucao, {
                    type: 'line',
                    data: {
                        labels: dadosEvolucaoTemporal.labels,
                        datasets: [{
                            label: 'Honor√°rios (‚Ç¨)',
                            data: dadosEvolucaoTemporal.valores,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '‚Ç¨' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico de Compara√ß√£o Mensal
            const ctxComparacao = document.getElementById('chartComparacaoMensal');
            if (ctxComparacao) {
                new Chart(ctxComparacao, {
                    type: 'bar',
                    data: {
                        labels: dadosComparacaoMensal.labels,
                        datasets: [{
                            label: 'Honor√°rios',
                            data: dadosComparacaoMensal.honorarios,
                            backgroundColor: 'rgba(34, 197, 94, 0.8)'
                        }, {
                            label: 'Heran√ßas',
                            data: dadosComparacaoMensal.herancas,
                            backgroundColor: 'rgba(249, 115, 22, 0.8)'
                        }, {
                            label: 'Migra√ß√µes',
                            data: dadosComparacaoMensal.migracoes,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '‚Ç¨' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico de Distribui√ß√£o por Tipo
            const ctxDistribuicao = document.getElementById('chartDistribuicaoTipo');
            if (ctxDistribuicao) {
                new Chart(ctxDistribuicao, {
                    type: 'doughnut',
                    data: {
                        labels: dadosDistribuicaoTipo.labels,
                        datasets: [{
                            data: dadosDistribuicaoTipo.valores,
                            backgroundColor: [
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(249, 115, 22, 0.8)',
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(168, 85, 247, 0.8)',
                                'rgba(236, 72, 153, 0.8)'
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        function calcularEvolucaoTemporal() {
            const agora = new Date();
            const ultimos6Meses = [];
            
            for (let i = 5; i >= 0; i--) {
                const data = new Date(agora.getFullYear(), agora.getMonth() - i, 1);
                ultimos6Meses.push(data);
            }
            
            const labels = ultimos6Meses.map(data => 
                data.toLocaleDateString('pt-PT', { month: 'short', year: 'numeric' })
            );
            
            const valores = ultimos6Meses.map(data => {
                const inicioMes = new Date(data.getFullYear(), data.getMonth(), 1);
                const fimMes = new Date(data.getFullYear(), data.getMonth() + 1, 0);
                
                return window.honorarios ? window.honorarios.filter(h => {
                    const dataHonorario = new Date(h.dataCriacao);
                    return dataHonorario >= inicioMes && dataHonorario <= fimMes;
                }).reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
            });
            
            return { labels, valores };
        }

        function calcularComparacaoMensal() {
            const agora = new Date();
            const ultimos3Meses = [];
            
            for (let i = 2; i >= 0; i--) {
                const data = new Date(agora.getFullYear(), agora.getMonth() - i, 1);
                ultimos3Meses.push(data);
            }
            
            const labels = ultimos3Meses.map(data => 
                data.toLocaleDateString('pt-PT', { month: 'short', year: 'numeric' })
            );
            
            const valoresHonorarios = ultimos3Meses.map(data => {
                const inicioMes = new Date(data.getFullYear(), data.getMonth(), 1);
                const fimMes = new Date(data.getFullYear(), data.getMonth() + 1, 0);
                
                return window.honorarios ? window.honorarios.filter(h => {
                    const dataHonorario = new Date(h.dataCriacao);
                    return dataHonorario >= inicioMes && dataHonorario <= fimMes;
                }).reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
            });
            
            const valoresHerancas = ultimos3Meses.map(data => {
                const inicioMes = new Date(data.getFullYear(), data.getMonth(), 1);
                const fimMes = new Date(data.getFullYear(), data.getMonth() + 1, 0);
                
                return window.herancas ? window.herancas.filter(h => {
                    const dataHeranca = new Date(h.dataCriacao);
                    return dataHeranca >= inicioMes && dataHeranca <= fimMes;
                }).reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
            });
            
            const valoresMigracoes = ultimos3Meses.map(data => {
                const inicioMes = new Date(data.getFullYear(), data.getMonth(), 1);
                const fimMes = new Date(data.getFullYear(), data.getMonth() + 1, 0);
                
                return window.migracoes ? window.migracoes.filter(m => {
                    const dataMigracao = new Date(m.dataCriacao);
                    return dataMigracao >= inicioMes && dataMigracao <= fimMes;
                }).reduce((sum, m) => sum + (parseFloat(m.valor) || 0), 0) : 0;
            });
            
            return { labels, honorarios: valoresHonorarios, herancas: valoresHerancas, migracoes: valoresMigracoes };
        }

        function calcularDistribuicaoTipo() {
            const valorHonorarios = window.honorarios ? window.honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
            const valorHerancas = window.herancas ? window.herancas.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
            const valorMigracoes = window.migracoes ? window.migracoes.reduce((sum, m) => sum + (parseFloat(m.valor) || 0), 0) : 0;
            const valorRegistos = window.registos ? window.registos.reduce((sum, r) => sum + (parseFloat(r.valor) || 0), 0) : 0;
            const valorContratos = window.contratos ? window.contratos.reduce((sum, c) => sum + (parseFloat(c.valor) || 0), 0) : 0;
            
            return {
                labels: ['Honor√°rios', 'Heran√ßas', 'Migra√ß√µes', 'Registos', 'Contratos'],
                valores: [valorHonorarios, valorHerancas, valorMigracoes, valorRegistos, valorContratos]
            };
        }

        function gerarClientes() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            let clientesParaMostrar = clientes;
            
            // Filtrar clientes para convidados
            if (tipoUsuario === 'convidado') {
                const convidadoId = localStorage.getItem('convidadoId');
                const convidados = obterConvidados();
                const convidado = convidados.find(c => c.id === parseInt(convidadoId));
                
                console.log('üîß Convidado encontrado:', convidado);
                console.log('üîß Clientes autorizados:', convidado?.clientesAutorizados);
                console.log('üîß Total de clientes:', clientes.length);
                
                if (convidado && convidado.ativo) {
                    // Permitir que convidados vejam clientes autorizados E clientes que eles criaram
                    const clientesAutorizados = convidado.clientesAutorizados || [];
                    const clientesCriadosPeloConvidado = clientes.filter(cliente => 
                        cliente.criadoPorConvidado === parseInt(convidadoId)
                    );
                    
                    clientesParaMostrar = clientes.filter(cliente => 
                        clientesAutorizados.includes(cliente.id) || 
                        cliente.criadoPorConvidado === parseInt(convidadoId)
                    );
                    
                    console.log('üîß Clientes para mostrar:', clientesParaMostrar.length);
                } else {
                    clientesParaMostrar = []; // Nenhum cliente se n√£o h√° permiss√µes
                }
            }
            
            const botaoNovoCliente = `
                <button onclick="abrirModal('cliente')" class="btn btn-primary">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Novo Cliente
                </button>
            `;
            
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        ${botaoNovoCliente}
                    </div>

                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaClientes" placeholder="Buscar clientes..." 
                                   class="search-input" onkeyup="filtrarClientes()">
                        </div>
                        
                        <!-- Filtros Avan√ßados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosClientes()">
                                    <option value="">Todos os status</option>
                                    <option value="ativo">Ativo</option>
                                    <option value="inativo">Inativo</option>
                                    <option value="suspenso">Suspenso</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Cria√ß√£o</label>
                                <select id="filtroDataCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosClientes()">
                                    <option value="">Todas as datas</option>
                                    <option value="hoje">Hoje</option>
                                    <option value="semana">Esta semana</option>
                                    <option value="mes">Este m√™s</option>
                                    <option value="ano">Este ano</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Buscar por NIF</label>
                                <input type="text" id="buscaNifClientes" placeholder="Digite o NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onkeyup="aplicarFiltrosClientes()">
                                <!-- CACHE UPDATE: Campo NIF adicionado -->
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosClientes()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorClientes">0</span> clientes encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="p-6">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nome <span class="text-xs text-blue-500">(clique para ver)</span></th>
                                            <th>Email</th>
                                            <th>Telefone</th>
                                            <th>NIF</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaClientes">
                                        ${clientesParaMostrar.map(cliente => `
                                            <tr>
                                                <td>
                                                    <button onclick="mostrarInformacoesCompletasCliente(${JSON.stringify(cliente).replace(/"/g, '&quot;')})" 
                                                            class="text-blue-600 hover:text-blue-800 font-medium cursor-pointer hover:underline flex items-center gap-1" 
                                                            title="Clicar para ver informa√ß√µes completas">
                                                        <i data-lucide="user" class="w-4 h-4"></i>
                                                        ${cliente.nome}
                                                    </button>
                                                </td>
                                                <td>${cliente.email}</td>
                                                <td>${cliente.telefone}</td>
                                                <td>${cliente.nif || '-'}</td>
                                                <td><span class="status-badge status-${cliente.status || 'ativo'}">${cliente.status || 'Ativo'}</span></td>
                                                <td>
                                                    <button onclick="editarItem('cliente', ${cliente.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="abrirAnexosCliente(${cliente.id})" class="text-green-600 hover:text-green-800" title="Documentos">
                                                        <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarHonorarios() {
            const honorariosPagos = honorarios.filter(h => h.status === 'pago').length;
            const honorariosPendentes = honorarios.filter(h => h.status === 'pendente').length;
            const honorariosVencidos = honorarios.filter(h => h.status === 'vencido').length;
            const valorTotal = honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <button onclick="abrirModal('honorario')" class="btn btn-primary">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Novo Honor√°rio
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Pagos</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosPagos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="clock" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Pendentes</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosPendentes}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="alert-circle" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Vencidos</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosVencidos}</p>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${(Math.round(valorTotal * 100) / 100).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaHonorarios" placeholder="Buscar honor√°rios..." 
                                   class="search-input" onkeyup="filtrarHonorarios()">
                        </div>
                        
                        <!-- Filtros Avan√ßados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusHonorario" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="pago">Pago</option>
                                    <option value="vencido">Vencido</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor M√≠nimo</label>
                                <input type="number" id="filtroValorMinHonorario" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor M√°ximo</label>
                                <input type="number" id="filtroValorMaxHonorario" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                                <select id="filtroVencimentoHonorario" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                                    <option value="">Todas as datas</option>
                                    <option value="hoje">Vence hoje</option>
                                    <option value="semana">Esta semana</option>
                                    <option value="mes">Este m√™s</option>
                                    <option value="vencido">Vencidos</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosHonorarios()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorHonorarios">0</span> honor√°rios encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="p-6">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Servi√ßo</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>Vencimento</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaHonorarios">
                                        ${honorarios.map(honorario => `
                                            <tr>
                                                <td>${honorario.cliente}</td>
                                                <td>${honorario.servico}</td>
                                                <td>‚Ç¨${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</td>
                                                <td><span class="status-badge status-${honorario.status}">${honorario.status}</span></td>
                                                <td>${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}</td>
                                                <td>
                                                    <button onclick="editarItem('honorario', ${honorario.id})" class="text-blue-600 hover:text-blue-800">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="excluirItem('honorario', ${honorario.id})" class="text-red-600 hover:text-red-800 ml-2">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarContratos() {
            const contratosAtivos = contratos.filter(c => c.status === 'ativo').length;
            const contratosSuspensos = contratos.filter(c => c.status === 'suspenso').length;
            const contratosTerminados = contratos.filter(c => c.status === 'terminado').length;
            const valorTotalContratos = contratos.reduce((sum, c) => {
                const valor = parseFloat(c.valor) || 0;
                return sum + valor;
            }, 0);

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <button onclick="abrirModal('contrato')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                            Novo Contrato
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${contratosAtivos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Suspensos</p>
                                    <p class="text-2xl font-bold text-gray-900">${contratosSuspensos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Terminados</p>
                                    <p class="text-2xl font-bold text-gray-900">${contratosTerminados}</p>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${Math.round(valorTotalContratos * 100) / 100}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaContratos" placeholder="Buscar contratos..." 
                                   class="search-input" onkeyup="filtrarContratos()">
                        </div>
                        
                        <!-- Filtros Avan√ßados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusContrato" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosContratos()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Conclu√≠do</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                                <select id="filtroClienteContrato" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosContratos()">
                                    <option value="">Todos os clientes</option>
                                    ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIF</label>
                                <input type="text" id="filtroNifContrato" placeholder="Buscar por NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosContratos()">
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosContratos()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorContratos">0</span> contratos encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="p-6">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th class="font-bold">Cliente</th>
                                            <th class="font-bold">Tipo</th>
                                            <th class="font-bold">Descri√ß√£o</th>
                                            <th class="font-bold">Valor</th>
                                            <th class="font-bold">Status</th>
                                            <th class="font-bold">Data In√≠cio</th>
                                            <th class="font-bold">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaContratos">
                                        ${contratos.map(contrato => `
                                            <tr>
                                                <td>${contrato.clienteNome}</td>
                                                <td>${contrato.tipo}</td>
                                                <td>${contrato.descricao}</td>
                                                <td>
                                                    <div class="flex flex-col">
                                                        <div class="text-sm font-medium text-gray-900">‚Ç¨${(Math.round((parseFloat(contrato.valor) || 0) * 100) / 100).toFixed(2)}</div>
                                                        <div class="text-xs text-gray-500">
                                                            <span class="text-gray-400">+ ${contrato.iva || 0}% IVA:</span>
                                                            <span class="font-medium text-gray-700">‚Ç¨${(Math.round((parseFloat(contrato.valorTotal || contrato.valor) || 0) * 100) / 100).toFixed(2)}</span>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td><span class="status-badge status-${contrato.status}">${contrato.status === 'concluido' ? 'Conclu√≠do' : contrato.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span></td>
                                                <td>${new Date(contrato.dataInicio).toLocaleDateString('pt-PT')}</td>
                                                <td>
                                                    <button onclick="editarContratoDireto(${contrato.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="abrirAnexosContrato(${contrato.id})" class="text-green-600 hover:text-green-800 mr-2" title="Documentos">
                                                        <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="excluirContratoDireto(${contrato.id})" class="text-red-600 hover:text-red-800" title="Excluir">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarPrazos() {
            const prazosAtivos = prazos.filter(p => p.status === 'ativo').length;
            const prazosVencidos = prazos.filter(p => p.status === 'vencido').length;
            const prazosUrgentes = prazos.filter(p => p.prioridade === 'alta' || p.prioridade === 'critica').length;
            const prazosHoje = prazos.filter(p => {
                try {
                    if (!p.dataLimite) return false;
                    const hoje = new Date().toISOString().split('T')[0];
                    const dataLimite = new Date(p.dataLimite).toISOString().split('T')[0];
                    return dataLimite === hoje && p.status === 'ativo';
                } catch (error) {
                    console.warn('Erro ao processar data do prazo:', p.dataLimite);
                    return false;
                }
            }).length;

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600 bg-blue-50 px-3 py-2 rounded-lg">
                            <i data-lucide="info" class="w-4 h-4 inline mr-2"></i>
                            Prazos criados automaticamente pelas √°reas de execu√ß√£o
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="clock" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosAtivos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Vencidos</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosVencidos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-orange-100 rounded-lg">
                                    <i data-lucide="zap" class="w-6 h-6 text-orange-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Urgentes</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosUrgentes}</p>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="calendar" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Hoje</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosHoje}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informa√ß√£o sobre prazos autom√°ticos -->
                    <div class="card p-6 bg-blue-50 border-l-4 border-blue-400">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i data-lucide="clock" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-blue-800">Prazos Autom√°ticos</h3>
                                <div class="mt-2 text-sm text-blue-700">
                                    <p>Os prazos s√£o criados automaticamente quando voc√™ adiciona itens nas √°reas de execu√ß√£o:</p>
                                    <ul class="mt-2 list-disc list-inside space-y-1">
                                        <li><strong>Contratos:</strong> Prazo de 30 dias</li>
                                        <li><strong>Heran√ßas:</strong> Prazo de 60 dias</li>
                                        <li><strong>Migra√ß√£o:</strong> Prazo de 90 dias</li>
                                        <li><strong>Registos:</strong> Prazo de 15 dias</li>
                                    </ul>
                                    <p class="mt-2 text-xs text-blue-600">Voc√™ pode editar ou excluir prazos conforme necess√°rio.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaPrazos" placeholder="Buscar prazos..." 
                                   class="search-input" onkeyup="filtrarPrazos()">
                        </div>
                        
                        <!-- Filtros Avan√ßados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Conclu√≠do</option>
                                    <option value="vencido">Vencido</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="filtroTipoPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                                    <option value="">Todos os tipos</option>
                                    <option value="contrato">Contrato</option>
                                    <option value="heranca">Heran√ßa</option>
                                    <option value="migracao">Migra√ß√£o</option>
                                    <option value="registo">Registo</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                                <select id="filtroVencimentoPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                                    <option value="">Todas as datas</option>
                                    <option value="hoje">Vence hoje</option>
                                    <option value="semana">Esta semana</option>
                                    <option value="mes">Este m√™s</option>
                                    <option value="vencido">Vencidos</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                <select id="filtroPrioridadePrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                                    <option value="">Todas as prioridades</option>
                                    <option value="baixa">Baixa</option>
                                    <option value="media">M√©dia</option>
                                    <option value="alta">Alta</option>
                                    <option value="urgente">Urgente</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosPrazos()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorPrazos">0</span> prazos encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="p-6">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Tipo</th>
                                            <th>Descri√ß√£o</th>
                                            <th>Data Limite</th>
                                            <th>Prioridade</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaPrazos">
                                        ${prazos.map(prazo => `
                                            <tr>
                                                <td>${prazo.clienteNome}</td>
                                                <td>${prazo.tipo}</td>
                                                <td>${prazo.descricao}</td>
                                                <td>${prazo.dataLimite ? new Date(prazo.dataLimite).toLocaleDateString('pt-PT') : 'Data n√£o definida'}</td>
                                                <td><span class="status-badge status-${prazo.prioridade}">${prazo.prioridade}</span></td>
                                                <td><span class="status-badge status-${prazo.status}">${prazo.status}</span></td>
                                                <td>
                                                    <button onclick="editarItem('prazo', ${prazo.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="abrirAnexosPrazo(${prazo.id})" class="text-green-600 hover:text-green-800 mr-2">
                                                        <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="excluirItem('prazo', ${prazo.id})" class="text-red-600 hover:text-red-800">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarNotificacoes() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const convidadoId = localStorage.getItem('convidadoId');
            
            // Filtrar notifica√ß√µes baseado no tipo de usu√°rio
            let notificacoesFiltradas = notificacoes;
            
            if (tipoUsuario === 'convidado') {
                // Para convidados: apenas notifica√ß√µes direcionadas a eles
                notificacoesFiltradas = notificacoes.filter(n => 
                    n.destinatarioId === parseInt(convidadoId) || 
                    n.destinatarioId === 'todos' ||
                    n.tipo === 'cliente_autorizado' ||
                    n.tipo === 'documento_anexado' ||
                    n.tipo === 'prazo_proximo'
                );
            }
            
            const notificacoesNaoLidas = notificacoesFiltradas.filter(n => !n.lida).length;
            const notificacoesHoje = notificacoesFiltradas.filter(n => {
                try {
                    if (!n.dataCriacao) return false;
                    const hoje = new Date().toISOString().split('T')[0];
                    const dataNotificacao = new Date(n.dataCriacao).toISOString().split('T')[0];
                    return dataNotificacao === hoje;
                } catch (error) {
                    console.warn('Erro ao processar data da notifica√ß√£o:', n.dataCriacao);
                    return false;
                }
            }).length;

            return `
                <div class="space-y-6">
            <div class="flex justify-between items-center">
                <div class="flex space-x-3">
                    ${tipoUsuario === 'admin' ? `
                        <button onclick="criarNotificacaoTeste()" class="btn btn-info">
                            <i data-lucide="test-tube" class="w-4 h-4"></i>
                            Teste Aleat√≥rio
                        </button>
                        <button onclick="criarNotificacaoPersonalizada()" class="btn btn-warning">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                            Criar Personalizada
                        </button>
                        <button onclick="enviarMensagemConvidado()" class="btn btn-primary">
                            <i data-lucide="send" class="w-4 h-4"></i>
                            Enviar para Convidado
                        </button>
                        <button onclick="verConversas()" class="btn btn-info">
                            <i data-lucide="message-circle" class="w-4 h-4"></i>
                            Ver Conversas
                        </button>
                    ` : `
                        <div class="text-sm text-gray-600">
                            <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                            Suas notifica√ß√µes autom√°ticas e mensagens do administrador
                        </div>
                    `}
                </div>
                <div class="flex space-x-3">
                    <button onclick="marcarTodasComoLidas()" class="btn btn-secondary">
                        <i data-lucide="check" class="w-4 h-4"></i>
                        Marcar Todas como Lidas
                    </button>
                    ${tipoUsuario === 'admin' ? `
                        <button onclick="limparNotificacoes()" class="btn btn-error">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            Limpar Todas
                        </button>
                    ` : ''}
                </div>
            </div>
            
            <div class="card p-6">
                <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
                    <div>
                        <h3 class="text-lg font-semibold">Alertas Autom√°ticos (v2)</h3>
                        <p class="text-sm text-gray-600">Enviar resumo de prazos e honor√°rios por Email ou WhatsApp.</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2">
                        <button onclick="enviarAlertasEmail()" class="btn btn-primary">
                            <i data-lucide="mail" class="w-4 h-4"></i>
                            Enviar por Email
                        </button>
                        <button onclick="enviarAlertasWhatsApp()" class="btn btn-success">
                            <i data-lucide="message-circle" class="w-4 h-4"></i>
                            Enviar por WhatsApp
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email de destino</label>
                        <input id="alertasEmailDestino" type="email" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: cliente@email.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">WhatsApp (com indicativo)</label>
                        <input id="alertasWhatsAppDestino" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: 351912345678">
                    </div>
                </div>
                <div class="mt-3 text-xs text-gray-500">
                    Dica: o envio usa o seu cliente de email/WhatsApp Web (sem servi√ßos externos).
                </div>
            </div>
            
            <!-- Filtros Inteligentes -->
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Filtros Inteligentes</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                        <select id="filtroPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosNotificacoes()">
                            <option value="">Todas as prioridades</option>
                            <option value="alta">Alta</option>
                            <option value="media">M√©dia</option>
                            <option value="baixa">Baixa</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                        <select id="filtroTipo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosNotificacoes()">
                            <option value="">Todos os tipos</option>
                            <option value="mensagem_admin">Mensagem do Admin</option>
                            <option value="resposta_convidado">Resposta do Convidado</option>
                            <option value="cliente_autorizado">Cliente Autorizado</option>
                            <option value="documento_anexado">Documento Anexado</option>
                            <option value="prazo_proximo">Prazo Pr√≥ximo</option>
                            <option value="honorario">Honor√°rio</option>
                            <option value="prazo">Prazo</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="filtroStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosNotificacoes()">
                            <option value="">Todas</option>
                            <option value="nao_lida">N√£o Lidas</option>
                            <option value="lida">Lidas</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Per√≠odo</label>
                        <select id="filtroPeriodo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosNotificacoes()">
                            <option value="">Todos</option>
                            <option value="hoje">Hoje</option>
                            <option value="semana">Esta Semana</option>
                            <option value="mes">Este M√™s</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-4">
                    <button onclick="limparFiltrosNotificacoes()" class="btn btn-secondary">
                        <i data-lucide="x" class="w-4 h-4"></i>
                        Limpar Filtros
                    </button>
                    <div class="text-sm text-gray-600">
                        <span id="contadorFiltros">${notificacoesFiltradas.length} notifica√ß√µes encontradas</span>
                    </div>
                </div>
            </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="bell" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">N√£o Lidas</p>
                                    <p class="text-2xl font-bold text-gray-900">${notificacoesNaoLidas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="calendar" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Hoje</p>
                                    <p class="text-2xl font-bold text-gray-900">${notificacoesHoje}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total</p>
                                    <p class="text-2xl font-bold text-gray-900">${notificacoesFiltradas.length}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        ${notificacoesFiltradas.length === 0 ? `
                            <div class="card p-8 text-center">
                                <i data-lucide="bell-off" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                                <h3 class="text-lg font-semibold text-gray-600 mb-2">Nenhuma notifica√ß√£o</h3>
                                <p class="text-gray-500">Voc√™ est√° em dia! N√£o h√° notifica√ß√µes pendentes.</p>
                            </div>
                        ` : notificacoesFiltradas.map(notificacao => `
                            <div class="card p-4 ${notificacao.lida ? 'opacity-60' : 'border-l-4 border-blue-500'}">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="status-badge status-${notificacao.tipo}">${notificacao.tipo}</span>
                                            ${notificacao.prioridade === 'alta' ? '<span class="status-badge status-alta">Urgente</span>' : ''}
                                            ${notificacao.origem === 'admin' ? '<span class="status-badge status-info">Admin</span>' : ''}
                                            ${notificacao.origem === 'convidado' ? '<span class="status-badge status-success">Convidado</span>' : ''}
                                        </div>
                                        <h4 class="font-semibold text-gray-800">${notificacao.titulo}</h4>
                                        <p class="text-gray-600 text-sm mt-1">${notificacao.mensagem}</p>
                                        <p class="text-gray-400 text-xs mt-2">${notificacao.dataCriacao ? new Date(notificacao.dataCriacao).toLocaleString('pt-PT') : 'Data n√£o dispon√≠vel'}</p>
                                        
                                        ${notificacao.origem === 'admin' && tipoUsuario === 'convidado' ? `
                                            <div class="mt-3 pt-3 border-t border-gray-200">
                                                <button onclick="responderMensagem(${notificacao.id})" class="btn btn-sm btn-primary">
                                                    <i data-lucide="reply" class="w-4 h-4"></i>
                                                    Responder
                                                </button>
                                            </div>
                                        ` : ''}
                                        
                                        ${notificacao.respostas && notificacao.respostas.length > 0 ? `
                                            <div class="mt-3">
                                                <h5 class="text-sm font-medium text-gray-700 mb-2">Respostas (${notificacao.respostas.length})</h5>
                                                ${notificacao.respostas.map(resposta => `
                                                    <div class="bg-gray-50 p-3 rounded-lg mb-2">
                                                        <div class="flex items-center justify-between mb-1">
                                                            <span class="text-xs font-medium text-gray-600">${resposta.origem === 'admin' ? 'Admin' : 'Voc√™'}</span>
                                                            <span class="text-xs text-gray-400">${new Date(resposta.dataCriacao).toLocaleString('pt-PT')}</span>
                                                        </div>
                                                        <p class="text-sm text-gray-800">${resposta.mensagem}</p>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        ${!notificacao.lida ? `
                                            <button onclick="marcarComoLida(${notificacao.id})" class="text-blue-600 hover:text-blue-800">
                                                <i data-lucide="check" class="w-4 h-4"></i>
                                            </button>
                                        ` : ''}
                                        <button onclick="excluirNotificacao(${notificacao.id})" class="text-red-600 hover:text-red-800">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function salvarTarefasLocal(novos) {
            tarefas = novos;
            window.tarefas = tarefas;
            salvarDados('tarefas', tarefas);
        }

        function normalizarLinkTarefa(url) {
            const valor = String(url || '').trim();
            if (!valor) return '';
            if (!/^(https?:)?\/\//i.test(valor)) {
                return `https://${valor}`;
            }
            return valor;
        }

        function baixarAnexoTarefa(tarefaId, anexoId) {
            const lista = Array.isArray(tarefas) ? tarefas : [];
            const tarefa = lista.find(t => t.id === tarefaId);
            const anexo = tarefa && Array.isArray(tarefa.anexos) ? tarefa.anexos.find(a => a.id === anexoId) : null;
            if (!anexo || !anexo.conteudo) {
                mostrarNotificacao('Anexo n√£o encontrado.', 'error');
                return;
            }
            const link = document.createElement('a');
            link.href = anexo.conteudo;
            link.download = anexo.nome || 'anexo';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function finalizarCriacaoTarefa(tarefa) {
            const lista = Array.isArray(tarefas) ? tarefas : [];
            lista.unshift(tarefa);
            salvarTarefasLocal(lista);
            registrarAuditoria('criar', 'tarefa', `Tarefa criada: ${tarefa.titulo}`, null, tarefa);
            mostrarNotificacao('Tarefa criada com sucesso!', 'success');

            const ids = ['tarefaCliente', 'tarefaTitulo', 'tarefaDescricao', 'tarefaObservacoes', 'tarefaLinks', 'tarefaDataLimite', 'tarefaLembrete', 'tarefaAnexos'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            const prioridadeEl = document.getElementById('tarefaPrioridade');
            if (prioridadeEl) prioridadeEl.value = 'media';
            aplicarFiltrosTarefas();
        }

        function gerarTarefas() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const isConvidado = tipoUsuario === 'convidado';
            let clientesParaSelect = Array.isArray(clientes) ? clientes : [];
            let tarefasParaMostrar = Array.isArray(tarefas) ? tarefas : [];
            
            if (isConvidado) {
                clientesParaSelect = clientesParaSelect.filter(c => verificarPermissaoCliente(c.id));
                tarefasParaMostrar = tarefasParaMostrar.filter(t => verificarPermissaoCliente(t.clienteId));
            }
            
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Tarefas</h2>
                        ${isConvidado ? '' : `
                            <button onclick="criarTarefa()" class="btn btn-primary">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Adicionar Tarefa
                            </button>
                        `}
                    </div>
                    
                    ${isConvidado ? '' : `
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Nova Tarefa</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="tarefaCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecione</option>
                                        ${clientesParaSelect.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Processo</label>
                                    <select id="tarefaProcessoTipo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="contrato">Contrato</option>
                                        <option value="heranca">Heran√ßa</option>
                                        <option value="migracao">Migra√ß√£o</option>
                                        <option value="registo">Registo</option>
                                        <option value="prazo">Prazo</option>
                                        <option value="outro">Outro</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                    <select id="tarefaPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="baixa">Baixa</option>
                                        <option value="media" selected>M√©dia</option>
                                        <option value="alta">Alta</option>
                                        <option value="critica">Cr√≠tica</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo *</label>
                                    <input id="tarefaTitulo" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: Recolher documenta√ß√£o do cliente">
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o</label>
                                    <textarea id="tarefaDescricao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" rows="3" placeholder="Detalhes adicionais"></textarea>
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                    <textarea id="tarefaObservacoes" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" rows="2" placeholder="Observa√ß√µes internas"></textarea>
                                </div>
                                <div class="md:col-span-2 lg:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Links (separados por v√≠rgula)</label>
                                    <input id="tarefaLinks" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: https://..., https://...">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Anexos</label>
                                    <input id="tarefaAnexos" type="file" multiple class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <p class="text-xs text-gray-500 mt-1">Recomendado at√© 5 MB por anexo.</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data limite</label>
                                    <input id="tarefaDataLimite" type="date" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                            </div>
                        </div>
                    `}
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Filtros r√°pidos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pesquisa</label>
                                <input id="filtroTarefasTexto" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="t√≠tulo, cliente, processo..." oninput="aplicarFiltrosTarefas()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                                <select id="filtroTarefasCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosTarefas()">
                                    <option value="">Todos</option>
                                    ${clientesParaSelect.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroTarefasStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosTarefas()">
                                    <option value="">Todos</option>
                                    <option value="aberta">Aberta</option>
                                    <option value="concluida">Conclu√≠da</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                <select id="filtroTarefasPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosTarefas()">
                                    <option value="">Todas</option>
                                    <option value="baixa">Baixa</option>
                                    <option value="media">M√©dia</option>
                                    <option value="alta">Alta</option>
                                    <option value="critica">Cr√≠tica</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prazo</label>
                                <select id="filtroTarefasPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosTarefas()">
                                    <option value="">Todos</option>
                                    <option value="vencidas">Vencidas</option>
                                    <option value="hoje">Hoje</option>
                                    <option value="semana">Esta semana</option>
                                    <option value="mes">Este m√™s</option>
                                    <option value="sem_prazo">Sem prazo</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ordenar por</label>
                                <select id="filtroTarefasOrdenacao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosTarefas()">
                                    <option value="prazo">Prazo</option>
                                    <option value="prioridade">Prioridade</option>
                                    <option value="prioridade_prazo">Prioridade + Prazo</option>
                                    <option value="prazo_prioridade">Prazo + Prioridade</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-4">
                            <button id="btnSoComPrazo" onclick="alternarFiltroSoComPrazo()" class="btn ${localStorage.getItem('tarefasFiltroSoComPrazo') === 'true' ? 'btn-primary' : 'btn-secondary'}" data-ativo="${localStorage.getItem('tarefasFiltroSoComPrazo') === 'true' ? 'true' : 'false'}">
                                <i data-lucide="clock" class="w-4 h-4"></i>
                                ${localStorage.getItem('tarefasFiltroSoComPrazo') === 'true' ? 'S√≥ com prazo: ON' : 'S√≥ com prazo'}
                            </button>
                            <button onclick="aplicarFiltrosTarefas()" class="btn btn-primary">
                                <i data-lucide="filter" class="w-4 h-4"></i>
                                Aplicar filtros
                            </button>
                            <button onclick="limparFiltrosTarefas()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4"></i>
                                Limpar
                            </button>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Tarefas</h3>
                            <div class="text-sm text-gray-600"><span id="contadorTarefas">0</span> tarefas</div>
                        </div>
                        <div id="listaTarefas" class="space-y-3"></div>
                    </div>
                </div>
            `;
        }

        function limparFiltrosTarefas() {
            const ids = ['filtroTarefasTexto', 'filtroTarefasCliente', 'filtroTarefasStatus', 'filtroTarefasPrioridade', 'filtroTarefasPrazo'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            const btnSoComPrazo = document.getElementById('btnSoComPrazo');
            if (btnSoComPrazo) {
                btnSoComPrazo.dataset.ativo = 'false';
                btnSoComPrazo.classList.remove('btn-primary');
                btnSoComPrazo.classList.add('btn-secondary');
                btnSoComPrazo.innerHTML = '<i data-lucide="clock" class="w-4 h-4"></i> S√≥ com prazo';
            }
            localStorage.setItem('tarefasFiltroSoComPrazo', 'false');
            aplicarFiltrosTarefas();
        }

        function alternarFiltroSoComPrazo() {
            const btn = document.getElementById('btnSoComPrazo');
            if (!btn) return;
            const ativo = btn.dataset.ativo === 'true';
            btn.dataset.ativo = ativo ? 'false' : 'true';
            btn.classList.toggle('btn-primary', !ativo);
            btn.classList.toggle('btn-secondary', ativo);
            btn.innerHTML = `<i data-lucide="clock" class="w-4 h-4"></i> ${ativo ? 'S√≥ com prazo' : 'S√≥ com prazo: ON'}`;
            localStorage.setItem('tarefasFiltroSoComPrazo', ativo ? 'false' : 'true');
            aplicarFiltrosTarefas();
        }

        function aplicarFiltrosTarefas() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            let lista = Array.isArray(tarefas) ? tarefas : [];
            if (tipoUsuario === 'convidado') {
                lista = lista.filter(t => verificarPermissaoCliente(t.clienteId));
            }
            
            const texto = (document.getElementById('filtroTarefasTexto')?.value || '').toLowerCase();
            const clienteId = document.getElementById('filtroTarefasCliente')?.value || '';
            const status = document.getElementById('filtroTarefasStatus')?.value || '';
            const prioridade = document.getElementById('filtroTarefasPrioridade')?.value || '';
            const prazo = document.getElementById('filtroTarefasPrazo')?.value || '';
            const ordenacao = document.getElementById('filtroTarefasOrdenacao')?.value || 'prazo';
            const soComPrazo = document.getElementById('btnSoComPrazo')?.dataset?.ativo === 'true';
            
            if (clienteId) lista = lista.filter(t => String(t.clienteId) === clienteId);
            if (status) lista = lista.filter(t => t.status === status);
            if (prioridade) lista = lista.filter(t => t.prioridade === prioridade);
            if (soComPrazo) lista = lista.filter(t => !!t.dataLimite);
            if (prazo) {
                const agora = new Date();
                const hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
                const inicioSemana = new Date(hoje);
                inicioSemana.setDate(hoje.getDate() - hoje.getDay());
                const fimSemana = new Date(inicioSemana);
                fimSemana.setDate(inicioSemana.getDate() + 6);
                const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);
                const fimMes = new Date(agora.getFullYear(), agora.getMonth() + 1, 0);
                
                lista = lista.filter(t => {
                    if (!t.dataLimite) return prazo === 'sem_prazo';
                    const dataLimite = new Date(t.dataLimite);
                    if (isNaN(dataLimite.getTime())) return false;
                    
                    switch (prazo) {
                        case 'vencidas':
                            return dataLimite < hoje;
                        case 'hoje':
                            return dataLimite.toDateString() === hoje.toDateString();
                        case 'semana':
                            return dataLimite >= inicioSemana && dataLimite <= fimSemana;
                        case 'mes':
                            return dataLimite >= inicioMes && dataLimite <= fimMes;
                        case 'sem_prazo':
                            return false;
                        default:
                            return true;
                    }
                });
            }
            if (texto) {
                lista = lista.filter(t => {
                    const alvo = [
                        t.titulo,
                        t.descricao,
                        t.observacoes,
                        t.clienteNome,
                        t.processoTipo,
                        ...(t.links || [])
                    ].filter(Boolean).join(' ').toLowerCase();
                    return alvo.includes(texto);
                });
            }
            
            const prioridadePeso = (valor) => {
                switch (valor) {
                    case 'critica':
                        return 4;
                    case 'alta':
                        return 3;
                    case 'media':
                        return 2;
                    case 'baixa':
                        return 1;
                    default:
                        return 0;
                }
            };
            
            lista = lista.sort((a, b) => {
                const ordenarPorPrioridade = ordenacao === 'prioridade' || ordenacao === 'prioridade_prazo';
                const ordenarPorPrazo = ordenacao === 'prazo' || ordenacao === 'prazo_prioridade';
                
                if (ordenarPorPrioridade) {
                    const pesoA = prioridadePeso(a.prioridade);
                    const pesoB = prioridadePeso(b.prioridade);
                    if (pesoA !== pesoB) return pesoB - pesoA;
                    if (ordenacao === 'prioridade') {
                        // fallback para data, como antes
                    }
                }
                
                const dataA = a.dataLimite ? new Date(a.dataLimite) : null;
                const dataB = b.dataLimite ? new Date(b.dataLimite) : null;
                if (ordenarPorPrazo || ordenacao === 'prioridade_prazo') {
                    if (dataA && dataB) return dataA - dataB;
                    if (dataA && !dataB) return -1;
                    if (!dataA && dataB) return 1;
                }
                
                if (ordenacao === 'prazo_prioridade') {
                    const pesoA = prioridadePeso(a.prioridade);
                    const pesoB = prioridadePeso(b.prioridade);
                    if (pesoA !== pesoB) return pesoB - pesoA;
                }
                return (b.dataCriacao || '').localeCompare(a.dataCriacao || '');
            });
            
            renderizarListaTarefas(lista);
        }

        function renderizarListaTarefas(lista) {
            const container = document.getElementById('listaTarefas');
            const contador = document.getElementById('contadorTarefas');
            if (contador) contador.textContent = lista.length;
            if (!container) return;
            
            if (lista.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-500">Nenhuma tarefa encontrada.</div>';
                return;
            }
            
            const isConvidado = localStorage.getItem('tipoUsuario') === 'convidado';
            container.innerHTML = lista.map(tarefa => `
                <div class="flex flex-col gap-2 border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start gap-3">
                        <div class="flex-1">
                            <div class="text-sm font-semibold text-gray-800">${tarefa.titulo}</div>
                            <div class="text-xs text-gray-500">${tarefa.descricao || 'Sem descri√ß√£o'}</div>
                            ${tarefa.observacoes ? `<div class="text-xs text-gray-500">Observa√ß√µes: ${tarefa.observacoes}</div>` : ''}
                            <div class="text-xs text-gray-500">${tarefa.clienteNome || 'Cliente'} ‚Ä¢ ${tarefa.processoTipo || 'outro'}</div>
                            ${tarefa.dataLimite ? `<div class="text-xs text-gray-400">Prazo: ${new Date(tarefa.dataLimite).toLocaleDateString('pt-PT')}</div>` : ''}
                            ${tarefa.links && tarefa.links.length ? `
                                <div class="text-xs text-gray-400">
                                    Links:
                                    ${tarefa.links.map(link => {
                                        const href = normalizarLinkTarefa(link);
                                        return href ? `<a href="${href}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline mr-2">${link}</a>` : '';
                                    }).join('')}
                                </div>
                            ` : ''}
                            ${tarefa.anexos && tarefa.anexos.length ? `
                                <div class="flex flex-wrap gap-2 mt-1">
                                    ${tarefa.anexos.map(anexo => `
                                        <button onclick="baixarAnexoTarefa(${tarefa.id}, '${anexo.id}')" class="text-xs text-blue-600 hover:text-blue-800 underline">
                                            ${anexo.nome}
                                        </button>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="status-badge status-${tarefa.prioridade || 'media'}">${tarefa.prioridade || 'media'}</span>
                            <span class="status-badge status-${tarefa.status}">${tarefa.status === 'concluida' ? 'Conclu√≠da' : 'Aberta'}</span>
                        </div>
                    </div>
                    ${isConvidado ? '' : `
                        <div class="flex items-center gap-2">
                            <button onclick="alterarStatusTarefa(${tarefa.id})" class="btn btn-secondary">
                                <i data-lucide="${tarefa.status === 'concluida' ? 'rotate-ccw' : 'check'}" class="w-4 h-4"></i>
                                ${tarefa.status === 'concluida' ? 'Reabrir' : 'Concluir'}
                            </button>
                            <button onclick="excluirTarefa(${tarefa.id})" class="btn btn-danger">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                Excluir
                            </button>
                        </div>
                    `}
                </div>
            `).join('');
            lucide.createIcons();
        }

        function criarTarefa() {
            if (!exigirPermissaoAcao('criar', 'tarefa')) {
                return;
            }
            const clienteId = parseInt(document.getElementById('tarefaCliente')?.value || '');
            const processoTipo = document.getElementById('tarefaProcessoTipo')?.value || 'outro';
            const prioridade = document.getElementById('tarefaPrioridade')?.value || 'media';
            const titulo = document.getElementById('tarefaTitulo')?.value?.trim() || '';
            const descricao = document.getElementById('tarefaDescricao')?.value?.trim() || '';
            const observacoes = document.getElementById('tarefaObservacoes')?.value?.trim() || '';
            const linksRaw = document.getElementById('tarefaLinks')?.value || '';
            const links = linksRaw.split(',').map(item => item.trim()).filter(Boolean);
            const dataLimite = document.getElementById('tarefaDataLimite')?.value || '';
            const anexosInput = document.getElementById('tarefaAnexos');
            const arquivos = anexosInput && anexosInput.files ? Array.from(anexosInput.files) : [];
            const maxAnexo = 5 * 1024 * 1024;
            const anexoGrande = arquivos.find(arquivo => arquivo.size > maxAnexo);
            if (anexoGrande) {
                mostrarNotificacao('Anexo acima de 5 MB. Tente um ficheiro menor.', 'error');
                return;
            }
            
            if (!clienteId) {
                mostrarNotificacao('Selecione o cliente da tarefa.', 'warning');
                return;
            }
            if (!titulo) {
                mostrarNotificacao('Informe o t√≠tulo da tarefa.', 'warning');
                return;
            }
            
            const cliente = clientes.find(c => c.id === clienteId);
            const tarefa = {
                id: Date.now(),
                clienteId,
                clienteNome: cliente ? cliente.nome : '',
                processoTipo,
                titulo,
                descricao,
                observacoes,
                links,
                prioridade,
                status: 'aberta',
                dataLimite: dataLimite || null,
                anexos: [],
                criadoPor: localStorage.getItem('usuarioLogado') || 'N/D',
                tipoUsuario: localStorage.getItem('tipoUsuario') || 'N/D',
                dataCriacao: new Date().toISOString()
            };

            if (arquivos.length === 0) {
                finalizarCriacaoTarefa(tarefa);
                return;
            }

            Promise.all(arquivos.map((arquivo, index) => new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve({
                    id: `${Date.now()}_${index}`,
                    nome: arquivo.name,
                    tipo: arquivo.type,
                    tamanho: arquivo.size,
                    conteudo: reader.result
                });
                reader.onerror = () => resolve(null);
                reader.readAsDataURL(arquivo);
            }))).then(resultados => {
                tarefa.anexos = resultados.filter(Boolean);
                finalizarCriacaoTarefa(tarefa);
            });
        }

        function alterarStatusTarefa(id) {
            if (!exigirPermissaoAcao('editar', 'tarefa')) {
                return;
            }
            const lista = Array.isArray(tarefas) ? tarefas : [];
            const index = lista.findIndex(t => t.id === id);
            if (index === -1) return;
            const antes = { ...lista[index] };
            lista[index].status = lista[index].status === 'concluida' ? 'aberta' : 'concluida';
            salvarTarefasLocal(lista);
            registrarAuditoria('editar', 'tarefa', `Status da tarefa: ${lista[index].titulo}`, antes, lista[index]);
            aplicarFiltrosTarefas();
        }

        function excluirTarefa(id) {
            if (!exigirPermissaoAcao('apagar', 'tarefa')) {
                return;
            }
            const lista = Array.isArray(tarefas) ? tarefas : [];
            const tarefa = lista.find(t => t.id === id);
            if (!tarefa) {
                mostrarNotificacao('Tarefa n√£o encontrada.', 'error');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir esta tarefa?')) return;
            const novas = lista.filter(t => t.id !== id);
            salvarTarefasLocal(novas);
            registrarAuditoria('excluir', 'tarefa', `Tarefa exclu√≠da: ${tarefa.titulo}`, tarefa, null);
            aplicarFiltrosTarefas();
            mostrarNotificacao('Tarefa exclu√≠da com sucesso!', 'success');
        }

        function formatarDataLocalCalendario(data) {
            const ano = data.getFullYear();
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const dia = String(data.getDate()).padStart(2, '0');
            return `${ano}-${mes}-${dia}`;
        }

        function normalizarDataCalendario(valor) {
            if (!valor) return null;
            const data = new Date(valor);
            if (isNaN(data)) return null;
            return new Date(data.getFullYear(), data.getMonth(), data.getDate());
        }

        function obterPrazosDoDia(data) {
            const alvo = formatarDataLocalCalendario(data);
            const lista = Array.isArray(prazos) ? prazos : [];
            return lista.filter(prazo => {
                if (!prazo.dataLimite) return false;
                if (calendarioFiltroCliente) {
                    const clienteId = String(prazo.clienteId || '');
                    if (clienteId !== String(calendarioFiltroCliente)) return false;
                }
                if (calendarioFiltroStatus) {
                    if (String(prazo.status || '') !== String(calendarioFiltroStatus)) return false;
                }
                if (calendarioFiltroTipo) {
                    const tipo = String(prazo.tipo || '').toLowerCase();
                    if (tipo !== String(calendarioFiltroTipo)) return false;
                }
                if (calendarioFiltroPrioridade) {
                    const prioridade = String(prazo.prioridade || '').toLowerCase();
                    if (prioridade !== String(calendarioFiltroPrioridade)) return false;
                }
                const dataPrazo = normalizarDataCalendario(prazo.dataLimite);
                if (!dataPrazo) return false;
                return formatarDataLocalCalendario(dataPrazo) === alvo;
            });
        }

        function gerarCalendarioPrazos() {
            return `
                <div class="space-y-6">
                    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                        <h2 class="text-2xl font-bold">Calend√°rio de Prazos</h2>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="moverCalendario(-1)" class="btn btn-secondary">
                                <i data-lucide="chevron-left" class="w-4 h-4"></i>
                            </button>
                            <button onclick="irHojeCalendario()" class="btn btn-secondary">Hoje</button>
                            <button onclick="moverCalendario(1)" class="btn btn-secondary">
                                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                            </button>
                            <button onclick="alterarModoCalendario('mensal')" class="btn btn-primary">M√™s</button>
                            <button onclick="alterarModoCalendario('semanal')" class="btn btn-secondary">Semana</button>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                                <select id="calendarioFiltroCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosCalendario()">
                                    <option value="">Todos os clientes</option>
                                    ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="calendarioFiltroStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosCalendario()">
                                    <option value="">Todos os status</option>
                                    <option value="ativo">Ativo</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em andamento</option>
                                    <option value="concluido">Conclu√≠do</option>
                                    <option value="vencido">Vencido</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="calendarioFiltroTipo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosCalendario()">
                                    <option value="">Todos os tipos</option>
                                    <option value="contrato">Contrato</option>
                                    <option value="heranca">Heran√ßa</option>
                                    <option value="migracao">Migra√ß√£o</option>
                                    <option value="registo">Registo</option>
                                    <option value="prazo">Prazo</option>
                                    <option value="outro">Outro</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                <select id="calendarioFiltroPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosCalendario()">
                                    <option value="">Todas</option>
                                    <option value="baixa">Baixa</option>
                                    <option value="media">M√©dia</option>
                                    <option value="alta">Alta</option>
                                    <option value="critica">Cr√≠tica</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 text-xs text-gray-600 mb-4">
                            <div class="flex items-center gap-2">
                                <span class="calendario-item calendario-prioridade-baixa">Baixa</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="calendario-item calendario-prioridade-media">M√©dia</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="calendario-item calendario-prioridade-alta">Alta</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="calendario-item calendario-prioridade-critica">Cr√≠tica</span>
                            </div>
                        </div>
                        <div id="calendarioTitulo" class="text-lg font-semibold mb-4"></div>
                        <div id="calendarioGrid"></div>
                    </div>
                </div>
            `;
        }

        function inicializarCalendarioPrazos() {
            const select = document.getElementById('calendarioFiltroCliente');
            if (select) {
                select.value = calendarioFiltroCliente || '';
            }
            const selectStatus = document.getElementById('calendarioFiltroStatus');
            if (selectStatus) {
                selectStatus.value = calendarioFiltroStatus || '';
            }
            const selectTipo = document.getElementById('calendarioFiltroTipo');
            if (selectTipo) {
                selectTipo.value = calendarioFiltroTipo || '';
            }
            const selectPrioridade = document.getElementById('calendarioFiltroPrioridade');
            if (selectPrioridade) {
                selectPrioridade.value = calendarioFiltroPrioridade || '';
            }
            atualizarCalendarioPrazos();
            lucide.createIcons();
        }

        function aplicarFiltrosCalendario() {
            const select = document.getElementById('calendarioFiltroCliente');
            const selectStatus = document.getElementById('calendarioFiltroStatus');
            const selectTipo = document.getElementById('calendarioFiltroTipo');
            const selectPrioridade = document.getElementById('calendarioFiltroPrioridade');
            calendarioFiltroCliente = select ? select.value : '';
            calendarioFiltroStatus = selectStatus ? selectStatus.value : '';
            calendarioFiltroTipo = selectTipo ? selectTipo.value : '';
            calendarioFiltroPrioridade = selectPrioridade ? selectPrioridade.value : '';
            window.calendarioFiltroCliente = calendarioFiltroCliente;
            window.calendarioFiltroStatus = calendarioFiltroStatus;
            window.calendarioFiltroTipo = calendarioFiltroTipo;
            window.calendarioFiltroPrioridade = calendarioFiltroPrioridade;
            atualizarCalendarioPrazos();
        }

        function alterarModoCalendario(modo) {
            calendarioModo = modo;
            window.calendarioModo = calendarioModo;
            atualizarCalendarioPrazos();
        }

        function moverCalendario(direcao) {
            const atual = calendarioDataRef instanceof Date ? calendarioDataRef : new Date(calendarioDataRef);
            if (calendarioModo === 'semanal') {
                atual.setDate(atual.getDate() + (direcao * 7));
            } else {
                atual.setMonth(atual.getMonth() + direcao);
            }
            calendarioDataRef = atual;
            window.calendarioDataRef = calendarioDataRef;
            atualizarCalendarioPrazos();
        }

        function irHojeCalendario() {
            calendarioDataRef = new Date();
            window.calendarioDataRef = calendarioDataRef;
            atualizarCalendarioPrazos();
        }

        function atualizarCalendarioPrazos() {
            const titulo = document.getElementById('calendarioTitulo');
            const grid = document.getElementById('calendarioGrid');
            if (!titulo || !grid) return;
            
            if (calendarioModo === 'semanal') {
                const dataRef = calendarioDataRef instanceof Date ? calendarioDataRef : new Date(calendarioDataRef);
                const diaSemana = (dataRef.getDay() + 6) % 7;
                const inicioSemana = new Date(dataRef.getFullYear(), dataRef.getMonth(), dataRef.getDate() - diaSemana);
                const fimSemana = new Date(inicioSemana.getFullYear(), inicioSemana.getMonth(), inicioSemana.getDate() + 6);
                titulo.textContent = `Semana de ${inicioSemana.toLocaleDateString('pt-PT')} at√© ${fimSemana.toLocaleDateString('pt-PT')}`;
                grid.innerHTML = gerarSemanaCalendario(inicioSemana);
            } else {
                const dataRef = calendarioDataRef instanceof Date ? calendarioDataRef : new Date(calendarioDataRef);
                const mesExtenso = dataRef.toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
                titulo.textContent = mesExtenso.charAt(0).toUpperCase() + mesExtenso.slice(1);
                grid.innerHTML = gerarMesCalendario(dataRef.getFullYear(), dataRef.getMonth());
            }
        }

        function gerarMesCalendario(ano, mes) {
            const primeiroDia = new Date(ano, mes, 1);
            const offset = (primeiroDia.getDay() + 6) % 7;
            const inicio = new Date(ano, mes, 1 - offset);
            const hoje = formatarDataLocalCalendario(new Date());
            
            const diasSemana = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
            let html = `
                <div class="grid grid-cols-7 text-xs text-gray-500 mb-2">
                    ${diasSemana.map(dia => `<div class="text-center font-semibold">${dia}</div>`).join('')}
                </div>
                <div class="grid grid-cols-7 gap-2">
            `;
            
            for (let i = 0; i < 42; i++) {
                const dataAtual = new Date(inicio.getFullYear(), inicio.getMonth(), inicio.getDate() + i);
                const dataLocal = formatarDataLocalCalendario(dataAtual);
                const pertenceMes = dataAtual.getMonth() === mes;
                const prazosDia = obterPrazosDoDia(dataAtual);
                const extra = prazosDia.length > 3 ? prazosDia.length - 3 : 0;
                
                html += `
                    <div class="border rounded-lg p-2 min-h-[90px] ${pertenceMes ? 'bg-white' : 'bg-gray-50 text-gray-400'} ${dataLocal === hoje ? 'border-blue-400' : 'border-gray-200'}">
                        <div class="text-xs font-semibold mb-1">${dataAtual.getDate()}</div>
                        <div class="space-y-1">
                            ${prazosDia.slice(0, 3).map(prazo => `
                                <div class="text-[11px] text-gray-700 truncate calendario-item calendario-prioridade-${prazo.prioridade || 'media'}">
                                    <span class="status-badge status-${prazo.prioridade || 'media'}">${prazo.prioridade || 'media'}</span>
                                    ${prazo.descricao || prazo.tipo || 'Prazo'}
                                </div>
                            `).join('')}
                            ${extra > 0 ? `<div class="text-[11px] text-gray-400">+${extra} mais</div>` : ''}
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            return html;
        }

        function gerarSemanaCalendario(inicioSemana) {
            const diasSemana = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
            const hoje = formatarDataLocalCalendario(new Date());
            let html = '<div class="grid grid-cols-7 gap-2">';
            
            for (let i = 0; i < 7; i++) {
                const dataAtual = new Date(inicioSemana.getFullYear(), inicioSemana.getMonth(), inicioSemana.getDate() + i);
                const dataLocal = formatarDataLocalCalendario(dataAtual);
                const prazosDia = obterPrazosDoDia(dataAtual);
                
                html += `
                    <div class="border rounded-lg p-3 min-h-[140px] ${dataLocal === hoje ? 'border-blue-400' : 'border-gray-200'}">
                        <div class="text-xs font-semibold text-gray-500 mb-2">${diasSemana[i]} ‚Ä¢ ${dataAtual.toLocaleDateString('pt-PT')}</div>
                        <div class="space-y-2">
                            ${prazosDia.length ? prazosDia.map(prazo => `
                                <div class="text-xs text-gray-700 border border-gray-200 rounded p-2 calendario-item calendario-prioridade-${prazo.prioridade || 'media'}">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="status-badge status-${prazo.prioridade || 'media'}">${prazo.prioridade || 'media'}</span>
                                        <span class="font-semibold">${prazo.descricao || prazo.tipo || 'Prazo'}</span>
                                    </div>
                                    <div class="text-[11px] text-gray-500">${prazo.clienteNome || prazo.cliente || ''}</div>
                                </div>
                            `).join('') : '<div class="text-xs text-gray-400">Sem prazos</div>'}
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            return html;
        }

        function gerarRelatorios() {
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Relat√≥rios</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Relat√≥rio Financeiro por Cliente</h3>
                            <p class="text-gray-600 mb-4">Relat√≥rio financeiro personalizado por cliente espec√≠fico</p>
                            <button onclick="gerarRelatorioFinanceiroCliente()" class="btn btn-warning">
                                <i data-lucide="user-dollar" class="w-4 h-4"></i>
                                Gerar
                            </button>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Relat√≥rio Geral</h3>
                            <p class="text-gray-600 mb-4">Relat√≥rio completo do sistema</p>
                            <button onclick="gerarRelatorioCompleto()" class="btn btn-primary">
                                <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                                Gerar
                            </button>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Relat√≥rio por Cliente</h3>
                            <p class="text-gray-600 mb-4">Relat√≥rio personalizado por cliente espec√≠fico</p>
                            <button onclick="gerarRelatorioCliente()" class="btn btn-secondary">
                                <i data-lucide="user-check" class="w-4 h-4"></i>
                                Gerar
                            </button>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Relat√≥rio Geral por Cliente</h3>
                            <p class="text-gray-600 mb-4">Relat√≥rio geral personalizado por cliente espec√≠fico</p>
                            <button onclick="gerarRelatorioGeralCliente()" class="btn btn-info">
                                <i data-lucide="file-text" class="w-4 h-4"></i>
                                Gerar
                            </button>
                        </div>
                        
                        <div class="card p-6 md:col-span-2 lg:col-span-3">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="text-lg font-semibold">Relat√≥rios Avan√ßados</h3>
                                    <p class="text-gray-600">Filtros por datas, cliente e tipo com exporta√ß√£o em Excel (CSV) e PDF.</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button id="btnExportarCsvRelatorio" class="btn btn-secondary">
                                        <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                                        Exportar Excel
                                    </button>
                                    <button id="btnExportarPdfRelatorio" class="btn btn-primary">
                                        <i data-lucide="file-text" class="w-4 h-4"></i>
                                        Exportar PDF
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                                    <select id="relatorioAvancadoCliente" class="form-control">
                                        <option value="">Todos os clientes</option>
                                        ${clientes.map(cliente => 
                                            `<option value="${cliente.nome}">${cliente.nome} (${cliente.email})</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                                    <select id="relatorioAvancadoTipo" class="form-control">
                                        <option value="todos">Todos</option>
                                        <option value="honorarios">Honor√°rios</option>
                                        <option value="contratos">Contratos</option>
                                        <option value="herancas">Heran√ßas</option>
                                        <option value="migracoes">Migra√ß√µes</option>
                                        <option value="registos">Registos</option>
                                        <option value="prazos">Prazos</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Data in√≠cio</label>
                                    <input type="date" id="relatorioAvancadoDataInicio" class="form-control">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Data fim</label>
                                    <input type="date" id="relatorioAvancadoDataFim" class="form-control">
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3 mb-4">
                                <button id="btnAplicarFiltrosRelatorio" class="btn btn-success">
                                    <i data-lucide="filter" class="w-4 h-4"></i>
                                    Aplicar filtros
                                </button>
                                <span id="relatorioAvancadoResumo" class="text-sm text-gray-500">Nenhum filtro aplicado.</span>
                            </div>
                            
                            <div id="relatorioAvancadoResultados" class="overflow-x-auto text-sm text-gray-600">
                                Aplique filtros para visualizar os resultados.
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function formatarTamanhoArquivo(bytes) {
            if (!bytes && bytes !== 0) return 'N/D';
            if (bytes < 1024) return `${bytes} B`;
            if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
            return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
        }

        function salvarDocumentosLocal(novos) {
            documentos = novos;
            window.documentos = documentos;
            salvarDados('documentos', documentos);
        }

        function obterModelosDocumentos() {
            return [
                { id: 'procuracao_simples', nome: 'Procura√ß√£o Simples', arquivo: 'procuracao_simples' },
                { id: 'declaracao_comparecimento', nome: 'Declara√ß√£o de Comparecimento', arquivo: 'declaracao_comparecimento' },
                { id: 'declaracao_residencia', nome: 'Declara√ß√£o de Resid√™ncia', arquivo: 'declaracao_residencia' },
                { id: 'recibo_honorarios', nome: 'Recibo de Honor√°rios', arquivo: 'recibo_honorarios' }
            ];
        }

        function normalizarNomeArquivo(valor) {
            return String(valor || '')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '_')
                .replace(/^_+|_+$/g, '');
        }

        function obterDadosTemplateDocumento() {
            const clienteId = parseInt(document.getElementById('templateCliente')?.value || '');
            const modeloId = document.getElementById('templateModelo')?.value || '';
            const processoTipo = document.getElementById('templateProcessoTipo')?.value || 'outro';

            if (!clienteId) {
                mostrarNotificacao('Selecione o cliente do modelo.', 'warning');
                return null;
            }
            if (!modeloId) {
                mostrarNotificacao('Selecione o modelo.', 'warning');
                return null;
            }

            const cliente = clientes.find(c => c.id === clienteId);
            return {
                clienteId,
                cliente,
                processoTipo,
                modeloId,
                hoje: new Date()
            };
        }

        function gerarConteudoTemplateDocumento(modeloId, dados) {
            const nomeCliente = dados.cliente?.nome || 'N/D';
            const nif = dados.cliente?.nif || dados.cliente?.documento || 'N/D';
            const morada = dados.cliente?.morada || dados.cliente?.endereco || 'N/D';
            const dataHoje = dados.hoje.toLocaleDateString('pt-PT');

            switch (modeloId) {
                case 'procuracao_simples':
                    return [
                        'PROCURA√á√ÉO SIMPLES',
                        '',
                        `Eu, ${nomeCliente}, NIF ${nif}, residente em ${morada},`,
                        'pelo presente instrumento, nomeio e constituo como meu bastante procurador(a)',
                        'o(a) Dr(a). ________________________, para me representar junto das entidades competentes.',
                        '',
                        `Local e data: _____________________, ${dataHoje}`,
                        '',
                        'Assinatura: ________________________________'
                    ].join('\n');
                case 'declaracao_comparecimento':
                    return [
                        'DECLARA√á√ÉO DE COMPARECIMENTO',
                        '',
                        `Declaro que ${nomeCliente}, NIF ${nif}, compareceu neste escrit√≥rio no dia ${dataHoje}.`,
                        '',
                        'Para os devidos efeitos, assino a presente declara√ß√£o.',
                        '',
                        `Local e data: _____________________, ${dataHoje}`,
                        '',
                        'Assinatura: ________________________________'
                    ].join('\n');
                case 'declaracao_residencia':
                    return [
                        'DECLARA√á√ÉO DE RESID√äNCIA',
                        '',
                        `Eu, ${nomeCliente}, NIF ${nif}, declaro que resido em ${morada}.`,
                        '',
                        'Declaro, sob compromisso de honra, que as informa√ß√µes acima s√£o verdadeiras.',
                        '',
                        `Local e data: _____________________, ${dataHoje}`,
                        '',
                        'Assinatura: ________________________________'
                    ].join('\n');
                case 'recibo_honorarios':
                    return [
                        'RECIBO DE HONOR√ÅRIOS',
                        '',
                        `Recebi de ${nomeCliente}, NIF ${nif}, a quantia de ‚Ç¨__________`,
                        'referente a honor√°rios profissionais.',
                        '',
                        `Local e data: _____________________, ${dataHoje}`,
                        '',
                        'Assinatura: ________________________________'
                    ].join('\n');
                default:
                    return 'Modelo n√£o encontrado.';
            }
        }

        function gerarTemplateDocumento(acao) {
            if (!exigirPermissaoAcao('criar', 'documento')) {
                return;
            }
            const dados = obterDadosTemplateDocumento();
            if (!dados) return;

            const modelos = obterModelosDocumentos();
            const modelo = modelos.find(m => m.id === dados.modeloId);
            if (!modelo) {
                mostrarNotificacao('Modelo n√£o encontrado.', 'error');
                return;
            }

            const conteudo = gerarConteudoTemplateDocumento(modelo.id, dados);
            const dataUri = `data:text/plain;charset=utf-8,${encodeURIComponent(conteudo)}`;
            const nomeBase = normalizarNomeArquivo(`${modelo.arquivo}_${dados.cliente?.nome || 'cliente'}`);
            const nomeArquivo = `${nomeBase || modelo.arquivo}.txt`;

            if (acao === 'baixar') {
                const link = document.createElement('a');
                link.href = dataUri;
                link.download = nomeArquivo;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                return;
            }

            const tamanho = new Blob([conteudo]).size;
            const documento = {
                id: Date.now(),
                clienteId: dados.clienteId,
                clienteNome: dados.cliente?.nome || '',
                processoTipo: dados.processoTipo,
                descricao: `Modelo: ${modelo.nome}`,
                tags: ['template', modelo.nome],
                nomeArquivo,
                tipoArquivo: 'text/plain',
                tamanho,
                conteudo: dataUri,
                criadoPor: localStorage.getItem('usuarioLogado') || 'N/D',
                tipoUsuario: localStorage.getItem('tipoUsuario') || 'N/D',
                dataCriacao: new Date().toISOString()
            };
            const lista = Array.isArray(documentos) ? documentos : [];
            lista.unshift(documento);
            salvarDocumentosLocal(lista);
            registrarAuditoria('criar', 'documento', `Documento modelo criado: ${documento.nomeArquivo}`, null, documento);
            mostrarNotificacao('Modelo gerado e guardado com sucesso!', 'success');
            aplicarFiltrosDocumentos();
        }

        function gerarDocumentos() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const isConvidado = tipoUsuario === 'convidado';
            let clientesParaSelect = Array.isArray(clientes) ? clientes : [];
            let documentosParaMostrar = Array.isArray(documentos) ? documentos : [];
            
            if (tipoUsuario === 'convidado') {
                const convidadoId = localStorage.getItem('convidadoId');
                const convidados = obterConvidados();
                const convidado = convidados.find(c => c.id === parseInt(convidadoId));
                const clientesAutorizados = convidado && convidado.ativo ? convidado.clientesAutorizados : [];
                clientesParaSelect = clientesParaSelect.filter(c => clientesAutorizados.includes(c.id));
                documentosParaMostrar = documentosParaMostrar.filter(d => clientesAutorizados.includes(d.clienteId));
            }
            
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Documentos</h2>
                        ${isConvidado ? '' : `
                            <button onclick="uploadDocumento()" class="btn btn-primary">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                Adicionar Documento
                            </button>
                        `}
                    </div>
                    
                    ${isConvidado ? '' : `
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Novo Documento</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="docCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecione</option>
                                        ${clientesParaSelect.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Processo</label>
                                    <select id="docProcessoTipo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="contrato">Contrato</option>
                                        <option value="heranca">Heran√ßa</option>
                                        <option value="migracao">Migra√ß√£o</option>
                                        <option value="registo">Registo</option>
                                        <option value="prazo">Prazo</option>
                                        <option value="outro">Outro</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o</label>
                                    <input id="docDescricao" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: Contrato assinado">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tags (separadas por v√≠rgula)</label>
                                    <input id="docTags" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: contrato, assinatura">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ficheiro *</label>
                                    <input id="docArquivo" type="file" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <p class="text-xs text-gray-500 mt-1">Recomendado at√© 5 MB.</p>
                                </div>
                            </div>
                        </div>
                    `}

                    ${isConvidado ? '' : `
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Modelos de documentos</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="templateCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecione</option>
                                        ${clientesParaSelect.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Processo</label>
                                    <select id="templateProcessoTipo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="contrato">Contrato</option>
                                        <option value="heranca">Heran√ßa</option>
                                        <option value="migracao">Migra√ß√£o</option>
                                        <option value="registo">Registo</option>
                                        <option value="prazo">Prazo</option>
                                        <option value="outro">Outro</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Modelo *</label>
                                    <select id="templateModelo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        ${obterModelosDocumentos().map(modelo => `<option value="${modelo.id}">${modelo.nome}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 mt-4">
                                <button onclick="gerarTemplateDocumento('salvar')" class="btn btn-primary">
                                    <i data-lucide="file-plus" class="w-4 h-4"></i>
                                    Gerar e guardar
                                </button>
                                <button onclick="gerarTemplateDocumento('baixar')" class="btn btn-secondary">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    Baixar
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-3">Os modelos s√£o gerados em formato .txt e podem ser editados depois.</p>
                        </div>
                    `}
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Filtros</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pesquisa</label>
                                <input id="filtroDocTexto" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="nome, descri√ß√£o, tag...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                                <select id="filtroDocCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Todos</option>
                                    ${clientesParaSelect.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Processo</label>
                                <select id="filtroDocProcesso" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Todos</option>
                                    <option value="contrato">Contrato</option>
                                    <option value="heranca">Heran√ßa</option>
                                    <option value="migracao">Migra√ß√£o</option>
                                    <option value="registo">Registo</option>
                                    <option value="prazo">Prazo</option>
                                    <option value="outro">Outro</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tag</label>
                                <input id="filtroDocTag" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: assinatura">
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mt-4">
                            <button onclick="aplicarFiltrosDocumentos()" class="btn btn-primary">
                                <i data-lucide="filter" class="w-4 h-4"></i>
                                Aplicar filtros
                            </button>
                            <button onclick="limparFiltrosDocumentos()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4"></i>
                                Limpar
                            </button>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Documentos guardados</h3>
                            <div class="text-sm text-gray-600"><span id="contadorDocumentos">0</span> documentos</div>
                        </div>
                        <div id="listaDocumentos" class="space-y-3"></div>
                    </div>
                </div>
            `;
        }

        function limparFiltrosDocumentos() {
            const ids = ['filtroDocTexto', 'filtroDocCliente', 'filtroDocProcesso', 'filtroDocTag'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            aplicarFiltrosDocumentos();
        }

        function aplicarFiltrosDocumentos() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            let lista = Array.isArray(documentos) ? documentos : [];
            
            if (tipoUsuario === 'convidado') {
                const convidadoId = localStorage.getItem('convidadoId');
                const convidados = obterConvidados();
                const convidado = convidados.find(c => c.id === parseInt(convidadoId));
                const clientesAutorizados = convidado && convidado.ativo ? convidado.clientesAutorizados : [];
                lista = lista.filter(doc => clientesAutorizados.includes(doc.clienteId));
            }
            
            const texto = (document.getElementById('filtroDocTexto')?.value || '').toLowerCase();
            const clienteId = document.getElementById('filtroDocCliente')?.value || '';
            const processo = document.getElementById('filtroDocProcesso')?.value || '';
            const tag = (document.getElementById('filtroDocTag')?.value || '').toLowerCase();
            
            if (clienteId) lista = lista.filter(doc => String(doc.clienteId) === clienteId);
            if (processo) lista = lista.filter(doc => doc.processoTipo === processo);
            if (texto) {
                lista = lista.filter(doc => {
                    const alvo = [
                        doc.nomeArquivo,
                        doc.descricao,
                        doc.clienteNome,
                        doc.processoTipo,
                        ...(doc.tags || [])
                    ].filter(Boolean).join(' ').toLowerCase();
                    return alvo.includes(texto);
                });
            }
            if (tag) {
                lista = lista.filter(doc => (doc.tags || []).some(t => t.toLowerCase().includes(tag)));
            }
            
            lista = lista.sort((a, b) => new Date(b.dataCriacao) - new Date(a.dataCriacao));
            renderizarListaDocumentos(lista);
        }

        function renderizarListaDocumentos(lista) {
            const container = document.getElementById('listaDocumentos');
            const contador = document.getElementById('contadorDocumentos');
            if (contador) contador.textContent = lista.length;
            if (!container) return;
            
            if (lista.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-500">Nenhum documento encontrado.</div>';
                return;
            }
            
            const isConvidado = localStorage.getItem('tipoUsuario') === 'convidado';
            container.innerHTML = lista.map(doc => `
                <div class="flex flex-col gap-2 border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-sm font-semibold text-gray-800">${doc.nomeArquivo}</div>
                            <div class="text-xs text-gray-500">${doc.descricao || 'Sem descri√ß√£o'}</div>
                            <div class="text-xs text-gray-500">${doc.clienteNome || 'Cliente'} ‚Ä¢ ${doc.processoTipo || 'outro'} ‚Ä¢ ${formatarTamanhoArquivo(doc.tamanho)}</div>
                            <div class="text-xs text-gray-400">${doc.dataCriacao ? new Date(doc.dataCriacao).toLocaleString('pt-PT') : ''}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="baixarDocumento(${doc.id})" class="text-blue-600 hover:text-blue-800" title="Baixar">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                            ${isConvidado ? '' : `
                                <button onclick="excluirDocumento(${doc.id})" class="text-red-600 hover:text-red-800" title="Excluir">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            `}
                        </div>
                    </div>
                    ${doc.tags && doc.tags.length ? `
                        <div class="flex flex-wrap gap-2">
                            ${doc.tags.map(tag => `<span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
            lucide.createIcons();
        }

        function uploadDocumento() {
            if (!exigirPermissaoAcao('criar', 'documento')) {
                return;
            }
            const arquivoInput = document.getElementById('docArquivo');
            const clienteId = parseInt(document.getElementById('docCliente')?.value || '');
            const processoTipo = document.getElementById('docProcessoTipo')?.value || 'outro';
            const descricao = document.getElementById('docDescricao')?.value?.trim() || '';
            const tagsRaw = document.getElementById('docTags')?.value || '';
            const tags = tagsRaw.split(',').map(t => t.trim()).filter(Boolean);
            
            if (!clienteId) {
                mostrarNotificacao('Selecione o cliente do documento.', 'warning');
                return;
            }
            if (!arquivoInput || !arquivoInput.files || arquivoInput.files.length === 0) {
                mostrarNotificacao('Selecione um ficheiro.', 'warning');
                return;
            }
            const arquivo = arquivoInput.files[0];
            if (arquivo.size > 5 * 1024 * 1024) {
                mostrarNotificacao('Ficheiro acima de 5 MB. Tente um ficheiro menor.', 'error');
                return;
            }
            
            const cliente = clientes.find(c => c.id === clienteId);
            const reader = new FileReader();
            reader.onload = () => {
                const documento = {
                    id: Date.now(),
                    clienteId,
                    clienteNome: cliente ? cliente.nome : '',
                    processoTipo,
                    descricao,
                    tags,
                    nomeArquivo: arquivo.name,
                    tipoArquivo: arquivo.type,
                    tamanho: arquivo.size,
                    conteudo: reader.result,
                    criadoPor: localStorage.getItem('usuarioLogado') || 'N/D',
                    tipoUsuario: localStorage.getItem('tipoUsuario') || 'N/D',
                    dataCriacao: new Date().toISOString()
                };
                const lista = Array.isArray(documentos) ? documentos : [];
                lista.unshift(documento);
                salvarDocumentosLocal(lista);
                registrarAuditoria('criar', 'documento', `Documento adicionado: ${documento.nomeArquivo}`, null, documento);
                mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                arquivoInput.value = '';
                const descInput = document.getElementById('docDescricao');
                const tagsInput = document.getElementById('docTags');
                if (descInput) descInput.value = '';
                if (tagsInput) tagsInput.value = '';
                aplicarFiltrosDocumentos();
            };
            reader.readAsDataURL(arquivo);
        }

        function baixarDocumento(id) {
            const doc = documentos.find(d => d.id === id);
            if (!doc) {
                mostrarNotificacao('Documento n√£o encontrado.', 'error');
                return;
            }
            const link = document.createElement('a');
            link.href = doc.conteudo;
            link.download = doc.nomeArquivo || 'documento';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function excluirDocumento(id) {
            if (!exigirPermissaoAcao('apagar', 'documento')) {
                return;
            }
            const doc = documentos.find(d => d.id === id);
            if (!doc) {
                mostrarNotificacao('Documento n√£o encontrado.', 'error');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este documento?')) return;
            const lista = documentos.filter(d => d.id !== id);
            salvarDocumentosLocal(lista);
            registrarAuditoria('excluir', 'documento', `Documento exclu√≠do: ${doc.nomeArquivo}`, doc, null);
            aplicarFiltrosDocumentos();
            mostrarNotificacao('Documento exclu√≠do com sucesso!', 'success');
        }

        function inicializarRelatoriosAvancados() {
            const btnAplicar = document.getElementById('btnAplicarFiltrosRelatorio');
            const btnCsv = document.getElementById('btnExportarCsvRelatorio');
            const btnPdf = document.getElementById('btnExportarPdfRelatorio');
            
            if (btnAplicar) {
                btnAplicar.addEventListener('click', aplicarFiltrosRelatorioAvancado);
            }
            if (btnCsv) {
                btnCsv.addEventListener('click', exportarRelatorioAvancadoCsv);
            }
            if (btnPdf) {
                btnPdf.addEventListener('click', exportarRelatorioAvancadoPdf);
            }
        }

        function normalizarDataRelatorio(valor) {
            if (!valor) return null;
            if (valor instanceof Date) return valor;
            if (typeof valor === 'number') return new Date(valor);
            if (typeof valor === 'string') {
                if (/^\d{4}-\d{2}-\d{2}/.test(valor)) {
                    return new Date(valor);
                }
                if (/^\d{2}\/\d{2}\/\d{4}/.test(valor)) {
                    const [dia, mes, ano] = valor.split('/');
                    return new Date(`${ano}-${mes}-${dia}`);
                }
                return new Date(valor);
            }
            return null;
        }

        function extrairDataRelatorio(item) {
            if (!item) return null;
            const campos = ['data', 'dataCriacao', 'dataInicio', 'dataRegisto', 'dataEntrada', 'dataLimite', 'vencimento'];
            for (const campo of campos) {
                if (item[campo]) {
                    const data = normalizarDataRelatorio(item[campo]);
                    if (data && !isNaN(data.getTime())) {
                        return data;
                    }
                }
            }
            return null;
        }

        function obterNomeClienteRelatorio(item) {
            if (!item) return 'N/D';
            if (item.clienteNome) return item.clienteNome;
            if (item.cliente) return item.cliente;
            if (item.clienteId) {
                const cliente = clientes.find(c => c.id === item.clienteId);
                return cliente ? cliente.nome : 'N/D';
            }
            return 'N/D';
        }

        function formatarDataRelatorio(data) {
            return data ? data.toLocaleDateString('pt-PT') : 'N/D';
        }

        function aplicarFiltrosRelatorioAvancado() {
            const clienteFiltro = document.getElementById('relatorioAvancadoCliente')?.value || '';
            const tipoFiltro = document.getElementById('relatorioAvancadoTipo')?.value || 'todos';
            const dataInicioValor = document.getElementById('relatorioAvancadoDataInicio')?.value || '';
            const dataFimValor = document.getElementById('relatorioAvancadoDataFim')?.value || '';
            
            const dataInicio = normalizarDataRelatorio(dataInicioValor);
            const dataFim = normalizarDataRelatorio(dataFimValor);
            if (dataFim) {
                dataFim.setHours(23, 59, 59, 999);
            }
            
            const fontes = [
                { tipo: 'honorarios', label: 'Honor√°rios', itens: Array.isArray(honorarios) ? honorarios : [], map: (item, cliente, data) => ({
                    tipo: 'Honor√°rios',
                    cliente,
                    descricao: item.descricao || item.servico || item.tipo || 'Honor√°rio',
                    valor: item.valor,
                    status: item.status || 'N/D',
                    data: formatarDataRelatorio(data),
                    _data: data
                }) },
                { tipo: 'contratos', label: 'Contratos', itens: Array.isArray(contratos) ? contratos : [], map: (item, cliente, data) => ({
                    tipo: 'Contratos',
                    cliente,
                    descricao: item.tipo || item.descricao || 'Contrato',
                    valor: item.valor,
                    status: item.status || 'N/D',
                    data: formatarDataRelatorio(data),
                    _data: data
                }) },
                { tipo: 'herancas', label: 'Heran√ßas', itens: Array.isArray(herancas) ? herancas : [], map: (item, cliente, data) => ({
                    tipo: 'Heran√ßas',
                    cliente,
                    descricao: item.tipo || item.descricao || 'Heran√ßa',
                    valor: item.valor,
                    status: item.status || 'N/D',
                    data: formatarDataRelatorio(data),
                    _data: data
                }) },
                { tipo: 'migracoes', label: 'Migra√ß√µes', itens: Array.isArray(migracoes) ? migracoes : [], map: (item, cliente, data) => ({
                    tipo: 'Migra√ß√µes',
                    cliente,
                    descricao: item.tipo || item.descricao || 'Migra√ß√£o',
                    valor: item.valor,
                    status: item.status || 'N/D',
                    data: formatarDataRelatorio(data),
                    _data: data
                }) },
                { tipo: 'registos', label: 'Registos', itens: Array.isArray(registos) ? registos : [], map: (item, cliente, data) => ({
                    tipo: 'Registos',
                    cliente,
                    descricao: item.tipo || item.descricao || 'Registo',
                    valor: item.valor,
                    status: item.status || 'N/D',
                    data: formatarDataRelatorio(data),
                    _data: data
                }) },
                { tipo: 'prazos', label: 'Prazos', itens: Array.isArray(prazos) ? prazos : [], map: (item, cliente, data) => ({
                    tipo: 'Prazos',
                    cliente,
                    descricao: item.descricao || item.tipo || 'Prazo',
                    valor: item.valor || '',
                    status: item.status || 'N/D',
                    data: formatarDataRelatorio(data),
                    _data: data
                }) }
            ];
            
            let resultados = [];
            fontes.forEach(fonte => {
                if (tipoFiltro !== 'todos' && tipoFiltro !== fonte.tipo) {
                    return;
                }
                fonte.itens.forEach(item => {
                    const clienteNome = obterNomeClienteRelatorio(item);
                    if (clienteFiltro && clienteNome !== clienteFiltro) return;
                    
                    const dataItem = extrairDataRelatorio(item);
                    if ((dataInicio || dataFim) && (!dataItem || isNaN(dataItem.getTime()))) return;
                    if (dataInicio && dataItem < dataInicio) return;
                    if (dataFim && dataItem > dataFim) return;
                    
                    resultados.push(fonte.map(item, clienteNome, dataItem));
                });
            });
            
            resultados.sort((a, b) => {
                if (!a._data && !b._data) return 0;
                if (!a._data) return 1;
                if (!b._data) return -1;
                return b._data - a._data;
            });
            
            relatorioAvancadoUltimosResultados = resultados;
            window.relatorioAvancadoUltimosResultados = resultados;
            
            const resumo = document.getElementById('relatorioAvancadoResumo');
            if (resumo) {
                const filtrosAplicados = [
                    clienteFiltro ? `Cliente: ${clienteFiltro}` : null,
                    tipoFiltro !== 'todos' ? `Tipo: ${tipoFiltro}` : null,
                    dataInicioValor ? `De: ${dataInicioValor}` : null,
                    dataFimValor ? `At√©: ${dataFimValor}` : null
                ].filter(Boolean).join(' | ');
                resumo.textContent = `Resultados: ${resultados.length}${filtrosAplicados ? ` ‚Ä¢ ${filtrosAplicados}` : ''}`;
            }
            
            const container = document.getElementById('relatorioAvancadoResultados');
            if (!container) return;
            
            if (resultados.length === 0) {
                container.innerHTML = '<div class="text-gray-500">Nenhum resultado encontrado para os filtros selecionados.</div>';
                return;
            }
            
            const limite = Math.min(resultados.length, 200);
            const linhas = resultados.slice(0, limite).map(item => `
                <tr class="border-b border-gray-200">
                    <td class="py-2 pr-4 font-medium text-gray-700">${item.tipo}</td>
                    <td class="py-2 pr-4">${item.cliente}</td>
                    <td class="py-2 pr-4">${item.descricao}</td>
                    <td class="py-2 pr-4">${item.valor !== undefined && item.valor !== '' ? `‚Ç¨${(parseFloat(item.valor) || 0).toFixed(2)}` : '‚Äî'}</td>
                    <td class="py-2 pr-4">${item.status}</td>
                    <td class="py-2">${item.data}</td>
                </tr>
            `).join('');
            
            container.innerHTML = `
                <table class="min-w-full">
                    <thead>
                        <tr class="text-left text-xs uppercase tracking-wider text-gray-500 border-b border-gray-200">
                            <th class="py-2 pr-4">Tipo</th>
                            <th class="py-2 pr-4">Cliente</th>
                            <th class="py-2 pr-4">Descri√ß√£o</th>
                            <th class="py-2 pr-4">Valor</th>
                            <th class="py-2 pr-4">Status</th>
                            <th class="py-2">Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${linhas}
                    </tbody>
                </table>
                ${resultados.length > limite ? `<div class="mt-2 text-xs text-gray-400">Mostrando ${limite} de ${resultados.length} resultados.</div>` : ''}
            `;
        }

        function exportarRelatorioAvancadoCsv() {
            if (!Array.isArray(relatorioAvancadoUltimosResultados) || relatorioAvancadoUltimosResultados.length === 0) {
                mostrarNotificacao('Aplique filtros para gerar resultados antes de exportar.', 'warning');
                return;
            }
            
            const headers = ['Tipo', 'Cliente', 'Descri√ß√£o', 'Valor', 'Status', 'Data'];
            const escapeCsv = (valor) => {
                const texto = valor === null || valor === undefined ? '' : String(valor);
                if (texto.includes(';') || texto.includes('"') || texto.includes('\n')) {
                    return `"${texto.replace(/"/g, '""')}"`;
                }
                return texto;
            };
            
            const linhas = relatorioAvancadoUltimosResultados.map(item => [
                item.tipo,
                item.cliente,
                item.descricao,
                item.valor !== undefined && item.valor !== '' ? (parseFloat(item.valor) || 0).toFixed(2) : '',
                item.status,
                item.data
            ].map(escapeCsv).join(';'));
            
            const csv = '\uFEFF' + [headers.join(';'), ...linhas].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `relatorio_avancado_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('Exporta√ß√£o Excel (CSV) conclu√≠da!', 'success');
        }

        function exportarRelatorioAvancadoPdf() {
            if (!Array.isArray(relatorioAvancadoUltimosResultados) || relatorioAvancadoUltimosResultados.length === 0) {
                mostrarNotificacao('Aplique filtros para gerar resultados antes de exportar.', 'warning');
                return;
            }
            
            const janela = window.open('', '_blank');
            if (!janela) {
                mostrarNotificacao('Bloqueio de pop-up: permita abrir a janela para exportar PDF.', 'warning');
                return;
            }
            
            const dataRelatorio = new Date().toLocaleString('pt-PT');
            const linhas = relatorioAvancadoUltimosResultados.slice(0, 500).map(item => `
                <tr>
                    <td>${item.tipo}</td>
                    <td>${item.cliente}</td>
                    <td>${item.descricao}</td>
                    <td>${item.valor !== undefined && item.valor !== '' ? `‚Ç¨${(parseFloat(item.valor) || 0).toFixed(2)}` : '‚Äî'}</td>
                    <td>${item.status}</td>
                    <td>${item.data}</td>
                </tr>
            `).join('');
            
            janela.document.write(`
                <html>
                <head>
                    <title>Relat√≥rio Avan√ßado</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 24px; color: #111827; }
                        h1 { font-size: 20px; margin-bottom: 6px; }
                        p { font-size: 12px; color: #6b7280; margin-top: 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 12px; }
                        th, td { border: 1px solid #e5e7eb; padding: 6px 8px; text-align: left; }
                        th { background: #f3f4f6; }
                    </style>
                </head>
                <body>
                    <h1>Relat√≥rio Avan√ßado</h1>
                    <p>Gerado em ${dataRelatorio}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Cliente</th>
                                <th>Descri√ß√£o</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${linhas}
                        </tbody>
                    </table>
                    ${relatorioAvancadoUltimosResultados.length > 500 ? `<p>Mostrando 500 de ${relatorioAvancadoUltimosResultados.length} resultados.</p>` : ''}
                </body>
                </html>
            `);
            janela.document.close();
            setTimeout(() => {
                janela.focus();
                janela.print();
            }, 400);
        }

        function inicializarSecao(secao) {
            lucide.createIcons();
            
            if (secao === 'dashboard') {
                setTimeout(() => {
                    criarGraficoHonorarios();
                }, 100);
            }
            if (secao === 'relatorios') {
                setTimeout(() => {
                    inicializarRelatoriosAvancados();
                }, 100);
            }
            if (secao === 'notificacoes') {
                setTimeout(() => {
                    inicializarAlertasAutomaticos();
                }, 100);
            }
            if (secao === 'documentos') {
                setTimeout(() => {
                    aplicarFiltrosDocumentos();
                }, 100);
            }
            if (secao === 'historico') {
                setTimeout(() => {
                    aplicarFiltrosHistorico();
                }, 100);
            }
        }

        function criarGraficoHonorarios() {
            const ctx = document.getElementById('chartHonorarios');
            if (!ctx) return;

            const honorariosPagos = honorarios.filter(h => h.status === 'pago').length;
            const honorariosPendentes = honorarios.filter(h => h.status === 'pendente').length;
            const honorariosVencidos = honorarios.filter(h => h.status === 'vencido').length;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pagos', 'Pendentes', 'Vencidos'],
                    datasets: [{
                        data: [honorariosPagos, honorariosPendentes, honorariosVencidos],
                        backgroundColor: [
                            '#10b981',
                            '#f59e0b',
                            '#ef4444'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function abrirModal(tipo) {
            const modal = criarModal(tipo);
            document.getElementById('modalContainer').innerHTML = modal;
            document.getElementById('modalContainer').classList.add('show');
            lucide.createIcons();
        }

        function abrirModalEdicaoCliente(cliente) {
            console.log('üîß abrirModalEdicaoCliente chamado (vers√£o criarModalEdicaoCliente) com:', cliente);
            const modal = criarModalEdicaoCliente(cliente);
            const modalContainer = document.getElementById('modalContainer');
            if (!modalContainer) {
                console.error('‚ùå modalContainer n√£o encontrado!');
                return;
            }
            modalContainer.innerHTML = modal;
            modalContainer.classList.add('show');
            lucide.createIcons();
            console.log('‚úÖ Modal de edi√ß√£o de cliente aberto (vers√£o criarModalEdicaoCliente)!');
            
            // Adicionar listener direto no formul√°rio ap√≥s cri√°-lo
            setTimeout(() => {
                const form = document.getElementById(`formEditarCliente_${cliente.id}`);
                const btnSalvar = form ? form.querySelector('button[type="submit"]') : null;
                
                if (form) {
                    console.log('üîß Formul√°rio encontrado (vers√£o criarModalEdicaoCliente), adicionando listener direto...');
                    
                    // Adicionar listener no formul√°rio
                    form.addEventListener('submit', function(e) {
                        console.log('üîß Evento submit capturado diretamente (vers√£o criarModalEdicaoCliente)!');
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üîß Chamando atualizarCliente com ID:', cliente.id);
                        const resultado = atualizarCliente(e, cliente.id);
                        console.log('üîß Resultado de atualizarCliente:', resultado);
                        return false;
                    }, false);
                    
                    console.log('‚úÖ Listener direto adicionado ao formul√°rio (vers√£o criarModalEdicaoCliente)!');
                } else {
                    console.error('‚ùå Formul√°rio n√£o encontrado ap√≥s criar modal (vers√£o criarModalEdicaoCliente)!');
                }
                
                if (btnSalvar) {
                    btnSalvar.addEventListener('click', function(e) {
                        console.log('üîß Bot√£o Salvar clicado diretamente (vers√£o criarModalEdicaoCliente)!');
                        e.preventDefault();
                        e.stopPropagation();
                        const form = document.getElementById(`formEditarCliente_${cliente.id}`);
                        if (form) {
                            console.log('üîß Chamando atualizarCliente diretamente do bot√£o com ID:', cliente.id);
                            const resultado = atualizarCliente(e, cliente.id);
                            console.log('üîß Resultado de atualizarCliente do bot√£o:', resultado);
                        }
                    }, false);
                    console.log('‚úÖ Listener adicionado ao bot√£o Salvar (vers√£o criarModalEdicaoCliente)!');
                } else {
                    console.error('‚ùå Bot√£o Salvar n√£o encontrado ap√≥s criar modal (vers√£o criarModalEdicaoCliente)!');
                }
            }, 100);
        }

        function abrirModalEdicaoContrato(contrato) {
            console.log('üîß abrirModalEdicaoContrato chamado com:', contrato);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoContrato';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = fecharModal;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Contrato</h3>
                            <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form onsubmit="atualizarContrato(event, ${contrato.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="editarContratoCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `
                                            <option value="${cliente.id}" data-nome="${cliente.nome}" ${cliente.id === contrato.clienteId ? 'selected' : ''}>${cliente.nome}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Servi√ßo *</label>
                                    <input type="text" id="editarContratoTipo" value="${contrato.tipo || ''}" list="tiposContratoEdicao2" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite ou selecione um tipo">
                                    <datalist id="tiposContratoEdicao2">
                                        <option value="Altera√ß√£o de pactos sociais">
                                        <option value="An√°lise e revis√£o de contratos">
                                        <option value="Cess√£o de quotas">
                                        <option value="Constitui√ß√£o de sociedades">
                                        <option value="Contratos de arrendamento">
                                        <option value="Contratos de compra e venda">
                                        <option value="Contratos de presta√ß√£o de servi√ßos">
                                        <option value="Contratos de trabalho">
                                        <option value="Pactos sociais">
                                        <option value="Consultoria">
                                        <option value="Assessoria">
                                        <option value="Representa√ß√£o">
                                        <option value="Compra e Venda">
                                        <option value="Arrendamento">
                                        <option value="Presta√ß√£o de Servi√ßos">
                                        <option value="Empr√©stimo">
                                        <option value="Outro">
                                    </datalist>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o *</label>
                                    <textarea id="editarContratoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descreva os servi√ßos a serem prestados...">${contrato.descricao || ''}</textarea>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="editarContratoValor" step="0.01" value="${contrato.valor || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="editarContratoIVA" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0" ${contrato.iva === 0 ? 'selected' : ''}>0% (Isento)</option>
                                            <option value="6" ${contrato.iva === 6 ? 'selected' : ''}>6% (Reduzida)</option>
                                            <option value="13" ${contrato.iva === 13 ? 'selected' : ''}>13% (Interm√©dia)</option>
                                            <option value="23" ${contrato.iva === 23 ? 'selected' : ''}>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="editarContratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente" ${contrato.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                            <option value="em_andamento" ${contrato.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                            <option value="concluido" ${contrato.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de In√≠cio *</label>
                                        <input type="date" id="editarContratoDataInicio" value="${contrato.dataInicio || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                    <textarea id="editarContratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observa√ß√µes adicionais sobre o contrato...">${contrato.observacoes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Altera√ß√µes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Adicionar ao body
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('‚úÖ Modal de edi√ß√£o de contrato criado e adicionado ao body!');
        }

        function fecharModal() {
            console.log('üîß fecharModal chamado');
            
            // Remover todos os modais com classe 'modal' PRIMEIRO
            const todosModais = document.querySelectorAll('.modal');
            todosModais.forEach(modal => {
                console.log('üîß Removendo modal:', modal.className);
                modal.remove();
            });
            
            // Limpar modalContainer
            const modalContainer = document.getElementById('modalContainer');
            if (modalContainer) {
                modalContainer.classList.remove('show');
                modalContainer.innerHTML = '';
                console.log('‚úÖ modalContainer limpo');
            }
            
            // Remover qualquer modal que possa estar no body
            const modalsNoBody = document.querySelectorAll('.fixed.inset-0');
            modalsNoBody.forEach(modal => {
                console.log('üîß Removendo modal do body:', modal.id);
                modal.remove();
            });
            
            // Remover modais espec√≠ficos
            const modalHeranca = document.getElementById('modalEdicaoHeranca');
            if (modalHeranca) {
                console.log('üîß Removendo modalEdicaoHeranca');
                modalHeranca.remove();
            }
            
            const modalMigracao = document.getElementById('modalEdicaoMigracao');
            if (modalMigracao) {
                console.log('üîß Removendo modalEdicaoMigracao');
                modalMigracao.remove();
            }
            
            const modalRegisto = document.getElementById('modalEdicaoRegisto');
            if (modalRegisto) {
                console.log('üîß Removendo modalEdicaoRegisto');
                modalRegisto.remove();
            }
            
            // Remover qualquer modal de edi√ß√£o
            const modaisEdicao = document.querySelectorAll('[id^="modalEdicao"]');
            modaisEdicao.forEach(modal => {
                console.log('üîß Removendo modal de edi√ß√£o:', modal.id);
                modal.remove();
            });
            
            console.log('‚úÖ fecharModal conclu√≠do');
        }

        function criarModal(tipo) {
            const modais = {
                cliente: criarModalCliente(),
                honorario: criarModalHonorario(),
                contrato: criarModalContrato(),
                migracao: criarModalMigracao()
            };
            return modais[tipo] || '<div class="modal-content p-6">Modal n√£o encontrado</div>';
        }

        function criarModalEdicaoCliente(cliente) {
            return `
                <div class="modal show" onclick="fecharModalRobusto()">
                    <div class="modal-content p-6" style="max-width: 500px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Editar Cliente</h3>
                            <button onclick="fecharModalRobusto()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formEditarCliente_${cliente.id}" onsubmit="return atualizarCliente(event, ${cliente.id});">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                                    <input type="text" id="editarClienteNome" value="${cliente.nome}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                    <input type="email" id="editarClienteEmail" value="${cliente.email}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                                    <input type="tel" id="editarClienteTelefone" value="${cliente.telefone}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NIF *</label>
                                    <input type="text" id="editarClienteNIF" value="${cliente.nif || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="123456789">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Endere√ßo</label>
                                    <textarea id="editarClienteEndereco" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${cliente.endereco || ''}</textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="editarClienteStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="ativo" ${cliente.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                        <option value="inativo" ${cliente.status === 'inativo' ? 'selected' : ''}>Inativo</option>
                                        <option value="suspenso" ${cliente.status === 'suspenso' ? 'selected' : ''}>Suspenso</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-between mt-6">
                                <div class="flex space-x-3">
                                    <button type="button" onclick="excluirCliente(${cliente.id})" class="btn btn-error">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        Excluir
                                    </button>
                                </div>
                                <div class="flex space-x-3">
                                    <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i data-lucide="save" class="w-4 h-4"></i>
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function criarModalCliente() {
            return `
                <div class="modal show" onclick="fecharModalRobusto()">
                    <div class="modal-content p-6" style="max-width: 500px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Novo Cliente</h3>
                            <button onclick="fecharModalRobusto()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formCliente" onsubmit="salvarCliente(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                                    <input type="text" id="clienteNome" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                    <input type="email" id="clienteEmail" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                                    <input type="tel" id="clienteTelefone" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NIF *</label>
                                    <input type="text" id="clienteNIF" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="123456789">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Endere√ßo</label>
                                    <textarea id="clienteEndereco" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="clienteStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="ativo">Ativo</option>
                                        <option value="inativo">Inativo</option>
                                        <option value="suspenso">Suspenso</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Cliente
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function criarModalHonorario() {
            return `
                <div class="modal show">
                    <div class="modal-content p-6" style="max-width: 500px;">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Novo Honor√°rio</h3>
                            <button onclick="fecharModalRobusto()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formHonorario" onsubmit="salvarHonorario(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="honorarioCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `
                                            <option value="${cliente.nome}">${cliente.nome}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Servi√ßo *</label>
                                    <input type="text" id="honorarioServico" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                    <input type="number" id="honorarioValor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="honorarioStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="pendente">Pendente</option>
                                        <option value="pago">Pago</option>
                                        <option value="vencido">Vencido</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                                    <input type="date" id="honorarioVencimento" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Honor√°rio
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function criarModalContrato() {
            return `
                <div class="modal show" onclick="fecharModalRobusto()">
                    <div class="modal-content p-6" style="max-width: 600px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Novo Contrato</h3>
                            <button onclick="fecharModalRobusto()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formContrato" onsubmit="salvarContrato(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="contratoCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `
                                            <option value="${cliente.id}" data-nome="${cliente.nome}">${cliente.nome}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Servi√ßo *</label>
                                    <select id="contratoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Altera√ß√£o de pactos sociais">Altera√ß√£o de pactos sociais</option>
                                        <option value="An√°lise e revis√£o de contratos">An√°lise e revis√£o de contratos</option>
                                        <option value="Cess√£o de quotas">Cess√£o de quotas</option>
                                        <option value="Constitui√ß√£o de sociedades">Constitui√ß√£o de sociedades</option>
                                        <option value="Contratos de arrendamento">Contratos de arrendamento</option>
                                        <option value="Contratos de compra e venda">Contratos de compra e venda</option>
                                        <option value="Contratos de presta√ß√£o de servi√ßos">Contratos de presta√ß√£o de servi√ßos</option>
                                        <option value="Contratos de trabalho">Contratos de trabalho</option>
                                        <option value="Pactos sociais">Pactos sociais</option>
                                        <option value="Consultoria">Consultoria</option>
                                        <option value="Assessoria">Assessoria</option>
                                        <option value="Representa√ß√£o">Representa√ß√£o</option>
                                        <option value="Outro">Outro</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="contratoValor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="contratoIVA" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0">0% (Isento)</option>
                                            <option value="6">6% (Reduzida)</option>
                                            <option value="13">13% (Interm√©dia)</option>
                                            <option value="23" selected>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                        <select id="contratoParceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('contrato')">
                                            <option value="sem">Sem parceria</option>
                                            <option value="empresa">Empresa</option>
                                            <option value="pessoa">Pessoa</option>
                                        </select>
                                    </div>
                                    
                                    <div id="contratoParceriaNomeDiv" style="display: none;">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                        <input type="text" id="contratoParceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                        <input type="number" id="contratoPercentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="contratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente">Pendente</option>
                                            <option value="em_andamento">Em Andamento</option>
                                            <option value="concluido">Conclu√≠do</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de In√≠cio *</label>
                                        <input type="date" id="contratoDataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                    <textarea id="contratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observa√ß√µes adicionais sobre o contrato..."></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Contrato
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function criarModalEdicaoContrato(contrato) {
            return `
                <div class="modal show" onclick="fecharModalRobusto()">
                    <div class="modal-content p-6" style="max-width: 600px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Editar Contrato</h3>
                            <button onclick="fecharModalRobusto()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formEditarContrato" onsubmit="atualizarContrato(event, ${contrato.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="editarContratoCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `
                                            <option value="${cliente.id}" data-nome="${cliente.nome}" ${cliente.id === contrato.clienteId ? 'selected' : ''}>${cliente.nome}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Servi√ßo *</label>
                                    <input type="text" id="editarContratoTipo" value="${contrato.tipo || ''}" list="tiposContratoEdicao2" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite ou selecione um tipo">
                                    <datalist id="tiposContratoEdicao2">
                                        <option value="Altera√ß√£o de pactos sociais">
                                        <option value="An√°lise e revis√£o de contratos">
                                        <option value="Cess√£o de quotas">
                                        <option value="Constitui√ß√£o de sociedades">
                                        <option value="Contratos de arrendamento">
                                        <option value="Contratos de compra e venda">
                                        <option value="Contratos de presta√ß√£o de servi√ßos">
                                        <option value="Contratos de trabalho">
                                        <option value="Pactos sociais">
                                        <option value="Consultoria">
                                        <option value="Assessoria">
                                        <option value="Representa√ß√£o">
                                        <option value="Compra e Venda">
                                        <option value="Arrendamento">
                                        <option value="Presta√ß√£o de Servi√ßos">
                                        <option value="Empr√©stimo">
                                        <option value="Outro">
                                    </datalist>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o *</label>
                                    <textarea id="editarContratoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descreva os servi√ßos a serem prestados...">${contrato.descricao || ''}</textarea>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="editarContratoValor" step="0.01" value="${contrato.valor || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="editarContratoIVA" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0" ${contrato.iva === 0 ? 'selected' : ''}>0% (Isento)</option>
                                            <option value="6" ${contrato.iva === 6 ? 'selected' : ''}>6% (Reduzida)</option>
                                            <option value="13" ${contrato.iva === 13 ? 'selected' : ''}>13% (Interm√©dia)</option>
                                            <option value="23" ${contrato.iva === 23 ? 'selected' : ''}>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="editarContratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="ativo" ${contrato.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                            <option value="suspenso" ${contrato.status === 'suspenso' ? 'selected' : ''}>Suspenso</option>
                                            <option value="terminado" ${contrato.status === 'terminado' ? 'selected' : ''}>Terminado</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de In√≠cio *</label>
                                        <input type="date" id="editarContratoDataInicio" value="${contrato.dataInicio || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                    <textarea id="editarContratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observa√ß√µes adicionais sobre o contrato...">${contrato.observacoes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-between mt-6">
                                <div class="flex space-x-3">
                                    <button type="button" onclick="excluirContrato(${contrato.id})" class="btn btn-error">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        Excluir
                                    </button>
                                </div>
                                <div class="flex space-x-3">
                                    <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i data-lucide="save" class="w-4 h-4"></i>
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function salvarCliente(event) {
            event.preventDefault();
            
            console.log('üîß salvarCliente chamado');
            console.log('üîß clientes antes:', clientes.length);
            
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const convidadoId = localStorage.getItem('convidadoId');
            
            // Validar dados √∫nicos
            const nome = document.getElementById('clienteNome').value.trim();
            const email = document.getElementById('clienteEmail').value.trim();
            const telefone = document.getElementById('clienteTelefone').value.trim();
            const nif = document.getElementById('clienteNIF').value.trim();

            if (!nome || !email || !telefone || !nif) {
                mostrarNotificacao('Por favor, preencha todos os campos obrigat√≥rios!', 'warning');
                return;
            }
            if (!validarEmail(email)) {
                mostrarNotificacao('Email inv√°lido. Verifique o formato.', 'error');
                return;
            }
            if (!validarTelefone(telefone)) {
                mostrarNotificacao('Telefone inv√°lido. Use apenas n√∫meros (9 a 15 d√≠gitos).', 'error');
                return;
            }
            if (!validarNIF(nif)) {
                mostrarNotificacao('NIF inv√°lido. Verifique o n√∫mero.', 'error');
                return;
            }
            
            // Verificar se j√° existe cliente com os mesmos dados
            const clienteExistente = clientes.find(c => 
                c.nome.toLowerCase() === nome.toLowerCase() ||
                (email && c.email && c.email.toLowerCase() === email.toLowerCase()) ||
                (telefone && c.telefone && c.telefone === telefone) ||
                (nif && c.nif && c.nif === nif)
            );
            
            if (clienteExistente) {
                let mensagemErro = 'J√° existe um cliente com:';
                if (clienteExistente.nome.toLowerCase() === nome.toLowerCase()) {
                    mensagemErro += ' ‚Ä¢ Nome igual';
                }
                if (email && clienteExistente.email && clienteExistente.email.toLowerCase() === email.toLowerCase()) {
                    mensagemErro += ' ‚Ä¢ Email igual';
                }
                if (telefone && clienteExistente.telefone && clienteExistente.telefone === telefone) {
                    mensagemErro += ' ‚Ä¢ Telefone igual';
                }
                if (nif && clienteExistente.nif && clienteExistente.nif === nif) {
                    mensagemErro += ' ‚Ä¢ NIF igual';
                }
                
                mostrarNotificacao(mensagemErro, 'error');
                return;
            }
            
            const cliente = {
                id: Date.now(),
                nome: nome,
                email: email,
                telefone: telefone,
                nif: nif,
                endereco: document.getElementById('clienteEndereco').value,
                status: document.getElementById('clienteStatus').value,
                dataCriacao: new Date().toISOString(),
                criadoPorConvidado: tipoUsuario === 'convidado' ? parseInt(convidadoId) : null
            };
            
            console.log('üîß Novo cliente criado:', cliente);
            
            clientes.push(cliente);
            console.log('üîß clientes ap√≥s push:', clientes.length);
            
            salvarDados('clientes', clientes);
            registrarAuditoria('criar', 'cliente', `Cliente criado: ${cliente.nome}`, null, cliente);
            mostrarNotificacao('Cliente salvo com sucesso!', 'success');
            
            // Fechar modal imediatamente
            fecharModal();
            
            // Recarregar se√ß√£o ap√≥s um pequeno delay
            setTimeout(() => {
                console.log('üîß Recarregando se√ß√£o clientes...');
                carregarSecao('clientes');
            }, 100);
        }

        function salvarHonorario(event) {
            event.preventDefault();
            
            const valorHonorario = parseFloat(document.getElementById('honorarioValor').value);
            const clienteHonorario = document.getElementById('honorarioCliente').value.trim();
            const servicoHonorario = document.getElementById('honorarioServico').value.trim();
            const vencimentoHonorario = document.getElementById('honorarioVencimento').value;
            
            if (!clienteHonorario || !servicoHonorario || !vencimentoHonorario || !valorHonorario || valorHonorario <= 0) {
                mostrarNotificacao('Preencha os campos obrigat√≥rios do honor√°rio.', 'warning');
                return;
            }
            
            const honorario = {
                id: Date.now(),
                cliente: clienteHonorario,
                servico: servicoHonorario,
                valor: valorHonorario,
                status: document.getElementById('honorarioStatus').value,
                vencimento: vencimentoHonorario,
                dataCriacao: new Date().toISOString()
            };
            
            honorarios.push(honorario);
            salvarDados('honorarios', honorarios);
            registrarAuditoria('criar', 'honorario', `Honor√°rio criado: ${honorario.cliente}`, null, honorario);
            mostrarNotificacao('Honor√°rio salvo com sucesso!', 'success');
            
            // Fechar modal imediatamente
            fecharModal();
            
            // Recarregar se√ß√£o ap√≥s um pequeno delay
            setTimeout(() => {
                carregarSecao('honorarios');
            }, 100);
        }

        function salvarContrato(event) {
            event.preventDefault();
            
            const clienteId = parseInt(document.getElementById('contratoCliente').value);
            const clienteSelecionado = clientes.find(c => c.id === clienteId);
            
            const valor = parseFloat(document.getElementById('contratoValor').value);
            const ivaPercent = parseFloat(document.getElementById('contratoIVA').value);
            const percentagem = parseFloat(document.getElementById('contratoPercentagem').value) || 0;
            const valorIVA = (valor * ivaPercent) / 100;
            const valorTotal = valor + valorIVA;
            const tipoContrato = document.getElementById('contratoTipo').value.trim();
            const dataInicio = document.getElementById('contratoDataInicio').value;
            
            if (!clienteId || !tipoContrato || !dataInicio || !valor || valor <= 0) {
                mostrarNotificacao('Preencha os campos obrigat√≥rios do contrato.', 'warning');
                return;
            }

            const contrato = {
                id: Date.now(),
                clienteId: clienteId,
                clienteNome: clienteSelecionado ? clienteSelecionado.nome : '',
                tipo: tipoContrato,
                valor: valor,
                iva: ivaPercent,
                percentagem: percentagem,
                valorIVA: valorIVA,
                valorTotal: valorTotal,
                status: document.getElementById('contratoStatus').value,
                dataInicio: dataInicio,
                observacoes: document.getElementById('contratoObservacoes').value,
                dataCriacao: new Date().toISOString()
            };
            
            contratos.push(contrato);
            salvarDados('contratos', contratos);
            registrarAuditoria('criar', 'contrato', `Contrato criado: ${contrato.clienteNome}`, null, contrato);
            
            // Criar prazo autom√°tico para o contrato
            // Carregar prazos do localStorage antes de adicionar
            const prazosSalvos = localStorage.getItem('prazos');
            if (prazosSalvos) {
                prazos = JSON.parse(prazosSalvos);
                window.prazos = prazos;
            }
            
            const prazoContrato = {
                id: Date.now() + 1,
                clienteId: clienteId,
                clienteNome: clienteSelecionado ? clienteSelecionado.nome : '',
                descricao: `Prazo para ${contrato.tipo}`,
                dataLimite: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30 dias
                status: 'ativo',
                tipo: 'contrato',
                prioridade: 'media',
                referenciaId: contrato.id,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoContrato);
            window.prazos = prazos;
            salvarDados('prazos', prazos);
            registrarAuditoria('criar', 'prazo', `Prazo criado para contrato: ${contrato.clienteNome}`, null, prazoContrato);
            
            mostrarNotificacao('Contrato e prazo criados com sucesso!', 'success');
            
            // Fechar modal imediatamente
            fecharModal();
            
            // Recarregar se√ß√£o ap√≥s um pequeno delay
            setTimeout(() => {
                carregarSecao('contratos');
            }, 100);
        }

        function atualizarCliente(event, id) {
            console.log('üîß atualizarCliente chamado com ID:', id);
            
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            try {
                // Verificar se o ID √© v√°lido
                const clienteId = parseInt(id);
                if (isNaN(clienteId)) {
                    console.error('‚ùå ID inv√°lido:', id);
                    mostrarNotificacao('ID de cliente inv√°lido!', 'error');
                    return false;
                }
                
                // Verificar se clientes est√° definido
                if (!clientes || !Array.isArray(clientes)) {
                    console.error('‚ùå Array de clientes n√£o est√° definido');
                    // Tentar carregar do localStorage
                    const clientesSalvos = localStorage.getItem('clientes');
                    if (clientesSalvos) {
                        clientes = JSON.parse(clientesSalvos);
                        window.clientes = clientes;
                    } else {
                        mostrarNotificacao('Erro: Clientes n√£o carregados!', 'error');
                        return false;
                    }
                }
                
                const clienteIndex = clientes.findIndex(c => c.id === clienteId);
                console.log('üîß Cliente encontrado no √≠ndice:', clienteIndex);
                
                if (clienteIndex === -1) {
                    console.error('‚ùå Cliente n√£o encontrado com ID:', clienteId);
                    mostrarNotificacao('Cliente n√£o encontrado!', 'error');
                    return false;
                }
                
                if (!exigirPermissaoAcao('editar', 'cliente')) {
                    return false;
                }

                // Obter valores do formul√°rio
                const nomeInput = document.getElementById('editarClienteNome');
                const emailInput = document.getElementById('editarClienteEmail');
                const telefoneInput = document.getElementById('editarClienteTelefone');
                const nifInput = document.getElementById('editarClienteNIF');
                const enderecoInput = document.getElementById('editarClienteEndereco');
                const statusInput = document.getElementById('editarClienteStatus');
                
                if (!nomeInput || !emailInput || !telefoneInput || !nifInput) {
                    console.error('‚ùå Campos do formul√°rio n√£o encontrados');
                    mostrarNotificacao('Erro: Formul√°rio n√£o encontrado!', 'error');
                    return false;
                }
                
                const nome = nomeInput.value.trim();
                const email = emailInput.value.trim();
                const telefone = telefoneInput.value.trim();
                const nif = nifInput.value.trim();
                const endereco = enderecoInput ? enderecoInput.value.trim() : '';
                const status = statusInput ? statusInput.value : 'ativo';
                
                console.log('üîß Dados do formul√°rio:', { nome, email, telefone, nif, endereco, status });
                
                // Validar campos obrigat√≥rios
                if (!nome || !email || !telefone || !nif) {
                    console.error('‚ùå Campos obrigat√≥rios n√£o preenchidos');
                    mostrarNotificacao('Por favor, preencha todos os campos obrigat√≥rios!', 'error');
                    return false;
                }
                if (!validarEmail(email)) {
                    mostrarNotificacao('Email inv√°lido. Verifique o formato.', 'error');
                    return false;
                }
                if (!validarTelefone(telefone)) {
                    mostrarNotificacao('Telefone inv√°lido. Use apenas n√∫meros (9 a 15 d√≠gitos).', 'error');
                    return false;
                }
                if (!validarNIF(nif)) {
                    mostrarNotificacao('NIF inv√°lido. Verifique o n√∫mero.', 'error');
                    return false;
                }
                
                // Verificar se j√° existe outro cliente com os mesmos dados (excluindo o cliente atual)
                const clienteExistente = clientes.find(c => 
                    c.id !== clienteId && (
                        c.nome.toLowerCase() === nome.toLowerCase() ||
                        (email && c.email && c.email.toLowerCase() === email.toLowerCase()) ||
                        (telefone && c.telefone && c.telefone === telefone) ||
                        (nif && c.nif && c.nif === nif)
                    )
                );
                
                if (clienteExistente) {
                    let mensagemErro = 'J√° existe outro cliente com:';
                    if (clienteExistente.nome.toLowerCase() === nome.toLowerCase()) {
                        mensagemErro += ' ‚Ä¢ Nome igual';
                    }
                    if (email && clienteExistente.email && clienteExistente.email.toLowerCase() === email.toLowerCase()) {
                        mensagemErro += ' ‚Ä¢ Email igual';
                    }
                    if (telefone && clienteExistente.telefone && clienteExistente.telefone === telefone) {
                        mensagemErro += ' ‚Ä¢ Telefone igual';
                    }
                    if (nif && clienteExistente.nif && clienteExistente.nif === nif) {
                        mensagemErro += ' ‚Ä¢ NIF igual';
                    }
                    
                    console.warn('‚ö†Ô∏è Cliente duplicado encontrado:', clienteExistente);
                    mostrarNotificacao(mensagemErro, 'error');
                    return false;
                }
                
                // Atualizar cliente
                const clienteAntes = { ...clientes[clienteIndex] };
                const clienteAtualizado = {
                    ...clientes[clienteIndex],
                    nome: nome,
                    email: email,
                    telefone: telefone,
                    nif: nif,
                    endereco: endereco,
                    status: status,
                    dataAtualizacao: new Date().toISOString()
                };
                
                clientes[clienteIndex] = clienteAtualizado;
                console.log('üîß Cliente atualizado:', clienteAtualizado);
                
                // Salvar dados no localStorage diretamente
                try {
                    const dadosString = JSON.stringify(clientes);
                    localStorage.setItem('clientes', dadosString);
                    window.clientes = clientes;
                    console.log('‚úÖ Dados salvos no localStorage:', dadosString.length, 'caracteres');
                    registrarAuditoria('atualizar', 'cliente', `Cliente atualizado: ${clienteAtualizado.nome}`, clienteAntes, clienteAtualizado);
                    
                    // Verificar se foi salvo corretamente
                    const verificar = localStorage.getItem('clientes');
                    if (!verificar) {
                        throw new Error('Dados n√£o foram salvos no localStorage');
                    }
                    console.log('‚úÖ Dados confirmados no localStorage');
                } catch (saveError) {
                    console.error('‚ùå Erro ao salvar no localStorage:', saveError);
                    mostrarNotificacao('Erro ao salvar dados: ' + saveError.message, 'error');
                    return false;
                }
                
                // Mostrar notifica√ß√£o
                mostrarNotificacao('Cliente atualizado com sucesso!', 'success');
                console.log('‚úÖ Notifica√ß√£o mostrada');
                
                // Fechar modal usando fecharModalRobusto para garantir que funciona
                console.log('üîß Fechando modal...');
                fecharModalRobusto();
                console.log('‚úÖ Modal fechado');
                
                // Recarregar se√ß√£o ap√≥s um pequeno delay
                setTimeout(() => {
                    console.log('üîß Recarregando se√ß√£o clientes...');
                    carregarSecao('clientes');
                    console.log('‚úÖ Se√ß√£o recarregada');
                }, 300);
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar cliente:', error);
                console.error('‚ùå Stack trace:', error.stack);
                mostrarNotificacao('Erro ao atualizar cliente: ' + error.message, 'error');
                return false;
            }
        }
        
        // Garantir que atualizarCliente seja globalmente acess√≠vel
        window.atualizarCliente = atualizarCliente;

        function excluirCliente(id) {
            if (confirm('Tem certeza que deseja excluir este cliente? Esta a√ß√£o n√£o pode ser desfeita.')) {
                if (!exigirAdmin('exclus√£o de clientes')) {
                    return;
                }
                const clienteAntes = clientes.find(c => c.id === id);
                clientes = clientes.filter(c => c.id !== id);
                salvarDados('clientes', clientes);
                registrarAuditoria('excluir', 'cliente', `Cliente exclu√≠do: ${clienteAntes?.nome || id}`, clienteAntes, null);
                mostrarNotificacao('Cliente exclu√≠do com sucesso!', 'success');
                
                // Fechar modal imediatamente
                fecharModal();
                
                // Recarregar se√ß√£o ap√≥s um pequeno delay
                setTimeout(() => {
                    carregarSecao('clientes');
                }, 100);
            }
        }

        function excluirClienteDireto(id) {
            console.log('üîß excluirClienteDireto chamado com ID:', id);
            
            if (!exigirPermissaoAcao('apagar', 'cliente')) {
                return;
            }
            if (confirm('Tem certeza que deseja excluir este cliente? Esta a√ß√£o n√£o pode ser desfeita.')) {
                // Carregar dados dos clientes
                const clientesSalvos = localStorage.getItem('clientes');
                let clientes = [];
                if (clientesSalvos) {
                    clientes = JSON.parse(clientesSalvos);
                }
                
                console.log('üîß Clientes antes da exclus√£o:', clientes.length);
                
                // Filtrar cliente a ser exclu√≠do
                const clientesAtualizados = clientes.filter(c => c.id !== parseInt(id));
                
                console.log('üîß Clientes ap√≥s exclus√£o:', clientesAtualizados.length);
                
                // Salvar dados atualizados
                localStorage.setItem('clientes', JSON.stringify(clientesAtualizados));
                window.clientes = clientesAtualizados;
                
                console.log('‚úÖ Clientes salvos no localStorage');
                
                mostrarNotificacao('Cliente exclu√≠do com sucesso!', 'success');
                
                // Recarregar se√ß√£o
                setTimeout(() => {
                    console.log('üîß Recarregando se√ß√£o clientes');
                    carregarSecao('clientes');
                    if (typeof atualizarListaClientes === 'function') {
                        atualizarListaClientes(clientesAtualizados);
                    }
                }, 100);
            }
        }

        function atualizarContrato(event, id) {
            console.log('üîß atualizarContrato chamado com ID:', id);
            event.preventDefault();
            
            const contratoIndex = contratos.findIndex(c => c.id === id);
            console.log('üîß Contrato encontrado no √≠ndice:', contratoIndex);
            
            if (contratoIndex !== -1) {
                if (!exigirPermissaoAcao('editar', 'contrato')) {
                    return false;
                }
                const clienteId = parseInt(document.getElementById('editarContratoCliente').value);
                const clienteSelecionado = clientes.find(c => c.id === clienteId);
                console.log('üîß Cliente selecionado:', clienteSelecionado);
                
                const valor = parseFloat(document.getElementById('editarContratoValor').value);
                const ivaPercent = parseFloat(document.getElementById('editarContratoIVA').value);
                const valorIVA = (valor * ivaPercent) / 100;
                const valorTotal = valor + valorIVA;

                contratos[contratoIndex] = {
                    ...contratos[contratoIndex],
                    clienteId: clienteId,
                    clienteNome: clienteSelecionado ? clienteSelecionado.nome : '',
                    tipo: document.getElementById('editarContratoTipo').value,
                    descricao: document.getElementById('editarContratoDescricao').value,
                    valor: valor,
                    iva: ivaPercent,
                    valorIVA: valorIVA,
                    valorTotal: valorTotal,
                    status: document.getElementById('editarContratoStatus').value,
                    dataInicio: document.getElementById('editarContratoDataInicio').value,
                    observacoes: document.getElementById('editarContratoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                console.log('üîß Contrato atualizado:', contratos[contratoIndex]);
                salvarDados('contratos', contratos);
                mostrarNotificacao('Contrato atualizado com sucesso!', 'success');
                
                // Fechar modal imediatamente
                fecharModal();
                
                // Recarregar se√ß√£o ap√≥s um pequeno delay
                setTimeout(() => {
                    carregarSecao('contratos');
                }, 100);
            } else {
                console.error('‚ùå Contrato n√£o encontrado com ID:', id);
                mostrarNotificacao('Contrato n√£o encontrado!', 'error');
            }
        }

        function excluirContrato(id) {
            if (confirm('Tem certeza que deseja excluir este contrato? Esta a√ß√£o n√£o pode ser desfeita.')) {
                contratos = contratos.filter(c => c.id !== id);
                salvarDados('contratos', contratos);
                mostrarNotificacao('Contrato exclu√≠do com sucesso!', 'success');
                
                // Fechar modal imediatamente
                fecharModal();
                
                // Recarregar se√ß√£o ap√≥s um pequeno delay
                setTimeout(() => {
                    carregarSecao('contratos');
                }, 100);
            }
        }

        function filtrarClientes() {
            aplicarFiltrosClientes();
        }

        function aplicarFiltrosClientes() {
            const busca = document.getElementById('buscaClientes')?.value.toLowerCase() || '';
            const buscaNif = document.getElementById('buscaNifClientes')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusCliente')?.value || '';
            const dataFiltro = document.getElementById('filtroDataCliente')?.value || '';
            
            const clientesFiltrados = clientes.filter(cliente => {
                // Filtro por busca de texto (nome, email, telefone)
                const matchBusca = !busca || 
                    cliente.nome.toLowerCase().includes(busca) || 
                    cliente.email.toLowerCase().includes(busca) ||
                    cliente.telefone.toLowerCase().includes(busca);
                
                // Filtro por NIF
                const matchNif = !buscaNif || 
                    (cliente.nif && cliente.nif.toLowerCase().includes(buscaNif));
                
                // Filtro por status
                const matchStatus = !status || cliente.status === status;
                
                // Filtro por data
                let matchData = true;
                if (dataFiltro) {
                    const dataCliente = new Date(cliente.dataCriacao);
                    const hoje = new Date();
                    
                    switch (dataFiltro) {
                        case 'hoje':
                            matchData = dataCliente.toDateString() === hoje.toDateString();
                            break;
                        case 'semana':
                            const inicioSemana = new Date(hoje);
                            inicioSemana.setDate(hoje.getDate() - hoje.getDay());
                            matchData = dataCliente >= inicioSemana;
                            break;
                        case 'mes':
                            matchData = dataCliente.getMonth() === hoje.getMonth() && 
                                        dataCliente.getFullYear() === hoje.getFullYear();
                            break;
                        case 'ano':
                            matchData = dataCliente.getFullYear() === hoje.getFullYear();
                            break;
                    }
                }
                
                return matchBusca && matchNif && matchStatus && matchData;
            });
            
            atualizarListaClientes(clientesFiltrados);
            document.getElementById('contadorClientes').textContent = clientesFiltrados.length;
        }

        function limparFiltrosClientes() {
            document.getElementById('buscaClientes').value = '';
            document.getElementById('buscaNifClientes').value = '';
            document.getElementById('filtroStatusCliente').value = '';
            document.getElementById('filtroDataCliente').value = '';
            aplicarFiltrosClientes();
        }

        function filtrarHonorarios() {
            aplicarFiltrosHonorarios();
        }

        function aplicarFiltrosHonorarios() {
            console.log('üîß aplicarFiltrosHonorarios chamado');
            const busca = document.getElementById('buscaHonorarios')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusHonorario')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinHonorario')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxHonorario')?.value) || Infinity;
            const vencimento = document.getElementById('filtroVencimentoHonorario')?.value || '';
            
            console.log('üîß Filtros aplicados:', { busca, status, valorMin, valorMax, vencimento });
            console.log('üîß Total de honor√°rios:', honorarios.length);
            
            const honorariosFiltrados = honorarios.filter(honorario => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    honorario.cliente.toLowerCase().includes(busca) || 
                    honorario.servico.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || honorario.status === status;
                
                // Filtro por valor
                const valor = parseFloat(honorario.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                // Filtro por vencimento
                let matchVencimento = true;
                if (vencimento && honorario.vencimento) {
                    const dataVencimento = new Date(honorario.vencimento);
                    const hoje = new Date();
                    
                    switch (vencimento) {
                        case 'hoje':
                            matchVencimento = dataVencimento.toDateString() === hoje.toDateString();
                            break;
                        case 'semana':
                            const fimSemana = new Date(hoje);
                            fimSemana.setDate(hoje.getDate() + 7);
                            matchVencimento = dataVencimento >= hoje && dataVencimento <= fimSemana;
                            break;
                        case 'mes':
                            const fimMes = new Date(hoje);
                            fimMes.setMonth(hoje.getMonth() + 1);
                            matchVencimento = dataVencimento >= hoje && dataVencimento <= fimMes;
                            break;
                        case 'vencido':
                            matchVencimento = dataVencimento < hoje;
                            break;
                    }
                }
                
                return matchBusca && matchStatus && matchValor && matchVencimento;
            });
            
            console.log('üîß Honor√°rios filtrados:', honorariosFiltrados.length);
            atualizarListaHonorarios(honorariosFiltrados);
            
            const contador = document.getElementById('contadorHonorarios');
            if (contador) {
                contador.textContent = honorariosFiltrados.length;
            }
            
            // Reinicializar √≠cones Lucide ap√≥s aplicar filtros
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('üîß √çcones Lucide reinicializados para Honor√°rios');
                }
            }, 100);
        }

        function limparFiltrosHonorarios() {
            document.getElementById('buscaHonorarios').value = '';
            document.getElementById('filtroStatusHonorario').value = '';
            document.getElementById('filtroValorMinHonorario').value = '';
            document.getElementById('filtroValorMaxHonorario').value = '';
            document.getElementById('filtroVencimentoHonorario').value = '';
            aplicarFiltrosHonorarios();
        }

        function filtrarContratos() {
            aplicarFiltrosContratos();
        }

        function aplicarFiltrosContratos() {
            console.log('üîß aplicarFiltrosContratos chamado');
            const busca = document.getElementById('buscaContratos')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusContrato')?.value || '';
            const clienteId = document.getElementById('filtroClienteContrato')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinContrato')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxContrato')?.value) || Infinity;
            const nif = document.getElementById('filtroNifContrato')?.value || '';
            
            console.log('üîß Filtros aplicados:', { busca, status, clienteId, valorMin, valorMax });
            console.log('üîß Total de contratos:', contratos.length);
            
            const contratosFiltrados = contratos.filter(contrato => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    contrato.clienteNome.toLowerCase().includes(busca) || 
                    contrato.tipo.toLowerCase().includes(busca) ||
                    (contrato.observacoes && contrato.observacoes.toLowerCase().includes(busca));
                
                // Filtro por status
                const matchStatus = !status || contrato.status === status;
                
                // Filtro por cliente
                const matchCliente = !clienteId || contrato.clienteId == clienteId;
                
                // Filtro por valor
                const valor = parseFloat(contrato.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                // Filtro por NIF
                const cliente = clientes.find(c => c.id === contrato.clienteId);
                const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));
                
                return matchBusca && matchStatus && matchCliente && matchValor && matchNif;
            });
            
            console.log('üîß Contratos filtrados:', contratosFiltrados.length);
            atualizarListaContratos(contratosFiltrados);
            
            const contador = document.getElementById('contadorContratos');
            if (contador) {
                contador.textContent = contratosFiltrados.length;
            }
            
            // Reinicializar √≠cones Lucide ap√≥s aplicar filtros
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('üîß √çcones Lucide reinicializados para Contratos');
                }
            }, 100);
        }

        function limparFiltrosContratos() {
            document.getElementById('buscaContratos').value = '';
            document.getElementById('filtroStatusContrato').value = '';
            document.getElementById('filtroClienteContrato').value = '';
            document.getElementById('filtroValorMinContrato').value = '';
            document.getElementById('filtroValorMaxContrato').value = '';
            document.getElementById('filtroNifContrato').value = '';
            aplicarFiltrosContratos();
        }

        function atualizarListaClientes(clientesFiltrados) {
            const tbody = document.getElementById('listaClientes');
            if (!tbody) return;
            
            tbody.innerHTML = clientesFiltrados.map(cliente => `
                <tr>
                    <td>
                        <button onclick="mostrarInformacoesCompletasCliente(${JSON.stringify(cliente).replace(/"/g, '&quot;')})" 
                                class="text-blue-600 hover:text-blue-800 font-medium cursor-pointer hover:underline flex items-center gap-1" 
                                title="Clicar para ver informa√ß√µes completas">
                            <i data-lucide="user" class="w-4 h-4"></i>
                            ${cliente.nome}
                        </button>
                    </td>
                    <td>${cliente.email}</td>
                    <td>${cliente.telefone}</td>
                    <td>${cliente.nif || '-'}</td>
                    <td><span class="status-badge status-${cliente.status || 'ativo'}">${cliente.status || 'Ativo'}</span></td>
                    <td>
                        <button onclick="editarClienteDireto(${cliente.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirItem('cliente', ${cliente.id})" class="text-red-600 hover:text-red-800" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Reinicializar √≠cones Lucide
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            }, 50);
        }

        function atualizarListaHonorarios(honorariosFiltrados) {
            const tbody = document.getElementById('listaHonorarios');
            if (!tbody) return;
            
            tbody.innerHTML = honorariosFiltrados.map(honorario => `
                <tr>
                    <td>${honorario.cliente}</td>
                    <td>${honorario.servico}</td>
                    <td>‚Ç¨${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</td>
                    <td><span class="status-badge status-${honorario.status}">${honorario.status}</span></td>
                    <td>${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}</td>
                    <td>
                        <button class="btn-editar-honorario text-blue-600 hover:text-blue-800 mr-2" data-id="${honorario.id}" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button class="btn-excluir-honorario text-red-600 hover:text-red-800" data-id="${honorario.id}" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Adicionar event listeners
            tbody.querySelectorAll('.btn-editar-honorario').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    console.log('üîß ID do bot√£o editar:', id, 'Tipo:', typeof id);
                    editarHonorarioDireto(id);
                });
            });
            
            tbody.querySelectorAll('.btn-excluir-honorario').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    console.log('üîß ID do bot√£o excluir:', id, 'Tipo:', typeof id);
                    excluirHonorarioDireto(id);
                });
            });
            
            // Reinicializar √≠cones Lucide
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            }, 50);
        }

        function atualizarListaContratos(contratosFiltrados) {
            const tbody = document.getElementById('listaContratos');
            if (!tbody) return;
            
            tbody.innerHTML = contratosFiltrados.map(contrato => `
                <tr>
                    <td>${contrato.clienteNome}</td>
                    <td>${contrato.tipo}</td>
                    <td>${contrato.descricao || '-'}</td>
                    <td>
                        ${(() => {
                            const valor = parseFloat(contrato.valor) || 0;
                            const iva = parseFloat(contrato.iva) || 0;
                            const valorComIVA = Number(valor) + (Number(valor) * Number(iva) / 100);
                            const valorFormatado = Math.round(valor * 100) / 100;
                            const valorComIVAFormatado = Math.round(valorComIVA * 100) / 100;
                            return `
                                <div class="text-sm font-bold text-black">‚Ç¨${valorFormatado.toFixed(2)}</div>
                                <div class="text-xs font-bold text-red-600">+ IVA: ‚Ç¨${valorComIVAFormatado.toFixed(2)}</div>
                            `;
                        })()}
                    </td>
                    <td><span class="status-badge status-${contrato.status}">${contrato.status === 'concluido' ? 'Conclu√≠do' : contrato.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span></td>
                    <td>${contrato.dataInicio ? new Date(contrato.dataInicio).toLocaleDateString('pt-PT') : '-'}</td>
                    <td>
                        <button onclick="editarContratoDireto(${contrato.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="abrirAnexosContrato(${contrato.id})" class="text-green-600 hover:text-green-800 mr-2" title="Documentos">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirContratoDireto(${contrato.id})" class="text-red-600 hover:text-red-800" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Reinicializar √≠cones Lucide ap√≥s atualizar a lista
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('üîß √çcones Lucide reinicializados na lista de Contratos');
                }
            }, 100);
        }

        function mostrarNotificacao(mensagem, tipo = 'info') {
            const container = document.getElementById('notificationsContainer');
            if (!container) {
                // Se n√£o h√° container, criar notifica√ß√£o tempor√°ria
                const notificacao = document.createElement('div');
                notificacao.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300`;
                
                const cores = {
                    success: 'bg-green-500 text-white',
                    error: 'bg-red-500 text-white',
                    warning: 'bg-yellow-500 text-white',
                    info: 'bg-blue-500 text-white'
                };
                
                notificacao.className += ` ${cores[tipo] || cores.info}`;
                notificacao.textContent = mensagem;
                
                document.body.appendChild(notificacao);
                
                // Remover ap√≥s 5 segundos
                setTimeout(() => {
                    if (notificacao.parentNode) {
                        notificacao.parentNode.removeChild(notificacao);
                    }
                }, 5000);
                return;
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            notification.textContent = mensagem;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function atualizarInterface() {
            lucide.createIcons();
        }

        // Fun√ß√£o fecharModal duplicada removida

        function editarItem(tipo, id) {
            console.log('üîß editarItem chamado:', tipo, id);

            if (!exigirPermissaoAcao('editar', tipo)) {
                return;
            }
            
            // Fechar qualquer modal aberto primeiro
            fecharModal();
            
            if (tipo === 'cliente') {
                const cliente = clientes.find(c => c.id === id);
                if (cliente) {
                    abrirModalEdicaoCliente(cliente);
                }
            } else if (tipo === 'contrato') {
                const contrato = contratos.find(c => c.id === id);
                console.log('Contrato encontrado:', contrato);
                if (contrato) {
                    // Aguardar um pouco para garantir que o modal anterior foi fechado
                    setTimeout(() => {
                        abrirModalEdicaoContrato(contrato);
                    }, 100);
                } else {
                    console.error('Contrato n√£o encontrado com ID:', id);
                    mostrarNotificacao('Contrato n√£o encontrado!', 'error');
                }
            } else if (tipo === 'honorario') {
                const honorario = honorarios.find(h => h.id === id);
                if (honorario) {
                    abrirModalEdicaoHonorario(honorario);
                }
            } else if (tipo === 'heranca') {
                const heranca = herancas.find(h => h.id === id);
                if (heranca) {
                    abrirModalEdicaoHeranca(heranca);
                }
            } else if (tipo === 'migracao') {
                const migracao = migracoes.find(m => m.id === id);
                if (migracao) {
                    abrirModalEdicaoMigracao(migracao);
                }
            } else if (tipo === 'registo') {
                const registo = registos.find(r => r.id === id);
                if (registo) {
                    abrirModalEdicaoRegisto(registo);
                }
            } else if (tipo === 'prazo') {
                const prazo = prazos.find(p => p.id === id);
                if (prazo) {
                    abrirModalEdicaoPrazo(prazo);
                }
            } else {
                mostrarNotificacao('Funcionalidade de edi√ß√£o em desenvolvimento', 'info');
            }
        }

        function excluirItem(tipo, id) {
            console.log('üîß excluirItem chamado:', tipo, id);

            if (!exigirPermissaoAcao('apagar', tipo)) {
                return;
            }
            
            if (confirm('Tem certeza que deseja excluir este item?')) {
                if (!exigirAdmin('exclus√£o de dados')) {
                    return;
                }
                if (tipo === 'cliente') {
                    const itemAntes = clientes.find(item => item.id === id);
                    clientes = clientes.filter(item => item.id !== id);
                    salvarDados('clientes', clientes);
                    registrarAuditoria('excluir', 'cliente', `Cliente exclu√≠do: ${itemAntes?.nome || id}`, itemAntes, null);
                    console.log('‚úÖ Cliente exclu√≠do');
                } else if (tipo === 'honorario') {
                    const itemAntes = honorarios.find(item => item.id === id);
                    honorarios = honorarios.filter(item => item.id !== id);
                    salvarDados('honorarios', honorarios);
                    registrarAuditoria('excluir', 'honorario', `Honor√°rio exclu√≠do: ${itemAntes?.cliente || id}`, itemAntes, null);
                    console.log('‚úÖ Honor√°rio exclu√≠do');
                } else if (tipo === 'contrato') {
                    console.log('üîß Excluindo contrato com ID:', id);
                    console.log('üîß Contratos antes:', contratos.length);
                    const itemAntes = contratos.find(item => item.id === id);
                    contratos = contratos.filter(item => item.id !== id);
                    console.log('üîß Contratos depois:', contratos.length);
                    salvarDados('contratos', contratos);
                    registrarAuditoria('excluir', 'contrato', `Contrato exclu√≠do: ${itemAntes?.clienteNome || id}`, itemAntes, null);
                    console.log('‚úÖ Contrato exclu√≠do');
                } else if (tipo === 'heranca') {
                    const itemAntes = herancas.find(item => item.id === id);
                    herancas = herancas.filter(item => item.id !== id);
                    salvarDados('herancas', herancas);
                    registrarAuditoria('excluir', 'heranca', `Heran√ßa exclu√≠da: ${itemAntes?.clienteNome || id}`, itemAntes, null);
                    console.log('‚úÖ Heran√ßa exclu√≠da');
                } else if (tipo === 'migracao') {
                    const itemAntes = migracoes.find(item => item.id === id);
                    migracoes = migracoes.filter(item => item.id !== id);
                    salvarDados('migracoes', migracoes);
                    registrarAuditoria('excluir', 'migracao', `Migra√ß√£o exclu√≠da: ${itemAntes?.clienteNome || id}`, itemAntes, null);
                    console.log('‚úÖ Migra√ß√£o exclu√≠da');
                } else if (tipo === 'registo') {
                    const itemAntes = registos.find(item => item.id === id);
                    registos = registos.filter(item => item.id !== id);
                    salvarDados('registos', registos);
                    registrarAuditoria('excluir', 'registo', `Registo exclu√≠do: ${itemAntes?.clienteNome || id}`, itemAntes, null);
                    console.log('‚úÖ Registo exclu√≠do');
                } else if (tipo === 'prazo') {
                    const itemAntes = prazos.find(item => item.id === id);
                    prazos = prazos.filter(item => item.id !== id);
                    salvarDados('prazos', prazos);
                    registrarAuditoria('excluir', 'prazo', `Prazo exclu√≠do: ${itemAntes?.descricao || id}`, itemAntes, null);
                    console.log('‚úÖ Prazo exclu√≠do');
                }
                mostrarNotificacao('Item exclu√≠do com sucesso!', 'success');
                carregarSecao(secaoAtiva);
            }
        }

        function exportarDados() {
            exportarDadosCompletos();
        }

        function importarDados() {
            if (!exigirAdmin('importar dados')) {
                return;
            }
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const dados = JSON.parse(e.target.result);
                            if (dados.dados) {
                                clientes = dados.dados.clientes || [];
                                honorarios = dados.dados.honorarios || [];
                                contratos = dados.dados.contratos || [];
                                salvarDados('clientes', clientes);
                                salvarDados('honorarios', honorarios);
                                salvarDados('contratos', contratos);
                                registrarAuditoria('importar', 'backup', 'Importa√ß√£o parcial (clientes/honor√°rios/contratos)');
                                mostrarNotificacao('Dados importados com sucesso!', 'success');
                                carregarSecao(secaoAtiva);
                            }
                        } catch (error) {
                            mostrarNotificacao('Erro ao importar dados', 'error');
                            registrarErro('importarDados', error);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function gerarRelatorioClientes() {
            const relatorio = `
RELAT√ìRIO DE CLIENTES
====================
Data: ${new Date().toLocaleDateString('pt-PT')}

Total de Clientes: ${clientes.length}

CLIENTES CADASTRADOS:
${clientes.map((cliente, index) => `
${index + 1}. ${cliente.nome}
   Email: ${cliente.email}
   Telefone: ${cliente.telefone}
   Status: ${cliente.status}
   Data: ${new Date(cliente.dataCriacao).toLocaleDateString('pt-PT')}
`).join('')}
            `;
            
            downloadRelatorio(relatorio, 'relatorio_clientes.txt');
        }

        function gerarRelatorioFinanceiro() {
            const valorTotal = honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            const honorariosPagos = honorarios.filter(h => h.status === 'pago');
            const valorPago = honorariosPagos.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            
            const relatorio = `
RELAT√ìRIO FINANCEIRO
====================
Data: ${new Date().toLocaleDateString('pt-PT')}

RESUMO FINANCEIRO:
- Total de Honor√°rios: ${honorarios.length}
- Valor Total: ‚Ç¨${(Math.round(valorTotal * 100) / 100).toFixed(2)}
- Valor Pago: ‚Ç¨${Number(valorPago).toFixed(2)}
- Valor Pendente: ‚Ç¨${Number(valorTotal - valorPago).toFixed(2)}

HONOR√ÅRIOS POR STATUS:
- Pagos: ${honorarios.filter(h => h.status === 'pago').length}
- Pendentes: ${honorarios.filter(h => h.status === 'pendente').length}
- Vencidos: ${honorarios.filter(h => h.status === 'vencido').length}

DETALHES DOS HONOR√ÅRIOS:
${honorarios.map((honorario, index) => `
${index + 1}. ${honorario.cliente} - ${honorario.servico}
   Valor: ‚Ç¨${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}
   Status: ${honorario.status}
   Vencimento: ${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}
`).join('')}
            `;
            
            downloadRelatorio(relatorio, 'relatorio_financeiro.txt');
        }

        function gerarRelatorioCompleto() {
            const relatorio = `
RELAT√ìRIO COMPLETO DO SISTEMA
============================
Data: ${new Date().toLocaleDateString('pt-PT')}
Vers√£o: 38.0

ESTAT√çSTICAS GERAIS:
- Clientes: ${clientes.length}
- Honor√°rios: ${honorarios.length}

RESUMO FINANCEIRO:
- Valor Total: ‚Ç¨${Number(honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0)).toFixed(2)}
- Honor√°rios Pagos: ${honorarios.filter(h => h.status === 'pago').length}
- Honor√°rios Pendentes: ${honorarios.filter(h => h.status === 'pendente').length}

CLIENTES:
${clientes.map((cliente, index) => `
${index + 1}. ${cliente.nome} (${cliente.status})
`).join('')}

HONOR√ÅRIOS:
${honorarios.map((honorario, index) => `
${index + 1}. ${honorario.cliente} - ‚Ç¨${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)} (${honorario.status})
`).join('')}
            `;
            
            downloadRelatorio(relatorio, 'relatorio_completo.txt');
        }

        function downloadRelatorio(conteudo, nomeArquivo) {
            const blob = new Blob([conteudo], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('Relat√≥rio gerado com sucesso!', 'success');
        }

        // === SISTEMA DE BACKUP AUTOM√ÅTICO ===
        
        const BACKUP_CONFIG = {
            intervaloMs: 5 * 60 * 1000,
            downloadIntervalMs: 24 * 60 * 60 * 1000
        };
        let backupInterval;
        let persistenciaInterval;
        let ultimoBackup = null;
        let ultimoBackupDownload = localStorage.getItem('ultimoBackupDownload') || null;
        let backupAutoDownloadAtivo = JSON.parse(localStorage.getItem('backupAutoDownloadAtivo') || 'true');
        let persistenciaAtiva = JSON.parse(localStorage.getItem('persistenciaAtiva') || 'false');
        let persistenciaUltimoSalvamento = localStorage.getItem('persistenciaUltimoSalvamento') || null;
        
        function iniciarSistemaBackup() {
            console.log('üíæ Iniciando sistema de backup autom√°tico');
            
            // Backup inicial
            criarBackupAutomatico();
            
            // Backup a cada 5 minutos
            backupInterval = setInterval(() => {
                criarBackupAutomatico();
            }, BACKUP_CONFIG.intervaloMs);
            
            // Backup antes de fechar a p√°gina
            window.addEventListener('beforeunload', () => {
                criarBackupAutomatico();
            });
            
            if (persistenciaAtiva) {
                iniciarPersistenciaExterna();
            }
        }
        
        function criarBackupAutomatico() {
            try {
                const backup = {
                    timestamp: new Date().toISOString(),
                    dados: {
                        clientes: clientes,
                        honorarios: honorarios,
                        contratos: contratos,
                        prazos: prazos,
                        notificacoes: notificacoes,
                        herancas: herancas,
                        migracoes: migracoes,
                        registos: registos
                    },
                    versao: '1.0',
                    tipo: 'automatico'
                };
                
                // Salvar backup no localStorage
                const backupKey = `backup_${Date.now()}`;
                localStorage.setItem(backupKey, JSON.stringify(backup));
                
                // Manter apenas os √∫ltimos 10 backups
                limparBackupsAntigos();
                
                ultimoBackup = backup.timestamp;
                verificarDownloadAutomatico(backup);
                console.log('‚úÖ Backup autom√°tico criado:', new Date(backup.timestamp).toLocaleString('pt-PT'));
                
            } catch (error) {
                console.error('‚ùå Erro ao criar backup autom√°tico:', error);
                registrarErro('criarBackupAutomatico', error);
            }
        }

        function verificarDownloadAutomatico(backup) {
            if (!backupAutoDownloadAtivo) return;
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            if (tipoUsuario !== 'admin') return;
            const agora = Date.now();
            const ultimo = ultimoBackupDownload ? new Date(ultimoBackupDownload).getTime() : 0;
            if (agora - ultimo >= BACKUP_CONFIG.downloadIntervalMs) {
                baixarBackupAutomatico(backup);
            }
        }

        function baixarBackupAutomatico(backup) {
            try {
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_automatico_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                ultimoBackupDownload = new Date().toISOString();
                localStorage.setItem('ultimoBackupDownload', ultimoBackupDownload);
                registrarAuditoria('backup', 'sistema', 'Backup autom√°tico com download');
            } catch (error) {
                console.error('‚ùå Erro ao baixar backup autom√°tico:', error);
                registrarErro('baixarBackupAutomatico', error);
            }
        }

        function toggleBackupAutoDownload(ativo) {
            backupAutoDownloadAtivo = !!ativo;
            localStorage.setItem('backupAutoDownloadAtivo', JSON.stringify(backupAutoDownloadAtivo));
            mostrarNotificacao(`Backup autom√°tico com download ${backupAutoDownloadAtivo ? 'ativado' : 'desativado'}.`, 'info');
        }

        async function ativarPersistenciaExterna() {
            if (!exigirAdmin('persist√™ncia externa')) return;
            if (!('showSaveFilePicker' in window)) {
                mostrarNotificacao('Seu navegador n√£o suporta persist√™ncia externa autom√°tica.', 'warning');
                return;
            }
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: `backup_persistente_${new Date().toISOString().split('T')[0]}.json`,
                    types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
                });
                window._persistenciaHandle = handle;
                persistenciaAtiva = true;
                localStorage.setItem('persistenciaAtiva', 'true');
                salvarPersistenciaExterna();
                iniciarPersistenciaExterna();
                mostrarNotificacao('Persist√™ncia externa ativada.', 'success');
            } catch (error) {
                console.error('‚ùå Erro ao ativar persist√™ncia externa:', error);
                registrarErro('ativarPersistenciaExterna', error);
            }
        }

        function desativarPersistenciaExterna() {
            persistenciaAtiva = false;
            localStorage.setItem('persistenciaAtiva', 'false');
            if (persistenciaInterval) clearInterval(persistenciaInterval);
            mostrarNotificacao('Persist√™ncia externa desativada.', 'info');
        }

        function iniciarPersistenciaExterna() {
            if (!persistenciaAtiva) return;
            if (persistenciaInterval) clearInterval(persistenciaInterval);
            persistenciaInterval = setInterval(() => {
                salvarPersistenciaExterna();
            }, 10 * 60 * 1000);
        }

        async function salvarPersistenciaExterna() {
            try {
                if (!persistenciaAtiva || !window._persistenciaHandle) {
                    return;
                }
                const dadosCompletos = {
                    timestamp: new Date().toISOString(),
                    versao: '1.0',
                    dados: {
                        clientes: clientes,
                        honorarios: honorarios,
                        contratos: contratos,
                        prazos: prazos,
                        notificacoes: notificacoes,
                        herancas: herancas,
                        migracoes: migracoes,
                        registos: registos
                    }
                };
                const writable = await window._persistenciaHandle.createWritable();
                await writable.write(JSON.stringify(dadosCompletos, null, 2));
                await writable.close();
                persistenciaUltimoSalvamento = new Date().toISOString();
                localStorage.setItem('persistenciaUltimoSalvamento', persistenciaUltimoSalvamento);
            } catch (error) {
                console.error('‚ùå Erro ao salvar persist√™ncia externa:', error);
                registrarErro('salvarPersistenciaExterna', error);
            }
        }
        
        function limparBackupsAntigos() {
            const chaves = Object.keys(localStorage);
            const backups = chaves.filter(chave => chave.startsWith('backup_'));
            
            if (backups.length > 10) {
                // Ordenar por timestamp (mais antigos primeiro)
                const backupsOrdenados = backups.sort((a, b) => {
                    const timestampA = parseInt(a.split('_')[1]);
                    const timestampB = parseInt(b.split('_')[1]);
                    return timestampA - timestampB;
                });
                
                // Remover os mais antigos
                const paraRemover = backupsOrdenados.slice(0, backups.length - 10);
                paraRemover.forEach(chave => {
                    localStorage.removeItem(chave);
                });
                
                console.log(`üóëÔ∏è Removidos ${paraRemover.length} backups antigos`);
            }
        }
        
        function exportarDadosCompletos() {
            try {
                if (!exigirAdmin('exportar a base de dados')) {
                    return;
                }
                const dadosCompletos = {
                    timestamp: new Date().toISOString(),
                    versao: '1.0',
                    dados: {
                        clientes: clientes,
                        honorarios: honorarios,
                        contratos: contratos,
                        prazos: prazos,
                        notificacoes: notificacoes,
                        herancas: herancas,
                        migracoes: migracoes,
                        registos: registos
                    },
                    estatisticas: {
                        totalClientes: clientes.length,
                        totalHonorarios: honorarios.length,
                        totalContratos: contratos.length,
                        totalPrazos: prazos.length,
                        totalNotificacoes: notificacoes.length,
                        totalHerancas: herancas.length,
                        totalMigracoes: migracoes.length,
                        totalRegistos: registos.length
                    }
                };
                
                const blob = new Blob([JSON.stringify(dadosCompletos, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_sistema_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                mostrarNotificacao('Backup exportado com sucesso!', 'success');
                registrarAuditoria('exportar', 'backup', 'Exporta√ß√£o completa da base de dados');
                
            } catch (error) {
                console.error('‚ùå Erro ao exportar dados:', error);
                mostrarNotificacao('Erro ao exportar backup', 'error');
                registrarErro('exportarDadosCompletos', error);
            }
        }
        
        function importarDadosCompletos() {
            if (!exigirAdmin('importar a base de dados')) {
                return;
            }
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (event) => {
                const arquivo = event.target.files[0];
                if (!arquivo) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const dadosImportados = JSON.parse(e.target.result);
                        
                        // Validar estrutura do arquivo
                        if (!dadosImportados.dados || !dadosImportados.versao) {
                            throw new Error('Arquivo de backup inv√°lido');
                        }
                        
                        // Confirmar importa√ß√£o
                        if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° substituir TODOS os dados atuais!\n\nTem certeza que deseja continuar?')) {
                            
                            // Criar backup antes de importar
                            criarBackupAutomatico();
                            
                            // Importar dados
                            clientes = dadosImportados.dados.clientes || [];
                            honorarios = dadosImportados.dados.honorarios || [];
                            contratos = dadosImportados.dados.contratos || [];
                            prazos = dadosImportados.dados.prazos || [];
                            notificacoes = dadosImportados.dados.notificacoes || [];
                            herancas = dadosImportados.dados.herancas || [];
                            migracoes = dadosImportados.dados.migracoes || [];
                            registos = dadosImportados.dados.registos || [];
                            
                            // Salvar dados importados
                            salvarDados('clientes', clientes);
                            salvarDados('honorarios', honorarios);
                            salvarDados('contratos', contratos);
                            salvarDados('prazos', prazos);
                            salvarDados('notificacoes', notificacoes);
                            salvarDados('herancas', herancas);
                            salvarDados('migracoes', migracoes);
                            salvarDados('registos', registos);
                            
                            mostrarNotificacao('Dados importados com sucesso!', 'success');
                            registrarAuditoria('importar', 'backup', 'Importa√ß√£o completa da base de dados');
                            
                            // Recarregar se√ß√£o atual
                            carregarSecao(secaoAtiva);
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao importar dados:', error);
                        mostrarNotificacao('Erro ao importar backup: ' + error.message, 'error');
                        registrarErro('importarDadosCompletos', error);
                    }
                };
                reader.readAsText(arquivo);
            };
            input.click();
        }
        
        function gerarBackup() {
            const chaves = Object.keys(localStorage);
            const backups = chaves.filter(chave => chave.startsWith('backup_'));
            const ultimoBackupTexto = ultimoBackup ? new Date(ultimoBackup).toLocaleString('pt-PT') : 'Nunca';
            const ultimoDownloadTexto = ultimoBackupDownload ? new Date(ultimoBackupDownload).toLocaleString('pt-PT') : 'Nunca';
            const ultimoPersistenciaTexto = persistenciaUltimoSalvamento ? new Date(persistenciaUltimoSalvamento).toLocaleString('pt-PT') : 'Nunca';
            const auditoria = obterAuditoria().slice(0, 10);
            
            return `
                <div class="space-y-6">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Status do Sistema de Backup</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">√öltimo backup autom√°tico:</span>
                                <span class="font-medium">${ultimoBackupTexto}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total de backups:</span>
                                <span class="font-medium">${backups.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Frequ√™ncia:</span>
                                <span class="font-medium">A cada 5 minutos</span>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Backup Autom√°tico com Download</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Ativo:</span>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" ${backupAutoDownloadAtivo ? 'checked' : ''} onchange="toggleBackupAutoDownload(this.checked)" />
                                    <span class="text-sm">${backupAutoDownloadAtivo ? 'Sim' : 'N√£o'}</span>
                                </label>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">√öltimo download:</span>
                                <span class="font-medium">${ultimoDownloadTexto}</span>
                            </div>
                            <div class="text-xs text-gray-500">
                                Intervalo: a cada 24 horas (quando o sistema est√° aberto)
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Persist√™ncia Externa (Ficheiro)</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Status:</span>
                                <span class="font-medium">${persistenciaAtiva ? 'Ativa' : 'Inativa'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">√öltimo salvamento:</span>
                                <span class="font-medium">${ultimoPersistenciaTexto}</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="ativarPersistenciaExterna()" class="btn btn-primary flex-1">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                    Ativar
                                </button>
                                <button onclick="desativarPersistenciaExterna()" class="btn btn-secondary flex-1">
                                    <i data-lucide="pause" class="w-4 h-4 mr-2"></i>
                                    Desativar
                                </button>
                            </div>
                            <p class="text-xs text-gray-500">
                                Requer um navegador compat√≠vel. Voc√™ precisar√° escolher o ficheiro.
                            </p>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">A√ß√µes de Backup</h3>
                        <div class="space-y-3">
                            <button onclick="criarBackupAutomatico(); mostrarNotificacao('Backup manual criado!', 'success')" 
                                    class="w-full btn btn-primary">
                                <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                Criar Backup Manual
                            </button>
                            <button onclick="exportarDadosCompletos()" 
                                    class="w-full btn btn-success">
                                <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                Exportar Backup Completo
                            </button>
                            <button onclick="importarDadosCompletos()" 
                                    class="w-full btn btn-warning">
                                <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                                Importar Backup
                            </button>
                            <button onclick="exportarAuditoria()" 
                                    class="w-full btn btn-secondary">
                                <i data-lucide="clipboard" class="w-4 h-4 mr-2"></i>
                                Exportar Auditoria
                            </button>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Hist√≥rico de Altera√ß√µes (√öltimas 10)</h3>
                        <div class="space-y-2">
                            ${auditoria.length > 0 ? auditoria.map(item => `
                                <div class="flex justify-between items-start p-3 bg-gray-50 rounded">
                                    <div>
                                        <p class="text-sm font-medium">${item.acao.toUpperCase()} ${item.entidade}</p>
                                        <p class="text-xs text-gray-600">${item.descricao}</p>
                                        <p class="text-xs text-gray-500">${new Date(item.timestamp).toLocaleString('pt-PT')}</p>
                                    </div>
                                    <span class="text-xs text-gray-500">${item.usuario}</span>
                                </div>
                            `).join('') : `
                                <div class="text-center py-4 text-sm text-gray-500">Nenhuma altera√ß√£o registrada</div>
                            `}
                        </div>
                        <div class="mt-3">
                            <button onclick="limparAuditoria()" class="btn btn-danger w-full">
                                <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                                Limpar Auditoria
                            </button>
                        </div>
                    </div>
                    
                    <div class="card p-6 border-red-200 bg-red-50">
                        <h3 class="text-lg font-semibold mb-4 text-red-800">‚ö†Ô∏è Limpeza Profissional</h3>
                        <p class="text-sm text-red-700 mb-4">
                            Use esta fun√ß√£o para limpar todos os dados de teste e preparar o sistema para uso profissional com clientes reais.
                        </p>
                        <button onclick="limparDadosParaUsoProfissional()" 
                                class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 flex items-center justify-center">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                            Limpar Todos os Dados
                        </button>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Informa√ß√µes do Sistema</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Clientes:</span>
                                <span class="font-medium">${clientes.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Contratos:</span>
                                <span class="font-medium">${contratos.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Honor√°rios:</span>
                                <span class="font-medium">${honorarios.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Prazos:</span>
                                <span class="font-medium">${prazos.length}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        // === SISTEMA RESTAURADO - SEM LOGIN ===
        
        
        // Carregar usu√°rios do localStorage
        
        
        // Sistema restaurado - sem login
        
        
        
        
        // Processar login
        function processarLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;
            
            if (fazerLogin(email, senha)) {
                // Login bem-sucedido
            }
        }
        
        // Mostrar sistema principal
        function mostrarSistema() {
            document.body.innerHTML = `
                <div class="flex h-screen bg-gray-900">
                    <!-- Sidebar -->
                    <div id="sidebar" class="w-64 bg-gray-800 shadow-lg">
                        <div class="p-6">
                            <div class="flex items-center">
                                <div class="h-8 w-8 bg-blue-600 rounded-lg flex items-center justify-center">
                                    <i data-lucide="scale" class="h-5 w-5 text-white"></i>
                                </div>
                                <h1 class="ml-3 text-xl font-bold text-white">Sistema Jur√≠dico</h1>
                            </div>
                        </div>
                        
                        <nav class="mt-6">
                            <a href="#" onclick="carregarSecao('dashboard')" class="sidebar-item" id="nav-dashboard">
                                <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                                Dashboard
                            </a>
                            <a href="#" onclick="carregarSecao('clientes')" class="sidebar-item" id="nav-clientes">
                                <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                                Gest√£o de Clientes
                            </a>
                            <a href="#" onclick="carregarSecao('honorarios')" class="sidebar-item" id="nav-honorarios">
                                <i data-lucide="dollar-sign" class="w-5 h-5 mr-3"></i>
                                Gest√£o de Honor√°rios
                            </a>
                            <a href="#" onclick="carregarSecao('contratos')" class="sidebar-item" id="nav-contratos">
                                <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                                Gest√£o de Contratos
                            </a>
                            <a href="#" onclick="carregarSecao('herancas')" class="sidebar-item" id="nav-herancas">
                                <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                                Gest√£o de Heran√ßas
                            </a>
                            <a href="#" onclick="carregarSecao('migracao')" class="sidebar-item" id="nav-migracao">
                                <i data-lucide="globe" class="w-5 h-5 mr-3"></i>
                                Gest√£o de Migra√ß√£o
                            </a>
                            <a href="#" onclick="carregarSecao('registos')" class="sidebar-item" id="nav-registos">
                                <i data-lucide="clipboard" class="w-5 h-5 mr-3"></i>
                                Gest√£o de Registos
                            </a>
                            <a href="#" onclick="carregarSecao('prazos')" class="sidebar-item" id="nav-prazos">
                                <i data-lucide="calendar" class="w-5 h-5 mr-3"></i>
                                Gest√£o de Prazos
                            </a>
                            <a href="#" onclick="carregarSecao('notificacoes')" class="sidebar-item" id="nav-notificacoes">
                                <i data-lucide="bell" class="w-5 h-5 mr-3"></i>
                                Notifica√ß√µes
                                <span id="badgeNotificacoes" class="badge hidden">0</span>
                            </a>
                            <a href="#" onclick="carregarSecao('relatorios')" class="sidebar-item" id="nav-relatorios">
                                <i data-lucide="bar-chart-3" class="w-5 h-5 mr-3"></i>
                                Gest√£o de Relat√≥rios
                            </a>
                            <a href="#" onclick="carregarSecao('backup')" class="sidebar-item" id="nav-backup">
                                <i data-lucide="database" class="w-5 h-5 mr-3"></i>
                                Backup
                            </a>
                        </nav>
                        
                        <div class="absolute bottom-0 w-64 p-4">
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="flex items-center">
                                    <div class="h-8 w-8 bg-gray-600 rounded-full flex items-center justify-center">
                                        <i data-lucide="user" class="h-4 w-4 text-gray-300"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-white">${usuarioLogado ? usuarioLogado.nome : 'Usu√°rio'}</p>
                                        <p class="text-xs text-gray-300">${usuarioLogado ? usuarioLogado.email : ''}</p>
                                    </div>
                                </div>
                                <button onclick="fazerLogout()" class="mt-2 w-full text-left text-sm text-red-400 hover:text-red-300">
                                    <i data-lucide="log-out" class="w-4 h-4 inline mr-1"></i>
                                    Sair
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Conte√∫do Principal -->
                    <div class="flex-1 flex flex-col overflow-hidden bg-gray-100">
                        <!-- Header -->
                        <header class="bg-white shadow-sm border-b border-gray-200">
                            <div class="px-6 py-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h2 id="tituloSecao" class="text-2xl font-bold text-gray-900">Sistema Legal</h2>
                                        <p id="subtituloSecao" class="text-sm text-gray-600">Vis√£o geral do sistema</p>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100">
                                            <i data-lucide="menu" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </header>
                        
                        <!-- Conte√∫do -->
                        <main class="flex-1 overflow-y-auto">
                            <div class="p-6">
                                <div id="conteudoDinamico">
                                    <!-- Conte√∫do ser√° carregado aqui -->
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
                
                <!-- Modal Container -->
                <div id="modalContainer"></div>
                
                <!-- Notifications Container -->
                <div id="notificationsContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
            `;
            lucide.createIcons();
        }
        
        // Mostrar modal para criar usu√°rio
        function mostrarCriarUsuario() {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Criar Novo Usu√°rio</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="criarUsuario(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                                        <input type="text" id="novoNome" required 
                                               class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                        <input type="email" id="novoEmail" required 
                                               class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                                        <input type="password" id="novaSenha" required 
                                               class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Usu√°rio</label>
                                        <select id="novoTipo" required 
                                                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                            <option value="admin">Administrador</option>
                                            <option value="usuario">Usu√°rio</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalRobusto()" 
                                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                        Cancelar
                                    </button>
                                    <button type="submit" 
                                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                        Criar Usu√°rio
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
            lucide.createIcons();
        }
        
        // Criar novo usu√°rio
        function criarUsuario(event) {
            event.preventDefault();
            
            const nome = document.getElementById('novoNome').value;
            const email = document.getElementById('novoEmail').value;
            const senha = document.getElementById('novaSenha').value;
            const tipo = document.getElementById('novoTipo').value;
            
            // Verificar se email j√° existe
            if (usuarios.find(u => u.email === email)) {
                mostrarNotificacao('Email j√° cadastrado', 'error');
                return;
            }
            
            const novoUsuario = {
                id: Date.now(),
                nome: nome,
                email: email,
                senha: senha,
                tipo: tipo,
                ativo: true,
                dataCriacao: new Date().toISOString()
            };
            
            usuarios.push(novoUsuario);
            salvarUsuarios();
            
            mostrarNotificacao('Usu√°rio criado com sucesso!', 'success');
            fecharModal();
        }
        

        // === FUN√á√ÉO GEN√âRICA PARA CONVERTER ARQUIVO ===
        function converterArquivoParaBase64(arquivo, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                callback(e.target.result);
            };
            reader.readAsDataURL(arquivo);
        }
        
        // === FUN√á√ÉO ESPEC√çFICA PARA REGISTOS ===
        function adicionarAnexoRegistoReal(event, registoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const registo = registos.find(r => r.id === registoId);
                if (registo) {
                    if (!registo.anexos) registo.anexos = [];
                    registo.anexos.push(anexo);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    abrirAnexosRegisto(registoId);
                }
            });
        }
        
        // === SISTEMA DE ANEXOS PARA REGISTOS ===
        
        function abrirAnexosRegisto(registoId) {
            const registo = registos.find(r => r.id === registoId);
            if (!registo) return;
            
            if (!registo.anexos) {
                registo.anexos = [];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos do Registo</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexoRegisto(event, ${registoId})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('registo')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="certidao">Certid√£o</option>
                                                <option value="documento">Documento</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizadoRegisto" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descri√ß√£o do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${registo.anexos.length})</h4>
                                ${registo.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${registo.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} ‚Ä¢ ${anexo.tamanho} ‚Ä¢ ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexoRegisto(${registoId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }
        
        function adicionarAnexoRegisto(event, registoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const registo = registos.find(r => r.id === registoId);
                if (registo) {
                    if (!registo.anexos) registo.anexos = [];
                    registo.anexos.push(anexo);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    abrirAnexosRegisto(registoId);
                }
            });
        }
        
        function removerAnexoRegisto(registoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const registo = registos.find(r => r.id === registoId);
                if (registo && registo.anexos) {
                    registo.anexos = registo.anexos.filter(a => a.id !== anexoId);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosRegisto(registoId);
                }
            }
        }

        // === SISTEMA DE ANEXOS PARA PRAZOS ===
        
        function abrirAnexosPrazo(prazoId) {
            const prazo = prazos.find(p => p.id === prazoId);
            if (!prazo) return;
            
            if (!prazo.anexos) {
                prazo.anexos = [];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos do Prazo</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexoPrazo(event, ${prazoId})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('prazo')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="documento">Documento</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="certidao">Certid√£o</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizadoPrazo" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descri√ß√£o do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${prazo.anexos.length})</h4>
                                ${prazo.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${prazo.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} ‚Ä¢ ${anexo.tamanho} ‚Ä¢ ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexoPrazo(${prazoId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }
        
        function adicionarAnexoPrazo(event, prazoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            const anexo = {
                id: Date.now().toString(),
                nome: nome,
                tipo: tipo,
                descricao: descricao,
                nomeArquivo: arquivo.name,
                tamanho: formatarTamanho(arquivo.size),
                dataUpload: new Date().toISOString(),
                tipoArquivo: arquivo.type,
                conteudo: 'CONVERSAO_REAL_IMPLEMENTADA_FINAL...'
            };
            
            const prazo = prazos.find(p => p.id === prazoId);
            if (prazo) {
                if (!prazo.anexos) prazo.anexos = [];
                prazo.anexos.push(anexo);
                salvarDados('prazos', prazos);
                mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                abrirAnexosPrazo(prazoId);
            }
        }
        
        function removerAnexoPrazo(prazoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const prazo = prazos.find(p => p.id === prazoId);
                if (prazo && prazo.anexos) {
                    prazo.anexos = prazo.anexos.filter(a => a.id !== anexoId);
                    salvarDados('prazos', prazos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosPrazo(prazoId);
                }
            }
        }

        // === SISTEMA DE NOTIFICA√á√ïES AUTOM√ÅTICAS ===
        
        function iniciarSistemaNotificacoes() {
            console.log('üîî Iniciando sistema de notifica√ß√µes');
            verificarHonorariosVencidos();
            verificarPrazosUrgentes();
            atualizarBadgeNotificacoes();
            
            // Verificar a cada 5 minutos
            setInterval(() => {
                verificarHonorariosVencidos();
                verificarPrazosUrgentes();
                atualizarBadgeNotificacoes();
            }, 5 * 60 * 1000);
        }

        function inicializarAlertasAutomaticos() {
            const emailInput = document.getElementById('alertasEmailDestino');
            const whatsappInput = document.getElementById('alertasWhatsAppDestino');
            if (emailInput) {
                emailInput.value = localStorage.getItem('alertasEmailDestino') || '';
                emailInput.addEventListener('change', () => {
                    localStorage.setItem('alertasEmailDestino', emailInput.value.trim());
                });
            }
            if (whatsappInput) {
                whatsappInput.value = localStorage.getItem('alertasWhatsAppDestino') || '';
                whatsappInput.addEventListener('change', () => {
                    whatsappInput.value = whatsappInput.value.replace(/\D/g, '');
                    localStorage.setItem('alertasWhatsAppDestino', whatsappInput.value.trim());
                });
            }
        }

        function gerarResumoAlertasAutomaticos() {
            const hoje = new Date();
            const proximos3Dias = new Date(hoje.getTime() + 3 * 24 * 60 * 60 * 1000);
            const honorariosVencidos = honorarios.filter(h => {
                if (!h.vencimento) return false;
                const dataVenc = new Date(h.vencimento);
                return !isNaN(dataVenc.getTime()) && dataVenc < hoje && h.status !== 'pago';
            });
            const prazosVencidos = prazos.filter(p => {
                if (!p.dataLimite) return false;
                const dataLimite = new Date(p.dataLimite);
                return !isNaN(dataLimite.getTime()) && dataLimite < hoje && p.status === 'ativo';
            });
            const prazosHoje = prazos.filter(p => {
                if (!p.dataLimite) return false;
                const dataLimite = new Date(p.dataLimite);
                return !isNaN(dataLimite.getTime()) && dataLimite.toDateString() === hoje.toDateString() && p.status === 'ativo';
            });
            const prazos3Dias = prazos.filter(p => {
                if (!p.dataLimite) return false;
                const dataLimite = new Date(p.dataLimite);
                return !isNaN(dataLimite.getTime()) && dataLimite > hoje && dataLimite <= proximos3Dias && p.status === 'ativo';
            });
            
            const linhas = [];
            linhas.push(`Resumo de alertas (${hoje.toLocaleDateString('pt-PT')})`);
            linhas.push('');
            linhas.push(`Honor√°rios vencidos: ${honorariosVencidos.length}`);
            honorariosVencidos.slice(0, 10).forEach(h => {
                const data = new Date(h.vencimento);
                linhas.push(`- ${h.cliente} | ‚Ç¨${(parseFloat(h.valor) || 0).toFixed(2)} | venc. ${data.toLocaleDateString('pt-PT')}`);
            });
            linhas.push('');
            linhas.push(`Prazos vencidos: ${prazosVencidos.length}`);
            prazosVencidos.slice(0, 10).forEach(p => {
                linhas.push(`- ${p.clienteNome} | ${p.descricao} | venc. ${new Date(p.dataLimite).toLocaleDateString('pt-PT')}`);
            });
            linhas.push('');
            linhas.push(`Prazos hoje: ${prazosHoje.length}`);
            prazosHoje.slice(0, 10).forEach(p => {
                linhas.push(`- ${p.clienteNome} | ${p.descricao}`);
            });
            linhas.push('');
            linhas.push(`Prazos em at√© 3 dias: ${prazos3Dias.length}`);
            prazos3Dias.slice(0, 10).forEach(p => {
                linhas.push(`- ${p.clienteNome} | ${p.descricao} | ${new Date(p.dataLimite).toLocaleDateString('pt-PT')}`);
            });
            return linhas.join('\n');
        }

        function enviarAlertasEmail() {
            const destino = (document.getElementById('alertasEmailDestino')?.value || '').trim();
            if (!destino) {
                mostrarNotificacao('Informe o email de destino.', 'warning');
                return;
            }
            const corpo = gerarResumoAlertasAutomaticos();
            const assunto = `Alertas Autom√°ticos - ${new Date().toLocaleDateString('pt-PT')}`;
            const link = `mailto:${encodeURIComponent(destino)}?subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpo)}`;
            window.location.href = link;
        }

        function enviarAlertasWhatsApp() {
            const destino = (document.getElementById('alertasWhatsAppDestino')?.value || '').trim();
            if (!destino) {
                mostrarNotificacao('Informe o n√∫mero de WhatsApp (com indicativo).', 'warning');
                return;
            }
            const corpo = gerarResumoAlertasAutomaticos();
            const link = `https://wa.me/${encodeURIComponent(destino)}?text=${encodeURIComponent(corpo)}`;
            window.open(link, '_blank');
        }


        function verificarHonorariosVencidos() {
            const hoje = new Date();
            const honorariosVencidos = honorarios.filter(h => {
                try {
                    if (!h.vencimento) return false;
                    const dataVencimento = new Date(h.vencimento);
                    if (isNaN(dataVencimento.getTime())) {
                        console.warn('Data de vencimento inv√°lida no honor√°rio:', h.vencimento);
                        return false;
                    }
                    return dataVencimento < hoje && h.status === 'pendente';
                } catch (error) {
                    console.warn('Erro ao processar honor√°rio:', h.id, error);
                    return false;
                }
            });

            honorariosVencidos.forEach(honorario => {
                // Atualizar status para vencido
                const index = honorarios.findIndex(h => h.id === honorario.id);
                if (index !== -1) {
                    honorarios[index].status = 'vencido';
                }

                // Criar notifica√ß√£o se n√£o existir
                const notificacaoExistente = notificacoes.find(n => 
                    n.tipo === 'honorario' && 
                    n.referenciaId === honorario.id && 
                    n.titulo.includes('Vencido')
                );

                if (!notificacaoExistente) {
                    criarNotificacao({
                        tipo: 'honorario',
                        titulo: 'Honor√°rio Vencido',
                        mensagem: `O honor√°rio de ‚Ç¨${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)} do cliente ${honorario.cliente} est√° vencido desde ${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}`,
                        prioridade: 'alta',
                        referenciaId: honorario.id,
                        acao: 'ver_honorario'
                    });
                    
                }
            });

            salvarDados('honorarios', honorarios);
        }

        function verificarPrazosUrgentes() {
            const hoje = new Date();
            const amanha = new Date(hoje.getTime() + 24 * 60 * 60 * 1000);
            const proximos3Dias = new Date(hoje.getTime() + 3 * 24 * 60 * 60 * 1000);

            prazos.forEach(prazo => {
                try {
                    if (!prazo.dataLimite) return;
                    const dataLimite = new Date(prazo.dataLimite);
                    if (isNaN(dataLimite.getTime())) {
                        console.warn('Data inv√°lida no prazo:', prazo.dataLimite);
                        return;
                    }
                    const diasRestantes = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));

                // Prazos vencidos
                if (dataLimite < hoje && prazo.status === 'ativo') {
                    const notificacaoExistente = notificacoes.find(n => 
                        n.tipo === 'prazo' && 
                        n.referenciaId === prazo.id && 
                        n.titulo.includes('Vencido')
                    );

                    if (!notificacaoExistente) {
                        criarNotificacao({
                            tipo: 'prazo',
                            titulo: 'Prazo Vencido',
                            mensagem: `O prazo "${prazo.descricao}" do cliente ${prazo.clienteNome} venceu em ${dataLimite.toLocaleDateString('pt-PT')}`,
                            prioridade: 'critica',
                            referenciaId: prazo.id,
                            acao: 'ver_prazo'
                        });
                    }
                }
                // Prazos que vencem hoje
                else if (dataLimite.toDateString() === hoje.toDateString() && prazo.status === 'ativo') {
                    const notificacaoExistente = notificacoes.find(n => 
                        n.tipo === 'prazo' && 
                        n.referenciaId === prazo.id && 
                        n.titulo.includes('Hoje')
                    );

                    if (!notificacaoExistente) {
                        criarNotificacao({
                            tipo: 'prazo',
                            titulo: 'Prazo Vence Hoje',
                            mensagem: `O prazo "${prazo.descricao}" do cliente ${prazo.clienteNome} vence hoje!`,
                            prioridade: 'alta',
                            referenciaId: prazo.id,
                            acao: 'ver_prazo'
                        });
                    }
                }
                // Prazos que vencem em 3 dias
                else if (dataLimite <= proximos3Dias && dataLimite > amanha && prazo.status === 'ativo') {
                    const notificacaoExistente = notificacoes.find(n => 
                        n.tipo === 'prazo' && 
                        n.referenciaId === prazo.id && 
                        n.titulo.includes('3 dias')
                    );

                    if (!notificacaoExistente) {
                        criarNotificacao({
                            tipo: 'prazo',
                            titulo: 'Prazo em 3 Dias',
                            mensagem: `O prazo "${prazo.descricao}" do cliente ${prazo.clienteNome} vence em ${diasRestantes} dias`,
                            prioridade: 'media',
                            referenciaId: prazo.id,
                            acao: 'ver_prazo'
                        });
                    }
                }
                } catch (error) {
                    console.warn('Erro ao processar prazo:', prazo.id, error);
                }
            });
        }

        function criarNotificacao(dados) {
            // Verificar se j√° existe uma notifica√ß√£o similar n√£o lida
            const notificacaoExistente = notificacoes.find(n => 
                n.tipo === dados.tipo && 
                n.referenciaId === dados.referenciaId && 
                !n.lida &&
                n.titulo === dados.titulo
            );

            if (notificacaoExistente) {
                // Se j√° existe, apenas atualizar a data e mostrar lembrete visual
                notificacaoExistente.dataCriacao = new Date().toISOString();
                salvarDados('notificacoes', notificacoes);
                mostrarLembreteNotificacao(dados.titulo);
                return;
            }

            const notificacao = {
                id: Date.now(),
                tipo: dados.tipo,
                titulo: dados.titulo,
                mensagem: dados.mensagem,
                prioridade: dados.prioridade,
                referenciaId: dados.referenciaId,
                acao: dados.acao,
                destinatarioId: dados.destinatarioId || 'todos',
                origem: dados.origem || 'sistema',
                lida: false,
                dataCriacao: new Date().toISOString()
            };

            notificacoes.unshift(notificacao);
            salvarDados('notificacoes', notificacoes);
            
            // Mostrar notifica√ß√£o visual
            mostrarNotificacao(notificacao.titulo, 'warning');
        }

        function mostrarLembreteNotificacao(titulo) {
            // Criar lembrete visual no canto superior direito
            const lembrete = document.createElement('div');
            lembrete.className = 'fixed top-4 right-4 bg-orange-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center space-x-2 animate-pulse';
            lembrete.innerHTML = `
                <i data-lucide="bell" class="w-4 h-4"></i>
                <span>Lembrete: ${titulo}</span>
            `;
            
            document.body.appendChild(lembrete);
            lucide.createIcons();
            
            // Remover ap√≥s 3 segundos
            setTimeout(() => {
                if (lembrete.parentNode) {
                    lembrete.parentNode.removeChild(lembrete);
                }
            }, 3000);
        }

        // === SISTEMA DE TESTE DE NOTIFICA√á√ïES ===
        
        function criarNotificacaoTeste() {
            const tipos = ['prazo', 'honorario', 'contrato', 'heranca', 'migracao', 'registo'];
            const titulos = [
                'Prazo Vencido',
                'Honor√°rio Vencido', 
                'Contrato Pendente',
                'Heran√ßa em Andamento',
                'Migra√ß√£o Urgente',
                'Registo Pendente'
            ];
            const mensagens = [
                'O prazo para entrega de documentos vence hoje!',
                'O honor√°rio de ‚Ç¨500 est√° vencido h√° 3 dias',
                'O contrato precisa ser assinado at√© amanh√£',
                'A heran√ßa est√° aguardando documenta√ß√£o',
                'O processo de migra√ß√£o est√° atrasado',
                'O registo precisa ser finalizado esta semana'
            ];
            
            const tipoAleatorio = tipos[Math.floor(Math.random() * tipos.length)];
            const tituloAleatorio = titulos[Math.floor(Math.random() * titulos.length)];
            const mensagemAleatoria = mensagens[Math.floor(Math.random() * mensagens.length)];
            
            criarNotificacao({
                tipo: tipoAleatorio,
                titulo: tituloAleatorio,
                mensagem: mensagemAleatoria,
                prioridade: 'alta',
                referenciaId: Date.now(),
                acao: 'ver_detalhes'
            });
            
            mostrarNotificacao('Notifica√ß√£o de teste criada!', 'success');
        }
        
        function criarNotificacaoPersonalizada() {
            console.log('üîß criarNotificacaoPersonalizada chamado');
            
            const modalContainer = document.getElementById('modalContainer');
            if (!modalContainer) {
                console.error('‚ùå modalContainer n√£o encontrado!');
                mostrarNotificacao('Erro: Container do modal n√£o encontrado!', 'error');
                return;
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Criar Notifica√ß√£o Personalizada</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form id="formNotificacaoPersonalizada" onsubmit="salvarNotificacaoPersonalizada(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo *</label>
                                        <input type="text" id="notificacaoTitulo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite o t√≠tulo da notifica√ß√£o">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem *</label>
                                        <textarea id="notificacaoMensagem" rows="4" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite a mensagem da notifica√ß√£o"></textarea>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="notificacaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="prazo">Prazo</option>
                                            <option value="honorario">Honor√°rio</option>
                                            <option value="contrato">Contrato</option>
                                            <option value="heranca">Heran√ßa</option>
                                            <option value="migracao">Migra√ß√£o</option>
                                            <option value="registo">Registo</option>
                                            <option value="geral">Geral</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                        <select id="notificacaoPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="baixa">Baixa</option>
                                            <option value="media" selected>M√©dia</option>
                                            <option value="alta">Alta</option>
                                            <option value="urgente">Urgente</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i data-lucide="check" class="w-4 h-4"></i>
                                        Criar Notifica√ß√£o
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            modalContainer.innerHTML = modal;
            lucide.createIcons();
            console.log('‚úÖ Modal de notifica√ß√£o personalizada aberto!');
        }
        
        function salvarNotificacaoPersonalizada(event) {
            console.log('üîß salvarNotificacaoPersonalizada chamado');
            event.preventDefault();
            event.stopPropagation();
            
            const titulo = document.getElementById('notificacaoTitulo').value.trim();
            const mensagem = document.getElementById('notificacaoMensagem').value.trim();
            const tipo = document.getElementById('notificacaoTipo').value;
            const prioridade = document.getElementById('notificacaoPrioridade').value;
            
            if (!titulo || !mensagem || !tipo) {
                mostrarNotificacao('Por favor, preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }
            
            // Carregar notifica√ß√µes do localStorage
            const notificacoesSalvas = localStorage.getItem('notificacoes');
            let notificacoesAtual = notificacoes;
            if (notificacoesSalvas) {
                notificacoesAtual = JSON.parse(notificacoesSalvas);
                notificacoes = notificacoesAtual;
                window.notificacoes = notificacoes;
            }
            
            criarNotificacao({
                tipo: tipo,
                titulo: titulo,
                mensagem: mensagem,
                prioridade: prioridade || 'media',
                referenciaId: Date.now(),
                acao: 'ver_detalhes'
            });
            
            fecharModalRobusto();
            mostrarNotificacao('Notifica√ß√£o personalizada criada com sucesso!', 'success');
            
            // Recarregar se√ß√£o de notifica√ß√µes ap√≥s um pequeno delay
            setTimeout(() => {
                carregarSecao('notificacoes');
            }, 300);
        }
        
        // Garantir que as fun√ß√µes sejam globalmente acess√≠veis
        window.salvarNotificacaoPersonalizada = salvarNotificacaoPersonalizada;
        window.criarNotificacaoPersonalizada = criarNotificacaoPersonalizada;

        function atualizarBadgeNotificacoes() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const convidadoId = localStorage.getItem('convidadoId');
            
            // Filtrar notifica√ß√µes baseado no tipo de usu√°rio (igual ao gerarNotificacoes)
            let notificacoesFiltradas = notificacoes;
            
            if (tipoUsuario === 'convidado') {
                notificacoesFiltradas = notificacoes.filter(n => 
                    n.destinatarioId === parseInt(convidadoId) || 
                    n.destinatarioId === 'todos' ||
                    n.tipo === 'cliente_autorizado' ||
                    n.tipo === 'documento_anexado' ||
                    n.tipo === 'prazo_proximo'
                );
            }
            
            const notificacoesNaoLidas = notificacoesFiltradas.filter(n => !n.lida).length;
            const badge = document.getElementById('badgeNotificacoes');
            
            if (badge) {
                if (notificacoesNaoLidas > 0) {
                    badge.textContent = notificacoesNaoLidas;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        function marcarComoLida(notificacaoId) {
            const notificacao = notificacoes.find(n => n.id === notificacaoId);
            if (notificacao) {
                notificacao.lida = true;
                salvarDados('notificacoes', notificacoes);
                carregarSecao('notificacoes');
                atualizarBadgeNotificacoes();
            }
        }

        function marcarTodasComoLidas() {
            notificacoes.forEach(n => n.lida = true);
            salvarDados('notificacoes', notificacoes);
            carregarSecao('notificacoes');
            atualizarBadgeNotificacoes();
            mostrarNotificacao('Todas as notifica√ß√µes foram marcadas como lidas', 'success');
        }

        function excluirNotificacao(notificacaoId) {
            notificacoes = notificacoes.filter(n => n.id !== notificacaoId);
            salvarDados('notificacoes', notificacoes);
            carregarSecao('notificacoes');
            atualizarBadgeNotificacoes();
        }

        function limparNotificacoes() {
            if (confirm('Tem certeza que deseja limpar todas as notifica√ß√µes?')) {
                notificacoes = [];
                salvarDados('notificacoes', notificacoes);
                carregarSecao('notificacoes');
                atualizarBadgeNotificacoes();
                mostrarNotificacao('Todas as notifica√ß√µes foram removidas', 'success');
            }
        }

        // === SISTEMA H√çBRIDO DE NOTIFICA√á√ïES ===
        
        function enviarMensagemConvidado() {
            console.log('üîß enviarMensagemConvidado chamado');
            
            const convidados = obterConvidados();
            console.log('üîß Total de convidados:', convidados.length);
            console.log('üîß Convidados:', convidados);
            
            const convidadosAtivos = convidados.filter(c => c.ativo);
            console.log('üîß Convidados ativos:', convidadosAtivos.length);
            console.log('üîß Convidados ativos:', convidadosAtivos);
            
            if (convidadosAtivos.length === 0) {
                console.warn('‚ö†Ô∏è Nenhum convidado ativo encontrado!');
                mostrarNotificacao('Nenhum convidado ativo encontrado! Crie um convidado na se√ß√£o "Gest√£o de Convidados" primeiro.', 'warning');
                // N√£o retornar - permitir abrir modal mesmo sem convidados para mostrar mensagem mais clara
            }
            
            const modalContainer = document.getElementById('modalContainer');
            if (!modalContainer) {
                console.error('‚ùå modalContainer n√£o encontrado!');
                mostrarNotificacao('Erro: Container do modal n√£o encontrado!', 'error');
                return;
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Enviar Mensagem para Convidado</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form id="formEnviarMensagemConvidado" onsubmit="salvarMensagemConvidado(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Destinat√°rio *</label>
                                        ${convidadosAtivos.length === 0 ? `
                                            <div class="bg-yellow-50 border border-yellow-200 rounded px-4 py-3 mb-3">
                                                <p class="text-sm text-yellow-800">
                                                    <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-2"></i>
                                                    Nenhum convidado ativo encontrado. V√° para "Gest√£o de Convidados" para criar um convidado primeiro.
                                                </p>
                                            </div>
                                            <select id="convidadoDestinatario" required disabled class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black bg-gray-100">
                                                <option value="">Nenhum convidado dispon√≠vel</option>
                                            </select>
                                        ` : `
                                            <select id="convidadoDestinatario" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="">Selecione um convidado</option>
                                                ${convidadosAtivos.map(c => `
                                                    <option value="${c.id}">${c.nome} ${c.email ? '(' + c.email + ')' : ''}</option>
                                                `).join('')}
                                                ${convidadosAtivos.length > 1 ? '<option value="todos">Todos os Convidados</option>' : ''}
                                            </select>
                                        `}
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo *</label>
                                        <input type="text" id="mensagemTitulo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="T√≠tulo da mensagem">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem *</label>
                                        <textarea id="mensagemConteudo" rows="4" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite sua mensagem..."></textarea>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                        <select id="mensagemPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="baixa">Baixa</option>
                                            <option value="media" selected>M√©dia</option>
                                            <option value="alta">Alta</option>
                                            <option value="urgente">Urgente</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary" ${convidadosAtivos.length === 0 ? 'disabled' : ''}>
                                        <i data-lucide="send" class="w-4 h-4"></i>
                                        ${convidadosAtivos.length === 0 ? 'Nenhum Convidado Dispon√≠vel' : 'Enviar Mensagem'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            modalContainer.innerHTML = modal;
            lucide.createIcons();
            console.log('‚úÖ Modal de enviar mensagem para convidado aberto!');
        }
        
        function salvarMensagemConvidado(event) {
            console.log('üîß salvarMensagemConvidado chamado');
            event.preventDefault();
            event.stopPropagation();
            
            // Verificar se h√° convidados ativos
            const convidados = obterConvidados();
            const convidadosAtivos = convidados.filter(c => c.ativo);
            
            if (convidadosAtivos.length === 0) {
                mostrarNotificacao('Nenhum convidado ativo encontrado! Crie um convidado na se√ß√£o "Gest√£o de Convidados" primeiro.', 'error');
                return;
            }
            
            const destinatarioId = document.getElementById('convidadoDestinatario').value;
            const titulo = document.getElementById('mensagemTitulo').value.trim();
            const conteudo = document.getElementById('mensagemConteudo').value.trim();
            const prioridade = document.getElementById('mensagemPrioridade').value;
            
            if (!destinatarioId || !titulo || !conteudo) {
                mostrarNotificacao('Por favor, preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }
            
            // Carregar notifica√ß√µes do localStorage
            const notificacoesSalvas = localStorage.getItem('notificacoes');
            let notificacoesAtual = notificacoes;
            if (notificacoesSalvas) {
                notificacoesAtual = JSON.parse(notificacoesSalvas);
                notificacoes = notificacoesAtual;
                window.notificacoes = notificacoes;
            }
            
            const notificacao = {
                id: Date.now(),
                tipo: 'mensagem_admin',
                titulo: titulo,
                mensagem: conteudo,
                prioridade: prioridade || 'media',
                destinatarioId: destinatarioId === 'todos' ? 'todos' : parseInt(destinatarioId),
                lida: false,
                dataCriacao: new Date().toISOString(),
                origem: 'admin'
            };
            
            notificacoesAtual.unshift(notificacao);
            notificacoes = notificacoesAtual;
            window.notificacoes = notificacoes;
            
            console.log('üîß Notifica√ß√£o criada:', notificacao);
            salvarDados('notificacoes', notificacoesAtual);
            
            mostrarNotificacao('Mensagem enviada com sucesso!', 'success');
            fecharModalRobusto();
            
            setTimeout(() => {
                carregarSecao('notificacoes');
            }, 300);
        }
        
        // Garantir que as fun√ß√µes sejam globalmente acess√≠veis
        window.enviarMensagemConvidado = enviarMensagemConvidado;
        window.salvarMensagemConvidado = salvarMensagemConvidado;
        // Alias para compatibilidade
        window.enviarMensagemConfirmar = salvarMensagemConvidado;

        // === FILTROS INTELIGENTES DE NOTIFICA√á√ïES ===
        
        function aplicarFiltrosNotificacoes() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const convidadoId = localStorage.getItem('convidadoId');
            
            // Obter filtros
            const filtroPrioridade = document.getElementById('filtroPrioridade')?.value || '';
            const filtroTipo = document.getElementById('filtroTipo')?.value || '';
            const filtroStatus = document.getElementById('filtroStatus')?.value || '';
            const filtroPeriodo = document.getElementById('filtroPeriodo')?.value || '';
            
            // Filtrar notifica√ß√µes baseado no tipo de usu√°rio
            let notificacoesFiltradas = notificacoes;
            
            if (tipoUsuario === 'convidado') {
                notificacoesFiltradas = notificacoes.filter(n => 
                    n.destinatarioId === parseInt(convidadoId) || 
                    n.destinatarioId === 'todos' ||
                    n.tipo === 'cliente_autorizado' ||
                    n.tipo === 'documento_anexado' ||
                    n.tipo === 'prazo_proximo'
                );
            }
            
            // Aplicar filtros adicionais
            if (filtroPrioridade) {
                notificacoesFiltradas = notificacoesFiltradas.filter(n => n.prioridade === filtroPrioridade);
            }
            
            if (filtroTipo) {
                notificacoesFiltradas = notificacoesFiltradas.filter(n => n.tipo === filtroTipo);
            }
            
            if (filtroStatus === 'nao_lida') {
                notificacoesFiltradas = notificacoesFiltradas.filter(n => !n.lida);
            } else if (filtroStatus === 'lida') {
                notificacoesFiltradas = notificacoesFiltradas.filter(n => n.lida);
            }
            
            if (filtroPeriodo) {
                const agora = new Date();
                const hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
                const inicioSemana = new Date(hoje);
                inicioSemana.setDate(hoje.getDate() - hoje.getDay());
                const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);
                
                notificacoesFiltradas = notificacoesFiltradas.filter(n => {
                    if (!n.dataCriacao) return false;
                    const dataNotificacao = new Date(n.dataCriacao);
                    
                    switch (filtroPeriodo) {
                        case 'hoje':
                            return dataNotificacao >= hoje;
                        case 'semana':
                            return dataNotificacao >= inicioSemana;
                        case 'mes':
                            return dataNotificacao >= inicioMes;
                        default:
                            return true;
                    }
                });
            }
            
            // Atualizar contador
            const contador = document.getElementById('contadorFiltros');
            if (contador) {
                contador.textContent = `${notificacoesFiltradas.length} notifica√ß√µes encontradas`;
            }
            
            // Recarregar se√ß√£o com filtros aplicados
            carregarSecao('notificacoes');
        }
        
        function limparFiltrosNotificacoes() {
            document.getElementById('filtroPrioridade').value = '';
            document.getElementById('filtroTipo').value = '';
            document.getElementById('filtroStatus').value = '';
            document.getElementById('filtroPeriodo').value = '';
            
            carregarSecao('notificacoes');
        }

        // === SISTEMA DE COMUNICA√á√ÉO BIDIRECIONAL ===
        
        function responderMensagem(notificacaoId) {
            const notificacao = notificacoes.find(n => n.id === notificacaoId);
            if (!notificacao) {
                mostrarNotificacao('Notifica√ß√£o n√£o encontrada!', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <h3 class="text-lg font-semibold mb-4">Responder Mensagem</h3>
                    
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-800">${notificacao.titulo}</h4>
                        <p class="text-sm text-gray-600 mt-1">${notificacao.mensagem}</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sua Resposta</label>
                            <textarea id="respostaMensagem" rows="4" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite sua resposta..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="fecharModalRobusto()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button onclick="enviarResposta(${notificacaoId})" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Enviar Resposta
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function enviarResposta(notificacaoId) {
            const resposta = document.getElementById('respostaMensagem').value;
            
            if (!resposta.trim()) {
                mostrarNotificacao('Digite uma resposta!', 'error');
                return;
            }
            
            const notificacao = notificacoes.find(n => n.id === notificacaoId);
            if (notificacao) {
                // Inicializar array de respostas se n√£o existir
                if (!notificacao.respostas) {
                    notificacao.respostas = [];
                }
                
                // Adicionar resposta
                const novaResposta = {
                    id: Date.now(),
                    mensagem: resposta,
                    origem: 'convidado',
                    dataCriacao: new Date().toISOString(),
                    convidadoId: localStorage.getItem('convidadoId')
                };
                
                notificacao.respostas.push(novaResposta);
                
                // Salvar dados
                salvarDados('notificacoes', notificacoes);
                
                // Criar notifica√ß√£o para o admin sobre a resposta
                const notificacaoAdmin = {
                    id: Date.now(),
                    tipo: 'resposta_convidado',
                    titulo: 'Resposta Recebida',
                    mensagem: `Convidado respondeu: "${resposta.substring(0, 50)}${resposta.length > 50 ? '...' : ''}"`,
                    prioridade: 'media',
                    destinatarioId: 'admin',
                    referenciaId: notificacaoId,
                    lida: false,
                    dataCriacao: new Date().toISOString(),
                    origem: 'sistema'
                };
                
                notificacoes.unshift(notificacaoAdmin);
                salvarDados('notificacoes', notificacoes);
                
                mostrarNotificacao('Resposta enviada com sucesso!', 'success');
                fecharModal();
                carregarSecao('notificacoes');
            }
        }

        // === VISUALIZA√á√ÉO DE CONVERSAS PARA ADMIN ===
        
        function verConversas() {
            // Filtrar notifica√ß√µes que t√™m respostas
            const conversas = notificacoes.filter(n => 
                n.respostas && n.respostas.length > 0 && 
                (n.origem === 'admin' || n.tipo === 'mensagem_admin')
            );
            
            if (conversas.length === 0) {
                mostrarNotificacao('Nenhuma conversa encontrada!', 'info');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold">Conversas com Convidados</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        ${conversas.map(conversa => `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-start justify-between mb-3">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">${conversa.titulo}</h4>
                                        <p class="text-sm text-gray-600">${conversa.mensagem}</p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            ${new Date(conversa.dataCriacao).toLocaleString('pt-PT')}
                                        </p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
                                            ${conversa.respostas.length} resposta${conversa.respostas.length > 1 ? 's' : ''}
                                        </span>
                                        <button onclick="responderComoAdmin(${conversa.id})" class="btn btn-sm btn-primary">
                                            <i data-lucide="reply" class="w-4 h-4"></i>
                                            Responder
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="space-y-2">
                                    ${conversa.respostas.map(resposta => `
                                        <div class="bg-gray-50 p-3 rounded-lg">
                                            <div class="flex items-center justify-between mb-1">
                                                <span class="text-sm font-medium text-gray-600">
                                                    ${resposta.origem === 'admin' ? 'Admin' : 'Convidado'}
                                                </span>
                                                <span class="text-xs text-gray-400">
                                                    ${new Date(resposta.dataCriacao).toLocaleString('pt-PT')}
                                                </span>
                                            </div>
                                            <p class="text-sm text-gray-800">${resposta.mensagem}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function responderComoAdmin(notificacaoId) {
            const notificacao = notificacoes.find(n => n.id === notificacaoId);
            if (!notificacao) {
                mostrarNotificacao('Notifica√ß√£o n√£o encontrada!', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <h3 class="text-lg font-semibold mb-4">Responder como Admin</h3>
                    
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-800">${notificacao.titulo}</h4>
                        <p class="text-sm text-gray-600 mt-1">${notificacao.mensagem}</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sua Resposta</label>
                            <textarea id="respostaAdmin" rows="4" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite sua resposta..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="fecharModalRobusto()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button onclick="enviarRespostaAdmin(${notificacaoId})" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Enviar Resposta
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function enviarRespostaAdmin(notificacaoId) {
            const resposta = document.getElementById('respostaAdmin').value;
            
            if (!resposta.trim()) {
                mostrarNotificacao('Digite uma resposta!', 'error');
                return;
            }
            
            const notificacao = notificacoes.find(n => n.id === notificacaoId);
            if (notificacao) {
                // Inicializar array de respostas se n√£o existir
                if (!notificacao.respostas) {
                    notificacao.respostas = [];
                }
                
                // Adicionar resposta do admin
                const novaResposta = {
                    id: Date.now(),
                    mensagem: resposta,
                    origem: 'admin',
                    dataCriacao: new Date().toISOString()
                };
                
                notificacao.respostas.push(novaResposta);
                
                // Salvar dados
                salvarDados('notificacoes', notificacoes);
                
                mostrarNotificacao('Resposta enviada com sucesso!', 'success');
                fecharModal();
                carregarSecao('notificacoes');
            }
        }

        function filtrarPrazos() {
            const busca = document.getElementById('buscaPrazos')?.value.toLowerCase() || '';
            
            const prazosFiltrados = prazos.filter(prazo => {
                return prazo.clienteNome.toLowerCase().includes(busca) || 
                       prazo.tipo.toLowerCase().includes(busca) ||
                       prazo.descricao.toLowerCase().includes(busca);
            });
            
            atualizarListaPrazos(prazosFiltrados);
        }

        function atualizarListaPrazos(prazosFiltrados) {
            const tbody = document.getElementById('listaPrazos');
            if (!tbody) return;
            
            tbody.innerHTML = prazosFiltrados.map(prazo => `
                <tr>
                    <td>${prazo.clienteNome}</td>
                    <td>${prazo.tipo}</td>
                    <td>${prazo.descricao}</td>
                    <td>${prazo.dataLimite ? new Date(prazo.dataLimite).toLocaleDateString('pt-PT') : 'Data n√£o definida'}</td>
                    <td><span class="status-badge status-${prazo.prioridade}">${prazo.prioridade}</span></td>
                    <td><span class="status-badge status-${prazo.status}">${prazo.status}</span></td>
                    <td>
                        <button onclick="editarItem('prazo', ${prazo.id})" class="text-blue-600 hover:text-blue-800">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirItem('prazo', ${prazo.id})" class="text-red-600 hover:text-red-800 ml-2">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Sistema de inicializa√ß√£o movido para dentro da verifica√ß√£o de login

        // === FUN√á√ïES DAS NOVAS SE√á√ïES ===

        function gerarHerancas() {
            const totalHerancas = herancas.length;
            const herancasAtivas = herancas.filter(h => h.status === 'em_andamento').length;
            const herancasSuspensas = herancas.filter(h => h.status === 'pendente').length;
            const herancasTerminadas = herancas.filter(h => h.status === 'concluido').length;
            const valorTotalHerancas = herancas.reduce((total, h) => total + (h.valorComIva || h.valor || 0), 0);

            return `
                <div class="space-y-6">
                    <!-- Header √∫nico com bot√µes de a√ß√£o -->
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-3">
                            <button onclick="abrirModalHeranca()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Nova Heran√ßa
                            </button>
                        </div>
                    </div>

                    <!-- Estat√≠sticas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${herancasAtivas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Suspensos</p>
                                    <p class="text-2xl font-bold text-gray-900">${herancasSuspensas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Terminados</p>
                                    <p class="text-2xl font-bold text-gray-900">${herancasTerminadas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${Number(valorTotalHerancas).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de busca -->
                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaHerancas" placeholder="Buscar heran√ßas..." 
                                   class="search-input" onkeyup="filtrarHerancas()">
                        </div>
                        
                        <!-- Filtros Avan√ßados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusHeranca" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHerancas()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Conclu√≠do</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="filtroTipoHeranca" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHerancas()">
                                    <option value="">Todos os tipos</option>
                                    <option value="Aceita√ß√£o da heran√ßa">Aceita√ß√£o da heran√ßa</option>
                                    <option value="Doa√ß√µes">Doa√ß√µes</option>
                                    <option value="Escrituras de partilha">Escrituras de partilha</option>
                                    <option value="Habilita√ß√£o de herdeiros">Habilita√ß√£o de herdeiros</option>
                                    <option value="Partilhas em vida">Partilhas em vida</option>
                                    <option value="Partilhas por √≥bito">Partilhas por √≥bito</option>
                                    <option value="Processo de invent√°rio">Processo de invent√°rio</option>
                                    <option value="Ren√∫ncia √† heran√ßa">Ren√∫ncia √† heran√ßa</option>
                                    <option value="Testamentos">Testamentos</option>
                                </select>
                            </div>
                            
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIF</label>
                                <input type="text" id="filtroNifHeranca" placeholder="Buscar por NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHerancas()">
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosHerancas()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorHerancas">0</span> heran√ßas encontradas
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="overflow-x-auto table-responsive">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Descri√ß√£o</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Data In√≠cio</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                    </tr>
                                </thead>
                <tbody id="listaHerancas" class="bg-white divide-y divide-gray-200">
                    <!-- Lista din√¢mica de heran√ßas -->
                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarConvidados() {
            const convidados = obterConvidados();
            const convidadosAtivos = convidados.filter(c => c.ativo).length;
            const convidadosInativos = convidados.filter(c => !c.ativo).length;
            const totalConvidados = convidados.length;

            return `
                <div class="space-y-6">
                    <!-- Header com bot√µes de a√ß√£o -->
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-3">
                            <button onclick="abrirModalNovoConvidado()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
                                Novo Convidado
                            </button>
                        </div>
                    </div>

                    <!-- Estat√≠sticas -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalConvidados}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${convidadosAtivos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="user-x" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Inativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${convidadosInativos}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Convidados -->
                    <div class="card">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Lista de Convidados</h3>
                            
                            <div class="table-responsive">
                                <table class="w-full">
                                    <thead>
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√≥digo</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clientes Autorizados</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Cria√ß√£o</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaConvidados">
                                        ${convidados.map(convidado => `
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${convidado.nome}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${convidado.codigo}</td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="status-badge status-${convidado.ativo ? 'ativo' : 'inativo'}">${convidado.ativo ? 'Ativo' : 'Inativo'}</span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${convidado.clientesAutorizados.length} cliente(s)</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(convidado.dataCriacao).toLocaleDateString('pt-PT')}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                    <button onclick="abrirModalEditarPermissoes(${convidado.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar Permiss√µes">
                                                        <i data-lucide="settings" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="ativarDesativarConvidado(${convidado.id}, ${!convidado.ativo})" class="text-${convidado.ativo ? 'red' : 'green'}-600 hover:text-${convidado.ativo ? 'red' : 'green'}-900 mr-2" title="${convidado.ativo ? 'Desativar' : 'Ativar'}">
                                                        <i data-lucide="${convidado.ativo ? 'user-x' : 'user-check'}" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="copiarCodigoConvidado('${convidado.codigo}')" class="text-gray-600 hover:text-gray-900" title="Copiar C√≥digo">
                                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // FUN√á√ïES AUXILIARES PARA GEST√ÉO DE CONVIDADOS
        function abrirModalNovoConvidado() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">Novo Convidado</h3>
                            <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formNovoConvidado" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Convidado</label>
                                <input type="text" id="nomeConvidado" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite o nome" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Clientes Autorizados</label>
                                <div id="listaClientesConvidado" class="space-y-2 max-h-40 overflow-y-auto">
                                    <!-- Lista de clientes ser√° carregada aqui -->
                                </div>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button type="button" onclick="fecharModalRobusto()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                                    Cancelar
                                </button>
                                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                    Criar Convidado
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Carregar lista de clientes
            carregarClientesParaConvidado();
            
            document.getElementById('formNovoConvidado').addEventListener('submit', function(e) {
                e.preventDefault();
                const nome = document.getElementById('nomeConvidado').value;
                const clientesSelecionados = Array.from(document.querySelectorAll('#listaClientesConvidado input[type="checkbox"]:checked'))
                    .map(cb => parseInt(cb.value));
                
                const novoConvidado = criarConvidado(nome, clientesSelecionados);
                mostrarNotificacao(`Convidado criado! C√≥digo: ${novoConvidado.codigo}`, 'success');
                fecharModal();
                carregarSecao('convidados');
            });
        }
        
        function carregarClientesParaConvidado() {
            const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
            const container = document.getElementById('listaClientesConvidado');
            
            if (clientes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum cliente cadastrado</p>';
                return;
            }
            
            container.innerHTML = clientes.map(cliente => `
                <label class="flex items-center space-x-2">
                    <input type="checkbox" value="${cliente.id}" class="rounded border-gray-300">
                    <span class="text-sm text-gray-700">${cliente.nome}</span>
                </label>
            `).join('');
        }
        
        function abrirModalEditarPermissoes(id) {
            const convidados = obterConvidados();
            const convidado = convidados.find(c => c.id === id);
            
            if (!convidado) {
                mostrarNotificacao('Convidado n√£o encontrado!', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">Editar Permiss√µes - ${convidado.nome}</h3>
                            <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formEditarPermissoes" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Clientes Autorizados</label>
                                <div id="listaClientesEdicao" class="space-y-2 max-h-40 overflow-y-auto">
                                    <!-- Lista de clientes ser√° carregada aqui -->
                                </div>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button type="button" onclick="fecharModalRobusto()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                                    Cancelar
                                </button>
                                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                    Salvar Permiss√µes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Carregar lista de clientes com sele√ß√µes atuais
            carregarClientesParaEdicao(convidado.clientesAutorizados);
            
            document.getElementById('formEditarPermissoes').addEventListener('submit', function(e) {
                e.preventDefault();
                const clientesSelecionados = Array.from(document.querySelectorAll('#listaClientesEdicao input[type="checkbox"]:checked'))
                    .map(cb => parseInt(cb.value));
                
                console.log('üîß Formul√°rio submetido, clientes selecionados:', clientesSelecionados);
                console.log('üîß ID do convidado:', id);
                console.log('üîß Chamando editarPermissoesConvidado...');
                
                editarPermissoesConvidado(id, clientesSelecionados);
                console.log('üîß editarPermissoesConvidado chamado com sucesso');
                mostrarNotificacao('Permiss√µes atualizadas com sucesso!', 'success');
                fecharModal();
            });
        }
        
        function carregarClientesParaEdicao(clientesAutorizados) {
            const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
            const container = document.getElementById('listaClientesEdicao');
            
            if (clientes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum cliente cadastrado</p>';
                return;
            }
            
            container.innerHTML = clientes.map(cliente => `
                <label class="flex items-center space-x-2">
                    <input type="checkbox" value="${cliente.id}" ${clientesAutorizados.includes(cliente.id) ? 'checked' : ''} class="rounded border-gray-300">
                    <span class="text-sm text-gray-700">${cliente.nome}</span>
                </label>
            `).join('');
        }
        
        function ativarDesativarConvidado(id, ativo) {
            ativarDesativarConvidado(id, ativo);
            mostrarNotificacao(`Convidado ${ativo ? 'ativado' : 'desativado'} com sucesso!`, 'success');
            carregarSecao('convidados');
        }
        
        function copiarCodigoConvidado(codigo) {
            navigator.clipboard.writeText(codigo).then(() => {
                mostrarNotificacao('C√≥digo copiado para a √°rea de transfer√™ncia!', 'success');
            }).catch(() => {
                // Fallback para navegadores mais antigos
                const textArea = document.createElement('textarea');
                textArea.value = codigo;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                mostrarNotificacao('C√≥digo copiado para a √°rea de transfer√™ncia!', 'success');
            });
        }

        function gerarMigracao() {
            console.log('üîß gerarMigracao chamado');
            
            // Garantir que migracoes existe
            if (!migracoes) {
                migracoes = [];
            }
            
            const totalMigracoes = migracoes.length;
            const migracoesAtivas = migracoes.filter(m => m.status === 'em_andamento').length;
            const migracoesSuspensas = migracoes.filter(m => m.status === 'pendente').length;
            const migracoesTerminadas = migracoes.filter(m => m.status === 'concluido').length;
            const valorTotalMigracoes = migracoes.reduce((total, m) => {
                const valor = parseFloat(m.valor) || 0;
                return total + valor;
            }, 0);

            return `
                <div class="space-y-6">
                    <!-- Header √∫nico com bot√µes de a√ß√£o -->
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-3">
                            <button onclick="abrirModalMigracaoDireto()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Nova Migra√ß√£o
                            </button>
                        </div>
                    </div>

                    <!-- Estat√≠sticas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${migracoesAtivas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Suspensos</p>
                                    <p class="text-2xl font-bold text-gray-900">${migracoesSuspensas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Terminados</p>
                                    <p class="text-2xl font-bold text-gray-900">${migracoesTerminadas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${Number(valorTotalMigracoes).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de busca -->
                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaMigracoes" placeholder="Buscar migra√ß√µes..." 
                                   class="search-input" onkeyup="filtrarMigracoes()">
                        </div>
                        
                        <!-- Filtros Avan√ßados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusMigracao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosMigracoes()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Conclu√≠do</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="filtroTipoMigracao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosMigracoes()">
                                    <option value="">Todos os tipos</option>
                                    <option value="Autoriza√ß√£o de resid√™ncia">Autoriza√ß√£o de resid√™ncia</option>
                                    <option value="Certificados de resid√™ncia permanente">Certificados de resid√™ncia permanente</option>
                                    <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                    <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                    <option value="Renova√ß√£o de autoriza√ß√µes">Renova√ß√£o de autoriza√ß√µes</option>
                                    <option value="Vistos D7">Vistos D7</option>
                                    <option value="Vistos Gold">Vistos Gold</option>
                                    <option value="Vistos para estudantes">Vistos para estudantes</option>
                                    <option value="Vistos para trabalho">Vistos para trabalho</option>
                                </select>
                            </div>
                            
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIF</label>
                                <input type="text" id="filtroNifMigracao" placeholder="Buscar por NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosMigracoes()">
                                <!-- Campo NIF adicionado -->
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosMigracoes()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorMigracoes">0</span> migra√ß√µes encontradas
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="overflow-x-auto table-responsive">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Descri√ß√£o</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Data In√≠cio</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="listaMigracoes" class="bg-white divide-y divide-gray-200">
                                    ${migracoes.map(migracao => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${migracao.clienteNome || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.tipo || 'N/A'}</td>
                                            <td class="px-6 py-4 text-sm text-gray-500">${migracao.descricao || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <div class="text-sm font-bold text-black">‚Ç¨${(migracao.valor || 0).toFixed(2)}</div>
                                                <div class="text-xs font-bold text-red-600">+ IVA: ‚Ç¨${((migracao.valor || 0) + ((migracao.valor || 0) * (migracao.iva || 0) / 100)).toFixed(2)}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="status-badge status-${migracao.status}">${migracao.status === 'concluido' ? 'Conclu√≠do' : migracao.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.dataInicio ? new Date(migracao.dataInicio).toLocaleDateString('pt-PT') : 'Data n√£o definida'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button onclick="console.log('üîß Bot√£o editar clicado para ID:', ${migracao.id}); editarMigracaoDireto(${migracao.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar">
                                                    <i data-lucide="edit" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="abrirAnexosMigracao(${migracao.id})" class="text-green-600 hover:text-green-900 mr-2" title="Documentos">
                                                    <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="console.log('üîß Bot√£o excluir clicado para ID:', ${migracao.id}); excluirMigracaoDireto(${migracao.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarRegistos() {
            const totalRegistos = registos.length;
            const registosAtivos = registos.filter(r => r.status === 'em_andamento').length;
            const registosSuspensos = registos.filter(r => r.status === 'pendente').length;
            const registosTerminados = registos.filter(r => r.status === 'concluido').length;
            const valorTotalRegistos = registos.reduce((total, r) => total + (r.valorComIva || r.valor || 0), 0);

            return `
                <div class="space-y-6">
                    <!-- Header √∫nico com bot√µes de a√ß√£o -->
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-3">
                            <button onclick="abrirModalRegisto()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Novo Registo
                            </button>
                        </div>
                    </div>

                    <!-- Estat√≠sticas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${registosAtivos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Suspensos</p>
                                    <p class="text-2xl font-bold text-gray-900">${registosSuspensos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Terminados</p>
                                    <p class="text-2xl font-bold text-gray-900">${registosTerminados}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${Number(valorTotalRegistos).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de busca -->
                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaRegistos" placeholder="Buscar registos..." 
                                   class="search-input" onkeyup="filtrarRegistos()">
                        </div>
                        
                        <!-- Filtros Avan√ßados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusRegisto" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosRegistos()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Conclu√≠do</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="filtroTipoRegisto" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosRegistos()">
                                    <option value="">Todos os tipos</option>
                                    <option value="Autentica√ß√£o de documentos">Autentica√ß√£o de documentos</option>
                                    <option value="Certifica√ß√£o de fotoc√≥pias">Certifica√ß√£o de fotoc√≥pias</option>
                                    <option value="Documentos para o estrangeiro">Documentos para o estrangeiro</option>
                                    <option value="Procura√ß√µes">Procura√ß√µes</option>
                                    <option value="Reconhecimento presencial de assinaturas">Reconhecimento presencial de assinaturas</option>
                                    <option value="Registos autom√≥veis">Registos autom√≥veis</option>
                                    <option value="Registos comerciais">Registos comerciais</option>
                                    <option value="Registos de propriedade">Registos de propriedade</option>
                                    <option value="Termos de autentica√ß√£o">Termos de autentica√ß√£o</option>
                                </select>
                            </div>
                            
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIF</label>
                                <input type="text" id="filtroNifRegisto" placeholder="Buscar por NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosRegistos()">
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosRegistos()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorRegistos">0</span> registos encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="overflow-x-auto table-responsive">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Descri√ß√£o</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Data In√≠cio</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                    </tr>
                                </thead>
                <tbody id="listaRegistos" class="bg-white divide-y divide-gray-200">
                    <!-- Conte√∫do ser√° carregado via atualizarListaRegistos() -->
                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }


        // === FUN√á√ïES DE FILTRO ===

        function filtrarHerancas() {
            aplicarFiltrosHerancas();
        }

        function aplicarFiltrosHerancas() {
            const busca = document.getElementById('buscaHerancas')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusHeranca')?.value || '';
            const tipo = document.getElementById('filtroTipoHeranca')?.value || '';
            const nif = document.getElementById('filtroNifHeranca')?.value || '';
            
            const herancasFiltradas = herancas.filter(heranca => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    heranca.clienteNome.toLowerCase().includes(busca) || 
                    heranca.tipo.toLowerCase().includes(busca) ||
                    heranca.observacoes.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || heranca.status === status;
                
                // Filtro por tipo
                const matchTipo = !tipo || heranca.tipo === tipo;
                
                
                // Filtro por NIF
                const cliente = clientes.find(c => c.id === heranca.clienteId);
                const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));
                
                return matchBusca && matchStatus && matchTipo && matchNif;
            });
            
            atualizarListaHerancas(herancasFiltradas);
            document.getElementById('contadorHerancas').textContent = herancasFiltradas.length;
        }

        function limparFiltrosHerancas() {
            document.getElementById('buscaHerancas').value = '';
            document.getElementById('filtroStatusHeranca').value = '';
            document.getElementById('filtroTipoHeranca').value = '';
            document.getElementById('filtroValorMinHeranca').value = '';
            document.getElementById('filtroValorMaxHeranca').value = '';
            document.getElementById('filtroNifHeranca').value = '';
            aplicarFiltrosHerancas();
        }

        function filtrarMigracoes() {
            aplicarFiltrosMigracoes();
        }

        function aplicarFiltrosMigracoes() {
            const busca = document.getElementById('buscaMigracoes')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusMigracao')?.value || '';
            const tipo = document.getElementById('filtroTipoMigracao')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinMigracao')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxMigracao')?.value) || Infinity;
            const nif = document.getElementById('filtroNifMigracao')?.value || '';
            
            const migracoesFiltradas = migracoes.filter(migracao => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    migracao.clienteNome.toLowerCase().includes(busca) || 
                    migracao.tipo.toLowerCase().includes(busca) ||
                    migracao.observacoes.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || migracao.status === status;
                
                // Filtro por tipo
                const matchTipo = !tipo || migracao.tipo === tipo;
                
                // Filtro por valor
                const valor = parseFloat(migracao.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                // Filtro por NIF
                const cliente = clientes.find(c => c.id === migracao.clienteId);
                const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));
                
                return matchBusca && matchStatus && matchTipo && matchValor && matchNif;
            });
            
            atualizarListaMigracoes(migracoesFiltradas);
            document.getElementById('contadorMigracoes').textContent = migracoesFiltradas.length;
        }

        function limparFiltrosMigracoes() {
            document.getElementById('buscaMigracoes').value = '';
            document.getElementById('filtroStatusMigracao').value = '';
            document.getElementById('filtroTipoMigracao').value = '';
            document.getElementById('filtroValorMinMigracao').value = '';
            document.getElementById('filtroValorMaxMigracao').value = '';
            document.getElementById('filtroNifMigracao').value = '';
            aplicarFiltrosMigracoes();
        }

        function filtrarRegistos() {
            aplicarFiltrosRegistos();
        }

        function aplicarFiltrosRegistos() {
            const busca = document.getElementById('buscaRegistos')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusRegisto')?.value || '';
            const tipo = document.getElementById('filtroTipoRegisto')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinRegisto')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxRegisto')?.value) || Infinity;
            const nif = document.getElementById('filtroNifRegisto')?.value || '';
            
            const registosFiltrados = registos.filter(registo => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    registo.clienteNome.toLowerCase().includes(busca) || 
                    registo.tipo.toLowerCase().includes(busca) ||
                    registo.observacoes.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || registo.status === status;
                
                // Filtro por tipo
                const matchTipo = !tipo || registo.tipo === tipo;
                
                // Filtro por valor
                const valor = parseFloat(registo.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                // Filtro por NIF
                const cliente = clientes.find(c => c.id === registo.clienteId);
                const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));
                
                return matchBusca && matchStatus && matchTipo && matchValor && matchNif;
            });
            
            atualizarListaRegistos(registosFiltrados);
            document.getElementById('contadorRegistos').textContent = registosFiltrados.length;
        }

        function limparFiltrosRegistos() {
            document.getElementById('buscaRegistos').value = '';
            document.getElementById('filtroStatusRegisto').value = '';
            document.getElementById('filtroTipoRegisto').value = '';
            document.getElementById('filtroValorMinRegisto').value = '';
            document.getElementById('filtroValorMaxRegisto').value = '';
            document.getElementById('filtroNifRegisto').value = '';
            aplicarFiltrosRegistos();
        }

        function filtrarPrazos() {
            aplicarFiltrosPrazos();
        }

        function aplicarFiltrosPrazos() {
            const busca = document.getElementById('buscaPrazos')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusPrazo')?.value || '';
            const tipo = document.getElementById('filtroTipoPrazo')?.value || '';
            const vencimento = document.getElementById('filtroVencimentoPrazo')?.value || '';
            const prioridade = document.getElementById('filtroPrioridadePrazo')?.value || '';
            
            const prazosFiltrados = prazos.filter(prazo => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    prazo.clienteNome.toLowerCase().includes(busca) || 
                    prazo.descricao.toLowerCase().includes(busca) ||
                    prazo.tipo.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || prazo.status === status;
                
                // Filtro por tipo
                const matchTipo = !tipo || prazo.tipo === tipo;
                
                // Filtro por vencimento
                let matchVencimento = true;
                if (vencimento && prazo.dataLimite) {
                    const dataLimite = new Date(prazo.dataLimite);
                    const hoje = new Date();
                    
                    switch (vencimento) {
                        case 'hoje':
                            matchVencimento = dataLimite.toDateString() === hoje.toDateString();
                            break;
                        case 'semana':
                            const fimSemana = new Date(hoje);
                            fimSemana.setDate(hoje.getDate() + 7);
                            matchVencimento = dataLimite >= hoje && dataLimite <= fimSemana;
                            break;
                        case 'mes':
                            const fimMes = new Date(hoje);
                            fimMes.setMonth(hoje.getMonth() + 1);
                            matchVencimento = dataLimite >= hoje && dataLimite <= fimMes;
                            break;
                        case 'vencido':
                            matchVencimento = dataLimite < hoje;
                            break;
                    }
                }
                
                // Filtro por prioridade
                const matchPrioridade = !prioridade || prazo.prioridade === prioridade;
                
                return matchBusca && matchStatus && matchTipo && matchVencimento && matchPrioridade;
            });
            
            atualizarListaPrazos(prazosFiltrados);
            document.getElementById('contadorPrazos').textContent = prazosFiltrados.length;
        }

        function limparFiltrosPrazos() {
            document.getElementById('buscaPrazos').value = '';
            document.getElementById('filtroStatusPrazo').value = '';
            document.getElementById('filtroTipoPrazo').value = '';
            document.getElementById('filtroVencimentoPrazo').value = '';
            document.getElementById('filtroPrioridadePrazo').value = '';
            aplicarFiltrosPrazos();
        }

        function atualizarListaPrazos(prazosFiltrados) {
            const tbody = document.getElementById('listaPrazos');
            if (!tbody) return;
            
            tbody.innerHTML = prazosFiltrados.map(prazo => `
                <tr>
                    <td>${prazo.clienteNome}</td>
                    <td>${prazo.tipo}</td>
                    <td>${prazo.descricao}</td>
                    <td>${new Date(prazo.dataLimite).toLocaleDateString('pt-PT')}</td>
                    <td><span class="status-badge status-${prazo.prioridade}">${prazo.prioridade}</span></td>
                    <td><span class="status-badge status-${prazo.status}">${prazo.status === 'concluido' ? 'Conclu√≠do' : prazo.status === 'vencido' ? 'Vencido' : prazo.status === 'cancelado' ? 'Cancelado' : 'Ativo'}</span></td>
                    <td>
                        <button onclick="editarItem('prazo', ${prazo.id})" class="text-blue-600 hover:text-blue-800">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirItem('prazo', ${prazo.id})" class="text-red-600 hover:text-red-800 ml-2">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }


        // === FUN√á√ïES DE ATUALIZA√á√ÉO DE LISTAS ===

        function atualizarListaHerancas(herancasFiltradas) {
            console.log('üîß atualizarListaHerancas REABILITADO - carregando heran√ßas reais');
            console.log('üîß herancasFiltradas:', herancasFiltradas);
            console.log('üîß herancasFiltradas.length:', herancasFiltradas ? herancasFiltradas.length : 'undefined');
            
            const tbody = document.getElementById('listaHerancas');
            if (!tbody) {
                console.log('‚ùå tbody listaHerancas n√£o encontrado');
                return;
            }
            console.log('‚úÖ tbody listaHerancas encontrado');
            
            const html = herancasFiltradas.map(heranca => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${heranca.clienteNome || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${heranca.tipo || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${heranca.descricao || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="text-sm font-bold text-black">‚Ç¨${Number(heranca.valor || 0).toFixed(2)}</div>
                        <div class="text-xs font-bold text-red-600">+ IVA: ‚Ç¨${(Number(heranca.valor || 0) + (Number(heranca.valor || 0) * Number(heranca.iva || 0) / 100)).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge status-${heranca.status || 'pendente'}">${heranca.status || 'Pendente'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${heranca.dataInicio || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editarHerancaDireto(${heranca.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="abrirAnexosHeranca(${heranca.id})" class="text-green-600 hover:text-green-900 mr-2" title="Documentos">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirHerancaDireto(${heranca.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html;
            console.log('‚úÖ HTML inserido no tbody listaHerancas');
            
            // FOR√áAR RENDERIZA√á√ÉO DOS √çCONES
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('üîß √çcones Lucide renderizados');
                }
            }, 100);
        }

        function atualizarListaMigracoes(migracoesFiltradas) {
            const tbody = document.getElementById('listaMigracoes');
            if (!tbody) return;
            
            tbody.innerHTML = migracoesFiltradas.map(migracao => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${migracao.clienteNome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.tipo}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${migracao.descricao}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="text-sm font-bold text-black">‚Ç¨${(migracao.valor || 0).toFixed(2)}</div>
                        <div class="text-xs font-bold text-red-600">+ IVA: ‚Ç¨${((migracao.valor || 0) + ((migracao.valor || 0) * (migracao.iva || 0) / 100)).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge status-${migracao.status}">${migracao.status === 'concluido' ? 'Conclu√≠do' : migracao.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.dataInicio ? new Date(migracao.dataInicio).toLocaleDateString('pt-PT') : 'Data n√£o definida'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editarMigracaoSimples(${migracao.id})" class="text-blue-600 hover:text-blue-900 mr-3" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="abrirAnexosMigracao(${migracao.id})" class="text-green-600 hover:text-green-900 mr-3" title="Documentos">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirMigracao(${migracao.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function atualizarListaRegistos(registosFiltrados) {
            console.log('üîß atualizarListaRegistos REABILITADO - carregando registos reais');
            console.log('üîß registosFiltrados:', registosFiltrados);
            console.log('üîß registosFiltrados.length:', registosFiltrados ? registosFiltrados.length : 'undefined');
            
            const tbody = document.getElementById('listaRegistos');
            if (!tbody) {
                console.log('‚ùå tbody listaRegistos n√£o encontrado');
                return;
            }
            console.log('‚úÖ tbody listaRegistos encontrado');
            
            const html = registosFiltrados.map(registo => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${registo.clienteNome || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registo.tipo || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${registo.descricao || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="text-sm font-bold text-black">‚Ç¨${Number(registo.valor || 0).toFixed(2)}</div>
                        <div class="text-xs font-bold text-red-600">+ IVA: ‚Ç¨${(Number(registo.valor || 0) + (Number(registo.valor || 0) * Number(registo.iva || 0) / 100)).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge status-${registo.status || 'pendente'}">${registo.status || 'Pendente'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registo.dataInicio || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editarRegistoDireto(${registo.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="abrirAnexosRegisto(${registo.id})" class="text-green-600 hover:text-green-900 mr-2" title="Documentos">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirRegistoDireto(${registo.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html;
            console.log('‚úÖ HTML inserido no tbody listaRegistos');
            
            // FOR√áAR RENDERIZA√á√ÉO DOS √çCONES
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('üîß √çcones Lucide renderizados');
                }
            }, 100);
        }


        // === FUN√á√ïES DE MODAL E CRUD ===

        function abrirModalHeranca() {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Nova Heran√ßa</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form id="formHeranca" onsubmit="salvarHeranca(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Aceita√ß√£o da heran√ßa">Aceita√ß√£o da heran√ßa</option>
                                            <option value="Doa√ß√µes">Doa√ß√µes</option>
                                            <option value="Escrituras de partilha">Escrituras de partilha</option>
                                            <option value="Habilita√ß√£o de herdeiros">Habilita√ß√£o de herdeiros</option>
                                            <option value="Partilhas em vida">Partilhas em vida</option>
                                            <option value="Partilhas por √≥bito">Partilhas por √≥bito</option>
                                            <option value="Processo de invent√°rio">Processo de invent√°rio</option>
                                            <option value="Ren√∫ncia √† heran√ßa">Ren√∫ncia √† heran√ßa</option>
                                            <option value="Testamentos">Testamentos</option>
                                            <option value="Invent√°rio">Invent√°rio</option>
                                            <option value="Partilha">Partilha</option>
                                            <option value="Testamento">Testamento</option>
                                            <option value="Doa√ß√£o">Doa√ß√£o</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select name="iva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0">0% (Isento)</option>
                                                <option value="6">6% (Reduzida)</option>
                                                <option value="13">13% (Interm√©dia)</option>
                                                <option value="23" selected>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                            <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('heranca')">
                                                <option value="sem">Sem parceria</option>
                                                <option value="empresa">Empresa</option>
                                                <option value="pessoa">Pessoa</option>
                                            </select>
                                        </div>
                                        
                                        <div id="herancaParceriaNomeDiv" style="display: none;">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                            <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                            <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente">Pendente</option>
                                                <option value="em_andamento">Em Andamento</option>
                                                <option value="concluido">Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                            <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observa√ß√µes adicionais sobre a heran√ßa..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Heran√ßa
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        function criarModalMigracao() {
            return `
                <div class="modal show" onclick="fecharModalRobusto()">
                    <div class="modal-content p-6" style="max-width: 600px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Nova Migra√ß√£o</h3>
                            <button onclick="fecharModalRobusto()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formMigracao" onsubmit="salvarMigracao(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                    <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Autoriza√ß√£o de resid√™ncia">Autoriza√ß√£o de resid√™ncia</option>
                                        <option value="Certificados de resid√™ncia permanente">Certificados de resid√™ncia permanente</option>
                                        <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                        <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                        <option value="Renova√ß√£o de autoriza√ß√µes">Renova√ß√£o de autoriza√ß√µes</option>
                                        <option value="Vistos D7">Vistos D7</option>
                                        <option value="Vistos Gold">Vistos Gold</option>
                                        <option value="Vistos para estudantes">Vistos para estudantes</option>
                                        <option value="Vistos para trabalho">Vistos para trabalho</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor (‚Ç¨) *</label>
                                        <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="0.00">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <input type="number" name="iva" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="23" value="23">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                                        <select name="status" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente">Pendente</option>
                                            <option value="em_andamento">Em Andamento</option>
                                            <option value="concluido">Conclu√≠do</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de In√≠cio *</label>
                                    <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                    <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observa√ß√µes adicionais sobre a migra√ß√£o..."></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Migra√ß√£o
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function abrirModalMigracaoDireto() {
            console.log('üîß abrirModalMigracaoDireto chamado');
            
            // Fechar qualquer modal aberto
            fecharModal();
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalNovaMigracao';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Nova Migra√ß√£o</h3>
                            <button onclick="document.getElementById('modalNovaMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form id="formMigracao" onsubmit="salvarMigracao(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                    <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Autoriza√ß√£o de resid√™ncia">Autoriza√ß√£o de resid√™ncia</option>
                                        <option value="Certificados de resid√™ncia permanente">Certificados de resid√™ncia permanente</option>
                                        <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                        <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                        <option value="Renova√ß√£o de autoriza√ß√µes">Renova√ß√£o de autoriza√ß√µes</option>
                                        <option value="Vistos D7">Vistos D7</option>
                                        <option value="Vistos Gold">Vistos Gold</option>
                                        <option value="Vistos para estudantes">Vistos para estudantes</option>
                                        <option value="Vistos para trabalho">Vistos para trabalho</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor (‚Ç¨) *</label>
                                        <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="0.00">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <input type="number" name="iva" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="23" value="23">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                                        <select name="status" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente">Pendente</option>
                                            <option value="em_andamento">Em Andamento</option>
                                            <option value="concluido">Conclu√≠do</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de In√≠cio *</label>
                                    <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                    <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('migracao')">
                                        <option value="sem">Sem parceria</option>
                                        <option value="empresa">Empresa</option>
                                        <option value="pessoa">Pessoa</option>
                                    </select>
                                </div>
                                
                                <div id="migracaoParceriaNomeDiv" style="display: none;">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                    <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                    <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                    <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observa√ß√µes adicionais sobre a migra√ß√£o..."></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="document.getElementById('modalNovaMigracao').remove()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Migra√ß√£o
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('‚úÖ Modal de migra√ß√£o criado e adicionado ao body');
        }
        
        // Tornar fun√ß√£o global
        window.abrirModalMigracaoDireto = abrirModalMigracaoDireto;

        function abrirModalMigracao() {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Nova Migra√ß√£o</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form id="formMigracao" onsubmit="salvarMigracao(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autoriza√ß√£o de resid√™ncia">Autoriza√ß√£o de resid√™ncia</option>
                                            <option value="Certificados de resid√™ncia permanente">Certificados de resid√™ncia permanente</option>
                                            <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                            <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                            <option value="Renova√ß√£o de autoriza√ß√µes">Renova√ß√£o de autoriza√ß√µes</option>
                                            <option value="Vistos D7">Vistos D7</option>
                                            <option value="Vistos Gold">Vistos Gold</option>
                                            <option value="Vistos para estudantes">Vistos para estudantes</option>
                                            <option value="Vistos para trabalho">Vistos para trabalho</option>
                                            <option value="Nacionalidade">Nacionalidade</option>
                                            <option value="Resid√™ncia">Resid√™ncia</option>
                                            <option value="Visto">Visto</option>
                                            <option value="Reagrupamento">Reagrupamento</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select name="iva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0">0% (Isento)</option>
                                                <option value="6">6% (Reduzida)</option>
                                                <option value="13">13% (Interm√©dia)</option>
                                                <option value="23" selected>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                            <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('heranca')">
                                                <option value="sem">Sem parceria</option>
                                                <option value="empresa">Empresa</option>
                                                <option value="pessoa">Pessoa</option>
                                            </select>
                                        </div>
                                        
                                        <div id="herancaParceriaNomeDiv" style="display: none;">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                            <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                            <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente">Pendente</option>
                                                <option value="em_andamento">Em Andamento</option>
                                                <option value="concluido">Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                            <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observa√ß√µes adicionais sobre a migra√ß√£o..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Migra√ß√£o
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        function abrirModalRegisto() {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Novo Registo</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form id="formRegisto" onsubmit="salvarRegisto(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autentica√ß√£o de documentos">Autentica√ß√£o de documentos</option>
                                            <option value="Certifica√ß√£o de fotoc√≥pias">Certifica√ß√£o de fotoc√≥pias</option>
                                            <option value="Documentos para o estrangeiro">Documentos para o estrangeiro</option>
                                            <option value="Procura√ß√µes">Procura√ß√µes</option>
                                            <option value="Reconhecimento presencial de assinaturas">Reconhecimento presencial de assinaturas</option>
                                            <option value="Registos autom√≥veis">Registos autom√≥veis</option>
                                            <option value="Registos comerciais">Registos comerciais</option>
                                            <option value="Registos de propriedade">Registos de propriedade</option>
                                            <option value="Termos de autentica√ß√£o">Termos de autentica√ß√£o</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select name="iva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0">0% (Isento)</option>
                                                <option value="6">6% (Reduzida)</option>
                                                <option value="13">13% (Interm√©dia)</option>
                                                <option value="23" selected>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                            <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('heranca')">
                                                <option value="sem">Sem parceria</option>
                                                <option value="empresa">Empresa</option>
                                                <option value="pessoa">Pessoa</option>
                                            </select>
                                        </div>
                                        
                                        <div id="herancaParceriaNomeDiv" style="display: none;">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                            <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                            <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente">Pendente</option>
                                                <option value="em_andamento">Em Andamento</option>
                                                <option value="concluido">Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                            <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observa√ß√µes adicionais sobre o registo..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Registo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        // === FUN√á√ïES DE SALVAMENTO ===

        function salvarHeranca(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const clienteId = parseInt(formData.get('clienteId'));
            const cliente = clientes.find(c => c.id === clienteId);
            
            const valor = parseFloat(formData.get('valor')) || 0;
            const iva = parseFloat(formData.get('iva')) || 0;
            const percentagem = parseFloat(formData.get('percentagem')) || 0;
            const valorComIva = valor + (valor * iva / 100);

            const novaHeranca = {
                id: herancas.length > 0 ? Math.max(...herancas.map(h => h.id)) + 1 : 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente n√£o encontrado',
                tipo: formData.get('tipo'),
                descricao: formData.get('descricao'),
                valor: valor,
                iva: iva,
                percentagem: percentagem,
                valorComIva: valorComIva,
                status: formData.get('status'),
                dataInicio: formData.get('dataInicio'),
                observacoes: formData.get('observacoes'),
                dataCriacao: new Date().toISOString()
            };

            herancas.unshift(novaHeranca);
            salvarDados('herancas', herancas);
            
            // Criar prazo autom√°tico para a heran√ßa
            // Carregar prazos do localStorage antes de adicionar
            const prazosSalvos = localStorage.getItem('prazos');
            if (prazosSalvos) {
                prazos = JSON.parse(prazosSalvos);
                window.prazos = prazos;
            }
            
            const prazoHeranca = {
                id: Date.now() + 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente n√£o encontrado',
                descricao: `Prazo para ${novaHeranca.tipo} - ${novaHeranca.descricao}`,
                dataLimite: new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 60 dias
                status: 'ativo',
                tipo: 'heranca',
                prioridade: 'media',
                referenciaId: novaHeranca.id,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoHeranca);
            window.prazos = prazos;
            salvarDados('prazos', prazos);
            
            mostrarNotificacao('Heran√ßa e prazo criados com sucesso!', 'success');
            fecharModal();
            carregarSecao('herancas');
            
            // Atualizar lista ap√≥s salvar
            setTimeout(() => {
                if (typeof atualizarListaHerancas === 'function') {
                    atualizarListaHerancas(herancas);
                }
            }, 200);
        }

        function salvarMigracao(event) {
            try {
            event.preventDefault();
                console.log('üîß salvarMigracao iniciado');
                console.log('üîß FormData:', event.target);
                
            const formData = new FormData(event.target);
            const clienteId = parseInt(formData.get('clienteId'));
            const cliente = clientes.find(c => c.id === clienteId);
            
            const valor = parseFloat(formData.get('valor')) || 0;
            const iva = parseFloat(formData.get('iva')) || 0;
            const percentagem = parseFloat(formData.get('percentagem')) || 0;
            const valorComIva = valor + (valor * iva / 100);
                
                console.log('üîß Valores calculados:');
                console.log('üîß valor:', valor);
                console.log('üîß iva:', iva);
                console.log('üîß valorComIva:', valorComIva);

            const novaMigracao = {
                id: migracoes.length > 0 ? Math.max(...migracoes.map(m => m.id)) + 1 : 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente n√£o encontrado',
                tipo: formData.get('tipo'),
                    descricao: '', // Campo n√£o existe no modal de Migra√ß√£o
                valor: valor,
                iva: iva,
                percentagem: percentagem,
                valorComIva: valorComIva,
                status: formData.get('status'),
                dataInicio: formData.get('dataInicio'),
                    parceria: formData.get('parceria'),
                    parceriaNome: formData.get('parceriaNome'),
                observacoes: formData.get('observacoes'),
                dataCriacao: new Date().toISOString()
            };

                console.log('üîß Nova migra√ß√£o criada:', novaMigracao);
            migracoes.unshift(novaMigracao);
            salvarDados('migracoes', migracoes);
                console.log('üîß Migra√ß√£o salva no localStorage');
            
            // Criar prazo autom√°tico para a migra√ß√£o
            // Carregar prazos do localStorage antes de adicionar
            const prazosSalvos = localStorage.getItem('prazos');
            if (prazosSalvos) {
                prazos = JSON.parse(prazosSalvos);
                window.prazos = prazos;
            }
            
            const prazoMigracao = {
                id: Date.now() + 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente n√£o encontrado',
                descricao: `Prazo para ${novaMigracao.tipo}`,
                dataLimite: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 90 dias
                status: 'ativo',
                tipo: 'migracao',
                prioridade: 'media',
                referenciaId: novaMigracao.id,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoMigracao);
            window.prazos = prazos;
            salvarDados('prazos', prazos);
                console.log('üîß Prazo criado e salvo');
            
            mostrarNotificacao('Processo de migra√ß√£o e prazo criados com sucesso!', 'success');
            fecharModal();
                
                console.log('üîß Tentando carregar se√ß√£o migracoes');
                console.log('üîß Migra√ß√µes ap√≥s salvar:', migracoes);
                setTimeout(() => {
                    carregarSecao('migracoes');
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar migra√ß√£o:', error);
                mostrarNotificacao('Erro ao salvar migra√ß√£o: ' + error.message, 'error');
            }
        }

        function salvarRegisto(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const clienteId = parseInt(formData.get('clienteId'));
            const cliente = clientes.find(c => c.id === clienteId);
            
            const valor = parseFloat(formData.get('valor')) || 0;
            const iva = parseFloat(formData.get('iva')) || 0;
            const percentagem = parseFloat(formData.get('percentagem')) || 0;
            const valorComIva = valor + (valor * iva / 100);

            const novoRegisto = {
                id: registos.length > 0 ? Math.max(...registos.map(r => r.id)) + 1 : 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente n√£o encontrado',
                tipo: formData.get('tipo'),
                descricao: formData.get('descricao'),
                valor: valor,
                iva: iva,
                percentagem: percentagem,
                valorComIva: valorComIva,
                status: formData.get('status'),
                dataInicio: formData.get('dataInicio'),
                observacoes: formData.get('observacoes'),
                dataCriacao: new Date().toISOString()
            };

            registos.unshift(novoRegisto);
            salvarDados('registos', registos);
            
            // Criar prazo autom√°tico para o registo
            // Carregar prazos do localStorage antes de adicionar
            const prazosSalvos = localStorage.getItem('prazos');
            if (prazosSalvos) {
                prazos = JSON.parse(prazosSalvos);
                window.prazos = prazos;
            }
            
            const prazoRegisto = {
                id: Date.now() + 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente n√£o encontrado',
                descricao: `Prazo para ${novoRegisto.tipo} - ${novoRegisto.descricao}`,
                dataLimite: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 15 dias
                status: 'ativo',
                tipo: 'registo',
                prioridade: 'media',
                referenciaId: novoRegisto.id,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoRegisto);
            window.prazos = prazos;
            salvarDados('prazos', prazos);
            
            mostrarNotificacao('Registo e prazo criados com sucesso!', 'success');
            fecharModal();
            
            // FOR√áAR RECARREGAMENTO IMEDIATO
            console.log('üîß FOR√áANDO RECARREGAMENTO AP√ìS SALVAR REGISTO');
            console.log('üîß registos ap√≥s salvar:', registos);
            
            // Recarregar se√ß√£o
            setTimeout(() => {
                carregarSecao('registos');
            }, 100);
            
            // Atualizar lista ap√≥s salvar
            setTimeout(() => {
                console.log('üîß CHAMANDO atualizarListaRegistos ap√≥s salvar');
                if (typeof atualizarListaRegistos === 'function') {
                    atualizarListaRegistos(registos);
                    console.log('‚úÖ atualizarListaRegistos executado ap√≥s salvar');
                } else {
                    console.error('‚ùå atualizarListaRegistos n√£o √© uma fun√ß√£o ap√≥s salvar');
                }
            }, 300);
        }

        // === FUN√á√ïES DE EDI√á√ÉO E EXCLUS√ÉO ===

        function editarHeranca(id) {
            const heranca = herancas.find(h => h.id === id);
            if (!heranca) return;

            abrirModalHeranca();
            // Preencher formul√°rio com dados existentes
            setTimeout(() => {
                const form = document.getElementById('formHeranca');
                if (form) {
                    form.clienteId.value = heranca.clienteId;
                    form.tipo.value = heranca.tipo;
                    form.descricao.value = heranca.descricao || '';
                    form.valor.value = heranca.valor || '';
                    form.iva.value = heranca.iva || 23;
                    form.status.value = heranca.status;
                    form.dataInicio.value = heranca.dataInicio || '';
                    form.observacoes.value = heranca.observacoes || '';
                    
                    // Alterar t√≠tulo do modal
                    document.querySelector('#modalContainer h3').textContent = 'Editar Heran√ßa';
                    
                    // Adicionar campo hidden para ID
                    const hiddenId = document.createElement('input');
                    hiddenId.type = 'hidden';
                    hiddenId.name = 'id';
                    hiddenId.value = heranca.id;
                    form.appendChild(hiddenId);
                }
            }, 100);
        }

        function editarMigracao(id) {
            const migracao = migracoes.find(m => m.id === id);
            if (!migracao) return;

            abrirModalMigracao();
            setTimeout(() => {
                const form = document.getElementById('formMigracao');
                if (form) {
                    form.clienteId.value = migracao.clienteId;
                    form.tipo.value = migracao.tipo;
                    form.descricao.value = migracao.descricao || '';
                    form.valor.value = migracao.valor || '';
                    form.iva.value = migracao.iva || 23;
                    form.status.value = migracao.status;
                    form.dataInicio.value = migracao.dataInicio || '';
                    form.observacoes.value = migracao.observacoes || '';
                    
                    document.querySelector('#modalContainer h3').textContent = 'Editar Processo de Migra√ß√£o';
                    
                    const hiddenId = document.createElement('input');
                    hiddenId.type = 'hidden';
                    hiddenId.name = 'id';
                    hiddenId.value = migracao.id;
                    form.appendChild(hiddenId);
                }
            }, 100);
        }

        function editarRegisto(id) {
            const registo = registos.find(r => r.id === id);
            if (!registo) return;

            abrirModalRegisto();
            setTimeout(() => {
                const form = document.getElementById('formRegisto');
                if (form) {
                    form.clienteId.value = registo.clienteId;
                    form.tipo.value = registo.tipo;
                    form.descricao.value = registo.descricao || '';
                    form.valor.value = registo.valor || '';
                    form.iva.value = registo.iva || 23;
                    form.status.value = registo.status;
                    form.dataInicio.value = registo.dataInicio || '';
                    form.observacoes.value = registo.observacoes || '';
                    
                    document.querySelector('#modalContainer h3').textContent = 'Editar Registo';
                    
                    const hiddenId = document.createElement('input');
                    hiddenId.type = 'hidden';
                    hiddenId.name = 'id';
                    hiddenId.value = registo.id;
                    form.appendChild(hiddenId);
                }
            }, 100);
        }

        function excluirHeranca(id) {
            if (confirm('Tem certeza que deseja excluir esta heran√ßa?')) {
                herancas = herancas.filter(h => h.id !== id);
                salvarDados('herancas', herancas);
                mostrarNotificacao('Heran√ßa exclu√≠da com sucesso!', 'success');
                carregarSecao('herancas');
            }
        }

        function excluirMigracao(id) {
            if (confirm('Tem certeza que deseja excluir este processo de migra√ß√£o?')) {
                migracoes = migracoes.filter(m => m.id !== id);
                salvarDados('migracoes', migracoes);
                mostrarNotificacao('Processo de migra√ß√£o exclu√≠do com sucesso!', 'success');
                carregarSecao('migracao');
            }
        }

        function excluirRegisto(id) {
            if (confirm('Tem certeza que deseja excluir este registo?')) {
                registos = registos.filter(r => r.id !== id);
                salvarDados('registos', registos);
                mostrarNotificacao('Registo exclu√≠do com sucesso!', 'success');
                carregarSecao('registos');
            }
        }

        // === SISTEMA DE ANEXOS DE DOCUMENTOS ===
        
        function abrirAnexosCliente(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) return;
            
            // Inicializar array de anexos se n√£o existir
            if (!cliente.anexos) {
                cliente.anexos = [];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos de ${cliente.nome}</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <!-- Upload de novos documentos -->
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexo(event, ${clienteId})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('cliente')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="identificacao">Identifica√ß√£o</option>
                                                <option value="contrato">Contrato</option>
                                                <option value="certificado">Certificado</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizadoCliente" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descri√ß√£o do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Lista de documentos existentes -->
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${cliente.anexos.length})</h4>
                                ${cliente.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${cliente.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} ‚Ä¢ ${anexo.tamanho} ‚Ä¢ ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexo(${clienteId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }
        
        function adicionarAnexo(event, clienteId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            // Usar tipo personalizado se "outro" foi selecionado
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const cliente = clientes.find(c => c.id === clienteId);
                if (cliente) {
                    if (!cliente.anexos) cliente.anexos = [];
                    cliente.anexos.push(anexo);
                    salvarDados('clientes', clientes);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    abrirAnexosCliente(clienteId); // Recarregar modal
                }
            });
        }
        
        function formatarTamanho(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Fun√ß√£o para formatar valor com IVA incorporado
        function formatarValorComIva(valor, iva, valorComIva) {
            const valorNum = parseFloat(valor) || 0;
            const ivaNum = parseFloat(iva) || 0;
            const valorComIvaNum = parseFloat(valorComIva) || 0;
            
            // Calcular valor com IVA se n√£o foi fornecido
            const valorComIvaCalculado = valorComIvaNum > 0 ? valorComIvaNum : valorNum + (valorNum * ivaNum / 100);
            
            const valorFormatado = (Math.round(valorNum * 100) / 100).toFixed(2);
            const valorComIvaFormatado = (Math.round(valorComIvaCalculado * 100) / 100).toFixed(2);
            
            return `
                <div class="flex flex-col">
                    <div class="text-sm font-medium text-gray-900">‚Ç¨${valorFormatado}</div>
                    <div class="text-xs text-gray-500">
                        <span class="text-gray-400">+ ${ivaNum}% IVA:</span>
                        <span class="font-medium text-gray-700">‚Ç¨${valorComIvaFormatado}</span>
                    </div>
                </div>
            `;
        }
        
        function visualizarAnexo(anexoId) {
            console.log('üîß visualizarAnexo chamado com ID:', anexoId);
            
            // Buscar anexo em todas as fontes
            let anexo = null;
            let tipo = '';
            
            // Buscar em contratos
            const contratosSalvos = localStorage.getItem('contratos');
            if (contratosSalvos) {
                const contratos = JSON.parse(contratosSalvos);
                for (const contrato of contratos) {
                    if (contrato.anexos) {
                        anexo = contrato.anexos.find(a => a.id === anexoId);
                        if (anexo) {
                            tipo = 'contrato';
                            break;
                        }
                    }
                }
            }
            
            // Buscar em heran√ßas
            if (!anexo) {
                const herancasSalvas = localStorage.getItem('herancas');
                if (herancasSalvas) {
                    const herancas = JSON.parse(herancasSalvas);
                    for (const heranca of herancas) {
                        if (heranca.anexos) {
                            anexo = heranca.anexos.find(a => a.id === anexoId);
                            if (anexo) {
                                tipo = 'heranca';
                                break;
                            }
                        }
                    }
                }
            }
            
            // Buscar em migra√ß√µes
            if (!anexo) {
                const migracoesSalvas = localStorage.getItem('migracoes');
                if (migracoesSalvas) {
                    const migracoes = JSON.parse(migracoesSalvas);
                    for (const migracao of migracoes) {
                        if (migracao.anexos) {
                            anexo = migracao.anexos.find(a => a.id === anexoId);
                            if (anexo) {
                                tipo = 'migracao';
                                break;
                            }
                        }
                    }
                }
            }
            
            // Buscar em registos
            if (!anexo) {
                const registosSalvos = localStorage.getItem('registos');
                if (registosSalvos) {
                    const registos = JSON.parse(registosSalvos);
                    for (const registo of registos) {
                        if (registo.anexos) {
                            anexo = registo.anexos.find(a => a.id === anexoId);
                            if (anexo) {
                                tipo = 'registo';
                                break;
                            }
                        }
                    }
                }
            }
            
            // Buscar em clientes
            if (!anexo) {
                const clientesSalvos = localStorage.getItem('clientes');
                if (clientesSalvos) {
                    const clientes = JSON.parse(clientesSalvos);
                    for (const cliente of clientes) {
                        if (cliente.anexos) {
                            anexo = cliente.anexos.find(a => a.id === anexoId);
                            if (anexo) {
                                tipo = 'cliente';
                                break;
                            }
                        }
                    }
                }
            }
            
            if (!anexo) {
                mostrarNotificacao('Documento n√£o encontrado!', 'error');
                return;
            }
            
            // Determinar tipo de arquivo
            const extensao = anexo.nome.split('.').pop().toLowerCase();
            const isImagem = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extensao);
            const isPDF = extensao === 'pdf';
            const isDocumento = ['doc', 'docx', 'txt', 'rtf'].includes(extensao);
            
            // Criar modal de visualiza√ß√£o
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-900">${anexo.nome}</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <div class="mb-4 text-sm text-gray-600">
                                <p><strong>Tipo:</strong> ${anexo.tipo}</p>
                                <p><strong>Tamanho:</strong> ${anexo.tamanho}</p>
                                <p><strong>Data:</strong> ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                ${anexo.descricao ? `<p><strong>Descri√ß√£o:</strong> ${anexo.descricao}</p>` : ''}
                            </div>
                            
                            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                ${isImagem ? `
                                    <div class="text-center">
                                        <img src="${anexo.conteudo}" alt="${anexo.nome}" class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg">
                                    </div>
                                ` : isPDF ? `
                                    <div class="text-center">
                                        <iframe src="${anexo.conteudo}" width="100%" height="500px" class="rounded-lg border-0"></iframe>
                                    </div>
                                ` : isDocumento ? `
                                    <div class="text-center py-8">
                                        <i data-lucide="file-text" class="w-16 h-16 mx-auto mb-4 text-blue-600"></i>
                                        <p class="text-gray-600 mb-4">Visualiza√ß√£o n√£o dispon√≠vel para este tipo de arquivo</p>
                                        <button onclick="baixarAnexo('${anexoId}')" class="btn btn-primary">
                                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                            Baixar Documento
                                        </button>
                                    </div>
                                ` : `
                                    <div class="text-center py-8">
                                        <i data-lucide="file" class="w-16 h-16 mx-auto mb-4 text-gray-600"></i>
                                        <p class="text-gray-600 mb-4">Visualiza√ß√£o n√£o dispon√≠vel para este tipo de arquivo</p>
                                        <button onclick="baixarAnexo('${anexoId}')" class="btn btn-primary">
                                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                            Baixar Arquivo
                                        </button>
                                    </div>
                                `}
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-4">
                                <button onclick="baixarAnexo('${anexoId}')" class="btn btn-secondary">
                                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                    Baixar
                                </button>
                                <button onclick="fecharModalRobusto()" class="btn btn-primary">
                                    <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                    Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Adicionar modal ao body
            const modalElement = document.createElement('div');
            modalElement.innerHTML = modal;
            document.body.appendChild(modalElement.firstElementChild);
            lucide.createIcons();
        }
        
        function baixarAnexo(anexoId) {
            console.log('üîß baixarAnexo chamado com ID:', anexoId);
            console.log('üîß Buscando anexo com ID:', anexoId);
            
            // Buscar anexo em todas as fontes
            let anexo = null;
            
            // Buscar em contratos
            const contratosSalvos = localStorage.getItem('contratos');
            if (contratosSalvos) {
                const contratos = JSON.parse(contratosSalvos);
                for (const contrato of contratos) {
                    if (contrato.anexos) {
                        anexo = contrato.anexos.find(a => a.id === anexoId);
                        if (anexo) break;
                    }
                }
            }
            
            // Buscar em heran√ßas
            if (!anexo) {
                const herancasSalvas = localStorage.getItem('herancas');
                if (herancasSalvas) {
                    const herancas = JSON.parse(herancasSalvas);
                    for (const heranca of herancas) {
                        if (heranca.anexos) {
                            anexo = heranca.anexos.find(a => a.id === anexoId);
                            if (anexo) break;
                        }
                    }
                }
            }
            
            // Buscar em migra√ß√µes
            if (!anexo) {
                const migracoesSalvas = localStorage.getItem('migracoes');
                if (migracoesSalvas) {
                    const migracoes = JSON.parse(migracoesSalvas);
                    for (const migracao of migracoes) {
                        if (migracao.anexos) {
                            anexo = migracao.anexos.find(a => a.id === anexoId);
                            if (anexo) break;
                        }
                    }
                }
            }
            
            // Buscar em registos
            if (!anexo) {
                const registosSalvos = localStorage.getItem('registos');
                if (registosSalvos) {
                    const registos = JSON.parse(registosSalvos);
                    for (const registo of registos) {
                        if (registo.anexos) {
                            anexo = registo.anexos.find(a => a.id === anexoId);
                            if (anexo) break;
                        }
                    }
                }
            }
            
            // Buscar em clientes
            if (!anexo) {
                const clientesSalvos = localStorage.getItem('clientes');
                if (clientesSalvos) {
                    const clientes = JSON.parse(clientesSalvos);
                    for (const cliente of clientes) {
                        if (cliente.anexos) {
                            anexo = cliente.anexos.find(a => a.id === anexoId);
                            if (anexo) break;
                        }
                    }
                }
            }
            
            if (!anexo) {
                console.error('‚ùå Anexo n√£o encontrado com ID:', anexoId);
                mostrarNotificacao('Documento n√£o encontrado!', 'error');
                return;
            }
            
            console.log('üîß Anexo encontrado:', anexo);
            console.log('üîß Tipo de arquivo:', anexo.tipo || 'desconhecido');
            console.log('üîß Nome do arquivo:', anexo.nome || 'sem nome');
            console.log('üîß Campos dispon√≠veis:', Object.keys(anexo));
            console.log('üîß Conte√∫do (conteudo):', anexo.conteudo ? anexo.conteudo.substring(0, 50) + '...' : 'N/A');
            console.log('üîß Conte√∫do (dataURL):', anexo.dataURL ? anexo.dataURL.substring(0, 50) + '...' : 'N/A');
            console.log('üîß Conte√∫do (dados):', anexo.dados ? anexo.dados.substring(0, 50) + '...' : 'N/A');
            
            try {
                console.log('üîß Iniciando convers√£o Base64 para Blob...');
                
                // Verificar qual campo cont√©m o conte√∫do
                let conteudoBase64 = anexo.conteudo || anexo.dataURL || anexo.dados;
                
                // Validar se o conte√∫do Base64 √© v√°lido
                if (!conteudoBase64 || typeof conteudoBase64 !== 'string' || conteudoBase64 === 'simulado') {
                    throw new Error('Conte√∫do do anexo n√£o encontrado ou inv√°lido');
                }
                
                // Verificar se √© um data URL v√°lido
                let base64Content = conteudoBase64;
                if (base64Content.startsWith('data:')) {
                    // Extrair apenas a parte Base64 do data URL
                    base64Content = base64Content.split(',')[1];
                }
                
                // Validar formato Base64
                const base64Regex = /^[A-Za-z0-9+/]*={0,2}$/;
                if (!base64Regex.test(base64Content)) {
                    throw new Error('Formato Base64 inv√°lido');
                }
                
                console.log('üîß Base64 validado, iniciando decodifica√ß√£o...');
                // Converter base64 para blob
                const byteCharacters = atob(base64Content);
                console.log('üîß Base64 decodificado, tamanho:', byteCharacters.length);
                
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                console.log('üîß ByteArray criado, tamanho:', byteArray.length);
                
                // Detectar tipo MIME baseado na extens√£o do arquivo
                let mimeType = anexo.tipoMime || anexo.tipoArquivo || 'application/octet-stream';
                
                // Se n√£o temos tipo MIME, detectar pela extens√£o
                if (!anexo.tipoMime && !anexo.tipoArquivo) {
                    const extensao = anexo.nomeArquivo ? anexo.nomeArquivo.split('.').pop().toLowerCase() : '';
                    const mimeTypes = {
                        'jpg': 'image/jpeg',
                        'jpeg': 'image/jpeg',
                        'png': 'image/png',
                        'gif': 'image/gif',
                        'bmp': 'image/bmp',
                        'webp': 'image/webp',
                        'pdf': 'application/pdf',
                        'doc': 'application/msword',
                        'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                        'xls': 'application/vnd.ms-excel',
                        'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                        'ppt': 'application/vnd.ms-powerpoint',
                        'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                        'txt': 'text/plain',
                        'rtf': 'application/rtf',
                        'zip': 'application/zip',
                        'rar': 'application/x-rar-compressed',
                        '7z': 'application/x-7z-compressed'
                    };
                    
                    mimeType = mimeTypes[extensao] || 'application/octet-stream';
                }
                
                console.log('üîß Tipo MIME detectado:', mimeType);
                
                const blob = new Blob([byteArray], { type: mimeType });
                console.log('üîß Blob criado, tamanho:', blob.size, 'tipo:', blob.type);
                
                // Criar link de download
                const url = window.URL.createObjectURL(blob);
                console.log('üîß URL do objeto criada:', url);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = anexo.nomeArquivo || anexo.nome;
                console.log('üîß Link criado, href:', link.href, 'download:', link.download);
                
                document.body.appendChild(link);
                console.log('üîß Link adicionado ao body, clicando...');
                link.click();
                console.log('üîß Link clicado, removendo do body...');
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                console.log('üîß URL revogada, download deve ter iniciado');
                
                mostrarNotificacao('Download iniciado com sucesso!', 'success');
            } catch (error) {
                console.error('‚ùå Erro ao baixar arquivo:', error);
                console.error('‚ùå Detalhes do erro:', error.message);
                console.error('‚ùå Conte√∫do do anexo (primeiros 100 chars):', anexo.conteudo ? anexo.conteudo.substring(0, 100) : 'N/A');
                
                let mensagemErro = 'Erro ao baixar arquivo!';
                if (error.message.includes('Base64')) {
                    mensagemErro = 'Arquivo corrompido - Base64 inv√°lido. Tente fazer upload novamente.';
                } else if (error.message.includes('conte√∫do')) {
                    mensagemErro = 'Conte√∫do do arquivo n√£o encontrado.';
                }
                
                mostrarNotificacao(mensagemErro, 'error');
            }
        }
        
        function removerAnexo(clienteId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const cliente = clientes.find(c => c.id === clienteId);
                if (cliente && cliente.anexos) {
                    cliente.anexos = cliente.anexos.filter(a => a.id !== anexoId);
                    salvarDados('clientes', clientes);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosCliente(clienteId); // Recarregar modal
                }
            }
        }

        // === SISTEMA DE ANEXOS PARA √ÅREAS DE EXECU√á√ÉO ===
        
        function abrirAnexosContrato(contratoId) {
            const contrato = contratos.find(c => c.id === contratoId);
            if (!contrato) return;
            
            if (!contrato.anexos) contrato.anexos = [];
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos do Contrato</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexoContrato(event, ${contratoId})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('contrato')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="contrato">Contrato</option>
                                                <option value="anexo">Anexo</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="certificado">Certificado</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizadoContrato" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descri√ß√£o do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${contrato.anexos.length})</h4>
                                ${contrato.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${contrato.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} ‚Ä¢ ${anexo.tamanho} ‚Ä¢ ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexoContrato(${contratoId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }
        
        function adicionarAnexoContrato(event, contratoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            // Usar tipo personalizado se "outro" foi selecionado
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const contrato = contratos.find(c => c.id === contratoId);
                if (contrato) {
                    if (!contrato.anexos) contrato.anexos = [];
                    contrato.anexos.push(anexo);
                    salvarDados('contratos', contratos);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    abrirAnexosContrato(contratoId);
                }
            });
        }
        
        function removerAnexoContrato(contratoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const contrato = contratos.find(c => c.id === contratoId);
                if (contrato && contrato.anexos) {
                    contrato.anexos = contrato.anexos.filter(a => a.id !== anexoId);
                    salvarDados('contratos', contratos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosContrato(contratoId);
                }
            }
        }

        // === FUN√á√ÉO PARA CONTROLAR VISIBILIDADE DO TIPO PERSONALIZADO ===
        
        function toggleTipoPersonalizado(area) {
            console.log('üîß toggleTipoPersonalizado chamado para √°rea:', area);
            const select = document.getElementById('tipoDocumento');
            const divPersonalizado = document.getElementById(`tipoPersonalizado${area.charAt(0).toUpperCase() + area.slice(1)}`);
            const inputPersonalizado = document.getElementById('tipoPersonalizadoInput');
            
            console.log('üîß Select encontrado:', !!select);
            console.log('üîß Div personalizado encontrado:', !!divPersonalizado);
            console.log('üîß Input personalizado encontrado:', !!inputPersonalizado);
            
            if (select && divPersonalizado) {
                if (select.value === 'outro') {
                    console.log('üîß Mostrando campo personalizado');
                    divPersonalizado.classList.remove('hidden');
                    if (inputPersonalizado) {
                        inputPersonalizado.required = true;
                        inputPersonalizado.focus();
                    }
                } else {
                    console.log('üîß Ocultando campo personalizado');
                    divPersonalizado.classList.add('hidden');
                    if (inputPersonalizado) {
                        inputPersonalizado.required = false;
                        inputPersonalizado.value = '';
                    }
                }
            } else {
                console.error('‚ùå Elementos n√£o encontrados:', { select: !!select, divPersonalizado: !!divPersonalizado });
            }
        }

        // === FUN√á√ïES PARA PRAZOS ===
        
        
        // FUN√á√ÉO atualizarCliente DUPLICADA REMOVIDA - A FUN√á√ÉO CORRETA EST√Å NA LINHA 7675
        // Esta fun√ß√£o antiga estava sobrescrevendo a fun√ß√£o correta com valida√ß√µes e logs
        
        function atualizarPrazo(event, id) {
            event.preventDefault();
            
            const prazoIndex = prazos.findIndex(p => p.id === id);
            if (prazoIndex !== -1) {
                if (!exigirPermissaoAcao('editar', 'prazo')) {
                    return false;
                }
                prazos[prazoIndex] = {
                    ...prazos[prazoIndex],
                    descricao: document.getElementById('prazoDescricao').value,
                    dataLimite: document.getElementById('prazoDataLimite').value,
                    prioridade: document.getElementById('prazoPrioridade').value,
                    status: document.getElementById('prazoStatus').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('prazos', prazos);
                mostrarNotificacao('Prazo atualizado com sucesso!', 'success');
                fecharModal();
                carregarSecao('prazos');
            }
        }
        

        // === FUN√á√ïES DE MODAL DE EDI√á√ÉO ===
        
        function abrirModalEdicaoCliente(cliente) {
            console.log('abrirModalEdicaoCliente chamado com:', cliente);
            
            const modalContainer = document.getElementById('modalContainer');
            if (!modalContainer) {
                console.error('modalContainer n√£o encontrado!');
                return;
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Cliente</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form id="formEditarCliente_${cliente.id}" onsubmit="return atualizarCliente(event, ${cliente.id});">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                                        <input type="text" id="editarClienteNome" value="${cliente.nome}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                        <input type="email" id="editarClienteEmail" value="${cliente.email}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                                        <input type="tel" id="editarClienteTelefone" value="${cliente.telefone}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">NIF *</label>
                                        <input type="text" id="editarClienteNIF" value="${cliente.nif || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="123456789">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Endere√ßo</label>
                                        <textarea id="editarClienteEndereco" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${cliente.endereco || ''}</textarea>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="editarClienteStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="ativo" ${cliente.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                            <option value="inativo" ${cliente.status === 'inativo' ? 'selected' : ''}>Inativo</option>
                                            <option value="suspenso" ${cliente.status === 'suspenso' ? 'selected' : ''}>Suspenso</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" id="btnSalvarCliente_${cliente.id}" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            console.log('üîß Inserindo modal de cliente no container...');
            modalContainer.innerHTML = modal;
            console.log('üîß Modal inserido, criando √≠cones...');
            lucide.createIcons();
            console.log('‚úÖ Modal de edi√ß√£o de cliente aberto com sucesso!');
            
            // Adicionar listener direto no formul√°rio ap√≥s cri√°-lo
            setTimeout(() => {
                const form = document.getElementById(`formEditarCliente_${cliente.id}`);
                const btnSalvar = document.getElementById(`btnSalvarCliente_${cliente.id}`);
                
                if (form) {
                    console.log('üîß Formul√°rio encontrado, adicionando listener direto...');
                    
                    // Adicionar listener no formul√°rio (sem clonar para manter listeners internos)
                    form.addEventListener('submit', function(e) {
                        console.log('üîß Evento submit capturado diretamente!');
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üîß Chamando atualizarCliente com ID:', cliente.id);
                        const resultado = atualizarCliente(e, cliente.id);
                        console.log('üîß Resultado de atualizarCliente:', resultado);
                        return false;
                    }, false);
                    
                    console.log('‚úÖ Listener direto adicionado ao formul√°rio!');
                } else {
                    console.error('‚ùå Formul√°rio n√£o encontrado ap√≥s criar modal!');
                }
                
                if (btnSalvar) {
                    btnSalvar.addEventListener('click', function(e) {
                        console.log('üîß Bot√£o Salvar clicado diretamente!');
                        e.preventDefault();
                        e.stopPropagation();
                        const form = document.getElementById(`formEditarCliente_${cliente.id}`);
                        if (form) {
                            console.log('üîß Chamando atualizarCliente diretamente do bot√£o com ID:', cliente.id);
                            const resultado = atualizarCliente(e, cliente.id);
                            console.log('üîß Resultado de atualizarCliente do bot√£o:', resultado);
                        }
                    }, false);
                    console.log('‚úÖ Listener adicionado ao bot√£o Salvar!');
                } else {
                    console.error('‚ùå Bot√£o Salvar n√£o encontrado ap√≥s criar modal!');
                }
            }, 100);
        }
        
        function abrirModalEdicaoContrato(contrato) {
            console.log('abrirModalEdicaoContrato chamado com:', contrato);
            
            // Verificar se o modalContainer existe
            const modalContainer = document.getElementById('modalContainer');
            if (!modalContainer) {
                console.error('modalContainer n√£o encontrado!');
                mostrarNotificacao('Erro: Container do modal n√£o encontrado!', 'error');
                return;
            }
            
            // Limpar qualquer conte√∫do anterior
            modalContainer.innerHTML = '';
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Contrato</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarContrato(event, ${contrato.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="contratoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === contrato.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <input type="text" id="contratoTipo" value="${contrato.tipo || ''}" list="tiposContrato" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite ou selecione um tipo">
                                        <datalist id="tiposContrato">
                                            <option value="Compra e Venda">
                                            <option value="Arrendamento">
                                            <option value="Presta√ß√£o de Servi√ßos">
                                            <option value="Empr√©stimo">
                                            <option value="Altera√ß√£o de pactos sociais">
                                            <option value="An√°lise e revis√£o de contratos">
                                            <option value="Cess√£o de quotas">
                                            <option value="Constitui√ß√£o de sociedades">
                                            <option value="Contratos de arrendamento">
                                            <option value="Contratos de compra e venda">
                                            <option value="Contratos de presta√ß√£o de servi√ßos">
                                            <option value="Contratos de trabalho">
                                            <option value="Pactos sociais">
                                            <option value="Consultoria">
                                            <option value="Assessoria">
                                            <option value="Representa√ß√£o">
                                            <option value="Outro">
                                        </datalist>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="contratoValor" value="${contrato.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="contratoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${contrato.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${contrato.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${contrato.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                                <option value="23" ${contrato.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="contratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${contrato.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${contrato.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${contrato.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                            <input type="date" id="contratoDataInicio" value="${contrato.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Fim</label>
                                            <input type="date" id="contratoDataFim" value="${contrato.dataFim || ''}" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea id="contratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${contrato.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                console.log('Inserindo modal no container...');
                modalContainer.innerHTML = modal;
                console.log('Modal inserido, criando √≠cones...');
                lucide.createIcons();
                console.log('Modal de edi√ß√£o de contrato aberto com sucesso!');
                
                // Verificar se o modal foi inserido corretamente
                const modalElement = modalContainer.querySelector('.fixed.inset-0');
                if (modalElement) {
                    console.log('‚úÖ Modal inserido e vis√≠vel');
                    console.log('Modal element:', modalElement);
                    console.log('Modal styles:', window.getComputedStyle(modalElement));
                    
                    // For√ßar visibilidade
                    modalElement.style.display = 'flex';
                    modalElement.style.visibility = 'visible';
                    modalElement.style.opacity = '1';
                    modalElement.style.zIndex = '9999';
                    
                    console.log('Modal for√ßado a ser vis√≠vel');
                } else {
                    console.error('‚ùå Modal n√£o foi inserido corretamente');
                    mostrarNotificacao('Erro ao abrir modal de edi√ß√£o!', 'error');
                }
            } catch (error) {
                console.error('Erro ao inserir modal:', error);
                mostrarNotificacao('Erro ao abrir modal de edi√ß√£o!', 'error');
            }
        }
        
        function abrirModalEdicaoHonorario(honorario) {
            console.log('üîß abrirModalEdicaoHonorario chamado com:', honorario);
            
            const modalContainer = document.getElementById('modalContainer');
            if (!modalContainer) {
                console.error('‚ùå modalContainer n√£o encontrado!');
                mostrarNotificacao('Erro: Container do modal n√£o encontrado!', 'error');
                return;
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Honor√°rio</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form id="formEditarHonorario_${honorario.id}" onsubmit="return atualizarHonorario(event, ${honorario.id});">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <input type="text" id="honorarioCliente" value="${honorario.cliente}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Servi√ßo *</label>
                                        <input type="text" id="honorarioServico" value="${honorario.servico}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="honorarioValor" value="${honorario.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="honorarioStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${honorario.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="pago" ${honorario.status === 'pago' ? 'selected' : ''}>Pago</option>
                                                <option value="vencido" ${honorario.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento *</label>
                                        <input type="date" id="honorarioVencimento" value="${honorario.vencimento}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            console.log('üîß Inserindo modal de honor√°rio no container...');
            modalContainer.innerHTML = modal;
            console.log('üîß Modal inserido, criando √≠cones...');
            lucide.createIcons();
            console.log('‚úÖ Modal de edi√ß√£o de honor√°rio aberto com sucesso!');
        }

        function abrirModalEdicaoHeranca(heranca) {
            console.log('üîß abrirModalEdicaoHeranca chamado com:', heranca);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoHeranca';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = fecharModal;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Heran√ßa</h3>
                            <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form onsubmit="atualizarHeranca(event, ${heranca.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="herancaClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === heranca.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                    <select id="herancaTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Aceita√ß√£o da heran√ßa" ${heranca.tipo === 'Aceita√ß√£o da heran√ßa' ? 'selected' : ''}>Aceita√ß√£o da heran√ßa</option>
                                        <option value="Doa√ß√µes" ${heranca.tipo === 'Doa√ß√µes' ? 'selected' : ''}>Doa√ß√µes</option>
                                        <option value="Escrituras de partilha" ${heranca.tipo === 'Escrituras de partilha' ? 'selected' : ''}>Escrituras de partilha</option>
                                        <option value="Habilita√ß√£o de herdeiros" ${heranca.tipo === 'Habilita√ß√£o de herdeiros' ? 'selected' : ''}>Habilita√ß√£o de herdeiros</option>
                                        <option value="Partilhas em vida" ${heranca.tipo === 'Partilhas em vida' ? 'selected' : ''}>Partilhas em vida</option>
                                        <option value="Partilhas por √≥bito" ${heranca.tipo === 'Partilhas por √≥bito' ? 'selected' : ''}>Partilhas por √≥bito</option>
                                        <option value="Processo de invent√°rio" ${heranca.tipo === 'Processo de invent√°rio' ? 'selected' : ''}>Processo de invent√°rio</option>
                                        <option value="Ren√∫ncia √† heran√ßa" ${heranca.tipo === 'Ren√∫ncia √† heran√ßa' ? 'selected' : ''}>Ren√∫ncia √† heran√ßa</option>
                                        <option value="Testamentos" ${heranca.tipo === 'Testamentos' ? 'selected' : ''}>Testamentos</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="herancaValor" value="${heranca.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="herancaIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0" ${heranca.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                            <option value="6" ${heranca.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                            <option value="13" ${heranca.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                            <option value="23" ${heranca.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="herancaStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente" ${heranca.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                            <option value="em_andamento" ${heranca.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                            <option value="concluido" ${heranca.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                    <input type="date" id="herancaDataInicio" value="${heranca.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                    <textarea id="herancaObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${heranca.observacoes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Altera√ß√µes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            const modalAnterior = document.getElementById('modalEdicaoHeranca');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            // Adicionar ao body
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('‚úÖ Modal de edi√ß√£o de heran√ßa criado e adicionado ao body!');
        }

        function abrirModalEdicaoMigracao(migracao) {
            console.log('üîß abrirModalEdicaoMigracao chamado com:', migracao);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoMigracao';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = fecharModal;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Migra√ß√£o</h3>
                            <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form onsubmit="atualizarMigracao(event, ${migracao.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="migracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                    <select id="migracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Autoriza√ß√£o de resid√™ncia" ${migracao.tipo === 'Autoriza√ß√£o de resid√™ncia' ? 'selected' : ''}>Autoriza√ß√£o de resid√™ncia</option>
                                        <option value="Certificados de resid√™ncia permanente" ${migracao.tipo === 'Certificados de resid√™ncia permanente' ? 'selected' : ''}>Certificados de resid√™ncia permanente</option>
                                        <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                        <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                        <option value="Renova√ß√£o de autoriza√ß√µes" ${migracao.tipo === 'Renova√ß√£o de autoriza√ß√µes' ? 'selected' : ''}>Renova√ß√£o de autoriza√ß√µes</option>
                                        <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                        <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                        <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                        <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="migracaoValor" value="${migracao.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="migracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                            <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                            <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                            <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="migracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                            <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                            <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                    <input type="date" id="migracaoDataInicio" value="${migracao.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                    <textarea id="migracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Altera√ß√µes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            const modalAnterior = document.getElementById('modalEdicaoMigracao');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            // Adicionar ao body
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('‚úÖ Modal de edi√ß√£o de migra√ß√£o criado e adicionado ao body!');
        }

        function abrirModalEdicaoRegisto(registo) {
            console.log('üîß abrirModalEdicaoRegisto chamado com:', registo);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoRegisto';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = fecharModal;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Registo</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarRegisto(event, ${registo.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="registoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === registo.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="registoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autentica√ß√£o de documentos" ${registo.tipo === 'Autentica√ß√£o de documentos' ? 'selected' : ''}>Autentica√ß√£o de documentos</option>
                                            <option value="Certifica√ß√£o de fotoc√≥pias" ${registo.tipo === 'Certifica√ß√£o de fotoc√≥pias' ? 'selected' : ''}>Certifica√ß√£o de fotoc√≥pias</option>
                                            <option value="Documentos para o estrangeiro" ${registo.tipo === 'Documentos para o estrangeiro' ? 'selected' : ''}>Documentos para o estrangeiro</option>
                                            <option value="Procura√ß√µes" ${registo.tipo === 'Procura√ß√µes' ? 'selected' : ''}>Procura√ß√µes</option>
                                            <option value="Reconhecimento presencial de assinaturas" ${registo.tipo === 'Reconhecimento presencial de assinaturas' ? 'selected' : ''}>Reconhecimento presencial de assinaturas</option>
                                            <option value="Registos autom√≥veis" ${registo.tipo === 'Registos autom√≥veis' ? 'selected' : ''}>Registos autom√≥veis</option>
                                            <option value="Registos comerciais" ${registo.tipo === 'Registos comerciais' ? 'selected' : ''}>Registos comerciais</option>
                                            <option value="Registos de propriedade" ${registo.tipo === 'Registos de propriedade' ? 'selected' : ''}>Registos de propriedade</option>
                                            <option value="Termos de autentica√ß√£o" ${registo.tipo === 'Termos de autentica√ß√£o' ? 'selected' : ''}>Termos de autentica√ß√£o</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="registoValor" value="${registo.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="registoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${registo.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${registo.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${registo.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                                <option value="23" ${registo.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="registoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${registo.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${registo.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${registo.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                        <input type="date" id="registoDataInicio" value="${registo.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea id="registoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${registo.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            const modalAnterior = document.getElementById('modalEdicaoRegisto');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            // Adicionar ao body
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('‚úÖ Modal de edi√ß√£o de registo criado e adicionado ao body!');
        }

        function abrirModalEdicaoPrazo(prazo) {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Prazo</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarPrazo(event, ${prazo.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                                        <input type="text" id="prazoCliente" value="${prazo.clienteNome}" readonly class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                        <input type="text" id="prazoTipo" value="${prazo.tipo}" readonly class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o *</label>
                                        <textarea id="prazoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${prazo.descricao}</textarea>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Limite *</label>
                                            <input type="date" id="prazoDataLimite" value="${prazo.dataLimite}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                            <select id="prazoPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="baixa" ${prazo.prioridade === 'baixa' ? 'selected' : ''}>Baixa</option>
                                                <option value="media" ${prazo.prioridade === 'media' ? 'selected' : ''}>M√©dia</option>
                                                <option value="alta" ${prazo.prioridade === 'alta' ? 'selected' : ''}>Alta</option>
                                                <option value="critica" ${prazo.prioridade === 'critica' ? 'selected' : ''}>Cr√≠tica</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="prazoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="ativo" ${prazo.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                            <option value="concluido" ${prazo.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                            <option value="vencido" ${prazo.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                                            <option value="cancelado" ${prazo.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        // === FUN√á√ïES DE ATUALIZA√á√ÉO ===
        
        function atualizarContrato(event, id) {
            console.log('üîß atualizarContrato chamado com ID:', id);
            event.preventDefault();
            
            // Carregar contratos do localStorage se necess√°rio
            const contratosSalvos = localStorage.getItem('contratos');
            let contratosAtual = contratos;
            if (contratosSalvos && (!contratos || contratos.length === 0)) {
                contratosAtual = JSON.parse(contratosSalvos);
                contratos = contratosAtual;
                window.contratos = contratos;
                console.log('üîß Contratos carregados do localStorage:', contratosAtual.length);
            }
            
            // Converter ID para n√∫mero se necess√°rio
            const contratoId = typeof id === 'string' ? parseInt(id) : id;
            
            const contratoIndex = contratosAtual.findIndex(c => {
                const cId = typeof c.id === 'string' ? parseInt(c.id) : c.id;
                return cId === contratoId;
            });
            
            if (contratoIndex !== -1) {
                if (!exigirPermissaoAcao('editar', 'contrato')) {
                    return false;
                }
                const clienteId = document.getElementById('contratoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                // Obter e converter valores
                const valor = parseFloat(document.getElementById('contratoValor').value) || 0;
                const ivaPercent = parseFloat(document.getElementById('contratoIva').value) || 0;
                
                // Calcular IVA e valor total
                const valorIVA = (valor * ivaPercent) / 100;
                const valorTotal = valor + valorIVA;
                
                console.log('üîß Valores calculados:', { valor, ivaPercent, valorIVA, valorTotal });
                
                contratosAtual[contratoIndex] = {
                    ...contratosAtual[contratoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : contratosAtual[contratoIndex].clienteNome,
                    tipo: document.getElementById('contratoTipo').value,
                    valor: valor,
                    iva: ivaPercent,
                    valorIVA: valorIVA,
                    valorTotal: valorTotal,
                    status: document.getElementById('contratoStatus').value,
                    dataInicio: document.getElementById('contratoDataInicio').value,
                    dataFim: document.getElementById('contratoDataFim').value,
                    observacoes: document.getElementById('contratoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Atualizar array global
                contratos = contratosAtual;
                window.contratos = contratos;
                
                console.log('üîß Contrato atualizado:', contratosAtual[contratoIndex]);
                salvarDados('contratos', contratosAtual);
                mostrarNotificacao('Contrato atualizado com sucesso!', 'success');
                fecharModalRobusto();
                
                setTimeout(() => {
                    carregarSecao('contratos');
                }, 300);
            } else {
                console.error('‚ùå Contrato n√£o encontrado com ID:', contratoId);
                console.error('‚ùå Contratos dispon√≠veis:', contratosAtual.map(c => c.id));
                mostrarNotificacao('Contrato n√£o encontrado!', 'error');
            }
        }
        
        function atualizarHonorario(event, id) {
            event.preventDefault();
            
            const honorarioIndex = honorarios.findIndex(h => h.id === id);
            if (honorarioIndex !== -1) {
                if (!exigirPermissaoAcao('editar', 'honorario')) {
                    return false;
                }
                honorarios[honorarioIndex] = {
                    ...honorarios[honorarioIndex],
                    cliente: document.getElementById('honorarioCliente').value,
                    servico: document.getElementById('honorarioServico').value,
                    valor: document.getElementById('honorarioValor').value,
                    status: document.getElementById('honorarioStatus').value,
                    vencimento: document.getElementById('honorarioVencimento').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('honorarios', honorarios);
                mostrarNotificacao('Honor√°rio atualizado com sucesso!', 'success');
                fecharModal();
                carregarSecao('honorarios');
            }
        }

        function atualizarHeranca(event, id) {
            console.log('üîß atualizarHeranca chamado com ID:', id);
            event.preventDefault();
            
            // Buscar heran√ßas do localStorage
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) {
                herancas = JSON.parse(herancasSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const herancaIndex = herancas.findIndex(h => h.id === id);
            if (herancaIndex !== -1) {
                if (!exigirPermissaoAcao('editar', 'heranca')) {
                    return false;
                }
                const clienteId = document.getElementById('herancaClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                herancas[herancaIndex] = {
                    ...herancas[herancaIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : herancas[herancaIndex].clienteNome,
                    tipo: document.getElementById('herancaTipo').value,
                    valor: document.getElementById('herancaValor').value,
                    iva: document.getElementById('herancaIva').value,
                    status: document.getElementById('herancaStatus').value,
                    dataInicio: document.getElementById('herancaDataInicio').value,
                    observacoes: document.getElementById('herancaObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('herancas', herancas);
                mostrarNotificacao('Heran√ßa atualizada com sucesso!', 'success');
                
                // Fechar modal explicitamente
                console.log('üîß Fechando modal de heran√ßa...');
                fecharModal();
                
                // Aguardar um pouco antes de recarregar
                setTimeout(() => {
                    carregarSecao('herancas');
                }, 100);
                
                console.log('‚úÖ Heran√ßa atualizada com sucesso!');
            } else {
                console.error('‚ùå Heran√ßa n√£o encontrada com ID:', id);
                mostrarNotificacao('Erro: Heran√ßa n√£o encontrada!', 'error');
            }
        }
        
        // Tornar fun√ß√£o global
        window.atualizarHeranca = atualizarHeranca;

        function atualizarMigracao(event, id) {
            console.log('üîß atualizarMigracao chamado com ID:', id);
            event.preventDefault();
            
            // Buscar migra√ß√µes do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const migracaoIndex = migracoes.findIndex(m => m.id === id);
            if (migracaoIndex !== -1) {
                if (!exigirPermissaoAcao('editar', 'migracao')) {
                    return false;
                }
                const clienteId = document.getElementById('migracaoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                migracoes[migracaoIndex] = {
                    ...migracoes[migracaoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : migracoes[migracaoIndex].clienteNome,
                    tipo: document.getElementById('migracaoTipo').value,
                    valor: document.getElementById('migracaoValor').value,
                    iva: document.getElementById('migracaoIva').value,
                    status: document.getElementById('migracaoStatus').value,
                    dataInicio: document.getElementById('migracaoDataInicio').value,
                    observacoes: document.getElementById('migracaoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('migracoes', migracoes);
                mostrarNotificacao('Migra√ß√£o atualizada com sucesso!', 'success');
                
                // Fechar modal explicitamente
                console.log('üîß Fechando modal de migra√ß√£o...');
                fecharModal();
                
                // Aguardar um pouco antes de recarregar
                setTimeout(() => {
                    carregarSecao('migracoes');
                }, 100);
                
                console.log('‚úÖ Migra√ß√£o atualizada com sucesso!');
            } else {
                console.error('‚ùå Migra√ß√£o n√£o encontrada com ID:', id);
                mostrarNotificacao('Erro: Migra√ß√£o n√£o encontrada!', 'error');
            }
        }
        
        // Tornar fun√ß√£o global
        window.atualizarMigracao = atualizarMigracao;

        function atualizarRegisto(event, id) {
            console.log('üîß atualizarRegisto chamado com ID:', id);
            event.preventDefault();
            
            // Buscar registos do localStorage
            const registosSalvos = localStorage.getItem('registos');
            let registos = [];
            if (registosSalvos) {
                registos = JSON.parse(registosSalvos);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const registoIndex = registos.findIndex(r => r.id === id);
            if (registoIndex !== -1) {
                if (!exigirPermissaoAcao('editar', 'registo')) {
                    return false;
                }
                const clienteId = document.getElementById('registoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                registos[registoIndex] = {
                    ...registos[registoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : registos[registoIndex].clienteNome,
                    tipo: document.getElementById('registoTipo').value,
                    valor: document.getElementById('registoValor').value,
                    iva: document.getElementById('registoIva').value,
                    status: document.getElementById('registoStatus').value,
                    dataInicio: document.getElementById('registoDataInicio').value,
                    observacoes: document.getElementById('registoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('registos', registos);
                mostrarNotificacao('Registo atualizado com sucesso!', 'success');
                
                // Fechar modal explicitamente
                console.log('üîß Fechando modal de registo...');
                fecharModal();
                
                // Aguardar um pouco antes de recarregar
                setTimeout(() => {
                    carregarSecao('registos');
                }, 100);
                
                console.log('‚úÖ Registo atualizado com sucesso!');
            } else {
                console.error('‚ùå Registo n√£o encontrado com ID:', id);
                mostrarNotificacao('Erro: Registo n√£o encontrado!', 'error');
            }
        }
        
        // Tornar fun√ß√£o global
        window.atualizarRegisto = atualizarRegisto;
        
        // === FUN√á√ÉO SIMPLES PARA SALVAR HERAN√áA EDITADA ===
        function salvarHerancaEditada(event, id) {
            event.preventDefault();
            
            // Buscar heran√ßas do localStorage
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) {
                herancas = JSON.parse(herancasSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Encontrar a heran√ßa
            const herancaIndex = herancas.findIndex(h => h.id === id);
            if (herancaIndex !== -1) {
                const clienteId = document.getElementById('editClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                // Atualizar os dados
                herancas[herancaIndex] = {
                    ...herancas[herancaIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : herancas[herancaIndex].clienteNome,
                    tipo: document.getElementById('editTipo').value,
                    valor: document.getElementById('editValor').value,
                    iva: document.getElementById('editIva').value,
                    status: document.getElementById('editStatus').value,
                    dataInicio: document.getElementById('editDataInicio').value,
                    observacoes: document.getElementById('editObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('herancas', JSON.stringify(herancas));
                mostrarNotificacao('Heran√ßa atualizada com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoHeranca');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar se√ß√£o
                carregarSecao('herancas');
            }
        }
        
        // Tornar fun√ß√£o global
        window.salvarHerancaEditada = salvarHerancaEditada;
        
        // === FUN√á√ÉO PARA SALVAR MIGRA√á√ÉO EDITADA ===
        function salvarMigracaoEditada(event, id) {
            event.preventDefault();
            
            // Buscar migra√ß√µes do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Encontrar a migra√ß√£o
            const migracaoIndex = migracoes.findIndex(m => m.id === id);
            if (migracaoIndex !== -1) {
                const clienteId = document.getElementById('editMigracaoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                // Atualizar os dados
                migracoes[migracaoIndex] = {
                    ...migracoes[migracaoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : migracoes[migracaoIndex].clienteNome,
                    tipo: document.getElementById('editMigracaoTipo').value,
                    valor: document.getElementById('editMigracaoValor').value,
                    iva: document.getElementById('editMigracaoIva').value,
                    status: document.getElementById('editMigracaoStatus').value,
                    dataInicio: document.getElementById('editMigracaoDataInicio').value,
                    observacoes: document.getElementById('editMigracaoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('migracoes', JSON.stringify(migracoes));
                mostrarNotificacao('Migra√ß√£o atualizada com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoMigracao');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar se√ß√£o ap√≥s um pequeno delay
                setTimeout(() => {
                    carregarSecao('migracoes');
                }, 100);
            }
        }
        
        // Tornar fun√ß√£o global
        window.salvarMigracaoEditada = salvarMigracaoEditada;
        
        // === FUN√á√ÉO PARA SALVAR REGISTO EDITADO ===
        function salvarRegistoEditado(event, id) {
            event.preventDefault();
            
            // Buscar registos do localStorage
            const registosSalvos = localStorage.getItem('registos');
            let registos = [];
            if (registosSalvos) {
                registos = JSON.parse(registosSalvos);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Encontrar o registo
            const registoIndex = registos.findIndex(r => r.id === id);
            if (registoIndex !== -1) {
                const clienteId = document.getElementById('editRegistoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                // Atualizar os dados
                registos[registoIndex] = {
                    ...registos[registoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : registos[registoIndex].clienteNome,
                    tipo: document.getElementById('editRegistoTipo').value,
                    valor: document.getElementById('editRegistoValor').value,
                    iva: document.getElementById('editRegistoIva').value,
                    status: document.getElementById('editRegistoStatus').value,
                    dataInicio: document.getElementById('editRegistoDataInicio').value,
                    observacoes: document.getElementById('editRegistoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('registos', JSON.stringify(registos));
                mostrarNotificacao('Registo atualizado com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoRegisto');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar se√ß√£o ap√≥s um pequeno delay
                setTimeout(() => {
                    carregarSecao('registos');
                    // For√ßar atualiza√ß√£o da lista
                    if (typeof atualizarListaRegistos === 'function') {
                        atualizarListaRegistos(registos);
                    }
                }, 100);
            }
        }
        
        // Tornar fun√ß√£o global
        window.salvarRegistoEditado = salvarRegistoEditado;

        // === FUN√á√ÉO PARA CONTROLAR MENU MOBILE ===
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
        }
        
        // Fechar sidebar ao clicar fora (mobile)
        document.addEventListener('click', function(event) {
            try {
                const sidebar = document.getElementById('sidebar');
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                
                if (window.innerWidth <= 1024 && sidebar && mobileMenuBtn) {
                    if (!sidebar.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                        sidebar.classList.remove('open');
                    }
                }
            } catch (error) {
                console.log('Erro no evento de click:', error);
            }
        });
        
        // Fechar sidebar ao redimensionar para desktop
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar && window.innerWidth > 1024) {
                sidebar.classList.remove('open');
            }
        });

        // === FUN√á√ÉO PARA CONTROLAR VISIBILIDADE DO NOME DA PARCERIA ===
        
        function toggleParceriaNome(tipo) {
            const parceriaSelect = document.getElementById(`${tipo}Parceria`) || document.querySelector(`select[name="parceria"]`);
            const nomeDiv = document.getElementById(`${tipo}ParceriaNomeDiv`) || document.getElementById(`${tipo}ParceriaNomeDiv`);
            
            if (parceriaSelect && nomeDiv) {
                if (parceriaSelect.value === 'empresa' || parceriaSelect.value === 'pessoa') {
                    nomeDiv.style.display = 'block';
                } else {
                    nomeDiv.style.display = 'none';
                }
            }
        }

        // === FUN√á√ïES ESPEC√çFICAS DE EDI√á√ÉO E EXCLUS√ÉO PARA √ÅREAS DE ATUA√á√ÉO ===
        
        function editarHeranca(id) {
            // Buscar heran√ßa diretamente do localStorage
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) {
                herancas = JSON.parse(herancasSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const heranca = herancas.find(h => h.id === id);
            if (heranca) {
                // Fechar qualquer modal aberto
                fecharModal();
                
                // Criar modal com layout original
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoHeranca';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Heran√ßa</h3>
                                <button onclick="document.getElementById('modalEdicaoHeranca').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarHerancaEditada(event, ${id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === heranca.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Aceita√ß√£o da heran√ßa" ${heranca.tipo === 'Aceita√ß√£o da heran√ßa' ? 'selected' : ''}>Aceita√ß√£o da heran√ßa</option>
                                            <option value="Doa√ß√µes" ${heranca.tipo === 'Doa√ß√µes' ? 'selected' : ''}>Doa√ß√µes</option>
                                            <option value="Escrituras de partilha" ${heranca.tipo === 'Escrituras de partilha' ? 'selected' : ''}>Escrituras de partilha</option>
                                            <option value="Habilita√ß√£o de herdeiros" ${heranca.tipo === 'Habilita√ß√£o de herdeiros' ? 'selected' : ''}>Habilita√ß√£o de herdeiros</option>
                                            <option value="Partilhas em vida" ${heranca.tipo === 'Partilhas em vida' ? 'selected' : ''}>Partilhas em vida</option>
                                            <option value="Partilhas por √≥bito" ${heranca.tipo === 'Partilhas por √≥bito' ? 'selected' : ''}>Partilhas por √≥bito</option>
                                            <option value="Processo de invent√°rio" ${heranca.tipo === 'Processo de invent√°rio' ? 'selected' : ''}>Processo de invent√°rio</option>
                                            <option value="Ren√∫ncia √† heran√ßa" ${heranca.tipo === 'Ren√∫ncia √† heran√ßa' ? 'selected' : ''}>Ren√∫ncia √† heran√ßa</option>
                                            <option value="Testamentos" ${heranca.tipo === 'Testamentos' ? 'selected' : ''}>Testamentos</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editValor" value="${heranca.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${heranca.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${heranca.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${heranca.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                                <option value="23" ${heranca.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${heranca.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${heranca.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${heranca.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                        <input type="date" id="editDataInicio" value="${heranca.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea id="editObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${heranca.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoHeranca').remove()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
            }
        }

        function excluirHeranca(id) {
            excluirItem('heranca', id);
        }

        function editarMigracao(id) {
            // Buscar migra√ß√£o diretamente do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const migracao = migracoes.find(m => m.id === id);
            if (migracao) {
                // Fechar qualquer modal aberto
                fecharModal();
                
                // Criar modal com layout original
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoMigracao';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Migra√ß√£o</h3>
                                <button onclick="document.getElementById('modalEdicaoMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarMigracaoEditada(event, ${id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editMigracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editMigracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autoriza√ß√£o de resid√™ncia" ${migracao.tipo === 'Autoriza√ß√£o de resid√™ncia' ? 'selected' : ''}>Autoriza√ß√£o de resid√™ncia</option>
                                            <option value="Certificados de resid√™ncia permanente" ${migracao.tipo === 'Certificados de resid√™ncia permanente' ? 'selected' : ''}>Certificados de resid√™ncia permanente</option>
                                            <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                            <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                            <option value="Renova√ß√£o de autoriza√ß√µes" ${migracao.tipo === 'Renova√ß√£o de autoriza√ß√µes' ? 'selected' : ''}>Renova√ß√£o de autoriza√ß√µes</option>
                                            <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                            <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                            <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                            <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editMigracaoValor" value="${migracao.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editMigracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                                <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editMigracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                        <input type="date" id="editMigracaoDataInicio" value="${migracao.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea id="editMigracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoMigracao').remove()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
            }
        }

        function excluirMigracao(id) {
            excluirItem('migracao', id);
        }

        function editarRegisto(id) {
            // Buscar registo diretamente do localStorage
            const registosSalvos = localStorage.getItem('registos');
            let registos = [];
            if (registosSalvos) {
                registos = JSON.parse(registosSalvos);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const registo = registos.find(r => r.id === id);
            if (registo) {
                // Fechar qualquer modal aberto
                fecharModal();
                
                // Criar modal com layout original
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoRegisto';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Registo</h3>
                                <button onclick="document.getElementById('modalEdicaoRegisto').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarRegistoEditado(event, ${id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editRegistoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === registo.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editRegistoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autentica√ß√£o de documentos" ${registo.tipo === 'Autentica√ß√£o de documentos' ? 'selected' : ''}>Autentica√ß√£o de documentos</option>
                                            <option value="Certifica√ß√£o de fotoc√≥pias" ${registo.tipo === 'Certifica√ß√£o de fotoc√≥pias' ? 'selected' : ''}>Certifica√ß√£o de fotoc√≥pias</option>
                                            <option value="Documentos para o estrangeiro" ${registo.tipo === 'Documentos para o estrangeiro' ? 'selected' : ''}>Documentos para o estrangeiro</option>
                                            <option value="Procura√ß√µes" ${registo.tipo === 'Procura√ß√µes' ? 'selected' : ''}>Procura√ß√µes</option>
                                            <option value="Reconhecimento presencial de assinaturas" ${registo.tipo === 'Reconhecimento presencial de assinaturas' ? 'selected' : ''}>Reconhecimento presencial de assinaturas</option>
                                            <option value="Registos autom√≥veis" ${registo.tipo === 'Registos autom√≥veis' ? 'selected' : ''}>Registos autom√≥veis</option>
                                            <option value="Registos comerciais" ${registo.tipo === 'Registos comerciais' ? 'selected' : ''}>Registos comerciais</option>
                                            <option value="Registos de propriedade" ${registo.tipo === 'Registos de propriedade' ? 'selected' : ''}>Registos de propriedade</option>
                                            <option value="Termos de autentica√ß√£o" ${registo.tipo === 'Termos de autentica√ß√£o' ? 'selected' : ''}>Termos de autentica√ß√£o</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editRegistoValor" value="${registo.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editRegistoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${registo.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${registo.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${registo.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                                <option value="23" ${registo.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editRegistoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${registo.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${registo.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${registo.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                        <input type="date" id="editRegistoDataInicio" value="${registo.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea id="editRegistoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${registo.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoRegisto').remove()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
            }
        }

        function excluirRegisto(id) {
            excluirItem('registo', id);
        }
        
        // === FUN√á√ïES DE FILTRO PARA MIGRA√á√ïES ===
        function filtrarMigracoes() {
            aplicarFiltrosMigracoes();
        }

        function aplicarFiltrosMigracoes() {
            const busca = document.getElementById('buscaMigracoes')?.value.toLowerCase() || '';
            const statusFiltro = document.getElementById('filtroStatusMigracao')?.value || '';
            const tipoFiltro = document.getElementById('filtroTipoMigracao')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinMigracao')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxMigracao')?.value) || Infinity;
            const nif = document.getElementById('filtroNifMigracao')?.value || '';

            const migracoesFiltradas = migracoes.filter(migracao => {
                const matchBusca = !busca || 
                    (migracao.clienteNome?.toLowerCase().includes(busca)) ||
                    (migracao.tipo?.toLowerCase().includes(busca));
                
                const matchStatus = !statusFiltro || migracao.status === statusFiltro;
                const matchTipo = !tipoFiltro || migracao.tipo === tipoFiltro;
                const valor = parseFloat(migracao.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;

                // Filtro por NIF
                const cliente = clientes.find(c => c.id === migracao.clienteId);
                const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));

                return matchBusca && matchStatus && matchTipo && matchValor && matchNif;
            });

            // Atualizar tabela
            const tbody = document.getElementById('listaMigracoes');
            if (tbody) {
                tbody.innerHTML = migracoesFiltradas.map(migracao => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${migracao.clienteNome || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.tipo || 'N/A'}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${migracao.descricao || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div class="text-sm font-bold text-black">‚Ç¨${(migracao.valor || 0).toFixed(2)}</div>
                            <div class="text-xs font-bold text-red-600">+ IVA: ‚Ç¨${((migracao.valor || 0) + ((migracao.valor || 0) * (migracao.iva || 0) / 100)).toFixed(2)}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-badge status-${migracao.status}">${migracao.status === 'concluido' ? 'Conclu√≠do' : migracao.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.dataInicio ? new Date(migracao.dataInicio).toLocaleDateString('pt-PT') : 'Data n√£o definida'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="console.log('üîß Bot√£o editar clicado para ID:', ${migracao.id}); editarMigracaoDireto(${migracao.id})" class="text-blue-600 hover:text-blue-900 mr-3" title="Editar">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button onclick="abrirAnexosMigracao(${migracao.id})" class="text-green-600 hover:text-green-900 mr-3" title="Documentos">
                                <i data-lucide="paperclip" class="w-4 h-4"></i>
                            </button>
                            <button onclick="console.log('üîß Bot√£o excluir clicado para ID:', ${migracao.id}); excluirMigracaoDireto(${migracao.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            // Atualizar contador
            const contador = document.getElementById('contadorMigracoes');
            if (contador) {
                contador.textContent = migracoesFiltradas.length;
            }

            // Recriar √≠cones
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function limparFiltrosMigracoes() {
            const elementos = [
                'buscaMigracoes',
                'filtroStatusMigracao', 
                'filtroTipoMigracao',
                'filtroValorMinMigracao',
                'filtroValorMaxMigracao',
                'filtroNifMigracao'
            ];
            
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.value = '';
                }
            });
            
            aplicarFiltrosMigracoes();
        }

        function abrirAnexosMigracao(id) {
            const migracao = migracoes.find(m => m.id === id);
            if (migracao) {
                abrirModalAnexos('migracao', id, migracao.clienteNome || 'Migra√ß√£o');
            }
        }

        // === FUN√á√ÉO DE EDI√á√ÉO PADR√ÉO ===
        function abrirModalEdicaoMigracao(migracao) {
            console.log('üîß abrirModalEdicaoMigracao chamado com:', migracao);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            console.log('üîß Clientes encontrados:', clientes.length);
            
            if (migracao) {
                console.log('üîß Fechando modal...');
                // Fechar qualquer modal aberto
                fecharModal();
                
                console.log('üîß Criando modal...');
                // Criar modal com layout padr√£o
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoMigracao';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Migra√ß√£o</h3>
                                <button onclick="document.getElementById('modalEdicaoMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarMigracaoEditada(event, ${id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editMigracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editMigracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autoriza√ß√£o de resid√™ncia" ${migracao.tipo === 'Autoriza√ß√£o de resid√™ncia' ? 'selected' : ''}>Autoriza√ß√£o de resid√™ncia</option>
                                            <option value="Certificados de resid√™ncia permanente" ${migracao.tipo === 'Certificados de resid√™ncia permanente' ? 'selected' : ''}>Certificados de resid√™ncia permanente</option>
                                            <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                            <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                            <option value="Renova√ß√£o de autoriza√ß√µes" ${migracao.tipo === 'Renova√ß√£o de autoriza√ß√µes' ? 'selected' : ''}>Renova√ß√£o de autoriza√ß√µes</option>
                                            <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                            <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                            <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                            <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editMigracaoValor" value="${migracao.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editMigracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                                <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editMigracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                        <input type="date" id="editMigracaoDataInicio" value="${migracao.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea id="editMigracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoMigracao').remove()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
                console.log('üîß Modal de edi√ß√£o de migra√ß√£o inserido no DOM!');
            } else {
                console.log('üîß Erro: migra√ß√£o n√£o encontrada!');
            }
        }
        
        // === FUN√á√ÉO DE SALVAR PADR√ÉO ===
        function salvarMigracaoEditada(event, id) {
            event.preventDefault();
            console.log('üîß salvarMigracaoEditada chamado para ID:', id);
            
            // Buscar migra√ß√µes do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Encontrar a migra√ß√£o
            const migracaoIndex = migracoes.findIndex(m => m.id == id);
            console.log('üîß √çndice da migra√ß√£o encontrado:', migracaoIndex);
            
            if (migracaoIndex !== -1) {
                const clienteId = parseInt(document.getElementById('editMigracaoClienteId').value);
                const cliente = clientes.find(c => c.id === clienteId);
                
                const valor = parseFloat(document.getElementById('editMigracaoValor').value);
                const ivaPercent = parseFloat(document.getElementById('editMigracaoIva').value);
                const valorIVA = (valor * ivaPercent) / 100;
                const valorComIva = valor + valorIVA;
                
                // Atualizar os dados
                migracoes[migracaoIndex] = {
                    ...migracoes[migracaoIndex],
                    clienteId: clienteId,
                    clienteNome: cliente ? cliente.nome : migracoes[migracaoIndex].clienteNome,
                    tipo: document.getElementById('editMigracaoTipo').value,
                    valor: valor,
                    iva: ivaPercent,
                    valorIVA: valorIVA,
                    valorComIva: valorComIva,
                    status: document.getElementById('editMigracaoStatus').value,
                    dataInicio: document.getElementById('editMigracaoDataInicio').value,
                    observacoes: document.getElementById('editMigracaoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                console.log('üîß Migra√ß√£o atualizada:', migracoes[migracaoIndex]);
                
                // Salvar no localStorage
                localStorage.setItem('migracoes', JSON.stringify(migracoes));
                window.migracoes = migracoes;
                
                mostrarNotificacao('Migra√ß√£o atualizada com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoMigracao');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar se√ß√£o
                setTimeout(() => {
                    carregarSecao('migracoes');
                }, 100);
            } else {
                console.log('üîß Migra√ß√£o n√£o encontrada para atualizar!');
                mostrarNotificacao('Erro: Migra√ß√£o n√£o encontrada!', 'error');
            }
        }
        
        // Tornar fun√ß√£o global
        window.salvarMigracaoEditada = salvarMigracaoEditada;
        
        // === FUN√á√ÉO PARA ANEXOS DE CONTRATOS ===
        function abrirAnexosContrato(id) {
            const contrato = contratos.find(c => c.id === id);
            if (contrato) {
                abrirModalAnexos('contrato', id, contrato.clienteNome || 'Contrato');
            }
        }

        // === FUN√á√ÉO PARA ANEXOS DE HERAN√áAS ===
        function abrirAnexosHeranca(id) {
            const heranca = herancas.find(h => h.id === id);
            if (heranca) {
                abrirModalAnexos('heranca', id, heranca.clienteNome || 'Heran√ßa');
            }
        }

        // === FUN√á√ÉO PARA ANEXOS DE MIGRA√á√ïES ===
        function abrirAnexosMigracao(id) {
            const migracao = migracoes.find(m => m.id === id);
            if (migracao) {
                abrirModalAnexos('migracao', id, migracao.clienteNome || 'Migra√ß√£o');
            }
        }

        // === FUN√á√ÉO PARA ANEXOS DE REGISTOS ===
        function abrirAnexosRegisto(id) {
            const registo = registos.find(r => r.id === id);
            if (registo) {
                abrirModalAnexos('registo', id, registo.clienteNome || 'Registo');
            }
        }

        // === FUN√á√ÉO PRINCIPAL PARA ABRIR MODAL DE ANEXOS ===
        function abrirModalAnexos(tipo, id, nome) {
            console.log('üîß abrirModalAnexos chamado:', tipo, id, nome);
            
            // Fechar qualquer modal aberto primeiro
            fecharModal();
            
            // Buscar dados do localStorage
            let dados = [];
            let item = null;
            
            if (tipo === 'contrato') {
                const contratosSalvos = localStorage.getItem('contratos');
                if (contratosSalvos) {
                    dados = JSON.parse(contratosSalvos);
                }
                item = dados.find(c => c.id === id);
            } else if (tipo === 'heranca') {
                const herancasSalvas = localStorage.getItem('herancas');
                if (herancasSalvas) {
                    dados = JSON.parse(herancasSalvas);
                }
                item = dados.find(h => h.id === id);
            } else if (tipo === 'migracao') {
                const migracoesSalvas = localStorage.getItem('migracoes');
                if (migracoesSalvas) {
                    dados = JSON.parse(migracoesSalvas);
                }
                item = dados.find(m => m.id === id);
            } else if (tipo === 'registo') {
                const registosSalvos = localStorage.getItem('registos');
                if (registosSalvos) {
                    dados = JSON.parse(registosSalvos);
                }
                item = dados.find(r => r.id === id);
            }
            
            if (!item) {
                mostrarNotificacao('Item n√£o encontrado!', 'error');
                return;
            }
            
            // Inicializar array de anexos se n√£o existir
            if (!item.anexos) {
                item.anexos = [];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos de ${nome}</h3>
                                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <!-- Upload de novos documentos -->
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexo${tipo.charAt(0).toUpperCase() + tipo.slice(1)}(event, ${id})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('${tipo}')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="documento">Documento</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="certificado">Certificado</option>
                                                <option value="contrato">Contrato</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizado${tipo.charAt(0).toUpperCase() + tipo.slice(1)}" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descri√ß√£o do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Lista de documentos existentes -->
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${item.anexos.length})</h4>
                                ${item.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${item.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} ‚Ä¢ ${anexo.tamanho} ‚Ä¢ ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexo${tipo.charAt(0).toUpperCase() + tipo.slice(1)}(${id}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Adicionar modal ao body
            const modalElement = document.createElement('div');
            modalElement.innerHTML = modal;
            document.body.appendChild(modalElement.firstElementChild);
            lucide.createIcons();
        }

        // === FUN√á√ïES PARA ADICIONAR ANEXOS ===
        function adicionarAnexoContrato(event, contratoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const contrato = contratos.find(c => c.id === contratoId);
                if (contrato) {
                    if (!contrato.anexos) contrato.anexos = [];
                    contrato.anexos.push(anexo);
                    salvarDados('contratos', contratos);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    abrirAnexosContrato(contratoId);
                }
            });
        }

        function adicionarAnexoHeranca(event, herancaId) {
            console.log('üîß adicionarAnexoHeranca chamado com ID:', herancaId);
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            console.log('üîß Dados do formul√°rio:', { nome, tipoSelecionado, arquivo: arquivo?.name, descricao });
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const heranca = herancas.find(h => h.id === herancaId);
                console.log('üîß Heran√ßa encontrada:', heranca);
                if (heranca) {
                    if (!heranca.anexos) heranca.anexos = [];
                    heranca.anexos.push(anexo);
                    console.log('üîß Anexo adicionado:', anexo);
                    console.log('üîß Heran√ßa atualizada:', heranca);
                    salvarDados('herancas', herancas);
                    console.log('‚úÖ Dados salvos no localStorage');
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    abrirAnexosHeranca(herancaId);
                } else {
                    console.error('‚ùå Heran√ßa n√£o encontrada com ID:', herancaId);
                    mostrarNotificacao('Heran√ßa n√£o encontrada!', 'error');
                }
            });
        }

        function adicionarAnexoMigracao(event, migracaoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const migracao = migracoes.find(m => m.id === migracaoId);
                if (migracao) {
                    if (!migracao.anexos) migracao.anexos = [];
                    migracao.anexos.push(anexo);
                    salvarDados('migracoes', migracoes);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    abrirAnexosMigracao(migracaoId);
                }
            });
        }

        function adicionarAnexoRegisto(event, registoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const registo = registos.find(r => r.id === registoId);
                if (registo) {
                    if (!registo.anexos) registo.anexos = [];
                    registo.anexos.push(anexo);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    abrirAnexosRegisto(registoId);
                }
            });
        }

        // === FUN√á√ïES PARA REMOVER ANEXOS ===
        function removerAnexoContrato(contratoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const contrato = contratos.find(c => c.id === contratoId);
                if (contrato && contrato.anexos) {
                    contrato.anexos = contrato.anexos.filter(a => a.id !== anexoId);
                    salvarDados('contratos', contratos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosContrato(contratoId);
                }
            }
        }

        function removerAnexoHeranca(herancaId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const heranca = herancas.find(h => h.id === herancaId);
                if (heranca && heranca.anexos) {
                    heranca.anexos = heranca.anexos.filter(a => a.id !== anexoId);
                    salvarDados('herancas', herancas);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosHeranca(herancaId);
                }
            }
        }

        function removerAnexoMigracao(migracaoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const migracao = migracoes.find(m => m.id === migracaoId);
                if (migracao && migracao.anexos) {
                    migracao.anexos = migracao.anexos.filter(a => a.id !== anexoId);
                    salvarDados('migracoes', migracoes);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosMigracao(migracaoId);
                }
            }
        }

        function removerAnexoRegisto(registoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const registo = registos.find(r => r.id === registoId);
                if (registo && registo.anexos) {
                    registo.anexos = registo.anexos.filter(a => a.id !== anexoId);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosRegisto(registoId);
                }
            }
        }

        // === FUN√á√ÉO PARA TOGGLE TIPO PERSONALIZADO ===
        function toggleTipoPersonalizado(tipo) {
            const select = document.getElementById('tipoDocumento');
            const divPersonalizado = document.getElementById(`tipoPersonalizado${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
            
            if (select.value === 'outro') {
                divPersonalizado.classList.remove('hidden');
            } else {
                divPersonalizado.classList.add('hidden');
            }
        }

        // === FUN√á√ïES DIRETAS PARA CONTRATOS ===
        function editarContratoDireto(id) {
            console.log('üîß editarContratoDireto chamado com ID:', id);
            const contratosSalvos = localStorage.getItem('contratos');
            let contratos = [];
            if (contratosSalvos) contratos = JSON.parse(contratosSalvos);
            const contrato = contratos.find(c => c.id === id);
            if (contrato) {
                fecharModal();
                setTimeout(() => abrirModalEdicaoContrato(contrato), 100);
            } else {
                mostrarNotificacao('Contrato n√£o encontrado!', 'error');
            }
        }

        function excluirContratoDireto(id) {
            if (confirm('Tem certeza que deseja excluir este contrato? Esta a√ß√£o n√£o pode ser desfeita.')) {
                const contratosSalvos = localStorage.getItem('contratos');
                let contratos = [];
                if (contratosSalvos) contratos = JSON.parse(contratosSalvos);
                contratos = contratos.filter(c => c.id !== id);
                localStorage.setItem('contratos', JSON.stringify(contratos));
                window.contratos = contratos;
                mostrarNotificacao('Contrato exclu√≠do com sucesso!', 'success');
                carregarSecao('contratos');
            }
        }

        // === FUN√á√ïES DIRETAS PARA HERAN√áAS ===
        function editarHerancaDireto(id) {
            console.log('üîß editarHerancaDireto chamado com ID:', id);
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
            const heranca = herancas.find(h => h.id === id);
            if (heranca) {
                fecharModal();
                setTimeout(() => abrirModalEdicaoHeranca(heranca), 100);
            } else {
                mostrarNotificacao('Heran√ßa n√£o encontrada!', 'error');
            }
        }

        function excluirHerancaDireto(id) {
            if (confirm('Tem certeza que deseja excluir esta heran√ßa? Esta a√ß√£o n√£o pode ser desfeita.')) {
                const herancasSalvas = localStorage.getItem('herancas');
                let herancas = [];
                if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
                herancas = herancas.filter(h => h.id !== id);
                localStorage.setItem('herancas', JSON.stringify(herancas));
                window.herancas = herancas;
                mostrarNotificacao('Heran√ßa exclu√≠da com sucesso!', 'success');
                carregarSecao('herancas');
            }
        }

        // === FUN√á√ïES DIRETAS PARA MIGRA√á√ïES ===
        function editarMigracaoDireto(id) {
            console.log('üîß editarMigracaoDireto chamado com ID:', id);
            
            // Buscar migra√ß√µes do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            const migracao = migracoes.find(m => m.id == id);
            console.log('üîß Migra√ß√£o encontrada:', migracao);
            
            if (migracao) {
                // Fechar qualquer modal existente
                fecharModal();
                
                // Criar modal simples de edi√ß√£o
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoMigracao';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                // Buscar clientes do localStorage
                const clientesSalvos = localStorage.getItem('clientes');
                let clientes = [];
                if (clientesSalvos) {
                    clientes = JSON.parse(clientesSalvos);
                }
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Migra√ß√£o</h3>
                                <button onclick="document.getElementById('modalEdicaoMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarMigracaoEditada(event, ${migracao.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editMigracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editMigracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autoriza√ß√£o de resid√™ncia" ${migracao.tipo === 'Autoriza√ß√£o de resid√™ncia' ? 'selected' : ''}>Autoriza√ß√£o de resid√™ncia</option>
                                            <option value="Certificados de resid√™ncia permanente" ${migracao.tipo === 'Certificados de resid√™ncia permanente' ? 'selected' : ''}>Certificados de resid√™ncia permanente</option>
                                            <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                            <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                            <option value="Renova√ß√£o de autoriza√ß√µes" ${migracao.tipo === 'Renova√ß√£o de autoriza√ß√µes' ? 'selected' : ''}>Renova√ß√£o de autoriza√ß√µes</option>
                                            <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                            <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                            <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                            <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editMigracaoValor" value="${migracao.valor || ''}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editMigracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                                <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editMigracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                        <input type="date" id="editMigracaoDataInicio" value="${migracao.dataInicio || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea id="editMigracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoMigracao').remove()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
                console.log('üîß Modal de edi√ß√£o criado e inserido no DOM!');
            } else {
                mostrarNotificacao('Migra√ß√£o n√£o encontrada!', 'error');
            }
        }

        function excluirMigracaoDireto(id) {
            console.log('üîß excluirMigracaoDireto chamado com ID:', id);
            if (confirm('Tem certeza que deseja excluir esta migra√ß√£o? Esta a√ß√£o n√£o pode ser desfeita.')) {
                // Buscar migra√ß√µes do localStorage
                const migracoesSalvas = localStorage.getItem('migracoes');
                let migracoes = [];
                if (migracoesSalvas) {
                    migracoes = JSON.parse(migracoesSalvas);
                }
                
                // Filtrar para remover a migra√ß√£o
                migracoes = migracoes.filter(m => m.id != id);
                
                // Salvar no localStorage
                localStorage.setItem('migracoes', JSON.stringify(migracoes));
                
                // Atualizar array global
                window.migracoes = migracoes;
                
                mostrarNotificacao('Migra√ß√£o exclu√≠da com sucesso!', 'success');
                
                // Recarregar se√ß√£o
                carregarSecao('migracoes');
            }
        }

        // === SISTEMA DE IVA TRIMESTRAL ===
        
        // Fun√ß√£o para determinar o trimestre atual
        function obterTrimestreAtual() {
            const agora = new Date();
            const mes = agora.getMonth() + 1; // Janeiro = 1, Dezembro = 12
            
            if (mes >= 1 && mes <= 3) return 1; // 1¬∫ Trimestre (Jan-Mar)
            if (mes >= 4 && mes <= 6) return 2; // 2¬∫ Trimestre (Abr-Jun)
            if (mes >= 7 && mes <= 9) return 3; // 3¬∫ Trimestre (Jul-Set)
            if (mes >= 10 && mes <= 12) return 4; // 4¬∫ Trimestre (Out-Dez)
        }
        
        // Fun√ß√£o para obter datas de prazo do IVA
        function obterPrazosIVA(trimestre) {
            const ano = new Date().getFullYear();
            const prazos = {
                1: { // 1¬∫ Trimestre
                    entrega: `${ano}-05-20`,
                    pagamento: `${ano}-05-25`,
                    periodo: 'Janeiro a Mar√ßo'
                },
                2: { // 2¬∫ Trimestre
                    entrega: `${ano}-07-20`,
                    pagamento: `${ano}-07-25`,
                    periodo: 'Abril a Junho'
                },
                3: { // 3¬∫ Trimestre
                    entrega: `${ano}-11-20`,
                    pagamento: `${ano}-11-25`,
                    periodo: 'Julho a Setembro'
                },
                4: { // 4¬∫ Trimestre
                    entrega: `${ano + 1}-02-20`,
                    pagamento: `${ano + 1}-02-25`,
                    periodo: 'Outubro a Dezembro'
                }
            };
            return prazos[trimestre];
        }
        
        // Fun√ß√£o para calcular IVA acumulado por trimestre
        function calcularIVATrimestral_REMOVED() {
            const trimestreAtual = obterTrimestreAtual();
            const ano = new Date().getFullYear();
            
            // Buscar todos os dados
            const contratosSalvos = localStorage.getItem('contratos');
            const herancasSalvas = localStorage.getItem('herancas');
            const migracoesSalvas = localStorage.getItem('migracoes');
            const registosSalvos = localStorage.getItem('registos');
            
            let contratos = [], herancas = [], migracoes = [], registos = [];
            if (contratosSalvos) contratos = JSON.parse(contratosSalvos);
            if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
            if (migracoesSalvas) migracoes = JSON.parse(migracoesSalvas);
            if (registosSalvos) registos = JSON.parse(registosSalvos);
            
            const todosItens = [...contratos, ...herancas, ...migracoes, ...registos];
            
            // Calcular IVA por trimestre
            const ivaPorTrimestre = {
                1: { valor: 0, itens: 0, periodo: 'Janeiro a Mar√ßo' },
                2: { valor: 0, itens: 0, periodo: 'Abril a Junho' },
                3: { valor: 0, itens: 0, periodo: 'Julho a Setembro' },
                4: { valor: 0, itens: 0, periodo: 'Outubro a Dezembro' }
            };
            
            todosItens.forEach(item => {
                if (item.dataInicio) {
                    const dataInicio = new Date(item.dataInicio);
                    const mes = dataInicio.getMonth() + 1;
                    
                    let trimestre;
                    if (mes >= 1 && mes <= 3) trimestre = 1;
                    else if (mes >= 4 && mes <= 6) trimestre = 2;
                    else if (mes >= 7 && mes <= 9) trimestre = 3;
                    else if (mes >= 10 && mes <= 12) trimestre = 4;
                    
                    if (trimestre && item.valorIVA) {
                        ivaPorTrimestre[trimestre].valor += parseFloat(item.valorIVA) || 0;
                        ivaPorTrimestre[trimestre].itens += 1;
                    }
                }
            });
            
            return { ivaPorTrimestre, trimestreAtual };
        }
        
        // Fun√ß√£o para criar prazos autom√°ticos de IVA
        function criarPrazosIVA() {
            const trimestreAtual = obterTrimestreAtual();
            const prazos = obterPrazosIVA(trimestreAtual);
            
            // Verificar se j√° existem prazos de IVA para este trimestre
            const prazosSalvos = localStorage.getItem('prazos');
            let prazosExistentes = [];
            if (prazosSalvos) prazosExistentes = JSON.parse(prazosSalvos);
            
            const prazoEntregaExiste = prazosExistentes.some(p => 
                p.tipo === 'iva_entrega' && p.dataLimite === prazos.entrega
            );
            
            const prazoPagamentoExiste = prazosExistentes.some(p => 
                p.tipo === 'iva_pagamento' && p.dataLimite === prazos.pagamento
            );
            
            // Criar prazo de entrega se n√£o existir
            if (!prazoEntregaExiste) {
                const prazoEntrega = {
                    id: Date.now() + 1,
                    clienteId: 0,
                    clienteNome: 'Sistema',
                    descricao: `Entrega da declara√ß√£o de IVA - ${prazos.periodo}`,
                    dataLimite: prazos.entrega,
                    status: 'ativo',
                    tipo: 'iva_entrega',
                    prioridade: 'alta',
                    referenciaId: null,
                    dataCriacao: new Date().toISOString()
                };
                prazosExistentes.push(prazoEntrega);
            }
            
            // Criar prazo de pagamento se n√£o existir
            if (!prazoPagamentoExiste) {
                const prazoPagamento = {
                    id: Date.now() + 2,
                    clienteId: 0,
                    clienteNome: 'Sistema',
                    descricao: `Pagamento do IVA - ${prazos.periodo}`,
                    dataLimite: prazos.pagamento,
                    status: 'ativo',
                    tipo: 'iva_pagamento',
                    prioridade: 'alta',
                    referenciaId: null,
                    dataCriacao: new Date().toISOString()
                };
                prazosExistentes.push(prazoPagamento);
            }
            
            // Salvar prazos
            localStorage.setItem('prazos', JSON.stringify(prazosExistentes));
            window.prazos = prazosExistentes;
        }
        
        // === FUN√á√ïES DE IVA TRIMESTRAL ===
        
        function obterTrimestreAtual() {
            const agora = new Date();
            return Math.floor(agora.getMonth() / 3) + 1;
        }
        
        function calcularIVATrimestral_REMOVED() {
            const anoAtual = new Date().getFullYear();
            const trimestreAtual = obterTrimestreAtual();
            
            const ivaPorTrimestre = {
                1: { valor: 0, itens: 0, periodo: 'Jan-Mar' },
                2: { valor: 0, itens: 0, periodo: 'Abr-Jun' },
                3: { valor: 0, itens: 0, periodo: 'Jul-Set' },
                4: { valor: 0, itens: 0, periodo: 'Out-Dez' }
            };
            
            // Calcular IVA de todas as fontes
            const todasFontes = [
                ...contratos.map(c => ({ ...c, fonte: 'contrato' })),
                ...herancas.map(h => ({ ...h, fonte: 'heranca' })),
                ...migracoes.map(m => ({ ...m, fonte: 'migracao' })),
                ...registos.map(r => ({ ...r, fonte: 'registo' }))
            ];
            
            todasFontes.forEach(item => {
                if (item.dataCriacao) {
                    const data = new Date(item.dataCriacao);
                    const ano = data.getFullYear();
                    
                    if (ano === anoAtual) {
                        const trimestre = Math.floor(data.getMonth() / 3) + 1;
                        const valor = parseFloat(item.valor) || 0;
                        const iva = parseFloat(item.iva) || 0;
                        const valorIVA = (valor * iva) / 100;
                        
                        if (ivaPorTrimestre[trimestre]) {
                            ivaPorTrimestre[trimestre].valor += valorIVA;
                            ivaPorTrimestre[trimestre].itens++;
                        }
                    }
                }
            });
            
            return { ivaPorTrimestre, trimestreAtual };
        }
        
        function obterPrazosIVA(trimestre) {
            const anoAtual = new Date().getFullYear();
            const mesInicio = (trimestre - 1) * 3;
            const mesFim = mesInicio + 2;
            
            // Prazo de entrega: at√© o dia 10 do segundo m√™s ap√≥s o fim do trimestre
            const dataEntrega = new Date(anoAtual, mesFim + 2, 10);
            
            // Prazo de pagamento: at√© o dia 15 do segundo m√™s ap√≥s o fim do trimestre
            const dataPagamento = new Date(anoAtual, mesFim + 2, 15);
            
            const periodos = {
                1: 'Janeiro-Mar√ßo',
                2: 'Abril-Junho',
                3: 'Julho-Setembro',
                4: 'Outubro-Dezembro'
            };
            
            return {
                trimestre: trimestre,
                periodo: periodos[trimestre],
                entrega: dataEntrega.toISOString(),
                pagamento: dataPagamento.toISOString()
            };
        }
        
        function criarPrazosIVA() {
            const trimestreAtual = obterTrimestreAtual();
            const prazosIVA = obterPrazosIVA(trimestreAtual);
            // const { ivaPorTrimestre } = calcularIVATrimestral(); // REMOVIDO
            
            // Verificar se j√° existe um prazo de IVA para este trimestre
            const prazoExistente = prazos.find(p => 
                p.tipo === 'iva_trimestral' && 
                p.trimestre === trimestreAtual &&
                new Date(p.dataCriacao).getFullYear() === new Date().getFullYear()
            );
            
            if (prazoExistente) {
                mostrarNotificacao('J√° existe um prazo de IVA para este trimestre!', 'warning');
                return;
            }
            
            // Criar prazos de entrega e pagamento
            const prazoEntrega = {
                id: Date.now(),
                clienteId: null,
                clienteNome: 'Autoridade Tribut√°ria',
                tipo: 'iva_trimestral',
                trimestre: trimestreAtual,
                descricao: `Entrega da Declara√ß√£o de IVA - ${prazosIVA.periodo}`,
                dataLimite: prazosIVA.entrega.split('T')[0],
                status: 'ativo',
                prioridade: 'alta',
                valorIVA: ivaPorTrimestre[trimestreAtual].valor,
                dataCriacao: new Date().toISOString()
            };
            
            const prazoPagamento = {
                id: Date.now() + 1,
                clienteId: null,
                clienteNome: 'Autoridade Tribut√°ria',
                tipo: 'iva_trimestral',
                trimestre: trimestreAtual,
                descricao: `Pagamento do IVA - ${prazosIVA.periodo} (‚Ç¨${ivaPorTrimestre[trimestreAtual].valor.toFixed(2)})`,
                dataLimite: prazosIVA.pagamento.split('T')[0],
                status: 'ativo',
                prioridade: 'alta',
                valorIVA: ivaPorTrimestre[trimestreAtual].valor,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoEntrega, prazoPagamento);
            salvarDados('prazos', prazos);
            
            mostrarNotificacao('Prazos de IVA criados com sucesso!', 'success');
            
            // Recarregar a se√ß√£o de prazos se estiver ativa
            if (secaoAtiva === 'prazos') {
                carregarSecao('prazos');
            }
        }
        
        // Fun√ß√£o para gerar relat√≥rio de IVA trimestral




        function salvarHonorarioEditado(event, id) {
            console.log('üîß FUN√á√ÉO salvarHonorarioEditado INICIADA!');
            event.preventDefault();
            console.log('üîß salvarHonorarioEditado chamado para ID:', id, 'Tipo:', typeof id);
            
            const honorariosSalvos = localStorage.getItem('honorarios');
            let honorarios = [];
            if (honorariosSalvos) {
                honorarios = JSON.parse(honorariosSalvos);
            }
            
            // Converter ID para number se necess√°rio
            const idNum = typeof id === 'string' ? parseInt(id) : id;
            console.log('üîß ID convertido para salvar:', idNum);
            console.log('üîß Total de honor√°rios:', honorarios.length);
            console.log('üîß IDs dos honor√°rios:', honorarios.map(h => h.id));
            
            // Tentar diferentes tipos de compara√ß√£o
            let honorarioIndex = honorarios.findIndex(h => h.id == idNum);
            if (honorarioIndex === -1) {
                console.log('üîß Tentando compara√ß√£o com string...');
                honorarioIndex = honorarios.findIndex(h => h.id == id);
            }
            if (honorarioIndex === -1) {
                console.log('üîß Tentando compara√ß√£o com parseInt...');
                honorarioIndex = honorarios.findIndex(h => h.id == parseInt(id));
            }
            
            console.log('üîß √çndice encontrado:', honorarioIndex);
            
            if (honorarioIndex !== -1) {
                honorarios[honorarioIndex] = {
                    ...honorarios[honorarioIndex],
                    cliente: document.getElementById('editHonorarioCliente').value,
                    servico: document.getElementById('editHonorarioServico').value,
                    valor: parseFloat(document.getElementById('editHonorarioValor').value),
                    status: document.getElementById('editHonorarioStatus').value,
                    vencimento: document.getElementById('editHonorarioVencimento').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                localStorage.setItem('honorarios', JSON.stringify(honorarios));
                window.honorarios = honorarios;
                
                mostrarNotificacao('Honor√°rio atualizado com sucesso!', 'success');
                
                const modal = document.getElementById('modalEdicaoHonorario');
                if (modal) {
                    modal.remove();
                }
                
                setTimeout(() => {
                    carregarSecao('honorarios');
                }, 100);
            } else {
                mostrarNotificacao('Erro: Honor√°rio n√£o encontrado!', 'error');
            }
        }

        function salvarHonorarioEditadoSimples(id) {
            console.log('üîß salvarHonorarioEditadoSimples chamado para ID:', id, 'Tipo:', typeof id);
            
            // Buscar honor√°rios do localStorage
            const honorariosSalvos = localStorage.getItem('honorarios');
            let honorarios = [];
            if (honorariosSalvos) {
                honorarios = JSON.parse(honorariosSalvos);
            }
            
            console.log('üîß Total de honor√°rios:', honorarios.length);
            console.log('üîß IDs dos honor√°rios:', honorarios.map(h => h.id));
            
            // Encontrar o honor√°rio
            const honorarioIndex = honorarios.findIndex(h => h.id == id);
            console.log('üîß √çndice encontrado:', honorarioIndex);
            
            if (honorarioIndex !== -1) {
                // Atualizar os dados
                honorarios[honorarioIndex] = {
                    ...honorarios[honorarioIndex],
                    cliente: document.getElementById('editHonorarioCliente').value,
                    servico: document.getElementById('editHonorarioServico').value,
                    valor: parseFloat(document.getElementById('editHonorarioValor').value),
                    status: document.getElementById('editHonorarioStatus').value,
                    vencimento: document.getElementById('editHonorarioVencimento').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('honorarios', JSON.stringify(honorarios));
                window.honorarios = honorarios;
                
                mostrarNotificacao('Honor√°rio atualizado com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoHonorario');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar se√ß√£o
                setTimeout(() => {
                    carregarSecao('honorarios');
                }, 100);
            } else {
                console.log('üîß Honor√°rio n√£o encontrado para atualizar!');
                mostrarNotificacao('Erro: Honor√°rio n√£o encontrado!', 'error');
            }
        }

        // === FUN√á√ïES DIRETAS PARA REGISTOS ===
        function editarRegistoDireto(id) {
            console.log('üîß editarRegistoDireto chamado com ID:', id);
            console.log('üîß Tipo do ID:', typeof id);
            
            // Converter ID para n√∫mero se necess√°rio
            const idNumerico = parseInt(id);
            console.log('üîß ID convertido para n√∫mero:', idNumerico);
            
            if (isNaN(idNumerico)) {
                console.error('‚ùå ID inv√°lido:', id);
                mostrarNotificacao('ID inv√°lido!', 'error');
                return;
            }
            
            // Carregar dados do registo
            const registosSalvos = localStorage.getItem('registos');
            let registos = [];
            if (registosSalvos) registos = JSON.parse(registosSalvos);
            
            // Se n√£o h√° registos, criar dados de teste
            if (!registos || registos.length === 0) {
                console.log('üîß Criando dados de teste para registos');
                registos = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'Jo√£o Silva',
                        tipo: 'Documentos',
                        descricao: 'Documentos para o estrangeiro',
                        valor: 100,
                        iva: 23,
                        valorComIva: 123,
                        status: 'pendente',
                        dataInicio: '2025-10-24'
                    },
                    {
                        id: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Certid√µes',
                        descricao: 'Certid√£o de nascimento',
                        valor: 50,
                        iva: 23,
                        valorComIva: 61.5,
                        status: 'concluido',
                        dataInicio: '2025-10-23'
                    }
                ];
                localStorage.setItem('registos', JSON.stringify(registos));
                window.registos = registos;
            }
            
            console.log('üîß Registos dispon√≠veis:', registos);
            console.log('üîß Procurando registo com ID:', idNumerico);
            
            const registo = registos.find(r => r.id === idNumerico);
            if (!registo) {
                console.error('‚ùå Registo n√£o encontrado com ID:', idNumerico);
                mostrarNotificacao('Registo n√£o encontrado!', 'error');
                return;
            }
            
            console.log('‚úÖ Registo encontrado:', registo);
            // Abrir modal de edi√ß√£o
            abrirModalEdicaoRegisto(registo);
        }

        function abrirAnexosRegisto(id) {
            console.log('üîß abrirAnexosRegisto chamado com ID:', id);
            const registo = registos.find(r => r.id === parseInt(id));
            console.log('üîß Registo encontrado:', registo);
            if (registo) {
                console.log('üîß Chamando abrirModalAnexos para registo');
                abrirModalAnexos('registo', id, registo.clienteNome || 'Registo');
            } else {
                console.error('‚ùå Registo n√£o encontrado com ID:', id);
                mostrarNotificacao('Registo n√£o encontrado!', 'error');
            }
        }

        function excluirRegistoDireto(id) {
            console.log('üîß excluirRegistoDireto chamado com ID:', id);
            
            if (confirm('Tem certeza que deseja excluir este registo? Esta a√ß√£o n√£o pode ser desfeita.')) {
                // Carregar dados do registo
                const registosSalvos = localStorage.getItem('registos');
                let registos = [];
                if (registosSalvos) registos = JSON.parse(registosSalvos);
                
                // Filtrar registo a ser exclu√≠do
                const registosAtualizados = registos.filter(r => r.id !== parseInt(id));
                
                // Salvar dados atualizados
                localStorage.setItem('registos', JSON.stringify(registosAtualizados));
                window.registos = registosAtualizados;
                
                mostrarNotificacao('Registo exclu√≠do com sucesso!', 'success');
                
                // Recarregar se√ß√£o
                setTimeout(() => {
                    carregarSecao('registos');
                    if (typeof atualizarListaRegistos === 'function') {
                        atualizarListaRegistos(registosAtualizados);
                    }
                }, 100);
            }
        }

        // === FUN√á√ïES PARA HERAN√áAS ===
        function editarHerancaDireto(id) {
            console.log('üîß editarHerancaDireto chamado com ID:', id);
            
            // Carregar dados da heran√ßa
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
            
            const heranca = herancas.find(h => h.id === parseInt(id));
            if (!heranca) {
                mostrarNotificacao('Heran√ßa n√£o encontrada!', 'error');
                return;
            }
            
            console.log('‚úÖ Heran√ßa encontrada:', heranca);
            // Abrir modal de edi√ß√£o
            abrirModalEdicaoHeranca(heranca);
        }

        function abrirAnexosHeranca(id) {
            console.log('üîß abrirAnexosHeranca chamado com ID:', id);
            const heranca = herancas.find(h => h.id === parseInt(id));
            console.log('üîß Heran√ßa encontrada:', heranca);
            if (heranca) {
                console.log('üîß Chamando abrirModalAnexos para heran√ßa');
                abrirModalAnexos('heranca', id, heranca.clienteNome || 'Heran√ßa');
            } else {
                console.error('‚ùå Heran√ßa n√£o encontrada com ID:', id);
                mostrarNotificacao('Heran√ßa n√£o encontrada!', 'error');
            }
        }

        function excluirHerancaDireto(id) {
            console.log('üîß excluirHerancaDireto chamado com ID:', id);
            
            if (confirm('Tem certeza que deseja excluir esta heran√ßa? Esta a√ß√£o n√£o pode ser desfeita.')) {
                console.log('üîß Usu√°rio confirmou exclus√£o');
                
                // Carregar dados da heran√ßa
                const herancasSalvas = localStorage.getItem('herancas');
                let herancas = [];
                if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
                
                console.log('üîß Heran√ßas antes da exclus√£o:', herancas.length);
                
                // Filtrar heran√ßa a ser exclu√≠da
                const herancasAtualizadas = herancas.filter(h => h.id !== parseInt(id));
                
                console.log('üîß Heran√ßas ap√≥s exclus√£o:', herancasAtualizadas.length);
                
                // Salvar dados atualizados
                localStorage.setItem('herancas', JSON.stringify(herancasAtualizadas));
                window.herancas = herancasAtualizadas;
                
                console.log('‚úÖ Heran√ßas salvas no localStorage');
                
                mostrarNotificacao('Heran√ßa exclu√≠da com sucesso!', 'success');
                
                // Recarregar se√ß√£o
                setTimeout(() => {
                    console.log('üîß Recarregando se√ß√£o heran√ßas');
                    carregarSecao('herancas');
                    if (typeof atualizarListaHerancas === 'function') {
                        console.log('üîß Chamando atualizarListaHerancas');
                        atualizarListaHerancas(herancasAtualizadas);
                    }
                }, 100);
            }
        }


        // Tornar fun√ß√µes globais
        window.abrirAnexosContrato = abrirAnexosContrato;
        window.abrirAnexosHeranca = abrirAnexosHeranca;
        window.abrirAnexosMigracao = abrirAnexosMigracao;
        window.abrirAnexosRegisto = abrirAnexosRegisto;
        window.abrirModalAnexos = abrirModalAnexos;
        window.visualizarAnexo = visualizarAnexo;
        window.baixarAnexo = baixarAnexo;
        window.adicionarAnexoContrato = adicionarAnexoContrato;
        window.adicionarAnexoHeranca = adicionarAnexoHeranca;
        window.adicionarAnexoMigracao = adicionarAnexoMigracao;
        window.adicionarAnexoRegisto = adicionarAnexoRegisto;
        window.removerAnexoContrato = removerAnexoContrato;
        window.removerAnexoHeranca = removerAnexoHeranca;
        window.removerAnexoMigracao = removerAnexoMigracao;
        
        // VERIFICAR SE FUN√á√ïES EST√ÉO DEFINIDAS
        console.log('üîß VERIFICA√á√ÉO DE FUN√á√ïES:');
        console.log('üîß editarRegistoDireto:', typeof editarRegistoDireto);
        console.log('üîß abrirAnexosRegisto:', typeof abrirAnexosRegisto);
        console.log('üîß excluirRegistoDireto:', typeof excluirRegistoDireto);
        console.log('üîß visualizarAnexo:', typeof visualizarAnexo);
        console.log('üîß baixarAnexo:', typeof baixarAnexo);
        
        // TESTAR FUN√á√ïES DIRETAMENTE
        console.log('üîß TESTANDO FUN√á√ïES:');
        if (typeof editarRegistoDireto === 'function') {
            console.log('‚úÖ editarRegistoDireto est√° definida');
        } else {
            console.error('‚ùå editarRegistoDireto N√ÉO est√° definida');
        }
        
        if (typeof abrirAnexosRegisto === 'function') {
            console.log('‚úÖ abrirAnexosRegisto est√° definida');
        } else {
            console.error('‚ùå abrirAnexosRegisto N√ÉO est√° definida');
        }
        
        if (typeof excluirRegistoDireto === 'function') {
            console.log('‚úÖ excluirRegistoDireto est√° definida');
        } else {
            console.error('‚ùå excluirRegistoDireto N√ÉO est√° definida');
        }
        window.removerAnexoRegisto = removerAnexoRegisto;
        window.toggleTipoPersonalizado = toggleTipoPersonalizado;
        window.atualizarContrato = atualizarContrato;
        window.abrirModalEdicaoContrato = abrirModalEdicaoContrato;
        window.editarContratoDireto = editarContratoDireto;
        window.excluirContratoDireto = excluirContratoDireto;
        window.editarHerancaDireto = editarHerancaDireto;
        window.excluirHerancaDireto = excluirHerancaDireto;
        window.editarMigracaoDireto = editarMigracaoDireto;
        window.excluirMigracaoDireto = excluirMigracaoDireto;
        window.editarRegistoDireto = editarRegistoDireto;
        window.excluirRegistoDireto = excluirRegistoDireto;
        window.abrirModalEdicaoMigracao = abrirModalEdicaoMigracao;
        window.salvarMigracaoEditada = salvarMigracaoEditada;
        window.editarHonorarioDireto = editarHonorarioDireto;
        window.excluirHonorarioDireto = excluirHonorarioDireto;
        window.salvarHonorarioEditado = salvarHonorarioEditado;
        window.excluirClienteDireto = excluirClienteDireto;
        
        // Service Worker Registration REMOVIDO
        
        // PWA completamente removido

    </script>
</body>
</html>
