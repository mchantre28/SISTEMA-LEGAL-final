<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Legal - Gestão Jurídica</title>
    
    <!-- Meta Tags Básicas -->
    <meta name="description" content="Sistema completo de gestão jurídica para Solicitadores">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #000000;
            --secondary-color: #374151;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #3b82f6;
        }

        /* Modo Escuro */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #1f2937;
                --secondary-color: #4b5563;
            }
        }

        [data-theme="dark"] {
            --primary-color: #1f2937;
            --secondary-color: #4b5563;
        }

        [data-theme="dark"] body {
            background-color: #111827;
            color: #f9fafb;
        }

        [data-theme="dark"] .card {
            background-color: #1f2937;
            border-color: #374151;
            color: #f9fafb;
        }

        [data-theme="dark"] .sidebar {
            background: #111827 !important;
        }

        [data-theme="dark"] .main-content {
            background-color: #111827;
        }

        [data-theme="dark"] .table-responsive {
            background-color: #1f2937;
        }

        [data-theme="dark"] .table-responsive th,
        [data-theme="dark"] .table-responsive td {
            border-color: #374151;
            color: #f9fafb;
        }

        [data-theme="dark"] .modal-content {
            background-color: #1f2937;
            color: #f9fafb;
        }

        [data-theme="dark"] .btn {
            color: #f9fafb;
        }

        [data-theme="dark"] .btn-primary {
            background: #3b82f6;
        }

        [data-theme="dark"] .btn-secondary {
            background: #6b7280;
        }

        [data-theme="dark"] .btn-success {
            background: #10b981;
        }

        [data-theme="dark"] .btn-warning {
            background: #f59e0b;
        }

        [data-theme="dark"] .btn-error {
            background: #ef4444;
        }

        [data-theme="dark"] .btn-info {
            background: #3b82f6;
        }

        .sidebar { 
            background: var(--primary-color) !important; 
            min-height: 100vh !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 280px !important;
            min-width: 280px !important;
            max-width: 280px !important;
            z-index: 1000 !important;
            transition: all 0.3s ease;
            overflow-y: auto;
        }
        
        /* FORÇAR LARGURA EM DESKTOP */
        @media (min-width: 1025px) {
            .sidebar {
                width: 280px !important;
                min-width: 280px !important;
                max-width: 280px !important;
            }
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
                transform: translateX(-100%);
                overflow-y: auto;
                max-height: 100vh;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 180px;
            }
        }
        
        @media (max-width: 480px) {
            .sidebar {
                width: 160px;
            }
            
            .sidebar-item {
                padding: 6px 8px;
                font-size: 12px;
            }
            
            .sidebar h2 {
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            .sidebar-item i {
                width: 16px;
                height: 16px;
                margin-right: 8px;
            }
        }

        .sidebar-item { 
            color: #ffffff !important; 
            transition: all 0.2s ease;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 4px 8px;
            display: flex;
            align-items: center;
            text-decoration: none;
            cursor: pointer;
        }
        
        @media (max-width: 1024px) {
            .sidebar-item {
                padding: 10px 14px;
                font-size: 14px;
                margin: 2px 6px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar-item {
                padding: 8px 12px;
                font-size: 13px;
                margin: 2px 4px;
            }
        }
        
        @media (max-width: 1024px) {
            .sidebar h2 {
                font-size: 18px;
                padding: 16px 20px 8px 20px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar h2 {
                font-size: 16px;
                padding: 12px 16px 6px 16px;
            }
        }

        .sidebar-item:hover { 
            background: rgba(255, 255, 255, 0.1); 
            transform: translateX(4px);
        }
        
        .sidebar-item.active { 
            background: var(--secondary-color); 
            border-left: 4px solid #6b7280;
        }

        .main-content {
            margin-left: 280px;
            transition: margin-left 0.3s ease;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                margin-left: 0;
            }
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 1024px) {
            .mobile-menu-btn {
                display: block;
            }
        }

        @media (max-width: 1024px) {
            .mobile-menu-btn {
                display: block;
            }
            
            .sidebar {
                transform: translateX(-100%);
                width: 100% !important;
                max-width: 320px !important;
                z-index: 1000;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0 !important;
                padding-top: 80px;
            }
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .main-content {
                padding: 10px;
            }
            
            .card {
                margin-bottom: 16px;
                padding: 16px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            /* Tabelas responsivas */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table-responsive table {
                min-width: 600px;
            }
            
            /* Modais mobile */
            .modal-content {
                margin: 10px;
                max-height: calc(100vh - 20px);
                overflow-y: auto;
            }
            
            /* Botões de ação menores */
            .btn-sm {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            /* Grid responsivo */
            .grid-cols-1 {
                grid-template-columns: 1fr !important;
            }
            
            .md\\:grid-cols-3 {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 5px;
            }
            
            .card {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .btn {
                padding: 10px 14px;
                font-size: 13px;
            }
            
            .sidebar-item {
                padding: 10px 12px;
                font-size: 14px;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }

        .card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-error {
            background: var(--error-color);
            color: white;
        }

        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--error-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pendente {
            background: #fef3c7;
            color: #92400e;
        }

        .status-pago {
            background: #d1fae5;
            color: #065f46;
        }

        .status-vencido {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-ativo {
            background: #d1fae5;
            color: #065f46;
        }

        .status-inativo {
            background: #e5e7eb;
            color: #374151;
        }

        .status-suspenso {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Status das Áreas de Execução */
        .status-pendente {
            background: #fef3c7;
            color: #92400e;
        }

        .status-em_andamento {
            background: #fef3c7;
            color: #92400e;
        }

        .status-concluido {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Status de Prioridade dos Prazos */
        .status-baixa {
            background: #f3f4f6;
            color: #374151;
        }

        .status-media {
            background: #fef3c7;
            color: #92400e;
        }

        .status-alta {
            background: #fed7aa;
            color: #c2410c;
        }

        .status-critica {
            background: #fee2e2;
            color: #991b1b;
        }

        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .table-responsive table {
            width: 100%;
            border-collapse: collapse;
        }

        .table-responsive th,
        .table-responsive td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .table-responsive th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .table-responsive tbody tr:hover {
            background-color: #f9fafb;
        }
        
        /* Correção definitiva para alinhamento das colunas */
        .tabela-migracao th,
        .tabela-migracao td {
            vertical-align: top !important;
        }
        
        .tabela-migracao th:nth-child(1),
        .tabela-migracao td:nth-child(1) {
            width: 20% !important;
            min-width: 150px !important;
        }
        
        .tabela-migracao th:nth-child(2),
        .tabela-migracao td:nth-child(2) {
            width: 15% !important;
            min-width: 120px !important;
        }
        
        .tabela-migracao th:nth-child(3),
        .tabela-migracao td:nth-child(3) {
            width: 20% !important;
            min-width: 150px !important;
        }
        
        .tabela-migracao th:nth-child(4),
        .tabela-migracao td:nth-child(4) {
            width: 15% !important;
            min-width: 120px !important;
        }
        
        .tabela-migracao th:nth-child(5),
        .tabela-migracao td:nth-child(5) {
            width: 12% !important;
            min-width: 100px !important;
        }
        
        .tabela-migracao th:nth-child(6),
        .tabela-migracao td:nth-child(6) {
            width: 10% !important;
            min-width: 100px !important;
        }
        
        .tabela-migracao th:nth-child(7),
        .tabela-migracao td:nth-child(7) {
            width: 8% !important;
            min-width: 80px !important;
        }


        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .space-x-2 > * + * { margin-left: 8px; }
        .space-x-4 > * + * { margin-left: 16px; }
        .text-center { text-align: center; }
        .font-semibold { font-weight: 600; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-800 { color: #1f2937; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Sistema de Notificações -->
    <div id="notificationContainer"></div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()">
        <i data-lucide="menu" class="w-5 h-5"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="p-6">
            <h2 class="text-white text-xl font-bold mb-6">Sistema Legal</h2>
            <nav class="space-y-2">
                <a href="#" onclick="carregarSecao('dashboard')" class="sidebar-item active" id="nav-dashboard">
                    <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                    Visão Geral
                </a>
                <a href="#" onclick="carregarSecao('clientes')" class="sidebar-item" id="nav-clientes">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                    Clientes
                </a>
                <a href="#" onclick="carregarSecao('honorarios')" class="sidebar-item" id="nav-honorarios">
                    <i data-lucide="dollar-sign" class="w-5 h-5 mr-3"></i>
                    Honorários
                </a>
                <a href="#" onclick="carregarSecao('contratos')" class="sidebar-item" id="nav-contratos">
                    <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                    Contratos
                </a>
                <a href="#" onclick="carregarSecao('herancas')" class="sidebar-item" id="nav-herancas">
                    <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                    Heranças
                </a>
                <a href="#" onclick="carregarSecao('migracoes')" class="sidebar-item" id="nav-migracao">
                    <i data-lucide="users-2" class="w-5 h-5 mr-3"></i>
                    Migração
                </a>
                <a href="#" onclick="carregarSecao('registos')" class="sidebar-item" id="nav-registos">
                    <i data-lucide="book-open" class="w-5 h-5 mr-3"></i>
                    Registos
                </a>
                <a href="#" onclick="carregarSecao('prazos')" class="sidebar-item" id="nav-prazos">
                    <i data-lucide="clock" class="w-5 h-5 mr-3"></i>
                    Prazos
                </a>
                <a href="#" onclick="carregarSecao('notificacoes')" class="sidebar-item" id="nav-notificacoes">
                    <i data-lucide="bell" class="w-5 h-5 mr-3"></i>
                    Notificações
                    <span id="badgeNotificacoes" class="hidden bg-red-500 text-white text-xs rounded-full px-2 py-1 ml-2">0</span>
                </a>
            <a href="#" onclick="carregarSecao('relatorios')" class="sidebar-item" id="nav-relatorios">
                <i data-lucide="bar-chart-3" class="w-5 h-5 mr-3"></i>
                Relatórios
            </a>
            <a href="#" onclick="carregarSecao('backup')" class="sidebar-item" id="nav-backup">
                <i data-lucide="database" class="w-5 h-5 mr-3"></i>
                Backup
            </a>
            <a href="#" onclick="carregarSecao('convidados')" class="sidebar-item" id="nav-convidados" style="display: none;">
                <i data-lucide="user-plus" class="w-5 h-5 mr-3"></i>
                Gestão de Convidados
            </a>
            </nav>
        </div>
    </div>

    <!-- Menu Mobile -->
    <button id="menuHamburguer" class="fixed top-4 left-4 z-50 lg:hidden bg-black text-white p-2 rounded">
        <i data-lucide="menu" class="w-6 h-6"></i>
    </button>

    <!-- Conteúdo Principal -->
    <div class="main-content min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Sistema Legal</h1>
                    <div class="flex items-center space-x-4">
                        <!-- Botão PWA removido -->
                        <button onclick="exportarDados()" class="btn btn-primary">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Exportar
                        </button>
                        <button onclick="importarDados()" class="btn btn-success">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                            Importar
                        </button>
                        <button onclick="logout()" class="btn btn-danger">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conteúdo Dinâmico -->
        <main class="p-6">
            <div id="conteudoDinamico">
                <!-- Dashboard será carregado aqui -->
            </div>
        </main>
    </div>

    <!-- Modais -->
    <div id="modalContainer"></div>

    <script>
        // === SISTEMA LEGAL CORRIGIDO ===
        
        // SISTEMA DE LOGIN
        const USUARIO_PADRAO = 'admin';
        const SENHA_PADRAO = 'APM2024!';
        
        function verificarLogin() {
            const usuarioLogado = localStorage.getItem('usuarioLogado');
            if (!usuarioLogado) {
                mostrarTelaLogin();
                return false;
            }
            return true;
        }
        
        function mostrarTelaLogin() {
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex items-center justify-center">
                    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-900">Sistema Legal</h1>
                            <p class="text-lg font-semibold text-blue-600 mt-2">ANA PAULA MEDINA</p>
                            <p class="text-gray-600 mt-2">Selecione o tipo de acesso</p>
                        </div>
                        
                        <div class="space-y-4">
                            <button onclick="mostrarLoginAdmin()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center justify-center">
                                <i data-lucide="shield-check" class="w-5 h-5 mr-2"></i>
                                Administrador
                            </button>
                            
                            <button onclick="mostrarLoginConvidado()" class="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 flex items-center justify-center">
                                <i data-lucide="user" class="w-5 h-5 mr-2"></i>
                                Convidado
                            </button>
                        </div>
                        
                        <div class="mt-6 text-center text-sm text-gray-600">
                            <p><strong>Administrador:</strong> Acesso total ao sistema</p>
                            <p><strong>Convidado:</strong> Acesso limitado a clientes autorizados</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Renderizar ícones
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }
        
        function mostrarLoginAdmin() {
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex items-center justify-center">
                    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-900">Sistema Legal</h1>
                            <p class="text-lg font-semibold text-blue-600 mt-2">ANA PAULA MEDINA</p>
                            <p class="text-gray-600 mt-2">Login Administrador - Acesso total ao sistema</p>
                        </div>
                        
                        <form id="formLoginAdmin" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Usuário</label>
                                <input type="text" id="usuario" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite seu usuário" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                                <input type="password" id="senha" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite sua senha" required>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button type="button" onclick="mostrarTelaLogin()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                                    Voltar
                                </button>
                                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                    Entrar
                                </button>
                            </div>
                        </form>
                        
                        <div class="mt-6 text-center text-sm text-gray-600">
                            <p><strong>🔒 Acesso Restrito</strong></p>
                            <p>Entre em contato com o administrador para obter as credenciais</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('formLoginAdmin').addEventListener('submit', function(e) {
                e.preventDefault();
                const usuario = document.getElementById('usuario').value;
                const senha = document.getElementById('senha').value;
                
                if (usuario === USUARIO_PADRAO && senha === SENHA_PADRAO) {
                    localStorage.setItem('usuarioLogado', 'true');
                    localStorage.setItem('usuarioNome', usuario);
                    localStorage.setItem('tipoUsuario', 'admin');
                    location.reload();
                } else {
                    alert('Usuário ou senha incorretos!');
                }
            });
        }
        
        function mostrarLoginConvidado() {
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex items-center justify-center">
                    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-900">Sistema Legal</h1>
                            <p class="text-lg font-semibold text-blue-600 mt-2">ANA PAULA MEDINA</p>
                            <p class="text-gray-600 mt-2">Login Convidado - Acesso limitado a clientes autorizados</p>
                        </div>
                        
                        <form id="formLoginConvidado" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Convidado</label>
                                <input type="text" id="nomeConvidado" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Digite seu nome" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Código de Acesso</label>
                                <input type="text" id="codigoAcesso" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Digite o código de acesso" required>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button type="button" onclick="mostrarTelaLogin()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                                    Voltar
                                </button>
                                <button type="submit" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                                    Entrar
                                </button>
                            </div>
                        </form>
                        
                        <div class="mt-6 text-center text-sm text-gray-600">
                            <p>Peça o código de acesso ao administrador</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('formLoginConvidado').addEventListener('submit', function(e) {
                e.preventDefault();
                const nome = document.getElementById('nomeConvidado').value;
                const codigo = document.getElementById('codigoAcesso').value;
                
                // Verificar se o código existe e está ativo
                const convidados = JSON.parse(localStorage.getItem('convidados') || '[]');
                const convidado = convidados.find(c => c.codigo === codigo && c.ativo);
                
                if (convidado) {
                    localStorage.setItem('usuarioLogado', 'true');
                    localStorage.setItem('usuarioNome', nome);
                    localStorage.setItem('tipoUsuario', 'convidado');
                    localStorage.setItem('convidadoId', convidado.id);
                    location.reload();
                } else {
                    alert('Código de acesso inválido ou inativo!');
                }
            });
        }
        
        function logout() {
            localStorage.removeItem('usuarioLogado');
            localStorage.removeItem('usuarioNome');
            localStorage.removeItem('tipoUsuario');
            localStorage.removeItem('convidadoId');
            location.reload();
        }
        
        // FUNÇÃO PARA GERAR CÓDIGOS DE ACESSO SEGUROS
        function gerarCodigoAcesso() {
            const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let codigo = '';
            for (let i = 0; i < 8; i++) {
                codigo += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
            }
            return codigo;
        }
        
        // FUNÇÃO PARA LIMPEZA PROFISSIONAL
        function limparDadosParaUsoProfissional() {
            if (confirm('⚠️ ATENÇÃO: Esta ação irá APAGAR TODOS os dados do sistema!\n\nIsso inclui:\n- Todos os clientes\n- Todos os honorários\n- Todos os contratos\n- Todas as heranças\n- Todas as migrações\n- Todos os registos\n- Todos os convidados\n\nTem certeza que deseja continuar?')) {
                if (confirm('🚨 CONFIRMAÇÃO FINAL:\n\nEsta ação é IRREVERSÍVEL!\n\nTodos os dados serão permanentemente apagados.\n\nDeseja realmente continuar?')) {
                    // Limpar todos os dados do localStorage
                    localStorage.removeItem('clientes');
                    localStorage.removeItem('honorarios');
                    localStorage.removeItem('contratos');
                    localStorage.removeItem('herancas');
                    localStorage.removeItem('migracoes');
                    localStorage.removeItem('registos');
                    localStorage.removeItem('convidados');
                    localStorage.removeItem('prazos');
                    localStorage.removeItem('notificacoes');
                    
                    // Limpar variáveis globais
                    clientes = [];
                    honorarios = [];
                    contratos = [];
                    herancas = [];
                    migracoes = [];
                    registos = [];
                    prazos = [];
                    notificacoes = [];
                    
                    mostrarNotificacao('✅ Sistema limpo com sucesso! Pronto para uso profissional.', 'success');
                    
                    // Recarregar página após 2 segundos
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }
            }
        }
        
        // SISTEMA DE GESTÃO DE CONVIDADOS
        function criarConvidado(nome, clientesAutorizados) {
            const convidados = JSON.parse(localStorage.getItem('convidados') || '[]');
            const codigo = gerarCodigoAcesso(); // Usar função de código seguro
            
            const novoConvidado = {
                id: Date.now(),
                nome: nome,
                codigo: codigo,
                clientesAutorizados: clientesAutorizados || [],
                ativo: true,
                dataCriacao: new Date().toISOString()
            };
            
            convidados.push(novoConvidado);
            localStorage.setItem('convidados', JSON.stringify(convidados));
            
            return novoConvidado;
        }
        
        function obterConvidados() {
            return JSON.parse(localStorage.getItem('convidados') || '[]');
        }
        
        function ativarDesativarConvidado(id, ativo) {
            const convidados = obterConvidados();
            const convidado = convidados.find(c => c.id === id);
            if (convidado) {
                convidado.ativo = ativo;
                localStorage.setItem('convidados', JSON.stringify(convidados));
            }
        }
        
        // FUNÇÃO RECRIADA PARA CORRIGIR PROBLEMA
        function editarPermissoesConvidado(id, clientesAutorizados) {
            console.log('🚀 INÍCIO da função editarPermissoesConvidado');
            console.log('🔧 Parâmetros recebidos:', { id, clientesAutorizados });
            
            // Carregar convidados diretamente
            const convidados = JSON.parse(localStorage.getItem('convidados') || '[]');
            console.log('🔧 Convidados carregados:', convidados.length);
            
            // Buscar convidado
            const convidado = convidados.find(c => c.id === id);
            console.log('🔧 Buscando convidado com ID:', id);
            
            if (convidado) {
                console.log('🔧 Convidado encontrado:', convidado.nome);
                console.log('🔧 Clientes autorizados antes:', convidado.clientesAutorizados);
                
                // Verificar se há novos clientes autorizados
                const clientesAntigos = convidado.clientesAutorizados || [];
                const novosClientes = clientesAutorizados.filter(id => !clientesAntigos.includes(id));
                
                // Atualizar permissões
                convidado.clientesAutorizados = clientesAutorizados;
                localStorage.setItem('convidados', JSON.stringify(convidados));
                
                console.log('🔧 Clientes autorizados depois:', convidado.clientesAutorizados);
                console.log('🔧 Dados salvos no localStorage');
                
                // Criar notificações automáticas para novos clientes
                if (novosClientes.length > 0) {
                    const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
                    novosClientes.forEach(clienteId => {
                        const cliente = clientes.find(c => c.id === clienteId);
                        if (cliente) {
                            criarNotificacao({
                                tipo: 'cliente_autorizado',
                                titulo: 'Novo Cliente Autorizado',
                                mensagem: `O cliente "${cliente.nome}" foi autorizado para você.`,
                                prioridade: 'media',
                                referenciaId: clienteId,
                                destinatarioId: id,
                                acao: 'ver_cliente'
                            });
                        }
                    });
                }
                
                // Recarregar seção
                setTimeout(() => {
                    console.log('🔧 Recarregando seção convidados...');
                    carregarSecao('convidados');
                }, 100);
            } else {
                console.error('❌ Convidado não encontrado com ID:', id);
                console.log('🔧 IDs disponíveis:', convidados.map(c => c.id));
            }
        }
        
        // VERIFICAÇÃO DE PERMISSÕES
        function verificarPermissaoCliente(clienteId) {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            
            if (tipoUsuario === 'admin') {
                return true; // Admin tem acesso total
            }
            
            if (tipoUsuario === 'convidado') {
                const convidadoId = localStorage.getItem('convidadoId');
                const convidados = obterConvidados();
                const convidado = convidados.find(c => c.id === parseInt(convidadoId));
                
                if (convidado && convidado.ativo) {
                    return convidado.clientesAutorizados.includes(parseInt(clienteId));
                }
            }
            
            return false;
        }
        
        // Verificar login após o DOM estar carregado
        document.addEventListener('DOMContentLoaded', function() {
            if (!verificarLogin()) {
                // A página será substituída pela tela de login
                // O resto do código não será executado
                return;
            }
            // Se login OK, configurar interface baseada no tipo de usuário
            configurarInterfaceUsuario();
            // Forçar largura do sidebar
            forcarLarguraSidebar();
            // Aplicar novamente após um delay
            setTimeout(forcarLarguraSidebar, 1000);
            setTimeout(forcarLarguraSidebar, 2000);
            // Inicializar sistema normalmente
            init();
        });
        
        function forcarLarguraSidebar() {
            // Tentar múltiplas formas de encontrar o sidebar
            const sidebar = document.getElementById('sidebar');
            const sidebarClass = document.querySelector('.sidebar');
            
            if (sidebar) {
                sidebar.style.width = '300px';
                sidebar.style.minWidth = '300px';
                sidebar.style.maxWidth = '300px';
                sidebar.style.setProperty('width', '300px', 'important');
                sidebar.style.setProperty('min-width', '300px', 'important');
                sidebar.style.setProperty('max-width', '300px', 'important');
                console.log('🔧 Largura do sidebar forçada para 300px (ID)');
            }
            
            if (sidebarClass) {
                sidebarClass.style.width = '300px';
                sidebarClass.style.minWidth = '300px';
                sidebarClass.style.maxWidth = '300px';
                sidebarClass.style.setProperty('width', '300px', 'important');
                sidebarClass.style.setProperty('min-width', '300px', 'important');
                sidebarClass.style.setProperty('max-width', '300px', 'important');
                console.log('🔧 Largura do sidebar forçada para 300px (CLASS)');
            }
            
            // Aplicar também no conteúdo principal
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.style.marginLeft = '300px';
                mainContent.style.setProperty('margin-left', '300px', 'important');
                console.log('🔧 Margem do conteúdo principal ajustada para 300px');
            }
        }
        
        function configurarInterfaceUsuario() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const navConvidados = document.getElementById('nav-convidados');
            
            if (tipoUsuario === 'admin' && navConvidados) {
                navConvidados.style.display = 'block';
            } else if (navConvidados) {
                navConvidados.style.display = 'none';
            }
            
            // OCULTAR SEÇÕES PARA CONVIDADOS
            if (tipoUsuario === 'convidado') {
                ocultarSecoesConvidado();
            } else {
                mostrarTodasSecoes();
            }
        }
        
        function ocultarSecoesConvidado() {
            // Ocultar todas as seções exceto clientes
            const secoesParaOcultar = [
                'nav-dashboard',
                'nav-honorarios',
                'nav-contratos', 
                'nav-herancas',
                'nav-migracao',
                'nav-registos',
                'nav-prazos',
                'nav-relatorios',
                'nav-backup',
                'nav-convidados'
            ];
            
            secoesParaOcultar.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.style.display = 'none';
                }
            });
            
            // Manter apenas a seção de clientes visível
            const navClientes = document.getElementById('nav-clientes');
            if (navClientes) {
                navClientes.style.display = 'block';
            }
        }
        
        function mostrarTodasSecoes() {
            // Mostrar todas as seções para administradores
            const todasSecoes = [
                'nav-honorarios',
                'nav-contratos', 
                'nav-herancas',
                'nav-migracao',
                'nav-registos',
                'nav-relatorios',
                'nav-backup',
                'nav-convidados'
            ];
            
            todasSecoes.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.style.display = 'block';
                }
            });
        }
        
        // Dados globais
        let clientes = [];
        let honorarios = [];
        let contratos = [];
        let prazos = [];
        let notificacoes = [];
        let herancas = [];
        let migracoes = [];
        let registos = [];
        let secaoAtiva = 'dashboard';
        
        // Garantir que as variáveis estão definidas globalmente
        window.clientes = clientes;
        window.honorarios = honorarios;
        window.contratos = contratos;
        window.prazos = prazos;
        window.notificacoes = notificacoes;
        window.herancas = herancas;
        window.migracoes = migracoes;
        window.registos = registos;

        // === FUNÇÃO DE TESTE ===
        function testarBotao() {
            alert('BOTÃO FUNCIONANDO!');
            console.log('BOTÃO FUNCIONANDO!');
        }

        // === FUNÇÕES DE EDIÇÃO DIRETA ===
        function editarContratoDireto(id) {
            console.log('🔧 EDITANDO CONTRATO ID:', id);
            alert('EDITANDO CONTRATO ID: ' + id);
            
            const contrato = contratos.find(c => c.id === id);
            if (contrato) {
                console.log('✅ Contrato encontrado:', contrato);
                alert('Contrato encontrado: ' + contrato.clienteNome);
                
                // Fechar qualquer modal aberto primeiro
                fecharModal();
                
                // Aguardar um pouco para garantir que o modal anterior foi fechado
                setTimeout(() => {
                    console.log('🚀 Abrindo modal de edição...');
                    abrirModalEdicaoContrato(contrato);
                }, 200);
            } else {
                console.error('❌ Contrato não encontrado com ID:', id);
                alert('❌ Contrato não encontrado com ID: ' + id);
                mostrarNotificacao('Contrato não encontrado!', 'error');
            }
        }

        function editarHonorarioDireto(id) {
            console.log('🔧 EDITANDO HONORÁRIO ID:', id);
            alert('EDITANDO HONORÁRIO ID: ' + id);
            
            const honorario = honorarios.find(h => h.id === id);
            if (honorario) {
                console.log('✅ Honorário encontrado:', honorario);
                alert('Honorário encontrado: ' + honorario.cliente);
                
                // Fechar qualquer modal aberto primeiro
                fecharModal();
                
                // Aguardar um pouco para garantir que o modal anterior foi fechado
                setTimeout(() => {
                    console.log('🚀 Abrindo modal de edição...');
                    abrirModalEdicaoHonorario(honorario);
                }, 200);
            } else {
                console.error('❌ Honorário não encontrado com ID:', id);
                alert('❌ Honorário não encontrado com ID: ' + id);
                mostrarNotificacao('Honorário não encontrado!', 'error');
            }
        }

        function editarClienteDireto(id) {
            console.log('EDITANDO CLIENTE ID:', id);
            
            const cliente = clientes.find(c => c.id === id);
            if (cliente) {
                console.log('Cliente encontrado:', cliente);
                
                // Fechar qualquer modal aberto primeiro
                fecharModal();
                
                // Aguardar um pouco para garantir que o modal anterior foi fechado
                setTimeout(() => {
                    abrirModalEdicaoCliente(cliente);
                }, 100);
            } else {
                console.error('Cliente não encontrado com ID:', id);
                mostrarNotificacao('Cliente não encontrado!', 'error');
            }
        }

        // Inicialização
        function init() {
            console.log('🚀 TESTE RADICAL v67.0 - CACHE FORÇADO!');
            
            // LIMPAR CACHE APÓS INICIALIZAÇÃO
            try {
                localStorage.clear();
                console.log('🧹 localStorage limpo completamente');
            } catch (error) {
                console.log('❌ Erro ao limpar localStorage:', error);
            }
            
            carregarDados();
            carregarDadosExemplo();
            
            // Gerar bilhetes para clientes existentes que não têm bilhete
            gerarBilhetesParaClientesExistentes();
            
            // Verificar tipo de usuário para carregar seção apropriada
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            if (tipoUsuario === 'convidado') {
                carregarSecao('clientes');
            } else {
                carregarSecao('dashboard');
            }
            
            configurarEventos();
            atualizarInterface();
            iniciarSistemaNotificacoes();
            iniciarSistemaBackup();
            
            // Inicializar funcionalidades mobile
            // inicializarPWA(); // REMOVIDO - PWA desativado
            // inicializarModoEscuro(); // REMOVIDO
            inicializarGestosTouch();
            
            
            // Calcular juros automáticos na inicialização
            // calcularJurosAutomaticos(); // REMOVIDO
        }

        // PWA - Service Worker Registration
        // PWA - Service Worker Registration REMOVIDO

        // Função verificarCriteriosInstalacao removida - PWA desativado

        // Função debugPWA removida - PWA desativado

        // Função mostrarBotaoInstalacao removida - PWA desativado

        // Função DEFINITIVA que FUNCIONA - Baseada no teste do usuário
        function fecharModalDIRETO() {
            console.log('🔧 fecharModalDIRETO chamado - SOLUÇÃO DEFINITIVA QUE FUNCIONA');
            
            // SOLUÇÃO QUE FUNCIONA - Baseada no teste do usuário
            try {
                // 1. Remover TODOS os elementos .fixed e .inset-0 (SOLUÇÃO QUE FUNCIONA!)
                document.querySelectorAll('.fixed, .inset-0').forEach(el => {
                    console.log('Removendo elemento:', el);
                    el.remove();
                });
                console.log('✅ Elementos .fixed e .inset-0 removidos!');
                
                // 2. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.classList.remove('show');
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('✅ modalContainer limpo');
                }
                
                // 3. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 4. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
            } catch (e) { console.warn('Erro:', e); }
            
            console.log('✅ fecharModalDIRETO executado - SOLUÇÃO DEFINITIVA QUE FUNCIONA');
        }

        // SUBSTITUIR TODAS AS OUTRAS FUNÇÕES DE FECHAR MODAL
        function fecharModal() { fecharModalDIRETO(); }
        function fecharModalRobusto() { fecharModalDIRETO(); }
        function fecharModalAnexosCliente() { fecharModalDIRETO(); }
        function fecharModalSimples() { fecharModalDIRETO(); }
        function fecharModalNUCLEAR() { fecharModalDIRETO(); }
        function fecharModalSUPERRADICAL() { fecharModalDIRETO(); }
        function fecharModalEMERGENCIA() { fecharModalDIRETO(); }
        function fecharModalFINAL() { fecharModalDIRETO(); }

        // FORÇAR RELOAD PARA GARANTIR VERSÃO MAIS RECENTE
        function forcarReload() {
            console.log('🔄 FORÇANDO RELOAD PARA GARANTIR VERSÃO MAIS RECENTE');
            if (confirm('🔄 O sistema detectou uma versão mais recente!\n\nDeseja recarregar a página para usar a versão mais atual?')) {
                window.location.reload(true);
            }
        }

        // EXECUTAR AUTOMATICAMENTE APÓS 2 SEGUNDOS
        setTimeout(function() {
            console.log('🔧 EXECUTANDO AUTOMATICAMENTE - FORÇA RELOAD');
            try {
                forcarReload();
            } catch (e) {
                console.warn('Erro na força de reload:', e);
            }
        }, 2000);

        // SOLUÇÃO EXTREMA - REMOVE TUDO QUE ESTIVER NA TELA
        function fecharModalNUCLEAR() {
            console.log('💥💥💥💥💥 fecharModalNUCLEAR - SOLUÇÃO EXTREMA - REMOVE TUDO');
            
            // MÉTODO EXTREMO: Remover TUDO que estiver na tela
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const selectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]',
                    'div[class*="modal"]', 'div[class*="overlay"]', 'div[class*="backdrop"]'
                ];
                
                selectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        console.log('💥💥💥💥💥 Removendo elemento:', selector, el);
                        el.remove();
                    });
                });
                
                // 2. Remover TODOS os elementos com position fixed
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💥💥💥💥💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥💥💥💥💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. Remover TODOS os divs que possam ser modais
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('modal') || 
                        div.classList.contains('fixed') ||
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.display === 'flex' ||
                        div.style.justifyContent === 'center' ||
                        div.style.alignItems === 'center') {
                        console.log('💥💥💥💥💥 Removendo div suspeito:', div);
                        div.remove();
                    }
                });
                
                // 5. REMOVER TODOS OS ELEMENTOS QUE ESTEJAM VISÍVEIS NA TELA
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        // Verificar se é um modal
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)') {
                            console.log('💥💥💥💥💥 Removendo elemento visível:', el);
                            el.remove();
                        }
                    }
                });
                
                // 6. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('💥💥💥💥💥 modalContainer limpo');
                }
                
                // 7. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 8. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥💥💥💥💥 fecharModalNUCLEAR executado - SOLUÇÃO EXTREMA');
                
            } catch (e) {
                console.warn('Erro extremo:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES IMEDIATAMENTE
        window.fecharModal = fecharModalNUCLEAR;
        window.fecharModalDIRETO = fecharModalNUCLEAR;
        window.fecharModalRobusto = fecharModalNUCLEAR;
        window.fecharModalAnexosCliente = fecharModalNUCLEAR;
        window.fecharModalSimples = fecharModalNUCLEAR;
        window.fecharModalNUCLEAR = fecharModalNUCLEAR;
        window.fecharModalSUPERRADICAL = fecharModalNUCLEAR;
        window.fecharModalEMERGENCIA = fecharModalNUCLEAR;
        window.fecharModalFINAL = fecharModalNUCLEAR;

        console.log('💥 TODAS AS FUNÇÕES SUBSTITUÍDAS POR fecharModalNUCLEAR - FUNCIONA IMEDIATAMENTE');

        // SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR - EXECUTA IMEDIATAMENTE
        function fecharModalFINAL() {
            console.log('💥💥💥💥💥💥 fecharModalFINAL - SOLUÇÃO IMPOSSÍVEL DE FALHAR');
            
            // MÉTODO IMPOSSÍVEL DE FALHAR: Remover TUDO que estiver na tela
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const selectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]',
                    'div[class*="modal"]', 'div[class*="overlay"]', 'div[class*="backdrop"]'
                ];
                
                selectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        console.log('💥💥💥💥💥💥 Removendo elemento:', selector, el);
                        el.remove();
                    });
                });
                
                // 2. Remover TODOS os elementos com position fixed
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💥💥💥💥💥💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥💥💥💥💥💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. Remover TODOS os divs que possam ser modais
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('modal') || 
                        div.classList.contains('fixed') ||
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.display === 'flex' ||
                        div.style.justifyContent === 'center' ||
                        div.style.alignItems === 'center') {
                        console.log('💥💥💥💥💥💥 Removendo div suspeito:', div);
                        div.remove();
                    }
                });
                
                // 5. REMOVER TODOS OS ELEMENTOS QUE ESTEJAM VISÍVEIS NA TELA
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        // Verificar se é um modal
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)') {
                            console.log('💥💥💥💥💥💥 Removendo elemento visível:', el);
                            el.remove();
                        }
                    }
                });
                
                // 6. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('💥💥💥💥💥💥 modalContainer limpo');
                }
                
                // 7. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 8. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥💥💥💥💥💥 fecharModalFINAL executado - SOLUÇÃO IMPOSSÍVEL DE FALHAR');
                
            } catch (e) {
                console.warn('Erro impossível:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES IMEDIATAMENTE COM A SOLUÇÃO FINAL
        window.fecharModal = fecharModalFINAL;
        window.fecharModalDIRETO = fecharModalFINAL;
        window.fecharModalRobusto = fecharModalFINAL;
        window.fecharModalAnexosCliente = fecharModalFINAL;
        window.fecharModalSimples = fecharModalFINAL;
        window.fecharModalNUCLEAR = fecharModalFINAL;
        window.fecharModalSUPERRADICAL = fecharModalFINAL;
        window.fecharModalEMERGENCIA = fecharModalFINAL;
        window.fecharModalFINAL = fecharModalFINAL;

        console.log('💥💥💥💥💥💥 TODAS AS FUNÇÕES SUBSTITUÍDAS POR fecharModalFINAL - IMPOSSÍVEL DE FALHAR');

        // SOLUÇÃO ULTRA FINAL - EXECUTA IMEDIATAMENTE NO CONSOLE
        function fecharModalULTRA() {
            console.log('💥💥💥💥💥💥💥 fecharModalULTRA - SOLUÇÃO ULTRA FINAL');
            
            // MÉTODO ULTRA FINAL: Remover TUDO que estiver na tela
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const selectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]',
                    'div[class*="modal"]', 'div[class*="overlay"]', 'div[class*="backdrop"]'
                ];
                
                selectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        console.log('💥💥💥💥💥💥💥 Removendo elemento:', selector, el);
                        el.remove();
                    });
                });
                
                // 2. Remover TODOS os elementos com position fixed
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💥💥💥💥💥💥💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥💥💥💥💥💥💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. Remover TODOS os divs que possam ser modais
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('modal') || 
                        div.classList.contains('fixed') ||
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.display === 'flex' ||
                        div.style.justifyContent === 'center' ||
                        div.style.alignItems === 'center') {
                        console.log('💥💥💥💥💥💥💥 Removendo div suspeito:', div);
                        div.remove();
                    }
                });
                
                // 5. REMOVER TODOS OS ELEMENTOS QUE ESTEJAM VISÍVEIS NA TELA
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        // Verificar se é um modal
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)') {
                            console.log('💥💥💥💥💥💥💥 Removendo elemento visível:', el);
                            el.remove();
                        }
                    }
                });
                
                // 6. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('💥💥💥💥💥💥💥 modalContainer limpo');
                }
                
                // 7. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 8. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥💥💥💥💥💥💥 fecharModalULTRA executado - SOLUÇÃO ULTRA FINAL');
                
            } catch (e) {
                console.warn('Erro ultra final:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES IMEDIATAMENTE COM A SOLUÇÃO ULTRA FINAL
        window.fecharModal = fecharModalULTRA;
        window.fecharModalDIRETO = fecharModalULTRA;
        window.fecharModalRobusto = fecharModalULTRA;
        window.fecharModalAnexosCliente = fecharModalULTRA;
        window.fecharModalSimples = fecharModalULTRA;
        window.fecharModalNUCLEAR = fecharModalULTRA;
        window.fecharModalSUPERRADICAL = fecharModalULTRA;
        window.fecharModalEMERGENCIA = fecharModalULTRA;
        window.fecharModalFINAL = fecharModalULTRA;
        window.fecharModalULTRA = fecharModalULTRA;

        console.log('💥💥💥💥💥💥💥 TODAS AS FUNÇÕES SUBSTITUÍDAS POR fecharModalULTRA - SOLUÇÃO ULTRA FINAL');

        // EXECUTAR IMEDIATAMENTE NO CONSOLE
        console.log('💥💥💥💥💥💥💥 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO ULTRA FINAL');
        fecharModalULTRA();

        // SOLUÇÃO EXTREMA FINAL - EXECUTA IMEDIATAMENTE NO CONSOLE
        function fecharModalEXTREMO() {
            console.log('💥💥💥💥💥💥💥💥 fecharModalEXTREMO - SOLUÇÃO EXTREMA FINAL');
            
            // MÉTODO EXTREMO FINAL: Remover TUDO que estiver na tela
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const selectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]',
                    'div[class*="modal"]', 'div[class*="overlay"]', 'div[class*="backdrop"]'
                ];
                
                selectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        console.log('💥💥💥💥💥💥💥💥 Removendo elemento:', selector, el);
                        el.remove();
                    });
                });
                
                // 2. Remover TODOS os elementos com position fixed
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💥💥💥💥💥💥💥💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥💥💥💥💥💥💥💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. Remover TODOS os divs que possam ser modais
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('modal') || 
                        div.classList.contains('fixed') ||
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.display === 'flex' ||
                        div.style.justifyContent === 'center' ||
                        div.style.alignItems === 'center') {
                        console.log('💥💥💥💥💥💥💥💥 Removendo div suspeito:', div);
                        div.remove();
                    }
                });
                
                // 5. REMOVER TODOS OS ELEMENTOS QUE ESTEJAM VISÍVEIS NA TELA
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        // Verificar se é um modal
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)') {
                            console.log('💥💥💥💥💥💥💥💥 Removendo elemento visível:', el);
                            el.remove();
                        }
                    }
                });
                
                // 6. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('💥💥💥💥💥💥💥💥 modalContainer limpo');
                }
                
                // 7. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 8. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥💥💥💥💥💥💥💥 fecharModalEXTREMO executado - SOLUÇÃO EXTREMA FINAL');
                
            } catch (e) {
                console.warn('Erro extremo final:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES IMEDIATAMENTE COM A SOLUÇÃO EXTREMA FINAL
        window.fecharModal = fecharModalEXTREMO;
        window.fecharModalDIRETO = fecharModalEXTREMO;
        window.fecharModalRobusto = fecharModalEXTREMO;
        window.fecharModalAnexosCliente = fecharModalEXTREMO;
        window.fecharModalSimples = fecharModalEXTREMO;
        window.fecharModalNUCLEAR = fecharModalEXTREMO;
        window.fecharModalSUPERRADICAL = fecharModalEXTREMO;
        window.fecharModalEMERGENCIA = fecharModalEXTREMO;
        window.fecharModalFINAL = fecharModalEXTREMO;
        window.fecharModalULTRA = fecharModalEXTREMO;
        window.fecharModalEXTREMO = fecharModalEXTREMO;

        console.log('💥💥💥💥💥💥💥💥 TODAS AS FUNÇÕES SUBSTITUÍDAS POR fecharModalEXTREMO - SOLUÇÃO EXTREMA FINAL');

        // EXECUTAR IMEDIATAMENTE NO CONSOLE
        console.log('💥💥💥💥💥💥💥💥 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO EXTREMA FINAL');
        fecharModalEXTREMO();

        // SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR - EXECUTA IMEDIATAMENTE NO CONSOLE
        function fecharModalIMPOSSIVEL() {
            console.log('💥💥💥💥💥💥💥💥💥 fecharModalIMPOSSIVEL - SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR');
            
            // MÉTODO IMPOSSÍVEL DE FALHAR: Remover TUDO que estiver na tela
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const selectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]',
                    'div[class*="modal"]', 'div[class*="overlay"]', 'div[class*="backdrop"]'
                ];
                
                selectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        console.log('💥💥💥💥💥💥💥💥💥 Removendo elemento:', selector, el);
                        el.remove();
                    });
                });
                
                // 2. Remover TODOS os elementos com position fixed
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💥💥💥💥💥💥💥💥💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥💥💥💥💥💥💥💥💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. Remover TODOS os divs que possam ser modais
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('modal') || 
                        div.classList.contains('fixed') ||
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.display === 'flex' ||
                        div.style.justifyContent === 'center' ||
                        div.style.alignItems === 'center') {
                        console.log('💥💥💥💥💥💥💥💥💥 Removendo div suspeito:', div);
                        div.remove();
                    }
                });
                
                // 5. REMOVER TODOS OS ELEMENTOS QUE ESTEJAM VISÍVEIS NA TELA
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        // Verificar se é um modal
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)') {
                            console.log('💥💥💥💥💥💥💥💥💥 Removendo elemento visível:', el);
                            el.remove();
                        }
                    }
                });
                
                // 6. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('💥💥💥💥💥💥💥💥💥 modalContainer limpo');
                }
                
                // 7. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 8. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥💥💥💥💥💥💥💥💥 fecharModalIMPOSSIVEL executado - SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR');
                
            } catch (e) {
                console.warn('Erro impossível de falhar:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES IMEDIATAMENTE COM A SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR
        window.fecharModal = fecharModalIMPOSSIVEL;
        window.fecharModalDIRETO = fecharModalIMPOSSIVEL;
        window.fecharModalRobusto = fecharModalIMPOSSIVEL;
        window.fecharModalAnexosCliente = fecharModalIMPOSSIVEL;
        window.fecharModalSimples = fecharModalIMPOSSIVEL;
        window.fecharModalNUCLEAR = fecharModalIMPOSSIVEL;
        window.fecharModalSUPERRADICAL = fecharModalIMPOSSIVEL;
        window.fecharModalEMERGENCIA = fecharModalIMPOSSIVEL;
        window.fecharModalFINAL = fecharModalIMPOSSIVEL;
        window.fecharModalULTRA = fecharModalIMPOSSIVEL;
        window.fecharModalEXTREMO = fecharModalIMPOSSIVEL;
        window.fecharModalIMPOSSIVEL = fecharModalIMPOSSIVEL;

        console.log('💥💥💥💥💥💥💥💥💥 TODAS AS FUNÇÕES SUBSTITUÍDAS POR fecharModalIMPOSSIVEL - SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR');

        // EXECUTAR IMEDIATAMENTE NO CONSOLE
        console.log('💥💥💥💥💥💥💥💥💥 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR');
        fecharModalIMPOSSIVEL();

        // SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR - EXECUTA IMEDIATAMENTE NO CONSOLE
        function fecharModalULTRAIMPOSSIVEL() {
            console.log('💥💥💥💥💥💥💥💥💥💥 fecharModalULTRAIMPOSSIVEL - SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR');
            
            // MÉTODO ULTRA FINAL IMPOSSÍVEL DE FALHAR: Remover TUDO que estiver na tela
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const selectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]',
                    'div[class*="modal"]', 'div[class*="overlay"]', 'div[class*="backdrop"]'
                ];
                
                selectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        console.log('💥💥💥💥💥💥💥💥💥💥 Removendo elemento:', selector, el);
                        el.remove();
                    });
                });
                
                // 2. Remover TODOS os elementos com position fixed
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💥💥💥💥💥💥💥💥💥💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥💥💥💥💥💥💥💥💥💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. Remover TODOS os divs que possam ser modais
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('modal') || 
                        div.classList.contains('fixed') ||
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.display === 'flex' ||
                        div.style.justifyContent === 'center' ||
                        div.style.alignItems === 'center') {
                        console.log('💥💥💥💥💥💥💥💥💥💥 Removendo div suspeito:', div);
                        div.remove();
                    }
                });
                
                // 5. REMOVER TODOS OS ELEMENTOS QUE ESTEJAM VISÍVEIS NA TELA
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        // Verificar se é um modal
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)') {
                            console.log('💥💥💥💥💥💥💥💥💥💥 Removendo elemento visível:', el);
                            el.remove();
                        }
                    }
                });
                
                // 6. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('💥💥💥💥💥💥💥💥💥💥 modalContainer limpo');
                }
                
                // 7. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 8. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥💥💥💥💥💥💥💥💥💥 fecharModalULTRAIMPOSSIVEL executado - SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR');
                
            } catch (e) {
                console.warn('Erro ultra final impossível de falhar:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES IMEDIATAMENTE COM A SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR
        window.fecharModal = fecharModalULTRAIMPOSSIVEL;
        window.fecharModalDIRETO = fecharModalULTRAIMPOSSIVEL;
        window.fecharModalRobusto = fecharModalULTRAIMPOSSIVEL;
        window.fecharModalAnexosCliente = fecharModalULTRAIMPOSSIVEL;
        window.fecharModalSimples = fecharModalULTRAIMPOSSIVEL;
        window.fecharModalNUCLEAR = fecharModalULTRAIMPOSSIVEL;
        window.fecharModalSUPERRADICAL = fecharModalULTRAIMPOSSIVEL;
        window.fecharModalEMERGENCIA = fecharModalULTRAIMPOSSIVEL;
        window.fecharModalFINAL = fecharModalULTRAIMPOSSIVEL;
        window.fecharModalULTRA = fecharModalULTRAIMPOSSIVEL;
        window.fecharModalEXTREMO = fecharModalULTRAIMPOSSIVEL;
        window.fecharModalIMPOSSIVEL = fecharModalULTRAIMPOSSIVEL;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalULTRAIMPOSSIVEL;

        console.log('💥💥💥💥💥💥💥💥💥💥 TODAS AS FUNÇÕES SUBSTITUÍDAS POR fecharModalULTRAIMPOSSIVEL - SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR');

        // EXECUTAR IMEDIATAMENTE NO CONSOLE
        console.log('💥💥💥💥💥💥💥💥💥💥 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR');
        fecharModalULTRAIMPOSSIVEL();

        // SOLUÇÃO EXTREMA FINAL IMPOSSÍVEL DE FALHAR - EXECUTA IMEDIATAMENTE NO CONSOLE
        function fecharModalEXTREMAIMPOSSIVEL() {
            console.log('💥💥💥💥💥💥💥💥💥💥💥 fecharModalEXTREMAIMPOSSIVEL - SOLUÇÃO EXTREMA FINAL IMPOSSÍVEL DE FALHAR');
            
            // MÉTODO EXTREMA FINAL IMPOSSÍVEL DE FALHAR: Remover TUDO que estiver na tela
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const selectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]',
                    'div[class*="modal"]', 'div[class*="overlay"]', 'div[class*="backdrop"]'
                ];
                
                selectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento:', selector, el);
                        el.remove();
                    });
                });
                
                // 2. Remover TODOS os elementos com position fixed
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. Remover TODOS os divs que possam ser modais
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('modal') || 
                        div.classList.contains('fixed') ||
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.display === 'flex' ||
                        div.style.justifyContent === 'center' ||
                        div.style.alignItems === 'center') {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥 Removendo div suspeito:', div);
                        div.remove();
                    }
                });
                
                // 5. REMOVER TODOS OS ELEMENTOS QUE ESTEJAM VISÍVEIS NA TELA
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        // Verificar se é um modal
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)') {
                            console.log('💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento visível:', el);
                            el.remove();
                        }
                    }
                });
                
                // 6. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('💥💥💥💥💥💥💥💥💥💥💥 modalContainer limpo');
                }
                
                // 7. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 8. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥💥💥💥💥💥💥💥💥💥💥 fecharModalEXTREMAIMPOSSIVEL executado - SOLUÇÃO EXTREMA FINAL IMPOSSÍVEL DE FALHAR');
                
            } catch (e) {
                console.warn('Erro extrema final impossível de falhar:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES IMEDIATAMENTE COM A SOLUÇÃO EXTREMA FINAL IMPOSSÍVEL DE FALHAR
        window.fecharModal = fecharModalEXTREMAIMPOSSIVEL;
        window.fecharModalDIRETO = fecharModalEXTREMAIMPOSSIVEL;
        window.fecharModalRobusto = fecharModalEXTREMAIMPOSSIVEL;
        window.fecharModalAnexosCliente = fecharModalEXTREMAIMPOSSIVEL;
        window.fecharModalSimples = fecharModalEXTREMAIMPOSSIVEL;
        window.fecharModalNUCLEAR = fecharModalEXTREMAIMPOSSIVEL;
        window.fecharModalSUPERRADICAL = fecharModalEXTREMAIMPOSSIVEL;
        window.fecharModalEMERGENCIA = fecharModalEXTREMAIMPOSSIVEL;
        window.fecharModalFINAL = fecharModalEXTREMAIMPOSSIVEL;
        window.fecharModalULTRA = fecharModalEXTREMAIMPOSSIVEL;
        window.fecharModalEXTREMO = fecharModalEXTREMAIMPOSSIVEL;
        window.fecharModalIMPOSSIVEL = fecharModalEXTREMAIMPOSSIVEL;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalEXTREMAIMPOSSIVEL;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalEXTREMAIMPOSSIVEL;

        console.log('💥💥💥💥💥💥💥💥💥💥💥 TODAS AS FUNÇÕES SUBSTITUÍDAS POR fecharModalEXTREMAIMPOSSIVEL - SOLUÇÃO EXTREMA FINAL IMPOSSÍVEL DE FALHAR');

        // EXECUTAR IMEDIATAMENTE NO CONSOLE
        console.log('💥💥💥💥💥💥💥💥💥💥💥 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO EXTREMA FINAL IMPOSSÍVEL DE FALHAR');
        fecharModalEXTREMAIMPOSSIVEL();

        // SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR - EXECUTA IMEDIATAMENTE NO CONSOLE
        function fecharModalFINALIMPOSSIVEL() {
            console.log('💥💥💥💥💥💥💥💥💥💥💥💥 fecharModalFINALIMPOSSIVEL - SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR');
            
            // MÉTODO FINAL IMPOSSÍVEL DE FALHAR: Remover TUDO que estiver na tela
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const selectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]',
                    'div[class*="modal"]', 'div[class*="overlay"]', 'div[class*="backdrop"]'
                ];
                
                selectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento:', selector, el);
                        el.remove();
                    });
                });
                
                // 2. Remover TODOS os elementos com position fixed
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. Remover TODOS os divs que possam ser modais
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('modal') || 
                        div.classList.contains('fixed') ||
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.display === 'flex' ||
                        div.style.justifyContent === 'center' ||
                        div.style.alignItems === 'center') {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥 Removendo div suspeito:', div);
                        div.remove();
                    }
                });
                
                // 5. REMOVER TODOS OS ELEMENTOS QUE ESTEJAM VISÍVEIS NA TELA
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        // Verificar se é um modal
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)') {
                            console.log('💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento visível:', el);
                            el.remove();
                        }
                    }
                });
                
                // 6. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('💥💥💥💥💥💥💥💥💥💥💥💥 modalContainer limpo');
                }
                
                // 7. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 8. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥💥💥💥💥💥💥💥💥💥💥💥 fecharModalFINALIMPOSSIVEL executado - SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR');
                
            } catch (e) {
                console.warn('Erro final impossível de falhar:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES IMEDIATAMENTE COM A SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR
        window.fecharModal = fecharModalFINALIMPOSSIVEL;
        window.fecharModalDIRETO = fecharModalFINALIMPOSSIVEL;
        window.fecharModalRobusto = fecharModalFINALIMPOSSIVEL;
        window.fecharModalAnexosCliente = fecharModalFINALIMPOSSIVEL;
        window.fecharModalSimples = fecharModalFINALIMPOSSIVEL;
        window.fecharModalNUCLEAR = fecharModalFINALIMPOSSIVEL;
        window.fecharModalSUPERRADICAL = fecharModalFINALIMPOSSIVEL;
        window.fecharModalEMERGENCIA = fecharModalFINALIMPOSSIVEL;
        window.fecharModalFINAL = fecharModalFINALIMPOSSIVEL;
        window.fecharModalULTRA = fecharModalFINALIMPOSSIVEL;
        window.fecharModalEXTREMO = fecharModalFINALIMPOSSIVEL;
        window.fecharModalIMPOSSIVEL = fecharModalFINALIMPOSSIVEL;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalFINALIMPOSSIVEL;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalFINALIMPOSSIVEL;
        window.fecharModalFINALIMPOSSIVEL = fecharModalFINALIMPOSSIVEL;

        console.log('💥💥💥💥💥💥💥💥💥💥💥💥 TODAS AS FUNÇÕES SUBSTITUÍDAS POR fecharModalFINALIMPOSSIVEL - SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR');

        // EXECUTAR IMEDIATAMENTE NO CONSOLE
        console.log('💥💥💥💥💥💥💥💥💥💥💥💥 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR');
        fecharModalFINALIMPOSSIVEL();

        // SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR - EXECUTA IMEDIATAMENTE NO CONSOLE
        function fecharModalULTRAIMPOSSIVELFINAL() {
            console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥 fecharModalULTRAIMPOSSIVELFINAL - SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR');
            
            // MÉTODO ULTRA FINAL IMPOSSÍVEL DE FALHAR: Remover TUDO que estiver na tela
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const selectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]',
                    'div[class*="modal"]', 'div[class*="overlay"]', 'div[class*="backdrop"]'
                ];
                
                selectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento:', selector, el);
                        el.remove();
                    });
                });
                
                // 2. Remover TODOS os elementos com position fixed
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. Remover TODOS os divs que possam ser modais
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('modal') || 
                        div.classList.contains('fixed') ||
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.display === 'flex' ||
                        div.style.justifyContent === 'center' ||
                        div.style.alignItems === 'center') {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo div suspeito:', div);
                        div.remove();
                    }
                });
                
                // 5. REMOVER TODOS OS ELEMENTOS QUE ESTEJAM VISÍVEIS NA TELA
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        // Verificar se é um modal
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)') {
                            console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento visível:', el);
                            el.remove();
                        }
                    }
                });
                
                // 6. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥 modalContainer limpo');
                }
                
                // 7. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 8. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥 fecharModalULTRAIMPOSSIVELFINAL executado - SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR');
                
            } catch (e) {
                console.warn('Erro ultra final impossível de falhar:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES IMEDIATAMENTE COM A SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR
        window.fecharModal = fecharModalULTRAIMPOSSIVELFINAL;
        window.fecharModalDIRETO = fecharModalULTRAIMPOSSIVELFINAL;
        window.fecharModalRobusto = fecharModalULTRAIMPOSSIVELFINAL;
        window.fecharModalAnexosCliente = fecharModalULTRAIMPOSSIVELFINAL;
        window.fecharModalSimples = fecharModalULTRAIMPOSSIVELFINAL;
        window.fecharModalNUCLEAR = fecharModalULTRAIMPOSSIVELFINAL;
        window.fecharModalSUPERRADICAL = fecharModalULTRAIMPOSSIVELFINAL;
        window.fecharModalEMERGENCIA = fecharModalULTRAIMPOSSIVELFINAL;
        window.fecharModalFINAL = fecharModalULTRAIMPOSSIVELFINAL;
        window.fecharModalULTRA = fecharModalULTRAIMPOSSIVELFINAL;
        window.fecharModalEXTREMO = fecharModalULTRAIMPOSSIVELFINAL;
        window.fecharModalIMPOSSIVEL = fecharModalULTRAIMPOSSIVELFINAL;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalULTRAIMPOSSIVELFINAL;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalULTRAIMPOSSIVELFINAL;
        window.fecharModalFINALIMPOSSIVEL = fecharModalULTRAIMPOSSIVELFINAL;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalULTRAIMPOSSIVELFINAL;

        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥 TODAS AS FUNÇÕES SUBSTITUÍDAS POR fecharModalULTRAIMPOSSIVELFINAL - SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR');

        // EXECUTAR IMEDIATAMENTE NO CONSOLE
        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR');
        fecharModalULTRAIMPOSSIVELFINAL();

        // SOLUÇÃO EXTREMA FINAL IMPOSSÍVEL DE FALHAR - EXECUTA IMEDIATAMENTE NO CONSOLE
        function fecharModalEXTREMAIMPOSSIVELFINAL() {
            console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥 fecharModalEXTREMAIMPOSSIVELFINAL - SOLUÇÃO EXTREMA FINAL IMPOSSÍVEL DE FALHAR');
            
            // MÉTODO EXTREMA FINAL IMPOSSÍVEL DE FALHAR: Remover TUDO que estiver na tela
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const selectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]',
                    'div[class*="modal"]', 'div[class*="overlay"]', 'div[class*="backdrop"]'
                ];
                
                selectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento:', selector, el);
                        el.remove();
                    });
                });
                
                // 2. Remover TODOS os elementos com position fixed
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. Remover TODOS os divs que possam ser modais
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('modal') || 
                        div.classList.contains('fixed') ||
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.display === 'flex' ||
                        div.style.justifyContent === 'center' ||
                        div.style.alignItems === 'center') {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo div suspeito:', div);
                        div.remove();
                    }
                });
                
                // 5. REMOVER TODOS OS ELEMENTOS QUE ESTEJAM VISÍVEIS NA TELA
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        // Verificar se é um modal
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)') {
                            console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento visível:', el);
                            el.remove();
                        }
                    }
                });
                
                // 6. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥 modalContainer limpo');
                }
                
                // 7. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 8. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥 fecharModalEXTREMAIMPOSSIVELFINAL executado - SOLUÇÃO EXTREMA FINAL IMPOSSÍVEL DE FALHAR');
                
            } catch (e) {
                console.warn('Erro extrema final impossível de falhar:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES IMEDIATAMENTE COM A SOLUÇÃO EXTREMA FINAL IMPOSSÍVEL DE FALHAR
        window.fecharModal = fecharModalEXTREMAIMPOSSIVELFINAL;
        window.fecharModalDIRETO = fecharModalEXTREMAIMPOSSIVELFINAL;
        window.fecharModalRobusto = fecharModalEXTREMAIMPOSSIVELFINAL;
        window.fecharModalAnexosCliente = fecharModalEXTREMAIMPOSSIVELFINAL;
        window.fecharModalSimples = fecharModalEXTREMAIMPOSSIVELFINAL;
        window.fecharModalNUCLEAR = fecharModalEXTREMAIMPOSSIVELFINAL;
        window.fecharModalSUPERRADICAL = fecharModalEXTREMAIMPOSSIVELFINAL;
        window.fecharModalEMERGENCIA = fecharModalEXTREMAIMPOSSIVELFINAL;
        window.fecharModalFINAL = fecharModalEXTREMAIMPOSSIVELFINAL;
        window.fecharModalULTRA = fecharModalEXTREMAIMPOSSIVELFINAL;
        window.fecharModalEXTREMO = fecharModalEXTREMAIMPOSSIVELFINAL;
        window.fecharModalIMPOSSIVEL = fecharModalEXTREMAIMPOSSIVELFINAL;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalEXTREMAIMPOSSIVELFINAL;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalEXTREMAIMPOSSIVELFINAL;
        window.fecharModalFINALIMPOSSIVEL = fecharModalEXTREMAIMPOSSIVELFINAL;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalEXTREMAIMPOSSIVELFINAL;
        window.fecharModalEXTREMAIMPOSSIVELFINAL = fecharModalEXTREMAIMPOSSIVELFINAL;

        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥 TODAS AS FUNÇÕES SUBSTITUÍDAS POR fecharModalEXTREMAIMPOSSIVELFINAL - SOLUÇÃO EXTREMA FINAL IMPOSSÍVEL DE FALHAR');

        // EXECUTAR IMEDIATAMENTE NO CONSOLE
        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO EXTREMA FINAL IMPOSSÍVEL DE FALHAR');
        fecharModalEXTREMAIMPOSSIVELFINAL();

        // COMANDO DA CONSOLE QUE FUNCIONOU ONTEM - APLICADO AUTOMATICAMENTE
        function fecharModalCONSOLEFUNCIONOU() {
            console.log('🚀 COMANDO DA CONSOLE QUE FUNCIONOU ONTEM - APLICADO AUTOMATICAMENTE');
            
            // COMANDO EXATO QUE FUNCIONOU ONTEM:
            // Remover TODOS os elementos .fixed e .inset-0
            document.querySelectorAll('.fixed, .inset-0').forEach(el => {
                console.log('🚀 Removendo elemento:', el);
                el.remove();
            });
            console.log('🚀 Elementos removidos!');
            
            // Limpar modalContainer
            const modalContainer = document.getElementById('modalContainer');
            if (modalContainer) {
                modalContainer.innerHTML = '';
                modalContainer.style.display = 'none';
                console.log('🚀 modalContainer limpo');
            }
            
            // Restaurar scroll
            document.body.style.overflow = '';
            document.documentElement.style.overflow = '';
            
            console.log('🚀 COMANDO DA CONSOLE QUE FUNCIONOU ONTEM EXECUTADO - APLICADO AUTOMATICAMENTE');
        }

        // SUBSTITUIR TODAS AS FUNÇÕES COM O COMANDO QUE FUNCIONOU ONTEM
        window.fecharModal = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalDIRETO = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalRobusto = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalAnexosCliente = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalSimples = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalNUCLEAR = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalSUPERRADICAL = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalEMERGENCIA = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalFINAL = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalULTRA = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalEXTREMO = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalIMPOSSIVEL = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalFINALIMPOSSIVEL = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalEXTREMAIMPOSSIVELFINAL = fecharModalCONSOLEFUNCIONOU;
        window.fecharModalCONSOLEFUNCIONOU = fecharModalCONSOLEFUNCIONOU;

        console.log('🚀 TODAS AS FUNÇÕES SUBSTITUÍDAS PELO COMANDO DA CONSOLE QUE FUNCIONOU ONTEM - APLICADO AUTOMATICAMENTE');

        // EXECUTAR IMEDIATAMENTE O COMANDO QUE FUNCIONOU ONTEM
        console.log('🚀 EXECUTANDO IMEDIATAMENTE - COMANDO DA CONSOLE QUE FUNCIONOU ONTEM');
        fecharModalCONSOLEFUNCIONOU();

        // SOLUÇÃO QUE REMOVE TODOS OS ELEMENTOS VISÍVEIS NA TELA
        function fecharModalREMOVERTODOSVISIVEIS() {
            console.log('💥💥💥 REMOVENDO TODOS OS ELEMENTOS VISÍVEIS NA TELA - SOLUÇÃO DEFINITIVA');
            
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const selectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]',
                    'div[class*="modal"]', 'div[class*="overlay"]', 'div[class*="backdrop"]'
                ];
                
                selectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        console.log('💥💥💥 Removendo elemento:', selector, el);
                        el.remove();
                    });
                });
                
                // 2. Remover TODOS os elementos com position fixed
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💥💥💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥💥💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. REMOVER TODOS OS ELEMENTOS QUE ESTEJAM VISÍVEIS NA TELA
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        // Verificar se é um modal ou elemento suspeito
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.display === 'flex' ||
                            el.style.justifyContent === 'center' ||
                            el.style.alignItems === 'center' ||
                            el.tagName === 'DIV' && el.style.position === 'absolute' ||
                            el.tagName === 'DIV' && el.style.zIndex >= 10) {
                            console.log('💥💥💥 Removendo elemento visível:', el);
                            el.remove();
                        }
                    }
                });
                
                // 5. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('💥💥💥 modalContainer limpo');
                }
                
                // 6. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 7. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥💥💥 TODOS OS ELEMENTOS VISÍVEIS REMOVIDOS - SOLUÇÃO DEFINITIVA');
                
            } catch (e) {
                console.warn('Erro ao remover elementos visíveis:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES COM A SOLUÇÃO QUE REMOVE TODOS OS ELEMENTOS VISÍVEIS
        window.fecharModal = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalDIRETO = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalRobusto = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalAnexosCliente = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalSimples = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalNUCLEAR = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalSUPERRADICAL = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalEMERGENCIA = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalFINAL = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalULTRA = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalEXTREMO = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalIMPOSSIVEL = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalFINALIMPOSSIVEL = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalEXTREMAIMPOSSIVELFINAL = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalCONSOLEFUNCIONOU = fecharModalREMOVERTODOSVISIVEIS;
        window.fecharModalREMOVERTODOSVISIVEIS = fecharModalREMOVERTODOSVISIVEIS;

        console.log('💥💥💥 TODAS AS FUNÇÕES SUBSTITUÍDAS PELA SOLUÇÃO QUE REMOVE TODOS OS ELEMENTOS VISÍVEIS');

        // EXECUTAR IMEDIATAMENTE A SOLUÇÃO QUE REMOVE TODOS OS ELEMENTOS VISÍVEIS
        console.log('💥💥💥 EXECUTANDO IMEDIATAMENTE - REMOVENDO TODOS OS ELEMENTOS VISÍVEIS');
        fecharModalREMOVERTODOSVISIVEIS();

        // SOLUÇÃO IMPOSSÍVEL DE FALHAR - REMOVE TUDO QUE ESTIVER NA TELA
        function fecharModalIMPOSSIVELFALHAR() {
            console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 IMPOSSÍVEL DE FALHAR - REMOVE TUDO NA TELA');
            
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const selectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]',
                    'div[class*="modal"]', 'div[class*="overlay"]', 'div[class*="backdrop"]'
                ];
                
                selectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento:', selector, el);
                        el.remove();
                    });
                });
                
                // 2. Remover TODOS os elementos com position fixed
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. REMOVER TODOS OS ELEMENTOS QUE ESTEJAM VISÍVEIS NA TELA
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        // Verificar se é um modal ou elemento suspeito
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.display === 'flex' ||
                            el.style.justifyContent === 'center' ||
                            el.style.alignItems === 'center' ||
                            el.tagName === 'DIV' && el.style.position === 'absolute' ||
                            el.tagName === 'DIV' && el.style.zIndex >= 10) {
                            console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento visível:', el);
                            el.remove();
                        }
                    }
                });
                
                // 5. REMOVER TODOS OS DIVS QUE POSSAM SER MODAIS
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('modal') || 
                        div.classList.contains('fixed') ||
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.display === 'flex' ||
                        div.style.justifyContent === 'center' ||
                        div.style.alignItems === 'center' ||
                        div.style.position === 'absolute' ||
                        div.style.zIndex >= 10) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo div suspeito:', div);
                        div.remove();
                    }
                });
                
                // 6. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 modalContainer limpo');
                }
                
                // 7. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 8. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 IMPOSSÍVEL DE FALHAR EXECUTADO - REMOVE TUDO NA TELA');
                
            } catch (e) {
                console.warn('Erro impossível de falhar:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES COM A SOLUÇÃO IMPOSSÍVEL DE FALHAR
        window.fecharModal = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalDIRETO = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalRobusto = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalAnexosCliente = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalSimples = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalNUCLEAR = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalSUPERRADICAL = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalEMERGENCIA = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalFINAL = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalULTRA = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalEXTREMO = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalIMPOSSIVEL = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalFINALIMPOSSIVEL = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalEXTREMAIMPOSSIVELFINAL = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalCONSOLEFUNCIONOU = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalREMOVERTODOSVISIVEIS = fecharModalIMPOSSIVELFALHAR;
        window.fecharModalIMPOSSIVELFALHAR = fecharModalIMPOSSIVELFALHAR;

        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 TODAS AS FUNÇÕES SUBSTITUÍDAS PELA SOLUÇÃO IMPOSSÍVEL DE FALHAR');

        // EXECUTAR IMEDIATAMENTE A SOLUÇÃO IMPOSSÍVEL DE FALHAR
        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO IMPOSSÍVEL DE FALHAR');
        fecharModalIMPOSSIVELFALHAR();

        // SOLUÇÃO ULTRA IMPOSSÍVEL DE FALHAR - REMOVE TUDO QUE ESTIVER NA TELA
        function fecharModalULTRAIMPOSSIVELFALHAR() {
            console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 ULTRA IMPOSSÍVEL DE FALHAR - REMOVE TUDO NA TELA');
            
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const selectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]',
                    'div[class*="modal"]', 'div[class*="overlay"]', 'div[class*="backdrop"]'
                ];
                
                selectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento:', selector, el);
                        el.remove();
                    });
                });
                
                // 2. Remover TODOS os elementos com position fixed
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. REMOVER TODOS OS ELEMENTOS QUE ESTEJAM VISÍVEIS NA TELA
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        // Verificar se é um modal ou elemento suspeito
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.display === 'flex' ||
                            el.style.justifyContent === 'center' ||
                            el.style.alignItems === 'center' ||
                            el.tagName === 'DIV' && el.style.position === 'absolute' ||
                            el.tagName === 'DIV' && el.style.zIndex >= 10) {
                            console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento visível:', el);
                            el.remove();
                        }
                    }
                });
                
                // 5. REMOVER TODOS OS DIVS QUE POSSAM SER MODAIS
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('modal') || 
                        div.classList.contains('fixed') ||
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.display === 'flex' ||
                        div.style.justifyContent === 'center' ||
                        div.style.alignItems === 'center' ||
                        div.style.position === 'absolute' ||
                        div.style.zIndex >= 10) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo div suspeito:', div);
                        div.remove();
                    }
                });
                
                // 6. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Documentos de"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Documentos de')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Documentos de":', el);
                        el.remove();
                    }
                });
                
                // 7. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 modalContainer limpo');
                }
                
                // 8. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 9. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 ULTRA IMPOSSÍVEL DE FALHAR EXECUTADO - REMOVE TUDO NA TELA');
                
            } catch (e) {
                console.warn('Erro ultra impossível de falhar:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES COM A SOLUÇÃO ULTRA IMPOSSÍVEL DE FALHAR
        window.fecharModal = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalDIRETO = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalRobusto = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalAnexosCliente = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalSimples = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalNUCLEAR = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalSUPERRADICAL = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalEMERGENCIA = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalFINAL = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalULTRA = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalEXTREMO = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalIMPOSSIVEL = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalFINALIMPOSSIVEL = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalEXTREMAIMPOSSIVELFINAL = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalCONSOLEFUNCIONOU = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalREMOVERTODOSVISIVEIS = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalIMPOSSIVELFALHAR = fecharModalULTRAIMPOSSIVELFALHAR;
        window.fecharModalULTRAIMPOSSIVELFALHAR = fecharModalULTRAIMPOSSIVELFALHAR;

        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 TODAS AS FUNÇÕES SUBSTITUÍDAS PELA SOLUÇÃO ULTRA IMPOSSÍVEL DE FALHAR');

        // EXECUTAR IMEDIATAMENTE A SOLUÇÃO ULTRA IMPOSSÍVEL DE FALHAR
        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO ULTRA IMPOSSÍVEL DE FALHAR');
        fecharModalULTRAIMPOSSIVELFALHAR();

        // SOLUÇÃO EXTREMA IMPOSSÍVEL DE FALHAR - REMOVE TUDO QUE ESTIVER NA TELA
        function fecharModalEXTREMAIMPOSSIVELFALHAR() {
            console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 EXTREMA IMPOSSÍVEL DE FALHAR - REMOVE TUDO NA TELA');
            
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const selectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]',
                    'div[class*="modal"]', 'div[class*="overlay"]', 'div[class*="backdrop"]'
                ];
                
                selectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento:', selector, el);
                        el.remove();
                    });
                });
                
                // 2. Remover TODOS os elementos com position fixed
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. REMOVER TODOS OS ELEMENTOS QUE ESTEJAM VISÍVEIS NA TELA
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        // Verificar se é um modal ou elemento suspeito
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.display === 'flex' ||
                            el.style.justifyContent === 'center' ||
                            el.style.alignItems === 'center' ||
                            el.tagName === 'DIV' && el.style.position === 'absolute' ||
                            el.tagName === 'DIV' && el.style.zIndex >= 10) {
                            console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento visível:', el);
                            el.remove();
                        }
                    }
                });
                
                // 5. REMOVER TODOS OS DIVS QUE POSSAM SER MODAIS
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('modal') || 
                        div.classList.contains('fixed') ||
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.display === 'flex' ||
                        div.style.justifyContent === 'center' ||
                        div.style.alignItems === 'center' ||
                        div.style.position === 'absolute' ||
                        div.style.zIndex >= 10) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo div suspeito:', div);
                        div.remove();
                    }
                });
                
                // 6. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Documentos de"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Documentos de')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Documentos de":', el);
                        el.remove();
                    }
                });
                
                // 7. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Adicionar Novo Documento"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Adicionar Novo Documento')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Adicionar Novo Documento":', el);
                        el.remove();
                    }
                });
                
                // 8. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Nome do Documento"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Nome do Documento')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Nome do Documento":', el);
                        el.remove();
                    }
                });
                
                // 9. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 modalContainer limpo');
                }
                
                // 10. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 11. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 EXTREMA IMPOSSÍVEL DE FALHAR EXECUTADO - REMOVE TUDO NA TELA');
                
            } catch (e) {
                console.warn('Erro extrema impossível de falhar:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES COM A SOLUÇÃO EXTREMA IMPOSSÍVEL DE FALHAR
        window.fecharModal = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalDIRETO = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalRobusto = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalAnexosCliente = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalSimples = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalNUCLEAR = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalSUPERRADICAL = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalEMERGENCIA = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalFINAL = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalULTRA = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalEXTREMO = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalIMPOSSIVEL = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalFINALIMPOSSIVEL = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalEXTREMAIMPOSSIVELFINAL = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalCONSOLEFUNCIONOU = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalREMOVERTODOSVISIVEIS = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalIMPOSSIVELFALHAR = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalULTRAIMPOSSIVELFALHAR = fecharModalEXTREMAIMPOSSIVELFALHAR;
        window.fecharModalEXTREMAIMPOSSIVELFALHAR = fecharModalEXTREMAIMPOSSIVELFALHAR;

        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 TODAS AS FUNÇÕES SUBSTITUÍDAS PELA SOLUÇÃO EXTREMA IMPOSSÍVEL DE FALHAR');

        // EXECUTAR IMEDIATAMENTE A SOLUÇÃO EXTREMA IMPOSSÍVEL DE FALHAR
        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO EXTREMA IMPOSSÍVEL DE FALHAR');
        fecharModalEXTREMAIMPOSSIVELFALHAR();

        // SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR - REMOVE TUDO QUE ESTIVER NA TELA
        function fecharModalFINALIMPOSSIVELFALHAR() {
            console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 FINAL IMPOSSÍVEL DE FALHAR - REMOVE TUDO NA TELA');
            
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const selectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]',
                    'div[class*="modal"]', 'div[class*="overlay"]', 'div[class*="backdrop"]'
                ];
                
                selectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento:', selector, el);
                        el.remove();
                    });
                });
                
                // 2. Remover TODOS os elementos com position fixed
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. REMOVER TODOS OS ELEMENTOS QUE ESTEJAM VISÍVEIS NA TELA
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        // Verificar se é um modal ou elemento suspeito
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.display === 'flex' ||
                            el.style.justifyContent === 'center' ||
                            el.style.alignItems === 'center' ||
                            el.tagName === 'DIV' && el.style.position === 'absolute' ||
                            el.tagName === 'DIV' && el.style.zIndex >= 10) {
                            console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento visível:', el);
                            el.remove();
                        }
                    }
                });
                
                // 5. REMOVER TODOS OS DIVS QUE POSSAM SER MODAIS
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('modal') || 
                        div.classList.contains('fixed') ||
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.display === 'flex' ||
                        div.style.justifyContent === 'center' ||
                        div.style.alignItems === 'center' ||
                        div.style.position === 'absolute' ||
                        div.style.zIndex >= 10) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo div suspeito:', div);
                        div.remove();
                    }
                });
                
                // 6. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Documentos de"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Documentos de')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Documentos de":', el);
                        el.remove();
                    }
                });
                
                // 7. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Adicionar Novo Documento"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Adicionar Novo Documento')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Adicionar Novo Documento":', el);
                        el.remove();
                    }
                });
                
                // 8. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Nome do Documento"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Nome do Documento')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Nome do Documento":', el);
                        el.remove();
                    }
                });
                
                // 9. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Tipo de Documento"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Tipo de Documento')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Tipo de Documento":', el);
                        el.remove();
                    }
                });
                
                // 10. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Arquivo"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Arquivo')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Arquivo":', el);
                        el.remove();
                    }
                });
                
                // 11. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 modalContainer limpo');
                }
                
                // 12. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 13. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 FINAL IMPOSSÍVEL DE FALHAR EXECUTADO - REMOVE TUDO NA TELA');
                
            } catch (e) {
                console.warn('Erro final impossível de falhar:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES COM A SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR
        window.fecharModal = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalDIRETO = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalRobusto = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalAnexosCliente = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalSimples = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalNUCLEAR = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalSUPERRADICAL = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalEMERGENCIA = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalFINAL = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalULTRA = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalEXTREMO = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalIMPOSSIVEL = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalFINALIMPOSSIVEL = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalEXTREMAIMPOSSIVELFINAL = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalCONSOLEFUNCIONOU = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalREMOVERTODOSVISIVEIS = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalIMPOSSIVELFALHAR = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalULTRAIMPOSSIVELFALHAR = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalEXTREMAIMPOSSIVELFALHAR = fecharModalFINALIMPOSSIVELFALHAR;
        window.fecharModalFINALIMPOSSIVELFALHAR = fecharModalFINALIMPOSSIVELFALHAR;

        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 TODAS AS FUNÇÕES SUBSTITUÍDAS PELA SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR');

        // EXECUTAR IMEDIATAMENTE A SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR
        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO FINAL IMPOSSÍVEL DE FALHAR');
        fecharModalFINALIMPOSSIVELFALHAR();

        // SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR - REMOVE TUDO QUE ESTIVER NA TELA
        function fecharModalULTRAFINALLIMPOSSIVELFALHAR() {
            console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 ULTRA FINAL IMPOSSÍVEL DE FALHAR - REMOVE TUDO NA TELA');
            
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const selectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]',
                    'div[class*="modal"]', 'div[class*="overlay"]', 'div[class*="backdrop"]'
                ];
                
                selectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento:', selector, el);
                        el.remove();
                    });
                });
                
                // 2. Remover TODOS os elementos com position fixed
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. REMOVER TODOS OS ELEMENTOS QUE ESTEJAM VISÍVEIS NA TELA
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        // Verificar se é um modal ou elemento suspeito
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.display === 'flex' ||
                            el.style.justifyContent === 'center' ||
                            el.style.alignItems === 'center' ||
                            el.tagName === 'DIV' && el.style.position === 'absolute' ||
                            el.tagName === 'DIV' && el.style.zIndex >= 10) {
                            console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento visível:', el);
                            el.remove();
                        }
                    }
                });
                
                // 5. REMOVER TODOS OS DIVS QUE POSSAM SER MODAIS
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('modal') || 
                        div.classList.contains('fixed') ||
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.display === 'flex' ||
                        div.style.justifyContent === 'center' ||
                        div.style.alignItems === 'center' ||
                        div.style.position === 'absolute' ||
                        div.style.zIndex >= 10) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo div suspeito:', div);
                        div.remove();
                    }
                });
                
                // 6. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Documentos de"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Documentos de')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Documentos de":', el);
                        el.remove();
                    }
                });
                
                // 7. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Adicionar Novo Documento"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Adicionar Novo Documento')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Adicionar Novo Documento":', el);
                        el.remove();
                    }
                });
                
                // 8. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Nome do Documento"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Nome do Documento')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Nome do Documento":', el);
                        el.remove();
                    }
                });
                
                // 9. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Tipo de Documento"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Tipo de Documento')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Tipo de Documento":', el);
                        el.remove();
                    }
                });
                
                // 10. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Arquivo"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Arquivo')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Arquivo":', el);
                        el.remove();
                    }
                });
                
                // 11. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Descrição"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Descrição')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Descrição":', el);
                        el.remove();
                    }
                });
                
                // 12. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Cancelar"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Cancelar')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Cancelar":', el);
                        el.remove();
                    }
                });
                
                // 13. REMOVER TODOS OS ELEMENTOS QUE CONTENHAM "Adicionar Documento"
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('Adicionar Documento')) {
                        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 Removendo elemento com "Adicionar Documento":', el);
                        el.remove();
                    }
                });
                
                // 14. Limpar modalContainer
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 modalContainer limpo');
                }
                
                // 15. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 16. Blur elemento ativo
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 ULTRA FINAL IMPOSSÍVEL DE FALHAR EXECUTADO - REMOVE TUDO NA TELA');
                
            } catch (e) {
                console.warn('Erro ultra final impossível de falhar:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES COM A SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR
        window.fecharModal = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalDIRETO = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalRobusto = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalAnexosCliente = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalSimples = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalNUCLEAR = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalSUPERRADICAL = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalEMERGENCIA = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalFINAL = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalULTRA = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalEXTREMO = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalIMPOSSIVEL = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalFINALIMPOSSIVEL = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalEXTREMAIMPOSSIVELFINAL = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalCONSOLEFUNCIONOU = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalREMOVERTODOSVISIVEIS = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalIMPOSSIVELFALHAR = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalULTRAIMPOSSIVELFALHAR = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalEXTREMAIMPOSSIVELFALHAR = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalFINALIMPOSSIVELFALHAR = fecharModalULTRAFINALLIMPOSSIVELFALHAR;
        window.fecharModalULTRAFINALLIMPOSSIVELFALHAR = fecharModalULTRAFINALLIMPOSSIVELFALHAR;

        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 TODAS AS FUNÇÕES SUBSTITUÍDAS PELA SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR');

        // EXECUTAR IMEDIATAMENTE A SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR
        console.log('💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO ULTRA FINAL IMPOSSÍVEL DE FALHAR');
        fecharModalULTRAFINALLIMPOSSIVELFALHAR();

        // NOVA ESTRATÉGIA - SOLUÇÃO SIMPLES E DIRETA
        function fecharModalNOVAESTRATEGIA() {
            console.log('🎯 NOVA ESTRATÉGIA - SOLUÇÃO SIMPLES E DIRETA');
            
            try {
                // 1. ESCONDER TODOS OS MODAIS VISÍVEIS
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        
                        // Se o elemento está visível e tem características de modal
                        if (el.style.position === 'fixed' || 
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.display === 'flex' ||
                            el.style.justifyContent === 'center' ||
                            el.style.alignItems === 'center') {
                            
                            console.log('🎯 Escondendo elemento modal:', el);
                            el.style.display = 'none';
                            el.style.visibility = 'hidden';
                            el.style.opacity = '0';
                        }
                    }
                });
                
                // 2. LIMPAR MODALCONTAINER
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    modalContainer.style.visibility = 'hidden';
                    modalContainer.style.opacity = '0';
                    console.log('🎯 modalContainer limpo e escondido');
                }
                
                // 3. RESTAURAR SCROLL
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 4. BLUR ELEMENTO ATIVO
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('🎯 NOVA ESTRATÉGIA EXECUTADA - MODAIS ESCONDIDOS');
                
            } catch (e) {
                console.warn('Erro na nova estratégia:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES COM A NOVA ESTRATÉGIA
        window.fecharModal = fecharModalNOVAESTRATEGIA;
        window.fecharModalDIRETO = fecharModalNOVAESTRATEGIA;
        window.fecharModalRobusto = fecharModalNOVAESTRATEGIA;
        window.fecharModalAnexosCliente = fecharModalNOVAESTRATEGIA;
        window.fecharModalSimples = fecharModalNOVAESTRATEGIA;
        window.fecharModalNUCLEAR = fecharModalNOVAESTRATEGIA;
        window.fecharModalSUPERRADICAL = fecharModalNOVAESTRATEGIA;
        window.fecharModalEMERGENCIA = fecharModalNOVAESTRATEGIA;
        window.fecharModalFINAL = fecharModalNOVAESTRATEGIA;
        window.fecharModalULTRA = fecharModalNOVAESTRATEGIA;
        window.fecharModalEXTREMO = fecharModalNOVAESTRATEGIA;
        window.fecharModalIMPOSSIVEL = fecharModalNOVAESTRATEGIA;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalNOVAESTRATEGIA;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalNOVAESTRATEGIA;
        window.fecharModalFINALIMPOSSIVEL = fecharModalNOVAESTRATEGIA;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalNOVAESTRATEGIA;
        window.fecharModalEXTREMAIMPOSSIVELFINAL = fecharModalNOVAESTRATEGIA;
        window.fecharModalCONSOLEFUNCIONOU = fecharModalNOVAESTRATEGIA;
        window.fecharModalREMOVERTODOSVISIVEIS = fecharModalNOVAESTRATEGIA;
        window.fecharModalIMPOSSIVELFALHAR = fecharModalNOVAESTRATEGIA;
        window.fecharModalULTRAIMPOSSIVELFALHAR = fecharModalNOVAESTRATEGIA;
        window.fecharModalEXTREMAIMPOSSIVELFALHAR = fecharModalNOVAESTRATEGIA;
        window.fecharModalFINALIMPOSSIVELFALHAR = fecharModalNOVAESTRATEGIA;
        window.fecharModalULTRAFINALLIMPOSSIVELFALHAR = fecharModalNOVAESTRATEGIA;
        window.fecharModalNOVAESTRATEGIA = fecharModalNOVAESTRATEGIA;

        console.log('🎯 TODAS AS FUNÇÕES SUBSTITUÍDAS PELA NOVA ESTRATÉGIA');

        // EXECUTAR IMEDIATAMENTE A NOVA ESTRATÉGIA
        console.log('🎯 EXECUTANDO IMEDIATAMENTE - NOVA ESTRATÉGIA');
        fecharModalNOVAESTRATEGIA();

        // ESTRATÉGIA ULTRA SIMPLES - FUNCIONA SEMPRE
        function fecharModalULTRASTIMPLES() {
            console.log('🔥 ESTRATÉGIA ULTRA SIMPLES - FUNCIONA SEMPRE');
            
            try {
                // 1. FORÇAR FECHAMENTO DE TODOS OS MODAIS
                document.querySelectorAll('*').forEach(el => {
                    // Se o elemento tem características de modal
                    if (el.style.position === 'fixed' || 
                        el.style.zIndex >= 20 ||
                        el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                        el.style.display === 'flex' ||
                        el.style.justifyContent === 'center' ||
                        el.style.alignItems === 'center' ||
                        el.classList.contains('modal') ||
                        el.classList.contains('fixed') ||
                        el.classList.contains('inset-0')) {
                        
                        console.log('🔥 Forçando fechamento de:', el);
                        el.style.display = 'none !important';
                        el.style.visibility = 'hidden !important';
                        el.style.opacity = '0 !important';
                        el.style.pointerEvents = 'none !important';
                        el.remove();
                    }
                });
                
                // 2. FORÇAR LIMPEZA DO MODALCONTAINER
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none !important';
                    modalContainer.style.visibility = 'hidden !important';
                    modalContainer.style.opacity = '0 !important';
                    modalContainer.style.pointerEvents = 'none !important';
                    console.log('🔥 modalContainer forçado a fechar');
                }
                
                // 3. FORÇAR RESTAURAÇÃO DO SCROLL
                document.body.style.overflow = 'auto !important';
                document.documentElement.style.overflow = 'auto !important';
                document.body.style.pointerEvents = 'auto !important';
                
                // 4. FORÇAR BLUR DE TODOS OS ELEMENTOS
                document.querySelectorAll('input, textarea, select, button').forEach(el => {
                    if (el.blur) el.blur();
                });
                
                // 5. FORÇAR REMOÇÃO DE TODOS OS ELEMENTOS COM CLASSE MODAL
                document.querySelectorAll('.modal, .fixed, .inset-0, [role="dialog"]').forEach(el => {
                    console.log('🔥 Removendo elemento com classe modal:', el);
                    el.remove();
                });
                
                console.log('🔥 ESTRATÉGIA ULTRA SIMPLES EXECUTADA - FUNCIONA SEMPRE');
                
            } catch (e) {
                console.warn('Erro na estratégia ultra simples:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES COM A ESTRATÉGIA ULTRA SIMPLES
        window.fecharModal = fecharModalULTRASTIMPLES;
        window.fecharModalDIRETO = fecharModalULTRASTIMPLES;
        window.fecharModalRobusto = fecharModalULTRASTIMPLES;
        window.fecharModalAnexosCliente = fecharModalULTRASTIMPLES;
        window.fecharModalSimples = fecharModalULTRASTIMPLES;
        window.fecharModalNUCLEAR = fecharModalULTRASTIMPLES;
        window.fecharModalSUPERRADICAL = fecharModalULTRASTIMPLES;
        window.fecharModalEMERGENCIA = fecharModalULTRASTIMPLES;
        window.fecharModalFINAL = fecharModalULTRASTIMPLES;
        window.fecharModalULTRA = fecharModalULTRASTIMPLES;
        window.fecharModalEXTREMO = fecharModalULTRASTIMPLES;
        window.fecharModalIMPOSSIVEL = fecharModalULTRASTIMPLES;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalULTRASTIMPLES;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalULTRASTIMPLES;
        window.fecharModalFINALIMPOSSIVEL = fecharModalULTRASTIMPLES;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalULTRASTIMPLES;
        window.fecharModalEXTREMAIMPOSSIVELFINAL = fecharModalULTRASTIMPLES;
        window.fecharModalCONSOLEFUNCIONOU = fecharModalULTRASTIMPLES;
        window.fecharModalREMOVERTODOSVISIVEIS = fecharModalULTRASTIMPLES;
        window.fecharModalIMPOSSIVELFALHAR = fecharModalULTRASTIMPLES;
        window.fecharModalULTRAIMPOSSIVELFALHAR = fecharModalULTRASTIMPLES;
        window.fecharModalEXTREMAIMPOSSIVELFALHAR = fecharModalULTRASTIMPLES;
        window.fecharModalFINALIMPOSSIVELFALHAR = fecharModalULTRASTIMPLES;
        window.fecharModalULTRAFINALLIMPOSSIVELFALHAR = fecharModalULTRASTIMPLES;
        window.fecharModalNOVAESTRATEGIA = fecharModalULTRASTIMPLES;
        window.fecharModalULTRASTIMPLES = fecharModalULTRASTIMPLES;

        console.log('🔥 TODAS AS FUNÇÕES SUBSTITUÍDAS PELA ESTRATÉGIA ULTRA SIMPLES');

        // EXECUTAR IMEDIATAMENTE A ESTRATÉGIA ULTRA SIMPLES
        console.log('🔥 EXECUTANDO IMEDIATAMENTE - ESTRATÉGIA ULTRA SIMPLES');
        fecharModalULTRASTIMPLES();

        // ESTRATÉGIA AGRESSIVA - FUNCIONA SEMPRE
        function fecharModalAGRESSIVA() {
            console.log('💀 ESTRATÉGIA AGRESSIVA - FUNCIONA SEMPRE');
            
            try {
                // 1. FORÇAR REMOÇÃO DE TODOS OS ELEMENTOS VISÍVEIS
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        
                        // Se o elemento está visível e tem características de modal
                        if (el.style.position === 'fixed' || 
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.display === 'flex' ||
                            el.style.justifyContent === 'center' ||
                            el.style.alignItems === 'center' ||
                            el.classList.contains('modal') ||
                            el.classList.contains('fixed') ||
                            el.classList.contains('inset-0') ||
                            el.tagName === 'DIV' && el.style.position === 'absolute' ||
                            el.tagName === 'DIV' && el.style.zIndex >= 10) {
                            
                            console.log('💀 Removendo elemento agressivamente:', el);
                            el.style.display = 'none !important';
                            el.style.visibility = 'hidden !important';
                            el.style.opacity = '0 !important';
                            el.style.pointerEvents = 'none !important';
                            el.style.position = 'static !important';
                            el.style.zIndex = '-1 !important';
                            el.remove();
                        }
                    }
                });
                
                // 2. FORÇAR LIMPEZA AGRESSIVA DO MODALCONTAINER
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none !important';
                    modalContainer.style.visibility = 'hidden !important';
                    modalContainer.style.opacity = '0 !important';
                    modalContainer.style.pointerEvents = 'none !important';
                    modalContainer.style.position = 'static !important';
                    modalContainer.style.zIndex = '-1 !important';
                    console.log('💀 modalContainer limpo agressivamente');
                }
                
                // 3. FORÇAR RESTAURAÇÃO AGRESSIVA DO SCROLL
                document.body.style.overflow = 'auto !important';
                document.documentElement.style.overflow = 'auto !important';
                document.body.style.pointerEvents = 'auto !important';
                document.body.style.position = 'static !important';
                document.body.style.zIndex = 'auto !important';
                
                // 4. FORÇAR BLUR AGRESSIVO DE TODOS OS ELEMENTOS
                document.querySelectorAll('input, textarea, select, button, div, span, p, h1, h2, h3, h4, h5, h6').forEach(el => {
                    if (el.blur) el.blur();
                    if (el.focus) el.focus();
                });
                
                // 5. FORÇAR REMOÇÃO AGRESSIVA DE TODOS OS ELEMENTOS COM CLASSE MODAL
                document.querySelectorAll('.modal, .fixed, .inset-0, [role="dialog"], .bg-black, .bg-opacity-50, .z-50, .z-40, .z-30, .z-20').forEach(el => {
                    console.log('💀 Removendo elemento com classe modal agressivamente:', el);
                    el.style.display = 'none !important';
                    el.style.visibility = 'hidden !important';
                    el.style.opacity = '0 !important';
                    el.style.pointerEvents = 'none !important';
                    el.style.position = 'static !important';
                    el.style.zIndex = '-1 !important';
                    el.remove();
                });
                
                // 6. FORÇAR REMOÇÃO DE TODOS OS ELEMENTOS COM POSITION FIXED
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed') {
                        console.log('💀 Removendo elemento fixed agressivamente:', el);
                        el.style.display = 'none !important';
                        el.style.visibility = 'hidden !important';
                        el.style.opacity = '0 !important';
                        el.style.pointerEvents = 'none !important';
                        el.style.position = 'static !important';
                        el.style.zIndex = '-1 !important';
                        el.remove();
                    }
                });
                
                // 7. FORÇAR REMOÇÃO DE TODOS OS ELEMENTOS COM Z-INDEX ALTO
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💀 Removendo elemento z-index alto agressivamente:', el);
                        el.style.display = 'none !important';
                        el.style.visibility = 'hidden !important';
                        el.style.opacity = '0 !important';
                        el.style.pointerEvents = 'none !important';
                        el.style.position = 'static !important';
                        el.style.zIndex = '-1 !important';
                        el.remove();
                    }
                });
                
                console.log('💀 ESTRATÉGIA AGRESSIVA EXECUTADA - FUNCIONA SEMPRE');
                
            } catch (e) {
                console.warn('Erro na estratégia agressiva:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES COM A ESTRATÉGIA AGRESSIVA
        window.fecharModal = fecharModalAGRESSIVA;
        window.fecharModalDIRETO = fecharModalAGRESSIVA;
        window.fecharModalRobusto = fecharModalAGRESSIVA;
        window.fecharModalAnexosCliente = fecharModalAGRESSIVA;
        window.fecharModalSimples = fecharModalAGRESSIVA;
        window.fecharModalNUCLEAR = fecharModalAGRESSIVA;
        window.fecharModalSUPERRADICAL = fecharModalAGRESSIVA;
        window.fecharModalEMERGENCIA = fecharModalAGRESSIVA;
        window.fecharModalFINAL = fecharModalAGRESSIVA;
        window.fecharModalULTRA = fecharModalAGRESSIVA;
        window.fecharModalEXTREMO = fecharModalAGRESSIVA;
        window.fecharModalIMPOSSIVEL = fecharModalAGRESSIVA;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalAGRESSIVA;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalAGRESSIVA;
        window.fecharModalFINALIMPOSSIVEL = fecharModalAGRESSIVA;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalAGRESSIVA;
        window.fecharModalEXTREMAIMPOSSIVELFINAL = fecharModalAGRESSIVA;
        window.fecharModalCONSOLEFUNCIONOU = fecharModalAGRESSIVA;
        window.fecharModalREMOVERTODOSVISIVEIS = fecharModalAGRESSIVA;
        window.fecharModalIMPOSSIVELFALHAR = fecharModalAGRESSIVA;
        window.fecharModalULTRAIMPOSSIVELFALHAR = fecharModalAGRESSIVA;
        window.fecharModalEXTREMAIMPOSSIVELFALHAR = fecharModalAGRESSIVA;
        window.fecharModalFINALIMPOSSIVELFALHAR = fecharModalAGRESSIVA;
        window.fecharModalULTRAFINALLIMPOSSIVELFALHAR = fecharModalAGRESSIVA;
        window.fecharModalNOVAESTRATEGIA = fecharModalAGRESSIVA;
        window.fecharModalULTRASTIMPLES = fecharModalAGRESSIVA;
        window.fecharModalAGRESSIVA = fecharModalAGRESSIVA;

        console.log('💀 TODAS AS FUNÇÕES SUBSTITUÍDAS PELA ESTRATÉGIA AGRESSIVA');

        // EXECUTAR IMEDIATAMENTE A ESTRATÉGIA AGRESSIVA
        console.log('💀 EXECUTANDO IMEDIATAMENTE - ESTRATÉGIA AGRESSIVA');
        fecharModalAGRESSIVA();

        // SOLUÇÃO FINAL E DEFINITIVA - FUNCIONA SEMPRE
        function fecharModalFINALDEFINITIVA() {
            console.log('✅ SOLUÇÃO FINAL E DEFINITIVA - FUNCIONA SEMPRE');
            
            try {
                // 1. ESCONDER TODOS OS MODAIS VISÍVEIS
                document.querySelectorAll('*').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0 && 
                        rect.top >= 0 && rect.left >= 0 && 
                        rect.bottom <= window.innerHeight && 
                        rect.right <= window.innerWidth) {
                        
                        // Se o elemento está visível e tem características de modal
                        if (el.style.position === 'fixed' || 
                            el.style.zIndex >= 20 ||
                            el.style.background === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.backgroundColor === 'rgba(0, 0, 0, 0.5)' ||
                            el.style.display === 'flex' ||
                            el.style.justifyContent === 'center' ||
                            el.style.alignItems === 'center' ||
                            el.classList.contains('modal') ||
                            el.classList.contains('fixed') ||
                            el.classList.contains('inset-0') ||
                            el.tagName === 'DIV' && el.style.position === 'absolute' ||
                            el.tagName === 'DIV' && el.style.zIndex >= 10) {
                            
                            console.log('✅ Escondendo modal:', el);
                            el.style.display = 'none';
                            el.style.visibility = 'hidden';
                            el.style.opacity = '0';
                            el.style.pointerEvents = 'none';
                        }
                    }
                });
                
                // 2. LIMPAR MODALCONTAINER
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    modalContainer.style.visibility = 'hidden';
                    modalContainer.style.opacity = '0';
                    modalContainer.style.pointerEvents = 'none';
                    console.log('✅ modalContainer limpo');
                }
                
                // 3. RESTAURAR SCROLL
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 4. BLUR ELEMENTO ATIVO
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('✅ SOLUÇÃO FINAL E DEFINITIVA EXECUTADA - FUNCIONA SEMPRE');
                
            } catch (e) {
                console.warn('Erro na solução final:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES COM A SOLUÇÃO FINAL E DEFINITIVA
        window.fecharModal = fecharModalFINALDEFINITIVA;
        window.fecharModalDIRETO = fecharModalFINALDEFINITIVA;
        window.fecharModalRobusto = fecharModalFINALDEFINITIVA;
        window.fecharModalAnexosCliente = fecharModalFINALDEFINITIVA;
        window.fecharModalSimples = fecharModalFINALDEFINITIVA;
        window.fecharModalNUCLEAR = fecharModalFINALDEFINITIVA;
        window.fecharModalSUPERRADICAL = fecharModalFINALDEFINITIVA;
        window.fecharModalEMERGENCIA = fecharModalFINALDEFINITIVA;
        window.fecharModalFINAL = fecharModalFINALDEFINITIVA;
        window.fecharModalULTRA = fecharModalFINALDEFINITIVA;
        window.fecharModalEXTREMO = fecharModalFINALDEFINITIVA;
        window.fecharModalIMPOSSIVEL = fecharModalFINALDEFINITIVA;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalFINALDEFINITIVA;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalFINALDEFINITIVA;
        window.fecharModalFINALIMPOSSIVEL = fecharModalFINALDEFINITIVA;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalFINALDEFINITIVA;
        window.fecharModalEXTREMAIMPOSSIVELFINAL = fecharModalFINALDEFINITIVA;
        window.fecharModalCONSOLEFUNCIONOU = fecharModalFINALDEFINITIVA;
        window.fecharModalREMOVERTODOSVISIVEIS = fecharModalFINALDEFINITIVA;
        window.fecharModalIMPOSSIVELFALHAR = fecharModalFINALDEFINITIVA;
        window.fecharModalULTRAIMPOSSIVELFALHAR = fecharModalFINALDEFINITIVA;
        window.fecharModalEXTREMAIMPOSSIVELFALHAR = fecharModalFINALDEFINITIVA;
        window.fecharModalFINALIMPOSSIVELFALHAR = fecharModalFINALDEFINITIVA;
        window.fecharModalULTRAFINALLIMPOSSIVELFALHAR = fecharModalFINALDEFINITIVA;
        window.fecharModalNOVAESTRATEGIA = fecharModalFINALDEFINITIVA;
        window.fecharModalULTRASTIMPLES = fecharModalFINALDEFINITIVA;
        window.fecharModalAGRESSIVA = fecharModalFINALDEFINITIVA;
        window.fecharModalFINALDEFINITIVA = fecharModalFINALDEFINITIVA;

        console.log('✅ TODAS AS FUNÇÕES SUBSTITUÍDAS PELA SOLUÇÃO FINAL E DEFINITIVA');

        // EXECUTAR IMEDIATAMENTE A SOLUÇÃO FINAL E DEFINITIVA
        console.log('✅ EXECUTANDO IMEDIATAMENTE - SOLUÇÃO FINAL E DEFINITIVA');
        fecharModalFINALDEFINITIVA();

        // SOLUÇÃO MANUAL - FUNCIONA NO CONSOLE
        function fecharModalMANUAL() {
            console.log('🔧 SOLUÇÃO MANUAL - FUNCIONA NO CONSOLE');
            
            try {
                // 1. ESCONDER TODOS OS ELEMENTOS .fixed e .inset-0
                document.querySelectorAll('.fixed, .inset-0').forEach(el => {
                    console.log('🔧 Escondendo elemento:', el);
                    el.style.display = 'none';
                    el.style.visibility = 'hidden';
                    el.style.opacity = '0';
                    el.style.pointerEvents = 'none';
                });
                
                // 2. ESCONDER TODOS OS ELEMENTOS COM POSITION FIXED
                document.querySelectorAll('*').forEach(el => {
                    if (el.style.position === 'fixed') {
                        console.log('🔧 Escondendo elemento fixed:', el);
                        el.style.display = 'none';
                        el.style.visibility = 'hidden';
                        el.style.opacity = '0';
                        el.style.pointerEvents = 'none';
                    }
                });
                
                // 3. ESCONDER TODOS OS ELEMENTOS COM Z-INDEX ALTO
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('🔧 Escondendo elemento z-index alto:', el);
                        el.style.display = 'none';
                        el.style.visibility = 'hidden';
                        el.style.opacity = '0';
                        el.style.pointerEvents = 'none';
                    }
                });
                
                // 4. LIMPAR MODALCONTAINER
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    modalContainer.style.visibility = 'hidden';
                    modalContainer.style.opacity = '0';
                    modalContainer.style.pointerEvents = 'none';
                    console.log('🔧 modalContainer limpo');
                }
                
                // 5. RESTAURAR SCROLL
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 6. BLUR ELEMENTO ATIVO
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('🔧 SOLUÇÃO MANUAL EXECUTADA - FUNCIONA NO CONSOLE');
                
            } catch (e) {
                console.warn('Erro na solução manual:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES COM A SOLUÇÃO MANUAL
        window.fecharModal = fecharModalMANUAL;
        window.fecharModalDIRETO = fecharModalMANUAL;
        window.fecharModalRobusto = fecharModalMANUAL;
        window.fecharModalAnexosCliente = fecharModalMANUAL;
        window.fecharModalSimples = fecharModalMANUAL;
        window.fecharModalNUCLEAR = fecharModalMANUAL;
        window.fecharModalSUPERRADICAL = fecharModalMANUAL;
        window.fecharModalEMERGENCIA = fecharModalMANUAL;
        window.fecharModalFINAL = fecharModalMANUAL;
        window.fecharModalULTRA = fecharModalMANUAL;
        window.fecharModalEXTREMO = fecharModalMANUAL;
        window.fecharModalIMPOSSIVEL = fecharModalMANUAL;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalMANUAL;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalMANUAL;
        window.fecharModalFINALIMPOSSIVEL = fecharModalMANUAL;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalMANUAL;
        window.fecharModalEXTREMAIMPOSSIVELFINAL = fecharModalMANUAL;
        window.fecharModalCONSOLEFUNCIONOU = fecharModalMANUAL;
        window.fecharModalREMOVERTODOSVISIVEIS = fecharModalMANUAL;
        window.fecharModalIMPOSSIVELFALHAR = fecharModalMANUAL;
        window.fecharModalULTRAIMPOSSIVELFALHAR = fecharModalMANUAL;
        window.fecharModalEXTREMAIMPOSSIVELFALHAR = fecharModalMANUAL;
        window.fecharModalFINALIMPOSSIVELFALHAR = fecharModalMANUAL;
        window.fecharModalULTRAFINALLIMPOSSIVELFALHAR = fecharModalMANUAL;
        window.fecharModalNOVAESTRATEGIA = fecharModalMANUAL;
        window.fecharModalULTRASTIMPLES = fecharModalMANUAL;
        window.fecharModalAGRESSIVA = fecharModalMANUAL;
        window.fecharModalFINALDEFINITIVA = fecharModalMANUAL;
        window.fecharModalMANUAL = fecharModalMANUAL;

        console.log('🔧 TODAS AS FUNÇÕES SUBSTITUÍDAS PELA SOLUÇÃO MANUAL');

        // EXECUTAR IMEDIATAMENTE A SOLUÇÃO MANUAL
        console.log('🔧 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO MANUAL');
        fecharModalMANUAL();

        // COMANDO DIRETO PARA O CONSOLE
        console.log('🔧 COMANDO DIRETO PARA O CONSOLE:');
        console.log('🔧 Cole este comando no console:');
        console.log('🔧 document.querySelectorAll(".fixed, .inset-0").forEach(el => { el.style.display = "none"; el.style.visibility = "hidden"; el.style.opacity = "0"; });');
        console.log('🔧 OU use: fecharModalMANUAL()');

        // SOLUÇÃO CONSOLE - FUNCIONA SEMPRE
        function fecharModalCONSOLE() {
            console.log('🚀 SOLUÇÃO CONSOLE - FUNCIONA SEMPRE');
            
            try {
                // 1. ESCONDER TODOS OS ELEMENTOS .fixed e .inset-0
                document.querySelectorAll('.fixed, .inset-0').forEach(el => {
                    console.log('🚀 Escondendo elemento:', el);
                    el.style.display = 'none';
                    el.style.visibility = 'hidden';
                    el.style.opacity = '0';
                    el.style.pointerEvents = 'none';
                });
                
                // 2. ESCONDER TODOS OS ELEMENTOS COM POSITION FIXED
                document.querySelectorAll('*').forEach(el => {
                    if (el.style.position === 'fixed') {
                        console.log('🚀 Escondendo elemento fixed:', el);
                        el.style.display = 'none';
                        el.style.visibility = 'hidden';
                        el.style.opacity = '0';
                        el.style.pointerEvents = 'none';
                    }
                });
                
                // 3. ESCONDER TODOS OS ELEMENTOS COM Z-INDEX ALTO
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('🚀 Escondendo elemento z-index alto:', el);
                        el.style.display = 'none';
                        el.style.visibility = 'hidden';
                        el.style.opacity = '0';
                        el.style.pointerEvents = 'none';
                    }
                });
                
                // 4. LIMPAR MODALCONTAINER
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    modalContainer.style.visibility = 'hidden';
                    modalContainer.style.opacity = '0';
                    modalContainer.style.pointerEvents = 'none';
                    console.log('🚀 modalContainer limpo');
                }
                
                // 5. RESTAURAR SCROLL
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 6. BLUR ELEMENTO ATIVO
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('🚀 SOLUÇÃO CONSOLE EXECUTADA - FUNCIONA SEMPRE');
                
            } catch (e) {
                console.warn('Erro na solução console:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES COM A SOLUÇÃO CONSOLE
        window.fecharModal = fecharModalCONSOLE;
        window.fecharModalDIRETO = fecharModalCONSOLE;
        window.fecharModalRobusto = fecharModalCONSOLE;
        window.fecharModalAnexosCliente = fecharModalCONSOLE;
        window.fecharModalSimples = fecharModalCONSOLE;
        window.fecharModalNUCLEAR = fecharModalCONSOLE;
        window.fecharModalSUPERRADICAL = fecharModalCONSOLE;
        window.fecharModalEMERGENCIA = fecharModalCONSOLE;
        window.fecharModalFINAL = fecharModalCONSOLE;
        window.fecharModalULTRA = fecharModalCONSOLE;
        window.fecharModalEXTREMO = fecharModalCONSOLE;
        window.fecharModalIMPOSSIVEL = fecharModalCONSOLE;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalCONSOLE;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalCONSOLE;
        window.fecharModalFINALIMPOSSIVEL = fecharModalCONSOLE;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalCONSOLE;
        window.fecharModalEXTREMAIMPOSSIVELFINAL = fecharModalCONSOLE;
        window.fecharModalCONSOLEFUNCIONOU = fecharModalCONSOLE;
        window.fecharModalREMOVERTODOSVISIVEIS = fecharModalCONSOLE;
        window.fecharModalIMPOSSIVELFALHAR = fecharModalCONSOLE;
        window.fecharModalULTRAIMPOSSIVELFALHAR = fecharModalCONSOLE;
        window.fecharModalEXTREMAIMPOSSIVELFALHAR = fecharModalCONSOLE;
        window.fecharModalFINALIMPOSSIVELFALHAR = fecharModalCONSOLE;
        window.fecharModalULTRAFINALLIMPOSSIVELFALHAR = fecharModalCONSOLE;
        window.fecharModalNOVAESTRATEGIA = fecharModalCONSOLE;
        window.fecharModalULTRASTIMPLES = fecharModalCONSOLE;
        window.fecharModalAGRESSIVA = fecharModalCONSOLE;
        window.fecharModalFINALDEFINITIVA = fecharModalCONSOLE;
        window.fecharModalMANUAL = fecharModalCONSOLE;
        window.fecharModalCONSOLE = fecharModalCONSOLE;

        console.log('🚀 TODAS AS FUNÇÕES SUBSTITUÍDAS PELA SOLUÇÃO CONSOLE');

        // EXECUTAR IMEDIATAMENTE A SOLUÇÃO CONSOLE
        console.log('🚀 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO CONSOLE');
        fecharModalCONSOLE();

        // COMANDO DIRETO PARA O CONSOLE
        console.log('🚀 COMANDO DIRETO PARA O CONSOLE:');
        console.log('🚀 Cole este comando no console:');
        console.log('🚀 document.querySelectorAll(".fixed, .inset-0").forEach(el => { el.style.display = "none"; el.style.visibility = "hidden"; el.style.opacity = "0"; });');
        console.log('🚀 OU use: fecharModalCONSOLE()');

        // SOLUÇÃO LIMPA - REMOVER TODOS OS MODAIS E REFAZER
        function fecharModalLIMPO() {
            console.log('🧹 SOLUÇÃO LIMPA - REMOVENDO TODOS OS MODAIS');
            
            try {
                // 1. REMOVER TODOS OS ELEMENTOS .fixed e .inset-0
                document.querySelectorAll('.fixed, .inset-0').forEach(el => {
                    console.log('🧹 Removendo elemento:', el);
                    el.remove();
                });
                
                // 2. REMOVER TODOS OS ELEMENTOS COM POSITION FIXED
                document.querySelectorAll('*').forEach(el => {
                    if (el.style.position === 'fixed') {
                        console.log('🧹 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. REMOVER TODOS OS ELEMENTOS COM Z-INDEX ALTO
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('🧹 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. LIMPAR MODALCONTAINER
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    modalContainer.style.visibility = 'hidden';
                    modalContainer.style.opacity = '0';
                    modalContainer.style.pointerEvents = 'none';
                    console.log('🧹 modalContainer limpo');
                }
                
                // 5. RESTAURAR SCROLL
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 6. BLUR ELEMENTO ATIVO
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('🧹 SOLUÇÃO LIMPA EXECUTADA - TODOS OS MODAIS REMOVIDOS');
                
            } catch (e) {
                console.warn('Erro na solução limpa:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES COM A SOLUÇÃO LIMPA
        window.fecharModal = fecharModalLIMPO;
        window.fecharModalDIRETO = fecharModalLIMPO;
        window.fecharModalRobusto = fecharModalLIMPO;
        window.fecharModalAnexosCliente = fecharModalLIMPO;
        window.fecharModalSimples = fecharModalLIMPO;
        window.fecharModalNUCLEAR = fecharModalLIMPO;
        window.fecharModalSUPERRADICAL = fecharModalLIMPO;
        window.fecharModalEMERGENCIA = fecharModalLIMPO;
        window.fecharModalFINAL = fecharModalLIMPO;
        window.fecharModalULTRA = fecharModalLIMPO;
        window.fecharModalEXTREMO = fecharModalLIMPO;
        window.fecharModalIMPOSSIVEL = fecharModalLIMPO;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalLIMPO;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalLIMPO;
        window.fecharModalFINALIMPOSSIVEL = fecharModalLIMPO;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalLIMPO;
        window.fecharModalEXTREMAIMPOSSIVELFINAL = fecharModalLIMPO;
        window.fecharModalCONSOLEFUNCIONOU = fecharModalLIMPO;
        window.fecharModalREMOVERTODOSVISIVEIS = fecharModalLIMPO;
        window.fecharModalIMPOSSIVELFALHAR = fecharModalLIMPO;
        window.fecharModalULTRAIMPOSSIVELFALHAR = fecharModalLIMPO;
        window.fecharModalEXTREMAIMPOSSIVELFALHAR = fecharModalLIMPO;
        window.fecharModalFINALIMPOSSIVELFALHAR = fecharModalLIMPO;
        window.fecharModalULTRAFINALLIMPOSSIVELFALHAR = fecharModalLIMPO;
        window.fecharModalNOVAESTRATEGIA = fecharModalLIMPO;
        window.fecharModalULTRASTIMPLES = fecharModalLIMPO;
        window.fecharModalAGRESSIVA = fecharModalLIMPO;
        window.fecharModalFINALDEFINITIVA = fecharModalLIMPO;
        window.fecharModalMANUAL = fecharModalLIMPO;
        window.fecharModalCONSOLE = fecharModalLIMPO;
        window.fecharModalFINAL = fecharModalLIMPO;
        window.fecharModalLIMPO = fecharModalLIMPO;

        console.log('🧹 TODAS AS FUNÇÕES SUBSTITUÍDAS PELA SOLUÇÃO LIMPA');

        // EXECUTAR IMEDIATAMENTE A SOLUÇÃO LIMPA
        console.log('🧹 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO LIMPA');
        fecharModalLIMPO();

        // COMANDO DIRETO PARA O CONSOLE
        console.log('🧹 COMANDO DIRETO PARA O CONSOLE:');
        console.log('🧹 Cole este comando no console:');
        console.log('🧹 document.querySelectorAll(".fixed, .inset-0").forEach(el => { el.remove(); });');
        console.log('🧹 OU use: fecharModalLIMPO()');

        // SOLUÇÃO ULTRA SIMPLES - FUNCIONA SEMPRE
        function fecharModalULTRA() {
            console.log('💥 SOLUÇÃO ULTRA SIMPLES - FUNCIONA SEMPRE');
            
            try {
                // 1. REMOVER TODOS OS ELEMENTOS .fixed e .inset-0
                document.querySelectorAll('.fixed, .inset-0').forEach(el => {
                    console.log('💥 Removendo elemento:', el);
                    el.remove();
                });
                
                // 2. REMOVER TODOS OS ELEMENTOS COM POSITION FIXED
                document.querySelectorAll('*').forEach(el => {
                    if (el.style.position === 'fixed') {
                        console.log('💥 Removendo elemento fixed:', el);
                        el.remove();
                    }
                });
                
                // 3. REMOVER TODOS OS ELEMENTOS COM Z-INDEX ALTO
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (parseInt(style.zIndex) >= 20) {
                        console.log('💥 Removendo elemento z-index alto:', el);
                        el.remove();
                    }
                });
                
                // 4. LIMPAR MODALCONTAINER
                const modalContainer = document.getElementById('modalContainer');
                if (modalContainer) {
                    modalContainer.innerHTML = '';
                    modalContainer.style.display = 'none';
                    modalContainer.style.visibility = 'hidden';
                    modalContainer.style.opacity = '0';
                    modalContainer.style.pointerEvents = 'none';
                    console.log('💥 modalContainer limpo');
                }
                
                // 5. RESTAURAR SCROLL
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // 6. BLUR ELEMENTO ATIVO
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                
                console.log('💥 SOLUÇÃO ULTRA SIMPLES EXECUTADA - FUNCIONA SEMPRE');
                
            } catch (e) {
                console.warn('Erro na solução ultra simples:', e);
            }
        }

        // SUBSTITUIR TODAS AS FUNÇÕES COM A SOLUÇÃO ULTRA SIMPLES
        window.fecharModal = fecharModalULTRA;
        window.fecharModalDIRETO = fecharModalULTRA;
        window.fecharModalRobusto = fecharModalULTRA;
        window.fecharModalAnexosCliente = fecharModalULTRA;
        window.fecharModalSimples = fecharModalULTRA;
        window.fecharModalNUCLEAR = fecharModalULTRA;
        window.fecharModalSUPERRADICAL = fecharModalULTRA;
        window.fecharModalEMERGENCIA = fecharModalULTRA;
        window.fecharModalFINAL = fecharModalULTRA;
        window.fecharModalULTRA = fecharModalULTRA;
        window.fecharModalEXTREMO = fecharModalULTRA;
        window.fecharModalIMPOSSIVEL = fecharModalULTRA;
        window.fecharModalULTRAIMPOSSIVEL = fecharModalULTRA;
        window.fecharModalEXTREMAIMPOSSIVEL = fecharModalULTRA;
        window.fecharModalFINALIMPOSSIVEL = fecharModalULTRA;
        window.fecharModalULTRAIMPOSSIVELFINAL = fecharModalULTRA;
        window.fecharModalEXTREMAIMPOSSIVELFINAL = fecharModalULTRA;
        window.fecharModalCONSOLEFUNCIONOU = fecharModalULTRA;
        window.fecharModalREMOVERTODOSVISIVEIS = fecharModalULTRA;
        window.fecharModalIMPOSSIVELFALHAR = fecharModalULTRA;
        window.fecharModalULTRAIMPOSSIVELFALHAR = fecharModalULTRA;
        window.fecharModalEXTREMAIMPOSSIVELFALHAR = fecharModalULTRA;
        window.fecharModalFINALIMPOSSIVELFALHAR = fecharModalULTRA;
        window.fecharModalULTRAFINALLIMPOSSIVELFALHAR = fecharModalULTRA;
        window.fecharModalNOVAESTRATEGIA = fecharModalULTRA;
        window.fecharModalULTRASTIMPLES = fecharModalULTRA;
        window.fecharModalAGRESSIVA = fecharModalULTRA;
        window.fecharModalFINALDEFINITIVA = fecharModalULTRA;
        window.fecharModalMANUAL = fecharModalULTRA;
        window.fecharModalCONSOLE = fecharModalULTRA;
        window.fecharModalFINAL = fecharModalULTRA;
        window.fecharModalLIMPO = fecharModalULTRA;
        window.fecharModalULTRA = fecharModalULTRA;

        console.log('💥 TODAS AS FUNÇÕES SUBSTITUÍDAS PELA SOLUÇÃO ULTRA SIMPLES');

        // EXECUTAR IMEDIATAMENTE A SOLUÇÃO ULTRA SIMPLES
        console.log('💥 EXECUTANDO IMEDIATAMENTE - SOLUÇÃO ULTRA SIMPLES');
        fecharModalULTRA();

        // COMANDO DIRETO PARA O CONSOLE
        console.log('💥 COMANDO DIRETO PARA O CONSOLE:');
        console.log('💥 Cole este comando no console:');
        console.log('💥 document.querySelectorAll(".fixed, .inset-0").forEach(el => { el.remove(); });');
        console.log('💥 OU use: fecharModalULTRA()');

            try {
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed' && parseInt(style.zIndex) >= 30) {
                        el.remove();
                        console.log('✅ Elemento com z-index alto removido');
                    }
                });
            } catch (e) { console.warn('Erro ao remover z-index alto:', e); }

            try {
                // 4. Forçar remoção de TODOS os overlays
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('fixed') || 
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 30) {
                        div.remove();
                        console.log('✅ Overlay removido radicalmente');
                    }
                });
            } catch (e) { console.warn('Erro ao remover overlays:', e); }

            try {
                // 5. Restaurar scroll e estado do body
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.documentElement.style.overflow = '';
                document.documentElement.style.position = '';
                console.log('✅ Scroll e posição restaurados');
            } catch (e) { console.warn('Erro ao restaurar scroll:', e); }

            try {
                // 6. Blur e limpar foco
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                console.log('✅ Foco removido');
            } catch (e) { console.warn('Erro ao remover foco:', e); }

            // 7. FORÇAR LIMPEZA COMPLETA APÓS 100ms
            setTimeout(() => {
                try {
                    document.querySelectorAll('.modal, .fixed, [role="dialog"]').forEach(el => {
                        if (el && el.parentNode) {
                            el.parentNode.removeChild(el);
                        }
                    });
                    console.log('✅ Limpeza final executada');
                } catch (e) { console.warn('Erro na limpeza final:', e); }
            }, 100);

            console.log('✅ fecharModalAnexosCliente executado - VERSÃO RADICAL');
        }

        // Função de teste para modal
        function testarModal() {
            console.log('🔧 Testando modal...');
            
            // MÉTODO NUCLEAR: Remover TUDO que possa ser modal
            try {
                // 1. Remover TODOS os elementos possíveis
                const nuclearSelectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]'
                ];
                
                nuclearSelectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        if (el && el.parentNode) {
                            el.parentNode.removeChild(el);
                            console.log('✅ Elemento nuclear removido:', selector);
                        }
                    });
                });
            } catch (e) { console.warn('Erro nuclear:', e); }

            try {
                // 2. Limpar modalContainer COMPLETAMENTE
                const container = document.getElementById('modalContainer');
                if (container) {
                    container.classList.remove('show');
                    container.innerHTML = '';
                    container.style.display = 'none';
                    container.style.visibility = 'hidden';
                    container.style.opacity = '0';
                    container.style.position = 'static';
                    container.style.zIndex = '-1';
                    console.log('✅ modalContainer nuclear limpo');
                }
            } catch (e) { console.warn('Erro modalContainer:', e); }

            try {
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed' && parseInt(style.zIndex) >= 20) {
                        el.remove();
                        console.log('✅ Z-index nuclear removido');
                    }
                });
            } catch (e) { console.warn('Erro z-index:', e); }

            try {
                // 4. Forçar remoção de TODOS os divs suspeitos
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('fixed') || 
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)') {
                        div.remove();
                        console.log('✅ Div suspeito removido');
                    }
                });
            } catch (e) { console.warn('Erro divs suspeitos:', e); }

            try {
                // 5. Restaurar TUDO do body e html
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.top = '';
                document.body.style.left = '';
                document.documentElement.style.overflow = '';
                document.documentElement.style.position = '';
                console.log('✅ Body/html nuclear restaurado');
            } catch (e) { console.warn('Erro body/html:', e); }

            try {
                // 6. Blur e limpar TUDO
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                console.log('✅ Foco nuclear removido');
            } catch (e) { console.warn('Erro foco:', e); }

            // 7. LIMPEZA NUCLEAR FINAL APÓS 50ms
            setTimeout(() => {
                try {
                    document.querySelectorAll('.modal, .fixed, [role="dialog"], .bg-black, .inset-0').forEach(el => {
                        if (el && el.parentNode) {
                            el.parentNode.removeChild(el);
                        }
                    });
                    console.log('✅ Limpeza nuclear final executada');
                } catch (e) { console.warn('Erro limpeza final:', e); }
            }, 50);

            // 8. LIMPEZA NUCLEAR EXTREMA APÓS 200ms
            setTimeout(() => {
                try {
                    document.querySelectorAll('div').forEach(div => {
                        if (div.style.position === 'fixed' || div.classList.contains('fixed')) {
                            div.remove();
                        }
                    });
                    console.log('✅ Limpeza nuclear extrema executada');
                } catch (e) { console.warn('Erro limpeza extrema:', e); }
            }, 200);

            console.log('✅ fecharModalSimples executado - VERSÃO NUCLEAR');
        }

        // FUNÇÃO NUCLEAR GLOBAL - MÉTODO IMPOSSÍVEL DE FALHAR - VERSÃO EXTREMA
        function fecharModalDIRETO() {
            console.log('🔧 fecharModalNUCLEAR chamado - MÉTODO IMPOSSÍVEL DE FALHAR - VERSÃO EXTREMA');
            
            // MÉTODO NUCLEAR ABSOLUTO: Remover TUDO que possa ser modal
            try {
                // 1. Remover TODOS os elementos possíveis
                const nuclearSelectors = [
                    '.modal', '.fixed', '.inset-0', '[role="dialog"]', '.modal-content',
                    '.bg-black', '.bg-opacity-50', '.z-50', '.z-40', '.z-30', '.z-20',
                    'div[style*="position: fixed"]', 'div[style*="z-index"]',
                    'div[class*="fixed"]', 'div[class*="inset"]', 'div[class*="bg-black"]'
                ];
                
                nuclearSelectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        if (el && el.parentNode) {
                            el.parentNode.removeChild(el);
                            console.log('✅ Elemento nuclear removido:', selector);
                        }
                    });
                });
            } catch (e) { console.warn('Erro nuclear:', e); }

            try {
                // 2. Limpar modalContainer COMPLETAMENTE
                const container = document.getElementById('modalContainer');
                if (container) {
                    container.classList.remove('show');
                    container.innerHTML = '';
                    container.style.display = 'none';
                    container.style.visibility = 'hidden';
                    container.style.opacity = '0';
                    container.style.position = 'static';
                    container.style.zIndex = '-1';
                    console.log('✅ modalContainer nuclear limpo');
                }
            } catch (e) { console.warn('Erro modalContainer:', e); }

            try {
                // 3. Remover TODOS os elementos com z-index alto
                document.querySelectorAll('*').forEach(el => {
                    const style = getComputedStyle(el);
                    if (style.position === 'fixed' && parseInt(style.zIndex) >= 20) {
                        el.remove();
                        console.log('✅ Z-index nuclear removido');
                    }
                });
            } catch (e) { console.warn('Erro z-index:', e); }

            try {
                // 4. Forçar remoção de TODOS os divs suspeitos
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' || 
                        div.classList.contains('fixed') || 
                        div.classList.contains('inset-0') ||
                        div.style.zIndex >= 20 ||
                        div.style.background === 'rgba(0, 0, 0, 0.5)' ||
                        div.style.backgroundColor === 'rgba(0, 0, 0, 0.5)') {
                        div.remove();
                        console.log('✅ Div suspeito removido');
                    }
                });
            } catch (e) { console.warn('Erro divs suspeitos:', e); }

            try {
                // 5. Restaurar TUDO do body e html
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.top = '';
                document.body.style.left = '';
                document.documentElement.style.overflow = '';
                document.documentElement.style.position = '';
                console.log('✅ Body/html nuclear restaurado');
            } catch (e) { console.warn('Erro body/html:', e); }

            try {
                // 6. Blur e limpar TUDO
                if (document.activeElement && typeof document.activeElement.blur === 'function') {
                    document.activeElement.blur();
                }
                console.log('✅ Foco nuclear removido');
            } catch (e) { console.warn('Erro foco:', e); }

            // 7. LIMPEZA NUCLEAR FINAL APÓS 50ms
            setTimeout(() => {
                try {
                    document.querySelectorAll('.modal, .fixed, [role="dialog"], .bg-black, .inset-0').forEach(el => {
                        if (el && el.parentNode) {
                            el.parentNode.removeChild(el);
                        }
                    });
                    console.log('✅ Limpeza nuclear final executada');
                } catch (e) { console.warn('Erro limpeza final:', e); }
            }, 50);

            // 8. LIMPEZA NUCLEAR EXTREMA APÓS 200ms
            setTimeout(() => {
                try {
                    document.querySelectorAll('div').forEach(div => {
                        if (div.style.position === 'fixed' || div.classList.contains('fixed')) {
                            div.remove();
                        }
                    });
                    console.log('✅ Limpeza nuclear extrema executada');
                } catch (e) { console.warn('Erro limpeza extrema:', e); }
            }, 200);

            // 9. LIMPEZA NUCLEAR ABSOLUTA APÓS 500ms
            setTimeout(() => {
                try {
                    // Remover TODOS os elementos que possam ser modais
                    document.querySelectorAll('*').forEach(el => {
                        const style = getComputedStyle(el);
                        if (style.position === 'fixed' && parseInt(style.zIndex) >= 10) {
                            el.remove();
                        }
                    });
                    console.log('✅ Limpeza nuclear absoluta executada');
                } catch (e) { console.warn('Erro limpeza absoluta:', e); }
            }, 500);

            // 10. LIMPEZA NUCLEAR FINAL APÓS 1000ms
            setTimeout(() => {
                try {
                    // Forçar remoção de TODOS os elementos com classes suspeitas
                    document.querySelectorAll('.modal, .fixed, .inset-0, [role="dialog"], .modal-content, .bg-black, .bg-opacity-50').forEach(el => {
                        if (el && el.parentNode) {
                            el.parentNode.removeChild(el);
                        }
                    });
                    console.log('✅ Limpeza nuclear final absoluta executada');
                } catch (e) { console.warn('Erro limpeza final absoluta:', e); }
            }, 1000);

            console.log('✅ fecharModalNUCLEAR executado - MÉTODO IMPOSSÍVEL DE FALHAR - VERSÃO EXTREMA');
        }

        // SOLUÇÃO SIMPLES E DIRETA - FUNCIONA GARANTIDO
        function fecharModalDIRETO() {
            console.log('🔧 fecharModalSUPERRADICAL chamado - SOLUÇÃO SIMPLES');
            
            // MÉTODO SIMPLES: Remover TUDO que seja modal
            try {
                // 1. Remover TODOS os elementos com classes de modal
                const elementos = document.querySelectorAll('.modal, .fixed, .inset-0, [role="dialog"], .modal-content, .bg-black, .bg-opacity-50');
                elementos.forEach(el => {
                    if (el && el.parentNode) {
                        el.parentNode.removeChild(el);
                        console.log('✅ Elemento removido');
                    }
                });
            } catch (e) { console.warn('Erro:', e); }

            try {
                // 2. Limpar modalContainer
                const container = document.getElementById('modalContainer');
                if (container) {
                    container.innerHTML = '';
                    container.style.display = 'none';
                    console.log('✅ modalContainer limpo');
                }
            } catch (e) { console.warn('Erro modalContainer:', e); }

            try {
                // 3. Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                console.log('✅ Scroll restaurado');
            } catch (e) { console.warn('Erro scroll:', e); }

            console.log('✅ fecharModalSUPERRADICAL executado - SOLUÇÃO SIMPLES');
        }

        // FUNÇÃO DE EMERGÊNCIA - FUNCIONA GARANTIDO - VERSÃO FINAL
        function fecharModalDIRETO() {
            console.log('🔧 fecharModalEMERGENCIA chamado - VERSÃO FINAL - FUNCIONA GARANTIDO');
            
            // MÉTODO DE EMERGÊNCIA: Remover TUDO
            try {
                // Remover TODOS os elementos que possam ser modais
                document.querySelectorAll('*').forEach(el => {
                    if (el.style.position === 'fixed' || 
                        el.classList.contains('modal') || 
                        el.classList.contains('fixed') ||
                        el.classList.contains('inset-0') ||
                        el.style.zIndex >= 10) {
                        el.remove();
                        console.log('✅ Elemento de emergência removido');
                    }
                });
            } catch (e) { console.warn('Erro emergência:', e); }

            try {
                // Limpar modalContainer
                const container = document.getElementById('modalContainer');
                if (container) {
                    container.innerHTML = '';
                    container.style.display = 'none';
                    console.log('✅ modalContainer de emergência limpo');
                }
            } catch (e) { console.warn('Erro modalContainer emergência:', e); }

            try {
                // Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                console.log('✅ Scroll de emergência restaurado');
            } catch (e) { console.warn('Erro scroll emergência:', e); }

            console.log('✅ fecharModalEMERGENCIA executado - VERSÃO FINAL - FUNCIONA GARANTIDO');
        }

        // FUNÇÃO DE EMERGÊNCIA ALTERNATIVA - CASO A PRIMEIRA NÃO FUNCIONE
        function fecharModalFINAL() {
            console.log('🔧 fecharModalFINAL chamado - FUNCIONA GARANTIDO');
            
            // MÉTODO FINAL: Remover TUDO
            try {
                // Remover TODOS os elementos que possam ser modais
                document.querySelectorAll('*').forEach(el => {
                    if (el.style.position === 'fixed' || 
                        el.classList.contains('modal') || 
                        el.classList.contains('fixed') ||
                        el.classList.contains('inset-0') ||
                        el.style.zIndex >= 10) {
                        el.remove();
                        console.log('✅ Elemento final removido');
                    }
                });
            } catch (e) { console.warn('Erro final:', e); }

            try {
                // Limpar modalContainer
                const container = document.getElementById('modalContainer');
                if (container) {
                    container.innerHTML = '';
                    container.style.display = 'none';
                    console.log('✅ modalContainer final limpo');
                }
            } catch (e) { console.warn('Erro modalContainer final:', e); }

            try {
                // Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                console.log('✅ Scroll final restaurado');
            } catch (e) { console.warn('Erro scroll final:', e); }

            console.log('✅ fecharModalFINAL executado - FUNCIONA GARANTIDO');
        }

        // FUNÇÃO QUE FORÇA O BROWSER A USAR A VERSÃO MAIS RECENTE
        function forcarVersaoMaisRecente() {
            console.log('🔧 forcarVersaoMaisRecente chamado - FORÇANDO VERSÃO MAIS RECENTE');
            
            // Forçar reload da página para garantir que a versão mais recente seja carregada
            if (confirm('Para garantir que a versão mais recente seja carregada, vamos recarregar a página. Continuar?')) {
                window.location.reload(true);
            }
        }

        // FUNÇÃO QUE SUBSTITUI A FUNÇÃO ANTIGA PELA NOVA
        function substituirFuncaoAntiga() {
            console.log('🔧 substituirFuncaoAntiga chamado - SUBSTITUINDO FUNÇÃO ANTIGA');
            
            // Substituir a função antiga pela nova
            if (typeof fecharModalRobusto === 'function') {
                fecharModalRobusto = fecharModalEMERGENCIA;
                console.log('✅ fecharModalRobusto substituída por fecharModalEMERGENCIA');
            }
            
            if (typeof fecharModalAnexosCliente === 'function') {
                fecharModalAnexosCliente = fecharModalEMERGENCIA;
                console.log('✅ fecharModalAnexosCliente substituída por fecharModalEMERGENCIA');
            }
            
            if (typeof fecharModalSimples === 'function') {
                fecharModalSimples = fecharModalEMERGENCIA;
                console.log('✅ fecharModalSimples substituída por fecharModalEMERGENCIA');
            }
            
            console.log('✅ substituirFuncaoAntiga executado - FUNÇÕES SUBSTITUÍDAS');
        }

        // EXECUTAR AUTOMATICAMENTE A SUBSTITUIÇÃO QUANDO A PÁGINA CARREGA
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 DOMContentLoaded - EXECUTANDO SUBSTITUIÇÃO AUTOMÁTICA');
            try {
                substituirFuncaoAntiga();
            } catch (e) {
                console.warn('Erro ao executar substituirFuncaoAntiga:', e);
            }
        });

        // EXECUTAR TAMBÉM QUANDO A PÁGINA ESTÁ COMPLETAMENTE CARREGADA
        window.addEventListener('load', function() {
            console.log('🔧 Window load - EXECUTANDO SUBSTITUIÇÃO AUTOMÁTICA');
            try {
                substituirFuncaoAntiga();
            } catch (e) {
                console.warn('Erro ao executar substituirFuncaoAntiga:', e);
            }
        });

        // EXECUTAR IMEDIATAMENTE QUANDO A PÁGINA CARREGA
        (function() {
            console.log('🔧 EXECUTANDO IMEDIATAMENTE - SUBSTITUIÇÃO AUTOMÁTICA');
            try {
                substituirFuncaoAntiga();
            } catch (e) {
                console.warn('Erro ao executar substituirFuncaoAntiga imediatamente:', e);
            }
        })();

        // FORÇAR VERSÃO MAIS RECENTE - MÉTODO DEFINITIVO
        function forcarVersaoMaisRecente() {
            console.log('🔧 forcarVersaoMaisRecente chamado - MÉTODO DEFINITIVO');
            
            // Forçar reload da página para garantir que a versão mais recente seja carregada
            if (confirm('Para garantir que a versão mais recente seja carregada, vamos recarregar a página. Continuar?')) {
                window.location.reload(true);
            }
        }

        // EXECUTAR AUTOMATICAMENTE A FORÇA DE VERSÃO MAIS RECENTE
        setTimeout(function() {
            console.log('🔧 EXECUTANDO AUTOMATICAMENTE - FORÇA VERSÃO MAIS RECENTE');
            try {
                forcarVersaoMaisRecente();
            } catch (e) {
                console.warn('Erro ao executar forcarVersaoMaisRecente:', e);
            }
        }, 1000);

        // FUNÇÃO DIRETA QUE FUNCIONA IMEDIATAMENTE
        function fecharModalDIRETO() {
            console.log('🔧 fecharModalDIRETO chamado - FUNCIONA IMEDIATAMENTE');
            
            // MÉTODO DIRETO: Remover TUDO
            try {
                // Remover TODOS os elementos que possam ser modais
                document.querySelectorAll('*').forEach(el => {
                    if (el.style.position === 'fixed' || 
                        el.classList.contains('modal') || 
                        el.classList.contains('fixed') ||
                        el.classList.contains('inset-0') ||
                        el.style.zIndex >= 10) {
                        el.remove();
                        console.log('✅ Elemento direto removido');
                    }
                });
            } catch (e) { console.warn('Erro direto:', e); }

            try {
                // Limpar modalContainer
                const container = document.getElementById('modalContainer');
                if (container) {
                    container.innerHTML = '';
                    container.style.display = 'none';
                    console.log('✅ modalContainer direto limpo');
                }
            } catch (e) { console.warn('Erro modalContainer direto:', e); }

            try {
                // Restaurar scroll
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                console.log('✅ Scroll direto restaurado');
            } catch (e) { console.warn('Erro scroll direto:', e); }

            console.log('✅ fecharModalDIRETO executado - FUNCIONA IMEDIATAMENTE');
        }

        // CRIAR FUNÇÃO SE ELA NÃO EXISTIR
        if (typeof fecharModalDIRETO === 'undefined') {
            window.fecharModalDIRETO = function() {
                console.log('🔧 fecharModalDIRETO criada dinamicamente - FUNCIONA IMEDIATAMENTE');
                
                // MÉTODO DIRETO: Remover TUDO
                try {
                    // Remover TODOS os elementos que possam ser modais
                    document.querySelectorAll('*').forEach(el => {
                        if (el.style.position === 'fixed' || 
                            el.classList.contains('modal') || 
                            el.classList.contains('fixed') ||
                            el.classList.contains('inset-0') ||
                            el.style.zIndex >= 10) {
                            el.remove();
                            console.log('✅ Elemento direto removido');
                        }
                    });
                } catch (e) { console.warn('Erro direto:', e); }

                try {
                    // Limpar modalContainer
                    const container = document.getElementById('modalContainer');
                    if (container) {
                        container.innerHTML = '';
                        container.style.display = 'none';
                        console.log('✅ modalContainer direto limpo');
                    }
                } catch (e) { console.warn('Erro modalContainer direto:', e); }

                try {
                    // Restaurar scroll
                    document.body.style.overflow = '';
                    document.documentElement.style.overflow = '';
                    console.log('✅ Scroll direto restaurado');
                } catch (e) { console.warn('Erro scroll direto:', e); }

                console.log('✅ fecharModalDIRETO executado - FUNCIONA IMEDIATAMENTE');
            };
            console.log('✅ fecharModalDIRETO criada dinamicamente');
        }

        // Função de teste para modal
        function testarModal() {
            console.log('🔧 Testando modal...');
            
            // Remover modais existentes primeiro
            fecharModalDIRETO();
            
            // Criar modal de teste simples
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background-color: rgba(0, 0, 0, 0.8) !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 99999 !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    max-width: 400px;
                    width: 90%;
                    text-align: center;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                ">
                    <h2 style="color: #1f2937; margin-bottom: 20px;">🧪 TESTE DE MODAL</h2>
                    <p style="color: #6b7280; margin-bottom: 20px;">Se vês esta mensagem, o modal está a funcionar!</p>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="fecharModalDIRETO()" style="
                            background: #3b82f6;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 16px;
                        ">Fechar Robusto</button>
                        <button onclick="fecharModalDIRETO()" style="
                            background: #10b981;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 16px;
                        ">Fechar Simples</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('✅ Modal de teste criado');
            
            // Verificar se foi adicionado
            setTimeout(() => {
                const modalTeste = document.querySelector('.modal');
                if (modalTeste) {
                    console.log('✅ Modal encontrado no DOM');
                } else {
                    console.log('❌ Modal não encontrado no DOM');
                }
            }, 100);
        }

        // Função ultra-simples para modal
        function modalUltraSimples() {
            console.log('🔧 Modal ultra-simples...');
            
            // Criar div simples
            const div = document.createElement('div');
            div.id = 'modal-teste';
            div.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 999999;
                display: flex;
                justify-content: center;
                align-items: center;
            `;
            
            div.innerHTML = `
                <div style="
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 300px;
                    text-align: center;
                ">
                    <h3>🎯 MODAL ULTRA-SIMPLES</h3>
                    <p>Se vês isto, o modal funciona!</p>
                    <button onclick="document.getElementById('modal-teste').remove()" style="
                        background: #ef4444;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 4px;
                        cursor: pointer;
                    ">Fechar</button>
                </div>
            `;
            
            document.body.appendChild(div);
            console.log('✅ Modal ultra-simples criado');
        }

        // Modo Escuro
        function inicializarModoEscuro_REMOVED() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                ativarModoEscuro();
            } else {
                desativarModoEscuro();
            }
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            
            if (isDark) {
                desativarModoEscuro();
            } else {
                ativarModoEscuro();
            }
        }

        function ativarModoEscuro() {
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
            
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            
            if (icon) icon.setAttribute('data-lucide', 'sun');
            if (text) text.textContent = 'Modo Claro';
            
            // Re-renderizar ícones
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        function desativarModoEscuro() {
            document.documentElement.removeAttribute('data-theme');
            localStorage.setItem('theme', 'light');
            
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            
            if (icon) icon.setAttribute('data-lucide', 'moon');
            if (text) text.textContent = 'Modo Escuro';
            
            // Re-renderizar ícones
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        // Gestos Touch
        function inicializarGestosTouch() {
            let startX, startY, endX, endY;
            
            document.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            });
            
            document.addEventListener('touchend', (e) => {
                endX = e.changedTouches[0].clientX;
                endY = e.changedTouches[0].clientY;
                
                const deltaX = endX - startX;
                const deltaY = endY - startY;
                
                // Swipe horizontal (mudança de seção)
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                    if (deltaX > 0) {
                        // Swipe direita - seção anterior
                        navegarSecaoAnterior();
                    } else {
                        // Swipe esquerda - próxima seção
                        navegarProximaSecao();
                    }
                }
                
                // Swipe vertical (fechar modais)
                if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > 100) {
                    if (deltaY > 0) {
                        // Swipe para baixo - fechar modal
                        fecharModal();
                    }
                }
            });
            
            // Pull to refresh
            let pullStartY = 0;
            let isPulling = false;
            
            document.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0) {
                    pullStartY = e.touches[0].clientY;
                    isPulling = true;
                }
            });
            
            document.addEventListener('touchmove', (e) => {
                if (isPulling && window.scrollY === 0) {
                    const pullDistance = e.touches[0].clientY - pullStartY;
                    if (pullDistance > 100) {
                        // Pull to refresh
                        window.location.reload();
                        isPulling = false;
                    }
                }
            });
        }

        function navegarSecaoAnterior() {
            const secoes = ['dashboard', 'clientes', 'honorarios', 'contratos', 'herancas', 'migracoes', 'registos', 'prazos', 'notificacoes'];
            const indiceAtual = secoes.indexOf(secaoAtiva);
            if (indiceAtual > 0) {
                carregarSecao(secoes[indiceAtual - 1]);
            }
        }

        function navegarProximaSecao() {
            const secoes = ['dashboard', 'clientes', 'honorarios', 'contratos', 'herancas', 'migracoes', 'registos', 'prazos', 'notificacoes'];
            const indiceAtual = secoes.indexOf(secaoAtiva);
            if (indiceAtual < secoes.length - 1) {
                carregarSecao(secoes[indiceAtual + 1]);
            }
        }

        // Notificações Push
        function solicitarPermissaoNotificacoes() {
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then((permission) => {
                        if (permission === 'granted') {
                            console.log('✅ Permissão para notificações concedida');
                            mostrarNotificacao('Notificações ativadas!', 'success');
                        }
                    });
                }
            }
        }

        function enviarNotificacaoPush(titulo, corpo, icone) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(titulo, {
                    body: corpo,
                    icon: icone || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMzYjgyZjYiLz4KPHBhdGggZD0iTTk2IDQ4QzY5LjQ5IDQ4IDQ4IDY5LjQ5IDQ4IDk2UzY5LjQ5IDE0NCA5NiAxNDRTMTQ0IDEyMi41MSAxNDQgOTZTMTIyLjUxIDQ4IDk2IDQ4Wk05NiAxMjhDNzMuOTA5IDEyOCA1NiAxMTAuMDkgNTYgODhTNzMuOTA5IDQ4IDk2IDQ4UzEzNiA2NS45MSAxMzYgODhTMTE4LjA5IDEyOCA5NiAxMjhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K',
                    badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTYiIGhlaWdodD0iOTYiIHZpZXdCb3g9IjAgMCA5NiA5NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9Ijk2IiBoZWlnaHQ9Ijk2IiByeD0iMTIiIGZpbGw9IiNmNTk5MGIiLz4KPHBhdGggZD0iTTQ4IDI0QzM0Ljc0IDI0IDI0IDM0Ljc0IDI0IDQ4UzM0Ljc0IDcyIDQ4IDcyUzcyIDYxLjI2IDcyIDQ4UzYxLjI2IDI0IDQ4IDI0Wk00OCA2NEM0MC4yNyA2NCAzNCA1Ny43MyAzNCA1MFM0MC4yNyAzNiA0OCAzNlM2MiA0Mi4yNyA2MiA1MFM1NS73MyA2NCA0OCA2NFoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',
                    vibrate: [200, 100, 200],
                    requireInteraction: true
                });

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
        }





        function calcularJurosAutomaticos_REMOVED() {
            console.log('🔧 Função calcularJurosAutomaticos chamada');
            console.log('💰 Calculando juros automáticos...');
            
            const honorariosVencidos = honorarios.filter(h => {
                if (h.status === 'pago') return false;
                const dataVencimento = new Date(h.vencimento);
                return dataVencimento < new Date();
            });
            
            honorariosVencidos.forEach(honorario => {
                const diasAtraso = Math.ceil((new Date() - new Date(honorario.vencimento)) / (1000 * 60 * 60 * 24));
                const taxaJuros = 0.0005; // 0.05% ao dia
                const juros = parseFloat(honorario.valor) * taxaJuros * diasAtraso;
                
                if (juros > 0) {
                    honorario.jurosCalculados = juros;
                    honorario.diasAtraso = diasAtraso;
                    honorario.valorComJuros = parseFloat(honorario.valor) + juros;
                    
                    // Criar notificação de juros
                    criarNotificacao({
                        titulo: `Juros calculados - ${honorario.clienteNome}`,
                        descricao: `Juros de €${juros.toFixed(2)} calculados (${diasAtraso} dias de atraso)`,
                        tipo: 'warning',
                        categoria: 'juros_calculados',
                        referenciaId: honorario.clienteId
                    });
                }
            });
            
            // Verificar se a função existe antes de chamar
            if (typeof salvarHonorarios === 'function') {
                console.log('🔧 Chamando salvarHonorarios...');
                salvarHonorarios();
            } else {
                console.error('❌ Função salvarHonorarios não encontrada!');
                // Fallback: salvar diretamente
                try {
                    localStorage.setItem('honorarios', JSON.stringify(honorarios));
                    console.log('✅ Honorários salvos via fallback');
                } catch (error) {
                    console.error('❌ Erro no fallback:', error);
                }
            }
        }

        // 3. GERAÇÃO AUTOMÁTICA DE FATURAS
        function gerarFaturaAutomatica(honorarioId) {
            const honorario = honorarios.find(h => h.id === honorarioId);
            if (!honorario) return;
            
            const cliente = clientes.find(c => c.id === honorario.clienteId);
            if (!cliente) return;
            
            const fatura = {
                id: Date.now(),
                numero: `FAT-${new Date().getFullYear()}-${String(Date.now()).slice(-6)}`,
                clienteId: honorario.clienteId,
                clienteNome: honorario.clienteNome,
                honorarioId: honorarioId,
                data: new Date().toISOString().split('T')[0],
                valor: honorario.valorComJuros || honorario.valor,
                juros: honorario.jurosCalculados || 0,
                status: 'pendente',
                observacoes: `Fatura gerada automaticamente para ${honorario.descricao}`
            };
            
            // Adicionar fatura
            const faturas = obterFaturas();
            faturas.push(fatura);
            localStorage.setItem('faturas', JSON.stringify(faturas));
            
            // Criar notificação
            criarNotificacao({
                titulo: `Fatura gerada - ${cliente.nome}`,
                descricao: `Fatura ${fatura.numero} gerada automaticamente`,
                tipo: 'success',
                categoria: 'fatura_gerada',
                referenciaId: cliente.id
            });
            
            console.log('📄 Fatura gerada automaticamente:', fatura);
            return fatura;
        }

        // 4. SINCRONIZAÇÃO COM CALENDÁRIO
        function sincronizarComCalendario_REMOVED() {
            console.log('🔧 Função sincronizarComCalendario chamada');
            console.log('📅 Sincronizando com calendário...');
            
            const eventos = [];
            
            // Adicionar prazos
            prazos.forEach(prazo => {
                if (prazo.status === 'ativo' && prazo.dataLimite) {
                    eventos.push({
                        titulo: `📋 Prazo: ${prazo.descricao}`,
                        data: prazo.dataLimite,
                        tipo: 'prazo',
                        cliente: prazo.clienteNome,
                        descricao: prazo.observacoes || 'Prazo importante do Sistema Legal'
                    });
                }
            });
            
            // Adicionar vencimentos de honorários
            honorarios.forEach(honorario => {
                if (honorario.status === 'pendente' && honorario.vencimento) {
                    eventos.push({
                        titulo: `💰 Vencimento: ${honorario.descricao}`,
                        data: honorario.vencimento,
                        tipo: 'vencimento',
                        cliente: honorario.clienteNome,
                        valor: honorario.valor,
                        descricao: `Honorário de €${parseFloat(honorario.valor).toFixed(2)}`
                    });
                }
            });
            
            // Adicionar contratos com vencimento
            contratos.forEach(contrato => {
                if (contrato.vencimento) {
                    eventos.push({
                        titulo: `📄 Contrato: ${contrato.descricao}`,
                        data: contrato.vencimento,
                        tipo: 'contrato',
                        cliente: contrato.clienteNome,
                        descricao: `Contrato - ${contrato.tipo}`
                    });
                }
            });
            
            // Adicionar heranças com prazo
            herancas.forEach(heranca => {
                if (heranca.prazo) {
                    eventos.push({
                        titulo: `⚖️ Herança: ${heranca.descricao}`,
                        data: heranca.prazo,
                        tipo: 'heranca',
                        cliente: heranca.clienteNome,
                        descricao: `Processo de herança - ${heranca.tipo}`
                    });
                }
            });
            
            console.log('📅 Eventos encontrados:', eventos.length);
            
            if (eventos.length === 0) {
                mostrarNotificacao('Nenhum evento encontrado para exportar!', 'info');
                return;
            }
            
            // Gerar arquivo ICS para importar no calendário
            gerarArquivoICS(eventos);
        }

        function gerarArquivoICS(eventos) {
            console.log('📅 Gerando arquivo ICS com', eventos.length, 'eventos');
            
            // Função para formatar data no formato ICS
            function formatarDataICS(data) {
                return data.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            }
            
            // Função para escapar texto para ICS
            function escaparTextoICS(texto) {
                return texto
                    .replace(/\\/g, '\\\\')
                    .replace(/;/g, '\\;')
                    .replace(/,/g, '\\,')
                    .replace(/\n/g, '\\n')
                    .replace(/\r/g, '');
            }
            
            let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Sistema Legal//Sistema Legal//PT
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:Sistema Legal - Prazos e Vencimentos
X-WR-CALDESC:Calendário do Sistema Legal com prazos e vencimentos
X-WR-TIMEZONE:Europe/Lisbon`;

            eventos.forEach((evento, index) => {
                const dataInicio = new Date(evento.data);
                const dataFim = new Date(dataInicio.getTime() + (24 * 60 * 60 * 1000)); // +1 dia
                
                // Gerar UID único
                const uid = `sistema-legal-${Date.now()}-${index}@sistemalegal.com`;
                
                // Formatar datas
                const dtstart = formatarDataICS(dataInicio);
                const dtend = formatarDataICS(dataFim);
                const dtstamp = formatarDataICS(new Date());
                
                // Escapar textos
                const summary = escaparTextoICS(evento.titulo);
                const description = escaparTextoICS(`Cliente: ${evento.cliente}${evento.valor ? `\\nValor: €${evento.valor}` : ''}\\n\\nSistema Legal - ANA PAULA MEDINA`);
                const location = escaparTextoICS('Sistema Legal');
                
                icsContent += `
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dtstamp}
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:${summary}
DESCRIPTION:${description}
LOCATION:${location}
STATUS:CONFIRMED
TRANSP:OPAQUE
SEQUENCE:0
END:VEVENT`;
            });

            icsContent += `
END:VCALENDAR`;

            console.log('📅 Conteúdo ICS gerado:', icsContent.substring(0, 200) + '...');
            
            // Criar e baixar arquivo
            const blob = new Blob([icsContent], { 
                type: 'text/calendar;charset=utf-8',
                endings: 'native'
            });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Sistema_Legal_Calendario_${new Date().toISOString().split('T')[0]}.ics`;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao(`Arquivo de calendário gerado com sucesso! (${eventos.length} eventos)`, 'success');
        }

        // 5. INTEGRAÇÃO COM SISTEMAS EXTERNOS
        function inicializarIntegracoes() {
            console.log('🔗 Inicializando integrações externas...');
            
            // Verificar se há integrações configuradas
            const integracoes = obterIntegracoes();
            
            integracoes.forEach(integracao => {
                if (integracao.ativa) {
                    switch(integracao.tipo) {
                        case 'email':
                            configurarIntegracaoEmail(integracao);
                            break;
                        case 'calendario':
                            configurarIntegracaoCalendario(integracao);
                            break;
                        case 'contabilidade':
                            configurarIntegracaoContabilidade(integracao);
                            break;
                    }
                }
            });
        }

        function configurarIntegracaoEmail(config) {
            console.log('📧 Configurando integração de email:', config);
            // Aqui você integraria com Gmail API, Outlook API, etc.
        }

        function configurarIntegracaoCalendario(config) {
            console.log('📅 Configurando integração de calendário:', config);
            // Aqui você integraria com Google Calendar, Outlook Calendar, etc.
        }

        function configurarIntegracaoContabilidade(config) {
            console.log('💰 Configurando integração de contabilidade:', config);
            // Aqui você integraria com sistemas de contabilidade
        }



        function obterFaturas() {
            console.log('🔧 Função obterFaturas chamada');
            const faturas = localStorage.getItem('faturas');
            const resultado = faturas ? JSON.parse(faturas) : [];
            console.log('🔧 Faturas obtidas:', resultado.length);
            return resultado;
        }

        function obterIntegracoes() {
            console.log('🔧 Função obterIntegracoes chamada');
            const integracoes = localStorage.getItem('integracoes');
            const resultado = integracoes ? JSON.parse(integracoes) : [];
            console.log('🔧 Integrações obtidas:', resultado.length);
            return resultado;
        }

        function salvarIntegracoes(integracoes) {
            localStorage.setItem('integracoes', JSON.stringify(integracoes));
        }

        // Função para salvar honorários (CORRIGIDA - v2.0)
        function salvarHonorarios() {
            console.log('🔧 Função salvarHonorarios chamada - v2.0');
            try {
                localStorage.setItem('honorarios', JSON.stringify(honorarios));
                console.log('✅ Honorários salvos com sucesso - v2.0');
            } catch (error) {
                console.error('❌ Erro ao salvar honorários:', error);
                mostrarNotificacao('Erro ao salvar honorários!', 'error');
            }
        }





        function gerarFaturasAutomaticas() {
            console.log('🔧 Função gerarFaturasAutomaticas chamada');
            const honorariosComJuros = honorarios.filter(h => h.jurosCalculados && h.jurosCalculados > 0);
            
            if (honorariosComJuros.length === 0) {
                mostrarNotificacao('Nenhum honorário com juros encontrado!', 'info');
                return;
            }
            
            let faturasGeradas = 0;
            honorariosComJuros.forEach(honorario => {
                if (!obterFaturas().find(f => f.honorarioId === honorario.id)) {
                    gerarFaturaAutomatica(honorario.id);
                    faturasGeradas++;
                }
            });
            
            mostrarNotificacao(`${faturasGeradas} faturas geradas automaticamente!`, 'success');
            carregarSecao('dashboard');
        }

        // Funções para gerenciar lembretes
        function editarLembrete(lembreteId) {
            const lembretes = obterLembretes();
            const lembrete = lembretes.find(l => l.id === lembreteId);
            
            if (!lembrete) {
                mostrarNotificacao('Lembrete não encontrado!', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Editar Lembrete</h3>
                        <button onclick="fecharModalDIRETO()" class="btn btn-sm btn-secondary">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <form onsubmit="atualizarLembrete(event, ${lembreteId})">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Cliente</label>
                                <select name="clienteId" required class="w-full p-2 border rounded-lg">
                                    <option value="">Selecione um cliente</option>
                                    ${clientes.map(c => `<option value="${c.id}" ${c.id === lembrete.clienteId ? 'selected' : ''}>${c.nome}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Título</label>
                                <input type="text" name="titulo" required class="w-full p-2 border rounded-lg" 
                                       value="${lembrete.titulo}" placeholder="Título do lembrete">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Data/Hora</label>
                                <input type="datetime-local" name="data" required class="w-full p-2 border rounded-lg" 
                                       value="${lembrete.data}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Descrição</label>
                                <textarea name="descricao" class="w-full p-2 border rounded-lg" rows="3" 
                                          placeholder="Descrição do lembrete">${lembrete.descricao}</textarea>
                            </div>
                            <div class="flex space-x-3">
                                <button type="submit" class="btn btn-primary">Atualizar Lembrete</button>
                                <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">Cancelar</button>
                            </div>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function atualizarLembrete(event, lembreteId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const lembretes = obterLembretes();
            const lembreteIndex = lembretes.findIndex(l => l.id === lembreteId);
            
            if (lembreteIndex === -1) {
                mostrarNotificacao('Lembrete não encontrado!', 'error');
                return;
            }
            
            lembretes[lembreteIndex] = {
                ...lembretes[lembreteIndex],
                clienteId: parseInt(formData.get('clienteId')),
                titulo: formData.get('titulo'),
                data: formData.get('data'),
                descricao: formData.get('descricao'),
                atualizadoEm: new Date().toISOString()
            };
            
            localStorage.setItem('lembretes', JSON.stringify(lembretes));
            
            fecharModal();
            mostrarNotificacao('Lembrete atualizado com sucesso!', 'success');
            carregarSecao('dashboard');
        }

        function desativarLembrete(lembreteId) {
            if (!confirm('Tem certeza que deseja desativar este lembrete?')) {
                return;
            }
            
            const lembretes = obterLembretes();
            const lembreteIndex = lembretes.findIndex(l => l.id === lembreteId);
            
            if (lembreteIndex === -1) {
                mostrarNotificacao('Lembrete não encontrado!', 'error');
                return;
            }
            
            lembretes[lembreteIndex].ativo = false;
            lembretes[lembreteIndex].desativadoEm = new Date().toISOString();
            
            localStorage.setItem('lembretes', JSON.stringify(lembretes));
            
            mostrarNotificacao('Lembrete desativado com sucesso!', 'success');
            carregarSecao('dashboard');
        }

        // Função para configurar integrações
        function configurarIntegracoes() {
            console.log('🔧 Função configurarIntegracoes chamada');
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Configurar Integrações</h3>
                        <button onclick="fecharModalDIRETO()" class="btn btn-sm btn-secondary">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Integração de Email -->
                        <div class="card p-4">
                            <h4 class="font-semibold mb-3">📧 Integração de Email</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Servidor SMTP</label>
                                    <input type="text" id="smtpServer" class="w-full p-2 border rounded-lg" 
                                           placeholder="smtp.gmail.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Porta</label>
                                    <input type="number" id="smtpPort" class="w-full p-2 border rounded-lg" 
                                           placeholder="587" value="587">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Email</label>
                                    <input type="email" id="smtpEmail" class="w-full p-2 border rounded-lg" 
                                           placeholder="seu@email.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Senha</label>
                                    <input type="password" id="smtpPassword" class="w-full p-2 border rounded-lg" 
                                           placeholder="Senha do email">
                                </div>
                                <button onclick="salvarIntegracaoEmail()" class="btn btn-primary">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                    Salvar Configuração
                                </button>
                            </div>
                        </div>

                        <!-- Integração de Calendário -->
                        <div class="card p-4">
                            <h4 class="font-semibold mb-3">📅 Integração de Calendário</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Tipo de Calendário</label>
                                    <select id="calendarioTipo" class="w-full p-2 border rounded-lg">
                                        <option value="google">Google Calendar</option>
                                        <option value="outlook">Outlook Calendar</option>
                                        <option value="apple">Apple Calendar</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">API Key</label>
                                    <input type="text" id="calendarioApiKey" class="w-full p-2 border rounded-lg" 
                                           placeholder="Chave da API">
                                </div>
                                <button onclick="salvarIntegracaoCalendario()" class="btn btn-primary">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                    Salvar Configuração
                                </button>
                            </div>
                        </div>

                        <!-- Integração de Contabilidade -->
                        <div class="card p-4">
                            <h4 class="font-semibold mb-3">💰 Integração de Contabilidade</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Sistema</label>
                                    <select id="contabilidadeSistema" class="w-full p-2 border rounded-lg">
                                        <option value="sap">SAP</option>
                                        <option value="oracle">Oracle</option>
                                        <option value="custom">Sistema Personalizado</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">URL da API</label>
                                    <input type="url" id="contabilidadeUrl" class="w-full p-2 border rounded-lg" 
                                           placeholder="https://api.exemplo.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Token de Acesso</label>
                                    <input type="text" id="contabilidadeToken" class="w-full p-2 border rounded-lg" 
                                           placeholder="Token de autenticação">
                                </div>
                                <button onclick="salvarIntegracaoContabilidade()" class="btn btn-primary">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                    Salvar Configuração
                                </button>
                            </div>
                        </div>

                        <div class="flex space-x-3">
                            <button onclick="fecharModalDIRETO()" class="btn btn-secondary">Fechar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function salvarIntegracaoEmail() {
            const config = {
                tipo: 'email',
                servidor: document.getElementById('smtpServer').value,
                porta: document.getElementById('smtpPort').value,
                email: document.getElementById('smtpEmail').value,
                senha: document.getElementById('smtpPassword').value,
                ativa: true,
                configuradaEm: new Date().toISOString()
            };
            
            const integracoes = obterIntegracoes();
            const index = integracoes.findIndex(i => i.tipo === 'email');
            
            if (index >= 0) {
                integracoes[index] = config;
            } else {
                integracoes.push(config);
            }
            
            salvarIntegracoes(integracoes);
            mostrarNotificacao('Configuração de email salva com sucesso!', 'success');
        }

        function salvarIntegracaoCalendario() {
            const config = {
                tipo: 'calendario',
                sistema: document.getElementById('calendarioTipo').value,
                apiKey: document.getElementById('calendarioApiKey').value,
                ativa: true,
                configuradaEm: new Date().toISOString()
            };
            
            const integracoes = obterIntegracoes();
            const index = integracoes.findIndex(i => i.tipo === 'calendario');
            
            if (index >= 0) {
                integracoes[index] = config;
            } else {
                integracoes.push(config);
            }
            
            salvarIntegracoes(integracoes);
            mostrarNotificacao('Configuração de calendário salva com sucesso!', 'success');
        }

        function salvarIntegracaoContabilidade() {
            const config = {
                tipo: 'contabilidade',
                sistema: document.getElementById('contabilidadeSistema').value,
                url: document.getElementById('contabilidadeUrl').value,
                token: document.getElementById('contabilidadeToken').value,
                ativa: true,
                configuradaEm: new Date().toISOString()
            };
            
            const integracoes = obterIntegracoes();
            const index = integracoes.findIndex(i => i.tipo === 'contabilidade');
            
            if (index >= 0) {
                integracoes[index] = config;
            } else {
                integracoes.push(config);
            }
            
            salvarIntegracoes(integracoes);
            mostrarNotificacao('Configuração de contabilidade salva com sucesso!', 'success');
        }

        function carregarDados() {
            try {
                const clientesSalvos = localStorage.getItem('clientes');
                if (clientesSalvos) {
                    clientes = JSON.parse(clientesSalvos);
                    window.clientes = clientes;
                }

                const honorariosSalvos = localStorage.getItem('honorarios');
                if (honorariosSalvos) {
                    honorarios = JSON.parse(honorariosSalvos);
                    window.honorarios = honorarios;
                }

                const contratosSalvos = localStorage.getItem('contratos');
                if (contratosSalvos) {
                    contratos = JSON.parse(contratosSalvos);
                    window.contratos = contratos;
                }

                const prazosSalvos = localStorage.getItem('prazos');
                if (prazosSalvos) {
                    prazos = JSON.parse(prazosSalvos);
                    window.prazos = prazos;
                }

                const notificacoesSalvas = localStorage.getItem('notificacoes');
                if (notificacoesSalvas) {
                    notificacoes = JSON.parse(notificacoesSalvas);
                    window.notificacoes = notificacoes;
                }

                const herancasSalvas = localStorage.getItem('herancas');
                if (herancasSalvas) {
                    herancas = JSON.parse(herancasSalvas);
                    window.herancas = herancas;
                }

                const migracoesSalvas = localStorage.getItem('migracoes');
                if (migracoesSalvas) {
                    migracoes = JSON.parse(migracoesSalvas);
                    window.migracoes = migracoes;
                }

                const registosSalvos = localStorage.getItem('registos');
                if (registosSalvos) {
                    registos = JSON.parse(registosSalvos);
                    window.registos = registos;
                }

                console.log('✅ Dados carregados com sucesso');
            } catch (error) {
                console.error('❌ Erro ao carregar dados:', error);
                mostrarNotificacao('Erro ao carregar dados salvos', 'error');
            }
        }

        function carregarDadosExemplo() {
            if (clientes.length === 0) {
                clientes = [
                    {
                        id: 1,
                        nome: 'João Silva',
                        email: 'joao@email.com',
                        telefone: '123456789',
                        nif: '123456789',
                        endereco: 'Rua das Flores, 123',
                        status: 'ativo',
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        nome: 'Maria Santos',
                        email: 'maria@email.com',
                        telefone: '987654321',
                        nif: '987654321',
                        endereco: 'Av. Principal, 456',
                        status: 'ativo',
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('clientes', clientes);
            }

            if (honorarios.length === 0) {
                honorarios = [
                    {
                        id: 1,
                        cliente: 'João Silva',
                        servico: 'Consulta Jurídica',
                        valor: 150.00,
                        status: 'pago',
                        vencimento: new Date().toISOString().split('T')[0],
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        cliente: 'Maria Santos',
                        servico: 'Elaboração de Contrato',
                        valor: 300.00,
                        status: 'pendente',
                        vencimento: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('honorarios', honorarios);
            }

            if (contratos.length === 0) {
                contratos = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'João Silva',
                        tipo: 'Prestação de Serviços',
                        descricao: 'Assessoria jurídica empresarial',
                        valor: 5000.00,
                        iva: 23,
                        valorIVA: 1150.00,
                        valorTotal: 6150.00,
                        dataInicio: new Date().toISOString().split('T')[0],
                        dataFim: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'ativo',
                        observacoes: 'Contrato de assessoria jurídica anual',
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Consultoria',
                        descricao: 'Consultoria em direito trabalhista',
                        valor: 2500.00,
                        iva: 23,
                        valorIVA: 575.00,
                        valorTotal: 3075.00,
                        dataInicio: new Date().toISOString().split('T')[0],
                        dataFim: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'ativo',
                        observacoes: 'Consultoria específica para questões trabalhistas',
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('contratos', contratos);
            }

            if (prazos.length === 0) {
                prazos = [
                    {
                        id: 1,
                        honorarioId: 1,
                        clienteId: 1,
                        clienteNome: 'João Silva',
                        tipo: 'Vencimento',
                        descricao: 'Vencimento de honorário - Consultoria jurídica',
                        dataLimite: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
                        status: 'ativo',
                        prioridade: 'alta',
                        notificacoes: [],
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        honorarioId: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Lembrete',
                        descricao: 'Lembrete de pagamento - Elaboração de contrato',
                        dataLimite: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                        status: 'ativo',
                        prioridade: 'media',
                        notificacoes: [],
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('prazos', prazos);
            }

            if (notificacoes.length === 0) {
                notificacoes = [];
                salvarDados('notificacoes', notificacoes);
            }

            if (herancas.length === 0) {
                herancas = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'João Silva',
                        tipo: 'Inventário',
                        descricao: 'Processo de inventário de bens',
                        valor: 15000.00,
                        iva: 23,
                        valorComIva: 18450.00,
                        status: 'em_andamento',
                        dataInicio: new Date().toISOString().split('T')[0],
                        observacoes: 'Inventário de bens móveis e imóveis',
                        parceria: false,
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Partilha',
                        descricao: 'Processo de partilha de herança',
                        valor: 25000.00,
                        iva: 23,
                        valorComIva: 30750.00,
                        status: 'concluido',
                        dataInicio: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        observacoes: 'Partilha entre 3 herdeiros',
                        parceria: true,
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('herancas', herancas);
            }

            if (migracoes.length === 0) {
                migracoes = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'João Silva',
                        tipo: 'Nacionalidade',
                        descricao: 'Processo de aquisição de nacionalidade portuguesa',
                        valor: 500.00,
                        iva: 23,
                        valorComIva: 615.00,
                        status: 'em_andamento',
                        dataInicio: new Date().toISOString().split('T')[0],
                        observacoes: 'Processo via casamento',
                        parceria: false,
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Residência',
                        descricao: 'Renovação de autorização de residência',
                        valor: 300.00,
                        iva: 23,
                        valorComIva: 369.00,
                        status: 'pendente',
                        dataInicio: new Date().toISOString().split('T')[0],
                        observacoes: 'Renovação por trabalho',
                        parceria: true,
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('migracoes', migracoes);
            }

            if (registos.length === 0) {
                registos = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'João Silva',
                        tipo: 'Nascimento',
                        descricao: 'Registo de nascimento de filho',
                        valor: 150.00,
                        iva: 23,
                        valorComIva: 184.50,
                        status: 'concluido',
                        dataInicio: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        observacoes: 'Registo no consulado',
                        parceria: false,
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Casamento',
                        descricao: 'Registo de casamento civil',
                        valor: 200.00,
                        iva: 23,
                        valorComIva: 246.00,
                        status: 'em_andamento',
                        dataInicio: new Date().toISOString().split('T')[0],
                        observacoes: 'Casamento com cidadão português',
                        parceria: true,
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('registos', registos);
            }

        }

        function salvarDados(chave, dados) {
            console.log('🔧 salvarDados chamado:', chave, dados);
            try {
                // Verificar se os dados são válidos
                if (!dados || !Array.isArray(dados)) {
                    console.error('❌ Dados inválidos para salvar:', dados);
                    mostrarNotificacao('Erro: Dados inválidos', 'error');
                    return;
                }
                
                // Salvar no localStorage
                const dadosString = JSON.stringify(dados);
                localStorage.setItem(chave, dadosString);
                console.log('✅ Dados salvos no localStorage:', chave, dadosString.length, 'caracteres');
                
                // Atualizar variáveis globais
                if (chave === 'clientes') {
                    clientes = dados;
                    window.clientes = clientes;
                } else if (chave === 'honorarios') {
                    honorarios = dados;
                    window.honorarios = honorarios;
                } else if (chave === 'contratos') {
                    contratos = dados;
                    window.contratos = contratos;
                } else if (chave === 'prazos') {
                    prazos = dados;
                    window.prazos = prazos;
                } else if (chave === 'notificacoes') {
                    notificacoes = dados;
                    window.notificacoes = notificacoes;
                } else if (chave === 'herancas') {
                    herancas = dados;
                    window.herancas = herancas;
                } else if (chave === 'migracoes') {
                    migracoes = dados;
                    window.migracoes = migracoes;
                } else if (chave === 'registos') {
                    registos = dados;
                    window.registos = registos;
                }
                
                console.log(`✅ Dados ${chave} salvos com sucesso - ${dados.length} itens`);
                
                // Verificar se foi salvo corretamente
                const dadosSalvos = localStorage.getItem(chave);
                if (dadosSalvos) {
                    console.log('✅ Verificação: Dados confirmados no localStorage');
                } else {
                    console.error('❌ Verificação: Dados não encontrados no localStorage');
                }
                
            } catch (error) {
                console.error('❌ Erro ao salvar dados:', error);
                mostrarNotificacao('Erro ao salvar dados: ' + error.message, 'error');
            }
        }

        function configurarEventos() {
            document.getElementById('menuHamburguer')?.addEventListener('click', () => {
                toggleSidebar();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    fecharModal();
                }
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
        }

        function carregarSecao(secao) {
            console.log('🔧 carregarSecao chamado para:', secao);
            
            // Verificar se é convidado e redirecionar para clientes se necessário
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            if (tipoUsuario === 'convidado') {
                const secoesPermitidas = ['clientes', 'notificacoes'];
                if (!secoesPermitidas.includes(secao)) {
                    secao = 'clientes'; // Redirecionar para clientes
                }
            }
            
            // Fechar qualquer modal aberto antes de carregar nova seção
            fecharModal();
            
            // Recarregar dados do localStorage antes de gerar conteúdo
            carregarDados();
            
            secaoAtiva = secao;
            atualizarNavegacao();
            atualizarTitulo(secao);
            
            const conteudo = gerarConteudoSecao(secao);
            console.log('🔧 Conteúdo gerado:', conteudo ? 'SIM' : 'NÃO');
            const conteudoElement = document.getElementById('conteudoDinamico');
            if (conteudoElement) {
                conteudoElement.innerHTML = conteudo;
                console.log('✅ Conteúdo inserido no DOM');
                
                // Atualizar badge de notificações se for a seção de notificações
                if (secao === 'notificacoes') {
                    atualizarBadgeNotificacoes();
                }
            } else {
                console.error('❌ Elemento conteudoDinamico não encontrado');
            }
            
            inicializarSecao(secao);
            
            // Inicializar filtros para seções específicas
            if (secao === 'migracoes') {
                setTimeout(() => {
                    aplicarFiltrosMigracoes();
                }, 100);
            }
            
            if (secao === 'contratos') {
                setTimeout(() => {
                    aplicarFiltrosContratos();
                }, 100);
            }
            
            if (secao === 'honorarios') {
                setTimeout(() => {
                    aplicarFiltrosHonorarios();
                }, 100);
            }
            
            if (secao === 'herancas') {
                console.log('🔧 Carregando seção herancas');
                console.log('🔧 herancas array:', herancas);
                console.log('🔧 herancas length:', herancas ? herancas.length : 'undefined');
                setTimeout(() => {
                    if (typeof atualizarListaHerancas === 'function') {
                        console.log('🔧 Chamando atualizarListaHerancas');
                        atualizarListaHerancas(herancas);
                    } else {
                        console.log('❌ atualizarListaHerancas não é uma função');
                    }
                }, 100);
                
                // FORÇAR CHAMADA ADICIONAL
                setTimeout(() => {
                    console.log('🔧 FORÇANDO CHAMADA ADICIONAL atualizarListaHerancas');
                    if (typeof atualizarListaHerancas === 'function') {
                        atualizarListaHerancas(herancas);
                    }
                }, 500);
                
                // TESTE DIRETO NO CONSOLE
                console.log('🔧 TESTE: Executando atualizarListaHerancas diretamente');
                if (typeof atualizarListaHerancas === 'function') {
                    try {
                        atualizarListaHerancas(herancas);
                        console.log('✅ atualizarListaHerancas executado com sucesso');
                    } catch (error) {
                        console.error('❌ ERRO ao executar atualizarListaHerancas:', error);
                    }
                } else {
                    console.error('❌ atualizarListaHerancas não é uma função');
                }
            }
            
            if (secao === 'registos') {
                console.log('🔧 Carregando seção registos');
                console.log('🔧 registos array:', registos);
                console.log('🔧 registos length:', registos ? registos.length : 'undefined');
                
                // FORÇAR CHAMADA IMEDIATA
                console.log('🔧 FORÇANDO CHAMADA IMEDIATA atualizarListaRegistos');
                console.log('🔧 registos disponíveis:', registos);
                if (typeof atualizarListaRegistos === 'function') {
                    try {
                        atualizarListaRegistos(registos);
                        console.log('✅ atualizarListaRegistos executado imediatamente');
                    } catch (error) {
                        console.error('❌ ERRO ao executar atualizarListaRegistos:', error);
                    }
                } else {
                    console.error('❌ atualizarListaRegistos não é uma função!');
                }
                
                setTimeout(() => {
                    if (typeof atualizarListaRegistos === 'function') {
                        console.log('🔧 Chamando atualizarListaRegistos');
                        atualizarListaRegistos(registos);
                    } else {
                        console.log('❌ atualizarListaRegistos não é uma função');
                    }
                }, 100);
                
                // FORÇAR CHAMADA ADICIONAL
                setTimeout(() => {
                    console.log('🔧 FORÇANDO CHAMADA ADICIONAL atualizarListaRegistos');
                    if (typeof atualizarListaRegistos === 'function') {
                        atualizarListaRegistos(registos);
                    }
                }, 500);
                
                // TESTE DIRETO NO CONSOLE
                console.log('🔧 TESTE: Executando atualizarListaRegistos diretamente');
                if (typeof atualizarListaRegistos === 'function') {
                    try {
                        atualizarListaRegistos(registos);
                        console.log('✅ atualizarListaRegistos executado com sucesso');
                    } catch (error) {
                        console.error('❌ ERRO ao executar atualizarListaRegistos:', error);
                    }
                } else {
                    console.error('❌ atualizarListaRegistos não é uma função');
                }
            }
            
            console.log('✅ Seção carregada:', secao);
            
            // FORÇAR EXECUÇÃO IMEDIATA PARA TESTE
            if (secao === 'herancas') {
                console.log('🔧 FORÇANDO EXECUÇÃO IMEDIATA PARA HERANÇAS');
                
                // CRIAR DADOS DE TESTE SE NÃO EXISTIREM
                if (!herancas || herancas.length === 0) {
                    console.log('🔧 CRIANDO DADOS DE TESTE PARA HERANÇAS');
                    herancas = [{
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'TESTE HERANÇA',
                        tipo: 'TESTE',
                        descricao: 'TESTE PARA VERIFICAR AÇÕES',
                        valor: 1000,
                        iva: 23,
                        valorComIva: 1230,
                        status: 'em_andamento',
                        dataInicio: new Date().toISOString().split('T')[0]
                    }];
                }
                
                setTimeout(() => {
                    console.log('🔧 EXECUTANDO atualizarListaHerancas IMEDIATAMENTE');
                    if (typeof atualizarListaHerancas === 'function') {
                        try {
                            atualizarListaHerancas(herancas);
                            console.log('✅ atualizarListaHerancas FORÇADO executado');
                        } catch (error) {
                            console.error('❌ ERRO FORÇADO atualizarListaHerancas:', error);
                        }
                    }
                }, 1000);
            }
            
            if (secao === 'registos') {
                console.log('🔧 FORÇANDO EXECUÇÃO IMEDIATA PARA REGISTOS');
                
                // CRIAR DADOS DE TESTE SE NÃO EXISTIREM
                if (!registos || registos.length === 0) {
                    console.log('🔧 CRIANDO DADOS DE TESTE PARA REGISTOS');
                    registos = [{
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'TESTE REGISTO',
                        tipo: 'TESTE',
                        descricao: 'TESTE PARA VERIFICAR AÇÕES',
                        valor: 500,
                        iva: 23,
                        valorComIva: 615,
                        status: 'em_andamento',
                        dataInicio: new Date().toISOString().split('T')[0]
                    }];
                }
                
                setTimeout(() => {
                    console.log('🔧 EXECUTANDO atualizarListaRegistos IMEDIATAMENTE');
                    if (typeof atualizarListaRegistos === 'function') {
                        try {
                            atualizarListaRegistos(registos);
                            console.log('✅ atualizarListaRegistos FORÇADO executado');
                        } catch (error) {
                            console.error('❌ ERRO FORÇADO atualizarListaRegistos:', error);
                        }
                    }
                }, 1000);
            }
            
            // Só tentar fechar sidebar se estiver no sistema principal
            if (window.innerWidth <= 1024 && document.getElementById('sidebar')) {
                toggleSidebar();
            }
            
            // Criar gráficos avançados se for a seção dashboard
            if (secao === 'dashboard') {
                setTimeout(() => {
                    criarGraficosAvancados();
                }, 500);
            }
        }

        function atualizarNavegacao() {
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            if (sidebarItems.length > 0) {
                sidebarItems.forEach(item => {
                    item.classList.remove('active');
                });
                const activeItem = document.getElementById(`nav-${secaoAtiva}`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }
        }

        function atualizarTitulo(secao) {
            console.log('🔧 atualizarTitulo chamado para:', secao);
            
            const titulos = {
                dashboard: 'Visão Geral',
                clientes: 'Gestão de Clientes',
                honorarios: 'Gestão de Honorários',
                contratos: 'Gestão de Contratos',
                prazos: 'Gestão de Prazos',
                notificacoes: 'Central de Notificações',
                herancas: 'Gestão de Heranças',
                migracoes: 'Gestão de Migração',
                registos: 'Gestão de Registos',
                relatorios: 'Gestão de Relatórios',
                backup: 'Sistema de Backup',
            };
            
            const tituloElement = document.getElementById('tituloSecao');
            const subtituloElement = document.getElementById('subtituloSecao');
            const pageTitleElement = document.getElementById('pageTitle');
            
            console.log('🔧 Elementos encontrados:', {
                tituloSecao: tituloElement ? 'SIM' : 'NÃO',
                subtituloSecao: subtituloElement ? 'SIM' : 'NÃO',
                pageTitle: pageTitleElement ? 'SIM' : 'NÃO'
            });
            
            const titulo = titulos[secao] || 'Sistema Legal';
            
            if (tituloElement) {
                tituloElement.textContent = titulo;
                console.log('✅ tituloSecao atualizado para:', titulo);
            }
            if (subtituloElement) {
                subtituloElement.textContent = 'Visão geral do sistema';
            }
            if (pageTitleElement) {
                pageTitleElement.textContent = titulo;
                console.log('✅ pageTitle atualizado para:', titulo);
            }
        }

        function gerarConteudoSecao(secao) {
            console.log('🔧 gerarConteudoSecao chamado para:', secao);
            console.log('🔧 migracoes array antes:', migracoes);
            
            
            // Garantir que migracoes existe
            if (!migracoes) {
                migracoes = [];
                console.log('🔧 migracoes inicializado como array vazio');
            }
            
            const conteudos = {
                dashboard: gerarDashboard(),
                clientes: gerarClientes(),
                honorarios: gerarHonorarios(),
                contratos: gerarContratos(),
                prazos: gerarPrazos(),
                notificacoes: gerarNotificacoes(),
                herancas: gerarHerancas(),
                convidados: gerarConvidados(),
                migracoes: gerarMigracao(),
                registos: gerarRegistos(),
                relatorios: gerarRelatorios(),
                backup: gerarBackup(),
            };
            
            console.log('🔧 Conteúdos disponíveis:', Object.keys(conteudos));
            console.log('🔧 Conteúdo para migracoes:', conteudos.migracoes ? 'EXISTE' : 'NÃO EXISTE');
            console.log('🔧 Conteúdo migracoes:', conteudos.migracoes);
            
            
            return conteudos[secao] || '<p>Seção não encontrada</p>';
        }

        function gerarRelatorioCompleto() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            let clientesParaMostrar = clientes;
            let honorariosParaMostrar = honorarios;
            let herancasParaMostrar = herancas;
            let migracoesParaMostrar = migracoes;
            let registosParaMostrar = registos;
            let contratosParaMostrar = contratos;
            
            // Filtrar dados para convidados
            if (tipoUsuario === 'convidado') {
                const convidadoId = localStorage.getItem('convidadoId');
                const convidados = obterConvidados();
                const convidado = convidados.find(c => c.id === parseInt(convidadoId));
                
                if (convidado && convidado.ativo) {
                    const clientesAutorizados = convidado.clientesAutorizados;
                    clientesParaMostrar = clientes.filter(c => clientesAutorizados.includes(c.id));
                    honorariosParaMostrar = honorarios.filter(h => clientesAutorizados.includes(h.clienteId));
                    herancasParaMostrar = herancas.filter(h => clientesAutorizados.includes(h.clienteId));
                    migracoesParaMostrar = migracoes.filter(m => clientesAutorizados.includes(m.clienteId));
                    registosParaMostrar = registos.filter(r => clientesAutorizados.includes(r.clienteId));
                    contratosParaMostrar = contratos.filter(c => clientesAutorizados.includes(c.clienteId));
                } else {
                    clientesParaMostrar = [];
                    honorariosParaMostrar = [];
                    herancasParaMostrar = [];
                    migracoesParaMostrar = [];
                    registosParaMostrar = [];
                    contratosParaMostrar = [];
                }
            }
            
            const valorTotalHonorarios = honorariosParaMostrar.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            const valorTotalHerancas = herancasParaMostrar.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            const valorTotalMigracoes = migracoesParaMostrar.reduce((sum, m) => sum + (parseFloat(m.valor) || 0), 0);
            const valorTotalRegistos = registosParaMostrar.reduce((sum, r) => sum + (parseFloat(r.valor) || 0), 0);
            const valorTotalContratos = contratosParaMostrar.reduce((sum, c) => sum + (parseFloat(c.valor) || 0), 0);
            const valorTotalGeral = valorTotalHonorarios + valorTotalHerancas + valorTotalMigracoes + valorTotalRegistos + valorTotalContratos;
            
            const relatorio = `
RELATÓRIO COMPLETO - SISTEMA LEGAL
Data: ${new Date().toLocaleDateString('pt-PT')} ${new Date().toLocaleTimeString('pt-PT')}

=== RESUMO GERAL ===
Total de Clientes: ${clientesParaMostrar.length}
Total de Honorários: ${honorariosParaMostrar.length}
Total de Heranças: ${herancasParaMostrar.length}
Total de Migrações: ${migracoesParaMostrar.length}
Total de Registos: ${registosParaMostrar.length}
Total de Contratos: ${contratosParaMostrar.length}

=== RESUMO FINANCEIRO ===
Valor Total Honorários: €${(Math.round(valorTotalHonorarios * 100) / 100).toFixed(2)}
Valor Total Heranças: €${(Math.round(valorTotalHerancas * 100) / 100).toFixed(2)}
Valor Total Migrações: €${(Math.round(valorTotalMigracoes * 100) / 100).toFixed(2)}
Valor Total Registos: €${(Math.round(valorTotalRegistos * 100) / 100).toFixed(2)}
Valor Total Contratos: €${(Math.round(valorTotalContratos * 100) / 100).toFixed(2)}
VALOR TOTAL GERAL: €${(Math.round(valorTotalGeral * 100) / 100).toFixed(2)}

=== STATUS DOS HONORÁRIOS ===
Pagos: ${honorariosParaMostrar.filter(h => h.status === 'pago').length}
Pendentes: ${honorariosParaMostrar.filter(h => h.status === 'pendente').length}
Vencidos: ${honorariosParaMostrar.filter(h => {
                if (!h.vencimento) return false;
                const dataVencimento = new Date(h.vencimento);
                const hoje = new Date();
                return dataVencimento < hoje && h.status === 'pendente';
            }).length}

=== PRAZOS PRÓXIMOS (7 dias) ===
${prazos.filter(p => {
                if (!p.dataLimite) return false;
                const dataLimite = new Date(p.dataLimite);
                const hoje = new Date();
                const diferencaDias = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));
                return diferencaDias <= 7 && diferencaDias >= 0 && p.status === 'ativo';
            }).map(p => `- ${p.descricao} (${p.clienteNome}) - ${p.tipo} - ${Math.ceil((new Date(p.dataLimite) - new Date()) / (1000 * 60 * 60 * 24))} dias`).join('\n') || 'Nenhum prazo próximo'}

=== TOP 5 CLIENTES POR VALOR ===
${clientesParaMostrar.map(cliente => {
                const valorCliente = honorariosParaMostrar
                    .filter(h => h.clienteId === cliente.id)
                    .reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
                return { ...cliente, valorTotal: valorCliente };
            }).sort((a, b) => b.valorTotal - a.valorTotal).slice(0, 5).map((cliente, index) => 
                `${index + 1}. ${cliente.nome} - €${(Math.round(cliente.valorTotal * 100) / 100).toFixed(2)}`
            ).join('\n')}

=== RELATÓRIO GERADO AUTOMATICAMENTE ===
Sistema Legal - ANA PAULA MEDINA
            `;
            
            // Criar e baixar arquivo
            const blob = new Blob([relatorio], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `relatorio_completo_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('Relatório completo gerado com sucesso!', 'success');
        }

        // NOVA FUNÇÃO: Relatório personalizado por cliente
        function gerarRelatorioCliente() {
            console.log('🔧 Gerando relatório personalizado por cliente...');
            
            // Verificar se já existe um modal aberto
            const modalExistente = document.querySelector('.modal');
            if (modalExistente) {
                console.log('⚠️ Modal já existe, removendo...');
                modalExistente.remove();
            }
            
            // Verificar se há clientes
            if (!clientes || clientes.length === 0) {
                mostrarNotificacao('Nenhum cliente encontrado para gerar relatório!', 'warning');
                return;
            }
            
            console.log('✅ Clientes encontrados:', clientes.length);
            
            // Criar modal para seleção de cliente
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background-color: rgba(0, 0, 0, 0.7) !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 99999 !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                ">
                    <div class="modal-header" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid #e5e7eb;
                    ">
                        <h3 style="margin: 0; color: #1f2937;">📊 Relatório Personalizado por Cliente</h3>
                        <button class="close-btn" onclick="fecharModalDIRETO()" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #6b7280;
                        ">&times;</button>
                    </div>
                    <div class="modal-body" style="margin-bottom: 20px;">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="clienteSelecionado" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Selecione o Cliente:</label>
                            <select id="clienteSelecionado" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="">-- Escolha um cliente --</option>
                                ${clientes.map(cliente => 
                                    `<option value="${cliente.nome}">${cliente.nome} (${cliente.email})</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="tipoRelatorio" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Tipo de Relatório:</label>
                            <select id="tipoRelatorio" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="completo">Relatório Completo</option>
                                <option value="honorarios">Apenas Honorários</option>
                                <option value="contratos">Apenas Contratos</option>
                                <option value="herancas">Apenas Heranças</option>
                                <option value="migracoes">Apenas Migrações</option>
                                <option value="registos">Apenas Registos</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="periodoRelatorio" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Período:</label>
                            <select id="periodoRelatorio" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="todos">Todos os dados</option>
                                <option value="mes">Último mês</option>
                                <option value="trimestre">Último trimestre</option>
                                <option value="ano">Último ano</option>
                                <option value="personalizado">Período personalizado</option>
                            </select>
                        </div>
                        <div id="periodoPersonalizado" class="form-group" style="display: none; margin-bottom: 15px;">
                            <label for="dataInicio" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de Início:</label>
                            <input type="date" id="dataInicio" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                                margin-bottom: 10px;
                            ">
                            <label for="dataFim" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de Fim:</label>
                            <input type="date" id="dataFim" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                        </div>
                    </div>
                    <div class="modal-footer" style="
                        display: flex;
                        justify-content: flex-end;
                        gap: 10px;
                        padding-top: 15px;
                        border-top: 1px solid #e5e7eb;
                    ">
                        <button class="btn btn-secondary" onclick="fecharModalDIRETO()" style="
                            padding: 8px 16px;
                            background-color: #6b7280;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                        ">Cancelar</button>
                        <button class="btn btn-primary" onclick="gerarRelatorioClienteSelecionado()" style="
                            padding: 8px 16px;
                            background-color: #3b82f6;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            display: flex;
                            align-items: center;
                            gap: 5px;
                        ">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Gerar Relatório
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('✅ Modal criado e adicionado ao DOM');
            
            // Verificar se o modal foi criado corretamente
            setTimeout(() => {
                const modalTeste = document.querySelector('.modal');
                if (modalTeste) {
                    console.log('✅ Modal encontrado no DOM');
                    // Forçar visibilidade do modal
                    modalTeste.style.display = 'flex';
                    modalTeste.style.visibility = 'visible';
                    modalTeste.style.opacity = '1';
                    console.log('✅ Modal forçado a ser visível');
                } else {
                    console.log('❌ Modal não encontrado no DOM');
                }
            }, 100);
            
            // Event listener para período personalizado
            setTimeout(() => {
                const periodoSelect = document.getElementById('periodoRelatorio');
                if (periodoSelect) {
                    periodoSelect.addEventListener('change', function() {
                        const periodoPersonalizado = document.getElementById('periodoPersonalizado');
                        if (this.value === 'personalizado') {
                            periodoPersonalizado.style.display = 'block';
                        } else {
                            periodoPersonalizado.style.display = 'none';
                        }
                    });
                    console.log('✅ Event listener adicionado');
                } else {
                    console.log('❌ Elemento periodoRelatorio não encontrado');
                }
            }, 100);
        }

        function gerarRelatorioClienteSelecionado() {
            console.log('🔧 Iniciando geração de relatório...');
            
            const clienteSelecionado = document.getElementById('clienteSelecionado').value;
            const tipoRelatorio = document.getElementById('tipoRelatorio').value;
            const periodoRelatorio = document.getElementById('periodoRelatorio').value;
            
            console.log('📊 Dados selecionados:', {
                cliente: clienteSelecionado,
                tipo: tipoRelatorio,
                periodo: periodoRelatorio
            });
            
            if (!clienteSelecionado) {
                mostrarNotificacao('Por favor, selecione um cliente!', 'warning');
                return;
            }
            
            console.log('🔧 Gerando relatório para cliente:', clienteSelecionado);
            
            // Filtrar dados por cliente
            const dadosCliente = {
                honorarios: honorarios ? honorarios.filter(h => h.cliente === clienteSelecionado) : [],
                contratos: contratos ? contratos.filter(c => c.cliente === clienteSelecionado) : [],
                herancas: herancas ? herancas.filter(h => h.cliente === clienteSelecionado) : [],
                migracoes: migracoes ? migracoes.filter(m => m.cliente === clienteSelecionado) : [],
                registos: registos ? registos.filter(r => r.cliente === clienteSelecionado) : []
            };
            
            // Aplicar filtro de período se necessário
            if (periodoRelatorio !== 'todos') {
                const agora = new Date();
                let dataLimite = new Date();
                
                switch (periodoRelatorio) {
                    case 'mes':
                        dataLimite.setMonth(agora.getMonth() - 1);
                        break;
                    case 'trimestre':
                        dataLimite.setMonth(agora.getMonth() - 3);
                        break;
                    case 'ano':
                        dataLimite.setFullYear(agora.getFullYear() - 1);
                        break;
                    case 'personalizado':
                        const dataInicio = document.getElementById('dataInicio').value;
                        const dataFim = document.getElementById('dataFim').value;
                        if (!dataInicio || !dataFim) {
                            mostrarNotificacao('Por favor, selecione as datas do período personalizado!', 'warning');
                            return;
                        }
                        // Aplicar filtro personalizado
                        Object.keys(dadosCliente).forEach(tipo => {
                            dadosCliente[tipo] = dadosCliente[tipo].filter(item => {
                                const dataItem = new Date(item.data);
                                return dataItem >= new Date(dataInicio) && dataItem <= new Date(dataFim);
                            });
                        });
                        break;
                }
                
                if (periodoRelatorio !== 'personalizado') {
                    Object.keys(dadosCliente).forEach(tipo => {
                        dadosCliente[tipo] = dadosCliente[tipo].filter(item => {
                            const dataItem = new Date(item.data);
                            return dataItem >= dataLimite;
                        });
                    });
                }
            }
            
            // Gerar relatório
            let relatorio = `RELATÓRIO PERSONALIZADO - ${clienteSelecionado.toUpperCase()}\n`;
            relatorio += '==========================================\n\n';
            relatorio += `Cliente: ${clienteSelecionado}\n`;
            relatorio += `Data: ${new Date().toLocaleDateString('pt-PT')}\n`;
            relatorio += `Hora: ${new Date().toLocaleTimeString('pt-PT')}\n`;
            relatorio += `Tipo: ${tipoRelatorio.toUpperCase()}\n`;
            relatorio += `Período: ${periodoRelatorio.toUpperCase()}\n\n`;
            
            // Adicionar seções baseadas no tipo de relatório
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'honorarios') {
                relatorio += 'HONORÁRIOS:\n';
                relatorio += '-----------\n';
                if (dadosCliente.honorarios.length > 0) {
                    let totalHonorarios = 0;
                    dadosCliente.honorarios.forEach((honorario, index) => {
                        relatorio += `${index + 1}. ${honorario.descricao}\n`;
                        relatorio += `   Valor: €${honorario.valor}\n`;
                        relatorio += `   Status: ${honorario.status}\n`;
                        relatorio += `   Data: ${honorario.data}\n\n`;
                        totalHonorarios += parseFloat(honorario.valor) || 0;
                    });
                    relatorio += `TOTAL HONORÁRIOS: €${totalHonorarios.toFixed(2)}\n\n`;
                } else {
                    relatorio += 'Nenhum honorário encontrado.\n\n';
                }
            }
            
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'contratos') {
                relatorio += 'CONTRATOS:\n';
                relatorio += '----------\n';
                if (dadosCliente.contratos.length > 0) {
                    dadosCliente.contratos.forEach((contrato, index) => {
                        relatorio += `${index + 1}. ${contrato.tipo}\n`;
                        relatorio += `   Valor: €${contrato.valor}\n`;
                        relatorio += `   Status: ${contrato.status}\n`;
                        relatorio += `   Data: ${contrato.data}\n\n`;
                    });
                } else {
                    relatorio += 'Nenhum contrato encontrado.\n\n';
                }
            }
            
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'herancas') {
                relatorio += 'HERANÇAS:\n';
                relatorio += '---------\n';
                if (dadosCliente.herancas.length > 0) {
                    dadosCliente.herancas.forEach((heranca, index) => {
                        relatorio += `${index + 1}. ${heranca.tipo}\n`;
                        relatorio += `   Valor: €${heranca.valor}\n`;
                        relatorio += `   Status: ${heranca.status}\n`;
                        relatorio += `   Data: ${heranca.data}\n\n`;
                    });
                } else {
                    relatorio += 'Nenhuma herança encontrada.\n\n';
                }
            }
            
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'migracoes') {
                relatorio += 'MIGRAÇÕES:\n';
                relatorio += '----------\n';
                if (dadosCliente.migracoes.length > 0) {
                    dadosCliente.migracoes.forEach((migracao, index) => {
                        relatorio += `${index + 1}. ${migracao.tipo}\n`;
                        relatorio += `   Valor: €${migracao.valor}\n`;
                        relatorio += `   Status: ${migracao.status}\n`;
                        relatorio += `   Data: ${migracao.data}\n\n`;
                    });
                } else {
                    relatorio += 'Nenhuma migração encontrada.\n\n';
                }
            }
            
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'registos') {
                relatorio += 'REGISTOS:\n';
                relatorio += '---------\n';
                if (dadosCliente.registos.length > 0) {
                    dadosCliente.registos.forEach((registo, index) => {
                        relatorio += `${index + 1}. ${registo.tipo}\n`;
                        relatorio += `   Valor: €${registo.valor}\n`;
                        relatorio += `   Status: ${registo.status}\n`;
                        relatorio += `   Data: ${registo.data}\n\n`;
                    });
                } else {
                    relatorio += 'Nenhum registo encontrado.\n\n';
                }
            }
            
            relatorio += '==========================================\n';
            relatorio += 'Relatório personalizado gerado automaticamente\n';
            relatorio += 'Sistema Legal - Gestão Jurídica\n';
            
            // Download do relatório
            const blob = new Blob([relatorio], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_${clienteSelecionado.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            // Fechar modal - SOLUÇÃO ROBUSTA
            setTimeout(() => {
                // Tentar múltiplas formas de fechar o modal
                const modal = document.querySelector('.modal');
                if (modal) {
                    modal.remove();
                    console.log('✅ Modal de relatório cliente fechado (método 1)');
                }
                
                // Tentar fechar todos os modais
                const todosModais = document.querySelectorAll('.modal');
                todosModais.forEach(modal => {
                    modal.remove();
                    console.log('✅ Modal removido (método 2)');
                });
                
                // Tentar fechar por classe
                const modaisPorClasse = document.querySelectorAll('[class*="modal"]');
                modaisPorClasse.forEach(modal => {
                    modal.remove();
                    console.log('✅ Modal removido por classe (método 3)');
                });
                
                // Forçar fechamento
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' && div.style.zIndex === '99999') {
                        div.remove();
                        console.log('✅ Modal removido por estilo (método 4)');
                    }
                });
                
                console.log('✅ Todos os métodos de fechamento executados');
            }, 100);
            
            mostrarNotificacao(`Relatório personalizado para ${clienteSelecionado} gerado com sucesso!`, 'success');
        }

        // NOVA FUNÇÃO: Relatório financeiro personalizado por cliente
        function gerarRelatorioFinanceiroCliente() {
            console.log('🔧 Gerando relatório financeiro personalizado por cliente...');
            
            // Verificar se já existe um modal aberto
            const modalExistente = document.querySelector('.modal');
            if (modalExistente) {
                console.log('⚠️ Modal já existe, removendo...');
                modalExistente.remove();
            }
            
            // Verificar se há clientes
            if (!clientes || clientes.length === 0) {
                mostrarNotificacao('Nenhum cliente encontrado para gerar relatório!', 'warning');
                return;
            }
            
            console.log('✅ Clientes encontrados:', clientes.length);
            
            // Criar modal para seleção de cliente
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background-color: rgba(0, 0, 0, 0.7) !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 99999 !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                ">
                    <div class="modal-header" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid #e5e7eb;
                    ">
                        <h3 style="margin: 0; color: #1f2937;">💰 Relatório Financeiro Personalizado</h3>
                        <button class="close-btn" onclick="fecharModalDIRETO()" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #6b7280;
                        ">&times;</button>
                    </div>
                    <div class="modal-body" style="margin-bottom: 20px;">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="clienteFinanceiroSelecionado" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Selecione o Cliente:</label>
                            <select id="clienteFinanceiroSelecionado" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="">-- Escolha um cliente --</option>
                                ${clientes.map(cliente => 
                                    `<option value="${cliente.nome}">${cliente.nome} (${cliente.email})</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="tipoRelatorioFinanceiro" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Tipo de Relatório Financeiro:</label>
                            <select id="tipoRelatorioFinanceiro" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="completo">Relatório Financeiro Completo</option>
                                <option value="honorarios">Apenas Honorários</option>
                                <option value="receitas">Apenas Receitas</option>
                                <option value="pendentes">Apenas Pendentes</option>
                                <option value="pagos">Apenas Pagos</option>
                                <option value="vencidos">Apenas Vencidos</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="periodoRelatorioFinanceiro" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Período:</label>
                            <select id="periodoRelatorioFinanceiro" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="todos">Todos os dados</option>
                                <option value="mes">Último mês</option>
                                <option value="trimestre">Último trimestre</option>
                                <option value="ano">Último ano</option>
                                <option value="personalizado">Período personalizado</option>
                            </select>
                        </div>
                        <div id="periodoPersonalizadoFinanceiro" class="form-group" style="display: none; margin-bottom: 15px;">
                            <label for="dataInicioFinanceiro" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de Início:</label>
                            <input type="date" id="dataInicioFinanceiro" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                                margin-bottom: 10px;
                            ">
                            <label for="dataFimFinanceiro" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de Fim:</label>
                            <input type="date" id="dataFimFinanceiro" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                        </div>
                    </div>
                    <div class="modal-footer" style="
                        display: flex;
                        justify-content: flex-end;
                        gap: 10px;
                        padding-top: 15px;
                        border-top: 1px solid #e5e7eb;
                    ">
                        <button class="btn btn-secondary" onclick="fecharModalDIRETO()" style="
                            padding: 8px 16px;
                            background-color: #6b7280;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                        ">Cancelar</button>
                        <button class="btn btn-primary" onclick="gerarRelatorioFinanceiroClienteSelecionado()" style="
                            padding: 8px 16px;
                            background-color: #10b981;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            display: flex;
                            align-items: center;
                            gap: 5px;
                        ">
                            <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                            Gerar Relatório
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('✅ Modal financeiro criado e adicionado ao DOM');
            
            // Verificar se o modal foi criado corretamente
            setTimeout(() => {
                const modalTeste = document.querySelector('.modal');
                if (modalTeste) {
                    console.log('✅ Modal financeiro encontrado no DOM');
                    // Forçar visibilidade do modal
                    modalTeste.style.display = 'flex';
                    modalTeste.style.visibility = 'visible';
                    modalTeste.style.opacity = '1';
                    console.log('✅ Modal financeiro forçado a ser visível');
                } else {
                    console.log('❌ Modal financeiro não encontrado no DOM');
                }
            }, 100);
            
            // Event listener para período personalizado
            setTimeout(() => {
                const periodoSelect = document.getElementById('periodoRelatorioFinanceiro');
                if (periodoSelect) {
                    periodoSelect.addEventListener('change', function() {
                        const periodoPersonalizado = document.getElementById('periodoPersonalizadoFinanceiro');
                        if (this.value === 'personalizado') {
                            periodoPersonalizado.style.display = 'block';
                        } else {
                            periodoPersonalizado.style.display = 'none';
                        }
                    });
                    console.log('✅ Event listener financeiro adicionado');
                } else {
                    console.log('❌ Elemento periodoRelatorioFinanceiro não encontrado');
                }
            }, 100);
        }

        function gerarRelatorioFinanceiroClienteSelecionado() {
            console.log('🔧 Iniciando geração de relatório financeiro...');
            
            const clienteSelecionado = document.getElementById('clienteFinanceiroSelecionado').value;
            const tipoRelatorio = document.getElementById('tipoRelatorioFinanceiro').value;
            const periodoRelatorio = document.getElementById('periodoRelatorioFinanceiro').value;
            
            console.log('💰 Dados financeiros selecionados:', {
                cliente: clienteSelecionado,
                tipo: tipoRelatorio,
                periodo: periodoRelatorio
            });
            
            if (!clienteSelecionado) {
                mostrarNotificacao('Por favor, selecione um cliente!', 'warning');
                return;
            }
            
            console.log('🔧 Gerando relatório financeiro para cliente:', clienteSelecionado);
            
            // Filtrar dados financeiros por cliente
            const dadosFinanceiros = {
                honorarios: honorarios ? honorarios.filter(h => h.cliente === clienteSelecionado) : [],
                contratos: contratos ? contratos.filter(c => c.cliente === clienteSelecionado) : [],
                herancas: herancas ? herancas.filter(h => h.cliente === clienteSelecionado) : [],
                migracoes: migracoes ? migracoes.filter(m => m.cliente === clienteSelecionado) : [],
                registos: registos ? registos.filter(r => r.cliente === clienteSelecionado) : []
            };
            
            // Aplicar filtro de período se necessário
            if (periodoRelatorio !== 'todos') {
                const agora = new Date();
                let dataLimite = new Date();
                
                switch (periodoRelatorio) {
                    case 'mes':
                        dataLimite.setMonth(agora.getMonth() - 1);
                        break;
                    case 'trimestre':
                        dataLimite.setMonth(agora.getMonth() - 3);
                        break;
                    case 'ano':
                        dataLimite.setFullYear(agora.getFullYear() - 1);
                        break;
                    case 'personalizado':
                        const dataInicio = document.getElementById('dataInicioFinanceiro').value;
                        const dataFim = document.getElementById('dataFimFinanceiro').value;
                        if (!dataInicio || !dataFim) {
                            mostrarNotificacao('Por favor, selecione as datas do período personalizado!', 'warning');
                            return;
                        }
                        // Aplicar filtro personalizado
                        Object.keys(dadosFinanceiros).forEach(tipo => {
                            dadosFinanceiros[tipo] = dadosFinanceiros[tipo].filter(item => {
                                const dataItem = new Date(item.data);
                                return dataItem >= new Date(dataInicio) && dataItem <= new Date(dataFim);
                            });
                        });
                        break;
                }
                
                if (periodoRelatorio !== 'personalizado') {
                    Object.keys(dadosFinanceiros).forEach(tipo => {
                        dadosFinanceiros[tipo] = dadosFinanceiros[tipo].filter(item => {
                            const dataItem = new Date(item.data);
                            return dataItem >= dataLimite;
                        });
                    });
                }
            }
            
            // Calcular totais financeiros
            let totalHonorarios = 0;
            let totalContratos = 0;
            let totalHerancas = 0;
            let totalMigracoes = 0;
            let totalRegistos = 0;
            
            dadosFinanceiros.honorarios.forEach(h => totalHonorarios += parseFloat(h.valor) || 0);
            dadosFinanceiros.contratos.forEach(c => totalContratos += parseFloat(c.valor) || 0);
            dadosFinanceiros.herancas.forEach(h => totalHerancas += parseFloat(h.valor) || 0);
            dadosFinanceiros.migracoes.forEach(m => totalMigracoes += parseFloat(m.valor) || 0);
            dadosFinanceiros.registos.forEach(r => totalRegistos += parseFloat(r.valor) || 0);
            
            const totalGeral = totalHonorarios + totalContratos + totalHerancas + totalMigracoes + totalRegistos;
            
            // Gerar relatório financeiro
            let relatorio = `RELATÓRIO FINANCEIRO PERSONALIZADO - ${clienteSelecionado.toUpperCase()}\n`;
            relatorio += '==================================================\n\n';
            relatorio += `Cliente: ${clienteSelecionado}\n`;
            relatorio += `Data: ${new Date().toLocaleDateString('pt-PT')}\n`;
            relatorio += `Hora: ${new Date().toLocaleTimeString('pt-PT')}\n`;
            relatorio += `Tipo: ${tipoRelatorio.toUpperCase()}\n`;
            relatorio += `Período: ${periodoRelatorio.toUpperCase()}\n\n`;
            
            // Resumo financeiro
            relatorio += 'RESUMO FINANCEIRO:\n';
            relatorio += '==================\n';
            relatorio += `Total Geral: €${totalGeral.toFixed(2)}\n`;
            relatorio += `Honorários: €${totalHonorarios.toFixed(2)}\n`;
            relatorio += `Contratos: €${totalContratos.toFixed(2)}\n`;
            relatorio += `Heranças: €${totalHerancas.toFixed(2)}\n`;
            relatorio += `Migrações: €${totalMigracoes.toFixed(2)}\n`;
            relatorio += `Registos: €${totalRegistos.toFixed(2)}\n\n`;
            
            // Adicionar seções baseadas no tipo de relatório
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'honorarios') {
                relatorio += 'HONORÁRIOS:\n';
                relatorio += '-----------\n';
                if (dadosFinanceiros.honorarios.length > 0) {
                    let totalHonorariosCliente = 0;
                    dadosFinanceiros.honorarios.forEach((honorario, index) => {
                        relatorio += `${index + 1}. ${honorario.descricao || honorario.servico}\n`;
                        relatorio += `   Valor: €${honorario.valor}\n`;
                        relatorio += `   Status: ${honorario.status}\n`;
                        relatorio += `   Data: ${honorario.data}\n`;
                        if (honorario.vencimento) {
                            relatorio += `   Vencimento: ${honorario.vencimento}\n`;
                        }
                        relatorio += `\n`;
                        totalHonorariosCliente += parseFloat(honorario.valor) || 0;
                    });
                    relatorio += `TOTAL HONORÁRIOS: €${totalHonorariosCliente.toFixed(2)}\n\n`;
                } else {
                    relatorio += 'Nenhum honorário encontrado.\n\n';
                }
            }
            
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'receitas') {
                relatorio += 'RECEITAS (Contratos, Heranças, Migrações, Registos):\n';
                relatorio += '==================================================\n';
                
                if (dadosFinanceiros.contratos.length > 0) {
                    relatorio += 'CONTRATOS:\n';
                    dadosFinanceiros.contratos.forEach((contrato, index) => {
                        relatorio += `${index + 1}. ${contrato.tipo}\n`;
                        relatorio += `   Valor: €${contrato.valor}\n`;
                        relatorio += `   Status: ${contrato.status}\n`;
                        relatorio += `   Data: ${contrato.data}\n\n`;
                    });
                }
                
                if (dadosFinanceiros.herancas.length > 0) {
                    relatorio += 'HERANÇAS:\n';
                    dadosFinanceiros.herancas.forEach((heranca, index) => {
                        relatorio += `${index + 1}. ${heranca.tipo}\n`;
                        relatorio += `   Valor: €${heranca.valor}\n`;
                        relatorio += `   Status: ${heranca.status}\n`;
                        relatorio += `   Data: ${heranca.data}\n\n`;
                    });
                }
                
                if (dadosFinanceiros.migracoes.length > 0) {
                    relatorio += 'MIGRAÇÕES:\n';
                    dadosFinanceiros.migracoes.forEach((migracao, index) => {
                        relatorio += `${index + 1}. ${migracao.tipo}\n`;
                        relatorio += `   Valor: €${migracao.valor}\n`;
                        relatorio += `   Status: ${migracao.status}\n`;
                        relatorio += `   Data: ${migracao.data}\n\n`;
                    });
                }
                
                if (dadosFinanceiros.registos.length > 0) {
                    relatorio += 'REGISTOS:\n';
                    dadosFinanceiros.registos.forEach((registo, index) => {
                        relatorio += `${index + 1}. ${registo.tipo}\n`;
                        relatorio += `   Valor: €${registo.valor}\n`;
                        relatorio += `   Status: ${registo.status}\n`;
                        relatorio += `   Data: ${registo.data}\n\n`;
                    });
                }
            }
            
            // Análise por status
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'pendentes' || tipoRelatorio === 'pagos' || tipoRelatorio === 'vencidos') {
                relatorio += 'ANÁLISE POR STATUS:\n';
                relatorio += '==================\n';
                
                const honorariosPendentes = dadosFinanceiros.honorarios.filter(h => h.status === 'pendente');
                const honorariosPagos = dadosFinanceiros.honorarios.filter(h => h.status === 'pago');
                const honorariosVencidos = dadosFinanceiros.honorarios.filter(h => h.status === 'vencido');
                
                relatorio += `Honorários Pendentes: ${honorariosPendentes.length} (€${honorariosPendentes.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0).toFixed(2)})\n`;
                relatorio += `Honorários Pagos: ${honorariosPagos.length} (€${honorariosPagos.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0).toFixed(2)})\n`;
                relatorio += `Honorários Vencidos: ${honorariosVencidos.length} (€${honorariosVencidos.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0).toFixed(2)})\n\n`;
            }
            
            relatorio += '==================================================\n';
            relatorio += 'Relatório financeiro personalizado gerado automaticamente\n';
            relatorio += 'Sistema Legal - Gestão Jurídica\n';
            
            // Download do relatório
            const blob = new Blob([relatorio], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_financeiro_${clienteSelecionado.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            // Fechar modal - SOLUÇÃO ROBUSTA
            setTimeout(() => {
                // Tentar múltiplas formas de fechar o modal
                const modal = document.querySelector('.modal');
                if (modal) {
                    modal.remove();
                    console.log('✅ Modal de relatório financeiro fechado (método 1)');
                }
                
                // Tentar fechar todos os modais
                const todosModais = document.querySelectorAll('.modal');
                todosModais.forEach(modal => {
                    modal.remove();
                    console.log('✅ Modal removido (método 2)');
                });
                
                // Tentar fechar por classe
                const modaisPorClasse = document.querySelectorAll('[class*="modal"]');
                modaisPorClasse.forEach(modal => {
                    modal.remove();
                    console.log('✅ Modal removido por classe (método 3)');
                });
                
                // Forçar fechamento
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' && div.style.zIndex === '99999') {
                        div.remove();
                        console.log('✅ Modal removido por estilo (método 4)');
                    }
                });
                
                console.log('✅ Todos os métodos de fechamento executados');
            }, 100);
            
            mostrarNotificacao(`Relatório financeiro personalizado para ${clienteSelecionado} gerado com sucesso!`, 'success');
        }

        // NOVA FUNÇÃO: Relatório geral personalizado por cliente
        function gerarRelatorioGeralCliente() {
            console.log('🔧 Gerando relatório geral personalizado por cliente...');
            
            // Verificar se já existe um modal aberto
            const modalExistente = document.querySelector('.modal');
            if (modalExistente) {
                console.log('⚠️ Modal já existe, removendo...');
                modalExistente.remove();
            }
            
            // Verificar se há clientes
            if (!clientes || clientes.length === 0) {
                mostrarNotificacao('Nenhum cliente encontrado para gerar relatório!', 'warning');
                return;
            }
            
            console.log('✅ Clientes encontrados:', clientes.length);
            
            // Criar modal para seleção de cliente
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background-color: rgba(0, 0, 0, 0.7) !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 99999 !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                ">
                    <div class="modal-header" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid #e5e7eb;
                    ">
                        <h3 style="margin: 0; color: #1f2937;">📊 Relatório Geral Personalizado</h3>
                        <button class="close-btn" onclick="fecharModalDIRETO()" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #6b7280;
                        ">&times;</button>
                    </div>
                    <div class="modal-body" style="margin-bottom: 20px;">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="clienteGeralSelecionado" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Selecione o Cliente:</label>
                            <select id="clienteGeralSelecionado" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="">-- Escolha um cliente --</option>
                                ${clientes.map(cliente => 
                                    `<option value="${cliente.nome}">${cliente.nome} (${cliente.email})</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="tipoRelatorioGeral" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Tipo de Relatório Geral:</label>
                            <select id="tipoRelatorioGeral" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="completo">Relatório Geral Completo</option>
                                <option value="dados_pessoais">Apenas Dados Pessoais</option>
                                <option value="honorarios">Apenas Honorários</option>
                                <option value="contratos">Apenas Contratos</option>
                                <option value="herancas">Apenas Heranças</option>
                                <option value="migracoes">Apenas Migrações</option>
                                <option value="registos">Apenas Registos</option>
                                <option value="documentos">Apenas Documentos</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="periodoRelatorioGeral" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Período:</label>
                            <select id="periodoRelatorioGeral" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <option value="todos">Todos os dados</option>
                                <option value="mes">Último mês</option>
                                <option value="trimestre">Último trimestre</option>
                                <option value="ano">Último ano</option>
                                <option value="personalizado">Período personalizado</option>
                            </select>
                        </div>
                        <div id="periodoPersonalizadoGeral" class="form-group" style="display: none; margin-bottom: 15px;">
                            <label for="dataInicioGeral" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de Início:</label>
                            <input type="date" id="dataInicioGeral" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                                margin-bottom: 10px;
                            ">
                            <label for="dataFimGeral" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de Fim:</label>
                            <input type="date" id="dataFimGeral" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                        </div>
                    </div>
                    <div class="modal-footer" style="
                        display: flex;
                        justify-content: flex-end;
                        gap: 10px;
                        padding-top: 15px;
                        border-top: 1px solid #e5e7eb;
                    ">
                        <button class="btn btn-secondary" onclick="fecharModalDIRETO()" style="
                            padding: 8px 16px;
                            background-color: #6b7280;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                        ">Cancelar</button>
                        <button class="btn btn-primary" onclick="gerarRelatorioGeralClienteSelecionado()" style="
                            padding: 8px 16px;
                            background-color: #6366f1;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            display: flex;
                            align-items: center;
                            gap: 5px;
                        ">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                            Gerar Relatório
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('✅ Modal geral criado e adicionado ao DOM');
            
            // Verificar se o modal foi criado corretamente
            setTimeout(() => {
                const modalTeste = document.querySelector('.modal');
                if (modalTeste) {
                    console.log('✅ Modal geral encontrado no DOM');
                    // Forçar visibilidade do modal
                    modalTeste.style.display = 'flex';
                    modalTeste.style.visibility = 'visible';
                    modalTeste.style.opacity = '1';
                    console.log('✅ Modal geral forçado a ser visível');
                } else {
                    console.log('❌ Modal geral não encontrado no DOM');
                }
            }, 100);
            
            // Event listener para período personalizado
            setTimeout(() => {
                const periodoSelect = document.getElementById('periodoRelatorioGeral');
                if (periodoSelect) {
                    periodoSelect.addEventListener('change', function() {
                        const periodoPersonalizado = document.getElementById('periodoPersonalizadoGeral');
                        if (this.value === 'personalizado') {
                            periodoPersonalizado.style.display = 'block';
                        } else {
                            periodoPersonalizado.style.display = 'none';
                        }
                    });
                    console.log('✅ Event listener geral adicionado');
                } else {
                    console.log('❌ Elemento periodoRelatorioGeral não encontrado');
                }
            }, 100);
        }

        function gerarRelatorioGeralClienteSelecionado() {
            console.log('🔧 Iniciando geração de relatório geral...');
            
            const clienteSelecionado = document.getElementById('clienteGeralSelecionado').value;
            const tipoRelatorio = document.getElementById('tipoRelatorioGeral').value;
            const periodoRelatorio = document.getElementById('periodoRelatorioGeral').value;
            
            console.log('📊 Dados gerais selecionados:', {
                cliente: clienteSelecionado,
                tipo: tipoRelatorio,
                periodo: periodoRelatorio
            });
            
            if (!clienteSelecionado) {
                mostrarNotificacao('Por favor, selecione um cliente!', 'warning');
                return;
            }
            
            console.log('🔧 Gerando relatório geral para cliente:', clienteSelecionado);
            
            // Filtrar dados gerais por cliente
            const dadosGeral = {
                honorarios: honorarios ? honorarios.filter(h => h.cliente === clienteSelecionado) : [],
                contratos: contratos ? contratos.filter(c => c.cliente === clienteSelecionado) : [],
                herancas: herancas ? herancas.filter(h => h.cliente === clienteSelecionado) : [],
                migracoes: migracoes ? migracoes.filter(m => m.cliente === clienteSelecionado) : [],
                registos: registos ? registos.filter(r => r.cliente === clienteSelecionado) : []
            };
            
            // Encontrar dados do cliente
            const cliente = clientes.find(c => c.nome === clienteSelecionado);
            
            // Aplicar filtro de período se necessário
            if (periodoRelatorio !== 'todos') {
                const agora = new Date();
                let dataLimite = new Date();
                
                switch (periodoRelatorio) {
                    case 'mes':
                        dataLimite.setMonth(agora.getMonth() - 1);
                        break;
                    case 'trimestre':
                        dataLimite.setMonth(agora.getMonth() - 3);
                        break;
                    case 'ano':
                        dataLimite.setFullYear(agora.getFullYear() - 1);
                        break;
                    case 'personalizado':
                        const dataInicio = document.getElementById('dataInicioGeral').value;
                        const dataFim = document.getElementById('dataFimGeral').value;
                        if (!dataInicio || !dataFim) {
                            mostrarNotificacao('Por favor, selecione as datas do período personalizado!', 'warning');
                            return;
                        }
                        // Aplicar filtro personalizado
                        Object.keys(dadosGeral).forEach(tipo => {
                            dadosGeral[tipo] = dadosGeral[tipo].filter(item => {
                                const dataItem = new Date(item.data);
                                return dataItem >= new Date(dataInicio) && dataItem <= new Date(dataFim);
                            });
                        });
                        break;
                }
                
                if (periodoRelatorio !== 'personalizado') {
                    Object.keys(dadosGeral).forEach(tipo => {
                        dadosGeral[tipo] = dadosGeral[tipo].filter(item => {
                            const dataItem = new Date(item.data);
                            return dataItem >= dataLimite;
                        });
                    });
                }
            }
            
            // Gerar relatório geral
            let relatorio = `RELATÓRIO GERAL PERSONALIZADO - ${clienteSelecionado.toUpperCase()}\n`;
            relatorio += '==================================================\n\n';
            relatorio += `Cliente: ${clienteSelecionado}\n`;
            relatorio += `Data: ${new Date().toLocaleDateString('pt-PT')}\n`;
            relatorio += `Hora: ${new Date().toLocaleTimeString('pt-PT')}\n`;
            relatorio += `Tipo: ${tipoRelatorio.toUpperCase()}\n`;
            relatorio += `Período: ${periodoRelatorio.toUpperCase()}\n\n`;
            
            // Dados pessoais do cliente
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'dados_pessoais') {
                relatorio += 'DADOS PESSOAIS DO CLIENTE:\n';
                relatorio += '==========================\n';
                if (cliente) {
                    relatorio += `Nome: ${cliente.nome}\n`;
                    relatorio += `Email: ${cliente.email}\n`;
                    relatorio += `Telefone: ${cliente.telefone}\n`;
                    relatorio += `NIF: ${cliente.nif}\n`;
                    relatorio += `Data de Registo: ${cliente.data}\n`;
                    if (cliente.endereco) {
                        relatorio += `Endereço: ${cliente.endereco}\n`;
                    }
                    if (cliente.observacoes) {
                        relatorio += `Observações: ${cliente.observacoes}\n`;
                    }
                }
                relatorio += '\n';
            }
            
            // Honorários
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'honorarios') {
                relatorio += 'HONORÁRIOS:\n';
                relatorio += '-----------\n';
                if (dadosGeral.honorarios.length > 0) {
                    let totalHonorarios = 0;
                    dadosGeral.honorarios.forEach((honorario, index) => {
                        relatorio += `${index + 1}. ${honorario.descricao || honorario.servico}\n`;
                        relatorio += `   Valor: €${honorario.valor}\n`;
                        relatorio += `   Status: ${honorario.status}\n`;
                        relatorio += `   Data: ${honorario.data}\n`;
                        if (honorario.vencimento) {
                            relatorio += `   Vencimento: ${honorario.vencimento}\n`;
                        }
                        relatorio += `\n`;
                        totalHonorarios += parseFloat(honorario.valor) || 0;
                    });
                    relatorio += `TOTAL HONORÁRIOS: €${totalHonorarios.toFixed(2)}\n\n`;
                } else {
                    relatorio += 'Nenhum honorário encontrado.\n\n';
                }
            }
            
            // Contratos
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'contratos') {
                relatorio += 'CONTRATOS:\n';
                relatorio += '----------\n';
                if (dadosGeral.contratos.length > 0) {
                    dadosGeral.contratos.forEach((contrato, index) => {
                        relatorio += `${index + 1}. ${contrato.tipo}\n`;
                        relatorio += `   Valor: €${contrato.valor}\n`;
                        relatorio += `   Status: ${contrato.status}\n`;
                        relatorio += `   Data: ${contrato.data}\n\n`;
                    });
                } else {
                    relatorio += 'Nenhum contrato encontrado.\n\n';
                }
            }
            
            // Heranças
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'herancas') {
                relatorio += 'HERANÇAS:\n';
                relatorio += '---------\n';
                if (dadosGeral.herancas.length > 0) {
                    dadosGeral.herancas.forEach((heranca, index) => {
                        relatorio += `${index + 1}. ${heranca.tipo}\n`;
                        relatorio += `   Valor: €${heranca.valor}\n`;
                        relatorio += `   Status: ${heranca.status}\n`;
                        relatorio += `   Data: ${heranca.data}\n\n`;
                    });
                } else {
                    relatorio += 'Nenhuma herança encontrada.\n\n';
                }
            }
            
            // Migrações
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'migracoes') {
                relatorio += 'MIGRAÇÕES:\n';
                relatorio += '----------\n';
                if (dadosGeral.migracoes.length > 0) {
                    dadosGeral.migracoes.forEach((migracao, index) => {
                        relatorio += `${index + 1}. ${migracao.tipo}\n`;
                        relatorio += `   Valor: €${migracao.valor}\n`;
                        relatorio += `   Status: ${migracao.status}\n`;
                        relatorio += `   Data: ${migracao.data}\n\n`;
                    });
                } else {
                    relatorio += 'Nenhuma migração encontrada.\n\n';
                }
            }
            
            // Registos
            if (tipoRelatorio === 'completo' || tipoRelatorio === 'registos') {
                relatorio += 'REGISTOS:\n';
                relatorio += '---------\n';
                if (dadosGeral.registos.length > 0) {
                    dadosGeral.registos.forEach((registo, index) => {
                        relatorio += `${index + 1}. ${registo.tipo}\n`;
                        relatorio += `   Valor: €${registo.valor}\n`;
                        relatorio += `   Status: ${registo.status}\n`;
                        relatorio += `   Data: ${registo.data}\n\n`;
                    });
                } else {
                    relatorio += 'Nenhum registo encontrado.\n\n';
                }
            }
            
            // Resumo estatístico
            if (tipoRelatorio === 'completo') {
                relatorio += 'RESUMO ESTATÍSTICO:\n';
                relatorio += '===================\n';
                relatorio += `Total de Honorários: ${dadosGeral.honorarios.length}\n`;
                relatorio += `Total de Contratos: ${dadosGeral.contratos.length}\n`;
                relatorio += `Total de Heranças: ${dadosGeral.herancas.length}\n`;
                relatorio += `Total de Migrações: ${dadosGeral.migracoes.length}\n`;
                relatorio += `Total de Registos: ${dadosGeral.registos.length}\n\n`;
            }
            
            relatorio += '==================================================\n';
            relatorio += 'Relatório geral personalizado gerado automaticamente\n';
            relatorio += 'Sistema Legal - Gestão Jurídica\n';
            
            // Download do relatório
            const blob = new Blob([relatorio], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_geral_${clienteSelecionado.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            // Fechar modal - SOLUÇÃO ROBUSTA
            setTimeout(() => {
                // Tentar múltiplas formas de fechar o modal
                const modal = document.querySelector('.modal');
                if (modal) {
                    modal.remove();
                    console.log('✅ Modal de relatório geral fechado (método 1)');
                }
                
                // Tentar fechar todos os modais
                const todosModais = document.querySelectorAll('.modal');
                todosModais.forEach(modal => {
                    modal.remove();
                    console.log('✅ Modal removido (método 2)');
                });
                
                // Tentar fechar por classe
                const modaisPorClasse = document.querySelectorAll('[class*="modal"]');
                modaisPorClasse.forEach(modal => {
                    modal.remove();
                    console.log('✅ Modal removido por classe (método 3)');
                });
                
                // Forçar fechamento
                document.querySelectorAll('div').forEach(div => {
                    if (div.style.position === 'fixed' && div.style.zIndex === '99999') {
                        div.remove();
                        console.log('✅ Modal removido por estilo (método 4)');
                    }
                });
                
                console.log('✅ Todos os métodos de fechamento executados');
            }, 100);
            
            mostrarNotificacao(`Relatório geral personalizado para ${clienteSelecionado} gerado com sucesso!`, 'success');
        }

        // NOVA FUNÇÃO: Carregar cliente por bilhete
        function carregarClientePorBilhete() {
            console.log('🔧 Carregando cliente por bilhete...');
            
            // Verificar se já existe um modal aberto
            const modalExistente = document.querySelector('.modal');
            if (modalExistente) {
                console.log('⚠️ Modal já existe, removendo...');
                modalExistente.remove();
            }
            
            // Criar modal para inserir bilhete
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background-color: rgba(0, 0, 0, 0.7) !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 99999 !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                ">
                    <div class="modal-header" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid #e5e7eb;
                    ">
                        <h3 style="margin: 0; color: #1f2937;">🎫 Carregar Cliente por Bilhete</h3>
                        <button class="close-btn" onclick="fecharModalDIRETO()" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #6b7280;
                        ">&times;</button>
                    </div>
                    <div class="modal-body" style="margin-bottom: 20px;">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="bilheteCliente" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Código do Bilhete:</label>
                            <input type="text" id="bilheteCliente" class="form-control" style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                                font-size: 14px;
                                text-transform: uppercase;
                            " placeholder="Ex: BIL1234567890ABC">
                            <p class="text-xs text-gray-500 mt-1">Insira o código do bilhete para carregar as informações do cliente</p>
                        </div>
                    </div>
                    <div class="modal-footer" style="
                        display: flex;
                        justify-content: flex-end;
                        gap: 10px;
                        padding-top: 15px;
                        border-top: 1px solid #e5e7eb;
                    ">
                        <button class="btn btn-secondary" onclick="fecharModalDIRETO()" style="
                            padding: 8px 16px;
                            background-color: #6b7280;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                        ">Cancelar</button>
                        <button class="btn btn-primary" onclick="buscarClientePorBilhete()" style="
                            padding: 8px 16px;
                            background-color: #3b82f6;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            display: flex;
                            align-items: center;
                            gap: 5px;
                        ">
                            <i data-lucide="search" class="w-4 h-4"></i>
                            Carregar Cliente
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('✅ Modal de bilhete criado e adicionado ao DOM');
            
            // Verificar se o modal foi criado corretamente
            setTimeout(() => {
                const modalTeste = document.querySelector('.modal');
                if (modalTeste) {
                    console.log('✅ Modal de bilhete encontrado no DOM');
                    // Forçar visibilidade do modal
                    modalTeste.style.display = 'flex';
                    modalTeste.style.visibility = 'visible';
                    modalTeste.style.opacity = '1';
                    console.log('✅ Modal de bilhete forçado a ser visível');
                } else {
                    console.log('❌ Modal de bilhete não encontrado no DOM');
                }
            }, 100);
        }

        function buscarClientePorBilhete() {
            console.log('🔧 Buscando cliente por bilhete...');
            
            const bilhete = document.getElementById('bilheteCliente').value.trim().toUpperCase();
            
            if (!bilhete) {
                mostrarNotificacao('Por favor, insira o código do bilhete!', 'warning');
                return;
            }
            
            console.log('🎫 Bilhete inserido:', bilhete);
            
            // Buscar cliente pelo bilhete
            const cliente = clientes.find(c => c.bilhete === bilhete);
            
            if (!cliente) {
                mostrarNotificacao('Cliente não encontrado com este bilhete!', 'error');
                return;
            }
            
            console.log('✅ Cliente encontrado:', cliente.nome);
            
            // Fechar modal de busca
            setTimeout(() => {
                fecharModalDIRETO();
            }, 100);
            
            // Mostrar informações completas do cliente (com delay maior)
            setTimeout(() => {
                mostrarInformacoesCompletasCliente(cliente);
            }, 200);
        }

        function mostrarInformacoesCompletasCliente(cliente) {
            console.log('🔧 Mostrando informações completas do cliente:', cliente.nome);
            
            // Verificar se já existe um modal aberto
            const modalExistente = document.querySelector('.modal');
            if (modalExistente) {
                console.log('⚠️ Modal já existe, removendo...');
                modalExistente.remove();
            }
            
            // Buscar todos os dados relacionados ao cliente
            const dadosCliente = {
                honorarios: honorarios ? honorarios.filter(h => h.cliente === cliente.nome) : [],
                contratos: contratos ? contratos.filter(c => c.cliente === cliente.nome) : [],
                herancas: herancas ? herancas.filter(h => h.cliente === cliente.nome) : [],
                migracoes: migracoes ? migracoes.filter(m => m.cliente === cliente.nome) : [],
                registos: registos ? registos.filter(r => r.cliente === cliente.nome) : []
            };
            
            // Criar modal com informações completas
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background-color: rgba(0, 0, 0, 0.7) !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 99999 !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 90%;
                    width: 90%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                ">
                    <div class="modal-header" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid #e5e7eb;
                    ">
                        <h3 style="margin: 0; color: #1f2937;">👤 ${cliente.nome} - Informações Completas</h3>
                        <button class="close-btn" onclick="fecharModalDIRETO()" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #6b7280;
                        ">&times;</button>
                    </div>
                    <div class="modal-body" style="margin-bottom: 20px;">
                        <!-- Dados Pessoais -->
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #3b82f6; padding-bottom: 5px;">📋 Dados Pessoais</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                    <strong>Nome:</strong> ${cliente.nome}
                                </div>
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                                    <strong>Email:</strong> ${cliente.email}
                                </div>
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                    <strong>Telefone:</strong> ${cliente.telefone}
                                </div>
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444;">
                                    <strong>NIF:</strong> ${cliente.nif}
                                </div>
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                                    <strong>Bilhete:</strong> ${cliente.bilhete}
                                </div>
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #06b6d4;">
                                    <strong>Status:</strong> ${cliente.status}
                                </div>
                            </div>
                            ${cliente.endereco ? `
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #6366f1; margin-top: 15px;">
                                    <strong>Endereço:</strong> ${cliente.endereco}
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Resumo Estatístico -->
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #10b981; padding-bottom: 5px;">📊 Resumo Estatístico</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${dadosCliente.honorarios.length}</div>
                                    <div style="font-size: 14px;">Honorários</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${dadosCliente.contratos.length}</div>
                                    <div style="font-size: 14px;">Contratos</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${dadosCliente.herancas.length}</div>
                                    <div style="font-size: 14px;">Heranças</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${dadosCliente.migracoes.length}</div>
                                    <div style="font-size: 14px;">Migrações</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${dadosCliente.registos.length}</div>
                                    <div style="font-size: 14px;">Registos</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Honorários -->
                        ${dadosCliente.honorarios.length > 0 ? `
                            <div style="margin-bottom: 30px;">
                                <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #3b82f6; padding-bottom: 5px;">💰 Honorários (${dadosCliente.honorarios.length})</h4>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${dadosCliente.honorarios.map((honorario, index) => `
                                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #3b82f6;">
                                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                                <div>
                                                    <strong>${honorario.descricao || honorario.servico}</strong><br>
                                                    <span style="color: #6b7280; font-size: 14px;">Valor: €${honorario.valor} | Status: ${honorario.status}</span><br>
                                                    <span style="color: #6b7280; font-size: 12px;">Data: ${honorario.data}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Contratos -->
                        ${dadosCliente.contratos.length > 0 ? `
                            <div style="margin-bottom: 30px;">
                                <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #10b981; padding-bottom: 5px;">📄 Contratos (${dadosCliente.contratos.length})</h4>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${dadosCliente.contratos.map((contrato, index) => `
                                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #10b981;">
                                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                                <div>
                                                    <strong>${contrato.tipo}</strong><br>
                                                    <span style="color: #6b7280; font-size: 14px;">Valor: €${contrato.valor} | Status: ${contrato.status}</span><br>
                                                    <span style="color: #6b7280; font-size: 12px;">Data: ${contrato.data}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Heranças -->
                        ${dadosCliente.herancas.length > 0 ? `
                            <div style="margin-bottom: 30px;">
                                <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #f59e0b; padding-bottom: 5px;">🏛️ Heranças (${dadosCliente.herancas.length})</h4>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${dadosCliente.herancas.map((heranca, index) => `
                                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #f59e0b;">
                                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                                <div>
                                                    <strong>${heranca.tipo}</strong><br>
                                                    <span style="color: #6b7280; font-size: 14px;">Valor: €${heranca.valor} | Status: ${heranca.status}</span><br>
                                                    <span style="color: #6b7280; font-size: 12px;">Data: ${heranca.data}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Migrações -->
                        ${dadosCliente.migracoes.length > 0 ? `
                            <div style="margin-bottom: 30px;">
                                <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #8b5cf6; padding-bottom: 5px;">🌍 Migrações (${dadosCliente.migracoes.length})</h4>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${dadosCliente.migracoes.map((migracao, index) => `
                                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #8b5cf6;">
                                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                                <div>
                                                    <strong>${migracao.tipo}</strong><br>
                                                    <span style="color: #6b7280; font-size: 14px;">Valor: €${migracao.valor} | Status: ${migracao.status}</span><br>
                                                    <span style="color: #6b7280; font-size: 12px;">Data: ${migracao.data}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Registos -->
                        ${dadosCliente.registos.length > 0 ? `
                            <div style="margin-bottom: 30px;">
                                <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #ef4444; padding-bottom: 5px;">📝 Registos (${dadosCliente.registos.length})</h4>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${dadosCliente.registos.map((registo, index) => `
                                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #ef4444;">
                                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                                <div>
                                                    <strong>${registo.tipo}</strong><br>
                                                    <span style="color: #6b7280; font-size: 14px;">Valor: €${registo.valor} | Status: ${registo.status}</span><br>
                                                    <span style="color: #6b7280; font-size: 12px;">Data: ${registo.data}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${dadosCliente.honorarios.length === 0 && dadosCliente.contratos.length === 0 && dadosCliente.herancas.length === 0 && dadosCliente.migracoes.length === 0 && dadosCliente.registos.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: #6b7280;">
                                <i data-lucide="file-x" style="width: 48px; height: 48px; margin: 0 auto 20px; display: block;"></i>
                                <h4 style="margin: 0 0 10px 0;">Nenhum documento encontrado</h4>
                                <p style="margin: 0;">Este cliente ainda não possui documentos associados.</p>
                            </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer" style="
                        display: flex;
                        justify-content: flex-end;
                        gap: 10px;
                        padding-top: 15px;
                        border-top: 1px solid #e5e7eb;
                    ">
                        <button class="btn btn-secondary" onclick="fecharModalDIRETO()" style="
                            padding: 8px 16px;
                            background-color: #6b7280;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                        ">Fechar</button>
                        <button class="btn btn-primary" onclick="gerarRelatorioClienteEspecifico('${cliente.nome}')" style="
                            padding: 8px 16px;
                            background-color: #3b82f6;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            display: flex;
                            align-items: center;
                            gap: 5px;
                        ">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Gerar Relatório
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('✅ Modal de informações completas criado');
            
            // Verificar se o modal foi criado corretamente
            setTimeout(() => {
                const modalTeste = document.querySelector('.modal');
                if (modalTeste) {
                    console.log('✅ Modal de informações encontrado no DOM');
                    // Forçar visibilidade do modal
                    modalTeste.style.display = 'flex';
                    modalTeste.style.visibility = 'visible';
                    modalTeste.style.opacity = '1';
                    console.log('✅ Modal de informações forçado a ser visível');
                } else {
                    console.log('⚠️ Modal de informações não encontrado no DOM (pode ter sido fechado)');
                }
            }, 200);
        }

        function gerarRelatorioClienteEspecifico(nomeCliente) {
            console.log('🔧 Gerando relatório para cliente específico:', nomeCliente);
            
            // Fechar modal atual
            fecharModalDIRETO();
            
            // Simular seleção do cliente no relatório
            setTimeout(() => {
                gerarRelatorioCliente();
                
                // Preencher automaticamente o cliente selecionado
                setTimeout(() => {
                    const selectCliente = document.getElementById('clienteSelecionado');
                    if (selectCliente) {
                        selectCliente.value = nomeCliente;
                        console.log('✅ Cliente pré-selecionado:', nomeCliente);
                    }
                }, 200);
            }, 100);
        }

        // FUNÇÃO: Gerar bilhetes para clientes existentes
        function gerarBilhetesParaClientesExistentes() {
            console.log('🎫 Verificando bilhetes para clientes existentes...');
            
            let clientesAtualizados = false;
            
            // Verificar cada cliente
            clientes.forEach((cliente, index) => {
                if (!cliente.bilhete) {
                    // Gerar bilhete único
                    const bilhete = 'BIL' + Date.now() + Math.random().toString(36).substring(2, 8).toUpperCase();
                    clientes[index].bilhete = bilhete;
                    clientesAtualizados = true;
                    console.log(`✅ Bilhete gerado para ${cliente.nome}: ${bilhete}`);
                }
            });
            
            // Salvar se houve atualizações
            if (clientesAtualizados) {
                salvarDados('clientes', clientes);
                console.log('✅ Bilhetes gerados e salvos para clientes existentes');
                mostrarNotificacao('Bilhetes gerados automaticamente para clientes existentes!', 'success');
            } else {
                console.log('✅ Todos os clientes já têm bilhetes');
            }
        }

        // FUNÇÃO: Copiar bilhete para clipboard
        function copiarBilhete(bilhete) {
            if (!bilhete || bilhete === '') {
                mostrarNotificacao('Bilhete ainda não foi gerado!', 'warning');
                return;
            }
            
            // Copiar para clipboard
            navigator.clipboard.writeText(bilhete).then(() => {
                mostrarNotificacao(`Bilhete copiado: ${bilhete}`, 'success');
                console.log('✅ Bilhete copiado:', bilhete);
            }).catch(err => {
                // Fallback para navegadores mais antigos
                const textArea = document.createElement('textarea');
                textArea.value = bilhete;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                mostrarNotificacao(`Bilhete copiado: ${bilhete}`, 'success');
                console.log('✅ Bilhete copiado (fallback):', bilhete);
            });
        }

        function gerarDashboard() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            let clientesParaMostrar = clientes;
            let honorariosParaMostrar = honorarios;
            let herancasParaMostrar = herancas;
            let migracoesParaMostrar = migracoes;
            let registosParaMostrar = registos;
            
            // Filtrar dados para convidados
            if (tipoUsuario === 'convidado') {
                const convidadoId = localStorage.getItem('convidadoId');
                const convidados = obterConvidados();
                const convidado = convidados.find(c => c.id === parseInt(convidadoId));
                
                if (convidado && convidado.ativo) {
                    const clientesAutorizados = convidado.clientesAutorizados;
                    clientesParaMostrar = clientes.filter(c => clientesAutorizados.includes(c.id));
                    honorariosParaMostrar = honorarios.filter(h => clientesAutorizados.includes(h.clienteId));
                    herancasParaMostrar = herancas.filter(h => clientesAutorizados.includes(h.clienteId));
                    migracoesParaMostrar = migracoes.filter(m => clientesAutorizados.includes(m.clienteId));
                    registosParaMostrar = registos.filter(r => clientesAutorizados.includes(r.clienteId));
                } else {
                    // Se não há permissões, mostrar dados vazios
                    clientesParaMostrar = [];
                    honorariosParaMostrar = [];
                    herancasParaMostrar = [];
                    migracoesParaMostrar = [];
                    registosParaMostrar = [];
                }
            }
            
            const totalClientes = clientesParaMostrar.length;
            const totalHonorarios = honorariosParaMostrar.length;
            const valorTotal = honorariosParaMostrar.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            const honorariosPagos = honorariosParaMostrar.filter(h => h.status === 'pago').length;
            const honorariosPendentes = honorariosParaMostrar.filter(h => h.status === 'pendente').length;
            const totalHerancas = herancasParaMostrar.length;
            const totalMigracoes = migracoesParaMostrar.length;
            const totalRegistos = registosParaMostrar.length;
            
            // Calcular IVA acumulado trimestral
            const agora = new Date();
            const trimestreAtual = Math.floor(agora.getMonth() / 3);
            const anoAtual = agora.getFullYear();
            const inicioTrimestre = new Date(anoAtual, trimestreAtual * 3, 1);
            const fimTrimestre = new Date(anoAtual, (trimestreAtual + 1) * 3, 0);
            
            // Calcular IVA de todos os itens do trimestre atual
            let ivaAcumuladoTrimestral = 0;
            
            // IVA dos honorários do trimestre
            const honorariosTrimestre = honorarios.filter(h => {
                const dataHonorario = new Date(h.dataCriacao);
                return dataHonorario >= inicioTrimestre && dataHonorario <= fimTrimestre;
            });
            honorariosTrimestre.forEach(h => {
                const valor = parseFloat(h.valor) || 0;
                const iva = parseFloat(h.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            // IVA dos contratos do trimestre
            const contratosTrimestre = contratos.filter(c => {
                const dataContrato = new Date(c.dataCriacao);
                return dataContrato >= inicioTrimestre && dataContrato <= fimTrimestre;
            });
            contratosTrimestre.forEach(c => {
                const valor = parseFloat(c.valor) || 0;
                const iva = parseFloat(c.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            // IVA das heranças do trimestre
            const herancasTrimestre = herancas.filter(h => {
                const dataHeranca = new Date(h.dataCriacao);
                return dataHeranca >= inicioTrimestre && dataHeranca <= fimTrimestre;
            });
            herancasTrimestre.forEach(h => {
                const valor = parseFloat(h.valor) || 0;
                const iva = parseFloat(h.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            // IVA das migrações do trimestre
            const migracoesTrimestre = migracoes.filter(m => {
                const dataMigracao = new Date(m.dataCriacao);
                return dataMigracao >= inicioTrimestre && dataMigracao <= fimTrimestre;
            });
            migracoesTrimestre.forEach(m => {
                const valor = parseFloat(m.valor) || 0;
                const iva = parseFloat(m.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            // IVA dos registos do trimestre
            const registosTrimestre = registos.filter(r => {
                const dataRegisto = new Date(r.dataCriacao);
                return dataRegisto >= inicioTrimestre && dataRegisto <= fimTrimestre;
            });
            registosTrimestre.forEach(r => {
                const valor = parseFloat(r.valor) || 0;
                const iva = parseFloat(r.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            const nomeTrimestre = ['1º Trimestre', '2º Trimestre', '3º Trimestre', '4º Trimestre'][trimestreAtual];

            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Clientes</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalClientes}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Honorários</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalHonorarios}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Pagos</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosPagos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-purple-100 rounded-lg">
                                    <i data-lucide="trending-up" class="w-6 h-6 text-purple-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">€${(Math.round(valorTotal * 100) / 100).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="receipt" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">IVA Acumulado ${nomeTrimestre}</p>
                                    <p class="text-2xl font-bold text-gray-900">€${Number(ivaAcumuladoTrimestral).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Métricas Avançadas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-indigo-100 rounded-lg">
                                    <i data-lucide="target" class="w-6 h-6 text-indigo-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Taxa de Conversão</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalClientes > 0 ? Math.round((honorariosParaMostrar.filter(h => h.clienteId).length / totalClientes) * 100) : 0}%</p>
                                    <div class="flex items-center mt-1">
                                        <i data-lucide="trending-up" class="w-4 h-4 text-green-500 mr-1"></i>
                                        <span class="text-xs text-green-600">+5.2% vs mês anterior</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-teal-100 rounded-lg">
                                    <i data-lucide="calculator" class="w-6 h-6 text-teal-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Média por Cliente</p>
                                    <p class="text-2xl font-bold text-gray-900">€${totalClientes > 0 ? (Math.round((valorTotal / totalClientes) * 100) / 100).toFixed(2) : '0.00'}</p>
                                    <div class="flex items-center mt-1">
                                        <i data-lucide="trending-up" class="w-4 h-4 text-green-500 mr-1"></i>
                                        <span class="text-xs text-green-600">+12.3% vs mês anterior</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-orange-100 rounded-lg">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-orange-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Honorários Vencidos</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosParaMostrar.filter(h => {
                                        if (!h.vencimento) return false;
                                        const dataVencimento = new Date(h.vencimento);
                                        const hoje = new Date();
                                        return dataVencimento < hoje && h.status === 'pendente';
                                    }).length}</p>
                                    <div class="flex items-center mt-1">
                                        <i data-lucide="trending-down" class="w-4 h-4 text-red-500 mr-1"></i>
                                        <span class="text-xs text-red-600">-2.1% vs mês anterior</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-pink-100 rounded-lg">
                                    <i data-lucide="clock" class="w-6 h-6 text-pink-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Prazos Próximos</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazos.filter(p => {
                                        if (!p.dataLimite) return false;
                                        const dataLimite = new Date(p.dataLimite);
                                        const hoje = new Date();
                                        const diferencaDias = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));
                                        return diferencaDias <= 7 && diferencaDias >= 0 && p.status === 'ativo';
                                    }).length}</p>
                                    <div class="flex items-center mt-1">
                                        <i data-lucide="trending-up" class="w-4 h-4 text-blue-500 mr-1"></i>
                                        <span class="text-xs text-blue-600">+3.7% vs mês anterior</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alertas e Resumos Inteligentes -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">🚨 Alertas Urgentes</h3>
                            <div class="space-y-3">
                                ${honorariosParaMostrar.filter(h => {
                                    if (!h.vencimento) return false;
                                    const dataVencimento = new Date(h.vencimento);
                                    const hoje = new Date();
                                    return dataVencimento < hoje && h.status === 'pendente';
                                }).slice(0, 3).map(honorario => `
                                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border-l-4 border-red-500">
                                        <div>
                                            <p class="text-sm font-medium text-red-800">${honorario.cliente}</p>
                                            <p class="text-xs text-red-600">Vencido em ${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}</p>
                                        </div>
                                        <span class="text-red-600 font-bold">€${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</span>
                                    </div>
                                `).join('')}
                                ${honorariosParaMostrar.filter(h => {
                                    if (!h.vencimento) return false;
                                    const dataVencimento = new Date(h.vencimento);
                                    const hoje = new Date();
                                    return dataVencimento < hoje && h.status === 'pendente';
                                }).length === 0 ? `
                                    <div class="text-center py-4">
                                        <i data-lucide="check-circle" class="w-8 h-8 text-green-500 mx-auto mb-2"></i>
                                        <p class="text-sm text-green-600">Nenhum honorário vencido!</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">⏰ Prazos Próximos</h3>
                            <div class="space-y-3">
                                ${prazos.filter(p => {
                                    if (!p.dataLimite) return false;
                                    const dataLimite = new Date(p.dataLimite);
                                    const hoje = new Date();
                                    const diferencaDias = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));
                                    return diferencaDias <= 7 && diferencaDias >= 0 && p.status === 'ativo';
                                }).slice(0, 3).map(prazo => `
                                    <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                                        <div>
                                            <p class="text-sm font-medium text-yellow-800">${prazo.descricao}</p>
                                            <p class="text-xs text-yellow-600">${prazo.clienteNome} - ${Math.ceil((new Date(prazo.dataLimite) - new Date()) / (1000 * 60 * 60 * 24))} dias</p>
                                        </div>
                                        <span class="text-yellow-600 font-bold">${prazo.tipo}</span>
                                    </div>
                                `).join('')}
                                ${prazos.filter(p => {
                                    if (!p.dataLimite) return false;
                                    const dataLimite = new Date(p.dataLimite);
                                    const hoje = new Date();
                                    const diferencaDias = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));
                                    return diferencaDias <= 7 && diferencaDias >= 0 && p.status === 'ativo';
                                }).length === 0 ? `
                                    <div class="text-center py-4">
                                        <i data-lucide="check-circle" class="w-8 h-8 text-green-500 mx-auto mb-2"></i>
                                        <p class="text-sm text-green-600">Nenhum prazo próximo!</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">📊 Resumo Financeiro</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                    <span class="text-green-800 font-medium">Honorários Pagos</span>
                                    <span class="text-green-600 font-bold">${honorariosPagos}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                                    <span class="text-yellow-800 font-medium">Honorários Pendentes</span>
                                    <span class="text-yellow-600 font-bold">${honorariosPendentes}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                    <span class="text-blue-800 font-medium">Valor Total</span>
                                    <span class="text-blue-600 font-bold">€${(Math.round(valorTotal * 100) / 100).toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                                    <span class="text-purple-800 font-medium">Taxa de Conversão</span>
                                    <span class="text-purple-600 font-bold">${totalClientes > 0 ? Math.round((honorariosParaMostrar.filter(h => h.clienteId).length / totalClientes) * 100) : 0}%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gráficos Avançados -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">📊 Evolução Temporal dos Honorários</h3>
                            <div class="chart-container">
                                <canvas id="chartEvolucaoTemporal"></canvas>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">📈 Comparação Mensal</h3>
                            <div class="chart-container">
                                <canvas id="chartComparacaoMensal"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">🥧 Distribuição por Tipo</h3>
                            <div class="chart-container">
                                <canvas id="chartDistribuicaoTipo"></canvas>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">📈 Top 5 Clientes por Valor</h3>
                            <div class="space-y-3">
                                ${clientesParaMostrar.map(cliente => {
                                    const valorCliente = honorariosParaMostrar
                                        .filter(h => h.clienteId === cliente.id)
                                        .reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
                                    return { ...cliente, valorTotal: valorCliente };
                                }).sort((a, b) => b.valorTotal - a.valorTotal).slice(0, 5).map((cliente, index) => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div class="flex items-center">
                                            <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded-full mr-3">${index + 1}</span>
                                            <div>
                                                <p class="font-medium text-gray-800">${cliente.nome}</p>
                                                <p class="text-xs text-gray-600">${cliente.email}</p>
                                            </div>
                                        </div>
                                        <span class="text-blue-600 font-bold">€${(Math.round(cliente.valorTotal * 100) / 100).toFixed(2)}</span>
                                    </div>
                                `).join('')}
                                ${clientesParaMostrar.length === 0 ? `
                                    <div class="text-center py-4">
                                        <i data-lucide="users" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                                        <p class="text-sm text-gray-500">Nenhum cliente encontrado</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Últimos Clientes</h3>
                            <div class="space-y-3">
                                ${clientes.slice(-3).map(cliente => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium">${cliente.nome}</p>
                                            <p class="text-sm text-gray-600">${cliente.email}</p>
                                        </div>
                                        <span class="status-badge status-${cliente.status || 'ativo'}">${cliente.status || 'Ativo'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Últimos Honorários</h3>
                            <div class="space-y-3">
                                ${honorarios.slice(-3).map(honorario => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium">${honorario.cliente}</p>
                                            <p class="text-sm text-gray-600">€${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</p>
                                        </div>
                                        <span class="status-badge status-${honorario.status}">${honorario.status}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Ações Rápidas -->
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">⚡ Ações Rápidas</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button onclick="carregarSecao('honorarios')" class="flex items-center justify-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg border border-blue-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-blue-800">Criar Honorário</p>
                                </div>
                            </button>
                            
                            <button onclick="carregarSecao('prazos')" class="flex items-center justify-center p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg border border-yellow-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="clock" class="w-6 h-6 text-yellow-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-yellow-800">Ver Prazos</p>
                                </div>
                            </button>
                            
                            <button onclick="carregarSecao('clientes')" class="flex items-center justify-center p-4 bg-green-50 hover:bg-green-100 rounded-lg border border-green-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="user-plus" class="w-6 h-6 text-green-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-green-800">Novo Cliente</p>
                                </div>
                            </button>
                            
                            <button onclick="gerarRelatorioCompleto()" class="flex items-center justify-center p-4 bg-purple-50 hover:bg-purple-100 rounded-lg border border-purple-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="download" class="w-6 h-6 text-purple-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-purple-800">Relatório Geral</p>
                                </div>
                            </button>
                            
                            <button onclick="gerarRelatorioCliente()" class="flex items-center justify-center p-4 bg-indigo-50 hover:bg-indigo-100 rounded-lg border border-indigo-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="user-check" class="w-6 h-6 text-indigo-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-indigo-800">Relatório Cliente</p>
                                </div>
                            </button>
                            
                            <button onclick="testarModal()" class="flex items-center justify-center p-4 bg-red-50 hover:bg-red-100 rounded-lg border border-red-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="bug" class="w-6 h-6 text-red-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-red-800">Testar Modal</p>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Novas Seções -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="home" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Heranças</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalHerancas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-orange-100 rounded-lg">
                                    <i data-lucide="users-2" class="w-6 h-6 text-orange-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Migrações</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalMigracoes}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-indigo-100 rounded-lg">
                                    <i data-lucide="book-open" class="w-6 h-6 text-indigo-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Registos</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalRegistos}</p>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            `;
        }

        function criarGraficosAvancados() {
            // Dados para os gráficos
            const dadosEvolucaoTemporal = calcularEvolucaoTemporal();
            const dadosComparacaoMensal = calcularComparacaoMensal();
            const dadosDistribuicaoTipo = calcularDistribuicaoTipo();
            
            // Gráfico de Evolução Temporal
            const ctxEvolucao = document.getElementById('chartEvolucaoTemporal');
            if (ctxEvolucao) {
                new Chart(ctxEvolucao, {
                    type: 'line',
                    data: {
                        labels: dadosEvolucaoTemporal.labels,
                        datasets: [{
                            label: 'Honorários (€)',
                            data: dadosEvolucaoTemporal.valores,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '€' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Gráfico de Comparação Mensal
            const ctxComparacao = document.getElementById('chartComparacaoMensal');
            if (ctxComparacao) {
                new Chart(ctxComparacao, {
                    type: 'bar',
                    data: {
                        labels: dadosComparacaoMensal.labels,
                        datasets: [{
                            label: 'Honorários',
                            data: dadosComparacaoMensal.honorarios,
                            backgroundColor: 'rgba(34, 197, 94, 0.8)'
                        }, {
                            label: 'Heranças',
                            data: dadosComparacaoMensal.herancas,
                            backgroundColor: 'rgba(249, 115, 22, 0.8)'
                        }, {
                            label: 'Migrações',
                            data: dadosComparacaoMensal.migracoes,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '€' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Gráfico de Distribuição por Tipo
            const ctxDistribuicao = document.getElementById('chartDistribuicaoTipo');
            if (ctxDistribuicao) {
                new Chart(ctxDistribuicao, {
                    type: 'doughnut',
                    data: {
                        labels: dadosDistribuicaoTipo.labels,
                        datasets: [{
                            data: dadosDistribuicaoTipo.valores,
                            backgroundColor: [
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(249, 115, 22, 0.8)',
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(168, 85, 247, 0.8)',
                                'rgba(236, 72, 153, 0.8)'
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        function calcularEvolucaoTemporal() {
            const agora = new Date();
            const ultimos6Meses = [];
            
            for (let i = 5; i >= 0; i--) {
                const data = new Date(agora.getFullYear(), agora.getMonth() - i, 1);
                ultimos6Meses.push(data);
            }
            
            const labels = ultimos6Meses.map(data => 
                data.toLocaleDateString('pt-PT', { month: 'short', year: 'numeric' })
            );
            
            const valores = ultimos6Meses.map(data => {
                const inicioMes = new Date(data.getFullYear(), data.getMonth(), 1);
                const fimMes = new Date(data.getFullYear(), data.getMonth() + 1, 0);
                
                return window.honorarios ? window.honorarios.filter(h => {
                    const dataHonorario = new Date(h.dataCriacao);
                    return dataHonorario >= inicioMes && dataHonorario <= fimMes;
                }).reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
            });
            
            return { labels, valores };
        }

        function calcularComparacaoMensal() {
            const agora = new Date();
            const ultimos3Meses = [];
            
            for (let i = 2; i >= 0; i--) {
                const data = new Date(agora.getFullYear(), agora.getMonth() - i, 1);
                ultimos3Meses.push(data);
            }
            
            const labels = ultimos3Meses.map(data => 
                data.toLocaleDateString('pt-PT', { month: 'short', year: 'numeric' })
            );
            
            const valoresHonorarios = ultimos3Meses.map(data => {
                const inicioMes = new Date(data.getFullYear(), data.getMonth(), 1);
                const fimMes = new Date(data.getFullYear(), data.getMonth() + 1, 0);
                
                return window.honorarios ? window.honorarios.filter(h => {
                    const dataHonorario = new Date(h.dataCriacao);
                    return dataHonorario >= inicioMes && dataHonorario <= fimMes;
                }).reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
            });
            
            const valoresHerancas = ultimos3Meses.map(data => {
                const inicioMes = new Date(data.getFullYear(), data.getMonth(), 1);
                const fimMes = new Date(data.getFullYear(), data.getMonth() + 1, 0);
                
                return window.herancas ? window.herancas.filter(h => {
                    const dataHeranca = new Date(h.dataCriacao);
                    return dataHeranca >= inicioMes && dataHeranca <= fimMes;
                }).reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
            });
            
            const valoresMigracoes = ultimos3Meses.map(data => {
                const inicioMes = new Date(data.getFullYear(), data.getMonth(), 1);
                const fimMes = new Date(data.getFullYear(), data.getMonth() + 1, 0);
                
                return window.migracoes ? window.migracoes.filter(m => {
                    const dataMigracao = new Date(m.dataCriacao);
                    return dataMigracao >= inicioMes && dataMigracao <= fimMes;
                }).reduce((sum, m) => sum + (parseFloat(m.valor) || 0), 0) : 0;
            });
            
            return { labels, honorarios: valoresHonorarios, herancas: valoresHerancas, migracoes: valoresMigracoes };
        }

        function calcularDistribuicaoTipo() {
            const valorHonorarios = window.honorarios ? window.honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
            const valorHerancas = window.herancas ? window.herancas.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
            const valorMigracoes = window.migracoes ? window.migracoes.reduce((sum, m) => sum + (parseFloat(m.valor) || 0), 0) : 0;
            const valorRegistos = window.registos ? window.registos.reduce((sum, r) => sum + (parseFloat(r.valor) || 0), 0) : 0;
            const valorContratos = window.contratos ? window.contratos.reduce((sum, c) => sum + (parseFloat(c.valor) || 0), 0) : 0;
            
            return {
                labels: ['Honorários', 'Heranças', 'Migrações', 'Registos', 'Contratos'],
                valores: [valorHonorarios, valorHerancas, valorMigracoes, valorRegistos, valorContratos]
            };
        }

        function gerarClientes() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            let clientesParaMostrar = clientes;
            
            // Filtrar clientes para convidados
            if (tipoUsuario === 'convidado') {
                const convidadoId = localStorage.getItem('convidadoId');
                const convidados = obterConvidados();
                const convidado = convidados.find(c => c.id === parseInt(convidadoId));
                
                console.log('🔧 Convidado encontrado:', convidado);
                console.log('🔧 Clientes autorizados:', convidado?.clientesAutorizados);
                console.log('🔧 Total de clientes:', clientes.length);
                
                if (convidado && convidado.ativo) {
                    // Permitir que convidados vejam clientes autorizados E clientes que eles criaram
                    const clientesAutorizados = convidado.clientesAutorizados || [];
                    const clientesCriadosPeloConvidado = clientes.filter(cliente => 
                        cliente.criadoPorConvidado === parseInt(convidadoId)
                    );
                    
                    clientesParaMostrar = clientes.filter(cliente => 
                        clientesAutorizados.includes(cliente.id) || 
                        cliente.criadoPorConvidado === parseInt(convidadoId)
                    );
                    
                    console.log('🔧 Clientes para mostrar:', clientesParaMostrar.length);
                } else {
                    clientesParaMostrar = []; // Nenhum cliente se não há permissões
                }
            }
            
            const botaoNovoCliente = `
                <button onclick="abrirModal('cliente')" class="btn btn-primary">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Novo Cliente
                </button>
            `;
            
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        ${botaoNovoCliente}
                    </div>

                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaClientes" placeholder="Buscar clientes..." 
                                   class="search-input" onkeyup="filtrarClientes()">
                        </div>
                        
                        <!-- Filtros Avançados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosClientes()">
                                    <option value="">Todos os status</option>
                                    <option value="ativo">Ativo</option>
                                    <option value="inativo">Inativo</option>
                                    <option value="suspenso">Suspenso</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Criação</label>
                                <select id="filtroDataCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosClientes()">
                                    <option value="">Todas as datas</option>
                                    <option value="hoje">Hoje</option>
                                    <option value="semana">Esta semana</option>
                                    <option value="mes">Este mês</option>
                                    <option value="ano">Este ano</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Buscar por NIF</label>
                                <input type="text" id="buscaNifClientes" placeholder="Digite o NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onkeyup="aplicarFiltrosClientes()">
                                <!-- CACHE UPDATE: Campo NIF adicionado -->
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosClientes()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorClientes">0</span> clientes encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="p-6">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nome <span class="text-xs text-blue-500">(clique para ver)</span></th>
                                            <th>Email</th>
                                            <th>Telefone</th>
                                            <th>NIF</th>
                                            <th>Bilhete</th>
                                            <th>Status</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaClientes">
                                        ${clientesParaMostrar.map(cliente => `
                                            <tr>
                                                <td>
                                                    <button onclick="mostrarInformacoesCompletasCliente(${JSON.stringify(cliente).replace(/"/g, '&quot;')})" 
                                                            class="text-blue-600 hover:text-blue-800 font-medium cursor-pointer hover:underline flex items-center gap-1" 
                                                            title="Clicar para ver informações completas">
                                                        <i data-lucide="user" class="w-4 h-4"></i>
                                                        ${cliente.nome}
                                                    </button>
                                                </td>
                                                <td>${cliente.email}</td>
                                                <td>${cliente.telefone}</td>
                                                <td>${cliente.nif || '-'}</td>
                                                <td><span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-mono">${cliente.bilhete || 'Gerando...'}</span></td>
                                                <td><span class="status-badge status-${cliente.status || 'ativo'}">${cliente.status || 'Ativo'}</span></td>
                                                <td>
                                                    <button onclick="copiarBilhete('${cliente.bilhete || ''}')" class="text-yellow-600 hover:text-yellow-800 mr-2" title="Copiar Bilhete">
                                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="editarItem('cliente', ${cliente.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="abrirAnexosCliente(${cliente.id})" class="text-green-600 hover:text-green-800" title="Documentos">
                                                        <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarHonorarios() {
            const honorariosPagos = honorarios.filter(h => h.status === 'pago').length;
            const honorariosPendentes = honorarios.filter(h => h.status === 'pendente').length;
            const honorariosVencidos = honorarios.filter(h => h.status === 'vencido').length;
            const valorTotal = honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <button onclick="abrirModal('honorario')" class="btn btn-primary">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Novo Honorário
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Pagos</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosPagos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="clock" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Pendentes</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosPendentes}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="alert-circle" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Vencidos</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosVencidos}</p>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">€${(Math.round(valorTotal * 100) / 100).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaHonorarios" placeholder="Buscar honorários..." 
                                   class="search-input" onkeyup="filtrarHonorarios()">
                        </div>
                        
                        <!-- Filtros Avançados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusHonorario" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="pago">Pago</option>
                                    <option value="vencido">Vencido</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor Mínimo</label>
                                <input type="number" id="filtroValorMinHonorario" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor Máximo</label>
                                <input type="number" id="filtroValorMaxHonorario" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                                <select id="filtroVencimentoHonorario" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                                    <option value="">Todas as datas</option>
                                    <option value="hoje">Vence hoje</option>
                                    <option value="semana">Esta semana</option>
                                    <option value="mes">Este mês</option>
                                    <option value="vencido">Vencidos</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosHonorarios()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorHonorarios">0</span> honorários encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="p-6">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Serviço</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>Vencimento</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaHonorarios">
                                        ${honorarios.map(honorario => `
                                            <tr>
                                                <td>${honorario.cliente}</td>
                                                <td>${honorario.servico}</td>
                                                <td>€${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</td>
                                                <td><span class="status-badge status-${honorario.status}">${honorario.status}</span></td>
                                                <td>${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}</td>
                                                <td>
                                                    <button onclick="editarItem('honorario', ${honorario.id})" class="text-blue-600 hover:text-blue-800">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="excluirItem('honorario', ${honorario.id})" class="text-red-600 hover:text-red-800 ml-2">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarContratos() {
            const contratosAtivos = contratos.filter(c => c.status === 'ativo').length;
            const contratosSuspensos = contratos.filter(c => c.status === 'suspenso').length;
            const contratosTerminados = contratos.filter(c => c.status === 'terminado').length;
            const valorTotalContratos = contratos.reduce((sum, c) => {
                const valor = parseFloat(c.valor) || 0;
                return sum + valor;
            }, 0);

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <button onclick="abrirModal('contrato')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                            Novo Contrato
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${contratosAtivos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Suspensos</p>
                                    <p class="text-2xl font-bold text-gray-900">${contratosSuspensos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Terminados</p>
                                    <p class="text-2xl font-bold text-gray-900">${contratosTerminados}</p>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">€${Math.round(valorTotalContratos * 100) / 100}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaContratos" placeholder="Buscar contratos..." 
                                   class="search-input" onkeyup="filtrarContratos()">
                        </div>
                        
                        <!-- Filtros Avançados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusContrato" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosContratos()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                                <select id="filtroClienteContrato" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosContratos()">
                                    <option value="">Todos os clientes</option>
                                    ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIF</label>
                                <input type="text" id="filtroNifContrato" placeholder="Buscar por NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosContratos()">
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosContratos()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorContratos">0</span> contratos encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="p-6">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th class="font-bold">Cliente</th>
                                            <th class="font-bold">Tipo</th>
                                            <th class="font-bold">Descrição</th>
                                            <th class="font-bold">Valor</th>
                                            <th class="font-bold">Status</th>
                                            <th class="font-bold">Data Início</th>
                                            <th class="font-bold">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaContratos">
                                        ${contratos.map(contrato => `
                                            <tr>
                                                <td>${contrato.clienteNome}</td>
                                                <td>${contrato.tipo}</td>
                                                <td>${contrato.descricao}</td>
                                                <td>
                                                    <div class="flex flex-col">
                                                        <div class="text-sm font-medium text-gray-900">€${(Math.round((parseFloat(contrato.valor) || 0) * 100) / 100).toFixed(2)}</div>
                                                        <div class="text-xs text-gray-500">
                                                            <span class="text-gray-400">+ ${contrato.iva || 0}% IVA:</span>
                                                            <span class="font-medium text-gray-700">€${(Math.round((parseFloat(contrato.valorTotal || contrato.valor) || 0) * 100) / 100).toFixed(2)}</span>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td><span class="status-badge status-${contrato.status}">${contrato.status === 'concluido' ? 'Concluído' : contrato.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span></td>
                                                <td>${new Date(contrato.dataInicio).toLocaleDateString('pt-PT')}</td>
                                                <td>
                                                    <button onclick="editarContratoDireto(${contrato.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="abrirAnexosContrato(${contrato.id})" class="text-green-600 hover:text-green-800 mr-2" title="Documentos">
                                                        <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="excluirContratoDireto(${contrato.id})" class="text-red-600 hover:text-red-800" title="Excluir">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarPrazos() {
            const prazosAtivos = prazos.filter(p => p.status === 'ativo').length;
            const prazosVencidos = prazos.filter(p => p.status === 'vencido').length;
            const prazosUrgentes = prazos.filter(p => p.prioridade === 'alta' || p.prioridade === 'critica').length;
            const prazosHoje = prazos.filter(p => {
                try {
                    if (!p.dataLimite) return false;
                    const hoje = new Date().toISOString().split('T')[0];
                    const dataLimite = new Date(p.dataLimite).toISOString().split('T')[0];
                    return dataLimite === hoje && p.status === 'ativo';
                } catch (error) {
                    console.warn('Erro ao processar data do prazo:', p.dataLimite);
                    return false;
                }
            }).length;

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600 bg-blue-50 px-3 py-2 rounded-lg">
                            <i data-lucide="info" class="w-4 h-4 inline mr-2"></i>
                            Prazos criados automaticamente pelas áreas de execução
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="clock" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosAtivos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Vencidos</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosVencidos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-orange-100 rounded-lg">
                                    <i data-lucide="zap" class="w-6 h-6 text-orange-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Urgentes</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosUrgentes}</p>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="calendar" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Hoje</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosHoje}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informação sobre prazos automáticos -->
                    <div class="card p-6 bg-blue-50 border-l-4 border-blue-400">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i data-lucide="clock" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-blue-800">Prazos Automáticos</h3>
                                <div class="mt-2 text-sm text-blue-700">
                                    <p>Os prazos são criados automaticamente quando você adiciona itens nas áreas de execução:</p>
                                    <ul class="mt-2 list-disc list-inside space-y-1">
                                        <li><strong>Contratos:</strong> Prazo de 30 dias</li>
                                        <li><strong>Heranças:</strong> Prazo de 60 dias</li>
                                        <li><strong>Migração:</strong> Prazo de 90 dias</li>
                                        <li><strong>Registos:</strong> Prazo de 15 dias</li>
                                    </ul>
                                    <p class="mt-2 text-xs text-blue-600">Você pode editar ou excluir prazos conforme necessário.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaPrazos" placeholder="Buscar prazos..." 
                                   class="search-input" onkeyup="filtrarPrazos()">
                        </div>
                        
                        <!-- Filtros Avançados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                    <option value="vencido">Vencido</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="filtroTipoPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                                    <option value="">Todos os tipos</option>
                                    <option value="contrato">Contrato</option>
                                    <option value="heranca">Herança</option>
                                    <option value="migracao">Migração</option>
                                    <option value="registo">Registo</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                                <select id="filtroVencimentoPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                                    <option value="">Todas as datas</option>
                                    <option value="hoje">Vence hoje</option>
                                    <option value="semana">Esta semana</option>
                                    <option value="mes">Este mês</option>
                                    <option value="vencido">Vencidos</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                <select id="filtroPrioridadePrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                                    <option value="">Todas as prioridades</option>
                                    <option value="baixa">Baixa</option>
                                    <option value="media">Média</option>
                                    <option value="alta">Alta</option>
                                    <option value="urgente">Urgente</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosPrazos()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorPrazos">0</span> prazos encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="p-6">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Tipo</th>
                                            <th>Descrição</th>
                                            <th>Data Limite</th>
                                            <th>Prioridade</th>
                                            <th>Status</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaPrazos">
                                        ${prazos.map(prazo => `
                                            <tr>
                                                <td>${prazo.clienteNome}</td>
                                                <td>${prazo.tipo}</td>
                                                <td>${prazo.descricao}</td>
                                                <td>${prazo.dataLimite ? new Date(prazo.dataLimite).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                                                <td><span class="status-badge status-${prazo.prioridade}">${prazo.prioridade}</span></td>
                                                <td><span class="status-badge status-${prazo.status}">${prazo.status}</span></td>
                                                <td>
                                                    <button onclick="editarItem('prazo', ${prazo.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="abrirAnexosPrazo(${prazo.id})" class="text-green-600 hover:text-green-800 mr-2">
                                                        <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="excluirItem('prazo', ${prazo.id})" class="text-red-600 hover:text-red-800">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarNotificacoes() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const convidadoId = localStorage.getItem('convidadoId');
            
            // Filtrar notificações baseado no tipo de usuário
            let notificacoesFiltradas = notificacoes;
            
            if (tipoUsuario === 'convidado') {
                // Para convidados: apenas notificações direcionadas a eles
                notificacoesFiltradas = notificacoes.filter(n => 
                    n.destinatarioId === parseInt(convidadoId) || 
                    n.destinatarioId === 'todos' ||
                    n.tipo === 'cliente_autorizado' ||
                    n.tipo === 'documento_anexado' ||
                    n.tipo === 'prazo_proximo'
                );
            }
            
            const notificacoesNaoLidas = notificacoesFiltradas.filter(n => !n.lida).length;
            const notificacoesHoje = notificacoesFiltradas.filter(n => {
                try {
                    if (!n.dataCriacao) return false;
                    const hoje = new Date().toISOString().split('T')[0];
                    const dataNotificacao = new Date(n.dataCriacao).toISOString().split('T')[0];
                    return dataNotificacao === hoje;
                } catch (error) {
                    console.warn('Erro ao processar data da notificação:', n.dataCriacao);
                    return false;
                }
            }).length;

            return `
                <div class="space-y-6">
            <div class="flex justify-between items-center">
                <div class="flex space-x-3">
                    ${tipoUsuario === 'admin' ? `
                        <button onclick="criarNotificacaoTeste()" class="btn btn-info">
                            <i data-lucide="test-tube" class="w-4 h-4"></i>
                            Teste Aleatório
                        </button>
                        <button onclick="criarNotificacaoPersonalizada()" class="btn btn-warning">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                            Criar Personalizada
                        </button>
                        <button onclick="enviarMensagemConvidado()" class="btn btn-primary">
                            <i data-lucide="send" class="w-4 h-4"></i>
                            Enviar para Convidado
                        </button>
                        <button onclick="verConversas()" class="btn btn-info">
                            <i data-lucide="message-circle" class="w-4 h-4"></i>
                            Ver Conversas
                        </button>
                    ` : `
                        <div class="text-sm text-gray-600">
                            <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                            Suas notificações automáticas e mensagens do administrador
                        </div>
                    `}
                </div>
                <div class="flex space-x-3">
                    <button onclick="marcarTodasComoLidas()" class="btn btn-secondary">
                        <i data-lucide="check" class="w-4 h-4"></i>
                        Marcar Todas como Lidas
                    </button>
                    ${tipoUsuario === 'admin' ? `
                        <button onclick="limparNotificacoes()" class="btn btn-error">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            Limpar Todas
                        </button>
                    ` : ''}
                </div>
            </div>
            
            <!-- Filtros Inteligentes -->
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Filtros Inteligentes</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                        <select id="filtroPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosNotificacoes()">
                            <option value="">Todas as prioridades</option>
                            <option value="alta">Alta</option>
                            <option value="media">Média</option>
                            <option value="baixa">Baixa</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                        <select id="filtroTipo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosNotificacoes()">
                            <option value="">Todos os tipos</option>
                            <option value="mensagem_admin">Mensagem do Admin</option>
                            <option value="resposta_convidado">Resposta do Convidado</option>
                            <option value="cliente_autorizado">Cliente Autorizado</option>
                            <option value="documento_anexado">Documento Anexado</option>
                            <option value="prazo_proximo">Prazo Próximo</option>
                            <option value="honorario">Honorário</option>
                            <option value="prazo">Prazo</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="filtroStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosNotificacoes()">
                            <option value="">Todas</option>
                            <option value="nao_lida">Não Lidas</option>
                            <option value="lida">Lidas</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Período</label>
                        <select id="filtroPeriodo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosNotificacoes()">
                            <option value="">Todos</option>
                            <option value="hoje">Hoje</option>
                            <option value="semana">Esta Semana</option>
                            <option value="mes">Este Mês</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-4">
                    <button onclick="limparFiltrosNotificacoes()" class="btn btn-secondary">
                        <i data-lucide="x" class="w-4 h-4"></i>
                        Limpar Filtros
                    </button>
                    <div class="text-sm text-gray-600">
                        <span id="contadorFiltros">${notificacoesFiltradas.length} notificações encontradas</span>
                    </div>
                </div>
            </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="bell" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Não Lidas</p>
                                    <p class="text-2xl font-bold text-gray-900">${notificacoesNaoLidas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="calendar" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Hoje</p>
                                    <p class="text-2xl font-bold text-gray-900">${notificacoesHoje}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total</p>
                                    <p class="text-2xl font-bold text-gray-900">${notificacoesFiltradas.length}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        ${notificacoesFiltradas.length === 0 ? `
                            <div class="card p-8 text-center">
                                <i data-lucide="bell-off" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                                <h3 class="text-lg font-semibold text-gray-600 mb-2">Nenhuma notificação</h3>
                                <p class="text-gray-500">Você está em dia! Não há notificações pendentes.</p>
                            </div>
                        ` : notificacoesFiltradas.map(notificacao => `
                            <div class="card p-4 ${notificacao.lida ? 'opacity-60' : 'border-l-4 border-blue-500'}">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="status-badge status-${notificacao.tipo}">${notificacao.tipo}</span>
                                            ${notificacao.prioridade === 'alta' ? '<span class="status-badge status-alta">Urgente</span>' : ''}
                                            ${notificacao.origem === 'admin' ? '<span class="status-badge status-info">Admin</span>' : ''}
                                            ${notificacao.origem === 'convidado' ? '<span class="status-badge status-success">Convidado</span>' : ''}
                                        </div>
                                        <h4 class="font-semibold text-gray-800">${notificacao.titulo}</h4>
                                        <p class="text-gray-600 text-sm mt-1">${notificacao.mensagem}</p>
                                        <p class="text-gray-400 text-xs mt-2">${notificacao.dataCriacao ? new Date(notificacao.dataCriacao).toLocaleString('pt-PT') : 'Data não disponível'}</p>
                                        
                                        ${notificacao.origem === 'admin' && tipoUsuario === 'convidado' ? `
                                            <div class="mt-3 pt-3 border-t border-gray-200">
                                                <button onclick="responderMensagem(${notificacao.id})" class="btn btn-sm btn-primary">
                                                    <i data-lucide="reply" class="w-4 h-4"></i>
                                                    Responder
                                                </button>
                                            </div>
                                        ` : ''}
                                        
                                        ${notificacao.respostas && notificacao.respostas.length > 0 ? `
                                            <div class="mt-3">
                                                <h5 class="text-sm font-medium text-gray-700 mb-2">Respostas (${notificacao.respostas.length})</h5>
                                                ${notificacao.respostas.map(resposta => `
                                                    <div class="bg-gray-50 p-3 rounded-lg mb-2">
                                                        <div class="flex items-center justify-between mb-1">
                                                            <span class="text-xs font-medium text-gray-600">${resposta.origem === 'admin' ? 'Admin' : 'Você'}</span>
                                                            <span class="text-xs text-gray-400">${new Date(resposta.dataCriacao).toLocaleString('pt-PT')}</span>
                                                        </div>
                                                        <p class="text-sm text-gray-800">${resposta.mensagem}</p>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        ${!notificacao.lida ? `
                                            <button onclick="marcarComoLida(${notificacao.id})" class="text-blue-600 hover:text-blue-800">
                                                <i data-lucide="check" class="w-4 h-4"></i>
                                            </button>
                                        ` : ''}
                                        <button onclick="excluirNotificacao(${notificacao.id})" class="text-red-600 hover:text-red-800">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function gerarRelatorios() {
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Relatórios</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Relatório de Clientes</h3>
                            <p class="text-gray-600 mb-4">Relatório completo de clientes cadastrados</p>
                            <button onclick="gerarRelatorioClientes()" class="btn btn-info">
                                <i data-lucide="users" class="w-4 h-4"></i>
                                Gerar
                            </button>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Relatório Financeiro</h3>
                            <p class="text-gray-600 mb-4">Relatório de honorários e receitas</p>
                            <button onclick="gerarRelatorioFinanceiro()" class="btn btn-success">
                                <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                                Gerar
                            </button>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Relatório Financeiro por Cliente</h3>
                            <p class="text-gray-600 mb-4">Relatório financeiro personalizado por cliente específico</p>
                            <button onclick="gerarRelatorioFinanceiroCliente()" class="btn btn-warning">
                                <i data-lucide="user-dollar" class="w-4 h-4"></i>
                                Gerar
                            </button>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Relatório Geral</h3>
                            <p class="text-gray-600 mb-4">Relatório completo do sistema</p>
                            <button onclick="gerarRelatorioCompleto()" class="btn btn-primary">
                                <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                                Gerar
                            </button>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Relatório por Cliente</h3>
                            <p class="text-gray-600 mb-4">Relatório personalizado por cliente específico</p>
                            <button onclick="gerarRelatorioCliente()" class="btn btn-secondary">
                                <i data-lucide="user-check" class="w-4 h-4"></i>
                                Gerar
                            </button>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Relatório Geral por Cliente</h3>
                            <p class="text-gray-600 mb-4">Relatório geral personalizado por cliente específico</p>
                            <button onclick="gerarRelatorioGeralCliente()" class="btn btn-info">
                                <i data-lucide="file-text" class="w-4 h-4"></i>
                                Gerar
                            </button>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Carregar Cliente por Bilhete</h3>
                            <p class="text-gray-600 mb-4">Carregar informações completas usando código do bilhete</p>
                            <button onclick="carregarClientePorBilhete()" class="btn btn-warning">
                                <i data-lucide="ticket" class="w-4 h-4"></i>
                                Carregar
                            </button>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Teste de Modal</h3>
                            <p class="text-gray-600 mb-4">Testar se os modais estão a funcionar</p>
                            <div class="flex gap-2">
                                <button onclick="testarModal()" class="btn btn-secondary">
                                    <i data-lucide="test-tube" class="w-4 h-4"></i>
                                    Testar Modal
                                </button>
                                <button onclick="modalUltraSimples()" class="btn btn-warning">
                                    <i data-lucide="zap" class="w-4 h-4"></i>
                                    Ultra Simples
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function inicializarSecao(secao) {
            lucide.createIcons();
            
            if (secao === 'dashboard') {
                setTimeout(() => {
                    criarGraficoHonorarios();
                }, 100);
            }
        }

        function criarGraficoHonorarios() {
            const ctx = document.getElementById('chartHonorarios');
            if (!ctx) return;

            const honorariosPagos = honorarios.filter(h => h.status === 'pago').length;
            const honorariosPendentes = honorarios.filter(h => h.status === 'pendente').length;
            const honorariosVencidos = honorarios.filter(h => h.status === 'vencido').length;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pagos', 'Pendentes', 'Vencidos'],
                    datasets: [{
                        data: [honorariosPagos, honorariosPendentes, honorariosVencidos],
                        backgroundColor: [
                            '#10b981',
                            '#f59e0b',
                            '#ef4444'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function abrirModal(tipo) {
            const modal = criarModal(tipo);
            document.getElementById('modalContainer').innerHTML = modal;
            document.getElementById('modalContainer').classList.add('show');
            lucide.createIcons();
        }

        function abrirModalEdicaoCliente(cliente) {
            const modal = criarModalEdicaoCliente(cliente);
            document.getElementById('modalContainer').innerHTML = modal;
            document.getElementById('modalContainer').classList.add('show');
            lucide.createIcons();
        }

        function abrirModalEdicaoContrato(contrato) {
            console.log('🔧 abrirModalEdicaoContrato chamado com:', contrato);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoContrato';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = fecharModal;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Contrato</h3>
                            <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form onsubmit="atualizarContrato(event, ${contrato.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="editarContratoCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `
                                            <option value="${cliente.id}" data-nome="${cliente.nome}" ${cliente.id === contrato.clienteId ? 'selected' : ''}>${cliente.nome}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Serviço *</label>
                                    <select id="editarContratoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Alteração de pactos sociais" ${contrato.tipo === 'Alteração de pactos sociais' ? 'selected' : ''}>Alteração de pactos sociais</option>
                                        <option value="Análise e revisão de contratos" ${contrato.tipo === 'Análise e revisão de contratos' ? 'selected' : ''}>Análise e revisão de contratos</option>
                                        <option value="Cessão de quotas" ${contrato.tipo === 'Cessão de quotas' ? 'selected' : ''}>Cessão de quotas</option>
                                        <option value="Constituição de sociedades" ${contrato.tipo === 'Constituição de sociedades' ? 'selected' : ''}>Constituição de sociedades</option>
                                        <option value="Contratos de arrendamento" ${contrato.tipo === 'Contratos de arrendamento' ? 'selected' : ''}>Contratos de arrendamento</option>
                                        <option value="Contratos de compra e venda" ${contrato.tipo === 'Contratos de compra e venda' ? 'selected' : ''}>Contratos de compra e venda</option>
                                        <option value="Contratos de prestação de serviços" ${contrato.tipo === 'Contratos de prestação de serviços' ? 'selected' : ''}>Contratos de prestação de serviços</option>
                                        <option value="Contratos de trabalho" ${contrato.tipo === 'Contratos de trabalho' ? 'selected' : ''}>Contratos de trabalho</option>
                                        <option value="Pactos sociais" ${contrato.tipo === 'Pactos sociais' ? 'selected' : ''}>Pactos sociais</option>
                                        <option value="Consultoria" ${contrato.tipo === 'Consultoria' ? 'selected' : ''}>Consultoria</option>
                                        <option value="Assessoria" ${contrato.tipo === 'Assessoria' ? 'selected' : ''}>Assessoria</option>
                                        <option value="Representação" ${contrato.tipo === 'Representação' ? 'selected' : ''}>Representação</option>
                                        <option value="Outro" ${contrato.tipo === 'Outro' ? 'selected' : ''}>Outro</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Descrição *</label>
                                    <textarea id="editarContratoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descreva os serviços a serem prestados...">${contrato.descricao || ''}</textarea>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="editarContratoValor" step="0.01" value="${contrato.valor || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="editarContratoIVA" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0" ${contrato.iva === 0 ? 'selected' : ''}>0% (Isento)</option>
                                            <option value="6" ${contrato.iva === 6 ? 'selected' : ''}>6% (Reduzida)</option>
                                            <option value="13" ${contrato.iva === 13 ? 'selected' : ''}>13% (Intermédia)</option>
                                            <option value="23" ${contrato.iva === 23 ? 'selected' : ''}>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="editarContratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente" ${contrato.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                            <option value="em_andamento" ${contrato.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                            <option value="concluido" ${contrato.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de Início *</label>
                                        <input type="date" id="editarContratoDataInicio" value="${contrato.dataInicio || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                    <textarea id="editarContratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre o contrato...">${contrato.observacoes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Alterações
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Adicionar ao body
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('✅ Modal de edição de contrato criado e adicionado ao body!');
        }

        function fecharModal() {
            console.log('🔧 fecharModal chamado');
            
            // Remover todos os modais com classe 'modal' PRIMEIRO
            const todosModais = document.querySelectorAll('.modal');
            todosModais.forEach(modal => {
                console.log('🔧 Removendo modal:', modal.className);
                modal.remove();
            });
            
            // Limpar modalContainer
            const modalContainer = document.getElementById('modalContainer');
            if (modalContainer) {
                modalContainer.classList.remove('show');
                modalContainer.innerHTML = '';
                console.log('✅ modalContainer limpo');
            }
            
            // Remover qualquer modal que possa estar no body
            const modalsNoBody = document.querySelectorAll('.fixed.inset-0');
            modalsNoBody.forEach(modal => {
                console.log('🔧 Removendo modal do body:', modal.id);
                modal.remove();
            });
            
            // Remover modais específicos
            const modalHeranca = document.getElementById('modalEdicaoHeranca');
            if (modalHeranca) {
                console.log('🔧 Removendo modalEdicaoHeranca');
                modalHeranca.remove();
            }
            
            const modalMigracao = document.getElementById('modalEdicaoMigracao');
            if (modalMigracao) {
                console.log('🔧 Removendo modalEdicaoMigracao');
                modalMigracao.remove();
            }
            
            const modalRegisto = document.getElementById('modalEdicaoRegisto');
            if (modalRegisto) {
                console.log('🔧 Removendo modalEdicaoRegisto');
                modalRegisto.remove();
            }
            
            // Remover qualquer modal de edição
            const modaisEdicao = document.querySelectorAll('[id^="modalEdicao"]');
            modaisEdicao.forEach(modal => {
                console.log('🔧 Removendo modal de edição:', modal.id);
                modal.remove();
            });
            
            console.log('✅ fecharModal concluído');
        }

        function criarModal(tipo) {
            const modais = {
                cliente: criarModalCliente(),
                honorario: criarModalHonorario(),
                contrato: criarModalContrato(),
                migracao: criarModalMigracao()
            };
            return modais[tipo] || '<div class="modal-content p-6">Modal não encontrado</div>';
        }

        function criarModalEdicaoCliente(cliente) {
            return `
                <div class="modal show" onclick="fecharModalDIRETO()">
                    <div class="modal-content p-6" style="max-width: 500px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Editar Cliente</h3>
                            <button onclick="fecharModalDIRETO()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formEditarCliente" onsubmit="atualizarCliente(event, ${cliente.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                                    <input type="text" id="editarClienteNome" value="${cliente.nome}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                    <input type="email" id="editarClienteEmail" value="${cliente.email}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                                    <input type="tel" id="editarClienteTelefone" value="${cliente.telefone}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NIF *</label>
                                    <input type="text" id="editarClienteNIF" value="${cliente.nif || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="123456789">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Bilhete/Código Único</label>
                                    <input type="text" id="editarClienteBilhete" value="${cliente.bilhete || ''}" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Será gerado automaticamente" readonly>
                                    <p class="text-xs text-gray-500 mt-1">Código único para carregar informações do cliente</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Endereço</label>
                                    <textarea id="editarClienteEndereco" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${cliente.endereco || ''}</textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="editarClienteStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="ativo" ${cliente.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                        <option value="inativo" ${cliente.status === 'inativo' ? 'selected' : ''}>Inativo</option>
                                        <option value="suspenso" ${cliente.status === 'suspenso' ? 'selected' : ''}>Suspenso</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-between mt-6">
                                <div class="flex space-x-3">
                                    <button type="button" onclick="excluirCliente(${cliente.id})" class="btn btn-error">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        Excluir
                                    </button>
                                </div>
                                <div class="flex space-x-3">
                                    <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i data-lucide="save" class="w-4 h-4"></i>
                                        Salvar Alterações
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function criarModalCliente() {
            return `
                <div class="modal show" onclick="fecharModalDIRETO()">
                    <div class="modal-content p-6" style="max-width: 500px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Novo Cliente</h3>
                            <button onclick="fecharModalDIRETO()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formCliente" onsubmit="salvarCliente(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                                    <input type="text" id="clienteNome" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                    <input type="email" id="clienteEmail" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                                    <input type="tel" id="clienteTelefone" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NIF *</label>
                                    <input type="text" id="clienteNIF" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="123456789">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Bilhete/Código Único</label>
                                    <input type="text" id="clienteBilhete" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Será gerado automaticamente" readonly>
                                    <p class="text-xs text-gray-500 mt-1">Código único para carregar informações do cliente</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Endereço</label>
                                    <textarea id="clienteEndereco" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="clienteStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="ativo">Ativo</option>
                                        <option value="inativo">Inativo</option>
                                        <option value="suspenso">Suspenso</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Cliente
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function criarModalHonorario() {
            return `
                <div class="modal show">
                    <div class="modal-content p-6" style="max-width: 500px;">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Novo Honorário</h3>
                            <button onclick="fecharModalDIRETO()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formHonorario" onsubmit="salvarHonorario(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="honorarioCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `
                                            <option value="${cliente.nome}">${cliente.nome}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Serviço *</label>
                                    <input type="text" id="honorarioServico" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                    <input type="number" id="honorarioValor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="honorarioStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="pendente">Pendente</option>
                                        <option value="pago">Pago</option>
                                        <option value="vencido">Vencido</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                                    <input type="date" id="honorarioVencimento" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Honorário
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function criarModalContrato() {
            return `
                <div class="modal show" onclick="fecharModalDIRETO()">
                    <div class="modal-content p-6" style="max-width: 600px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Novo Contrato</h3>
                            <button onclick="fecharModalDIRETO()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formContrato" onsubmit="salvarContrato(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="contratoCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `
                                            <option value="${cliente.id}" data-nome="${cliente.nome}">${cliente.nome}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Serviço *</label>
                                    <select id="contratoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Alteração de pactos sociais">Alteração de pactos sociais</option>
                                        <option value="Análise e revisão de contratos">Análise e revisão de contratos</option>
                                        <option value="Cessão de quotas">Cessão de quotas</option>
                                        <option value="Constituição de sociedades">Constituição de sociedades</option>
                                        <option value="Contratos de arrendamento">Contratos de arrendamento</option>
                                        <option value="Contratos de compra e venda">Contratos de compra e venda</option>
                                        <option value="Contratos de prestação de serviços">Contratos de prestação de serviços</option>
                                        <option value="Contratos de trabalho">Contratos de trabalho</option>
                                        <option value="Pactos sociais">Pactos sociais</option>
                                        <option value="Consultoria">Consultoria</option>
                                        <option value="Assessoria">Assessoria</option>
                                        <option value="Representação">Representação</option>
                                        <option value="Outro">Outro</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="contratoValor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="contratoIVA" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0">0% (Isento)</option>
                                            <option value="6">6% (Reduzida)</option>
                                            <option value="13">13% (Intermédia)</option>
                                            <option value="23" selected>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                        <select id="contratoParceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('contrato')">
                                            <option value="sem">Sem parceria</option>
                                            <option value="empresa">Empresa</option>
                                            <option value="pessoa">Pessoa</option>
                                        </select>
                                    </div>
                                    
                                    <div id="contratoParceriaNomeDiv" style="display: none;">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                        <input type="text" id="contratoParceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                        <input type="number" id="contratoPercentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="contratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente">Pendente</option>
                                            <option value="em_andamento">Em Andamento</option>
                                            <option value="concluido">Concluído</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de Início *</label>
                                        <input type="date" id="contratoDataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                    <textarea id="contratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre o contrato..."></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Contrato
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function criarModalEdicaoContrato(contrato) {
            return `
                <div class="modal show" onclick="fecharModalDIRETO()">
                    <div class="modal-content p-6" style="max-width: 600px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Editar Contrato</h3>
                            <button onclick="fecharModalDIRETO()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formEditarContrato" onsubmit="atualizarContrato(event, ${contrato.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="editarContratoCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `
                                            <option value="${cliente.id}" data-nome="${cliente.nome}" ${cliente.id === contrato.clienteId ? 'selected' : ''}>${cliente.nome}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Serviço *</label>
                                    <select id="editarContratoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Alteração de pactos sociais" ${contrato.tipo === 'Alteração de pactos sociais' ? 'selected' : ''}>Alteração de pactos sociais</option>
                                        <option value="Análise e revisão de contratos" ${contrato.tipo === 'Análise e revisão de contratos' ? 'selected' : ''}>Análise e revisão de contratos</option>
                                        <option value="Cessão de quotas" ${contrato.tipo === 'Cessão de quotas' ? 'selected' : ''}>Cessão de quotas</option>
                                        <option value="Constituição de sociedades" ${contrato.tipo === 'Constituição de sociedades' ? 'selected' : ''}>Constituição de sociedades</option>
                                        <option value="Contratos de arrendamento" ${contrato.tipo === 'Contratos de arrendamento' ? 'selected' : ''}>Contratos de arrendamento</option>
                                        <option value="Contratos de compra e venda" ${contrato.tipo === 'Contratos de compra e venda' ? 'selected' : ''}>Contratos de compra e venda</option>
                                        <option value="Contratos de prestação de serviços" ${contrato.tipo === 'Contratos de prestação de serviços' ? 'selected' : ''}>Contratos de prestação de serviços</option>
                                        <option value="Contratos de trabalho" ${contrato.tipo === 'Contratos de trabalho' ? 'selected' : ''}>Contratos de trabalho</option>
                                        <option value="Pactos sociais" ${contrato.tipo === 'Pactos sociais' ? 'selected' : ''}>Pactos sociais</option>
                                        <option value="Consultoria" ${contrato.tipo === 'Consultoria' ? 'selected' : ''}>Consultoria</option>
                                        <option value="Assessoria" ${contrato.tipo === 'Assessoria' ? 'selected' : ''}>Assessoria</option>
                                        <option value="Representação" ${contrato.tipo === 'Representação' ? 'selected' : ''}>Representação</option>
                                        <option value="Outro" ${contrato.tipo === 'Outro' ? 'selected' : ''}>Outro</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Descrição *</label>
                                    <textarea id="editarContratoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descreva os serviços a serem prestados...">${contrato.descricao || ''}</textarea>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="editarContratoValor" step="0.01" value="${contrato.valor || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="editarContratoIVA" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0" ${contrato.iva === 0 ? 'selected' : ''}>0% (Isento)</option>
                                            <option value="6" ${contrato.iva === 6 ? 'selected' : ''}>6% (Reduzida)</option>
                                            <option value="13" ${contrato.iva === 13 ? 'selected' : ''}>13% (Intermédia)</option>
                                            <option value="23" ${contrato.iva === 23 ? 'selected' : ''}>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="editarContratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="ativo" ${contrato.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                            <option value="suspenso" ${contrato.status === 'suspenso' ? 'selected' : ''}>Suspenso</option>
                                            <option value="terminado" ${contrato.status === 'terminado' ? 'selected' : ''}>Terminado</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de Início *</label>
                                        <input type="date" id="editarContratoDataInicio" value="${contrato.dataInicio || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                    <textarea id="editarContratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre o contrato...">${contrato.observacoes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-between mt-6">
                                <div class="flex space-x-3">
                                    <button type="button" onclick="excluirContrato(${contrato.id})" class="btn btn-error">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        Excluir
                                    </button>
                                </div>
                                <div class="flex space-x-3">
                                    <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i data-lucide="save" class="w-4 h-4"></i>
                                        Salvar Alterações
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function salvarCliente(event) {
            event.preventDefault();
            
            console.log('🔧 salvarCliente chamado');
            console.log('🔧 clientes antes:', clientes.length);
            
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const convidadoId = localStorage.getItem('convidadoId');
            
            // Validar dados únicos
            const nome = document.getElementById('clienteNome').value;
            const email = document.getElementById('clienteEmail').value;
            const telefone = document.getElementById('clienteTelefone').value;
            const nif = document.getElementById('clienteNIF').value;
            
            // Verificar se já existe cliente com os mesmos dados
            const clienteExistente = clientes.find(c => 
                c.nome.toLowerCase() === nome.toLowerCase() ||
                (email && c.email && c.email.toLowerCase() === email.toLowerCase()) ||
                (telefone && c.telefone && c.telefone === telefone) ||
                (nif && c.nif && c.nif === nif)
            );
            
            if (clienteExistente) {
                let mensagemErro = 'Já existe um cliente com:';
                if (clienteExistente.nome.toLowerCase() === nome.toLowerCase()) {
                    mensagemErro += ' • Nome igual';
                }
                if (email && clienteExistente.email && clienteExistente.email.toLowerCase() === email.toLowerCase()) {
                    mensagemErro += ' • Email igual';
                }
                if (telefone && clienteExistente.telefone && clienteExistente.telefone === telefone) {
                    mensagemErro += ' • Telefone igual';
                }
                if (nif && clienteExistente.nif && clienteExistente.nif === nif) {
                    mensagemErro += ' • NIF igual';
                }
                
                mostrarNotificacao(mensagemErro, 'error');
                return;
            }
            
            // Gerar bilhete único se não existir
            let bilhete = document.getElementById('clienteBilhete') ? document.getElementById('clienteBilhete').value : '';
            if (!bilhete) {
                bilhete = 'BIL' + Date.now() + Math.random().toString(36).substring(2, 8).toUpperCase();
            }
            
            const cliente = {
                id: Date.now(),
                nome: nome,
                email: email,
                telefone: telefone,
                nif: nif,
                bilhete: bilhete,
                endereco: document.getElementById('clienteEndereco').value,
                status: document.getElementById('clienteStatus').value,
                dataCriacao: new Date().toISOString(),
                criadoPorConvidado: tipoUsuario === 'convidado' ? parseInt(convidadoId) : null
            };
            
            console.log('🔧 Novo cliente criado:', cliente);
            
            clientes.push(cliente);
            console.log('🔧 clientes após push:', clientes.length);
            
            salvarDados('clientes', clientes);
            mostrarNotificacao('Cliente salvo com sucesso!', 'success');
            
            // Fechar modal imediatamente
            fecharModal();
            
            // Recarregar seção após um pequeno delay
            setTimeout(() => {
                console.log('🔧 Recarregando seção clientes...');
                carregarSecao('clientes');
            }, 100);
        }

        function salvarHonorario(event) {
            event.preventDefault();
            
            const honorario = {
                id: Date.now(),
                cliente: document.getElementById('honorarioCliente').value,
                servico: document.getElementById('honorarioServico').value,
                valor: parseFloat(document.getElementById('honorarioValor').value),
                status: document.getElementById('honorarioStatus').value,
                vencimento: document.getElementById('honorarioVencimento').value,
                dataCriacao: new Date().toISOString()
            };
            
            honorarios.push(honorario);
            salvarDados('honorarios', honorarios);
            mostrarNotificacao('Honorário salvo com sucesso!', 'success');
            
            // Fechar modal imediatamente
            fecharModal();
            
            // Recarregar seção após um pequeno delay
            setTimeout(() => {
                carregarSecao('honorarios');
            }, 100);
        }

        function salvarContrato(event) {
            event.preventDefault();
            
            const clienteId = parseInt(document.getElementById('contratoCliente').value);
            const clienteSelecionado = clientes.find(c => c.id === clienteId);
            
            const valor = parseFloat(document.getElementById('contratoValor').value);
            const ivaPercent = parseFloat(document.getElementById('contratoIVA').value);
            const percentagem = parseFloat(document.getElementById('contratoPercentagem').value) || 0;
            const valorIVA = (valor * ivaPercent) / 100;
            const valorTotal = valor + valorIVA;

            const contrato = {
                id: Date.now(),
                clienteId: clienteId,
                clienteNome: clienteSelecionado ? clienteSelecionado.nome : '',
                tipo: document.getElementById('contratoTipo').value,
                valor: valor,
                iva: ivaPercent,
                percentagem: percentagem,
                valorIVA: valorIVA,
                valorTotal: valorTotal,
                status: document.getElementById('contratoStatus').value,
                dataInicio: document.getElementById('contratoDataInicio').value,
                observacoes: document.getElementById('contratoObservacoes').value,
                dataCriacao: new Date().toISOString()
            };
            
            contratos.push(contrato);
            salvarDados('contratos', contratos);
            
            // Criar prazo automático para o contrato
            const prazoContrato = {
                id: Date.now() + 1,
                clienteId: clienteId,
                clienteNome: clienteSelecionado ? clienteSelecionado.nome : '',
                descricao: `Prazo para ${contrato.tipo}`,
                dataLimite: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30 dias
                status: 'ativo',
                tipo: 'contrato',
                referenciaId: contrato.id,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoContrato);
            salvarDados('prazos', prazos);
            
            mostrarNotificacao('Contrato e prazo criados com sucesso!', 'success');
            
            // Fechar modal imediatamente
            fecharModal();
            
            // Recarregar seção após um pequeno delay
            setTimeout(() => {
                carregarSecao('contratos');
            }, 100);
        }

        function atualizarCliente(event, id) {
            event.preventDefault();
            
            const clienteIndex = clientes.findIndex(c => c.id === id);
            if (clienteIndex !== -1) {
                // Validar dados únicos
                const nome = document.getElementById('editarClienteNome').value;
                const email = document.getElementById('editarClienteEmail').value;
                const telefone = document.getElementById('editarClienteTelefone').value;
                const nif = document.getElementById('editarClienteNIF').value;
                
                // Verificar se já existe outro cliente com os mesmos dados (excluindo o cliente atual)
                const clienteExistente = clientes.find(c => 
                    c.id !== id && (
                        c.nome.toLowerCase() === nome.toLowerCase() ||
                        (email && c.email && c.email.toLowerCase() === email.toLowerCase()) ||
                        (telefone && c.telefone && c.telefone === telefone) ||
                        (nif && c.nif && c.nif === nif)
                    )
                );
                
                if (clienteExistente) {
                    let mensagemErro = 'Já existe outro cliente com:';
                    if (clienteExistente.nome.toLowerCase() === nome.toLowerCase()) {
                        mensagemErro += ' • Nome igual';
                    }
                    if (email && clienteExistente.email && clienteExistente.email.toLowerCase() === email.toLowerCase()) {
                        mensagemErro += ' • Email igual';
                    }
                    if (telefone && clienteExistente.telefone && clienteExistente.telefone === telefone) {
                        mensagemErro += ' • Telefone igual';
                    }
                    if (nif && clienteExistente.nif && clienteExistente.nif === nif) {
                        mensagemErro += ' • NIF igual';
                    }
                    
                    mostrarNotificacao(mensagemErro, 'error');
                    return;
                }
                
                // Manter bilhete existente ou gerar novo se não existir
                let bilhete = clientes[clienteIndex].bilhete;
                if (!bilhete) {
                    bilhete = 'BIL' + Date.now() + Math.random().toString(36).substring(2, 8).toUpperCase();
                }
                
                clientes[clienteIndex] = {
                    ...clientes[clienteIndex],
                    nome: nome,
                    email: email,
                    telefone: telefone,
                    nif: nif,
                    bilhete: bilhete,
                    endereco: document.getElementById('editarClienteEndereco').value,
                    status: document.getElementById('editarClienteStatus').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('clientes', clientes);
                mostrarNotificacao('Cliente atualizado com sucesso!', 'success');
                
                // Fechar modal imediatamente
                fecharModal();
                
                // Recarregar seção após um pequeno delay
                setTimeout(() => {
                    carregarSecao('clientes');
                }, 100);
            }
        }

        function excluirCliente(id) {
            if (confirm('Tem certeza que deseja excluir este cliente? Esta ação não pode ser desfeita.')) {
                clientes = clientes.filter(c => c.id !== id);
                salvarDados('clientes', clientes);
                mostrarNotificacao('Cliente excluído com sucesso!', 'success');
                
                // Fechar modal imediatamente
                fecharModal();
                
                // Recarregar seção após um pequeno delay
                setTimeout(() => {
                    carregarSecao('clientes');
                }, 100);
            }
        }

        function atualizarContrato(event, id) {
            console.log('🔧 atualizarContrato chamado com ID:', id);
            event.preventDefault();
            
            const contratoIndex = contratos.findIndex(c => c.id === id);
            console.log('🔧 Contrato encontrado no índice:', contratoIndex);
            
            if (contratoIndex !== -1) {
                const clienteId = parseInt(document.getElementById('editarContratoCliente').value);
                const clienteSelecionado = clientes.find(c => c.id === clienteId);
                console.log('🔧 Cliente selecionado:', clienteSelecionado);
                
                const valor = parseFloat(document.getElementById('editarContratoValor').value);
                const ivaPercent = parseFloat(document.getElementById('editarContratoIVA').value);
                const valorIVA = (valor * ivaPercent) / 100;
                const valorTotal = valor + valorIVA;

                contratos[contratoIndex] = {
                    ...contratos[contratoIndex],
                    clienteId: clienteId,
                    clienteNome: clienteSelecionado ? clienteSelecionado.nome : '',
                    tipo: document.getElementById('editarContratoTipo').value,
                    descricao: document.getElementById('editarContratoDescricao').value,
                    valor: valor,
                    iva: ivaPercent,
                    valorIVA: valorIVA,
                    valorTotal: valorTotal,
                    status: document.getElementById('editarContratoStatus').value,
                    dataInicio: document.getElementById('editarContratoDataInicio').value,
                    observacoes: document.getElementById('editarContratoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                console.log('🔧 Contrato atualizado:', contratos[contratoIndex]);
                salvarDados('contratos', contratos);
                mostrarNotificacao('Contrato atualizado com sucesso!', 'success');
                
                // Fechar modal imediatamente
                fecharModal();
                
                // Recarregar seção após um pequeno delay
                setTimeout(() => {
                    carregarSecao('contratos');
                }, 100);
            } else {
                console.error('❌ Contrato não encontrado com ID:', id);
                mostrarNotificacao('Contrato não encontrado!', 'error');
            }
        }

        function excluirContrato(id) {
            if (confirm('Tem certeza que deseja excluir este contrato? Esta ação não pode ser desfeita.')) {
                contratos = contratos.filter(c => c.id !== id);
                salvarDados('contratos', contratos);
                mostrarNotificacao('Contrato excluído com sucesso!', 'success');
                
                // Fechar modal imediatamente
                fecharModal();
                
                // Recarregar seção após um pequeno delay
                setTimeout(() => {
                    carregarSecao('contratos');
                }, 100);
            }
        }

        function filtrarClientes() {
            aplicarFiltrosClientes();
        }

        function aplicarFiltrosClientes() {
            const busca = document.getElementById('buscaClientes')?.value.toLowerCase() || '';
            const buscaNif = document.getElementById('buscaNifClientes')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusCliente')?.value || '';
            const dataFiltro = document.getElementById('filtroDataCliente')?.value || '';
            
            const clientesFiltrados = clientes.filter(cliente => {
                // Filtro por busca de texto (nome, email, telefone)
                const matchBusca = !busca || 
                    cliente.nome.toLowerCase().includes(busca) || 
                    cliente.email.toLowerCase().includes(busca) ||
                    cliente.telefone.toLowerCase().includes(busca);
                
                // Filtro por NIF
                const matchNif = !buscaNif || 
                    (cliente.nif && cliente.nif.toLowerCase().includes(buscaNif));
                
                // Filtro por status
                const matchStatus = !status || cliente.status === status;
                
                // Filtro por data
                let matchData = true;
                if (dataFiltro) {
                    const dataCliente = new Date(cliente.dataCriacao);
                    const hoje = new Date();
                    
                    switch (dataFiltro) {
                        case 'hoje':
                            matchData = dataCliente.toDateString() === hoje.toDateString();
                            break;
                        case 'semana':
                            const inicioSemana = new Date(hoje);
                            inicioSemana.setDate(hoje.getDate() - hoje.getDay());
                            matchData = dataCliente >= inicioSemana;
                            break;
                        case 'mes':
                            matchData = dataCliente.getMonth() === hoje.getMonth() && 
                                        dataCliente.getFullYear() === hoje.getFullYear();
                            break;
                        case 'ano':
                            matchData = dataCliente.getFullYear() === hoje.getFullYear();
                            break;
                    }
                }
                
                return matchBusca && matchNif && matchStatus && matchData;
            });
            
            atualizarListaClientes(clientesFiltrados);
            document.getElementById('contadorClientes').textContent = clientesFiltrados.length;
        }

        function limparFiltrosClientes() {
            const elementos = [
                'buscaClientes', 'buscaNifClientes', 'filtroStatusCliente', 'filtroDataCliente'
            ];
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) elemento.value = '';
            });
            aplicarFiltrosClientes();
        }

        function filtrarHonorarios() {
            aplicarFiltrosHonorarios();
        }

        function aplicarFiltrosHonorarios() {
            console.log('🔧 aplicarFiltrosHonorarios chamado');
            const busca = document.getElementById('buscaHonorarios')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusHonorario')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinHonorario')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxHonorario')?.value) || Infinity;
            const vencimento = document.getElementById('filtroVencimentoHonorario')?.value || '';
            
            console.log('🔧 Filtros aplicados:', { busca, status, valorMin, valorMax, vencimento });
            console.log('🔧 Total de honorários:', honorarios.length);
            
            const honorariosFiltrados = honorarios.filter(honorario => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    honorario.cliente.toLowerCase().includes(busca) || 
                    honorario.servico.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || honorario.status === status;
                
                // Filtro por valor
                const valor = parseFloat(honorario.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                // Filtro por vencimento
                let matchVencimento = true;
                if (vencimento && honorario.vencimento) {
                    const dataVencimento = new Date(honorario.vencimento);
                    const hoje = new Date();
                    
                    switch (vencimento) {
                        case 'hoje':
                            matchVencimento = dataVencimento.toDateString() === hoje.toDateString();
                            break;
                        case 'semana':
                            const fimSemana = new Date(hoje);
                            fimSemana.setDate(hoje.getDate() + 7);
                            matchVencimento = dataVencimento >= hoje && dataVencimento <= fimSemana;
                            break;
                        case 'mes':
                            const fimMes = new Date(hoje);
                            fimMes.setMonth(hoje.getMonth() + 1);
                            matchVencimento = dataVencimento >= hoje && dataVencimento <= fimMes;
                            break;
                        case 'vencido':
                            matchVencimento = dataVencimento < hoje;
                            break;
                    }
                }
                
                return matchBusca && matchStatus && matchValor && matchVencimento;
            });
            
            console.log('🔧 Honorários filtrados:', honorariosFiltrados.length);
            atualizarListaHonorarios(honorariosFiltrados);
            
            const contador = document.getElementById('contadorHonorarios');
            if (contador) {
                contador.textContent = honorariosFiltrados.length;
            }
            
            // Reinicializar ícones Lucide após aplicar filtros
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('🔧 Ícones Lucide reinicializados para Honorários');
                }
            }, 100);
        }

        function limparFiltrosHonorarios() {
            const elementos = [
                'buscaHonorarios', 'filtroStatusHonorario', 'filtroValorMinHonorario', 
                'filtroValorMaxHonorario', 'filtroVencimentoHonorario'
            ];
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) elemento.value = '';
            });
            aplicarFiltrosHonorarios();
        }

        function filtrarContratos() {
            aplicarFiltrosContratos();
        }

        function aplicarFiltrosContratos() {
            console.log('🔧 aplicarFiltrosContratos chamado');
            const busca = document.getElementById('buscaContratos')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusContrato')?.value || '';
            const clienteId = document.getElementById('filtroClienteContrato')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinContrato')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxContrato')?.value) || Infinity;
            const nif = document.getElementById('filtroNifContrato')?.value || '';
            
            console.log('🔧 Filtros aplicados:', { busca, status, clienteId, valorMin, valorMax });
            console.log('🔧 Total de contratos:', contratos.length);
            
            const contratosFiltrados = contratos.filter(contrato => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    contrato.clienteNome.toLowerCase().includes(busca) || 
                    contrato.tipo.toLowerCase().includes(busca) ||
                    (contrato.observacoes && contrato.observacoes.toLowerCase().includes(busca));
                
                // Filtro por status
                const matchStatus = !status || contrato.status === status;
                
                // Filtro por cliente
                const matchCliente = !clienteId || contrato.clienteId == clienteId;
                
                // Filtro por valor
                const valor = parseFloat(contrato.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                // Filtro por NIF
                const cliente = clientes.find(c => c.id === contrato.clienteId);
                const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));
                
                return matchBusca && matchStatus && matchCliente && matchValor && matchNif;
            });
            
            console.log('🔧 Contratos filtrados:', contratosFiltrados.length);
            atualizarListaContratos(contratosFiltrados);
            
            const contador = document.getElementById('contadorContratos');
            if (contador) {
                contador.textContent = contratosFiltrados.length;
            }
            
            // Reinicializar ícones Lucide após aplicar filtros
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('🔧 Ícones Lucide reinicializados para Contratos');
                }
            }, 100);
        }

        function limparFiltrosContratos() {
            const elementos = [
                'buscaContratos', 'filtroStatusContrato', 'filtroClienteContrato', 
                'filtroValorMinContrato', 'filtroValorMaxContrato', 'filtroNifContrato'
            ];
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) elemento.value = '';
            });
            aplicarFiltrosContratos();
        }

        function atualizarListaClientes(clientesFiltrados) {
            const tbody = document.getElementById('listaClientes');
            if (!tbody) return;
            
            tbody.innerHTML = clientesFiltrados.map(cliente => `
                <tr>
                    <td>
                        <button onclick="mostrarInformacoesCompletasCliente(${JSON.stringify(cliente).replace(/"/g, '&quot;')})" 
                                class="text-blue-600 hover:text-blue-800 font-medium cursor-pointer hover:underline flex items-center gap-1" 
                                title="Clicar para ver informações completas">
                            <i data-lucide="user" class="w-4 h-4"></i>
                            ${cliente.nome}
                        </button>
                    </td>
                    <td>${cliente.email}</td>
                    <td>${cliente.telefone}</td>
                    <td>${cliente.nif || '-'}</td>
                    <td><span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-mono">${cliente.bilhete || 'Gerando...'}</span></td>
                    <td><span class="status-badge status-${cliente.status || 'ativo'}">${cliente.status || 'Ativo'}</span></td>
                    <td>
                        <button onclick="editarClienteDireto(${cliente.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirItem('cliente', ${cliente.id})" class="text-red-600 hover:text-red-800" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Reinicializar ícones Lucide
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            }, 50);
        }

        function atualizarListaHonorarios(honorariosFiltrados) {
            const tbody = document.getElementById('listaHonorarios');
            if (!tbody) return;
            
            tbody.innerHTML = honorariosFiltrados.map(honorario => `
                <tr>
                    <td>${honorario.cliente}</td>
                    <td>${honorario.servico}</td>
                    <td>€${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</td>
                    <td><span class="status-badge status-${honorario.status}">${honorario.status}</span></td>
                    <td>${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}</td>
                    <td>
                        <button class="btn-editar-honorario text-blue-600 hover:text-blue-800 mr-2" data-id="${honorario.id}" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button class="btn-excluir-honorario text-red-600 hover:text-red-800" data-id="${honorario.id}" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Adicionar event listeners
            tbody.querySelectorAll('.btn-editar-honorario').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    console.log('🔧 ID do botão editar:', id, 'Tipo:', typeof id);
                    editarHonorarioDireto(id);
                });
            });
            
            tbody.querySelectorAll('.btn-excluir-honorario').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    console.log('🔧 ID do botão excluir:', id, 'Tipo:', typeof id);
                    excluirHonorarioDireto(id);
                });
            });
            
            // Reinicializar ícones Lucide
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            }, 50);
        }

        function atualizarListaContratos(contratosFiltrados) {
            const tbody = document.getElementById('listaContratos');
            if (!tbody) return;
            
            tbody.innerHTML = contratosFiltrados.map(contrato => `
                <tr>
                    <td>${contrato.clienteNome}</td>
                    <td>${contrato.tipo}</td>
                    <td>${contrato.descricao || '-'}</td>
                    <td>
                        <div class="text-sm font-bold text-black">€${(Math.round((parseFloat(contrato.valor) || 0) * 100) / 100).toFixed(2)}</div>
                        <div class="text-xs font-bold text-red-600">+ IVA: €${((contrato.valor || 0) + ((contrato.valor || 0) * (contrato.iva || 0) / 100)).toFixed(2)}</div>
                    </td>
                    <td><span class="status-badge status-${contrato.status}">${contrato.status === 'concluido' ? 'Concluído' : contrato.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span></td>
                    <td>${contrato.dataInicio ? new Date(contrato.dataInicio).toLocaleDateString('pt-PT') : '-'}</td>
                    <td>
                        <button onclick="editarContratoDireto(${contrato.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="abrirAnexosContrato(${contrato.id})" class="text-green-600 hover:text-green-800 mr-2" title="Documentos">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirContratoDireto(${contrato.id})" class="text-red-600 hover:text-red-800" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Reinicializar ícones Lucide após atualizar a lista
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('🔧 Ícones Lucide reinicializados na lista de Contratos');
                }
            }, 100);
        }

        function mostrarNotificacao(mensagem, tipo = 'info') {
            const container = document.getElementById('notificationsContainer');
            if (!container) {
                // Se não há container, criar notificação temporária
                const notificacao = document.createElement('div');
                notificacao.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300`;
                
                const cores = {
                    success: 'bg-green-500 text-white',
                    error: 'bg-red-500 text-white',
                    warning: 'bg-yellow-500 text-white',
                    info: 'bg-blue-500 text-white'
                };
                
                notificacao.className += ` ${cores[tipo] || cores.info}`;
                notificacao.textContent = mensagem;
                
                document.body.appendChild(notificacao);
                
                // Remover após 5 segundos
                setTimeout(() => {
                    if (notificacao.parentNode) {
                        notificacao.parentNode.removeChild(notificacao);
                    }
                }, 5000);
                return;
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            notification.textContent = mensagem;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function atualizarInterface() {
            lucide.createIcons();
        }

        // Função fecharModal duplicada removida

        function editarItem(tipo, id) {
            console.log('🔧 editarItem chamado:', tipo, id);
            
            // Fechar qualquer modal aberto primeiro
            fecharModal();
            
            if (tipo === 'cliente') {
                const cliente = clientes.find(c => c.id === id);
                if (cliente) {
                    abrirModalEdicaoCliente(cliente);
                }
            } else if (tipo === 'contrato') {
                const contrato = contratos.find(c => c.id === id);
                console.log('Contrato encontrado:', contrato);
                if (contrato) {
                    // Aguardar um pouco para garantir que o modal anterior foi fechado
                    setTimeout(() => {
                        abrirModalEdicaoContrato(contrato);
                    }, 100);
                } else {
                    console.error('Contrato não encontrado com ID:', id);
                    mostrarNotificacao('Contrato não encontrado!', 'error');
                }
            } else if (tipo === 'honorario') {
                const honorario = honorarios.find(h => h.id === id);
                if (honorario) {
                    abrirModalEdicaoHonorario(honorario);
                }
            } else if (tipo === 'heranca') {
                const heranca = herancas.find(h => h.id === id);
                if (heranca) {
                    abrirModalEdicaoHeranca(heranca);
                }
            } else if (tipo === 'migracao') {
                const migracao = migracoes.find(m => m.id === id);
                if (migracao) {
                    abrirModalEdicaoMigracao(migracao);
                }
            } else if (tipo === 'registo') {
                const registo = registos.find(r => r.id === id);
                if (registo) {
                    abrirModalEdicaoRegisto(registo);
                }
            } else if (tipo === 'prazo') {
                const prazo = prazos.find(p => p.id === id);
                if (prazo) {
                    abrirModalEdicaoPrazo(prazo);
                }
            } else {
                mostrarNotificacao('Funcionalidade de edição em desenvolvimento', 'info');
            }
        }

        function excluirItem(tipo, id) {
            console.log('🔧 excluirItem chamado:', tipo, id);
            
            if (confirm('Tem certeza que deseja excluir este item?')) {
                if (tipo === 'cliente') {
                    clientes = clientes.filter(item => item.id !== id);
                    salvarDados('clientes', clientes);
                    console.log('✅ Cliente excluído');
                } else if (tipo === 'honorario') {
                    honorarios = honorarios.filter(item => item.id !== id);
                    salvarDados('honorarios', honorarios);
                    console.log('✅ Honorário excluído');
                } else if (tipo === 'contrato') {
                    console.log('🔧 Excluindo contrato com ID:', id);
                    console.log('🔧 Contratos antes:', contratos.length);
                    contratos = contratos.filter(item => item.id !== id);
                    console.log('🔧 Contratos depois:', contratos.length);
                    salvarDados('contratos', contratos);
                    console.log('✅ Contrato excluído');
                } else if (tipo === 'heranca') {
                    herancas = herancas.filter(item => item.id !== id);
                    salvarDados('herancas', herancas);
                    console.log('✅ Herança excluída');
                } else if (tipo === 'migracao') {
                    migracoes = migracoes.filter(item => item.id !== id);
                    salvarDados('migracoes', migracoes);
                    console.log('✅ Migração excluída');
                } else if (tipo === 'registo') {
                    registos = registos.filter(item => item.id !== id);
                    salvarDados('registos', registos);
                    console.log('✅ Registo excluído');
                } else if (tipo === 'prazo') {
                    prazos = prazos.filter(item => item.id !== id);
                    salvarDados('prazos', prazos);
                    console.log('✅ Prazo excluído');
                }
                mostrarNotificacao('Item excluído com sucesso!', 'success');
                carregarSecao(secaoAtiva);
            }
        }

        function exportarDados() {
            const dados = {
                exportadoEm: new Date().toISOString(),
                versao: '38.0',
                dados: { clientes, honorarios, contratos }
            };
            
            const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sistema_legal_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('Dados exportados com sucesso!', 'success');
        }

        function importarDados() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const dados = JSON.parse(e.target.result);
                            if (dados.dados) {
                                clientes = dados.dados.clientes || [];
                                honorarios = dados.dados.honorarios || [];
                                contratos = dados.dados.contratos || [];
                                salvarDados('clientes', clientes);
                                salvarDados('honorarios', honorarios);
                                salvarDados('contratos', contratos);
                                mostrarNotificacao('Dados importados com sucesso!', 'success');
                                carregarSecao(secaoAtiva);
                            }
                        } catch (error) {
                            mostrarNotificacao('Erro ao importar dados', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function gerarRelatorioClientes() {
            const relatorio = `
RELATÓRIO DE CLIENTES
====================
Data: ${new Date().toLocaleDateString('pt-PT')}

Total de Clientes: ${clientes.length}

CLIENTES CADASTRADOS:
${clientes.map((cliente, index) => `
${index + 1}. ${cliente.nome}
   Email: ${cliente.email}
   Telefone: ${cliente.telefone}
   Status: ${cliente.status}
   Data: ${new Date(cliente.dataCriacao).toLocaleDateString('pt-PT')}
`).join('')}
            `;
            
            downloadRelatorio(relatorio, 'relatorio_clientes.txt');
        }

        function gerarRelatorioFinanceiro() {
            const valorTotal = honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            const honorariosPagos = honorarios.filter(h => h.status === 'pago');
            const valorPago = honorariosPagos.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            
            const relatorio = `
RELATÓRIO FINANCEIRO
====================
Data: ${new Date().toLocaleDateString('pt-PT')}

RESUMO FINANCEIRO:
- Total de Honorários: ${honorarios.length}
- Valor Total: €${(Math.round(valorTotal * 100) / 100).toFixed(2)}
- Valor Pago: €${Number(valorPago).toFixed(2)}
- Valor Pendente: €${Number(valorTotal - valorPago).toFixed(2)}

HONORÁRIOS POR STATUS:
- Pagos: ${honorarios.filter(h => h.status === 'pago').length}
- Pendentes: ${honorarios.filter(h => h.status === 'pendente').length}
- Vencidos: ${honorarios.filter(h => h.status === 'vencido').length}

DETALHES DOS HONORÁRIOS:
${honorarios.map((honorario, index) => `
${index + 1}. ${honorario.cliente} - ${honorario.servico}
   Valor: €${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}
   Status: ${honorario.status}
   Vencimento: ${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}
`).join('')}
            `;
            
            downloadRelatorio(relatorio, 'relatorio_financeiro.txt');
        }

        function gerarRelatorioCompleto() {
            const relatorio = `
RELATÓRIO COMPLETO DO SISTEMA
============================
Data: ${new Date().toLocaleDateString('pt-PT')}
Versão: 38.0

ESTATÍSTICAS GERAIS:
- Clientes: ${clientes.length}
- Honorários: ${honorarios.length}

RESUMO FINANCEIRO:
- Valor Total: €${Number(honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0)).toFixed(2)}
- Honorários Pagos: ${honorarios.filter(h => h.status === 'pago').length}
- Honorários Pendentes: ${honorarios.filter(h => h.status === 'pendente').length}

CLIENTES:
${clientes.map((cliente, index) => `
${index + 1}. ${cliente.nome} (${cliente.status})
`).join('')}

HONORÁRIOS:
${honorarios.map((honorario, index) => `
${index + 1}. ${honorario.cliente} - €${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)} (${honorario.status})
`).join('')}
            `;
            
            downloadRelatorio(relatorio, 'relatorio_completo.txt');
        }

        function downloadRelatorio(conteudo, nomeArquivo) {
            const blob = new Blob([conteudo], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('Relatório gerado com sucesso!', 'success');
        }

        // === SISTEMA DE BACKUP AUTOMÁTICO ===
        
        let backupInterval;
        let ultimoBackup = null;
        
        function iniciarSistemaBackup() {
            console.log('💾 Iniciando sistema de backup automático');
            
            // Backup inicial
            criarBackupAutomatico();
            
            // Backup a cada 5 minutos
            backupInterval = setInterval(() => {
                criarBackupAutomatico();
            }, 5 * 60 * 1000);
            
            // Backup antes de fechar a página
            window.addEventListener('beforeunload', () => {
                criarBackupAutomatico();
            });
        }
        
        function criarBackupAutomatico() {
            try {
                const backup = {
                    timestamp: new Date().toISOString(),
                    dados: {
                        clientes: clientes,
                        honorarios: honorarios,
                        contratos: contratos,
                        prazos: prazos,
                        notificacoes: notificacoes,
                        herancas: herancas,
                        migracoes: migracoes,
                        registos: registos
                    },
                    versao: '1.0',
                    tipo: 'automatico'
                };
                
                // Salvar backup no localStorage
                const backupKey = `backup_${Date.now()}`;
                localStorage.setItem(backupKey, JSON.stringify(backup));
                
                // Manter apenas os últimos 10 backups
                limparBackupsAntigos();
                
                ultimoBackup = backup.timestamp;
                console.log('✅ Backup automático criado:', new Date(backup.timestamp).toLocaleString('pt-PT'));
                
            } catch (error) {
                console.error('❌ Erro ao criar backup automático:', error);
            }
        }
        
        function limparBackupsAntigos() {
            const chaves = Object.keys(localStorage);
            const backups = chaves.filter(chave => chave.startsWith('backup_'));
            
            if (backups.length > 10) {
                // Ordenar por timestamp (mais antigos primeiro)
                const backupsOrdenados = backups.sort((a, b) => {
                    const timestampA = parseInt(a.split('_')[1]);
                    const timestampB = parseInt(b.split('_')[1]);
                    return timestampA - timestampB;
                });
                
                // Remover os mais antigos
                const paraRemover = backupsOrdenados.slice(0, backups.length - 10);
                paraRemover.forEach(chave => {
                    localStorage.removeItem(chave);
                });
                
                console.log(`🗑️ Removidos ${paraRemover.length} backups antigos`);
            }
        }
        
        function exportarDadosCompletos() {
            try {
                const dadosCompletos = {
                    timestamp: new Date().toISOString(),
                    versao: '1.0',
                    dados: {
                        clientes: clientes,
                        honorarios: honorarios,
                        contratos: contratos,
                        prazos: prazos,
                        notificacoes: notificacoes,
                        herancas: herancas,
                        migracoes: migracoes,
                        registos: registos
                    },
                    estatisticas: {
                        totalClientes: clientes.length,
                        totalHonorarios: honorarios.length,
                        totalContratos: contratos.length,
                        totalPrazos: prazos.length,
                        totalNotificacoes: notificacoes.length,
                        totalHerancas: herancas.length,
                        totalMigracoes: migracoes.length,
                        totalRegistos: registos.length
                    }
                };
                
                const blob = new Blob([JSON.stringify(dadosCompletos, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_sistema_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                mostrarNotificacao('Backup exportado com sucesso!', 'success');
                
            } catch (error) {
                console.error('❌ Erro ao exportar dados:', error);
                mostrarNotificacao('Erro ao exportar backup', 'error');
            }
        }
        
        function importarDadosCompletos() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (event) => {
                const arquivo = event.target.files[0];
                if (!arquivo) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const dadosImportados = JSON.parse(e.target.result);
                        
                        // Validar estrutura do arquivo
                        if (!dadosImportados.dados || !dadosImportados.versao) {
                            throw new Error('Arquivo de backup inválido');
                        }
                        
                        // Confirmar importação
                        if (confirm('⚠️ ATENÇÃO: Esta ação irá substituir TODOS os dados atuais!\n\nTem certeza que deseja continuar?')) {
                            
                            // Criar backup antes de importar
                            criarBackupAutomatico();
                            
                            // Importar dados
                            clientes = dadosImportados.dados.clientes || [];
                            honorarios = dadosImportados.dados.honorarios || [];
                            contratos = dadosImportados.dados.contratos || [];
                            prazos = dadosImportados.dados.prazos || [];
                            notificacoes = dadosImportados.dados.notificacoes || [];
                            herancas = dadosImportados.dados.herancas || [];
                            migracoes = dadosImportados.dados.migracoes || [];
                            registos = dadosImportados.dados.registos || [];
                            
                            // Salvar dados importados
                            salvarDados('clientes', clientes);
                            salvarDados('honorarios', honorarios);
                            salvarDados('contratos', contratos);
                            salvarDados('prazos', prazos);
                            salvarDados('notificacoes', notificacoes);
                            salvarDados('herancas', herancas);
                            salvarDados('migracoes', migracoes);
                            salvarDados('registos', registos);
                            
                            mostrarNotificacao('Dados importados com sucesso!', 'success');
                            
                            // Recarregar seção atual
                            carregarSecao(secaoAtiva);
                        }
                        
                    } catch (error) {
                        console.error('❌ Erro ao importar dados:', error);
                        mostrarNotificacao('Erro ao importar backup: ' + error.message, 'error');
                    }
                };
                reader.readAsText(arquivo);
            };
            input.click();
        }
        
        function gerarBackup() {
            const chaves = Object.keys(localStorage);
            const backups = chaves.filter(chave => chave.startsWith('backup_'));
            const ultimoBackupTexto = ultimoBackup ? new Date(ultimoBackup).toLocaleString('pt-PT') : 'Nunca';
            
            return `
                <div class="space-y-6">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Status do Sistema de Backup</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Último backup automático:</span>
                                <span class="font-medium">${ultimoBackupTexto}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total de backups:</span>
                                <span class="font-medium">${backups.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Frequência:</span>
                                <span class="font-medium">A cada 5 minutos</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Ações de Backup</h3>
                        <div class="space-y-3">
                            <button onclick="criarBackupAutomatico(); mostrarNotificacao('Backup manual criado!', 'success')" 
                                    class="w-full btn btn-primary">
                                <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                Criar Backup Manual
                            </button>
                            <button onclick="exportarDadosCompletos()" 
                                    class="w-full btn btn-success">
                                <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                Exportar Backup Completo
                            </button>
                            <button onclick="importarDadosCompletos()" 
                                    class="w-full btn btn-warning">
                                <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                                Importar Backup
                            </button>
                        </div>
                    </div>
                    
                    <div class="card p-6 border-red-200 bg-red-50">
                        <h3 class="text-lg font-semibold mb-4 text-red-800">⚠️ Limpeza Profissional</h3>
                        <p class="text-sm text-red-700 mb-4">
                            Use esta função para limpar todos os dados de teste e preparar o sistema para uso profissional com clientes reais.
                        </p>
                        <button onclick="limparDadosParaUsoProfissional()" 
                                class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 flex items-center justify-center">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                            Limpar Todos os Dados
                        </button>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Informações do Sistema</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Clientes:</span>
                                <span class="font-medium">${clientes.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Contratos:</span>
                                <span class="font-medium">${contratos.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Honorários:</span>
                                <span class="font-medium">${honorarios.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Prazos:</span>
                                <span class="font-medium">${prazos.length}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        // === SISTEMA RESTAURADO - SEM LOGIN ===
        
        
        // Carregar usuários do localStorage
        
        
        // Sistema restaurado - sem login
        
        
        
        
        // Processar login
        function processarLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;
            
            if (fazerLogin(email, senha)) {
                // Login bem-sucedido
            }
        }
        
        // Mostrar sistema principal
        function mostrarSistema() {
            document.body.innerHTML = `
                <div class="flex h-screen bg-gray-900">
                    <!-- Sidebar -->
                    <div id="sidebar" class="w-64 bg-gray-800 shadow-lg">
                        <div class="p-6">
                            <div class="flex items-center">
                                <div class="h-8 w-8 bg-blue-600 rounded-lg flex items-center justify-center">
                                    <i data-lucide="scale" class="h-5 w-5 text-white"></i>
                                </div>
                                <h1 class="ml-3 text-xl font-bold text-white">Sistema Jurídico</h1>
                            </div>
                        </div>
                        
                        <nav class="mt-6">
                            <a href="#" onclick="carregarSecao('dashboard')" class="sidebar-item" id="nav-dashboard">
                                <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                                Dashboard
                            </a>
                            <a href="#" onclick="carregarSecao('clientes')" class="sidebar-item" id="nav-clientes">
                                <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                                Gestão de Clientes
                            </a>
                            <a href="#" onclick="carregarSecao('honorarios')" class="sidebar-item" id="nav-honorarios">
                                <i data-lucide="dollar-sign" class="w-5 h-5 mr-3"></i>
                                Gestão de Honorários
                            </a>
                            <a href="#" onclick="carregarSecao('contratos')" class="sidebar-item" id="nav-contratos">
                                <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                                Gestão de Contratos
                            </a>
                            <a href="#" onclick="carregarSecao('herancas')" class="sidebar-item" id="nav-herancas">
                                <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                                Gestão de Heranças
                            </a>
                            <a href="#" onclick="carregarSecao('migracao')" class="sidebar-item" id="nav-migracao">
                                <i data-lucide="globe" class="w-5 h-5 mr-3"></i>
                                Gestão de Migração
                            </a>
                            <a href="#" onclick="carregarSecao('registos')" class="sidebar-item" id="nav-registos">
                                <i data-lucide="clipboard" class="w-5 h-5 mr-3"></i>
                                Gestão de Registos
                            </a>
                            <a href="#" onclick="carregarSecao('prazos')" class="sidebar-item" id="nav-prazos">
                                <i data-lucide="calendar" class="w-5 h-5 mr-3"></i>
                                Gestão de Prazos
                            </a>
                            <a href="#" onclick="carregarSecao('notificacoes')" class="sidebar-item" id="nav-notificacoes">
                                <i data-lucide="bell" class="w-5 h-5 mr-3"></i>
                                Notificações
                                <span id="badgeNotificacoes" class="badge hidden">0</span>
                            </a>
                            <a href="#" onclick="carregarSecao('relatorios')" class="sidebar-item" id="nav-relatorios">
                                <i data-lucide="bar-chart-3" class="w-5 h-5 mr-3"></i>
                                Gestão de Relatórios
                            </a>
                            <a href="#" onclick="carregarSecao('backup')" class="sidebar-item" id="nav-backup">
                                <i data-lucide="database" class="w-5 h-5 mr-3"></i>
                                Backup
                            </a>
                        </nav>
                        
                        <div class="absolute bottom-0 w-64 p-4">
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="flex items-center">
                                    <div class="h-8 w-8 bg-gray-600 rounded-full flex items-center justify-center">
                                        <i data-lucide="user" class="h-4 w-4 text-gray-300"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-white">${usuarioLogado ? usuarioLogado.nome : 'Usuário'}</p>
                                        <p class="text-xs text-gray-300">${usuarioLogado ? usuarioLogado.email : ''}</p>
                                    </div>
                                </div>
                                <button onclick="fazerLogout()" class="mt-2 w-full text-left text-sm text-red-400 hover:text-red-300">
                                    <i data-lucide="log-out" class="w-4 h-4 inline mr-1"></i>
                                    Sair
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Conteúdo Principal -->
                    <div class="flex-1 flex flex-col overflow-hidden bg-gray-100">
                        <!-- Header -->
                        <header class="bg-white shadow-sm border-b border-gray-200">
                            <div class="px-6 py-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h2 id="tituloSecao" class="text-2xl font-bold text-gray-900">Sistema Legal</h2>
                                        <p id="subtituloSecao" class="text-sm text-gray-600">Visão geral do sistema</p>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100">
                                            <i data-lucide="menu" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </header>
                        
                        <!-- Conteúdo -->
                        <main class="flex-1 overflow-y-auto">
                            <div class="p-6">
                                <div id="conteudoDinamico">
                                    <!-- Conteúdo será carregado aqui -->
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
                
                <!-- Modal Container -->
                <div id="modalContainer"></div>
                
                <!-- Notifications Container -->
                <div id="notificationsContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
            `;
            lucide.createIcons();
        }
        
        // Mostrar modal para criar usuário
        function mostrarCriarUsuario() {
            const modal = `
                <div id="modalAnexosCliente" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalDIRETO()">
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Criar Novo Usuário</h3>
                                <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="criarUsuario(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                                        <input type="text" id="novoNome" required 
                                               class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                        <input type="email" id="novoEmail" required 
                                               class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                                        <input type="password" id="novaSenha" required 
                                               class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Usuário</label>
                                        <select id="novoTipo" required 
                                                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                            <option value="admin">Administrador</option>
                                            <option value="usuario">Usuário</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalDIRETO()" 
                                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                        Cancelar
                                    </button>
                                    <button type="submit" 
                                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                        Criar Usuário
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
            lucide.createIcons();
        }
        
        // Criar novo usuário
        function criarUsuario(event) {
            event.preventDefault();
            
            const nome = document.getElementById('novoNome').value;
            const email = document.getElementById('novoEmail').value;
            const senha = document.getElementById('novaSenha').value;
            const tipo = document.getElementById('novoTipo').value;
            
            // Verificar se email já existe
            if (usuarios.find(u => u.email === email)) {
                mostrarNotificacao('Email já cadastrado', 'error');
                return;
            }
            
            const novoUsuario = {
                id: Date.now(),
                nome: nome,
                email: email,
                senha: senha,
                tipo: tipo,
                ativo: true,
                dataCriacao: new Date().toISOString()
            };
            
            usuarios.push(novoUsuario);
            salvarUsuarios();
            
            mostrarNotificacao('Usuário criado com sucesso!', 'success');
            fecharModal();
        }
        

        // === FUNÇÃO GENÉRICA PARA CONVERTER ARQUIVO ===
        function converterArquivoParaBase64(arquivo, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                callback(e.target.result);
            };
            reader.readAsDataURL(arquivo);
        }
        
        // === FUNÇÃO ESPECÍFICA PARA REGISTOS ===
        function adicionarAnexoRegistoReal(event, registoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const registo = registos.find(r => r.id === registoId);
                if (registo) {
                    if (!registo.anexos) registo.anexos = [];
                    registo.anexos.push(anexo);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    fecharModalDIRETO(); // Fechar modal após salvar
                }
            });
        }
        
        // === SISTEMA DE ANEXOS PARA REGISTOS ===
        
        function abrirAnexosRegisto(registoId) {
            const registo = registos.find(r => r.id === registoId);
            if (!registo) return;
            
            if (!registo.anexos) {
                registo.anexos = [];
            }
            
            const modal = `
                <div id="modalAnexosCliente" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalDIRETO()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos do Registo</h3>
                                <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexoRegisto(event, ${registoId})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('registo')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="certidao">Certidão</option>
                                                <option value="documento">Documento</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizadoRegisto" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrição (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descrição do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${registo.anexos.length})</h4>
                                ${registo.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${registo.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} • ${anexo.tamanho} • ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexoRegisto(${registoId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }
        
        function adicionarAnexoRegisto(event, registoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const registo = registos.find(r => r.id === registoId);
                if (registo) {
                    if (!registo.anexos) registo.anexos = [];
                    registo.anexos.push(anexo);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    fecharModalDIRETO(); // Fechar modal após salvar
                }
            });
        }
        
        function removerAnexoRegisto(registoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const registo = registos.find(r => r.id === registoId);
                if (registo && registo.anexos) {
                    registo.anexos = registo.anexos.filter(a => a.id !== anexoId);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    fecharModalDIRETO(); // Fechar modal após salvar
                }
            }
        }

        // === SISTEMA DE ANEXOS PARA PRAZOS ===
        
        function abrirAnexosPrazo(prazoId) {
            const prazo = prazos.find(p => p.id === prazoId);
            if (!prazo) return;
            
            if (!prazo.anexos) {
                prazo.anexos = [];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalDIRETO()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos do Prazo</h3>
                                <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexoPrazo(event, ${prazoId})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('prazo')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="documento">Documento</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="certidao">Certidão</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizadoPrazo" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrição (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descrição do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${prazo.anexos.length})</h4>
                                ${prazo.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${prazo.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} • ${anexo.tamanho} • ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexoPrazo(${prazoId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }
        
        function adicionarAnexoPrazo(event, prazoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            const anexo = {
                id: Date.now().toString(),
                nome: nome,
                tipo: tipo,
                descricao: descricao,
                nomeArquivo: arquivo.name,
                tamanho: formatarTamanho(arquivo.size),
                dataUpload: new Date().toISOString(),
                tipoArquivo: arquivo.type,
                conteudo: 'CONVERSAO_REAL_IMPLEMENTADA_FINAL...'
            };
            
            const prazo = prazos.find(p => p.id === prazoId);
            if (prazo) {
                if (!prazo.anexos) prazo.anexos = [];
                prazo.anexos.push(anexo);
                salvarDados('prazos', prazos);
                mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                fecharModalDIRETO(); // Fechar modal após salvar
            }
        }
        
        function removerAnexoPrazo(prazoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const prazo = prazos.find(p => p.id === prazoId);
                if (prazo && prazo.anexos) {
                    prazo.anexos = prazo.anexos.filter(a => a.id !== anexoId);
                    salvarDados('prazos', prazos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    fecharModalDIRETO(); // Fechar modal após salvar
                }
            }
        }

        // === SISTEMA DE NOTIFICAÇÕES AUTOMÁTICAS ===
        
        function iniciarSistemaNotificacoes() {
            console.log('🔔 Iniciando sistema de notificações');
            verificarHonorariosVencidos();
            verificarPrazosUrgentes();
            atualizarBadgeNotificacoes();
            
            // Verificar a cada 5 minutos
            setInterval(() => {
                verificarHonorariosVencidos();
                verificarPrazosUrgentes();
                atualizarBadgeNotificacoes();
            }, 5 * 60 * 1000);
        }


        function verificarHonorariosVencidos() {
            const hoje = new Date();
            const honorariosVencidos = honorarios.filter(h => {
                try {
                    if (!h.vencimento) return false;
                    const dataVencimento = new Date(h.vencimento);
                    if (isNaN(dataVencimento.getTime())) {
                        console.warn('Data de vencimento inválida no honorário:', h.vencimento);
                        return false;
                    }
                    return dataVencimento < hoje && h.status === 'pendente';
                } catch (error) {
                    console.warn('Erro ao processar honorário:', h.id, error);
                    return false;
                }
            });

            honorariosVencidos.forEach(honorario => {
                // Atualizar status para vencido
                const index = honorarios.findIndex(h => h.id === honorario.id);
                if (index !== -1) {
                    honorarios[index].status = 'vencido';
                }

                // Criar notificação se não existir
                const notificacaoExistente = notificacoes.find(n => 
                    n.tipo === 'honorario' && 
                    n.referenciaId === honorario.id && 
                    n.titulo.includes('Vencido')
                );

                if (!notificacaoExistente) {
                    criarNotificacao({
                        tipo: 'honorario',
                        titulo: 'Honorário Vencido',
                        mensagem: `O honorário de €${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)} do cliente ${honorario.cliente} está vencido desde ${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}`,
                        prioridade: 'alta',
                        referenciaId: honorario.id,
                        acao: 'ver_honorario'
                    });
                    
                }
            });

            salvarDados('honorarios', honorarios);
        }

        function verificarPrazosUrgentes() {
            const hoje = new Date();
            const amanha = new Date(hoje.getTime() + 24 * 60 * 60 * 1000);
            const proximos3Dias = new Date(hoje.getTime() + 3 * 24 * 60 * 60 * 1000);

            prazos.forEach(prazo => {
                try {
                    if (!prazo.dataLimite) return;
                    const dataLimite = new Date(prazo.dataLimite);
                    if (isNaN(dataLimite.getTime())) {
                        console.warn('Data inválida no prazo:', prazo.dataLimite);
                        return;
                    }
                    const diasRestantes = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));

                // Prazos vencidos
                if (dataLimite < hoje && prazo.status === 'ativo') {
                    const notificacaoExistente = notificacoes.find(n => 
                        n.tipo === 'prazo' && 
                        n.referenciaId === prazo.id && 
                        n.titulo.includes('Vencido')
                    );

                    if (!notificacaoExistente) {
                        criarNotificacao({
                            tipo: 'prazo',
                            titulo: 'Prazo Vencido',
                            mensagem: `O prazo "${prazo.descricao}" do cliente ${prazo.clienteNome} venceu em ${dataLimite.toLocaleDateString('pt-PT')}`,
                            prioridade: 'critica',
                            referenciaId: prazo.id,
                            acao: 'ver_prazo'
                        });
                    }
                }
                // Prazos que vencem hoje
                else if (dataLimite.toDateString() === hoje.toDateString() && prazo.status === 'ativo') {
                    const notificacaoExistente = notificacoes.find(n => 
                        n.tipo === 'prazo' && 
                        n.referenciaId === prazo.id && 
                        n.titulo.includes('Hoje')
                    );

                    if (!notificacaoExistente) {
                        criarNotificacao({
                            tipo: 'prazo',
                            titulo: 'Prazo Vence Hoje',
                            mensagem: `O prazo "${prazo.descricao}" do cliente ${prazo.clienteNome} vence hoje!`,
                            prioridade: 'alta',
                            referenciaId: prazo.id,
                            acao: 'ver_prazo'
                        });
                    }
                }
                // Prazos que vencem em 3 dias
                else if (dataLimite <= proximos3Dias && dataLimite > amanha && prazo.status === 'ativo') {
                    const notificacaoExistente = notificacoes.find(n => 
                        n.tipo === 'prazo' && 
                        n.referenciaId === prazo.id && 
                        n.titulo.includes('3 dias')
                    );

                    if (!notificacaoExistente) {
                        criarNotificacao({
                            tipo: 'prazo',
                            titulo: 'Prazo em 3 Dias',
                            mensagem: `O prazo "${prazo.descricao}" do cliente ${prazo.clienteNome} vence em ${diasRestantes} dias`,
                            prioridade: 'media',
                            referenciaId: prazo.id,
                            acao: 'ver_prazo'
                        });
                    }
                }
                } catch (error) {
                    console.warn('Erro ao processar prazo:', prazo.id, error);
                }
            });
        }

        function criarNotificacao(dados) {
            // Verificar se já existe uma notificação similar não lida
            const notificacaoExistente = notificacoes.find(n => 
                n.tipo === dados.tipo && 
                n.referenciaId === dados.referenciaId && 
                !n.lida &&
                n.titulo === dados.titulo
            );

            if (notificacaoExistente) {
                // Se já existe, apenas atualizar a data e mostrar lembrete visual
                notificacaoExistente.dataCriacao = new Date().toISOString();
                salvarDados('notificacoes', notificacoes);
                mostrarLembreteNotificacao(dados.titulo);
                return;
            }

            const notificacao = {
                id: Date.now(),
                tipo: dados.tipo,
                titulo: dados.titulo,
                mensagem: dados.mensagem,
                prioridade: dados.prioridade,
                referenciaId: dados.referenciaId,
                acao: dados.acao,
                destinatarioId: dados.destinatarioId || 'todos',
                origem: dados.origem || 'sistema',
                lida: false,
                dataCriacao: new Date().toISOString()
            };

            notificacoes.unshift(notificacao);
            salvarDados('notificacoes', notificacoes);
            
            // Mostrar notificação visual
            mostrarNotificacao(notificacao.titulo, 'warning');
        }

        function mostrarLembreteNotificacao(titulo) {
            // Criar lembrete visual no canto superior direito
            const lembrete = document.createElement('div');
            lembrete.className = 'fixed top-4 right-4 bg-orange-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center space-x-2 animate-pulse';
            lembrete.innerHTML = `
                <i data-lucide="bell" class="w-4 h-4"></i>
                <span>Lembrete: ${titulo}</span>
            `;
            
            document.body.appendChild(lembrete);
            lucide.createIcons();
            
            // Remover após 3 segundos
            setTimeout(() => {
                if (lembrete.parentNode) {
                    lembrete.parentNode.removeChild(lembrete);
                }
            }, 3000);
        }

        // === SISTEMA DE TESTE DE NOTIFICAÇÕES ===
        
        function criarNotificacaoTeste() {
            const tipos = ['prazo', 'honorario', 'contrato', 'heranca', 'migracao', 'registo'];
            const titulos = [
                'Prazo Vencido',
                'Honorário Vencido', 
                'Contrato Pendente',
                'Herança em Andamento',
                'Migração Urgente',
                'Registo Pendente'
            ];
            const mensagens = [
                'O prazo para entrega de documentos vence hoje!',
                'O honorário de €500 está vencido há 3 dias',
                'O contrato precisa ser assinado até amanhã',
                'A herança está aguardando documentação',
                'O processo de migração está atrasado',
                'O registo precisa ser finalizado esta semana'
            ];
            
            const tipoAleatorio = tipos[Math.floor(Math.random() * tipos.length)];
            const tituloAleatorio = titulos[Math.floor(Math.random() * titulos.length)];
            const mensagemAleatoria = mensagens[Math.floor(Math.random() * mensagens.length)];
            
            criarNotificacao({
                tipo: tipoAleatorio,
                titulo: tituloAleatorio,
                mensagem: mensagemAleatoria,
                prioridade: 'alta',
                referenciaId: Date.now(),
                acao: 'ver_detalhes'
            });
            
            mostrarNotificacao('Notificação de teste criada!', 'success');
        }
        
        function criarNotificacaoPersonalizada() {
            const titulo = prompt('Digite o título da notificação:');
            if (!titulo) return;
            
            const mensagem = prompt('Digite a mensagem da notificação:');
            if (!mensagem) return;
            
            const tipo = prompt('Digite o tipo (prazo, honorario, contrato, heranca, migracao, registo):');
            if (!tipo) return;
            
            criarNotificacao({
                tipo: tipo,
                titulo: titulo,
                mensagem: mensagem,
                prioridade: 'media',
                referenciaId: Date.now(),
                acao: 'ver_detalhes'
            });
            
            mostrarNotificacao('Notificação personalizada criada!', 'success');
        }

        function atualizarBadgeNotificacoes() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const convidadoId = localStorage.getItem('convidadoId');
            
            // Filtrar notificações baseado no tipo de usuário (igual ao gerarNotificacoes)
            let notificacoesFiltradas = notificacoes;
            
            if (tipoUsuario === 'convidado') {
                notificacoesFiltradas = notificacoes.filter(n => 
                    n.destinatarioId === parseInt(convidadoId) || 
                    n.destinatarioId === 'todos' ||
                    n.tipo === 'cliente_autorizado' ||
                    n.tipo === 'documento_anexado' ||
                    n.tipo === 'prazo_proximo'
                );
            }
            
            const notificacoesNaoLidas = notificacoesFiltradas.filter(n => !n.lida).length;
            const badge = document.getElementById('badgeNotificacoes');
            
            if (badge) {
                if (notificacoesNaoLidas > 0) {
                    badge.textContent = notificacoesNaoLidas;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        function marcarComoLida(notificacaoId) {
            const notificacao = notificacoes.find(n => n.id === notificacaoId);
            if (notificacao) {
                notificacao.lida = true;
                salvarDados('notificacoes', notificacoes);
                carregarSecao('notificacoes');
                atualizarBadgeNotificacoes();
            }
        }

        function marcarTodasComoLidas() {
            notificacoes.forEach(n => n.lida = true);
            salvarDados('notificacoes', notificacoes);
            carregarSecao('notificacoes');
            atualizarBadgeNotificacoes();
            mostrarNotificacao('Todas as notificações foram marcadas como lidas', 'success');
        }

        function excluirNotificacao(notificacaoId) {
            notificacoes = notificacoes.filter(n => n.id !== notificacaoId);
            salvarDados('notificacoes', notificacoes);
            carregarSecao('notificacoes');
            atualizarBadgeNotificacoes();
        }

        function limparNotificacoes() {
            if (confirm('Tem certeza que deseja limpar todas as notificações?')) {
                notificacoes = [];
                salvarDados('notificacoes', notificacoes);
                carregarSecao('notificacoes');
                atualizarBadgeNotificacoes();
                mostrarNotificacao('Todas as notificações foram removidas', 'success');
            }
        }

        // === SISTEMA HÍBRIDO DE NOTIFICAÇÕES ===
        
        function enviarMensagemConvidado() {
            const convidados = obterConvidados();
            const convidadosAtivos = convidados.filter(c => c.ativo);
            
            if (convidadosAtivos.length === 0) {
                mostrarNotificacao('Nenhum convidado ativo encontrado!', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <h3 class="text-lg font-semibold mb-4">Enviar Mensagem para Convidado</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Destinatário</label>
                            <select id="convidadoDestinatario" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecione um convidado</option>
                                ${convidadosAtivos.map(c => `
                                    <option value="${c.id}">${c.nome} (${c.email})</option>
                                `).join('')}
                                <option value="todos">Todos os Convidados</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Título</label>
                            <input type="text" id="mensagemTitulo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Título da mensagem">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem</label>
                            <textarea id="mensagemConteudo" rows="4" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite sua mensagem..."></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                            <select id="mensagemPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="baixa">Baixa</option>
                                <option value="media" selected>Média</option>
                                <option value="alta">Alta</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="fecharModalDIRETO()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button onclick="enviarMensagemConfirmar()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Enviar Mensagem
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function enviarMensagemConfirmar() {
            const destinatarioId = document.getElementById('convidadoDestinatario').value;
            const titulo = document.getElementById('mensagemTitulo').value;
            const conteudo = document.getElementById('mensagemConteudo').value;
            const prioridade = document.getElementById('mensagemPrioridade').value;
            
            if (!destinatarioId || !titulo || !conteudo) {
                mostrarNotificacao('Preencha todos os campos!', 'error');
                return;
            }
            
            const notificacao = {
                id: Date.now(),
                tipo: 'mensagem_admin',
                titulo: titulo,
                mensagem: conteudo,
                prioridade: prioridade,
                destinatarioId: destinatarioId === 'todos' ? 'todos' : parseInt(destinatarioId),
                lida: false,
                dataCriacao: new Date().toISOString(),
                origem: 'admin'
            };
            
            notificacoes.unshift(notificacao);
            salvarDados('notificacoes', notificacoes);
            
            mostrarNotificacao('Mensagem enviada com sucesso!', 'success');
            fecharModal();
            carregarSecao('notificacoes');
        }

        // === FILTROS INTELIGENTES DE NOTIFICAÇÕES ===
        
        function aplicarFiltrosNotificacoes() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const convidadoId = localStorage.getItem('convidadoId');
            
            // Obter filtros
            const filtroPrioridade = document.getElementById('filtroPrioridade')?.value || '';
            const filtroTipo = document.getElementById('filtroTipo')?.value || '';
            const filtroStatus = document.getElementById('filtroStatus')?.value || '';
            const filtroPeriodo = document.getElementById('filtroPeriodo')?.value || '';
            
            // Filtrar notificações baseado no tipo de usuário
            let notificacoesFiltradas = notificacoes;
            
            if (tipoUsuario === 'convidado') {
                notificacoesFiltradas = notificacoes.filter(n => 
                    n.destinatarioId === parseInt(convidadoId) || 
                    n.destinatarioId === 'todos' ||
                    n.tipo === 'cliente_autorizado' ||
                    n.tipo === 'documento_anexado' ||
                    n.tipo === 'prazo_proximo'
                );
            }
            
            // Aplicar filtros adicionais
            if (filtroPrioridade) {
                notificacoesFiltradas = notificacoesFiltradas.filter(n => n.prioridade === filtroPrioridade);
            }
            
            if (filtroTipo) {
                notificacoesFiltradas = notificacoesFiltradas.filter(n => n.tipo === filtroTipo);
            }
            
            if (filtroStatus === 'nao_lida') {
                notificacoesFiltradas = notificacoesFiltradas.filter(n => !n.lida);
            } else if (filtroStatus === 'lida') {
                notificacoesFiltradas = notificacoesFiltradas.filter(n => n.lida);
            }
            
            if (filtroPeriodo) {
                const agora = new Date();
                const hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
                const inicioSemana = new Date(hoje);
                inicioSemana.setDate(hoje.getDate() - hoje.getDay());
                const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);
                
                notificacoesFiltradas = notificacoesFiltradas.filter(n => {
                    if (!n.dataCriacao) return false;
                    const dataNotificacao = new Date(n.dataCriacao);
                    
                    switch (filtroPeriodo) {
                        case 'hoje':
                            return dataNotificacao >= hoje;
                        case 'semana':
                            return dataNotificacao >= inicioSemana;
                        case 'mes':
                            return dataNotificacao >= inicioMes;
                        default:
                            return true;
                    }
                });
            }
            
            // Atualizar contador
            const contador = document.getElementById('contadorFiltros');
            if (contador) {
                contador.textContent = `${notificacoesFiltradas.length} notificações encontradas`;
            }
            
            // Recarregar seção com filtros aplicados
            carregarSecao('notificacoes');
        }
        
        function limparFiltrosNotificacoes() {
            const elementos = [
                'filtroPrioridade', 'filtroTipo', 'filtroStatus', 'filtroPeriodo'
            ];
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) elemento.value = '';
            });
            carregarSecao('notificacoes');
        }

        // === SISTEMA DE COMUNICAÇÃO BIDIRECIONAL ===
        
        function responderMensagem(notificacaoId) {
            const notificacao = notificacoes.find(n => n.id === notificacaoId);
            if (!notificacao) {
                mostrarNotificacao('Notificação não encontrada!', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <h3 class="text-lg font-semibold mb-4">Responder Mensagem</h3>
                    
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-800">${notificacao.titulo}</h4>
                        <p class="text-sm text-gray-600 mt-1">${notificacao.mensagem}</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sua Resposta</label>
                            <textarea id="respostaMensagem" rows="4" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite sua resposta..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="fecharModalDIRETO()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button onclick="enviarResposta(${notificacaoId})" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Enviar Resposta
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function enviarResposta(notificacaoId) {
            const resposta = document.getElementById('respostaMensagem').value;
            
            if (!resposta.trim()) {
                mostrarNotificacao('Digite uma resposta!', 'error');
                return;
            }
            
            const notificacao = notificacoes.find(n => n.id === notificacaoId);
            if (notificacao) {
                // Inicializar array de respostas se não existir
                if (!notificacao.respostas) {
                    notificacao.respostas = [];
                }
                
                // Adicionar resposta
                const novaResposta = {
                    id: Date.now(),
                    mensagem: resposta,
                    origem: 'convidado',
                    dataCriacao: new Date().toISOString(),
                    convidadoId: localStorage.getItem('convidadoId')
                };
                
                notificacao.respostas.push(novaResposta);
                
                // Salvar dados
                salvarDados('notificacoes', notificacoes);
                
                // Criar notificação para o admin sobre a resposta
                const notificacaoAdmin = {
                    id: Date.now(),
                    tipo: 'resposta_convidado',
                    titulo: 'Resposta Recebida',
                    mensagem: `Convidado respondeu: "${resposta.substring(0, 50)}${resposta.length > 50 ? '...' : ''}"`,
                    prioridade: 'media',
                    destinatarioId: 'admin',
                    referenciaId: notificacaoId,
                    lida: false,
                    dataCriacao: new Date().toISOString(),
                    origem: 'sistema'
                };
                
                notificacoes.unshift(notificacaoAdmin);
                salvarDados('notificacoes', notificacoes);
                
                mostrarNotificacao('Resposta enviada com sucesso!', 'success');
                fecharModal();
                carregarSecao('notificacoes');
            }
        }

        // === VISUALIZAÇÃO DE CONVERSAS PARA ADMIN ===
        
        function verConversas() {
            // Filtrar notificações que têm respostas
            const conversas = notificacoes.filter(n => 
                n.respostas && n.respostas.length > 0 && 
                (n.origem === 'admin' || n.tipo === 'mensagem_admin')
            );
            
            if (conversas.length === 0) {
                mostrarNotificacao('Nenhuma conversa encontrada!', 'info');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold">Conversas com Convidados</h3>
                        <button onclick="fecharModalDIRETO()" class="text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        ${conversas.map(conversa => `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-start justify-between mb-3">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">${conversa.titulo}</h4>
                                        <p class="text-sm text-gray-600">${conversa.mensagem}</p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            ${new Date(conversa.dataCriacao).toLocaleString('pt-PT')}
                                        </p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
                                            ${conversa.respostas.length} resposta${conversa.respostas.length > 1 ? 's' : ''}
                                        </span>
                                        <button onclick="responderComoAdmin(${conversa.id})" class="btn btn-sm btn-primary">
                                            <i data-lucide="reply" class="w-4 h-4"></i>
                                            Responder
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="space-y-2">
                                    ${conversa.respostas.map(resposta => `
                                        <div class="bg-gray-50 p-3 rounded-lg">
                                            <div class="flex items-center justify-between mb-1">
                                                <span class="text-sm font-medium text-gray-600">
                                                    ${resposta.origem === 'admin' ? 'Admin' : 'Convidado'}
                                                </span>
                                                <span class="text-xs text-gray-400">
                                                    ${new Date(resposta.dataCriacao).toLocaleString('pt-PT')}
                                                </span>
                                            </div>
                                            <p class="text-sm text-gray-800">${resposta.mensagem}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function responderComoAdmin(notificacaoId) {
            const notificacao = notificacoes.find(n => n.id === notificacaoId);
            if (!notificacao) {
                mostrarNotificacao('Notificação não encontrada!', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <h3 class="text-lg font-semibold mb-4">Responder como Admin</h3>
                    
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-800">${notificacao.titulo}</h4>
                        <p class="text-sm text-gray-600 mt-1">${notificacao.mensagem}</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sua Resposta</label>
                            <textarea id="respostaAdmin" rows="4" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite sua resposta..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="fecharModalDIRETO()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button onclick="enviarRespostaAdmin(${notificacaoId})" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Enviar Resposta
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function enviarRespostaAdmin(notificacaoId) {
            const resposta = document.getElementById('respostaAdmin').value;
            
            if (!resposta.trim()) {
                mostrarNotificacao('Digite uma resposta!', 'error');
                return;
            }
            
            const notificacao = notificacoes.find(n => n.id === notificacaoId);
            if (notificacao) {
                // Inicializar array de respostas se não existir
                if (!notificacao.respostas) {
                    notificacao.respostas = [];
                }
                
                // Adicionar resposta do admin
                const novaResposta = {
                    id: Date.now(),
                    mensagem: resposta,
                    origem: 'admin',
                    dataCriacao: new Date().toISOString()
                };
                
                notificacao.respostas.push(novaResposta);
                
                // Salvar dados
                salvarDados('notificacoes', notificacoes);
                
                mostrarNotificacao('Resposta enviada com sucesso!', 'success');
                fecharModal();
                carregarSecao('notificacoes');
            }
        }

        function filtrarPrazos() {
            const busca = document.getElementById('buscaPrazos')?.value.toLowerCase() || '';
            
            const prazosFiltrados = prazos.filter(prazo => {
                return prazo.clienteNome.toLowerCase().includes(busca) || 
                       prazo.tipo.toLowerCase().includes(busca) ||
                       prazo.descricao.toLowerCase().includes(busca);
            });
            
            atualizarListaPrazos(prazosFiltrados);
        }

        function atualizarListaPrazos(prazosFiltrados) {
            const tbody = document.getElementById('listaPrazos');
            if (!tbody) return;
            
            tbody.innerHTML = prazosFiltrados.map(prazo => `
                <tr>
                    <td>${prazo.clienteNome}</td>
                    <td>${prazo.tipo}</td>
                    <td>${prazo.descricao}</td>
                    <td>${prazo.dataLimite ? new Date(prazo.dataLimite).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                    <td><span class="status-badge status-${prazo.prioridade}">${prazo.prioridade}</span></td>
                    <td><span class="status-badge status-${prazo.status}">${prazo.status}</span></td>
                    <td>
                        <button onclick="editarItem('prazo', ${prazo.id})" class="text-blue-600 hover:text-blue-800">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirItem('prazo', ${prazo.id})" class="text-red-600 hover:text-red-800 ml-2">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Sistema de inicialização movido para dentro da verificação de login

        // === FUNÇÕES DAS NOVAS SEÇÕES ===

        function gerarHerancas() {
            const totalHerancas = herancas.length;
            const herancasAtivas = herancas.filter(h => h.status === 'em_andamento').length;
            const herancasSuspensas = herancas.filter(h => h.status === 'pendente').length;
            const herancasTerminadas = herancas.filter(h => h.status === 'concluido').length;
            const valorTotalHerancas = herancas.reduce((total, h) => total + (h.valorComIva || h.valor || 0), 0);

            return `
                <div class="space-y-6">
                    <!-- Header único com botões de ação -->
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-3">
                            <button onclick="abrirModalHeranca()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Nova Herança
                            </button>
                        </div>
                    </div>

                    <!-- Estatísticas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${herancasAtivas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Suspensos</p>
                                    <p class="text-2xl font-bold text-gray-900">${herancasSuspensas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Terminados</p>
                                    <p class="text-2xl font-bold text-gray-900">${herancasTerminadas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">€${Number(valorTotalHerancas).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de busca -->
                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaHerancas" placeholder="Buscar heranças..." 
                                   class="search-input" onkeyup="filtrarHerancas()">
                        </div>
                        
                        <!-- Filtros Avançados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusHeranca" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHerancas()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="filtroTipoHeranca" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHerancas()">
                                    <option value="">Todos os tipos</option>
                                    <option value="Aceitação da herança">Aceitação da herança</option>
                                    <option value="Doações">Doações</option>
                                    <option value="Escrituras de partilha">Escrituras de partilha</option>
                                    <option value="Habilitação de herdeiros">Habilitação de herdeiros</option>
                                    <option value="Partilhas em vida">Partilhas em vida</option>
                                    <option value="Partilhas por óbito">Partilhas por óbito</option>
                                    <option value="Processo de inventário">Processo de inventário</option>
                                    <option value="Renúncia à herança">Renúncia à herança</option>
                                    <option value="Testamentos">Testamentos</option>
                                </select>
                            </div>
                            
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIF</label>
                                <input type="text" id="filtroNifHeranca" placeholder="Buscar por NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHerancas()">
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosHerancas()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorHerancas">0</span> heranças encontradas
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="overflow-x-auto table-responsive">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Descrição</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Data Início</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                <tbody id="listaHerancas" class="bg-white divide-y divide-gray-200">
                    <!-- DADOS DE TESTE DIRETOS PARA VERIFICAR AÇÕES -->
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">TESTE HERANÇA DIRETO</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">TESTE</td>
                        <td class="px-6 py-4 text-sm text-gray-500">TESTE PARA VERIFICAR AÇÕES</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div class="text-sm font-bold text-black">€1000.00</div>
                            <div class="text-xs font-bold text-red-600">+ IVA: €1230.00</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-badge status-em_andamento">Em Andamento</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">15/10/2025</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="console.log('🔧 Botão EDITAR clicado'); editarHerancaDireto(1)" style="background: blue; color: white; padding: 8px; border: none; border-radius: 4px; margin: 2px; cursor: pointer; font-weight: bold; display: inline-block; width: 80px; height: 40px; position: relative; z-index: 9999; visibility: visible; opacity: 1; !important">
                                EDITAR
                            </button>
                            <button onclick="console.log('🔧 Botão ANEXAR clicado'); abrirAnexosHeranca(1)" style="background: green; color: white; padding: 8px; border: none; border-radius: 4px; margin: 2px; cursor: pointer; font-weight: bold; display: inline-block; width: 80px; height: 40px; position: relative; z-index: 9999; visibility: visible; opacity: 1; !important">
                                ANEXAR
                            </button>
                            <button onclick="console.log('🔧 Botão ELIMINAR clicado'); excluirHerancaDireto(1)" style="background: red; color: white; padding: 8px; border: none; border-radius: 4px; margin: 2px; cursor: pointer; font-weight: bold; display: inline-block; width: 80px; height: 40px; position: relative; z-index: 9999; visibility: visible; opacity: 1; !important">
                                ELIMINAR
                            </button>
                        </td>
                    </tr>
                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarConvidados() {
            const convidados = obterConvidados();
            const convidadosAtivos = convidados.filter(c => c.ativo).length;
            const convidadosInativos = convidados.filter(c => !c.ativo).length;
            const totalConvidados = convidados.length;

            return `
                <div class="space-y-6">
                    <!-- Header com botões de ação -->
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-3">
                            <button onclick="abrirModalNovoConvidado()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
                                Novo Convidado
                            </button>
                        </div>
                    </div>

                    <!-- Estatísticas -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalConvidados}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${convidadosAtivos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="user-x" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Inativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${convidadosInativos}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Convidados -->
                    <div class="card">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Lista de Convidados</h3>
                            
                            <div class="table-responsive">
                                <table class="w-full">
                                    <thead>
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clientes Autorizados</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Criação</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaConvidados">
                                        ${convidados.map(convidado => `
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${convidado.nome}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${convidado.codigo}</td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="status-badge status-${convidado.ativo ? 'ativo' : 'inativo'}">${convidado.ativo ? 'Ativo' : 'Inativo'}</span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${convidado.clientesAutorizados.length} cliente(s)</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(convidado.dataCriacao).toLocaleDateString('pt-PT')}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                    <button onclick="abrirModalEditarPermissoes(${convidado.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar Permissões">
                                                        <i data-lucide="settings" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="ativarDesativarConvidado(${convidado.id}, ${!convidado.ativo})" class="text-${convidado.ativo ? 'red' : 'green'}-600 hover:text-${convidado.ativo ? 'red' : 'green'}-900 mr-2" title="${convidado.ativo ? 'Desativar' : 'Ativar'}">
                                                        <i data-lucide="${convidado.ativo ? 'user-x' : 'user-check'}" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="copiarCodigoConvidado('${convidado.codigo}')" class="text-gray-600 hover:text-gray-900" title="Copiar Código">
                                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // FUNÇÕES AUXILIARES PARA GESTÃO DE CONVIDADOS
        function abrirModalNovoConvidado() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">Novo Convidado</h3>
                            <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formNovoConvidado" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Convidado</label>
                                <input type="text" id="nomeConvidado" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite o nome" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Clientes Autorizados</label>
                                <div id="listaClientesConvidado" class="space-y-2 max-h-40 overflow-y-auto">
                                    <!-- Lista de clientes será carregada aqui -->
                                </div>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button type="button" onclick="fecharModalDIRETO()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                                    Cancelar
                                </button>
                                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                    Criar Convidado
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Carregar lista de clientes
            carregarClientesParaConvidado();
            
            document.getElementById('formNovoConvidado').addEventListener('submit', function(e) {
                e.preventDefault();
                const nome = document.getElementById('nomeConvidado').value;
                const clientesSelecionados = Array.from(document.querySelectorAll('#listaClientesConvidado input[type="checkbox"]:checked'))
                    .map(cb => parseInt(cb.value));
                
                const novoConvidado = criarConvidado(nome, clientesSelecionados);
                mostrarNotificacao(`Convidado criado! Código: ${novoConvidado.codigo}`, 'success');
                fecharModal();
                carregarSecao('convidados');
            });
        }
        
        function carregarClientesParaConvidado() {
            const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
            const container = document.getElementById('listaClientesConvidado');
            
            if (clientes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum cliente cadastrado</p>';
                return;
            }
            
            container.innerHTML = clientes.map(cliente => `
                <label class="flex items-center space-x-2">
                    <input type="checkbox" value="${cliente.id}" class="rounded border-gray-300">
                    <span class="text-sm text-gray-700">${cliente.nome}</span>
                </label>
            `).join('');
        }
        
        function abrirModalEditarPermissoes(id) {
            const convidados = obterConvidados();
            const convidado = convidados.find(c => c.id === id);
            
            if (!convidado) {
                mostrarNotificacao('Convidado não encontrado!', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">Editar Permissões - ${convidado.nome}</h3>
                            <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formEditarPermissoes" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Clientes Autorizados</label>
                                <div id="listaClientesEdicao" class="space-y-2 max-h-40 overflow-y-auto">
                                    <!-- Lista de clientes será carregada aqui -->
                                </div>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button type="button" onclick="fecharModalDIRETO()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                                    Cancelar
                                </button>
                                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                    Salvar Permissões
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Carregar lista de clientes com seleções atuais
            carregarClientesParaEdicao(convidado.clientesAutorizados);
            
            document.getElementById('formEditarPermissoes').addEventListener('submit', function(e) {
                e.preventDefault();
                const clientesSelecionados = Array.from(document.querySelectorAll('#listaClientesEdicao input[type="checkbox"]:checked'))
                    .map(cb => parseInt(cb.value));
                
                console.log('🔧 Formulário submetido, clientes selecionados:', clientesSelecionados);
                console.log('🔧 ID do convidado:', id);
                console.log('🔧 Chamando editarPermissoesConvidado...');
                
                editarPermissoesConvidado(id, clientesSelecionados);
                console.log('🔧 editarPermissoesConvidado chamado com sucesso');
                mostrarNotificacao('Permissões atualizadas com sucesso!', 'success');
                fecharModal();
            });
        }
        
        function carregarClientesParaEdicao(clientesAutorizados) {
            const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
            const container = document.getElementById('listaClientesEdicao');
            
            if (clientes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum cliente cadastrado</p>';
                return;
            }
            
            container.innerHTML = clientes.map(cliente => `
                <label class="flex items-center space-x-2">
                    <input type="checkbox" value="${cliente.id}" ${clientesAutorizados.includes(cliente.id) ? 'checked' : ''} class="rounded border-gray-300">
                    <span class="text-sm text-gray-700">${cliente.nome}</span>
                </label>
            `).join('');
        }
        
        function ativarDesativarConvidado(id, ativo) {
            ativarDesativarConvidado(id, ativo);
            mostrarNotificacao(`Convidado ${ativo ? 'ativado' : 'desativado'} com sucesso!`, 'success');
            carregarSecao('convidados');
        }
        
        function copiarCodigoConvidado(codigo) {
            navigator.clipboard.writeText(codigo).then(() => {
                mostrarNotificacao('Código copiado para a área de transferência!', 'success');
            }).catch(() => {
                // Fallback para navegadores mais antigos
                const textArea = document.createElement('textarea');
                textArea.value = codigo;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                mostrarNotificacao('Código copiado para a área de transferência!', 'success');
            });
        }

        function gerarMigracao() {
            console.log('🔧 gerarMigracao chamado');
            console.log('🔧 migracoes array:', migracoes);
            console.log('🔧 migracoes length:', migracoes ? migracoes.length : 'undefined');
            
            // FORÇAR CRIAÇÃO DE MIGRAÇÃO DE TESTE APENAS SE NÃO HÁ MIGRAÇÕES
            if (!migracoes || migracoes.length === 0) {
                console.log('🔧 FORÇANDO CRIAÇÃO DE MIGRAÇÃO DE TESTE');
                migracoes = [{
                    id: 999,
                    clienteId: 1,
                    clienteNome: 'TESTE IVA DEFINITIVO',
                    tipo: 'TESTE IVA',
                    descricao: 'TESTE PARA VERIFICAR IVA',
                    valor: 1000,
                    iva: 23,
                    valorComIva: 1230,
                    status: 'em_andamento',
                    dataInicio: new Date().toISOString().split('T')[0]
                }];
                console.log('🔧 MIGRAÇÃO DE TESTE CRIADA:', migracoes[0]);
            }
            
            // Garantir que migracoes existe
            if (!migracoes) {
                migracoes = [];
            }
            
            const totalMigracoes = migracoes.length;
            const migracoesAtivas = migracoes.filter(m => m.status === 'em_andamento').length;
            const migracoesSuspensas = migracoes.filter(m => m.status === 'pendente').length;
            const migracoesTerminadas = migracoes.filter(m => m.status === 'concluido').length;
            const valorTotalMigracoes = migracoes.reduce((total, m) => {
                const valor = parseFloat(m.valor) || 0;
                return total + valor;
            }, 0);

            return `
                <div class="space-y-6">
                    <!-- Header único com botões de ação -->
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-3">
                            <button onclick="abrirModalMigracaoDireto()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Nova Migração
                            </button>
                        </div>
                    </div>

                    <!-- Estatísticas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${migracoesAtivas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Suspensos</p>
                                    <p class="text-2xl font-bold text-gray-900">${migracoesSuspensas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Terminados</p>
                                    <p class="text-2xl font-bold text-gray-900">${migracoesTerminadas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">€${Number(valorTotalMigracoes).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de busca -->
                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaMigracoes" placeholder="Buscar migrações..." 
                                   class="search-input" onkeyup="filtrarMigracoes()">
                        </div>
                        
                        <!-- Filtros Avançados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusMigracao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosMigracoes()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="filtroTipoMigracao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosMigracoes()">
                                    <option value="">Todos os tipos</option>
                                    <option value="Autorização de residência">Autorização de residência</option>
                                    <option value="Certificados de residência permanente">Certificados de residência permanente</option>
                                    <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                    <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                    <option value="Renovação de autorizações">Renovação de autorizações</option>
                                    <option value="Vistos D7">Vistos D7</option>
                                    <option value="Vistos Gold">Vistos Gold</option>
                                    <option value="Vistos para estudantes">Vistos para estudantes</option>
                                    <option value="Vistos para trabalho">Vistos para trabalho</option>
                                </select>
                            </div>
                            
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIF</label>
                                <input type="text" id="filtroNifMigracao" placeholder="Buscar por NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosMigracoes()">
                                <!-- Campo NIF adicionado -->
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosMigracoes()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorMigracoes">0</span> migrações encontradas
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="overflow-x-auto table-responsive">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Descrição</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Data Início</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="listaMigracoes" class="bg-white divide-y divide-gray-200">
                                    ${migracoes.map(migracao => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${migracao.clienteNome || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.tipo || 'N/A'}</td>
                                            <td class="px-6 py-4 text-sm text-gray-500">${migracao.descricao || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <div class="text-sm font-bold text-black">€${(migracao.valor || 0).toFixed(2)}</div>
                                                <div class="text-xs font-bold text-red-600">+ IVA: €${((migracao.valor || 0) + ((migracao.valor || 0) * (migracao.iva || 0) / 100)).toFixed(2)}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="status-badge status-${migracao.status}">${migracao.status === 'concluido' ? 'Concluído' : migracao.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.dataInicio ? new Date(migracao.dataInicio).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button onclick="console.log('🔧 Botão editar clicado para ID:', ${migracao.id}); editarMigracaoDireto(${migracao.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar">
                                                    <i data-lucide="edit" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="abrirAnexosMigracao(${migracao.id})" class="text-green-600 hover:text-green-900 mr-2" title="Documentos">
                                                    <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="console.log('🔧 Botão excluir clicado para ID:', ${migracao.id}); excluirMigracaoDireto(${migracao.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarRegistos() {
            const totalRegistos = registos.length;
            const registosAtivos = registos.filter(r => r.status === 'em_andamento').length;
            const registosSuspensos = registos.filter(r => r.status === 'pendente').length;
            const registosTerminados = registos.filter(r => r.status === 'concluido').length;
            const valorTotalRegistos = registos.reduce((total, r) => total + (r.valorComIva || r.valor || 0), 0);

            return `
                <div class="space-y-6">
                    <!-- Header único com botões de ação -->
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-3">
                            <button onclick="abrirModalRegisto()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Novo Registo
                            </button>
                        </div>
                    </div>

                    <!-- Estatísticas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${registosAtivos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Suspensos</p>
                                    <p class="text-2xl font-bold text-gray-900">${registosSuspensos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Terminados</p>
                                    <p class="text-2xl font-bold text-gray-900">${registosTerminados}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">€${Number(valorTotalRegistos).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de busca -->
                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaRegistos" placeholder="Buscar registos..." 
                                   class="search-input" onkeyup="filtrarRegistos()">
                        </div>
                        
                        <!-- Filtros Avançados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusRegisto" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosRegistos()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="filtroTipoRegisto" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosRegistos()">
                                    <option value="">Todos os tipos</option>
                                    <option value="Autenticação de documentos">Autenticação de documentos</option>
                                    <option value="Certificação de fotocópias">Certificação de fotocópias</option>
                                    <option value="Documentos para o estrangeiro">Documentos para o estrangeiro</option>
                                    <option value="Procurações">Procurações</option>
                                    <option value="Reconhecimento presencial de assinaturas">Reconhecimento presencial de assinaturas</option>
                                    <option value="Registos automóveis">Registos automóveis</option>
                                    <option value="Registos comerciais">Registos comerciais</option>
                                    <option value="Registos de propriedade">Registos de propriedade</option>
                                    <option value="Termos de autenticação">Termos de autenticação</option>
                                </select>
                            </div>
                            
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIF</label>
                                <input type="text" id="filtroNifRegisto" placeholder="Buscar por NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosRegistos()">
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosRegistos()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorRegistos">0</span> registos encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="overflow-x-auto table-responsive">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Descrição</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Data Início</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                <tbody id="listaRegistos" class="bg-white divide-y divide-gray-200">
                    <!-- Conteúdo será carregado via atualizarListaRegistos() -->
                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }


        // === FUNÇÕES DE FILTRO ===

        function filtrarHerancas() {
            aplicarFiltrosHerancas();
        }

        function aplicarFiltrosHerancas() {
            const busca = document.getElementById('buscaHerancas')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusHeranca')?.value || '';
            const tipo = document.getElementById('filtroTipoHeranca')?.value || '';
            const nif = document.getElementById('filtroNifHeranca')?.value || '';
            
            const herancasFiltradas = herancas.filter(heranca => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    heranca.clienteNome.toLowerCase().includes(busca) || 
                    heranca.tipo.toLowerCase().includes(busca) ||
                    heranca.observacoes.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || heranca.status === status;
                
                // Filtro por tipo
                const matchTipo = !tipo || heranca.tipo === tipo;
                
                
                // Filtro por NIF
                const cliente = clientes.find(c => c.id === heranca.clienteId);
                const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));
                
                return matchBusca && matchStatus && matchTipo && matchNif;
            });
            
            atualizarListaHerancas(herancasFiltradas);
            document.getElementById('contadorHerancas').textContent = herancasFiltradas.length;
        }

        function limparFiltrosHerancas() {
            const elementos = [
                'buscaHerancas', 'filtroStatusHeranca', 'filtroTipoHeranca', 
                'filtroValorMinHeranca', 'filtroValorMaxHeranca', 'filtroNifHeranca'
            ];
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) elemento.value = '';
            });
            aplicarFiltrosHerancas();
        }

        function filtrarMigracoes() {
            aplicarFiltrosMigracoes();
        }

        function aplicarFiltrosMigracoes() {
            const busca = document.getElementById('buscaMigracoes')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusMigracao')?.value || '';
            const tipo = document.getElementById('filtroTipoMigracao')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinMigracao')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxMigracao')?.value) || Infinity;
            const nif = document.getElementById('filtroNifMigracao')?.value || '';
            
            const migracoesFiltradas = migracoes.filter(migracao => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    migracao.clienteNome.toLowerCase().includes(busca) || 
                    migracao.tipo.toLowerCase().includes(busca) ||
                    migracao.observacoes.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || migracao.status === status;
                
                // Filtro por tipo
                const matchTipo = !tipo || migracao.tipo === tipo;
                
                // Filtro por valor
                const valor = parseFloat(migracao.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                // Filtro por NIF
                const cliente = clientes.find(c => c.id === migracao.clienteId);
                const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));
                
                return matchBusca && matchStatus && matchTipo && matchValor && matchNif;
            });
            
            atualizarListaMigracoes(migracoesFiltradas);
            document.getElementById('contadorMigracoes').textContent = migracoesFiltradas.length;
        }

        function limparFiltrosMigracoes() {
            const elementos = [
                'buscaMigracoes', 'filtroStatusMigracao', 'filtroTipoMigracao', 
                'filtroValorMinMigracao', 'filtroValorMaxMigracao', 'filtroNifMigracao'
            ];
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) elemento.value = '';
            });
            aplicarFiltrosMigracoes();
        }

        function filtrarRegistos() {
            aplicarFiltrosRegistos();
        }

        function aplicarFiltrosRegistos() {
            const busca = document.getElementById('buscaRegistos')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusRegisto')?.value || '';
            const tipo = document.getElementById('filtroTipoRegisto')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinRegisto')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxRegisto')?.value) || Infinity;
            const nif = document.getElementById('filtroNifRegisto')?.value || '';
            
            const registosFiltrados = registos.filter(registo => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    registo.clienteNome.toLowerCase().includes(busca) || 
                    registo.tipo.toLowerCase().includes(busca) ||
                    registo.observacoes.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || registo.status === status;
                
                // Filtro por tipo
                const matchTipo = !tipo || registo.tipo === tipo;
                
                // Filtro por valor
                const valor = parseFloat(registo.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                // Filtro por NIF
                const cliente = clientes.find(c => c.id === registo.clienteId);
                const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));
                
                return matchBusca && matchStatus && matchTipo && matchValor && matchNif;
            });
            
            atualizarListaRegistos(registosFiltrados);
            document.getElementById('contadorRegistos').textContent = registosFiltrados.length;
        }

        function limparFiltrosRegistos() {
            const elementos = [
                'buscaRegistos', 'filtroStatusRegisto', 'filtroTipoRegisto', 
                'filtroValorMinRegisto', 'filtroValorMaxRegisto', 'filtroNifRegisto'
            ];
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) elemento.value = '';
            });
            aplicarFiltrosRegistos();
        }

        function filtrarPrazos() {
            aplicarFiltrosPrazos();
        }

        function aplicarFiltrosPrazos() {
            const busca = document.getElementById('buscaPrazos')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusPrazo')?.value || '';
            const tipo = document.getElementById('filtroTipoPrazo')?.value || '';
            const vencimento = document.getElementById('filtroVencimentoPrazo')?.value || '';
            const prioridade = document.getElementById('filtroPrioridadePrazo')?.value || '';
            
            const prazosFiltrados = prazos.filter(prazo => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    prazo.clienteNome.toLowerCase().includes(busca) || 
                    prazo.descricao.toLowerCase().includes(busca) ||
                    prazo.tipo.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || prazo.status === status;
                
                // Filtro por tipo
                const matchTipo = !tipo || prazo.tipo === tipo;
                
                // Filtro por vencimento
                let matchVencimento = true;
                if (vencimento && prazo.dataLimite) {
                    const dataLimite = new Date(prazo.dataLimite);
                    const hoje = new Date();
                    
                    switch (vencimento) {
                        case 'hoje':
                            matchVencimento = dataLimite.toDateString() === hoje.toDateString();
                            break;
                        case 'semana':
                            const fimSemana = new Date(hoje);
                            fimSemana.setDate(hoje.getDate() + 7);
                            matchVencimento = dataLimite >= hoje && dataLimite <= fimSemana;
                            break;
                        case 'mes':
                            const fimMes = new Date(hoje);
                            fimMes.setMonth(hoje.getMonth() + 1);
                            matchVencimento = dataLimite >= hoje && dataLimite <= fimMes;
                            break;
                        case 'vencido':
                            matchVencimento = dataLimite < hoje;
                            break;
                    }
                }
                
                // Filtro por prioridade
                const matchPrioridade = !prioridade || prazo.prioridade === prioridade;
                
                return matchBusca && matchStatus && matchTipo && matchVencimento && matchPrioridade;
            });
            
            atualizarListaPrazos(prazosFiltrados);
            document.getElementById('contadorPrazos').textContent = prazosFiltrados.length;
        }

        function limparFiltrosPrazos() {
            const elementos = [
                'buscaPrazos', 'filtroStatusPrazo', 'filtroTipoPrazo', 
                'filtroVencimentoPrazo', 'filtroPrioridadePrazo'
            ];
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) elemento.value = '';
            });
            aplicarFiltrosPrazos();
        }

        function atualizarListaPrazos(prazosFiltrados) {
            const tbody = document.getElementById('listaPrazos');
            if (!tbody) return;
            
            tbody.innerHTML = prazosFiltrados.map(prazo => `
                <tr>
                    <td>${prazo.clienteNome}</td>
                    <td>${prazo.tipo}</td>
                    <td>${prazo.descricao}</td>
                    <td>${new Date(prazo.dataLimite).toLocaleDateString('pt-PT')}</td>
                    <td><span class="status-badge status-${prazo.prioridade}">${prazo.prioridade}</span></td>
                    <td><span class="status-badge status-${prazo.status}">${prazo.status === 'concluido' ? 'Concluído' : prazo.status === 'vencido' ? 'Vencido' : prazo.status === 'cancelado' ? 'Cancelado' : 'Ativo'}</span></td>
                    <td>
                        <button onclick="editarItem('prazo', ${prazo.id})" class="text-blue-600 hover:text-blue-800">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirItem('prazo', ${prazo.id})" class="text-red-600 hover:text-red-800 ml-2">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }


        // === FUNÇÕES DE ATUALIZAÇÃO DE LISTAS ===

        function atualizarListaHerancas(herancasFiltradas) {
            console.log('🔧 atualizarListaHerancas REABILITADO - carregando heranças reais');
            console.log('🔧 herancasFiltradas:', herancasFiltradas);
            console.log('🔧 herancasFiltradas.length:', herancasFiltradas ? herancasFiltradas.length : 'undefined');
            
            const tbody = document.getElementById('listaHerancas');
            if (!tbody) {
                console.log('❌ tbody listaHerancas não encontrado');
                return;
            }
            console.log('✅ tbody listaHerancas encontrado');
            
            const html = herancasFiltradas.map(heranca => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${heranca.clienteNome || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${heranca.tipo || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${heranca.descricao || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="text-sm font-bold text-black">€${Number(heranca.valor || 0).toFixed(2)}</div>
                        <div class="text-xs font-bold text-red-600">+ IVA: €${(Number(heranca.valor || 0) + (Number(heranca.valor || 0) * Number(heranca.iva || 0) / 100)).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge status-${heranca.status || 'pendente'}">${heranca.status || 'Pendente'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${heranca.dataInicio || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editarHerancaDireto(${heranca.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="abrirAnexosHeranca(${heranca.id})" class="text-green-600 hover:text-green-900 mr-2" title="Documentos">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirHerancaDireto(${heranca.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html;
            console.log('✅ HTML inserido no tbody listaHerancas');
            console.log('🔧 TESTE: Verificando se tbody tem conteúdo:', tbody.innerHTML.length);
            
            // FORÇAR RENDERIZAÇÃO DOS ÍCONES
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('🔧 Ícones Lucide renderizados');
                }
            }, 100);
        }

        function atualizarListaMigracoes(migracoesFiltradas) {
            const tbody = document.getElementById('listaMigracoes');
            if (!tbody) return;
            
            tbody.innerHTML = migracoesFiltradas.map(migracao => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${migracao.clienteNome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.tipo}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${migracao.descricao}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="text-sm font-bold text-black">€${(migracao.valor || 0).toFixed(2)}</div>
                        <div class="text-xs font-bold text-red-600">+ IVA: €${((migracao.valor || 0) + ((migracao.valor || 0) * (migracao.iva || 0) / 100)).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge status-${migracao.status}">${migracao.status === 'concluido' ? 'Concluído' : migracao.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.dataInicio ? new Date(migracao.dataInicio).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editarMigracaoSimples(${migracao.id})" class="text-blue-600 hover:text-blue-900 mr-3" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="abrirAnexosMigracao(${migracao.id})" class="text-green-600 hover:text-green-900 mr-3" title="Documentos">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirMigracao(${migracao.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function atualizarListaRegistos(registosFiltrados) {
            console.log('🔧 atualizarListaRegistos REABILITADO - carregando registos reais');
            console.log('🔧 registosFiltrados:', registosFiltrados);
            console.log('🔧 registosFiltrados.length:', registosFiltrados ? registosFiltrados.length : 'undefined');
            
            const tbody = document.getElementById('listaRegistos');
            if (!tbody) {
                console.log('❌ tbody listaRegistos não encontrado');
                return;
            }
            console.log('✅ tbody listaRegistos encontrado');
            
            const html = registosFiltrados.map(registo => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${registo.clienteNome || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registo.tipo || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${registo.descricao || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="text-sm font-bold text-black">€${Number(registo.valor || 0).toFixed(2)}</div>
                        <div class="text-xs font-bold text-red-600">+ IVA: €${(Number(registo.valor || 0) + (Number(registo.valor || 0) * Number(registo.iva || 0) / 100)).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge status-${registo.status || 'pendente'}">${registo.status || 'Pendente'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registo.dataInicio || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editarRegistoDireto(${registo.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="abrirAnexosRegisto(${registo.id})" class="text-green-600 hover:text-green-900 mr-2" title="Documentos">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirRegistoDireto(${registo.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html;
            console.log('✅ HTML inserido no tbody listaRegistos');
            console.log('🔧 TESTE: Verificando se tbody tem conteúdo:', tbody.innerHTML.length);
            console.log('🔧 HTML gerado:', html.substring(0, 500) + '...');
            
            // FORÇAR RENDERIZAÇÃO DOS ÍCONES
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('🔧 Ícones Lucide renderizados');
                }
            }, 100);
        }


        // === FUNÇÕES DE MODAL E CRUD ===

        function abrirModalHeranca() {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalDIRETO()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Nova Herança</h3>
                                <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form id="formHeranca" onsubmit="salvarHeranca(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Aceitação da herança">Aceitação da herança</option>
                                            <option value="Doações">Doações</option>
                                            <option value="Escrituras de partilha">Escrituras de partilha</option>
                                            <option value="Habilitação de herdeiros">Habilitação de herdeiros</option>
                                            <option value="Partilhas em vida">Partilhas em vida</option>
                                            <option value="Partilhas por óbito">Partilhas por óbito</option>
                                            <option value="Processo de inventário">Processo de inventário</option>
                                            <option value="Renúncia à herança">Renúncia à herança</option>
                                            <option value="Testamentos">Testamentos</option>
                                            <option value="Inventário">Inventário</option>
                                            <option value="Partilha">Partilha</option>
                                            <option value="Testamento">Testamento</option>
                                            <option value="Doação">Doação</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select name="iva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0">0% (Isento)</option>
                                                <option value="6">6% (Reduzida)</option>
                                                <option value="13">13% (Intermédia)</option>
                                                <option value="23" selected>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                            <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('heranca')">
                                                <option value="sem">Sem parceria</option>
                                                <option value="empresa">Empresa</option>
                                                <option value="pessoa">Pessoa</option>
                                            </select>
                                        </div>
                                        
                                        <div id="herancaParceriaNomeDiv" style="display: none;">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                            <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                            <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente">Pendente</option>
                                                <option value="em_andamento">Em Andamento</option>
                                                <option value="concluido">Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                            <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre a herança..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Herança
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        function criarModalMigracao() {
            return `
                <div class="modal show" onclick="fecharModalDIRETO()">
                    <div class="modal-content p-6" style="max-width: 600px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Nova Migração</h3>
                            <button onclick="fecharModalDIRETO()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formMigracao" onsubmit="salvarMigracao(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                    <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Autorização de residência">Autorização de residência</option>
                                        <option value="Certificados de residência permanente">Certificados de residência permanente</option>
                                        <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                        <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                        <option value="Renovação de autorizações">Renovação de autorizações</option>
                                        <option value="Vistos D7">Vistos D7</option>
                                        <option value="Vistos Gold">Vistos Gold</option>
                                        <option value="Vistos para estudantes">Vistos para estudantes</option>
                                        <option value="Vistos para trabalho">Vistos para trabalho</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor (€) *</label>
                                        <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="0.00">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <input type="number" name="iva" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="23" value="23">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                                        <select name="status" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente">Pendente</option>
                                            <option value="em_andamento">Em Andamento</option>
                                            <option value="concluido">Concluído</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Início *</label>
                                    <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                    <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre a migração..."></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Migração
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function abrirModalMigracaoDireto() {
            console.log('🔧 abrirModalMigracaoDireto chamado');
            
            // Fechar qualquer modal aberto
            fecharModal();
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalNovaMigracao';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Nova Migração</h3>
                            <button onclick="document.getElementById('modalNovaMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form id="formMigracao" onsubmit="salvarMigracao(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                    <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Autorização de residência">Autorização de residência</option>
                                        <option value="Certificados de residência permanente">Certificados de residência permanente</option>
                                        <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                        <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                        <option value="Renovação de autorizações">Renovação de autorizações</option>
                                        <option value="Vistos D7">Vistos D7</option>
                                        <option value="Vistos Gold">Vistos Gold</option>
                                        <option value="Vistos para estudantes">Vistos para estudantes</option>
                                        <option value="Vistos para trabalho">Vistos para trabalho</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor (€) *</label>
                                        <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="0.00">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <input type="number" name="iva" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="23" value="23">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                                        <select name="status" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente">Pendente</option>
                                            <option value="em_andamento">Em Andamento</option>
                                            <option value="concluido">Concluído</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Início *</label>
                                    <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                    <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('migracao')">
                                        <option value="sem">Sem parceria</option>
                                        <option value="empresa">Empresa</option>
                                        <option value="pessoa">Pessoa</option>
                                    </select>
                                </div>
                                
                                <div id="migracaoParceriaNomeDiv" style="display: none;">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                    <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                    <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                    <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre a migração..."></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="document.getElementById('modalNovaMigracao').remove()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Migração
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('✅ Modal de migração criado e adicionado ao body');
        }
        
        // Tornar função global
        window.abrirModalMigracaoDireto = abrirModalMigracaoDireto;

        function abrirModalMigracao() {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalDIRETO()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Nova Migração</h3>
                                <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form id="formMigracao" onsubmit="salvarMigracao(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autorização de residência">Autorização de residência</option>
                                            <option value="Certificados de residência permanente">Certificados de residência permanente</option>
                                            <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                            <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                            <option value="Renovação de autorizações">Renovação de autorizações</option>
                                            <option value="Vistos D7">Vistos D7</option>
                                            <option value="Vistos Gold">Vistos Gold</option>
                                            <option value="Vistos para estudantes">Vistos para estudantes</option>
                                            <option value="Vistos para trabalho">Vistos para trabalho</option>
                                            <option value="Nacionalidade">Nacionalidade</option>
                                            <option value="Residência">Residência</option>
                                            <option value="Visto">Visto</option>
                                            <option value="Reagrupamento">Reagrupamento</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select name="iva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0">0% (Isento)</option>
                                                <option value="6">6% (Reduzida)</option>
                                                <option value="13">13% (Intermédia)</option>
                                                <option value="23" selected>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                            <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('heranca')">
                                                <option value="sem">Sem parceria</option>
                                                <option value="empresa">Empresa</option>
                                                <option value="pessoa">Pessoa</option>
                                            </select>
                                        </div>
                                        
                                        <div id="herancaParceriaNomeDiv" style="display: none;">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                            <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                            <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente">Pendente</option>
                                                <option value="em_andamento">Em Andamento</option>
                                                <option value="concluido">Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                            <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre a migração..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Migração
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        function abrirModalRegisto() {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalDIRETO()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Novo Registo</h3>
                                <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form id="formRegisto" onsubmit="salvarRegisto(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autenticação de documentos">Autenticação de documentos</option>
                                            <option value="Certificação de fotocópias">Certificação de fotocópias</option>
                                            <option value="Documentos para o estrangeiro">Documentos para o estrangeiro</option>
                                            <option value="Procurações">Procurações</option>
                                            <option value="Reconhecimento presencial de assinaturas">Reconhecimento presencial de assinaturas</option>
                                            <option value="Registos automóveis">Registos automóveis</option>
                                            <option value="Registos comerciais">Registos comerciais</option>
                                            <option value="Registos de propriedade">Registos de propriedade</option>
                                            <option value="Termos de autenticação">Termos de autenticação</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select name="iva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0">0% (Isento)</option>
                                                <option value="6">6% (Reduzida)</option>
                                                <option value="13">13% (Intermédia)</option>
                                                <option value="23" selected>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                            <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('heranca')">
                                                <option value="sem">Sem parceria</option>
                                                <option value="empresa">Empresa</option>
                                                <option value="pessoa">Pessoa</option>
                                            </select>
                                        </div>
                                        
                                        <div id="herancaParceriaNomeDiv" style="display: none;">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                            <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                            <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente">Pendente</option>
                                                <option value="em_andamento">Em Andamento</option>
                                                <option value="concluido">Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                            <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre o registo..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Registo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        // === FUNÇÕES DE SALVAMENTO ===

        function salvarHeranca(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const clienteId = parseInt(formData.get('clienteId'));
            const cliente = clientes.find(c => c.id === clienteId);
            
            const valor = parseFloat(formData.get('valor')) || 0;
            const iva = parseFloat(formData.get('iva')) || 0;
            const percentagem = parseFloat(formData.get('percentagem')) || 0;
            const valorComIva = valor + (valor * iva / 100);

            const novaHeranca = {
                id: herancas.length > 0 ? Math.max(...herancas.map(h => h.id)) + 1 : 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
                tipo: formData.get('tipo'),
                descricao: formData.get('descricao'),
                valor: valor,
                iva: iva,
                percentagem: percentagem,
                valorComIva: valorComIva,
                status: formData.get('status'),
                dataInicio: formData.get('dataInicio'),
                observacoes: formData.get('observacoes'),
                dataCriacao: new Date().toISOString()
            };

            herancas.unshift(novaHeranca);
            salvarDados('herancas', herancas);
            
            // Criar prazo automático para a herança
            const prazoHeranca = {
                id: Date.now() + 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
                descricao: `Prazo para ${novaHeranca.tipo} - ${novaHeranca.descricao}`,
                dataLimite: new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 60 dias
                status: 'ativo',
                tipo: 'heranca',
                referenciaId: novaHeranca.id,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoHeranca);
            salvarDados('prazos', prazos);
            
            mostrarNotificacao('Herança e prazo criados com sucesso!', 'success');
            fecharModal();
            carregarSecao('herancas');
            
            // Atualizar lista após salvar
            setTimeout(() => {
                if (typeof atualizarListaHerancas === 'function') {
                    atualizarListaHerancas(herancas);
                }
            }, 200);
        }

        function salvarMigracao(event) {
            try {
            event.preventDefault();
                console.log('🔧 salvarMigracao iniciado');
                console.log('🔧 FormData:', event.target);
                
            const formData = new FormData(event.target);
            const clienteId = parseInt(formData.get('clienteId'));
            const cliente = clientes.find(c => c.id === clienteId);
            
            const valor = parseFloat(formData.get('valor')) || 0;
            const iva = parseFloat(formData.get('iva')) || 0;
            const percentagem = parseFloat(formData.get('percentagem')) || 0;
            const valorComIva = valor + (valor * iva / 100);
                
                console.log('🔧 Valores calculados:');
                console.log('🔧 valor:', valor);
                console.log('🔧 iva:', iva);
                console.log('🔧 valorComIva:', valorComIva);

            const novaMigracao = {
                id: migracoes.length > 0 ? Math.max(...migracoes.map(m => m.id)) + 1 : 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
                tipo: formData.get('tipo'),
                    descricao: '', // Campo não existe no modal de Migração
                valor: valor,
                iva: iva,
                percentagem: percentagem,
                valorComIva: valorComIva,
                status: formData.get('status'),
                dataInicio: formData.get('dataInicio'),
                    parceria: formData.get('parceria'),
                    parceriaNome: formData.get('parceriaNome'),
                observacoes: formData.get('observacoes'),
                dataCriacao: new Date().toISOString()
            };

                console.log('🔧 Nova migração criada:', novaMigracao);
            migracoes.unshift(novaMigracao);
            salvarDados('migracoes', migracoes);
                console.log('🔧 Migração salva no localStorage');
            
            // Criar prazo automático para a migração
            const prazoMigracao = {
                id: Date.now() + 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
                    descricao: `Prazo para ${novaMigracao.tipo}`,
                dataLimite: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 90 dias
                status: 'ativo',
                tipo: 'migracao',
                referenciaId: novaMigracao.id,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoMigracao);
            salvarDados('prazos', prazos);
                console.log('🔧 Prazo criado e salvo');
            
            mostrarNotificacao('Processo de migração e prazo criados com sucesso!', 'success');
            fecharModal();
                
                console.log('🔧 Tentando carregar seção migracoes');
                console.log('🔧 Migrações após salvar:', migracoes);
                setTimeout(() => {
                    carregarSecao('migracoes');
                }, 100);
                
            } catch (error) {
                console.error('❌ Erro ao salvar migração:', error);
                mostrarNotificacao('Erro ao salvar migração: ' + error.message, 'error');
            }
        }

        function salvarRegisto(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const clienteId = parseInt(formData.get('clienteId'));
            const cliente = clientes.find(c => c.id === clienteId);
            
            const valor = parseFloat(formData.get('valor')) || 0;
            const iva = parseFloat(formData.get('iva')) || 0;
            const percentagem = parseFloat(formData.get('percentagem')) || 0;
            const valorComIva = valor + (valor * iva / 100);

            const novoRegisto = {
                id: registos.length > 0 ? Math.max(...registos.map(r => r.id)) + 1 : 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
                tipo: formData.get('tipo'),
                descricao: formData.get('descricao'),
                valor: valor,
                iva: iva,
                percentagem: percentagem,
                valorComIva: valorComIva,
                status: formData.get('status'),
                dataInicio: formData.get('dataInicio'),
                observacoes: formData.get('observacoes'),
                dataCriacao: new Date().toISOString()
            };

            registos.unshift(novoRegisto);
            salvarDados('registos', registos);
            
            // Criar prazo automático para o registo
            const prazoRegisto = {
                id: Date.now() + 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
                descricao: `Prazo para ${novoRegisto.tipo} - ${novoRegisto.descricao}`,
                dataLimite: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 15 dias
                status: 'ativo',
                tipo: 'registo',
                referenciaId: novoRegisto.id,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoRegisto);
            salvarDados('prazos', prazos);
            
            mostrarNotificacao('Registo e prazo criados com sucesso!', 'success');
            fecharModal();
            
            // FORÇAR RECARREGAMENTO IMEDIATO
            console.log('🔧 FORÇANDO RECARREGAMENTO APÓS SALVAR REGISTO');
            console.log('🔧 registos após salvar:', registos);
            
            // Recarregar seção
            setTimeout(() => {
                carregarSecao('registos');
            }, 100);
            
            // Atualizar lista após salvar
            setTimeout(() => {
                console.log('🔧 CHAMANDO atualizarListaRegistos após salvar');
                if (typeof atualizarListaRegistos === 'function') {
                    atualizarListaRegistos(registos);
                    console.log('✅ atualizarListaRegistos executado após salvar');
                } else {
                    console.error('❌ atualizarListaRegistos não é uma função após salvar');
                }
            }, 300);
        }

        // === FUNÇÕES DE EDIÇÃO E EXCLUSÃO ===

        function editarHeranca(id) {
            const heranca = herancas.find(h => h.id === id);
            if (!heranca) return;

            abrirModalHeranca();
            // Preencher formulário com dados existentes
            setTimeout(() => {
                const form = document.getElementById('formHeranca');
                if (form) {
                    form.clienteId.value = heranca.clienteId;
                    form.tipo.value = heranca.tipo;
                    form.descricao.value = heranca.descricao || '';
                    form.valor.value = heranca.valor || '';
                    form.iva.value = heranca.iva || 23;
                    form.status.value = heranca.status;
                    form.dataInicio.value = heranca.dataInicio || '';
                    form.observacoes.value = heranca.observacoes || '';
                    
                    // Alterar título do modal
                    document.querySelector('#modalContainer h3').textContent = 'Editar Herança';
                    
                    // Adicionar campo hidden para ID
                    const hiddenId = document.createElement('input');
                    hiddenId.type = 'hidden';
                    hiddenId.name = 'id';
                    hiddenId.value = heranca.id;
                    form.appendChild(hiddenId);
                }
            }, 100);
        }

        function editarMigracao(id) {
            const migracao = migracoes.find(m => m.id === id);
            if (!migracao) return;

            abrirModalMigracao();
            setTimeout(() => {
                const form = document.getElementById('formMigracao');
                if (form) {
                    form.clienteId.value = migracao.clienteId;
                    form.tipo.value = migracao.tipo;
                    form.descricao.value = migracao.descricao || '';
                    form.valor.value = migracao.valor || '';
                    form.iva.value = migracao.iva || 23;
                    form.status.value = migracao.status;
                    form.dataInicio.value = migracao.dataInicio || '';
                    form.observacoes.value = migracao.observacoes || '';
                    
                    document.querySelector('#modalContainer h3').textContent = 'Editar Processo de Migração';
                    
                    const hiddenId = document.createElement('input');
                    hiddenId.type = 'hidden';
                    hiddenId.name = 'id';
                    hiddenId.value = migracao.id;
                    form.appendChild(hiddenId);
                }
            }, 100);
        }

        function editarRegisto(id) {
            const registo = registos.find(r => r.id === id);
            if (!registo) return;

            abrirModalRegisto();
            setTimeout(() => {
                const form = document.getElementById('formRegisto');
                if (form) {
                    form.clienteId.value = registo.clienteId;
                    form.tipo.value = registo.tipo;
                    form.descricao.value = registo.descricao || '';
                    form.valor.value = registo.valor || '';
                    form.iva.value = registo.iva || 23;
                    form.status.value = registo.status;
                    form.dataInicio.value = registo.dataInicio || '';
                    form.observacoes.value = registo.observacoes || '';
                    
                    document.querySelector('#modalContainer h3').textContent = 'Editar Registo';
                    
                    const hiddenId = document.createElement('input');
                    hiddenId.type = 'hidden';
                    hiddenId.name = 'id';
                    hiddenId.value = registo.id;
                    form.appendChild(hiddenId);
                }
            }, 100);
        }

        function excluirHeranca(id) {
            if (confirm('Tem certeza que deseja excluir esta herança?')) {
                herancas = herancas.filter(h => h.id !== id);
                salvarDados('herancas', herancas);
                mostrarNotificacao('Herança excluída com sucesso!', 'success');
                carregarSecao('herancas');
            }
        }

        function excluirMigracao(id) {
            if (confirm('Tem certeza que deseja excluir este processo de migração?')) {
                migracoes = migracoes.filter(m => m.id !== id);
                salvarDados('migracoes', migracoes);
                mostrarNotificacao('Processo de migração excluído com sucesso!', 'success');
                carregarSecao('migracao');
            }
        }

        function excluirRegisto(id) {
            if (confirm('Tem certeza que deseja excluir este registo?')) {
                registos = registos.filter(r => r.id !== id);
                salvarDados('registos', registos);
                mostrarNotificacao('Registo excluído com sucesso!', 'success');
                carregarSecao('registos');
            }
        }

        // === SISTEMA DE ANEXOS DE DOCUMENTOS ===
        
        function abrirAnexosCliente(clienteId) {
            // Bloqueio opcional para evitar reabertura imediata após salvar
            if (window.__bloquearReaberturaModalAnexos === true) {
                console.log('⚠️ Reabertura do modal de anexos bloqueada temporariamente.');
                window.__bloquearReaberturaModalAnexos = false;
                return;
            }
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) return;
            
            // Inicializar array de anexos se não existir
            if (!cliente.anexos) {
                cliente.anexos = [];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalDIRETO()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos de ${cliente.nome}</h3>
                                <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <!-- Upload de novos documentos -->
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexo(event, ${clienteId})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('cliente')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="identificacao">Identificação</option>
                                                <option value="contrato">Contrato</option>
                                                <option value="certificado">Certificado</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizadoCliente" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrição (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descrição do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Lista de documentos existentes -->
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${cliente.anexos.length})</h4>
                                ${cliente.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${cliente.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} • ${anexo.tamanho} • ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexo(${clienteId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }
        
        function adicionarAnexo(event, clienteId) {
            event.preventDefault();
            if (event && typeof event.stopPropagation === 'function') {
                event.stopPropagation();
            }
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            // Usar tipo personalizado se "outro" foi selecionado
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Não fechar imediatamente: só no sucesso ou pelo X

            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const cliente = clientes.find(c => c.id === clienteId);
                if (cliente) {
                    if (!cliente.anexos) cliente.anexos = [];
                    cliente.anexos.push(anexo);
                    salvarDados('clientes', clientes);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    // Fechar modal após salvar
                    fecharModalDIRETO();
                }
            });
        }
        
        function formatarTamanho(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Função para formatar valor com IVA incorporado
        function formatarValorComIva(valor, iva, valorComIva) {
            const valorNum = parseFloat(valor) || 0;
            const ivaNum = parseFloat(iva) || 0;
            const valorComIvaNum = parseFloat(valorComIva) || 0;
            
            // Calcular valor com IVA se não foi fornecido
            const valorComIvaCalculado = valorComIvaNum > 0 ? valorComIvaNum : valorNum + (valorNum * ivaNum / 100);
            
            const valorFormatado = (Math.round(valorNum * 100) / 100).toFixed(2);
            const valorComIvaFormatado = (Math.round(valorComIvaCalculado * 100) / 100).toFixed(2);
            
            return `
                <div class="flex flex-col">
                    <div class="text-sm font-medium text-gray-900">€${valorFormatado}</div>
                    <div class="text-xs text-gray-500">
                        <span class="text-gray-400">+ ${ivaNum}% IVA:</span>
                        <span class="font-medium text-gray-700">€${valorComIvaFormatado}</span>
                    </div>
                </div>
            `;
        }
        
        function visualizarAnexo(anexoId) {
            console.log('🔧 visualizarAnexo chamado com ID:', anexoId);
            
            // Buscar anexo em todas as fontes
            let anexo = null;
            let tipo = '';
            
            // Buscar em contratos
            const contratosSalvos = localStorage.getItem('contratos');
            if (contratosSalvos) {
                const contratos = JSON.parse(contratosSalvos);
                for (const contrato of contratos) {
                    if (contrato.anexos) {
                        anexo = contrato.anexos.find(a => a.id === anexoId);
                        if (anexo) {
                            tipo = 'contrato';
                            break;
                        }
                    }
                }
            }
            
            // Buscar em heranças
            if (!anexo) {
                const herancasSalvas = localStorage.getItem('herancas');
                if (herancasSalvas) {
                    const herancas = JSON.parse(herancasSalvas);
                    for (const heranca of herancas) {
                        if (heranca.anexos) {
                            anexo = heranca.anexos.find(a => a.id === anexoId);
                            if (anexo) {
                                tipo = 'heranca';
                                break;
                            }
                        }
                    }
                }
            }
            
            // Buscar em migrações
            if (!anexo) {
                const migracoesSalvas = localStorage.getItem('migracoes');
                if (migracoesSalvas) {
                    const migracoes = JSON.parse(migracoesSalvas);
                    for (const migracao of migracoes) {
                        if (migracao.anexos) {
                            anexo = migracao.anexos.find(a => a.id === anexoId);
                            if (anexo) {
                                tipo = 'migracao';
                                break;
                            }
                        }
                    }
                }
            }
            
            // Buscar em registos
            if (!anexo) {
                const registosSalvos = localStorage.getItem('registos');
                if (registosSalvos) {
                    const registos = JSON.parse(registosSalvos);
                    for (const registo of registos) {
                        if (registo.anexos) {
                            anexo = registo.anexos.find(a => a.id === anexoId);
                            if (anexo) {
                                tipo = 'registo';
                                break;
                            }
                        }
                    }
                }
            }
            
            // Buscar em clientes
            if (!anexo) {
                const clientesSalvos = localStorage.getItem('clientes');
                if (clientesSalvos) {
                    const clientes = JSON.parse(clientesSalvos);
                    for (const cliente of clientes) {
                        if (cliente.anexos) {
                            anexo = cliente.anexos.find(a => a.id === anexoId);
                            if (anexo) {
                                tipo = 'cliente';
                                break;
                            }
                        }
                    }
                }
            }
            
            if (!anexo) {
                mostrarNotificacao('Documento não encontrado!', 'error');
                return;
            }
            
            // Determinar tipo de arquivo
            const extensao = anexo.nome.split('.').pop().toLowerCase();
            const isImagem = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extensao);
            const isPDF = extensao === 'pdf';
            const isDocumento = ['doc', 'docx', 'txt', 'rtf'].includes(extensao);
            
            // Criar modal de visualização
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onclick="fecharModalDIRETO()">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-900">${anexo.nome}</h3>
                                <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <div class="mb-4 text-sm text-gray-600">
                                <p><strong>Tipo:</strong> ${anexo.tipo}</p>
                                <p><strong>Tamanho:</strong> ${anexo.tamanho}</p>
                                <p><strong>Data:</strong> ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                ${anexo.descricao ? `<p><strong>Descrição:</strong> ${anexo.descricao}</p>` : ''}
                            </div>
                            
                            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                ${isImagem ? `
                                    <div class="text-center">
                                        <img src="${anexo.conteudo}" alt="${anexo.nome}" class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg">
                                    </div>
                                ` : isPDF ? `
                                    <div class="text-center">
                                        <iframe src="${anexo.conteudo}" width="100%" height="500px" class="rounded-lg border-0"></iframe>
                                    </div>
                                ` : isDocumento ? `
                                    <div class="text-center py-8">
                                        <i data-lucide="file-text" class="w-16 h-16 mx-auto mb-4 text-blue-600"></i>
                                        <p class="text-gray-600 mb-4">Visualização não disponível para este tipo de arquivo</p>
                                        <button onclick="baixarAnexo('${anexoId}')" class="btn btn-primary">
                                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                            Baixar Documento
                                        </button>
                                    </div>
                                ` : `
                                    <div class="text-center py-8">
                                        <i data-lucide="file" class="w-16 h-16 mx-auto mb-4 text-gray-600"></i>
                                        <p class="text-gray-600 mb-4">Visualização não disponível para este tipo de arquivo</p>
                                        <button onclick="baixarAnexo('${anexoId}')" class="btn btn-primary">
                                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                            Baixar Arquivo
                                        </button>
                                    </div>
                                `}
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-4">
                                <button onclick="baixarAnexo('${anexoId}')" class="btn btn-secondary">
                                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                    Baixar
                                </button>
                                <button onclick="fecharModalDIRETO()" class="btn btn-primary">
                                    <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                    Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Adicionar modal ao body
            const modalElement = document.createElement('div');
            modalElement.innerHTML = modal;
            document.body.appendChild(modalElement.firstElementChild);
            lucide.createIcons();
        }
        
        function baixarAnexo(anexoId) {
            console.log('🔧 baixarAnexo chamado com ID:', anexoId);
            console.log('🔧 Buscando anexo com ID:', anexoId);
            
            // Buscar anexo em todas as fontes
            let anexo = null;
            
            // Buscar em contratos
            const contratosSalvos = localStorage.getItem('contratos');
            if (contratosSalvos) {
                const contratos = JSON.parse(contratosSalvos);
                for (const contrato of contratos) {
                    if (contrato.anexos) {
                        anexo = contrato.anexos.find(a => a.id === anexoId);
                        if (anexo) break;
                    }
                }
            }
            
            // Buscar em heranças
            if (!anexo) {
                const herancasSalvas = localStorage.getItem('herancas');
                if (herancasSalvas) {
                    const herancas = JSON.parse(herancasSalvas);
                    for (const heranca of herancas) {
                        if (heranca.anexos) {
                            anexo = heranca.anexos.find(a => a.id === anexoId);
                            if (anexo) break;
                        }
                    }
                }
            }
            
            // Buscar em migrações
            if (!anexo) {
                const migracoesSalvas = localStorage.getItem('migracoes');
                if (migracoesSalvas) {
                    const migracoes = JSON.parse(migracoesSalvas);
                    for (const migracao of migracoes) {
                        if (migracao.anexos) {
                            anexo = migracao.anexos.find(a => a.id === anexoId);
                            if (anexo) break;
                        }
                    }
                }
            }
            
            // Buscar em registos
            if (!anexo) {
                const registosSalvos = localStorage.getItem('registos');
                if (registosSalvos) {
                    const registos = JSON.parse(registosSalvos);
                    for (const registo of registos) {
                        if (registo.anexos) {
                            anexo = registo.anexos.find(a => a.id === anexoId);
                            if (anexo) break;
                        }
                    }
                }
            }
            
            // Buscar em clientes
            if (!anexo) {
                const clientesSalvos = localStorage.getItem('clientes');
                if (clientesSalvos) {
                    const clientes = JSON.parse(clientesSalvos);
                    for (const cliente of clientes) {
                        if (cliente.anexos) {
                            anexo = cliente.anexos.find(a => a.id === anexoId);
                            if (anexo) break;
                        }
                    }
                }
            }
            
            if (!anexo) {
                console.error('❌ Anexo não encontrado com ID:', anexoId);
                mostrarNotificacao('Documento não encontrado!', 'error');
                return;
            }
            
            console.log('🔧 Anexo encontrado:', anexo);
            console.log('🔧 Tipo de arquivo:', anexo.tipo || 'desconhecido');
            console.log('🔧 Nome do arquivo:', anexo.nome || 'sem nome');
            console.log('🔧 Campos disponíveis:', Object.keys(anexo));
            console.log('🔧 Conteúdo (conteudo):', anexo.conteudo ? anexo.conteudo.substring(0, 50) + '...' : 'N/A');
            console.log('🔧 Conteúdo (dataURL):', anexo.dataURL ? anexo.dataURL.substring(0, 50) + '...' : 'N/A');
            console.log('🔧 Conteúdo (dados):', anexo.dados ? anexo.dados.substring(0, 50) + '...' : 'N/A');
            
            try {
                console.log('🔧 Iniciando conversão Base64 para Blob...');
                
                // Verificar qual campo contém o conteúdo
                let conteudoBase64 = anexo.conteudo || anexo.dataURL || anexo.dados;
                
                // Validar se o conteúdo Base64 é válido
                if (!conteudoBase64 || typeof conteudoBase64 !== 'string' || conteudoBase64 === 'simulado') {
                    throw new Error('Conteúdo do anexo não encontrado ou inválido');
                }
                
                // Verificar se é um data URL válido
                let base64Content = conteudoBase64;
                if (base64Content.startsWith('data:')) {
                    // Extrair apenas a parte Base64 do data URL
                    base64Content = base64Content.split(',')[1];
                }
                
                // Validar formato Base64
                const base64Regex = /^[A-Za-z0-9+/]*={0,2}$/;
                if (!base64Regex.test(base64Content)) {
                    throw new Error('Formato Base64 inválido');
                }
                
                console.log('🔧 Base64 validado, iniciando decodificação...');
                // Converter base64 para blob
                const byteCharacters = atob(base64Content);
                console.log('🔧 Base64 decodificado, tamanho:', byteCharacters.length);
                
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                console.log('🔧 ByteArray criado, tamanho:', byteArray.length);
                
                // Detectar tipo MIME baseado na extensão do arquivo
                let mimeType = anexo.tipoMime || anexo.tipoArquivo || 'application/octet-stream';
                
                // Se não temos tipo MIME, detectar pela extensão
                if (!anexo.tipoMime && !anexo.tipoArquivo) {
                    const extensao = anexo.nomeArquivo ? anexo.nomeArquivo.split('.').pop().toLowerCase() : '';
                    const mimeTypes = {
                        'jpg': 'image/jpeg',
                        'jpeg': 'image/jpeg',
                        'png': 'image/png',
                        'gif': 'image/gif',
                        'bmp': 'image/bmp',
                        'webp': 'image/webp',
                        'pdf': 'application/pdf',
                        'doc': 'application/msword',
                        'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                        'xls': 'application/vnd.ms-excel',
                        'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                        'ppt': 'application/vnd.ms-powerpoint',
                        'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                        'txt': 'text/plain',
                        'rtf': 'application/rtf',
                        'zip': 'application/zip',
                        'rar': 'application/x-rar-compressed',
                        '7z': 'application/x-7z-compressed'
                    };
                    
                    mimeType = mimeTypes[extensao] || 'application/octet-stream';
                }
                
                console.log('🔧 Tipo MIME detectado:', mimeType);
                
                const blob = new Blob([byteArray], { type: mimeType });
                console.log('🔧 Blob criado, tamanho:', blob.size, 'tipo:', blob.type);
                
                // Criar link de download
                const url = window.URL.createObjectURL(blob);
                console.log('🔧 URL do objeto criada:', url);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = anexo.nomeArquivo || anexo.nome;
                console.log('🔧 Link criado, href:', link.href, 'download:', link.download);
                
                document.body.appendChild(link);
                console.log('🔧 Link adicionado ao body, clicando...');
                link.click();
                console.log('🔧 Link clicado, removendo do body...');
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                console.log('🔧 URL revogada, download deve ter iniciado');
                
                mostrarNotificacao('Download iniciado com sucesso!', 'success');
            } catch (error) {
                console.error('❌ Erro ao baixar arquivo:', error);
                console.error('❌ Detalhes do erro:', error.message);
                console.error('❌ Conteúdo do anexo (primeiros 100 chars):', anexo.conteudo ? anexo.conteudo.substring(0, 100) : 'N/A');
                
                let mensagemErro = 'Erro ao baixar arquivo!';
                if (error.message.includes('Base64')) {
                    mensagemErro = 'Arquivo corrompido - Base64 inválido. Tente fazer upload novamente.';
                } else if (error.message.includes('conteúdo')) {
                    mensagemErro = 'Conteúdo do arquivo não encontrado.';
                }
                
                mostrarNotificacao(mensagemErro, 'error');
            }
        }
        
        function removerAnexo(clienteId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const cliente = clientes.find(c => c.id === clienteId);
                if (cliente && cliente.anexos) {
                    cliente.anexos = cliente.anexos.filter(a => a.id !== anexoId);
                    salvarDados('clientes', clientes);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    fecharModalDIRETO(); // Fechar modal após salvar
                }
            }
        }

        // === SISTEMA DE ANEXOS PARA ÁREAS DE EXECUÇÃO ===
        
        function abrirAnexosContrato(contratoId) {
            const contrato = contratos.find(c => c.id === contratoId);
            if (!contrato) return;
            
            if (!contrato.anexos) contrato.anexos = [];
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalDIRETO()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos do Contrato</h3>
                                <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexoContrato(event, ${contratoId})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('contrato')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="contrato">Contrato</option>
                                                <option value="anexo">Anexo</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="certificado">Certificado</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizadoContrato" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrição (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descrição do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${contrato.anexos.length})</h4>
                                ${contrato.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${contrato.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} • ${anexo.tamanho} • ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexoContrato(${contratoId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }
        
        function adicionarAnexoContrato(event, contratoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            // Usar tipo personalizado se "outro" foi selecionado
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const contrato = contratos.find(c => c.id === contratoId);
                if (contrato) {
                    if (!contrato.anexos) contrato.anexos = [];
                    contrato.anexos.push(anexo);
                    salvarDados('contratos', contratos);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    fecharModalDIRETO(); // Fechar modal após salvar
                }
            });
        }
        
        function removerAnexoContrato(contratoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const contrato = contratos.find(c => c.id === contratoId);
                if (contrato && contrato.anexos) {
                    contrato.anexos = contrato.anexos.filter(a => a.id !== anexoId);
                    salvarDados('contratos', contratos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    fecharModalDIRETO(); // Fechar modal após salvar
                }
            }
        }

        // === FUNÇÃO PARA CONTROLAR VISIBILIDADE DO TIPO PERSONALIZADO ===
        
        function toggleTipoPersonalizado(area) {
            console.log('🔧 toggleTipoPersonalizado chamado para área:', area);
            const select = document.getElementById('tipoDocumento');
            const divPersonalizado = document.getElementById(`tipoPersonalizado${area.charAt(0).toUpperCase() + area.slice(1)}`);
            const inputPersonalizado = document.getElementById('tipoPersonalizadoInput');
            
            console.log('🔧 Select encontrado:', !!select);
            console.log('🔧 Div personalizado encontrado:', !!divPersonalizado);
            console.log('🔧 Input personalizado encontrado:', !!inputPersonalizado);
            
            if (select && divPersonalizado) {
                if (select.value === 'outro') {
                    console.log('🔧 Mostrando campo personalizado');
                    divPersonalizado.classList.remove('hidden');
                    if (inputPersonalizado) {
                        inputPersonalizado.required = true;
                        inputPersonalizado.focus();
                    }
                } else {
                    console.log('🔧 Ocultando campo personalizado');
                    divPersonalizado.classList.add('hidden');
                    if (inputPersonalizado) {
                        inputPersonalizado.required = false;
                        if (inputPersonalizado.value !== undefined) {
                            inputPersonalizado.value = '';
                        }
                    }
                }
            } else {
                console.error('❌ Elementos não encontrados:', { select: !!select, divPersonalizado: !!divPersonalizado });
            }
        }

        // === FUNÇÕES PARA PRAZOS ===
        
        
        function atualizarCliente(id) {
            const clienteIndex = clientes.findIndex(c => c.id === id);
            if (clienteIndex !== -1) {
                clientes[clienteIndex] = {
                    ...clientes[clienteIndex],
                    nome: document.getElementById('clienteNome').value,
                    email: document.getElementById('clienteEmail').value,
                    telefone: document.getElementById('clienteTelefone').value,
                    nif: document.getElementById('clienteNIF').value,
                    morada: document.getElementById('clienteMorada').value,
                    notas: document.getElementById('clienteNotas').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('clientes', clientes);
                mostrarNotificacao('Cliente atualizado com sucesso!', 'success');
                fecharModal();
                carregarSecao('clientes');
            }
        }
        
        function atualizarPrazo(event, id) {
            event.preventDefault();
            
            const prazoIndex = prazos.findIndex(p => p.id === id);
            if (prazoIndex !== -1) {
                prazos[prazoIndex] = {
                    ...prazos[prazoIndex],
                    descricao: document.getElementById('prazoDescricao').value,
                    dataLimite: document.getElementById('prazoDataLimite').value,
                    prioridade: document.getElementById('prazoPrioridade').value,
                    status: document.getElementById('prazoStatus').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('prazos', prazos);
                mostrarNotificacao('Prazo atualizado com sucesso!', 'success');
                fecharModal();
                carregarSecao('prazos');
            }
        }
        

        // === FUNÇÕES DE MODAL DE EDIÇÃO ===
        
        function abrirModalEdicaoCliente(cliente) {
            console.log('abrirModalEdicaoCliente chamado com:', cliente);
            
            const modalContainer = document.getElementById('modalContainer');
            if (!modalContainer) {
                console.error('modalContainer não encontrado!');
                return;
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalDIRETO()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Cliente</h3>
                                <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarCliente(event, ${cliente.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                                        <input type="text" id="editarClienteNome" value="${cliente.nome}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                        <input type="email" id="editarClienteEmail" value="${cliente.email}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                                        <input type="tel" id="editarClienteTelefone" value="${cliente.telefone}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">NIF *</label>
                                        <input type="text" id="editarClienteNIF" value="${cliente.nif || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="123456789">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Endereço</label>
                                        <textarea id="editarClienteEndereco" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${cliente.endereco || ''}</textarea>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="editarClienteStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="ativo" ${cliente.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                            <option value="inativo" ${cliente.status === 'inativo' ? 'selected' : ''}>Inativo</option>
                                            <option value="suspenso" ${cliente.status === 'suspenso' ? 'selected' : ''}>Suspenso</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            console.log('Inserindo modal de cliente no container...');
            modalContainer.innerHTML = modal;
            console.log('Modal inserido, criando ícones...');
            lucide.createIcons();
            console.log('Modal de edição de cliente aberto com sucesso!');
        }
        
        function abrirModalEdicaoContrato(contrato) {
            console.log('abrirModalEdicaoContrato chamado com:', contrato);
            
            // Verificar se o modalContainer existe
            const modalContainer = document.getElementById('modalContainer');
            if (!modalContainer) {
                console.error('modalContainer não encontrado!');
                mostrarNotificacao('Erro: Container do modal não encontrado!', 'error');
                return;
            }
            
            // Limpar qualquer conteúdo anterior
            modalContainer.innerHTML = '';
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalDIRETO()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Contrato</h3>
                                <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarContrato(event, ${contrato.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="contratoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === contrato.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="contratoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Compra e Venda" ${contrato.tipo === 'Compra e Venda' ? 'selected' : ''}>Compra e Venda</option>
                                            <option value="Arrendamento" ${contrato.tipo === 'Arrendamento' ? 'selected' : ''}>Arrendamento</option>
                                            <option value="Prestação de Serviços" ${contrato.tipo === 'Prestação de Serviços' ? 'selected' : ''}>Prestação de Serviços</option>
                                            <option value="Empréstimo" ${contrato.tipo === 'Empréstimo' ? 'selected' : ''}>Empréstimo</option>
                                            <option value="Outro" ${contrato.tipo === 'Outro' ? 'selected' : ''}>Outro</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="contratoValor" value="${contrato.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="contratoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${contrato.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${contrato.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${contrato.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                                <option value="23" ${contrato.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="contratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${contrato.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${contrato.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${contrato.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                            <input type="date" id="contratoDataInicio" value="${contrato.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Fim</label>
                                            <input type="date" id="contratoDataFim" value="${contrato.dataFim || ''}" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea id="contratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${contrato.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                console.log('Inserindo modal no container...');
                modalContainer.innerHTML = modal;
                console.log('Modal inserido, criando ícones...');
                lucide.createIcons();
                console.log('Modal de edição de contrato aberto com sucesso!');
                
                // Verificar se o modal foi inserido corretamente
                const modalElement = modalContainer.querySelector('.fixed.inset-0');
                if (modalElement) {
                    console.log('✅ Modal inserido e visível');
                    console.log('Modal element:', modalElement);
                    console.log('Modal styles:', window.getComputedStyle(modalElement));
                    
                    // Forçar visibilidade
                    modalElement.style.display = 'flex';
                    modalElement.style.visibility = 'visible';
                    modalElement.style.opacity = '1';
                    modalElement.style.zIndex = '9999';
                    
                    console.log('Modal forçado a ser visível');
                } else {
                    console.error('❌ Modal não foi inserido corretamente');
                    mostrarNotificacao('Erro ao abrir modal de edição!', 'error');
                }
            } catch (error) {
                console.error('Erro ao inserir modal:', error);
                mostrarNotificacao('Erro ao abrir modal de edição!', 'error');
            }
        }
        
        function abrirModalEdicaoHonorario(honorario) {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalDIRETO()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Honorário</h3>
                                <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarHonorario(event, ${honorario.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <input type="text" id="honorarioCliente" value="${honorario.cliente}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Serviço *</label>
                                        <input type="text" id="honorarioServico" value="${honorario.servico}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="honorarioValor" value="${honorario.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="honorarioStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${honorario.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="pago" ${honorario.status === 'pago' ? 'selected' : ''}>Pago</option>
                                                <option value="vencido" ${honorario.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento *</label>
                                        <input type="date" id="honorarioVencimento" value="${honorario.vencimento}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        function abrirModalEdicaoHeranca(heranca) {
            console.log('🔧 abrirModalEdicaoHeranca chamado com:', heranca);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoHeranca';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = fecharModal;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Herança</h3>
                            <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form onsubmit="atualizarHeranca(event, ${heranca.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="herancaClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === heranca.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                    <select id="herancaTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Aceitação da herança" ${heranca.tipo === 'Aceitação da herança' ? 'selected' : ''}>Aceitação da herança</option>
                                        <option value="Doações" ${heranca.tipo === 'Doações' ? 'selected' : ''}>Doações</option>
                                        <option value="Escrituras de partilha" ${heranca.tipo === 'Escrituras de partilha' ? 'selected' : ''}>Escrituras de partilha</option>
                                        <option value="Habilitação de herdeiros" ${heranca.tipo === 'Habilitação de herdeiros' ? 'selected' : ''}>Habilitação de herdeiros</option>
                                        <option value="Partilhas em vida" ${heranca.tipo === 'Partilhas em vida' ? 'selected' : ''}>Partilhas em vida</option>
                                        <option value="Partilhas por óbito" ${heranca.tipo === 'Partilhas por óbito' ? 'selected' : ''}>Partilhas por óbito</option>
                                        <option value="Processo de inventário" ${heranca.tipo === 'Processo de inventário' ? 'selected' : ''}>Processo de inventário</option>
                                        <option value="Renúncia à herança" ${heranca.tipo === 'Renúncia à herança' ? 'selected' : ''}>Renúncia à herança</option>
                                        <option value="Testamentos" ${heranca.tipo === 'Testamentos' ? 'selected' : ''}>Testamentos</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="herancaValor" value="${heranca.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="herancaIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0" ${heranca.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                            <option value="6" ${heranca.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                            <option value="13" ${heranca.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                            <option value="23" ${heranca.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="herancaStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente" ${heranca.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                            <option value="em_andamento" ${heranca.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                            <option value="concluido" ${heranca.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                    <input type="date" id="herancaDataInicio" value="${heranca.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                    <textarea id="herancaObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${heranca.observacoes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Alterações
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            const modalAnterior = document.getElementById('modalEdicaoHeranca');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            // Adicionar ao body
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('✅ Modal de edição de herança criado e adicionado ao body!');
        }

        function abrirModalEdicaoMigracao(migracao) {
            console.log('🔧 abrirModalEdicaoMigracao chamado com:', migracao);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoMigracao';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = fecharModal;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Migração</h3>
                            <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form onsubmit="atualizarMigracao(event, ${migracao.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="migracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                    <select id="migracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Autorização de residência" ${migracao.tipo === 'Autorização de residência' ? 'selected' : ''}>Autorização de residência</option>
                                        <option value="Certificados de residência permanente" ${migracao.tipo === 'Certificados de residência permanente' ? 'selected' : ''}>Certificados de residência permanente</option>
                                        <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                        <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                        <option value="Renovação de autorizações" ${migracao.tipo === 'Renovação de autorizações' ? 'selected' : ''}>Renovação de autorizações</option>
                                        <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                        <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                        <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                        <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="migracaoValor" value="${migracao.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="migracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                            <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                            <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                            <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="migracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                            <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                            <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                    <input type="date" id="migracaoDataInicio" value="${migracao.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                    <textarea id="migracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Alterações
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            const modalAnterior = document.getElementById('modalEdicaoMigracao');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            // Adicionar ao body
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('✅ Modal de edição de migração criado e adicionado ao body!');
        }

        function abrirModalEdicaoRegisto(registo) {
            console.log('🔧 abrirModalEdicaoRegisto chamado com:', registo);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoRegisto';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = fecharModal;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Registo</h3>
                                <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarRegisto(event, ${registo.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="registoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === registo.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="registoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autenticação de documentos" ${registo.tipo === 'Autenticação de documentos' ? 'selected' : ''}>Autenticação de documentos</option>
                                            <option value="Certificação de fotocópias" ${registo.tipo === 'Certificação de fotocópias' ? 'selected' : ''}>Certificação de fotocópias</option>
                                            <option value="Documentos para o estrangeiro" ${registo.tipo === 'Documentos para o estrangeiro' ? 'selected' : ''}>Documentos para o estrangeiro</option>
                                            <option value="Procurações" ${registo.tipo === 'Procurações' ? 'selected' : ''}>Procurações</option>
                                            <option value="Reconhecimento presencial de assinaturas" ${registo.tipo === 'Reconhecimento presencial de assinaturas' ? 'selected' : ''}>Reconhecimento presencial de assinaturas</option>
                                            <option value="Registos automóveis" ${registo.tipo === 'Registos automóveis' ? 'selected' : ''}>Registos automóveis</option>
                                            <option value="Registos comerciais" ${registo.tipo === 'Registos comerciais' ? 'selected' : ''}>Registos comerciais</option>
                                            <option value="Registos de propriedade" ${registo.tipo === 'Registos de propriedade' ? 'selected' : ''}>Registos de propriedade</option>
                                            <option value="Termos de autenticação" ${registo.tipo === 'Termos de autenticação' ? 'selected' : ''}>Termos de autenticação</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="registoValor" value="${registo.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="registoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${registo.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${registo.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${registo.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                                <option value="23" ${registo.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="registoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${registo.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${registo.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${registo.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                        <input type="date" id="registoDataInicio" value="${registo.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea id="registoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${registo.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            const modalAnterior = document.getElementById('modalEdicaoRegisto');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            // Adicionar ao body
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('✅ Modal de edição de registo criado e adicionado ao body!');
        }

        function abrirModalEdicaoPrazo(prazo) {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalDIRETO()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Prazo</h3>
                                <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarPrazo(event, ${prazo.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                                        <input type="text" id="prazoCliente" value="${prazo.clienteNome}" readonly class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                        <input type="text" id="prazoTipo" value="${prazo.tipo}" readonly class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrição *</label>
                                        <textarea id="prazoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${prazo.descricao}</textarea>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Limite *</label>
                                            <input type="date" id="prazoDataLimite" value="${prazo.dataLimite}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                            <select id="prazoPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="baixa" ${prazo.prioridade === 'baixa' ? 'selected' : ''}>Baixa</option>
                                                <option value="media" ${prazo.prioridade === 'media' ? 'selected' : ''}>Média</option>
                                                <option value="alta" ${prazo.prioridade === 'alta' ? 'selected' : ''}>Alta</option>
                                                <option value="critica" ${prazo.prioridade === 'critica' ? 'selected' : ''}>Crítica</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="prazoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="ativo" ${prazo.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                            <option value="concluido" ${prazo.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                            <option value="vencido" ${prazo.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                                            <option value="cancelado" ${prazo.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        // === FUNÇÕES DE ATUALIZAÇÃO ===
        
        function atualizarContrato(event, id) {
            event.preventDefault();
            
            const contratoIndex = contratos.findIndex(c => c.id === id);
            if (contratoIndex !== -1) {
                const clienteId = document.getElementById('contratoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                contratos[contratoIndex] = {
                    ...contratos[contratoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : contratos[contratoIndex].clienteNome,
                    tipo: document.getElementById('contratoTipo').value,
                    valor: document.getElementById('contratoValor').value,
                    iva: document.getElementById('contratoIva').value,
                    status: document.getElementById('contratoStatus').value,
                    dataInicio: document.getElementById('contratoDataInicio').value,
                    dataFim: document.getElementById('contratoDataFim').value,
                    observacoes: document.getElementById('contratoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('contratos', contratos);
                mostrarNotificacao('Contrato atualizado com sucesso!', 'success');
                fecharModal();
                carregarSecao('contratos');
            }
        }
        
        function atualizarHonorario(event, id) {
            event.preventDefault();
            
            const honorarioIndex = honorarios.findIndex(h => h.id === id);
            if (honorarioIndex !== -1) {
                honorarios[honorarioIndex] = {
                    ...honorarios[honorarioIndex],
                    cliente: document.getElementById('honorarioCliente').value,
                    servico: document.getElementById('honorarioServico').value,
                    valor: document.getElementById('honorarioValor').value,
                    status: document.getElementById('honorarioStatus').value,
                    vencimento: document.getElementById('honorarioVencimento').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('honorarios', honorarios);
                mostrarNotificacao('Honorário atualizado com sucesso!', 'success');
                fecharModal();
                carregarSecao('honorarios');
            }
        }

        function atualizarHeranca(event, id) {
            console.log('🔧 atualizarHeranca chamado com ID:', id);
            event.preventDefault();
            
            // Buscar heranças do localStorage
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) {
                herancas = JSON.parse(herancasSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const herancaIndex = herancas.findIndex(h => h.id === id);
            if (herancaIndex !== -1) {
                const clienteId = document.getElementById('herancaClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                herancas[herancaIndex] = {
                    ...herancas[herancaIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : herancas[herancaIndex].clienteNome,
                    tipo: document.getElementById('herancaTipo').value,
                    valor: document.getElementById('herancaValor').value,
                    iva: document.getElementById('herancaIva').value,
                    status: document.getElementById('herancaStatus').value,
                    dataInicio: document.getElementById('herancaDataInicio').value,
                    observacoes: document.getElementById('herancaObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('herancas', herancas);
                mostrarNotificacao('Herança atualizada com sucesso!', 'success');
                
                // Fechar modal explicitamente
                console.log('🔧 Fechando modal de herança...');
                fecharModal();
                
                // Aguardar um pouco antes de recarregar
                setTimeout(() => {
                    carregarSecao('herancas');
                }, 100);
                
                console.log('✅ Herança atualizada com sucesso!');
            } else {
                console.error('❌ Herança não encontrada com ID:', id);
                mostrarNotificacao('Erro: Herança não encontrada!', 'error');
            }
        }
        
        // Tornar função global
        window.atualizarHeranca = atualizarHeranca;

        function atualizarMigracao(event, id) {
            console.log('🔧 atualizarMigracao chamado com ID:', id);
            event.preventDefault();
            
            // Buscar migrações do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const migracaoIndex = migracoes.findIndex(m => m.id === id);
            if (migracaoIndex !== -1) {
                const clienteId = document.getElementById('migracaoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                migracoes[migracaoIndex] = {
                    ...migracoes[migracaoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : migracoes[migracaoIndex].clienteNome,
                    tipo: document.getElementById('migracaoTipo').value,
                    valor: document.getElementById('migracaoValor').value,
                    iva: document.getElementById('migracaoIva').value,
                    status: document.getElementById('migracaoStatus').value,
                    dataInicio: document.getElementById('migracaoDataInicio').value,
                    observacoes: document.getElementById('migracaoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('migracoes', migracoes);
                mostrarNotificacao('Migração atualizada com sucesso!', 'success');
                
                // Fechar modal explicitamente
                console.log('🔧 Fechando modal de migração...');
                fecharModal();
                
                // Aguardar um pouco antes de recarregar
                setTimeout(() => {
                    carregarSecao('migracoes');
                }, 100);
                
                console.log('✅ Migração atualizada com sucesso!');
            } else {
                console.error('❌ Migração não encontrada com ID:', id);
                mostrarNotificacao('Erro: Migração não encontrada!', 'error');
            }
        }
        
        // Tornar função global
        window.atualizarMigracao = atualizarMigracao;

        function atualizarRegisto(event, id) {
            console.log('🔧 atualizarRegisto chamado com ID:', id);
            event.preventDefault();
            
            // Buscar registos do localStorage
            const registosSalvos = localStorage.getItem('registos');
            let registos = [];
            if (registosSalvos) {
                registos = JSON.parse(registosSalvos);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const registoIndex = registos.findIndex(r => r.id === id);
            if (registoIndex !== -1) {
                const clienteId = document.getElementById('registoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                registos[registoIndex] = {
                    ...registos[registoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : registos[registoIndex].clienteNome,
                    tipo: document.getElementById('registoTipo').value,
                    valor: document.getElementById('registoValor').value,
                    iva: document.getElementById('registoIva').value,
                    status: document.getElementById('registoStatus').value,
                    dataInicio: document.getElementById('registoDataInicio').value,
                    observacoes: document.getElementById('registoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('registos', registos);
                mostrarNotificacao('Registo atualizado com sucesso!', 'success');
                
                // Fechar modal explicitamente
                console.log('🔧 Fechando modal de registo...');
                fecharModal();
                
                // Aguardar um pouco antes de recarregar
                setTimeout(() => {
                    carregarSecao('registos');
                }, 100);
                
                console.log('✅ Registo atualizado com sucesso!');
            } else {
                console.error('❌ Registo não encontrado com ID:', id);
                mostrarNotificacao('Erro: Registo não encontrado!', 'error');
            }
        }
        
        // Tornar função global
        window.atualizarRegisto = atualizarRegisto;
        
        // === FUNÇÃO SIMPLES PARA SALVAR HERANÇA EDITADA ===
        function salvarHerancaEditada(event, id) {
            event.preventDefault();
            
            // Buscar heranças do localStorage
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) {
                herancas = JSON.parse(herancasSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Encontrar a herança
            const herancaIndex = herancas.findIndex(h => h.id === id);
            if (herancaIndex !== -1) {
                const clienteId = document.getElementById('editClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                // Atualizar os dados
                herancas[herancaIndex] = {
                    ...herancas[herancaIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : herancas[herancaIndex].clienteNome,
                    tipo: document.getElementById('editTipo').value,
                    valor: document.getElementById('editValor').value,
                    iva: document.getElementById('editIva').value,
                    status: document.getElementById('editStatus').value,
                    dataInicio: document.getElementById('editDataInicio').value,
                    observacoes: document.getElementById('editObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('herancas', JSON.stringify(herancas));
                mostrarNotificacao('Herança atualizada com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoHeranca');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar seção
                carregarSecao('herancas');
            }
        }
        
        // Tornar função global
        window.salvarHerancaEditada = salvarHerancaEditada;
        
        // === FUNÇÃO PARA SALVAR MIGRAÇÃO EDITADA ===
        function salvarMigracaoEditada(event, id) {
            event.preventDefault();
            
            // Buscar migrações do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Encontrar a migração
            const migracaoIndex = migracoes.findIndex(m => m.id === id);
            if (migracaoIndex !== -1) {
                const clienteId = document.getElementById('editMigracaoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                // Atualizar os dados
                migracoes[migracaoIndex] = {
                    ...migracoes[migracaoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : migracoes[migracaoIndex].clienteNome,
                    tipo: document.getElementById('editMigracaoTipo').value,
                    valor: document.getElementById('editMigracaoValor').value,
                    iva: document.getElementById('editMigracaoIva').value,
                    status: document.getElementById('editMigracaoStatus').value,
                    dataInicio: document.getElementById('editMigracaoDataInicio').value,
                    observacoes: document.getElementById('editMigracaoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('migracoes', JSON.stringify(migracoes));
                mostrarNotificacao('Migração atualizada com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoMigracao');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar seção após um pequeno delay
                setTimeout(() => {
                    carregarSecao('migracoes');
                }, 100);
            }
        }
        
        // Tornar função global
        window.salvarMigracaoEditada = salvarMigracaoEditada;
        
        // === FUNÇÃO PARA SALVAR REGISTO EDITADO ===
        function salvarRegistoEditado(event, id) {
            event.preventDefault();
            
            // Buscar registos do localStorage
            const registosSalvos = localStorage.getItem('registos');
            let registos = [];
            if (registosSalvos) {
                registos = JSON.parse(registosSalvos);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Encontrar o registo
            const registoIndex = registos.findIndex(r => r.id === id);
            if (registoIndex !== -1) {
                const clienteId = document.getElementById('editRegistoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                // Atualizar os dados
                registos[registoIndex] = {
                    ...registos[registoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : registos[registoIndex].clienteNome,
                    tipo: document.getElementById('editRegistoTipo').value,
                    valor: document.getElementById('editRegistoValor').value,
                    iva: document.getElementById('editRegistoIva').value,
                    status: document.getElementById('editRegistoStatus').value,
                    dataInicio: document.getElementById('editRegistoDataInicio').value,
                    observacoes: document.getElementById('editRegistoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('registos', JSON.stringify(registos));
                mostrarNotificacao('Registo atualizado com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoRegisto');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar seção após um pequeno delay
                setTimeout(() => {
                    carregarSecao('registos');
                    // Forçar atualização da lista
                    if (typeof atualizarListaRegistos === 'function') {
                        atualizarListaRegistos(registos);
                    }
                }, 100);
            }
        }
        
        // Tornar função global
        window.salvarRegistoEditado = salvarRegistoEditado;

        // === FUNÇÃO PARA CONTROLAR MENU MOBILE ===
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
        }
        
        // Fechar sidebar ao clicar fora (mobile)
        document.addEventListener('click', function(event) {
            try {
                const sidebar = document.getElementById('sidebar');
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                
                if (window.innerWidth <= 1024 && sidebar && mobileMenuBtn) {
                    if (!sidebar.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                        sidebar.classList.remove('open');
                    }
                }
            } catch (error) {
                console.log('Erro no evento de click:', error);
            }
        });
        
        // Fechar sidebar ao redimensionar para desktop
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar && window.innerWidth > 1024) {
                sidebar.classList.remove('open');
            }
        });

        // === FUNÇÃO PARA CONTROLAR VISIBILIDADE DO NOME DA PARCERIA ===
        
        function toggleParceriaNome(tipo) {
            const parceriaSelect = document.getElementById(`${tipo}Parceria`) || document.querySelector(`select[name="parceria"]`);
            const nomeDiv = document.getElementById(`${tipo}ParceriaNomeDiv`) || document.getElementById(`${tipo}ParceriaNomeDiv`);
            
            if (parceriaSelect && nomeDiv) {
                if (parceriaSelect.value === 'empresa' || parceriaSelect.value === 'pessoa') {
                    nomeDiv.style.display = 'block';
                } else {
                    nomeDiv.style.display = 'none';
                }
            }
        }

        // === FUNÇÕES ESPECÍFICAS DE EDIÇÃO E EXCLUSÃO PARA ÁREAS DE ATUAÇÃO ===
        
        function editarHeranca(id) {
            // Buscar herança diretamente do localStorage
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) {
                herancas = JSON.parse(herancasSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const heranca = herancas.find(h => h.id === id);
            if (heranca) {
                // Fechar qualquer modal aberto
                fecharModal();
                
                // Criar modal com layout original
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoHeranca';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Herança</h3>
                                <button onclick="document.getElementById('modalEdicaoHeranca').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarHerancaEditada(event, ${id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === heranca.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Aceitação da herança" ${heranca.tipo === 'Aceitação da herança' ? 'selected' : ''}>Aceitação da herança</option>
                                            <option value="Doações" ${heranca.tipo === 'Doações' ? 'selected' : ''}>Doações</option>
                                            <option value="Escrituras de partilha" ${heranca.tipo === 'Escrituras de partilha' ? 'selected' : ''}>Escrituras de partilha</option>
                                            <option value="Habilitação de herdeiros" ${heranca.tipo === 'Habilitação de herdeiros' ? 'selected' : ''}>Habilitação de herdeiros</option>
                                            <option value="Partilhas em vida" ${heranca.tipo === 'Partilhas em vida' ? 'selected' : ''}>Partilhas em vida</option>
                                            <option value="Partilhas por óbito" ${heranca.tipo === 'Partilhas por óbito' ? 'selected' : ''}>Partilhas por óbito</option>
                                            <option value="Processo de inventário" ${heranca.tipo === 'Processo de inventário' ? 'selected' : ''}>Processo de inventário</option>
                                            <option value="Renúncia à herança" ${heranca.tipo === 'Renúncia à herança' ? 'selected' : ''}>Renúncia à herança</option>
                                            <option value="Testamentos" ${heranca.tipo === 'Testamentos' ? 'selected' : ''}>Testamentos</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editValor" value="${heranca.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${heranca.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${heranca.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${heranca.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                                <option value="23" ${heranca.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${heranca.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${heranca.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${heranca.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                        <input type="date" id="editDataInicio" value="${heranca.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea id="editObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${heranca.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoHeranca').remove()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
            }
        }

        function excluirHeranca(id) {
            excluirItem('heranca', id);
        }

        function editarMigracao(id) {
            // Buscar migração diretamente do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const migracao = migracoes.find(m => m.id === id);
            if (migracao) {
                // Fechar qualquer modal aberto
                fecharModal();
                
                // Criar modal com layout original
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoMigracao';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Migração</h3>
                                <button onclick="document.getElementById('modalEdicaoMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarMigracaoEditada(event, ${id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editMigracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editMigracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autorização de residência" ${migracao.tipo === 'Autorização de residência' ? 'selected' : ''}>Autorização de residência</option>
                                            <option value="Certificados de residência permanente" ${migracao.tipo === 'Certificados de residência permanente' ? 'selected' : ''}>Certificados de residência permanente</option>
                                            <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                            <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                            <option value="Renovação de autorizações" ${migracao.tipo === 'Renovação de autorizações' ? 'selected' : ''}>Renovação de autorizações</option>
                                            <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                            <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                            <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                            <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editMigracaoValor" value="${migracao.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editMigracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                                <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editMigracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                        <input type="date" id="editMigracaoDataInicio" value="${migracao.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea id="editMigracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoMigracao').remove()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
            }
        }

        function excluirMigracao(id) {
            excluirItem('migracao', id);
        }

        function editarRegisto(id) {
            // Buscar registo diretamente do localStorage
            const registosSalvos = localStorage.getItem('registos');
            let registos = [];
            if (registosSalvos) {
                registos = JSON.parse(registosSalvos);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const registo = registos.find(r => r.id === id);
            if (registo) {
                // Fechar qualquer modal aberto
                fecharModal();
                
                // Criar modal com layout original
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoRegisto';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Registo</h3>
                                <button onclick="document.getElementById('modalEdicaoRegisto').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarRegistoEditado(event, ${id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editRegistoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === registo.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editRegistoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autenticação de documentos" ${registo.tipo === 'Autenticação de documentos' ? 'selected' : ''}>Autenticação de documentos</option>
                                            <option value="Certificação de fotocópias" ${registo.tipo === 'Certificação de fotocópias' ? 'selected' : ''}>Certificação de fotocópias</option>
                                            <option value="Documentos para o estrangeiro" ${registo.tipo === 'Documentos para o estrangeiro' ? 'selected' : ''}>Documentos para o estrangeiro</option>
                                            <option value="Procurações" ${registo.tipo === 'Procurações' ? 'selected' : ''}>Procurações</option>
                                            <option value="Reconhecimento presencial de assinaturas" ${registo.tipo === 'Reconhecimento presencial de assinaturas' ? 'selected' : ''}>Reconhecimento presencial de assinaturas</option>
                                            <option value="Registos automóveis" ${registo.tipo === 'Registos automóveis' ? 'selected' : ''}>Registos automóveis</option>
                                            <option value="Registos comerciais" ${registo.tipo === 'Registos comerciais' ? 'selected' : ''}>Registos comerciais</option>
                                            <option value="Registos de propriedade" ${registo.tipo === 'Registos de propriedade' ? 'selected' : ''}>Registos de propriedade</option>
                                            <option value="Termos de autenticação" ${registo.tipo === 'Termos de autenticação' ? 'selected' : ''}>Termos de autenticação</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editRegistoValor" value="${registo.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editRegistoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${registo.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${registo.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${registo.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                                <option value="23" ${registo.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editRegistoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${registo.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${registo.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${registo.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                        <input type="date" id="editRegistoDataInicio" value="${registo.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea id="editRegistoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${registo.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoRegisto').remove()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
            }
        }

        function excluirRegisto(id) {
            excluirItem('registo', id);
        }
        
        // === FUNÇÕES DE FILTRO PARA MIGRAÇÕES ===
        function filtrarMigracoes() {
            aplicarFiltrosMigracoes();
        }

        function aplicarFiltrosMigracoes() {
            const busca = document.getElementById('buscaMigracoes')?.value.toLowerCase() || '';
            const statusFiltro = document.getElementById('filtroStatusMigracao')?.value || '';
            const tipoFiltro = document.getElementById('filtroTipoMigracao')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinMigracao')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxMigracao')?.value) || Infinity;
            const nif = document.getElementById('filtroNifMigracao')?.value || '';

            const migracoesFiltradas = migracoes.filter(migracao => {
                const matchBusca = !busca || 
                    (migracao.clienteNome?.toLowerCase().includes(busca)) ||
                    (migracao.tipo?.toLowerCase().includes(busca));
                
                const matchStatus = !statusFiltro || migracao.status === statusFiltro;
                const matchTipo = !tipoFiltro || migracao.tipo === tipoFiltro;
                const valor = parseFloat(migracao.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;

                // Filtro por NIF
                const cliente = clientes.find(c => c.id === migracao.clienteId);
                const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));

                return matchBusca && matchStatus && matchTipo && matchValor && matchNif;
            });

            // Atualizar tabela
            const tbody = document.getElementById('listaMigracoes');
            if (tbody) {
                tbody.innerHTML = migracoesFiltradas.map(migracao => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${migracao.clienteNome || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.tipo || 'N/A'}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${migracao.descricao || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div class="text-sm font-bold text-black">€${(migracao.valor || 0).toFixed(2)}</div>
                            <div class="text-xs font-bold text-red-600">+ IVA: €${((migracao.valor || 0) + ((migracao.valor || 0) * (migracao.iva || 0) / 100)).toFixed(2)}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-badge status-${migracao.status}">${migracao.status === 'concluido' ? 'Concluído' : migracao.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.dataInicio ? new Date(migracao.dataInicio).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="console.log('🔧 Botão editar clicado para ID:', ${migracao.id}); editarMigracaoDireto(${migracao.id})" class="text-blue-600 hover:text-blue-900 mr-3" title="Editar">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button onclick="abrirAnexosMigracao(${migracao.id})" class="text-green-600 hover:text-green-900 mr-3" title="Documentos">
                                <i data-lucide="paperclip" class="w-4 h-4"></i>
                            </button>
                            <button onclick="console.log('🔧 Botão excluir clicado para ID:', ${migracao.id}); excluirMigracaoDireto(${migracao.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            // Atualizar contador
            const contador = document.getElementById('contadorMigracoes');
            if (contador) {
                contador.textContent = migracoesFiltradas.length;
            }

            // Recriar ícones
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function limparFiltrosMigracoes() {
            const elementos = [
                'buscaMigracoes',
                'filtroStatusMigracao', 
                'filtroTipoMigracao',
                'filtroValorMinMigracao',
                'filtroValorMaxMigracao',
                'filtroNifMigracao'
            ];
            
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.value = '';
                }
            });
            
            aplicarFiltrosMigracoes();
        }

        function abrirAnexosMigracao(id) {
            const migracao = migracoes.find(m => m.id === id);
            if (migracao) {
                abrirModalAnexos('migracao', id, migracao.clienteNome || 'Migração');
            }
        }

        // === FUNÇÃO DE EDIÇÃO PADRÃO ===
        function abrirModalEdicaoMigracao(migracao) {
            console.log('🔧 abrirModalEdicaoMigracao chamado com:', migracao);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            console.log('🔧 Clientes encontrados:', clientes.length);
            
            if (migracao) {
                console.log('🔧 Fechando modal...');
                // Fechar qualquer modal aberto
                fecharModal();
                
                console.log('🔧 Criando modal...');
                // Criar modal com layout padrão
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoMigracao';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Migração</h3>
                                <button onclick="document.getElementById('modalEdicaoMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarMigracaoEditada(event, ${id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editMigracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editMigracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autorização de residência" ${migracao.tipo === 'Autorização de residência' ? 'selected' : ''}>Autorização de residência</option>
                                            <option value="Certificados de residência permanente" ${migracao.tipo === 'Certificados de residência permanente' ? 'selected' : ''}>Certificados de residência permanente</option>
                                            <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                            <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                            <option value="Renovação de autorizações" ${migracao.tipo === 'Renovação de autorizações' ? 'selected' : ''}>Renovação de autorizações</option>
                                            <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                            <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                            <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                            <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editMigracaoValor" value="${migracao.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editMigracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                                <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editMigracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                        <input type="date" id="editMigracaoDataInicio" value="${migracao.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea id="editMigracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoMigracao').remove()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
                console.log('🔧 Modal de edição de migração inserido no DOM!');
            } else {
                console.log('🔧 Erro: migração não encontrada!');
            }
        }
        
        // === FUNÇÃO DE SALVAR PADRÃO ===
        function salvarMigracaoEditada(event, id) {
            event.preventDefault();
            console.log('🔧 salvarMigracaoEditada chamado para ID:', id);
            
            // Buscar migrações do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Encontrar a migração
            const migracaoIndex = migracoes.findIndex(m => m.id == id);
            console.log('🔧 Índice da migração encontrado:', migracaoIndex);
            
            if (migracaoIndex !== -1) {
                const clienteId = parseInt(document.getElementById('editMigracaoClienteId').value);
                const cliente = clientes.find(c => c.id === clienteId);
                
                const valor = parseFloat(document.getElementById('editMigracaoValor').value);
                const ivaPercent = parseFloat(document.getElementById('editMigracaoIva').value);
                const valorIVA = (valor * ivaPercent) / 100;
                const valorComIva = valor + valorIVA;
                
                // Atualizar os dados
                migracoes[migracaoIndex] = {
                    ...migracoes[migracaoIndex],
                    clienteId: clienteId,
                    clienteNome: cliente ? cliente.nome : migracoes[migracaoIndex].clienteNome,
                    tipo: document.getElementById('editMigracaoTipo').value,
                    valor: valor,
                    iva: ivaPercent,
                    valorIVA: valorIVA,
                    valorComIva: valorComIva,
                    status: document.getElementById('editMigracaoStatus').value,
                    dataInicio: document.getElementById('editMigracaoDataInicio').value,
                    observacoes: document.getElementById('editMigracaoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                console.log('🔧 Migração atualizada:', migracoes[migracaoIndex]);
                
                // Salvar no localStorage
                localStorage.setItem('migracoes', JSON.stringify(migracoes));
                window.migracoes = migracoes;
                
                mostrarNotificacao('Migração atualizada com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoMigracao');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar seção
                setTimeout(() => {
                    carregarSecao('migracoes');
                }, 100);
            } else {
                console.log('🔧 Migração não encontrada para atualizar!');
                mostrarNotificacao('Erro: Migração não encontrada!', 'error');
            }
        }
        
        // Tornar função global
        window.salvarMigracaoEditada = salvarMigracaoEditada;
        
        // === FUNÇÃO PARA ANEXOS DE CONTRATOS ===
        function abrirAnexosContrato(id) {
            const contrato = contratos.find(c => c.id === id);
            if (contrato) {
                abrirModalAnexos('contrato', id, contrato.clienteNome || 'Contrato');
            }
        }

        // === FUNÇÃO PARA ANEXOS DE HERANÇAS ===
        function abrirAnexosHeranca(id) {
            const heranca = herancas.find(h => h.id === id);
            if (heranca) {
                abrirModalAnexos('heranca', id, heranca.clienteNome || 'Herança');
            }
        }

        // === FUNÇÃO PARA ANEXOS DE MIGRAÇÕES ===
        function abrirAnexosMigracao(id) {
            const migracao = migracoes.find(m => m.id === id);
            if (migracao) {
                abrirModalAnexos('migracao', id, migracao.clienteNome || 'Migração');
            }
        }

        // === FUNÇÃO PARA ANEXOS DE REGISTOS ===
        function abrirAnexosRegisto(id) {
            const registo = registos.find(r => r.id === id);
            if (registo) {
                abrirModalAnexos('registo', id, registo.clienteNome || 'Registo');
            }
        }

        // === FUNÇÃO PRINCIPAL PARA ABRIR MODAL DE ANEXOS ===
        function abrirModalAnexos(tipo, id, nome) {
            console.log('🔧 abrirModalAnexos chamado:', tipo, id, nome);
            
            // Fechar qualquer modal aberto primeiro
            fecharModal();
            
            // Buscar dados do localStorage
            let dados = [];
            let item = null;
            
            if (tipo === 'contrato') {
                const contratosSalvos = localStorage.getItem('contratos');
                if (contratosSalvos) {
                    dados = JSON.parse(contratosSalvos);
                }
                item = dados.find(c => c.id === id);
            } else if (tipo === 'heranca') {
                const herancasSalvas = localStorage.getItem('herancas');
                if (herancasSalvas) {
                    dados = JSON.parse(herancasSalvas);
                }
                item = dados.find(h => h.id === id);
            } else if (tipo === 'migracao') {
                const migracoesSalvas = localStorage.getItem('migracoes');
                if (migracoesSalvas) {
                    dados = JSON.parse(migracoesSalvas);
                }
                item = dados.find(m => m.id === id);
            } else if (tipo === 'registo') {
                const registosSalvos = localStorage.getItem('registos');
                if (registosSalvos) {
                    dados = JSON.parse(registosSalvos);
                }
                item = dados.find(r => r.id === id);
            }
            
            if (!item) {
                mostrarNotificacao('Item não encontrado!', 'error');
                return;
            }
            
            // Inicializar array de anexos se não existir
            if (!item.anexos) {
                item.anexos = [];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalDIRETO()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos de ${nome}</h3>
                                <button onclick="fecharModalDIRETO()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <!-- Upload de novos documentos -->
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexo${tipo.charAt(0).toUpperCase() + tipo.slice(1)}(event, ${id})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('${tipo}')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="documento">Documento</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="certificado">Certificado</option>
                                                <option value="contrato">Contrato</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizado${tipo.charAt(0).toUpperCase() + tipo.slice(1)}" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrição (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descrição do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModalDIRETO()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Lista de documentos existentes -->
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${item.anexos.length})</h4>
                                ${item.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${item.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} • ${anexo.tamanho} • ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexo${tipo.charAt(0).toUpperCase() + tipo.slice(1)}(${id}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Adicionar modal ao body
            const modalElement = document.createElement('div');
            modalElement.innerHTML = modal;
            document.body.appendChild(modalElement.firstElementChild);
            lucide.createIcons();
        }

        // === FUNÇÕES PARA ADICIONAR ANEXOS ===
        function adicionarAnexoContrato(event, contratoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const contrato = contratos.find(c => c.id === contratoId);
                if (contrato) {
                    if (!contrato.anexos) contrato.anexos = [];
                    contrato.anexos.push(anexo);
                    salvarDados('contratos', contratos);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    fecharModalDIRETO(); // Fechar modal após salvar
                }
            });
        }

        function adicionarAnexoHeranca(event, herancaId) {
            console.log('🔧 adicionarAnexoHeranca chamado com ID:', herancaId);
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            console.log('🔧 Dados do formulário:', { nome, tipoSelecionado, arquivo: arquivo?.name, descricao });
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const heranca = herancas.find(h => h.id === herancaId);
                console.log('🔧 Herança encontrada:', heranca);
                if (heranca) {
                    if (!heranca.anexos) heranca.anexos = [];
                    heranca.anexos.push(anexo);
                    console.log('🔧 Anexo adicionado:', anexo);
                    console.log('🔧 Herança atualizada:', heranca);
                    salvarDados('herancas', herancas);
                    console.log('✅ Dados salvos no localStorage');
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    fecharModalDIRETO(); // Fechar modal após salvar
                } else {
                    console.error('❌ Herança não encontrada com ID:', herancaId);
                    mostrarNotificacao('Herança não encontrada!', 'error');
                }
            });
        }

        function adicionarAnexoMigracao(event, migracaoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const migracao = migracoes.find(m => m.id === migracaoId);
                if (migracao) {
                    if (!migracao.anexos) migracao.anexos = [];
                    migracao.anexos.push(anexo);
                    salvarDados('migracoes', migracoes);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    fecharModalDIRETO(); // Fechar modal após salvar
                }
            });
        }

        function adicionarAnexoRegisto(event, registoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const registo = registos.find(r => r.id === registoId);
                if (registo) {
                    if (!registo.anexos) registo.anexos = [];
                    registo.anexos.push(anexo);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    fecharModalDIRETO(); // Fechar modal após salvar
                }
            });
        }

        // === FUNÇÕES PARA REMOVER ANEXOS ===
        function removerAnexoContrato(contratoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const contrato = contratos.find(c => c.id === contratoId);
                if (contrato && contrato.anexos) {
                    contrato.anexos = contrato.anexos.filter(a => a.id !== anexoId);
                    salvarDados('contratos', contratos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    fecharModalDIRETO(); // Fechar modal após salvar
                }
            }
        }

        function removerAnexoHeranca(herancaId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const heranca = herancas.find(h => h.id === herancaId);
                if (heranca && heranca.anexos) {
                    heranca.anexos = heranca.anexos.filter(a => a.id !== anexoId);
                    salvarDados('herancas', herancas);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    fecharModalDIRETO(); // Fechar modal após salvar
                }
            }
        }

        function removerAnexoMigracao(migracaoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const migracao = migracoes.find(m => m.id === migracaoId);
                if (migracao && migracao.anexos) {
                    migracao.anexos = migracao.anexos.filter(a => a.id !== anexoId);
                    salvarDados('migracoes', migracoes);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    fecharModalDIRETO(); // Fechar modal após salvar
                }
            }
        }

        function removerAnexoRegisto(registoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const registo = registos.find(r => r.id === registoId);
                if (registo && registo.anexos) {
                    registo.anexos = registo.anexos.filter(a => a.id !== anexoId);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    fecharModalDIRETO(); // Fechar modal após salvar
                }
            }
        }

        // === FUNÇÃO PARA TOGGLE TIPO PERSONALIZADO ===
        function toggleTipoPersonalizado(tipo) {
            const select = document.getElementById('tipoDocumento');
            const divPersonalizado = document.getElementById(`tipoPersonalizado${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
            
            if (select.value === 'outro') {
                divPersonalizado.classList.remove('hidden');
            } else {
                divPersonalizado.classList.add('hidden');
            }
        }



        // === FUNÇÕES DIRETAS PARA HERANÇAS ===
        function editarHerancaDireto(id) {
            console.log('🔧 editarHerancaDireto chamado com ID:', id);
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
            const heranca = herancas.find(h => h.id === id);
            if (heranca) {
                fecharModal();
                setTimeout(() => abrirModalEdicaoHeranca(heranca), 100);
            } else {
                mostrarNotificacao('Herança não encontrada!', 'error');
            }
        }

        function excluirHerancaDireto(id) {
            if (confirm('Tem certeza que deseja excluir esta herança? Esta ação não pode ser desfeita.')) {
                const herancasSalvas = localStorage.getItem('herancas');
                let herancas = [];
                if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
                herancas = herancas.filter(h => h.id !== id);
                localStorage.setItem('herancas', JSON.stringify(herancas));
                window.herancas = herancas;
                mostrarNotificacao('Herança excluída com sucesso!', 'success');
                carregarSecao('herancas');
            }
        }

        // === FUNÇÕES DIRETAS PARA MIGRAÇÕES ===
        function editarMigracaoDireto(id) {
            console.log('🔧 editarMigracaoDireto chamado com ID:', id);
            
            // Buscar migrações do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            const migracao = migracoes.find(m => m.id == id);
            console.log('🔧 Migração encontrada:', migracao);
            
            if (migracao) {
                // Fechar qualquer modal existente
                fecharModal();
                
                // Criar modal simples de edição
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoMigracao';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                // Buscar clientes do localStorage
                const clientesSalvos = localStorage.getItem('clientes');
                let clientes = [];
                if (clientesSalvos) {
                    clientes = JSON.parse(clientesSalvos);
                }
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Migração</h3>
                                <button onclick="document.getElementById('modalEdicaoMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarMigracaoEditada(event, ${migracao.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editMigracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editMigracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autorização de residência" ${migracao.tipo === 'Autorização de residência' ? 'selected' : ''}>Autorização de residência</option>
                                            <option value="Certificados de residência permanente" ${migracao.tipo === 'Certificados de residência permanente' ? 'selected' : ''}>Certificados de residência permanente</option>
                                            <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                            <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                            <option value="Renovação de autorizações" ${migracao.tipo === 'Renovação de autorizações' ? 'selected' : ''}>Renovação de autorizações</option>
                                            <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                            <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                            <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                            <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editMigracaoValor" value="${migracao.valor || ''}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editMigracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                                <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editMigracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                        <input type="date" id="editMigracaoDataInicio" value="${migracao.dataInicio || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea id="editMigracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoMigracao').remove()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
                console.log('🔧 Modal de edição criado e inserido no DOM!');
            } else {
                mostrarNotificacao('Migração não encontrada!', 'error');
            }
        }

        function excluirMigracaoDireto(id) {
            console.log('🔧 excluirMigracaoDireto chamado com ID:', id);
            if (confirm('Tem certeza que deseja excluir esta migração? Esta ação não pode ser desfeita.')) {
                // Buscar migrações do localStorage
                const migracoesSalvas = localStorage.getItem('migracoes');
                let migracoes = [];
                if (migracoesSalvas) {
                    migracoes = JSON.parse(migracoesSalvas);
                }
                
                // Filtrar para remover a migração
                migracoes = migracoes.filter(m => m.id != id);
                
                // Salvar no localStorage
                localStorage.setItem('migracoes', JSON.stringify(migracoes));
                
                // Atualizar array global
                window.migracoes = migracoes;
                
                mostrarNotificacao('Migração excluída com sucesso!', 'success');
                
                // Recarregar seção
                carregarSecao('migracoes');
            }
        }

        // === SISTEMA DE IVA TRIMESTRAL ===
        
        // Função para determinar o trimestre atual
        function obterTrimestreAtual() {
            const agora = new Date();
            const mes = agora.getMonth() + 1; // Janeiro = 1, Dezembro = 12
            
            if (mes >= 1 && mes <= 3) return 1; // 1º Trimestre (Jan-Mar)
            if (mes >= 4 && mes <= 6) return 2; // 2º Trimestre (Abr-Jun)
            if (mes >= 7 && mes <= 9) return 3; // 3º Trimestre (Jul-Set)
            if (mes >= 10 && mes <= 12) return 4; // 4º Trimestre (Out-Dez)
        }
        
        // Função para obter datas de prazo do IVA
        function obterPrazosIVA(trimestre) {
            const ano = new Date().getFullYear();
            const prazos = {
                1: { // 1º Trimestre
                    entrega: `${ano}-05-20`,
                    pagamento: `${ano}-05-25`,
                    periodo: 'Janeiro a Março'
                },
                2: { // 2º Trimestre
                    entrega: `${ano}-07-20`,
                    pagamento: `${ano}-07-25`,
                    periodo: 'Abril a Junho'
                },
                3: { // 3º Trimestre
                    entrega: `${ano}-11-20`,
                    pagamento: `${ano}-11-25`,
                    periodo: 'Julho a Setembro'
                },
                4: { // 4º Trimestre
                    entrega: `${ano + 1}-02-20`,
                    pagamento: `${ano + 1}-02-25`,
                    periodo: 'Outubro a Dezembro'
                }
            };
            return prazos[trimestre];
        }
        
        // Função para calcular IVA acumulado por trimestre
        function calcularIVATrimestral_REMOVED() {
            const trimestreAtual = obterTrimestreAtual();
            const ano = new Date().getFullYear();
            
            // Buscar todos os dados
            const contratosSalvos = localStorage.getItem('contratos');
            const herancasSalvas = localStorage.getItem('herancas');
            const migracoesSalvas = localStorage.getItem('migracoes');
            const registosSalvos = localStorage.getItem('registos');
            
            let contratos = [], herancas = [], migracoes = [], registos = [];
            if (contratosSalvos) contratos = JSON.parse(contratosSalvos);
            if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
            if (migracoesSalvas) migracoes = JSON.parse(migracoesSalvas);
            if (registosSalvos) registos = JSON.parse(registosSalvos);
            
            const todosItens = [...contratos, ...herancas, ...migracoes, ...registos];
            
            // Calcular IVA por trimestre
            const ivaPorTrimestre = {
                1: { valor: 0, itens: 0, periodo: 'Janeiro a Março' },
                2: { valor: 0, itens: 0, periodo: 'Abril a Junho' },
                3: { valor: 0, itens: 0, periodo: 'Julho a Setembro' },
                4: { valor: 0, itens: 0, periodo: 'Outubro a Dezembro' }
            };
            
            todosItens.forEach(item => {
                if (item.dataInicio) {
                    const dataInicio = new Date(item.dataInicio);
                    const mes = dataInicio.getMonth() + 1;
                    
                    let trimestre;
                    if (mes >= 1 && mes <= 3) trimestre = 1;
                    else if (mes >= 4 && mes <= 6) trimestre = 2;
                    else if (mes >= 7 && mes <= 9) trimestre = 3;
                    else if (mes >= 10 && mes <= 12) trimestre = 4;
                    
                    if (trimestre && item.valorIVA) {
                        ivaPorTrimestre[trimestre].valor += parseFloat(item.valorIVA) || 0;
                        ivaPorTrimestre[trimestre].itens += 1;
                    }
                }
            });
            
            return { ivaPorTrimestre, trimestreAtual };
        }
        
        // Função para criar prazos automáticos de IVA
        function criarPrazosIVA() {
            const trimestreAtual = obterTrimestreAtual();
            const prazos = obterPrazosIVA(trimestreAtual);
            
            // Verificar se já existem prazos de IVA para este trimestre
            const prazosSalvos = localStorage.getItem('prazos');
            let prazosExistentes = [];
            if (prazosSalvos) prazosExistentes = JSON.parse(prazosSalvos);
            
            const prazoEntregaExiste = prazosExistentes.some(p => 
                p.tipo === 'iva_entrega' && p.dataLimite === prazos.entrega
            );
            
            const prazoPagamentoExiste = prazosExistentes.some(p => 
                p.tipo === 'iva_pagamento' && p.dataLimite === prazos.pagamento
            );
            
            // Criar prazo de entrega se não existir
            if (!prazoEntregaExiste) {
                const prazoEntrega = {
                    id: Date.now() + 1,
                    clienteId: 0,
                    clienteNome: 'Sistema',
                    descricao: `Entrega da declaração de IVA - ${prazos.periodo}`,
                    dataLimite: prazos.entrega,
                    status: 'ativo',
                    tipo: 'iva_entrega',
                    prioridade: 'alta',
                    referenciaId: null,
                    dataCriacao: new Date().toISOString()
                };
                prazosExistentes.push(prazoEntrega);
            }
            
            // Criar prazo de pagamento se não existir
            if (!prazoPagamentoExiste) {
                const prazoPagamento = {
                    id: Date.now() + 2,
                    clienteId: 0,
                    clienteNome: 'Sistema',
                    descricao: `Pagamento do IVA - ${prazos.periodo}`,
                    dataLimite: prazos.pagamento,
                    status: 'ativo',
                    tipo: 'iva_pagamento',
                    prioridade: 'alta',
                    referenciaId: null,
                    dataCriacao: new Date().toISOString()
                };
                prazosExistentes.push(prazoPagamento);
            }
            
            // Salvar prazos
            localStorage.setItem('prazos', JSON.stringify(prazosExistentes));
            window.prazos = prazosExistentes;
        }
        
        // === FUNÇÕES DE IVA TRIMESTRAL ===
        
        function obterTrimestreAtual() {
            const agora = new Date();
            return Math.floor(agora.getMonth() / 3) + 1;
        }
        
        function calcularIVATrimestral_REMOVED() {
            const anoAtual = new Date().getFullYear();
            const trimestreAtual = obterTrimestreAtual();
            
            const ivaPorTrimestre = {
                1: { valor: 0, itens: 0, periodo: 'Jan-Mar' },
                2: { valor: 0, itens: 0, periodo: 'Abr-Jun' },
                3: { valor: 0, itens: 0, periodo: 'Jul-Set' },
                4: { valor: 0, itens: 0, periodo: 'Out-Dez' }
            };
            
            // Calcular IVA de todas as fontes
            const todasFontes = [
                ...contratos.map(c => ({ ...c, fonte: 'contrato' })),
                ...herancas.map(h => ({ ...h, fonte: 'heranca' })),
                ...migracoes.map(m => ({ ...m, fonte: 'migracao' })),
                ...registos.map(r => ({ ...r, fonte: 'registo' }))
            ];
            
            todasFontes.forEach(item => {
                if (item.dataCriacao) {
                    const data = new Date(item.dataCriacao);
                    const ano = data.getFullYear();
                    
                    if (ano === anoAtual) {
                        const trimestre = Math.floor(data.getMonth() / 3) + 1;
                        const valor = parseFloat(item.valor) || 0;
                        const iva = parseFloat(item.iva) || 0;
                        const valorIVA = (valor * iva) / 100;
                        
                        if (ivaPorTrimestre[trimestre]) {
                            ivaPorTrimestre[trimestre].valor += valorIVA;
                            ivaPorTrimestre[trimestre].itens++;
                        }
                    }
                }
            });
            
            return { ivaPorTrimestre, trimestreAtual };
        }
        
        function obterPrazosIVA(trimestre) {
            const anoAtual = new Date().getFullYear();
            const mesInicio = (trimestre - 1) * 3;
            const mesFim = mesInicio + 2;
            
            // Prazo de entrega: até o dia 10 do segundo mês após o fim do trimestre
            const dataEntrega = new Date(anoAtual, mesFim + 2, 10);
            
            // Prazo de pagamento: até o dia 15 do segundo mês após o fim do trimestre
            const dataPagamento = new Date(anoAtual, mesFim + 2, 15);
            
            const periodos = {
                1: 'Janeiro-Março',
                2: 'Abril-Junho',
                3: 'Julho-Setembro',
                4: 'Outubro-Dezembro'
            };
            
            return {
                trimestre: trimestre,
                periodo: periodos[trimestre],
                entrega: dataEntrega.toISOString(),
                pagamento: dataPagamento.toISOString()
            };
        }
        
        function criarPrazosIVA() {
            const trimestreAtual = obterTrimestreAtual();
            const prazosIVA = obterPrazosIVA(trimestreAtual);
            // const { ivaPorTrimestre } = calcularIVATrimestral(); // REMOVIDO
            
            // Verificar se já existe um prazo de IVA para este trimestre
            const prazoExistente = prazos.find(p => 
                p.tipo === 'iva_trimestral' && 
                p.trimestre === trimestreAtual &&
                new Date(p.dataCriacao).getFullYear() === new Date().getFullYear()
            );
            
            if (prazoExistente) {
                mostrarNotificacao('Já existe um prazo de IVA para este trimestre!', 'warning');
                return;
            }
            
            // Criar prazos de entrega e pagamento
            const prazoEntrega = {
                id: Date.now(),
                clienteId: null,
                clienteNome: 'Autoridade Tributária',
                tipo: 'iva_trimestral',
                trimestre: trimestreAtual,
                descricao: `Entrega da Declaração de IVA - ${prazosIVA.periodo}`,
                dataLimite: prazosIVA.entrega.split('T')[0],
                status: 'ativo',
                prioridade: 'alta',
                valorIVA: ivaPorTrimestre[trimestreAtual].valor,
                dataCriacao: new Date().toISOString()
            };
            
            const prazoPagamento = {
                id: Date.now() + 1,
                clienteId: null,
                clienteNome: 'Autoridade Tributária',
                tipo: 'iva_trimestral',
                trimestre: trimestreAtual,
                descricao: `Pagamento do IVA - ${prazosIVA.periodo} (€${ivaPorTrimestre[trimestreAtual].valor.toFixed(2)})`,
                dataLimite: prazosIVA.pagamento.split('T')[0],
                status: 'ativo',
                prioridade: 'alta',
                valorIVA: ivaPorTrimestre[trimestreAtual].valor,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoEntrega, prazoPagamento);
            salvarDados('prazos', prazos);
            
            mostrarNotificacao('Prazos de IVA criados com sucesso!', 'success');
            
            // Recarregar a seção de prazos se estiver ativa
            if (secaoAtiva === 'prazos') {
                carregarSecao('prazos');
            }
        }
        
        // Função para gerar relatório de IVA trimestral




        function salvarHonorarioEditado(event, id) {
            console.log('🔧 FUNÇÃO salvarHonorarioEditado INICIADA!');
            event.preventDefault();
            console.log('🔧 salvarHonorarioEditado chamado para ID:', id, 'Tipo:', typeof id);
            
            const honorariosSalvos = localStorage.getItem('honorarios');
            let honorarios = [];
            if (honorariosSalvos) {
                honorarios = JSON.parse(honorariosSalvos);
            }
            
            // Converter ID para number se necessário
            const idNum = typeof id === 'string' ? parseInt(id) : id;
            console.log('🔧 ID convertido para salvar:', idNum);
            console.log('🔧 Total de honorários:', honorarios.length);
            console.log('🔧 IDs dos honorários:', honorarios.map(h => h.id));
            
            // Tentar diferentes tipos de comparação
            let honorarioIndex = honorarios.findIndex(h => h.id == idNum);
            if (honorarioIndex === -1) {
                console.log('🔧 Tentando comparação com string...');
                honorarioIndex = honorarios.findIndex(h => h.id == id);
            }
            if (honorarioIndex === -1) {
                console.log('🔧 Tentando comparação com parseInt...');
                honorarioIndex = honorarios.findIndex(h => h.id == parseInt(id));
            }
            
            console.log('🔧 Índice encontrado:', honorarioIndex);
            
            if (honorarioIndex !== -1) {
                honorarios[honorarioIndex] = {
                    ...honorarios[honorarioIndex],
                    cliente: document.getElementById('editHonorarioCliente').value,
                    servico: document.getElementById('editHonorarioServico').value,
                    valor: parseFloat(document.getElementById('editHonorarioValor').value),
                    status: document.getElementById('editHonorarioStatus').value,
                    vencimento: document.getElementById('editHonorarioVencimento').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                localStorage.setItem('honorarios', JSON.stringify(honorarios));
                window.honorarios = honorarios;
                
                mostrarNotificacao('Honorário atualizado com sucesso!', 'success');
                
                const modal = document.getElementById('modalEdicaoHonorario');
                if (modal) {
                    modal.remove();
                }
                
                setTimeout(() => {
                    carregarSecao('honorarios');
                }, 100);
            } else {
                mostrarNotificacao('Erro: Honorário não encontrado!', 'error');
            }
        }

        function salvarHonorarioEditadoSimples(id) {
            console.log('🔧 salvarHonorarioEditadoSimples chamado para ID:', id, 'Tipo:', typeof id);
            
            // Buscar honorários do localStorage
            const honorariosSalvos = localStorage.getItem('honorarios');
            let honorarios = [];
            if (honorariosSalvos) {
                honorarios = JSON.parse(honorariosSalvos);
            }
            
            console.log('🔧 Total de honorários:', honorarios.length);
            console.log('🔧 IDs dos honorários:', honorarios.map(h => h.id));
            
            // Encontrar o honorário
            const honorarioIndex = honorarios.findIndex(h => h.id == id);
            console.log('🔧 Índice encontrado:', honorarioIndex);
            
            if (honorarioIndex !== -1) {
                // Atualizar os dados
                honorarios[honorarioIndex] = {
                    ...honorarios[honorarioIndex],
                    cliente: document.getElementById('editHonorarioCliente').value,
                    servico: document.getElementById('editHonorarioServico').value,
                    valor: parseFloat(document.getElementById('editHonorarioValor').value),
                    status: document.getElementById('editHonorarioStatus').value,
                    vencimento: document.getElementById('editHonorarioVencimento').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('honorarios', JSON.stringify(honorarios));
                window.honorarios = honorarios;
                
                mostrarNotificacao('Honorário atualizado com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoHonorario');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar seção
                setTimeout(() => {
                    carregarSecao('honorarios');
                }, 100);
            } else {
                console.log('🔧 Honorário não encontrado para atualizar!');
                mostrarNotificacao('Erro: Honorário não encontrado!', 'error');
            }
        }

        // === FUNÇÕES DIRETAS PARA REGISTOS ===
        function editarRegistoDireto(id) {
            console.log('🔧 editarRegistoDireto chamado com ID:', id);
            console.log('🔧 Tipo do ID:', typeof id);
            
            // Converter ID para número se necessário
            const idNumerico = parseInt(id);
            console.log('🔧 ID convertido para número:', idNumerico);
            
            if (isNaN(idNumerico)) {
                console.error('❌ ID inválido:', id);
                mostrarNotificacao('ID inválido!', 'error');
                return;
            }
            
            // Carregar dados do registo
            const registosSalvos = localStorage.getItem('registos');
            let registos = [];
            if (registosSalvos) registos = JSON.parse(registosSalvos);
            
            // Se não há registos, criar dados de teste
            if (!registos || registos.length === 0) {
                console.log('🔧 Criando dados de teste para registos');
                registos = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'João Silva',
                        tipo: 'Documentos',
                        descricao: 'Documentos para o estrangeiro',
                        valor: 100,
                        iva: 23,
                        valorComIva: 123,
                        status: 'pendente',
                        dataInicio: '2025-10-24'
                    },
                    {
                        id: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Certidões',
                        descricao: 'Certidão de nascimento',
                        valor: 50,
                        iva: 23,
                        valorComIva: 61.5,
                        status: 'concluido',
                        dataInicio: '2025-10-23'
                    }
                ];
                localStorage.setItem('registos', JSON.stringify(registos));
                window.registos = registos;
            }
            
            console.log('🔧 Registos disponíveis:', registos);
            console.log('🔧 Procurando registo com ID:', idNumerico);
            
            const registo = registos.find(r => r.id === idNumerico);
            if (!registo) {
                console.error('❌ Registo não encontrado com ID:', idNumerico);
                mostrarNotificacao('Registo não encontrado!', 'error');
                return;
            }
            
            console.log('✅ Registo encontrado:', registo);
            // Abrir modal de edição
            abrirModalEdicaoRegisto(registo);
        }

        function abrirAnexosRegisto(id) {
            console.log('🔧 abrirAnexosRegisto chamado com ID:', id);
            const registo = registos.find(r => r.id === parseInt(id));
            console.log('🔧 Registo encontrado:', registo);
            if (registo) {
                console.log('🔧 Chamando abrirModalAnexos para registo');
                abrirModalAnexos('registo', id, registo.clienteNome || 'Registo');
            } else {
                console.error('❌ Registo não encontrado com ID:', id);
                mostrarNotificacao('Registo não encontrado!', 'error');
            }
        }

        function excluirRegistoDireto(id) {
            console.log('🔧 excluirRegistoDireto chamado com ID:', id);
            
            if (confirm('Tem certeza que deseja excluir este registo? Esta ação não pode ser desfeita.')) {
                // Carregar dados do registo
                const registosSalvos = localStorage.getItem('registos');
                let registos = [];
                if (registosSalvos) registos = JSON.parse(registosSalvos);
                
                // Filtrar registo a ser excluído
                const registosAtualizados = registos.filter(r => r.id !== parseInt(id));
                
                // Salvar dados atualizados
                localStorage.setItem('registos', JSON.stringify(registosAtualizados));
                window.registos = registosAtualizados;
                
                mostrarNotificacao('Registo excluído com sucesso!', 'success');
                
                // Recarregar seção
                setTimeout(() => {
                    carregarSecao('registos');
                    if (typeof atualizarListaRegistos === 'function') {
                        atualizarListaRegistos(registosAtualizados);
                    }
                }, 100);
            }
        }

        // === FUNÇÕES PARA HERANÇAS ===
        function editarHerancaDireto(id) {
            console.log('🔧 editarHerancaDireto chamado com ID:', id);
            
            // Carregar dados da herança
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
            
            const heranca = herancas.find(h => h.id === parseInt(id));
            if (!heranca) {
                mostrarNotificacao('Herança não encontrada!', 'error');
                return;
            }
            
            console.log('✅ Herança encontrada:', heranca);
            // Abrir modal de edição
            abrirModalEdicaoHeranca(heranca);
        }

        function abrirAnexosHeranca(id) {
            console.log('🔧 abrirAnexosHeranca chamado com ID:', id);
            const heranca = herancas.find(h => h.id === parseInt(id));
            console.log('🔧 Herança encontrada:', heranca);
            if (heranca) {
                console.log('🔧 Chamando abrirModalAnexos para herança');
                abrirModalAnexos('heranca', id, heranca.clienteNome || 'Herança');
            } else {
                console.error('❌ Herança não encontrada com ID:', id);
                mostrarNotificacao('Herança não encontrada!', 'error');
            }
        }

        function excluirHerancaDireto(id) {
            console.log('🔧 excluirHerancaDireto chamado com ID:', id);
            
            if (confirm('Tem certeza que deseja excluir esta herança? Esta ação não pode ser desfeita.')) {
                console.log('🔧 Usuário confirmou exclusão');
                
                // Carregar dados da herança
                const herancasSalvas = localStorage.getItem('herancas');
                let herancas = [];
                if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
                
                console.log('🔧 Heranças antes da exclusão:', herancas.length);
                
                // Filtrar herança a ser excluída
                const herancasAtualizadas = herancas.filter(h => h.id !== parseInt(id));
                
                console.log('🔧 Heranças após exclusão:', herancasAtualizadas.length);
                
                // Salvar dados atualizados
                localStorage.setItem('herancas', JSON.stringify(herancasAtualizadas));
                window.herancas = herancasAtualizadas;
                
                console.log('✅ Heranças salvas no localStorage');
                
                mostrarNotificacao('Herança excluída com sucesso!', 'success');
                
                // Recarregar seção
                setTimeout(() => {
                    console.log('🔧 Recarregando seção heranças');
                    carregarSecao('herancas');
                    if (typeof atualizarListaHerancas === 'function') {
                        console.log('🔧 Chamando atualizarListaHerancas');
                        atualizarListaHerancas(herancasAtualizadas);
                    }
                }, 100);
            }
        }


        // Tornar funções globais
        window.abrirAnexosContrato = abrirAnexosContrato;
        window.abrirAnexosHeranca = abrirAnexosHeranca;
        window.abrirAnexosMigracao = abrirAnexosMigracao;
        window.abrirAnexosRegisto = abrirAnexosRegisto;
        window.abrirModalAnexos = abrirModalAnexos;
        window.visualizarAnexo = visualizarAnexo;
        window.baixarAnexo = baixarAnexo;
        window.adicionarAnexoContrato = adicionarAnexoContrato;
        window.adicionarAnexoHeranca = adicionarAnexoHeranca;
        window.adicionarAnexoMigracao = adicionarAnexoMigracao;
        window.adicionarAnexoRegisto = adicionarAnexoRegisto;
        window.removerAnexoContrato = removerAnexoContrato;
        window.removerAnexoHeranca = removerAnexoHeranca;
        window.removerAnexoMigracao = removerAnexoMigracao;
        
        // VERIFICAR SE FUNÇÕES ESTÃO DEFINIDAS
        console.log('🔧 VERIFICAÇÃO DE FUNÇÕES:');
        console.log('🔧 editarRegistoDireto:', typeof editarRegistoDireto);
        console.log('🔧 abrirAnexosRegisto:', typeof abrirAnexosRegisto);
        console.log('🔧 excluirRegistoDireto:', typeof excluirRegistoDireto);
        console.log('🔧 visualizarAnexo:', typeof visualizarAnexo);
        console.log('🔧 baixarAnexo:', typeof baixarAnexo);
        
        // TESTAR FUNÇÕES DIRETAMENTE
        console.log('🔧 TESTANDO FUNÇÕES:');
        if (typeof editarRegistoDireto === 'function') {
            console.log('✅ editarRegistoDireto está definida');
        } else {
            console.error('❌ editarRegistoDireto NÃO está definida');
        }
        
        if (typeof abrirAnexosRegisto === 'function') {
            console.log('✅ abrirAnexosRegisto está definida');
        } else {
            console.error('❌ abrirAnexosRegisto NÃO está definida');
        }
        
        if (typeof excluirRegistoDireto === 'function') {
            console.log('✅ excluirRegistoDireto está definida');
        } else {
            console.error('❌ excluirRegistoDireto NÃO está definida');
        }
        window.removerAnexoRegisto = removerAnexoRegisto;
        window.toggleTipoPersonalizado = toggleTipoPersonalizado;
        window.atualizarContrato = atualizarContrato;
        window.abrirModalEdicaoContrato = abrirModalEdicaoContrato;
        window.editarContratoDireto = editarContratoDireto;
        window.excluirContratoDireto = excluirContratoDireto;
        window.editarHerancaDireto = editarHerancaDireto;
        window.excluirHerancaDireto = excluirHerancaDireto;
        window.editarMigracaoDireto = editarMigracaoDireto;
        window.excluirMigracaoDireto = excluirMigracaoDireto;
        window.editarRegistoDireto = editarRegistoDireto;
        window.excluirRegistoDireto = excluirRegistoDireto;
        window.abrirModalEdicaoMigracao = abrirModalEdicaoMigracao;
        window.salvarMigracaoEditada = salvarMigracaoEditada;
        window.editarHonorarioDireto = editarHonorarioDireto;
        window.excluirHonorarioDireto = excluirHonorarioDireto;
        window.salvarHonorarioEditado = salvarHonorarioEditado;
        
        // Service Worker Registration REMOVIDO
        
        // PWA completamente removido

    </script>
</body>
</html>
