<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ana Paula Medina - Sistema Legal v38.0 CORRIGIDO</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema completo de gestão jurídica para Solicitadores">
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Sistema Legal">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzNiODJmNiIvPgo8cGF0aCBkPSJNMTYgOEMxMS41ODE3IDggOCAxMS41ODE3IDggMTZTMTEuNTgxNyAyNCAxNiAyNFMyNCAyMC40MTgzIDI0IDE2UzIwLjQxODMgOCAxNiA4Wk0xNiAyMEMxMy43OTE0IDIwIDEyIDE4LjIwODYgMTIgMTZTMTMuNzkxNCAxMiAxNiAxMlMyMCAxMy43OTE0IDIwIDE2UzE4LjIwODYgMjAgMTYgMjBaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMzYjgyZjYiLz4KPHBhdGggZD0iTTk2IDQ4QzY5LjQ5IDQ4IDQ4IDY5LjQ5IDQ4IDk2UzY5LjQ5IDE0NCA5NiAxNDRTMTQ0IDEyMi41MSAxNDQgOTZTMTIyLjUxIDQ4IDk2IDQ4Wk05NiAxMjhDNzMuOTA5IDEyOCA1NiAxMTAuMDkgNTYgODhTNzMuOTA5IDQ4IDk2IDQ4UzEzNiA2NS45MSAxMzYgODhTMTE4LjA5IDEyOCA5NiAxMjhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #000000;
            --secondary-color: #374151;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #3b82f6;
        }

        .sidebar { 
            background: var(--primary-color) !important; 
            min-height: 100vh !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 224px !important;
            z-index: 1000 !important;
            transition: all 0.3s ease;
        }

        .sidebar-item { 
            color: #ffffff !important; 
            transition: all 0.2s ease;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 4px 8px;
            display: flex;
            align-items: center;
            text-decoration: none;
            cursor: pointer;
        }

        .sidebar-item:hover { 
            background: rgba(255, 255, 255, 0.1); 
            transform: translateX(4px);
        }
        
        .sidebar-item.active { 
            background: var(--secondary-color); 
            border-left: 4px solid #6b7280;
        }

        .main-content {
            margin-left: 224px;
            transition: margin-left 0.3s ease;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        @media (max-width: 1024px) {
            .mobile-menu-btn {
                display: block;
            }
            
            .sidebar {
                transform: translateX(-100%);
                width: 100% !important;
                max-width: 320px !important;
                z-index: 1000;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0 !important;
                padding-top: 80px;
            }
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .main-content {
                padding: 10px;
            }
            
            .card {
                margin-bottom: 16px;
                padding: 16px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            /* Tabelas responsivas */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table-responsive table {
                min-width: 600px;
            }
            
            /* Modais mobile */
            .modal-content {
                margin: 10px;
                max-height: calc(100vh - 20px);
                overflow-y: auto;
            }
            
            /* Botões de ação menores */
            .btn-sm {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            /* Grid responsivo */
            .grid-cols-1 {
                grid-template-columns: 1fr !important;
            }
            
            .md\\:grid-cols-3 {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 5px;
            }
            
            .card {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .btn {
                padding: 10px 14px;
                font-size: 13px;
            }
            
            .sidebar-item {
                padding: 10px 12px;
                font-size: 14px;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }

        .card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-error {
            background: var(--error-color);
            color: white;
        }

        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--error-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pendente {
            background: #fef3c7;
            color: #92400e;
        }

        .status-pago {
            background: #d1fae5;
            color: #065f46;
        }

        .status-vencido {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-ativo {
            background: #d1fae5;
            color: #065f46;
        }

        .status-inativo {
            background: #e5e7eb;
            color: #374151;
        }

        .status-suspenso {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Status das Áreas de Execução */
        .status-pendente {
            background: #dcfce7;
            color: #166534;
        }

        .status-em_andamento {
            background: #fef3c7;
            color: #92400e;
        }

        .status-concluido {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Status de Prioridade dos Prazos */
        .status-baixa {
            background: #f3f4f6;
            color: #374151;
        }

        .status-media {
            background: #fef3c7;
            color: #92400e;
        }

        .status-alta {
            background: #fed7aa;
            color: #c2410c;
        }

        .status-critica {
            background: #fee2e2;
            color: #991b1b;
        }

        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .table-responsive table {
            width: 100%;
            border-collapse: collapse;
        }

        .table-responsive th,
        .table-responsive td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .table-responsive th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .table-responsive tbody tr:hover {
            background-color: #f9fafb;
        }
        
        /* Correção definitiva para alinhamento das colunas */
        .tabela-migracao th,
        .tabela-migracao td {
            vertical-align: top !important;
        }
        
        .tabela-migracao th:nth-child(1),
        .tabela-migracao td:nth-child(1) {
            width: 20% !important;
            min-width: 150px !important;
        }
        
        .tabela-migracao th:nth-child(2),
        .tabela-migracao td:nth-child(2) {
            width: 15% !important;
            min-width: 120px !important;
        }
        
        .tabela-migracao th:nth-child(3),
        .tabela-migracao td:nth-child(3) {
            width: 20% !important;
            min-width: 150px !important;
        }
        
        .tabela-migracao th:nth-child(4),
        .tabela-migracao td:nth-child(4) {
            width: 15% !important;
            min-width: 120px !important;
        }
        
        .tabela-migracao th:nth-child(5),
        .tabela-migracao td:nth-child(5) {
            width: 12% !important;
            min-width: 100px !important;
        }
        
        .tabela-migracao th:nth-child(6),
        .tabela-migracao td:nth-child(6) {
            width: 10% !important;
            min-width: 100px !important;
        }
        
        .tabela-migracao th:nth-child(7),
        .tabela-migracao td:nth-child(7) {
            width: 8% !important;
            min-width: 80px !important;
        }


        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .space-x-2 > * + * { margin-left: 8px; }
        .space-x-4 > * + * { margin-left: 16px; }
        .text-center { text-align: center; }
        .font-semibold { font-weight: 600; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-800 { color: #1f2937; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Sistema de Notificações -->
    <div id="notificationContainer"></div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()">
        <i data-lucide="menu" class="w-5 h-5"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="p-6">
            <h2 class="text-white text-xl font-bold mb-6">Sistema Legal</h2>
            <nav class="space-y-2">
                <a href="#" onclick="carregarSecao('dashboard')" class="sidebar-item active" id="nav-dashboard">
                    <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                    Visão Geral
                </a>
                <a href="#" onclick="carregarSecao('clientes')" class="sidebar-item" id="nav-clientes">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                    Clientes
                </a>
                <a href="#" onclick="carregarSecao('honorarios')" class="sidebar-item" id="nav-honorarios">
                    <i data-lucide="dollar-sign" class="w-5 h-5 mr-3"></i>
                    Honorários
                </a>
                <a href="#" onclick="carregarSecao('contratos')" class="sidebar-item" id="nav-contratos">
                    <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                    Contratos
                </a>
                <a href="#" onclick="carregarSecao('herancas')" class="sidebar-item" id="nav-herancas">
                    <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                    Heranças
                </a>
                <a href="#" onclick="carregarSecao('migracoes')" class="sidebar-item" id="nav-migracao">
                    <i data-lucide="users-2" class="w-5 h-5 mr-3"></i>
                    Migração
                </a>
                <a href="#" onclick="carregarSecao('registos')" class="sidebar-item" id="nav-registos">
                    <i data-lucide="book-open" class="w-5 h-5 mr-3"></i>
                    Registos
                </a>
                <a href="#" onclick="carregarSecao('prazos')" class="sidebar-item" id="nav-prazos">
                    <i data-lucide="clock" class="w-5 h-5 mr-3"></i>
                    Prazos
                </a>
                <a href="#" onclick="carregarSecao('iva-trimestral')" class="sidebar-item" id="nav-iva-trimestral">
                    <i data-lucide="receipt" class="w-5 h-5 mr-3"></i>
                    IVA Trimestral
                </a>
                <a href="#" onclick="carregarSecao('notificacoes')" class="sidebar-item" id="nav-notificacoes">
                    <i data-lucide="bell" class="w-5 h-5 mr-3"></i>
                    Notificações
                    <span id="badgeNotificacoes" class="hidden bg-red-500 text-white text-xs rounded-full px-2 py-1 ml-2">0</span>
                </a>
            <a href="#" onclick="carregarSecao('relatorios')" class="sidebar-item" id="nav-relatorios">
                <i data-lucide="bar-chart-3" class="w-5 h-5 mr-3"></i>
                Relatórios
            </a>
            <a href="#" onclick="carregarSecao('backup')" class="sidebar-item" id="nav-backup">
                <i data-lucide="database" class="w-5 h-5 mr-3"></i>
                Backup
            </a>
            </nav>
        </div>
    </div>

    <!-- Menu Mobile -->
    <button id="menuHamburguer" class="fixed top-4 left-4 z-50 lg:hidden bg-black text-white p-2 rounded">
        <i data-lucide="menu" class="w-6 h-6"></i>
    </button>

    <!-- Conteúdo Principal -->
    <div class="main-content min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Sistema Legal</h1>
                    <div class="flex items-center space-x-4">
                        <button onclick="exportarDados()" class="btn btn-primary">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Exportar
                        </button>
                        <button onclick="importarDados()" class="btn btn-success">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                            Importar
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conteúdo Dinâmico -->
        <main class="p-6">
            <div id="conteudoDinamico">
                <!-- Dashboard será carregado aqui -->
            </div>
        </main>
    </div>

    <!-- Modais -->
    <div id="modalContainer"></div>

    <script>
        // === SISTEMA LEGAL CORRIGIDO ===
        
        // Dados globais
        let clientes = [];
        let honorarios = [];
        let contratos = [];
        let prazos = [];
        let notificacoes = [];
        let herancas = [];
        let migracoes = [];
        let registos = [];
        let secaoAtiva = 'dashboard';
        
        // Garantir que as variáveis estão definidas globalmente
        window.clientes = clientes;
        window.honorarios = honorarios;
        window.contratos = contratos;
        window.prazos = prazos;
        window.notificacoes = notificacoes;
        window.herancas = herancas;
        window.migracoes = migracoes;
        window.registos = registos;

        // === FUNÇÃO DE TESTE ===
        function testarBotao() {
            alert('BOTÃO FUNCIONANDO!');
            console.log('BOTÃO FUNCIONANDO!');
        }

        // === FUNÇÕES DE EDIÇÃO DIRETA ===
        function editarContratoDireto(id) {
            console.log('🔧 EDITANDO CONTRATO ID:', id);
            alert('EDITANDO CONTRATO ID: ' + id);
            
            const contrato = contratos.find(c => c.id === id);
            if (contrato) {
                console.log('✅ Contrato encontrado:', contrato);
                alert('Contrato encontrado: ' + contrato.clienteNome);
                
                // Fechar qualquer modal aberto primeiro
                fecharModal();
                
                // Aguardar um pouco para garantir que o modal anterior foi fechado
                setTimeout(() => {
                    console.log('🚀 Abrindo modal de edição...');
                    abrirModalEdicaoContrato(contrato);
                }, 200);
            } else {
                console.error('❌ Contrato não encontrado com ID:', id);
                alert('❌ Contrato não encontrado com ID: ' + id);
                mostrarNotificacao('Contrato não encontrado!', 'error');
            }
        }

        function editarHonorarioDireto(id) {
            console.log('🔧 EDITANDO HONORÁRIO ID:', id);
            alert('EDITANDO HONORÁRIO ID: ' + id);
            
            const honorario = honorarios.find(h => h.id === id);
            if (honorario) {
                console.log('✅ Honorário encontrado:', honorario);
                alert('Honorário encontrado: ' + honorario.cliente);
                
                // Fechar qualquer modal aberto primeiro
                fecharModal();
                
                // Aguardar um pouco para garantir que o modal anterior foi fechado
                setTimeout(() => {
                    console.log('🚀 Abrindo modal de edição...');
                    abrirModalEdicaoHonorario(honorario);
                }, 200);
            } else {
                console.error('❌ Honorário não encontrado com ID:', id);
                alert('❌ Honorário não encontrado com ID: ' + id);
                mostrarNotificacao('Honorário não encontrado!', 'error');
            }
        }

        function editarClienteDireto(id) {
            console.log('EDITANDO CLIENTE ID:', id);
            
            const cliente = clientes.find(c => c.id === id);
            if (cliente) {
                console.log('Cliente encontrado:', cliente);
                
                // Fechar qualquer modal aberto primeiro
                fecharModal();
                
                // Aguardar um pouco para garantir que o modal anterior foi fechado
                setTimeout(() => {
                    abrirModalEdicaoCliente(cliente);
                }, 100);
            } else {
                console.error('Cliente não encontrado com ID:', id);
                mostrarNotificacao('Cliente não encontrado!', 'error');
            }
        }

        // Inicialização
        function init() {
            console.log('🚀 Inicializando Sistema Legal');
            carregarDados();
            carregarDadosExemplo();
            carregarSecao('dashboard');
            configurarEventos();
            atualizarInterface();
            iniciarSistemaNotificacoes();
            iniciarSistemaBackup();
        }

        function carregarDados() {
            try {
                const clientesSalvos = localStorage.getItem('clientes');
                if (clientesSalvos) {
                    clientes = JSON.parse(clientesSalvos);
                    window.clientes = clientes;
                }

                const honorariosSalvos = localStorage.getItem('honorarios');
                if (honorariosSalvos) {
                    honorarios = JSON.parse(honorariosSalvos);
                    window.honorarios = honorarios;
                }

                const contratosSalvos = localStorage.getItem('contratos');
                if (contratosSalvos) {
                    contratos = JSON.parse(contratosSalvos);
                    window.contratos = contratos;
                }

                const prazosSalvos = localStorage.getItem('prazos');
                if (prazosSalvos) {
                    prazos = JSON.parse(prazosSalvos);
                    window.prazos = prazos;
                }

                const notificacoesSalvas = localStorage.getItem('notificacoes');
                if (notificacoesSalvas) {
                    notificacoes = JSON.parse(notificacoesSalvas);
                    window.notificacoes = notificacoes;
                }

                const herancasSalvas = localStorage.getItem('herancas');
                if (herancasSalvas) {
                    herancas = JSON.parse(herancasSalvas);
                    window.herancas = herancas;
                }

                const migracoesSalvas = localStorage.getItem('migracoes');
                if (migracoesSalvas) {
                    migracoes = JSON.parse(migracoesSalvas);
                    window.migracoes = migracoes;
                }

                const registosSalvos = localStorage.getItem('registos');
                if (registosSalvos) {
                    registos = JSON.parse(registosSalvos);
                    window.registos = registos;
                }

                console.log('✅ Dados carregados com sucesso');
            } catch (error) {
                console.error('❌ Erro ao carregar dados:', error);
                mostrarNotificacao('Erro ao carregar dados salvos', 'error');
            }
        }

        function carregarDadosExemplo() {
            if (clientes.length === 0) {
                clientes = [
                    {
                        id: 1,
                        nome: 'João Silva',
                        email: 'joao@email.com',
                        telefone: '123456789',
                        nif: '123456789',
                        endereco: 'Rua das Flores, 123',
                        status: 'ativo',
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        nome: 'Maria Santos',
                        email: 'maria@email.com',
                        telefone: '987654321',
                        nif: '987654321',
                        endereco: 'Av. Principal, 456',
                        status: 'ativo',
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('clientes', clientes);
            }

            if (honorarios.length === 0) {
                honorarios = [
                    {
                        id: 1,
                        cliente: 'João Silva',
                        servico: 'Consulta Jurídica',
                        valor: 150.00,
                        status: 'pago',
                        vencimento: new Date().toISOString().split('T')[0],
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        cliente: 'Maria Santos',
                        servico: 'Elaboração de Contrato',
                        valor: 300.00,
                        status: 'pendente',
                        vencimento: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('honorarios', honorarios);
            }

            if (contratos.length === 0) {
                contratos = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'João Silva',
                        tipo: 'Prestação de Serviços',
                        descricao: 'Assessoria jurídica empresarial',
                        valor: 5000.00,
                        iva: 23,
                        valorIVA: 1150.00,
                        valorTotal: 6150.00,
                        dataInicio: new Date().toISOString().split('T')[0],
                        dataFim: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'ativo',
                        observacoes: 'Contrato de assessoria jurídica anual',
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Consultoria',
                        descricao: 'Consultoria em direito trabalhista',
                        valor: 2500.00,
                        iva: 23,
                        valorIVA: 575.00,
                        valorTotal: 3075.00,
                        dataInicio: new Date().toISOString().split('T')[0],
                        dataFim: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'ativo',
                        observacoes: 'Consultoria específica para questões trabalhistas',
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('contratos', contratos);
            }

            if (prazos.length === 0) {
                prazos = [
                    {
                        id: 1,
                        honorarioId: 1,
                        clienteId: 1,
                        clienteNome: 'João Silva',
                        tipo: 'Vencimento',
                        descricao: 'Vencimento de honorário - Consultoria jurídica',
                        dataLimite: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
                        status: 'ativo',
                        prioridade: 'alta',
                        notificacoes: [],
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        honorarioId: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Lembrete',
                        descricao: 'Lembrete de pagamento - Elaboração de contrato',
                        dataLimite: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                        status: 'ativo',
                        prioridade: 'media',
                        notificacoes: [],
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('prazos', prazos);
            }

            if (notificacoes.length === 0) {
                notificacoes = [];
                salvarDados('notificacoes', notificacoes);
            }

            if (herancas.length === 0) {
                herancas = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'João Silva',
                        tipo: 'Inventário',
                        descricao: 'Processo de inventário de bens',
                        valor: 15000.00,
                        iva: 23,
                        valorComIva: 18450.00,
                        status: 'em_andamento',
                        dataInicio: new Date().toISOString().split('T')[0],
                        observacoes: 'Inventário de bens móveis e imóveis',
                        parceria: false,
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Partilha',
                        descricao: 'Processo de partilha de herança',
                        valor: 25000.00,
                        iva: 23,
                        valorComIva: 30750.00,
                        status: 'concluido',
                        dataInicio: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        observacoes: 'Partilha entre 3 herdeiros',
                        parceria: true,
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('herancas', herancas);
            }

            if (migracoes.length === 0) {
                migracoes = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'João Silva',
                        tipo: 'Nacionalidade',
                        descricao: 'Processo de aquisição de nacionalidade portuguesa',
                        valor: 500.00,
                        iva: 23,
                        valorComIva: 615.00,
                        status: 'em_andamento',
                        dataInicio: new Date().toISOString().split('T')[0],
                        observacoes: 'Processo via casamento',
                        parceria: false,
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Residência',
                        descricao: 'Renovação de autorização de residência',
                        valor: 300.00,
                        iva: 23,
                        valorComIva: 369.00,
                        status: 'pendente',
                        dataInicio: new Date().toISOString().split('T')[0],
                        observacoes: 'Renovação por trabalho',
                        parceria: true,
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('migracoes', migracoes);
            }

            if (registos.length === 0) {
                registos = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'João Silva',
                        tipo: 'Nascimento',
                        descricao: 'Registo de nascimento de filho',
                        valor: 150.00,
                        iva: 23,
                        valorComIva: 184.50,
                        status: 'concluido',
                        dataInicio: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        observacoes: 'Registo no consulado',
                        parceria: false,
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Casamento',
                        descricao: 'Registo de casamento civil',
                        valor: 200.00,
                        iva: 23,
                        valorComIva: 246.00,
                        status: 'em_andamento',
                        dataInicio: new Date().toISOString().split('T')[0],
                        observacoes: 'Casamento com cidadão português',
                        parceria: true,
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('registos', registos);
            }

        }

        function salvarDados(chave, dados) {
            console.log('🔧 salvarDados chamado:', chave, dados);
            try {
                // Verificar se os dados são válidos
                if (!dados || !Array.isArray(dados)) {
                    console.error('❌ Dados inválidos para salvar:', dados);
                    mostrarNotificacao('Erro: Dados inválidos', 'error');
                    return;
                }
                
                // Salvar no localStorage
                const dadosString = JSON.stringify(dados);
                localStorage.setItem(chave, dadosString);
                console.log('✅ Dados salvos no localStorage:', chave, dadosString.length, 'caracteres');
                
                // Atualizar variáveis globais
                if (chave === 'clientes') {
                    clientes = dados;
                    window.clientes = clientes;
                } else if (chave === 'honorarios') {
                    honorarios = dados;
                    window.honorarios = honorarios;
                } else if (chave === 'contratos') {
                    contratos = dados;
                    window.contratos = contratos;
                } else if (chave === 'prazos') {
                    prazos = dados;
                    window.prazos = prazos;
                } else if (chave === 'notificacoes') {
                    notificacoes = dados;
                    window.notificacoes = notificacoes;
                } else if (chave === 'herancas') {
                    herancas = dados;
                    window.herancas = herancas;
                } else if (chave === 'migracoes') {
                    migracoes = dados;
                    window.migracoes = migracoes;
                } else if (chave === 'registos') {
                    registos = dados;
                    window.registos = registos;
                }
                
                console.log(`✅ Dados ${chave} salvos com sucesso - ${dados.length} itens`);
                
                // Verificar se foi salvo corretamente
                const dadosSalvos = localStorage.getItem(chave);
                if (dadosSalvos) {
                    console.log('✅ Verificação: Dados confirmados no localStorage');
                } else {
                    console.error('❌ Verificação: Dados não encontrados no localStorage');
                }
                
            } catch (error) {
                console.error('❌ Erro ao salvar dados:', error);
                mostrarNotificacao('Erro ao salvar dados: ' + error.message, 'error');
            }
        }

        function configurarEventos() {
            document.getElementById('menuHamburguer')?.addEventListener('click', () => {
                toggleSidebar();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    fecharModal();
                }
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
        }

        function carregarSecao(secao) {
            console.log('🔧 carregarSecao chamado para:', secao);
            
            // Fechar qualquer modal aberto antes de carregar nova seção
            fecharModal();
            
            // Recarregar dados do localStorage antes de gerar conteúdo
            carregarDados();
            
            secaoAtiva = secao;
            atualizarNavegacao();
            atualizarTitulo(secao);
            
            const conteudo = gerarConteudoSecao(secao);
            console.log('🔧 Conteúdo gerado:', conteudo ? 'SIM' : 'NÃO');
            const conteudoElement = document.getElementById('conteudoDinamico');
            if (conteudoElement) {
                conteudoElement.innerHTML = conteudo;
                console.log('✅ Conteúdo inserido no DOM');
            } else {
                console.error('❌ Elemento conteudoDinamico não encontrado');
            }
            
            inicializarSecao(secao);
            
            // Inicializar filtros para seções específicas
            if (secao === 'migracoes') {
                setTimeout(() => {
                    aplicarFiltrosMigracoes();
                }, 100);
            }
            
            if (secao === 'contratos') {
                setTimeout(() => {
                    aplicarFiltrosContratos();
                }, 100);
            }
            
            if (secao === 'honorarios') {
                setTimeout(() => {
                    aplicarFiltrosHonorarios();
                }, 100);
            }
            
            console.log('✅ Seção carregada:', secao);
            
            // Só tentar fechar sidebar se estiver no sistema principal
            if (window.innerWidth <= 1024 && document.getElementById('sidebar')) {
                toggleSidebar();
            }
        }

        function atualizarNavegacao() {
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            if (sidebarItems.length > 0) {
                sidebarItems.forEach(item => {
                    item.classList.remove('active');
                });
                const activeItem = document.getElementById(`nav-${secaoAtiva}`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }
        }

        function atualizarTitulo(secao) {
            console.log('🔧 atualizarTitulo chamado para:', secao);
            
            const titulos = {
                dashboard: 'Visão Geral',
                clientes: 'Gestão de Clientes',
                honorarios: 'Gestão de Honorários',
                contratos: 'Gestão de Contratos',
                prazos: 'Gestão de Prazos',
                notificacoes: 'Central de Notificações',
                herancas: 'Gestão de Heranças',
                migracoes: 'Gestão de Migração',
                registos: 'Gestão de Registos',
                'iva-trimestral': 'IVA Trimestral',
                relatorios: 'Gestão de Relatórios',
                backup: 'Sistema de Backup'
            };
            
            const tituloElement = document.getElementById('tituloSecao');
            const subtituloElement = document.getElementById('subtituloSecao');
            const pageTitleElement = document.getElementById('pageTitle');
            
            console.log('🔧 Elementos encontrados:', {
                tituloSecao: tituloElement ? 'SIM' : 'NÃO',
                subtituloSecao: subtituloElement ? 'SIM' : 'NÃO',
                pageTitle: pageTitleElement ? 'SIM' : 'NÃO'
            });
            
            const titulo = titulos[secao] || 'Sistema Legal';
            
            if (tituloElement) {
                tituloElement.textContent = titulo;
                console.log('✅ tituloSecao atualizado para:', titulo);
            }
            if (subtituloElement) {
                subtituloElement.textContent = 'Visão geral do sistema';
            }
            if (pageTitleElement) {
                pageTitleElement.textContent = titulo;
                console.log('✅ pageTitle atualizado para:', titulo);
            }
        }

        function gerarConteudoSecao(secao) {
            console.log('🔧 gerarConteudoSecao chamado para:', secao);
            console.log('🔧 migracoes array antes:', migracoes);
            
            // Garantir que migracoes existe
            if (!migracoes) {
                migracoes = [];
                console.log('🔧 migracoes inicializado como array vazio');
            }
            
            const conteudos = {
                dashboard: gerarDashboard(),
                clientes: gerarClientes(),
                honorarios: gerarHonorarios(),
                contratos: gerarContratos(),
                prazos: gerarPrazos(),
                notificacoes: gerarNotificacoes(),
                herancas: gerarHerancas(),
                migracoes: gerarMigracao(),
                registos: gerarRegistos(),
                'iva-trimestral': gerarRelatorioIVATrimestral(),
                relatorios: gerarRelatorios(),
                backup: gerarBackup()
            };
            
            console.log('🔧 Conteúdos disponíveis:', Object.keys(conteudos));
            console.log('🔧 Conteúdo para migracoes:', conteudos.migracoes ? 'EXISTE' : 'NÃO EXISTE');
            console.log('🔧 Conteúdo migracoes:', conteudos.migracoes);
            
            return conteudos[secao] || '<p>Seção não encontrada</p>';
        }

        function gerarDashboard() {
            const totalClientes = clientes.length;
            const totalHonorarios = honorarios.length;
            const valorTotal = honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            const honorariosPagos = honorarios.filter(h => h.status === 'pago').length;
            const honorariosPendentes = honorarios.filter(h => h.status === 'pendente').length;
            const totalHerancas = herancas.length;
            const totalMigracoes = migracoes.length;
            const totalRegistos = registos.length;
            
            // Calcular IVA acumulado trimestral
            const agora = new Date();
            const trimestreAtual = Math.floor(agora.getMonth() / 3);
            const anoAtual = agora.getFullYear();
            const inicioTrimestre = new Date(anoAtual, trimestreAtual * 3, 1);
            const fimTrimestre = new Date(anoAtual, (trimestreAtual + 1) * 3, 0);
            
            // Calcular IVA de todos os itens do trimestre atual
            let ivaAcumuladoTrimestral = 0;
            
            // IVA dos honorários do trimestre
            const honorariosTrimestre = honorarios.filter(h => {
                const dataHonorario = new Date(h.dataCriacao);
                return dataHonorario >= inicioTrimestre && dataHonorario <= fimTrimestre;
            });
            honorariosTrimestre.forEach(h => {
                const valor = parseFloat(h.valor) || 0;
                const iva = parseFloat(h.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            // IVA dos contratos do trimestre
            const contratosTrimestre = contratos.filter(c => {
                const dataContrato = new Date(c.dataCriacao);
                return dataContrato >= inicioTrimestre && dataContrato <= fimTrimestre;
            });
            contratosTrimestre.forEach(c => {
                const valor = parseFloat(c.valor) || 0;
                const iva = parseFloat(c.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            // IVA das heranças do trimestre
            const herancasTrimestre = herancas.filter(h => {
                const dataHeranca = new Date(h.dataCriacao);
                return dataHeranca >= inicioTrimestre && dataHeranca <= fimTrimestre;
            });
            herancasTrimestre.forEach(h => {
                const valor = parseFloat(h.valor) || 0;
                const iva = parseFloat(h.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            // IVA das migrações do trimestre
            const migracoesTrimestre = migracoes.filter(m => {
                const dataMigracao = new Date(m.dataCriacao);
                return dataMigracao >= inicioTrimestre && dataMigracao <= fimTrimestre;
            });
            migracoesTrimestre.forEach(m => {
                const valor = parseFloat(m.valor) || 0;
                const iva = parseFloat(m.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            // IVA dos registos do trimestre
            const registosTrimestre = registos.filter(r => {
                const dataRegisto = new Date(r.dataCriacao);
                return dataRegisto >= inicioTrimestre && dataRegisto <= fimTrimestre;
            });
            registosTrimestre.forEach(r => {
                const valor = parseFloat(r.valor) || 0;
                const iva = parseFloat(r.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            const nomeTrimestre = ['1º Trimestre', '2º Trimestre', '3º Trimestre', '4º Trimestre'][trimestreAtual];

            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Clientes</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalClientes}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Honorários</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalHonorarios}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Pagos</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosPagos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-purple-100 rounded-lg">
                                    <i data-lucide="trending-up" class="w-6 h-6 text-purple-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">€${(Math.round(valorTotal * 100) / 100).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="receipt" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">IVA Acumulado ${nomeTrimestre}</p>
                                    <p class="text-2xl font-bold text-gray-900">€${Number(ivaAcumuladoTrimestral).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Status dos Honorários</h3>
                            <div class="chart-container">
                                <canvas id="chartHonorarios"></canvas>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Resumo Financeiro</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                    <span class="text-green-800 font-medium">Honorários Pagos</span>
                                    <span class="text-green-600 font-bold">${honorariosPagos}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                                    <span class="text-yellow-800 font-medium">Honorários Pendentes</span>
                                    <span class="text-yellow-600 font-bold">${honorariosPendentes}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                    <span class="text-blue-800 font-medium">Valor Total</span>
                                    <span class="text-blue-600 font-bold">€${(Math.round(valorTotal * 100) / 100).toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Últimos Clientes</h3>
                            <div class="space-y-3">
                                ${clientes.slice(-3).map(cliente => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium">${cliente.nome}</p>
                                            <p class="text-sm text-gray-600">${cliente.email}</p>
                                        </div>
                                        <span class="status-badge status-${cliente.status || 'ativo'}">${cliente.status || 'Ativo'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Últimos Honorários</h3>
                            <div class="space-y-3">
                                ${honorarios.slice(-3).map(honorario => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium">${honorario.cliente}</p>
                                            <p class="text-sm text-gray-600">€${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</p>
                                        </div>
                                        <span class="status-badge status-${honorario.status}">${honorario.status}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Novas Seções -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="home" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Heranças</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalHerancas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-orange-100 rounded-lg">
                                    <i data-lucide="users-2" class="w-6 h-6 text-orange-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Migrações</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalMigracoes}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-indigo-100 rounded-lg">
                                    <i data-lucide="book-open" class="w-6 h-6 text-indigo-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Registos</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalRegistos}</p>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            `;
        }

        function gerarClientes() {
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <button onclick="abrirModal('cliente')" class="btn btn-primary">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Novo Cliente
                        </button>
                    </div>

                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaClientes" placeholder="Buscar clientes..." 
                                   class="search-input" onkeyup="filtrarClientes()">
                        </div>
                        
                        <!-- Filtros Avançados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosClientes()">
                                    <option value="">Todos os status</option>
                                    <option value="ativo">Ativo</option>
                                    <option value="inativo">Inativo</option>
                                    <option value="suspenso">Suspenso</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Criação</label>
                                <select id="filtroDataCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosClientes()">
                                    <option value="">Todas as datas</option>
                                    <option value="hoje">Hoje</option>
                                    <option value="semana">Esta semana</option>
                                    <option value="mes">Este mês</option>
                                    <option value="ano">Este ano</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Período Personalizado</label>
                                <input type="date" id="filtroDataInicioCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosClientes()">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Até</label>
                                <input type="date" id="filtroDataFimCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosClientes()">
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosClientes()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorClientes">0</span> clientes encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="p-6">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Email</th>
                                            <th>Telefone</th>
                                            <th>NIF</th>
                                            <th>Status</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaClientes">
                                        ${clientes.map(cliente => `
                                            <tr>
                                                <td>${cliente.nome}</td>
                                                <td>${cliente.email}</td>
                                                <td>${cliente.telefone}</td>
                                                <td>${cliente.nif || '-'}</td>
                                                <td><span class="status-badge status-${cliente.status || 'ativo'}">${cliente.status || 'Ativo'}</span></td>
                                                <td>
                                                    <button onclick="editarItem('cliente', ${cliente.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="abrirAnexosCliente(${cliente.id})" class="text-green-600 hover:text-green-800" title="Documentos">
                                                        <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarHonorarios() {
            const honorariosPagos = honorarios.filter(h => h.status === 'pago').length;
            const honorariosPendentes = honorarios.filter(h => h.status === 'pendente').length;
            const honorariosVencidos = honorarios.filter(h => h.status === 'vencido').length;
            const valorTotal = honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <button onclick="abrirModal('honorario')" class="btn btn-primary">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Novo Honorário
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Pagos</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosPagos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="clock" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Pendentes</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosPendentes}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="alert-circle" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Vencidos</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosVencidos}</p>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">€${(Math.round(valorTotal * 100) / 100).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaHonorarios" placeholder="Buscar honorários..." 
                                   class="search-input" onkeyup="filtrarHonorarios()">
                        </div>
                        
                        <!-- Filtros Avançados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusHonorario" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="pago">Pago</option>
                                    <option value="vencido">Vencido</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor Mínimo</label>
                                <input type="number" id="filtroValorMinHonorario" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor Máximo</label>
                                <input type="number" id="filtroValorMaxHonorario" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                                <select id="filtroVencimentoHonorario" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                                    <option value="">Todas as datas</option>
                                    <option value="hoje">Vence hoje</option>
                                    <option value="semana">Esta semana</option>
                                    <option value="mes">Este mês</option>
                                    <option value="vencido">Vencidos</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosHonorarios()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorHonorarios">0</span> honorários encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="p-6">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Serviço</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>Vencimento</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaHonorarios">
                                        ${honorarios.map(honorario => `
                                            <tr>
                                                <td>${honorario.cliente}</td>
                                                <td>${honorario.servico}</td>
                                                <td>€${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</td>
                                                <td><span class="status-badge status-${honorario.status}">${honorario.status}</span></td>
                                                <td>${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}</td>
                                                <td>
                                                    <button onclick="editarItem('honorario', ${honorario.id})" class="text-blue-600 hover:text-blue-800">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="excluirItem('honorario', ${honorario.id})" class="text-red-600 hover:text-red-800 ml-2">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarContratos() {
            const contratosAtivos = contratos.filter(c => c.status === 'ativo').length;
            const contratosSuspensos = contratos.filter(c => c.status === 'suspenso').length;
            const contratosTerminados = contratos.filter(c => c.status === 'terminado').length;
            const valorTotalContratos = contratos.reduce((sum, c) => {
                const valor = parseFloat(c.valor) || 0;
                return sum + valor;
            }, 0);

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <button onclick="abrirModal('contrato')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                            Novo Contrato
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${contratosAtivos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Suspensos</p>
                                    <p class="text-2xl font-bold text-gray-900">${contratosSuspensos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Terminados</p>
                                    <p class="text-2xl font-bold text-gray-900">${contratosTerminados}</p>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">€${Math.round(valorTotalContratos * 100) / 100}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaContratos" placeholder="Buscar contratos..." 
                                   class="search-input" onkeyup="filtrarContratos()">
                        </div>
                        
                        <!-- Filtros Avançados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusContrato" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosContratos()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                                <select id="filtroClienteContrato" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosContratos()">
                                    <option value="">Todos os clientes</option>
                                    ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor Mínimo</label>
                                <input type="number" id="filtroValorMinContrato" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosContratos()" placeholder="Ex: 100.00">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor Máximo</label>
                                <input type="number" id="filtroValorMaxContrato" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosContratos()" placeholder="Ex: 1000.00">
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosContratos()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorContratos">0</span> contratos encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="p-6">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th class="font-bold">Cliente</th>
                                            <th class="font-bold">Tipo</th>
                                            <th class="font-bold">Descrição</th>
                                            <th class="font-bold">Valor</th>
                                            <th class="font-bold">Status</th>
                                            <th class="font-bold">Data Início</th>
                                            <th class="font-bold">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaContratos">
                                        ${contratos.map(contrato => `
                                            <tr>
                                                <td>${contrato.clienteNome}</td>
                                                <td>${contrato.tipo}</td>
                                                <td>${contrato.descricao}</td>
                                                <td>
                                                    <div class="flex flex-col">
                                                        <div class="text-sm font-medium text-gray-900">€${(Math.round((parseFloat(contrato.valor) || 0) * 100) / 100).toFixed(2)}</div>
                                                        <div class="text-xs text-gray-500">
                                                            <span class="text-gray-400">+ ${contrato.iva || 0}% IVA:</span>
                                                            <span class="font-medium text-gray-700">€${(Math.round((parseFloat(contrato.valorTotal || contrato.valor) || 0) * 100) / 100).toFixed(2)}</span>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td><span class="status-badge status-${contrato.status}">${contrato.status === 'concluido' ? 'Concluído' : contrato.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span></td>
                                                <td>${new Date(contrato.dataInicio).toLocaleDateString('pt-PT')}</td>
                                                <td>
                                                    <button onclick="editarContratoDireto(${contrato.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="abrirAnexosContrato(${contrato.id})" class="text-green-600 hover:text-green-800 mr-2" title="Documentos">
                                                        <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="excluirContratoDireto(${contrato.id})" class="text-red-600 hover:text-red-800" title="Excluir">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarPrazos() {
            const prazosAtivos = prazos.filter(p => p.status === 'ativo').length;
            const prazosVencidos = prazos.filter(p => p.status === 'vencido').length;
            const prazosUrgentes = prazos.filter(p => p.prioridade === 'alta' || p.prioridade === 'critica').length;
            const prazosHoje = prazos.filter(p => {
                try {
                    if (!p.dataLimite) return false;
                    const hoje = new Date().toISOString().split('T')[0];
                    const dataLimite = new Date(p.dataLimite).toISOString().split('T')[0];
                    return dataLimite === hoje && p.status === 'ativo';
                } catch (error) {
                    console.warn('Erro ao processar data do prazo:', p.dataLimite);
                    return false;
                }
            }).length;

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600 bg-blue-50 px-3 py-2 rounded-lg">
                            <i data-lucide="info" class="w-4 h-4 inline mr-2"></i>
                            Prazos criados automaticamente pelas áreas de execução
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="clock" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosAtivos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Vencidos</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosVencidos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-orange-100 rounded-lg">
                                    <i data-lucide="zap" class="w-6 h-6 text-orange-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Urgentes</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosUrgentes}</p>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="calendar" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Hoje</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosHoje}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informação sobre prazos automáticos -->
                    <div class="card p-6 bg-blue-50 border-l-4 border-blue-400">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i data-lucide="clock" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-blue-800">Prazos Automáticos</h3>
                                <div class="mt-2 text-sm text-blue-700">
                                    <p>Os prazos são criados automaticamente quando você adiciona itens nas áreas de execução:</p>
                                    <ul class="mt-2 list-disc list-inside space-y-1">
                                        <li><strong>Contratos:</strong> Prazo de 30 dias</li>
                                        <li><strong>Heranças:</strong> Prazo de 60 dias</li>
                                        <li><strong>Migração:</strong> Prazo de 90 dias</li>
                                        <li><strong>Registos:</strong> Prazo de 15 dias</li>
                                    </ul>
                                    <p class="mt-2 text-xs text-blue-600">Você pode editar ou excluir prazos conforme necessário.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaPrazos" placeholder="Buscar prazos..." 
                                   class="search-input" onkeyup="filtrarPrazos()">
                        </div>
                        
                        <!-- Filtros Avançados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                    <option value="vencido">Vencido</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="filtroTipoPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                                    <option value="">Todos os tipos</option>
                                    <option value="contrato">Contrato</option>
                                    <option value="heranca">Herança</option>
                                    <option value="migracao">Migração</option>
                                    <option value="registo">Registo</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                                <select id="filtroVencimentoPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                                    <option value="">Todas as datas</option>
                                    <option value="hoje">Vence hoje</option>
                                    <option value="semana">Esta semana</option>
                                    <option value="mes">Este mês</option>
                                    <option value="vencido">Vencidos</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                <select id="filtroPrioridadePrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                                    <option value="">Todas as prioridades</option>
                                    <option value="baixa">Baixa</option>
                                    <option value="media">Média</option>
                                    <option value="alta">Alta</option>
                                    <option value="urgente">Urgente</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosPrazos()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorPrazos">0</span> prazos encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="p-6">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Tipo</th>
                                            <th>Descrição</th>
                                            <th>Data Limite</th>
                                            <th>Prioridade</th>
                                            <th>Status</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaPrazos">
                                        ${prazos.map(prazo => `
                                            <tr>
                                                <td>${prazo.clienteNome}</td>
                                                <td>${prazo.tipo}</td>
                                                <td>${prazo.descricao}</td>
                                                <td>${prazo.dataLimite ? new Date(prazo.dataLimite).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                                                <td><span class="status-badge status-${prazo.prioridade}">${prazo.prioridade}</span></td>
                                                <td><span class="status-badge status-${prazo.status}">${prazo.status}</span></td>
                                                <td>
                                                    <button onclick="editarItem('prazo', ${prazo.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="abrirAnexosPrazo(${prazo.id})" class="text-green-600 hover:text-green-800 mr-2">
                                                        <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="excluirItem('prazo', ${prazo.id})" class="text-red-600 hover:text-red-800">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarNotificacoes() {
            const notificacoesNaoLidas = notificacoes.filter(n => !n.lida).length;
            const notificacoesHoje = notificacoes.filter(n => {
                try {
                    if (!n.dataCriacao) return false;
                    const hoje = new Date().toISOString().split('T')[0];
                    const dataNotificacao = new Date(n.dataCriacao).toISOString().split('T')[0];
                    return dataNotificacao === hoje;
                } catch (error) {
                    console.warn('Erro ao processar data da notificação:', n.dataCriacao);
                    return false;
                }
            }).length;

            return `
                <div class="space-y-6">
            <div class="flex justify-between items-center">
                <div class="flex space-x-3">
                    <button onclick="criarNotificacaoTeste()" class="btn btn-info">
                        <i data-lucide="test-tube" class="w-4 h-4"></i>
                        Teste Aleatório
                    </button>
                    <button onclick="criarNotificacaoPersonalizada()" class="btn btn-warning">
                        <i data-lucide="edit" class="w-4 h-4"></i>
                        Criar Personalizada
                    </button>
                </div>
                <div class="flex space-x-3">
                    <button onclick="marcarTodasComoLidas()" class="btn btn-secondary">
                        <i data-lucide="check" class="w-4 h-4"></i>
                        Marcar Todas como Lidas
                    </button>
                    <button onclick="limparNotificacoes()" class="btn btn-error">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                        Limpar Todas
                    </button>
                </div>
            </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="bell" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Não Lidas</p>
                                    <p class="text-2xl font-bold text-gray-900">${notificacoesNaoLidas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="calendar" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Hoje</p>
                                    <p class="text-2xl font-bold text-gray-900">${notificacoesHoje}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total</p>
                                    <p class="text-2xl font-bold text-gray-900">${notificacoes.length}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        ${notificacoes.length === 0 ? `
                            <div class="card p-8 text-center">
                                <i data-lucide="bell-off" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                                <h3 class="text-lg font-semibold text-gray-600 mb-2">Nenhuma notificação</h3>
                                <p class="text-gray-500">Você está em dia! Não há notificações pendentes.</p>
                            </div>
                        ` : notificacoes.map(notificacao => `
                            <div class="card p-4 ${notificacao.lida ? 'opacity-60' : 'border-l-4 border-blue-500'}">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="status-badge status-${notificacao.tipo}">${notificacao.tipo}</span>
                                            ${notificacao.prioridade === 'alta' ? '<span class="status-badge status-alta">Urgente</span>' : ''}
                                        </div>
                                        <h4 class="font-semibold text-gray-800">${notificacao.titulo}</h4>
                                        <p class="text-gray-600 text-sm mt-1">${notificacao.mensagem}</p>
                                        <p class="text-gray-400 text-xs mt-2">${notificacao.dataCriacao ? new Date(notificacao.dataCriacao).toLocaleString('pt-PT') : 'Data não disponível'}</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        ${!notificacao.lida ? `
                                            <button onclick="marcarComoLida(${notificacao.id})" class="text-blue-600 hover:text-blue-800">
                                                <i data-lucide="check" class="w-4 h-4"></i>
                                            </button>
                                        ` : ''}
                                        <button onclick="excluirNotificacao(${notificacao.id})" class="text-red-600 hover:text-red-800">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function gerarRelatorios() {
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Relatórios</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Relatório de Clientes</h3>
                            <p class="text-gray-600 mb-4">Relatório completo de clientes cadastrados</p>
                            <button onclick="gerarRelatorioClientes()" class="btn btn-info">
                                <i data-lucide="users" class="w-4 h-4"></i>
                                Gerar
                            </button>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Relatório Financeiro</h3>
                            <p class="text-gray-600 mb-4">Relatório de honorários e receitas</p>
                            <button onclick="gerarRelatorioFinanceiro()" class="btn btn-success">
                                <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                                Gerar
                            </button>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Relatório Geral</h3>
                            <p class="text-gray-600 mb-4">Relatório completo do sistema</p>
                            <button onclick="gerarRelatorioCompleto()" class="btn btn-primary">
                                <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                                Gerar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function inicializarSecao(secao) {
            lucide.createIcons();
            
            if (secao === 'dashboard') {
                setTimeout(() => {
                    criarGraficoHonorarios();
                }, 100);
            }
        }

        function criarGraficoHonorarios() {
            const ctx = document.getElementById('chartHonorarios');
            if (!ctx) return;

            const honorariosPagos = honorarios.filter(h => h.status === 'pago').length;
            const honorariosPendentes = honorarios.filter(h => h.status === 'pendente').length;
            const honorariosVencidos = honorarios.filter(h => h.status === 'vencido').length;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pagos', 'Pendentes', 'Vencidos'],
                    datasets: [{
                        data: [honorariosPagos, honorariosPendentes, honorariosVencidos],
                        backgroundColor: [
                            '#10b981',
                            '#f59e0b',
                            '#ef4444'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function abrirModal(tipo) {
            const modal = criarModal(tipo);
            document.getElementById('modalContainer').innerHTML = modal;
            document.getElementById('modalContainer').classList.add('show');
            lucide.createIcons();
        }

        function abrirModalEdicaoCliente(cliente) {
            const modal = criarModalEdicaoCliente(cliente);
            document.getElementById('modalContainer').innerHTML = modal;
            document.getElementById('modalContainer').classList.add('show');
            lucide.createIcons();
        }

        function abrirModalEdicaoContrato(contrato) {
            console.log('🔧 abrirModalEdicaoContrato chamado com:', contrato);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoContrato';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = fecharModal;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Contrato</h3>
                            <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form onsubmit="atualizarContrato(event, ${contrato.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="editarContratoCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `
                                            <option value="${cliente.id}" data-nome="${cliente.nome}" ${cliente.id === contrato.clienteId ? 'selected' : ''}>${cliente.nome}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Serviço *</label>
                                    <select id="editarContratoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Alteração de pactos sociais" ${contrato.tipo === 'Alteração de pactos sociais' ? 'selected' : ''}>Alteração de pactos sociais</option>
                                        <option value="Análise e revisão de contratos" ${contrato.tipo === 'Análise e revisão de contratos' ? 'selected' : ''}>Análise e revisão de contratos</option>
                                        <option value="Cessão de quotas" ${contrato.tipo === 'Cessão de quotas' ? 'selected' : ''}>Cessão de quotas</option>
                                        <option value="Constituição de sociedades" ${contrato.tipo === 'Constituição de sociedades' ? 'selected' : ''}>Constituição de sociedades</option>
                                        <option value="Contratos de arrendamento" ${contrato.tipo === 'Contratos de arrendamento' ? 'selected' : ''}>Contratos de arrendamento</option>
                                        <option value="Contratos de compra e venda" ${contrato.tipo === 'Contratos de compra e venda' ? 'selected' : ''}>Contratos de compra e venda</option>
                                        <option value="Contratos de prestação de serviços" ${contrato.tipo === 'Contratos de prestação de serviços' ? 'selected' : ''}>Contratos de prestação de serviços</option>
                                        <option value="Contratos de trabalho" ${contrato.tipo === 'Contratos de trabalho' ? 'selected' : ''}>Contratos de trabalho</option>
                                        <option value="Pactos sociais" ${contrato.tipo === 'Pactos sociais' ? 'selected' : ''}>Pactos sociais</option>
                                        <option value="Consultoria" ${contrato.tipo === 'Consultoria' ? 'selected' : ''}>Consultoria</option>
                                        <option value="Assessoria" ${contrato.tipo === 'Assessoria' ? 'selected' : ''}>Assessoria</option>
                                        <option value="Representação" ${contrato.tipo === 'Representação' ? 'selected' : ''}>Representação</option>
                                        <option value="Outro" ${contrato.tipo === 'Outro' ? 'selected' : ''}>Outro</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Descrição *</label>
                                    <textarea id="editarContratoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descreva os serviços a serem prestados...">${contrato.descricao || ''}</textarea>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="editarContratoValor" step="0.01" value="${contrato.valor || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="editarContratoIVA" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0" ${contrato.iva === 0 ? 'selected' : ''}>0% (Isento)</option>
                                            <option value="6" ${contrato.iva === 6 ? 'selected' : ''}>6% (Reduzida)</option>
                                            <option value="13" ${contrato.iva === 13 ? 'selected' : ''}>13% (Intermédia)</option>
                                            <option value="23" ${contrato.iva === 23 ? 'selected' : ''}>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="editarContratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente" ${contrato.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                            <option value="em_andamento" ${contrato.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                            <option value="concluido" ${contrato.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de Início *</label>
                                        <input type="date" id="editarContratoDataInicio" value="${contrato.dataInicio || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                    <textarea id="editarContratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre o contrato...">${contrato.observacoes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Alterações
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Adicionar ao body
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('✅ Modal de edição de contrato criado e adicionado ao body!');
        }

        function fecharModal() {
            console.log('🔧 fecharModal chamado');
            
            // Limpar modalContainer
            const modalContainer = document.getElementById('modalContainer');
            if (modalContainer) {
                modalContainer.classList.remove('show');
                modalContainer.innerHTML = '';
                console.log('✅ modalContainer limpo');
            }
            
            // Remover qualquer modal que possa estar no body
            const modalsNoBody = document.querySelectorAll('.fixed.inset-0');
            modalsNoBody.forEach(modal => {
                console.log('🔧 Removendo modal do body:', modal.id);
                modal.remove();
            });
            
            // Remover modais específicos
            const modalHeranca = document.getElementById('modalEdicaoHeranca');
            if (modalHeranca) {
                console.log('🔧 Removendo modalEdicaoHeranca');
                modalHeranca.remove();
            }
            
            const modalMigracao = document.getElementById('modalEdicaoMigracao');
            if (modalMigracao) {
                console.log('🔧 Removendo modalEdicaoMigracao');
                modalMigracao.remove();
            }
            
            const modalRegisto = document.getElementById('modalEdicaoRegisto');
            if (modalRegisto) {
                console.log('🔧 Removendo modalEdicaoRegisto');
                modalRegisto.remove();
            }
            
            // Remover qualquer modal de edição
            const modaisEdicao = document.querySelectorAll('[id^="modalEdicao"]');
            modaisEdicao.forEach(modal => {
                console.log('🔧 Removendo modal de edição:', modal.id);
                modal.remove();
            });
            
            console.log('✅ fecharModal concluído');
        }

        function criarModal(tipo) {
            const modais = {
                cliente: criarModalCliente(),
                honorario: criarModalHonorario(),
                contrato: criarModalContrato(),
                migracao: criarModalMigracao()
            };
            return modais[tipo] || '<div class="modal-content p-6">Modal não encontrado</div>';
        }

        function criarModalEdicaoCliente(cliente) {
            return `
                <div class="modal show" onclick="fecharModal()">
                    <div class="modal-content p-6" style="max-width: 500px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Editar Cliente</h3>
                            <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formEditarCliente" onsubmit="atualizarCliente(event, ${cliente.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                                    <input type="text" id="editarClienteNome" value="${cliente.nome}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                    <input type="email" id="editarClienteEmail" value="${cliente.email}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                                    <input type="tel" id="editarClienteTelefone" value="${cliente.telefone}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NIF *</label>
                                    <input type="text" id="editarClienteNIF" value="${cliente.nif || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="123456789">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Endereço</label>
                                    <textarea id="editarClienteEndereco" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${cliente.endereco || ''}</textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="editarClienteStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="ativo" ${cliente.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                        <option value="inativo" ${cliente.status === 'inativo' ? 'selected' : ''}>Inativo</option>
                                        <option value="suspenso" ${cliente.status === 'suspenso' ? 'selected' : ''}>Suspenso</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-between mt-6">
                                <div class="flex space-x-3">
                                    <button type="button" onclick="excluirCliente(${cliente.id})" class="btn btn-error">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        Excluir
                                    </button>
                                </div>
                                <div class="flex space-x-3">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i data-lucide="save" class="w-4 h-4"></i>
                                        Salvar Alterações
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function criarModalCliente() {
            return `
                <div class="modal show" onclick="fecharModal()">
                    <div class="modal-content p-6" style="max-width: 500px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Novo Cliente</h3>
                            <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formCliente" onsubmit="salvarCliente(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                                    <input type="text" id="clienteNome" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                    <input type="email" id="clienteEmail" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                                    <input type="tel" id="clienteTelefone" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NIF *</label>
                                    <input type="text" id="clienteNIF" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="123456789">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Endereço</label>
                                    <textarea id="clienteEndereco" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="clienteStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="ativo">Ativo</option>
                                        <option value="inativo">Inativo</option>
                                        <option value="suspenso">Suspenso</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Cliente
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function criarModalHonorario() {
            return `
                <div class="modal show">
                    <div class="modal-content p-6" style="max-width: 500px;">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Novo Honorário</h3>
                            <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formHonorario" onsubmit="salvarHonorario(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="honorarioCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `
                                            <option value="${cliente.nome}">${cliente.nome}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Serviço *</label>
                                    <input type="text" id="honorarioServico" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                    <input type="number" id="honorarioValor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="honorarioStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="pendente">Pendente</option>
                                        <option value="pago">Pago</option>
                                        <option value="vencido">Vencido</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                                    <input type="date" id="honorarioVencimento" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Honorário
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function criarModalContrato() {
            return `
                <div class="modal show" onclick="fecharModal()">
                    <div class="modal-content p-6" style="max-width: 600px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Novo Contrato</h3>
                            <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formContrato" onsubmit="salvarContrato(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="contratoCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `
                                            <option value="${cliente.id}" data-nome="${cliente.nome}">${cliente.nome}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Serviço *</label>
                                    <select id="contratoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Alteração de pactos sociais">Alteração de pactos sociais</option>
                                        <option value="Análise e revisão de contratos">Análise e revisão de contratos</option>
                                        <option value="Cessão de quotas">Cessão de quotas</option>
                                        <option value="Constituição de sociedades">Constituição de sociedades</option>
                                        <option value="Contratos de arrendamento">Contratos de arrendamento</option>
                                        <option value="Contratos de compra e venda">Contratos de compra e venda</option>
                                        <option value="Contratos de prestação de serviços">Contratos de prestação de serviços</option>
                                        <option value="Contratos de trabalho">Contratos de trabalho</option>
                                        <option value="Pactos sociais">Pactos sociais</option>
                                        <option value="Consultoria">Consultoria</option>
                                        <option value="Assessoria">Assessoria</option>
                                        <option value="Representação">Representação</option>
                                        <option value="Outro">Outro</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="contratoValor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="contratoIVA" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0">0% (Isento)</option>
                                            <option value="6">6% (Reduzida)</option>
                                            <option value="13">13% (Intermédia)</option>
                                            <option value="23" selected>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                        <select id="contratoParceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('contrato')">
                                            <option value="sem">Sem parceria</option>
                                            <option value="empresa">Empresa</option>
                                            <option value="pessoa">Pessoa</option>
                                        </select>
                                    </div>
                                    
                                    <div id="contratoParceriaNomeDiv" style="display: none;">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                        <input type="text" id="contratoParceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                        <input type="number" id="contratoPercentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="contratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente">Pendente</option>
                                            <option value="em_andamento">Em Andamento</option>
                                            <option value="concluido">Concluído</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de Início *</label>
                                        <input type="date" id="contratoDataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                    <textarea id="contratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre o contrato..."></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Contrato
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function criarModalEdicaoContrato(contrato) {
            return `
                <div class="modal show" onclick="fecharModal()">
                    <div class="modal-content p-6" style="max-width: 600px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Editar Contrato</h3>
                            <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formEditarContrato" onsubmit="atualizarContrato(event, ${contrato.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="editarContratoCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `
                                            <option value="${cliente.id}" data-nome="${cliente.nome}" ${cliente.id === contrato.clienteId ? 'selected' : ''}>${cliente.nome}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Serviço *</label>
                                    <select id="editarContratoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Alteração de pactos sociais" ${contrato.tipo === 'Alteração de pactos sociais' ? 'selected' : ''}>Alteração de pactos sociais</option>
                                        <option value="Análise e revisão de contratos" ${contrato.tipo === 'Análise e revisão de contratos' ? 'selected' : ''}>Análise e revisão de contratos</option>
                                        <option value="Cessão de quotas" ${contrato.tipo === 'Cessão de quotas' ? 'selected' : ''}>Cessão de quotas</option>
                                        <option value="Constituição de sociedades" ${contrato.tipo === 'Constituição de sociedades' ? 'selected' : ''}>Constituição de sociedades</option>
                                        <option value="Contratos de arrendamento" ${contrato.tipo === 'Contratos de arrendamento' ? 'selected' : ''}>Contratos de arrendamento</option>
                                        <option value="Contratos de compra e venda" ${contrato.tipo === 'Contratos de compra e venda' ? 'selected' : ''}>Contratos de compra e venda</option>
                                        <option value="Contratos de prestação de serviços" ${contrato.tipo === 'Contratos de prestação de serviços' ? 'selected' : ''}>Contratos de prestação de serviços</option>
                                        <option value="Contratos de trabalho" ${contrato.tipo === 'Contratos de trabalho' ? 'selected' : ''}>Contratos de trabalho</option>
                                        <option value="Pactos sociais" ${contrato.tipo === 'Pactos sociais' ? 'selected' : ''}>Pactos sociais</option>
                                        <option value="Consultoria" ${contrato.tipo === 'Consultoria' ? 'selected' : ''}>Consultoria</option>
                                        <option value="Assessoria" ${contrato.tipo === 'Assessoria' ? 'selected' : ''}>Assessoria</option>
                                        <option value="Representação" ${contrato.tipo === 'Representação' ? 'selected' : ''}>Representação</option>
                                        <option value="Outro" ${contrato.tipo === 'Outro' ? 'selected' : ''}>Outro</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Descrição *</label>
                                    <textarea id="editarContratoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descreva os serviços a serem prestados...">${contrato.descricao || ''}</textarea>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="editarContratoValor" step="0.01" value="${contrato.valor || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="editarContratoIVA" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0" ${contrato.iva === 0 ? 'selected' : ''}>0% (Isento)</option>
                                            <option value="6" ${contrato.iva === 6 ? 'selected' : ''}>6% (Reduzida)</option>
                                            <option value="13" ${contrato.iva === 13 ? 'selected' : ''}>13% (Intermédia)</option>
                                            <option value="23" ${contrato.iva === 23 ? 'selected' : ''}>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="editarContratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="ativo" ${contrato.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                            <option value="suspenso" ${contrato.status === 'suspenso' ? 'selected' : ''}>Suspenso</option>
                                            <option value="terminado" ${contrato.status === 'terminado' ? 'selected' : ''}>Terminado</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de Início *</label>
                                        <input type="date" id="editarContratoDataInicio" value="${contrato.dataInicio || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                    <textarea id="editarContratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre o contrato...">${contrato.observacoes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-between mt-6">
                                <div class="flex space-x-3">
                                    <button type="button" onclick="excluirContrato(${contrato.id})" class="btn btn-error">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        Excluir
                                    </button>
                                </div>
                                <div class="flex space-x-3">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i data-lucide="save" class="w-4 h-4"></i>
                                        Salvar Alterações
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function salvarCliente(event) {
            event.preventDefault();
            
            const cliente = {
                id: Date.now(),
                nome: document.getElementById('clienteNome').value,
                email: document.getElementById('clienteEmail').value,
                telefone: document.getElementById('clienteTelefone').value,
                nif: document.getElementById('clienteNIF').value,
                endereco: document.getElementById('clienteEndereco').value,
                status: document.getElementById('clienteStatus').value,
                dataCriacao: new Date().toISOString()
            };
            
            clientes.push(cliente);
            salvarDados('clientes', clientes);
            mostrarNotificacao('Cliente salvo com sucesso!', 'success');
            
            // Fechar modal imediatamente
            fecharModal();
            
            // Recarregar seção após um pequeno delay
            setTimeout(() => {
                carregarSecao('clientes');
            }, 100);
        }

        function salvarHonorario(event) {
            event.preventDefault();
            
            const honorario = {
                id: Date.now(),
                cliente: document.getElementById('honorarioCliente').value,
                servico: document.getElementById('honorarioServico').value,
                valor: parseFloat(document.getElementById('honorarioValor').value),
                status: document.getElementById('honorarioStatus').value,
                vencimento: document.getElementById('honorarioVencimento').value,
                dataCriacao: new Date().toISOString()
            };
            
            honorarios.push(honorario);
            salvarDados('honorarios', honorarios);
            mostrarNotificacao('Honorário salvo com sucesso!', 'success');
            
            // Fechar modal imediatamente
            fecharModal();
            
            // Recarregar seção após um pequeno delay
            setTimeout(() => {
                carregarSecao('honorarios');
            }, 100);
        }

        function salvarContrato(event) {
            event.preventDefault();
            
            const clienteId = parseInt(document.getElementById('contratoCliente').value);
            const clienteSelecionado = clientes.find(c => c.id === clienteId);
            
            const valor = parseFloat(document.getElementById('contratoValor').value);
            const ivaPercent = parseFloat(document.getElementById('contratoIVA').value);
            const percentagem = parseFloat(document.getElementById('contratoPercentagem').value) || 0;
            const valorIVA = (valor * ivaPercent) / 100;
            const valorTotal = valor + valorIVA;

            const contrato = {
                id: Date.now(),
                clienteId: clienteId,
                clienteNome: clienteSelecionado ? clienteSelecionado.nome : '',
                tipo: document.getElementById('contratoTipo').value,
                valor: valor,
                iva: ivaPercent,
                percentagem: percentagem,
                valorIVA: valorIVA,
                valorTotal: valorTotal,
                status: document.getElementById('contratoStatus').value,
                dataInicio: document.getElementById('contratoDataInicio').value,
                observacoes: document.getElementById('contratoObservacoes').value,
                dataCriacao: new Date().toISOString()
            };
            
            contratos.push(contrato);
            salvarDados('contratos', contratos);
            
            // Criar prazo automático para o contrato
            const prazoContrato = {
                id: Date.now() + 1,
                clienteId: clienteId,
                clienteNome: clienteSelecionado ? clienteSelecionado.nome : '',
                descricao: `Prazo para ${contrato.tipo}`,
                dataLimite: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30 dias
                status: 'ativo',
                tipo: 'contrato',
                referenciaId: contrato.id,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoContrato);
            salvarDados('prazos', prazos);
            
            mostrarNotificacao('Contrato e prazo criados com sucesso!', 'success');
            
            // Fechar modal imediatamente
            fecharModal();
            
            // Recarregar seção após um pequeno delay
            setTimeout(() => {
                carregarSecao('contratos');
            }, 100);
        }

        function atualizarCliente(event, id) {
            event.preventDefault();
            
            const clienteIndex = clientes.findIndex(c => c.id === id);
            if (clienteIndex !== -1) {
                clientes[clienteIndex] = {
                    ...clientes[clienteIndex],
                    nome: document.getElementById('editarClienteNome').value,
                    email: document.getElementById('editarClienteEmail').value,
                    telefone: document.getElementById('editarClienteTelefone').value,
                    nif: document.getElementById('editarClienteNIF').value,
                    endereco: document.getElementById('editarClienteEndereco').value,
                    status: document.getElementById('editarClienteStatus').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('clientes', clientes);
                mostrarNotificacao('Cliente atualizado com sucesso!', 'success');
                
                // Fechar modal imediatamente
                fecharModal();
                
                // Recarregar seção após um pequeno delay
                setTimeout(() => {
                    carregarSecao('clientes');
                }, 100);
            }
        }

        function excluirCliente(id) {
            if (confirm('Tem certeza que deseja excluir este cliente? Esta ação não pode ser desfeita.')) {
                clientes = clientes.filter(c => c.id !== id);
                salvarDados('clientes', clientes);
                mostrarNotificacao('Cliente excluído com sucesso!', 'success');
                
                // Fechar modal imediatamente
                fecharModal();
                
                // Recarregar seção após um pequeno delay
                setTimeout(() => {
                    carregarSecao('clientes');
                }, 100);
            }
        }

        function atualizarContrato(event, id) {
            console.log('🔧 atualizarContrato chamado com ID:', id);
            event.preventDefault();
            
            const contratoIndex = contratos.findIndex(c => c.id === id);
            console.log('🔧 Contrato encontrado no índice:', contratoIndex);
            
            if (contratoIndex !== -1) {
                const clienteId = parseInt(document.getElementById('editarContratoCliente').value);
                const clienteSelecionado = clientes.find(c => c.id === clienteId);
                console.log('🔧 Cliente selecionado:', clienteSelecionado);
                
                const valor = parseFloat(document.getElementById('editarContratoValor').value);
                const ivaPercent = parseFloat(document.getElementById('editarContratoIVA').value);
                const valorIVA = (valor * ivaPercent) / 100;
                const valorTotal = valor + valorIVA;

                contratos[contratoIndex] = {
                    ...contratos[contratoIndex],
                    clienteId: clienteId,
                    clienteNome: clienteSelecionado ? clienteSelecionado.nome : '',
                    tipo: document.getElementById('editarContratoTipo').value,
                    descricao: document.getElementById('editarContratoDescricao').value,
                    valor: valor,
                    iva: ivaPercent,
                    valorIVA: valorIVA,
                    valorTotal: valorTotal,
                    status: document.getElementById('editarContratoStatus').value,
                    dataInicio: document.getElementById('editarContratoDataInicio').value,
                    observacoes: document.getElementById('editarContratoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                console.log('🔧 Contrato atualizado:', contratos[contratoIndex]);
                salvarDados('contratos', contratos);
                mostrarNotificacao('Contrato atualizado com sucesso!', 'success');
                
                // Fechar modal imediatamente
                fecharModal();
                
                // Recarregar seção após um pequeno delay
                setTimeout(() => {
                    carregarSecao('contratos');
                }, 100);
            } else {
                console.error('❌ Contrato não encontrado com ID:', id);
                mostrarNotificacao('Contrato não encontrado!', 'error');
            }
        }

        function excluirContrato(id) {
            if (confirm('Tem certeza que deseja excluir este contrato? Esta ação não pode ser desfeita.')) {
                contratos = contratos.filter(c => c.id !== id);
                salvarDados('contratos', contratos);
                mostrarNotificacao('Contrato excluído com sucesso!', 'success');
                
                // Fechar modal imediatamente
                fecharModal();
                
                // Recarregar seção após um pequeno delay
                setTimeout(() => {
                    carregarSecao('contratos');
                }, 100);
            }
        }

        function filtrarClientes() {
            aplicarFiltrosClientes();
        }

        function aplicarFiltrosClientes() {
            const busca = document.getElementById('buscaClientes')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusCliente')?.value || '';
            const dataFiltro = document.getElementById('filtroDataCliente')?.value || '';
            const dataInicio = document.getElementById('filtroDataInicioCliente')?.value || '';
            const dataFim = document.getElementById('filtroDataFimCliente')?.value || '';
            
            const clientesFiltrados = clientes.filter(cliente => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    cliente.nome.toLowerCase().includes(busca) || 
                    cliente.email.toLowerCase().includes(busca) ||
                    cliente.telefone.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || cliente.status === status;
                
                // Filtro por data
                let matchData = true;
                if (dataFiltro) {
                    const dataCliente = new Date(cliente.dataCriacao);
                    const hoje = new Date();
                    
                    switch (dataFiltro) {
                        case 'hoje':
                            matchData = dataCliente.toDateString() === hoje.toDateString();
                            break;
                        case 'semana':
                            const inicioSemana = new Date(hoje);
                            inicioSemana.setDate(hoje.getDate() - hoje.getDay());
                            matchData = dataCliente >= inicioSemana;
                            break;
                        case 'mes':
                            matchData = dataCliente.getMonth() === hoje.getMonth() && 
                                        dataCliente.getFullYear() === hoje.getFullYear();
                            break;
                        case 'ano':
                            matchData = dataCliente.getFullYear() === hoje.getFullYear();
                            break;
                    }
                }
                
                // Filtro por período personalizado
                if (dataInicio || dataFim) {
                    const dataCliente = new Date(cliente.dataCriacao);
                    if (dataInicio) {
                        const inicio = new Date(dataInicio);
                        matchData = matchData && dataCliente >= inicio;
                    }
                    if (dataFim) {
                        const fim = new Date(dataFim);
                        fim.setHours(23, 59, 59, 999);
                        matchData = matchData && dataCliente <= fim;
                    }
                }
                
                return matchBusca && matchStatus && matchData;
            });
            
            atualizarListaClientes(clientesFiltrados);
            document.getElementById('contadorClientes').textContent = clientesFiltrados.length;
        }

        function limparFiltrosClientes() {
            document.getElementById('buscaClientes').value = '';
            document.getElementById('filtroStatusCliente').value = '';
            document.getElementById('filtroDataCliente').value = '';
            document.getElementById('filtroDataInicioCliente').value = '';
            document.getElementById('filtroDataFimCliente').value = '';
            aplicarFiltrosClientes();
        }

        function filtrarHonorarios() {
            aplicarFiltrosHonorarios();
        }

        function aplicarFiltrosHonorarios() {
            console.log('🔧 aplicarFiltrosHonorarios chamado');
            const busca = document.getElementById('buscaHonorarios')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusHonorario')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinHonorario')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxHonorario')?.value) || Infinity;
            const vencimento = document.getElementById('filtroVencimentoHonorario')?.value || '';
            
            console.log('🔧 Filtros aplicados:', { busca, status, valorMin, valorMax, vencimento });
            console.log('🔧 Total de honorários:', honorarios.length);
            
            const honorariosFiltrados = honorarios.filter(honorario => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    honorario.cliente.toLowerCase().includes(busca) || 
                    honorario.servico.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || honorario.status === status;
                
                // Filtro por valor
                const valor = parseFloat(honorario.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                // Filtro por vencimento
                let matchVencimento = true;
                if (vencimento && honorario.vencimento) {
                    const dataVencimento = new Date(honorario.vencimento);
                    const hoje = new Date();
                    
                    switch (vencimento) {
                        case 'hoje':
                            matchVencimento = dataVencimento.toDateString() === hoje.toDateString();
                            break;
                        case 'semana':
                            const fimSemana = new Date(hoje);
                            fimSemana.setDate(hoje.getDate() + 7);
                            matchVencimento = dataVencimento >= hoje && dataVencimento <= fimSemana;
                            break;
                        case 'mes':
                            const fimMes = new Date(hoje);
                            fimMes.setMonth(hoje.getMonth() + 1);
                            matchVencimento = dataVencimento >= hoje && dataVencimento <= fimMes;
                            break;
                        case 'vencido':
                            matchVencimento = dataVencimento < hoje;
                            break;
                    }
                }
                
                return matchBusca && matchStatus && matchValor && matchVencimento;
            });
            
            console.log('🔧 Honorários filtrados:', honorariosFiltrados.length);
            atualizarListaHonorarios(honorariosFiltrados);
            
            const contador = document.getElementById('contadorHonorarios');
            if (contador) {
                contador.textContent = honorariosFiltrados.length;
            }
            
            // Reinicializar ícones Lucide após aplicar filtros
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('🔧 Ícones Lucide reinicializados para Honorários');
                }
            }, 100);
        }

        function limparFiltrosHonorarios() {
            document.getElementById('buscaHonorarios').value = '';
            document.getElementById('filtroStatusHonorario').value = '';
            document.getElementById('filtroValorMinHonorario').value = '';
            document.getElementById('filtroValorMaxHonorario').value = '';
            document.getElementById('filtroVencimentoHonorario').value = '';
            aplicarFiltrosHonorarios();
        }

        function filtrarContratos() {
            aplicarFiltrosContratos();
        }

        function aplicarFiltrosContratos() {
            console.log('🔧 aplicarFiltrosContratos chamado');
            const busca = document.getElementById('buscaContratos')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusContrato')?.value || '';
            const clienteId = document.getElementById('filtroClienteContrato')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinContrato')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxContrato')?.value) || Infinity;
            
            console.log('🔧 Filtros aplicados:', { busca, status, clienteId, valorMin, valorMax });
            console.log('🔧 Total de contratos:', contratos.length);
            
            const contratosFiltrados = contratos.filter(contrato => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    contrato.clienteNome.toLowerCase().includes(busca) || 
                    contrato.tipo.toLowerCase().includes(busca) ||
                    (contrato.observacoes && contrato.observacoes.toLowerCase().includes(busca));
                
                // Filtro por status
                const matchStatus = !status || contrato.status === status;
                
                // Filtro por cliente
                const matchCliente = !clienteId || contrato.clienteId == clienteId;
                
                // Filtro por valor
                const valor = parseFloat(contrato.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                return matchBusca && matchStatus && matchCliente && matchValor;
            });
            
            console.log('🔧 Contratos filtrados:', contratosFiltrados.length);
            atualizarListaContratos(contratosFiltrados);
            
            const contador = document.getElementById('contadorContratos');
            if (contador) {
                contador.textContent = contratosFiltrados.length;
            }
            
            // Reinicializar ícones Lucide após aplicar filtros
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('🔧 Ícones Lucide reinicializados para Contratos');
                }
            }, 100);
        }

        function limparFiltrosContratos() {
            document.getElementById('buscaContratos').value = '';
            document.getElementById('filtroStatusContrato').value = '';
            document.getElementById('filtroClienteContrato').value = '';
            document.getElementById('filtroValorMinContrato').value = '';
            document.getElementById('filtroValorMaxContrato').value = '';
            aplicarFiltrosContratos();
        }

        function atualizarListaClientes(clientesFiltrados) {
            const tbody = document.getElementById('listaClientes');
            if (!tbody) return;
            
            tbody.innerHTML = clientesFiltrados.map(cliente => `
                <tr>
                    <td>${cliente.nome}</td>
                    <td>${cliente.email}</td>
                    <td>${cliente.telefone}</td>
                    <td>${cliente.nif || '-'}</td>
                    <td><span class="status-badge status-${cliente.status || 'ativo'}">${cliente.status || 'Ativo'}</span></td>
                    <td>
                        <button onclick="editarClienteDireto(${cliente.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirItem('cliente', ${cliente.id})" class="text-red-600 hover:text-red-800" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Reinicializar ícones Lucide
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            }, 50);
        }

        function atualizarListaHonorarios(honorariosFiltrados) {
            const tbody = document.getElementById('listaHonorarios');
            if (!tbody) return;
            
            tbody.innerHTML = honorariosFiltrados.map(honorario => `
                <tr>
                    <td>${honorario.cliente}</td>
                    <td>${honorario.servico}</td>
                    <td>€${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</td>
                    <td><span class="status-badge status-${honorario.status}">${honorario.status}</span></td>
                    <td>${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}</td>
                    <td>
                        <button class="btn-editar-honorario text-blue-600 hover:text-blue-800 mr-2" data-id="${honorario.id}" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button class="btn-excluir-honorario text-red-600 hover:text-red-800" data-id="${honorario.id}" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Adicionar event listeners
            tbody.querySelectorAll('.btn-editar-honorario').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    console.log('🔧 ID do botão editar:', id, 'Tipo:', typeof id);
                    editarHonorarioDireto(id);
                });
            });
            
            tbody.querySelectorAll('.btn-excluir-honorario').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    console.log('🔧 ID do botão excluir:', id, 'Tipo:', typeof id);
                    excluirHonorarioDireto(id);
                });
            });
            
            // Reinicializar ícones Lucide
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            }, 50);
        }

        function atualizarListaContratos(contratosFiltrados) {
            const tbody = document.getElementById('listaContratos');
            if (!tbody) return;
            
            tbody.innerHTML = contratosFiltrados.map(contrato => `
                <tr>
                    <td>${contrato.clienteNome}</td>
                    <td>${contrato.tipo}</td>
                    <td>${contrato.descricao || '-'}</td>
                    <td>
                        <div class="text-sm">€${(Math.round((parseFloat(contrato.valor) || 0) * 100) / 100).toFixed(2)}</div>
                        <div class="text-xs text-gray-400">+ IVA: €${(Math.round((parseFloat(contrato.valorTotal || contrato.valor) || 0) * 100) / 100).toFixed(2)}</div>
                    </td>
                    <td><span class="status-badge status-${contrato.status}">${contrato.status === 'concluido' ? 'Concluído' : contrato.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span></td>
                    <td>${contrato.dataInicio ? new Date(contrato.dataInicio).toLocaleDateString('pt-PT') : '-'}</td>
                    <td>
                        <button onclick="editarContratoDireto(${contrato.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="abrirAnexosContrato(${contrato.id})" class="text-green-600 hover:text-green-800 mr-2" title="Documentos">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirContratoDireto(${contrato.id})" class="text-red-600 hover:text-red-800" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Reinicializar ícones Lucide após atualizar a lista
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('🔧 Ícones Lucide reinicializados na lista de Contratos');
                }
            }, 100);
        }

        function mostrarNotificacao(mensagem, tipo = 'info') {
            const container = document.getElementById('notificationsContainer');
            if (!container) {
                // Se não há container, criar notificação temporária
                const notificacao = document.createElement('div');
                notificacao.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300`;
                
                const cores = {
                    success: 'bg-green-500 text-white',
                    error: 'bg-red-500 text-white',
                    warning: 'bg-yellow-500 text-white',
                    info: 'bg-blue-500 text-white'
                };
                
                notificacao.className += ` ${cores[tipo] || cores.info}`;
                notificacao.textContent = mensagem;
                
                document.body.appendChild(notificacao);
                
                // Remover após 5 segundos
                setTimeout(() => {
                    if (notificacao.parentNode) {
                        notificacao.parentNode.removeChild(notificacao);
                    }
                }, 5000);
                return;
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            notification.textContent = mensagem;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function atualizarInterface() {
            lucide.createIcons();
        }

        function fecharModal() {
            console.log('🔧 fecharModal chamado');
            
            // Limpar modalContainer
            const modalContainer = document.getElementById('modalContainer');
            if (modalContainer) {
                modalContainer.classList.remove('show');
                modalContainer.innerHTML = '';
                console.log('✅ modalContainer limpo');
            }
            
            // Remover qualquer modal que possa estar no body
            const modalsNoBody = document.querySelectorAll('.fixed.inset-0');
            modalsNoBody.forEach(modal => {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                    console.log('✅ Modal removido do body');
                }
            });
            
            // Remover modais específicos por ID
            const modalIds = ['modalEdicaoContrato', 'modalEdicaoHeranca', 'modalEdicaoMigracao', 'modalEdicaoRegisto'];
            modalIds.forEach(id => {
                const modal = document.getElementById(id);
                if (modal && modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                    console.log(`✅ Modal ${id} removido`);
                }
            });
        }

        function editarItem(tipo, id) {
            console.log('🔧 editarItem chamado:', tipo, id);
            
            // Fechar qualquer modal aberto primeiro
            fecharModal();
            
            if (tipo === 'cliente') {
                const cliente = clientes.find(c => c.id === id);
                if (cliente) {
                    abrirModalEdicaoCliente(cliente);
                }
            } else if (tipo === 'contrato') {
                const contrato = contratos.find(c => c.id === id);
                console.log('Contrato encontrado:', contrato);
                if (contrato) {
                    // Aguardar um pouco para garantir que o modal anterior foi fechado
                    setTimeout(() => {
                        abrirModalEdicaoContrato(contrato);
                    }, 100);
                } else {
                    console.error('Contrato não encontrado com ID:', id);
                    mostrarNotificacao('Contrato não encontrado!', 'error');
                }
            } else if (tipo === 'honorario') {
                const honorario = honorarios.find(h => h.id === id);
                if (honorario) {
                    abrirModalEdicaoHonorario(honorario);
                }
            } else if (tipo === 'heranca') {
                const heranca = herancas.find(h => h.id === id);
                if (heranca) {
                    abrirModalEdicaoHeranca(heranca);
                }
            } else if (tipo === 'migracao') {
                const migracao = migracoes.find(m => m.id === id);
                if (migracao) {
                    abrirModalEdicaoMigracao(migracao);
                }
            } else if (tipo === 'registo') {
                const registo = registos.find(r => r.id === id);
                if (registo) {
                    abrirModalEdicaoRegisto(registo);
                }
            } else if (tipo === 'prazo') {
                const prazo = prazos.find(p => p.id === id);
                if (prazo) {
                    abrirModalEdicaoPrazo(prazo);
                }
            } else {
                mostrarNotificacao('Funcionalidade de edição em desenvolvimento', 'info');
            }
        }

        function excluirItem(tipo, id) {
            console.log('🔧 excluirItem chamado:', tipo, id);
            
            if (confirm('Tem certeza que deseja excluir este item?')) {
                if (tipo === 'cliente') {
                    clientes = clientes.filter(item => item.id !== id);
                    salvarDados('clientes', clientes);
                    console.log('✅ Cliente excluído');
                } else if (tipo === 'honorario') {
                    honorarios = honorarios.filter(item => item.id !== id);
                    salvarDados('honorarios', honorarios);
                    console.log('✅ Honorário excluído');
                } else if (tipo === 'contrato') {
                    console.log('🔧 Excluindo contrato com ID:', id);
                    console.log('🔧 Contratos antes:', contratos.length);
                    contratos = contratos.filter(item => item.id !== id);
                    console.log('🔧 Contratos depois:', contratos.length);
                    salvarDados('contratos', contratos);
                    console.log('✅ Contrato excluído');
                } else if (tipo === 'heranca') {
                    herancas = herancas.filter(item => item.id !== id);
                    salvarDados('herancas', herancas);
                    console.log('✅ Herança excluída');
                } else if (tipo === 'migracao') {
                    migracoes = migracoes.filter(item => item.id !== id);
                    salvarDados('migracoes', migracoes);
                    console.log('✅ Migração excluída');
                } else if (tipo === 'registo') {
                    registos = registos.filter(item => item.id !== id);
                    salvarDados('registos', registos);
                    console.log('✅ Registo excluído');
                } else if (tipo === 'prazo') {
                    prazos = prazos.filter(item => item.id !== id);
                    salvarDados('prazos', prazos);
                    console.log('✅ Prazo excluído');
                }
                mostrarNotificacao('Item excluído com sucesso!', 'success');
                carregarSecao(secaoAtiva);
            }
        }

        function exportarDados() {
            const dados = {
                exportadoEm: new Date().toISOString(),
                versao: '38.0',
                dados: { clientes, honorarios, contratos }
            };
            
            const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sistema_legal_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('Dados exportados com sucesso!', 'success');
        }

        function importarDados() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const dados = JSON.parse(e.target.result);
                            if (dados.dados) {
                                clientes = dados.dados.clientes || [];
                                honorarios = dados.dados.honorarios || [];
                                contratos = dados.dados.contratos || [];
                                salvarDados('clientes', clientes);
                                salvarDados('honorarios', honorarios);
                                salvarDados('contratos', contratos);
                                mostrarNotificacao('Dados importados com sucesso!', 'success');
                                carregarSecao(secaoAtiva);
                            }
                        } catch (error) {
                            mostrarNotificacao('Erro ao importar dados', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function gerarRelatorioClientes() {
            const relatorio = `
RELATÓRIO DE CLIENTES
====================
Data: ${new Date().toLocaleDateString('pt-PT')}

Total de Clientes: ${clientes.length}

CLIENTES CADASTRADOS:
${clientes.map((cliente, index) => `
${index + 1}. ${cliente.nome}
   Email: ${cliente.email}
   Telefone: ${cliente.telefone}
   Status: ${cliente.status}
   Data: ${new Date(cliente.dataCriacao).toLocaleDateString('pt-PT')}
`).join('')}
            `;
            
            downloadRelatorio(relatorio, 'relatorio_clientes.txt');
        }

        function gerarRelatorioFinanceiro() {
            const valorTotal = honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            const honorariosPagos = honorarios.filter(h => h.status === 'pago');
            const valorPago = honorariosPagos.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            
            const relatorio = `
RELATÓRIO FINANCEIRO
====================
Data: ${new Date().toLocaleDateString('pt-PT')}

RESUMO FINANCEIRO:
- Total de Honorários: ${honorarios.length}
- Valor Total: €${(Math.round(valorTotal * 100) / 100).toFixed(2)}
- Valor Pago: €${Number(valorPago).toFixed(2)}
- Valor Pendente: €${Number(valorTotal - valorPago).toFixed(2)}

HONORÁRIOS POR STATUS:
- Pagos: ${honorarios.filter(h => h.status === 'pago').length}
- Pendentes: ${honorarios.filter(h => h.status === 'pendente').length}
- Vencidos: ${honorarios.filter(h => h.status === 'vencido').length}

DETALHES DOS HONORÁRIOS:
${honorarios.map((honorario, index) => `
${index + 1}. ${honorario.cliente} - ${honorario.servico}
   Valor: €${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}
   Status: ${honorario.status}
   Vencimento: ${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}
`).join('')}
            `;
            
            downloadRelatorio(relatorio, 'relatorio_financeiro.txt');
        }

        function gerarRelatorioCompleto() {
            const relatorio = `
RELATÓRIO COMPLETO DO SISTEMA
============================
Data: ${new Date().toLocaleDateString('pt-PT')}
Versão: 38.0

ESTATÍSTICAS GERAIS:
- Clientes: ${clientes.length}
- Honorários: ${honorarios.length}

RESUMO FINANCEIRO:
- Valor Total: €${Number(honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0)).toFixed(2)}
- Honorários Pagos: ${honorarios.filter(h => h.status === 'pago').length}
- Honorários Pendentes: ${honorarios.filter(h => h.status === 'pendente').length}

CLIENTES:
${clientes.map((cliente, index) => `
${index + 1}. ${cliente.nome} (${cliente.status})
`).join('')}

HONORÁRIOS:
${honorarios.map((honorario, index) => `
${index + 1}. ${honorario.cliente} - €${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)} (${honorario.status})
`).join('')}
            `;
            
            downloadRelatorio(relatorio, 'relatorio_completo.txt');
        }

        function downloadRelatorio(conteudo, nomeArquivo) {
            const blob = new Blob([conteudo], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('Relatório gerado com sucesso!', 'success');
        }

        // === SISTEMA DE BACKUP AUTOMÁTICO ===
        
        let backupInterval;
        let ultimoBackup = null;
        
        function iniciarSistemaBackup() {
            console.log('💾 Iniciando sistema de backup automático');
            
            // Backup inicial
            criarBackupAutomatico();
            
            // Backup a cada 5 minutos
            backupInterval = setInterval(() => {
                criarBackupAutomatico();
            }, 5 * 60 * 1000);
            
            // Backup antes de fechar a página
            window.addEventListener('beforeunload', () => {
                criarBackupAutomatico();
            });
        }
        
        function criarBackupAutomatico() {
            try {
                const backup = {
                    timestamp: new Date().toISOString(),
                    dados: {
                        clientes: clientes,
                        honorarios: honorarios,
                        contratos: contratos,
                        prazos: prazos,
                        notificacoes: notificacoes,
                        herancas: herancas,
                        migracoes: migracoes,
                        registos: registos
                    },
                    versao: '1.0',
                    tipo: 'automatico'
                };
                
                // Salvar backup no localStorage
                const backupKey = `backup_${Date.now()}`;
                localStorage.setItem(backupKey, JSON.stringify(backup));
                
                // Manter apenas os últimos 10 backups
                limparBackupsAntigos();
                
                ultimoBackup = backup.timestamp;
                console.log('✅ Backup automático criado:', new Date(backup.timestamp).toLocaleString('pt-PT'));
                
            } catch (error) {
                console.error('❌ Erro ao criar backup automático:', error);
            }
        }
        
        function limparBackupsAntigos() {
            const chaves = Object.keys(localStorage);
            const backups = chaves.filter(chave => chave.startsWith('backup_'));
            
            if (backups.length > 10) {
                // Ordenar por timestamp (mais antigos primeiro)
                const backupsOrdenados = backups.sort((a, b) => {
                    const timestampA = parseInt(a.split('_')[1]);
                    const timestampB = parseInt(b.split('_')[1]);
                    return timestampA - timestampB;
                });
                
                // Remover os mais antigos
                const paraRemover = backupsOrdenados.slice(0, backups.length - 10);
                paraRemover.forEach(chave => {
                    localStorage.removeItem(chave);
                });
                
                console.log(`🗑️ Removidos ${paraRemover.length} backups antigos`);
            }
        }
        
        function exportarDadosCompletos() {
            try {
                const dadosCompletos = {
                    timestamp: new Date().toISOString(),
                    versao: '1.0',
                    dados: {
                        clientes: clientes,
                        honorarios: honorarios,
                        contratos: contratos,
                        prazos: prazos,
                        notificacoes: notificacoes,
                        herancas: herancas,
                        migracoes: migracoes,
                        registos: registos
                    },
                    estatisticas: {
                        totalClientes: clientes.length,
                        totalHonorarios: honorarios.length,
                        totalContratos: contratos.length,
                        totalPrazos: prazos.length,
                        totalNotificacoes: notificacoes.length,
                        totalHerancas: herancas.length,
                        totalMigracoes: migracoes.length,
                        totalRegistos: registos.length
                    }
                };
                
                const blob = new Blob([JSON.stringify(dadosCompletos, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_sistema_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                mostrarNotificacao('Backup exportado com sucesso!', 'success');
                
            } catch (error) {
                console.error('❌ Erro ao exportar dados:', error);
                mostrarNotificacao('Erro ao exportar backup', 'error');
            }
        }
        
        function importarDadosCompletos() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (event) => {
                const arquivo = event.target.files[0];
                if (!arquivo) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const dadosImportados = JSON.parse(e.target.result);
                        
                        // Validar estrutura do arquivo
                        if (!dadosImportados.dados || !dadosImportados.versao) {
                            throw new Error('Arquivo de backup inválido');
                        }
                        
                        // Confirmar importação
                        if (confirm('⚠️ ATENÇÃO: Esta ação irá substituir TODOS os dados atuais!\n\nTem certeza que deseja continuar?')) {
                            
                            // Criar backup antes de importar
                            criarBackupAutomatico();
                            
                            // Importar dados
                            clientes = dadosImportados.dados.clientes || [];
                            honorarios = dadosImportados.dados.honorarios || [];
                            contratos = dadosImportados.dados.contratos || [];
                            prazos = dadosImportados.dados.prazos || [];
                            notificacoes = dadosImportados.dados.notificacoes || [];
                            herancas = dadosImportados.dados.herancas || [];
                            migracoes = dadosImportados.dados.migracoes || [];
                            registos = dadosImportados.dados.registos || [];
                            
                            // Salvar dados importados
                            salvarDados('clientes', clientes);
                            salvarDados('honorarios', honorarios);
                            salvarDados('contratos', contratos);
                            salvarDados('prazos', prazos);
                            salvarDados('notificacoes', notificacoes);
                            salvarDados('herancas', herancas);
                            salvarDados('migracoes', migracoes);
                            salvarDados('registos', registos);
                            
                            mostrarNotificacao('Dados importados com sucesso!', 'success');
                            
                            // Recarregar seção atual
                            carregarSecao(secaoAtiva);
                        }
                        
                    } catch (error) {
                        console.error('❌ Erro ao importar dados:', error);
                        mostrarNotificacao('Erro ao importar backup: ' + error.message, 'error');
                    }
                };
                reader.readAsText(arquivo);
            };
            input.click();
        }
        
        function gerarBackup() {
            const chaves = Object.keys(localStorage);
            const backups = chaves.filter(chave => chave.startsWith('backup_'));
            const ultimoBackupTexto = ultimoBackup ? new Date(ultimoBackup).toLocaleString('pt-PT') : 'Nunca';
            
            return `
                <div class="space-y-6">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Status do Sistema de Backup</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Último backup automático:</span>
                                <span class="font-medium">${ultimoBackupTexto}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total de backups:</span>
                                <span class="font-medium">${backups.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Frequência:</span>
                                <span class="font-medium">A cada 5 minutos</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Ações de Backup</h3>
                        <div class="space-y-3">
                            <button onclick="criarBackupAutomatico(); mostrarNotificacao('Backup manual criado!', 'success')" 
                                    class="w-full btn btn-primary">
                                <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                Criar Backup Manual
                            </button>
                            <button onclick="exportarDadosCompletos()" 
                                    class="w-full btn btn-success">
                                <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                Exportar Backup Completo
                            </button>
                            <button onclick="importarDadosCompletos()" 
                                    class="w-full btn btn-warning">
                                <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                                Importar Backup
                            </button>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Informações do Sistema</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Clientes:</span>
                                <span class="font-medium">${clientes.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Contratos:</span>
                                <span class="font-medium">${contratos.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Honorários:</span>
                                <span class="font-medium">${honorarios.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Prazos:</span>
                                <span class="font-medium">${prazos.length}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        // === SISTEMA RESTAURADO - SEM LOGIN ===
        
        
        // Carregar usuários do localStorage
        
        
        // Sistema restaurado - sem login
        
        
        
        
        // Processar login
        function processarLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;
            
            if (fazerLogin(email, senha)) {
                // Login bem-sucedido
            }
        }
        
        // Mostrar sistema principal
        function mostrarSistema() {
            document.body.innerHTML = `
                <div class="flex h-screen bg-gray-900">
                    <!-- Sidebar -->
                    <div id="sidebar" class="w-64 bg-gray-800 shadow-lg">
                        <div class="p-6">
                            <div class="flex items-center">
                                <div class="h-8 w-8 bg-blue-600 rounded-lg flex items-center justify-center">
                                    <i data-lucide="scale" class="h-5 w-5 text-white"></i>
                                </div>
                                <h1 class="ml-3 text-xl font-bold text-white">Sistema Jurídico</h1>
                            </div>
                        </div>
                        
                        <nav class="mt-6">
                            <a href="#" onclick="carregarSecao('dashboard')" class="sidebar-item" id="nav-dashboard">
                                <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                                Dashboard
                            </a>
                            <a href="#" onclick="carregarSecao('clientes')" class="sidebar-item" id="nav-clientes">
                                <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                                Gestão de Clientes
                            </a>
                            <a href="#" onclick="carregarSecao('honorarios')" class="sidebar-item" id="nav-honorarios">
                                <i data-lucide="dollar-sign" class="w-5 h-5 mr-3"></i>
                                Gestão de Honorários
                            </a>
                            <a href="#" onclick="carregarSecao('contratos')" class="sidebar-item" id="nav-contratos">
                                <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                                Gestão de Contratos
                            </a>
                            <a href="#" onclick="carregarSecao('herancas')" class="sidebar-item" id="nav-herancas">
                                <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                                Gestão de Heranças
                            </a>
                            <a href="#" onclick="carregarSecao('migracao')" class="sidebar-item" id="nav-migracao">
                                <i data-lucide="globe" class="w-5 h-5 mr-3"></i>
                                Gestão de Migração
                            </a>
                            <a href="#" onclick="carregarSecao('registos')" class="sidebar-item" id="nav-registos">
                                <i data-lucide="clipboard" class="w-5 h-5 mr-3"></i>
                                Gestão de Registos
                            </a>
                            <a href="#" onclick="carregarSecao('prazos')" class="sidebar-item" id="nav-prazos">
                                <i data-lucide="calendar" class="w-5 h-5 mr-3"></i>
                                Gestão de Prazos
                            </a>
                            <a href="#" onclick="carregarSecao('notificacoes')" class="sidebar-item" id="nav-notificacoes">
                                <i data-lucide="bell" class="w-5 h-5 mr-3"></i>
                                Notificações
                                <span id="badgeNotificacoes" class="badge hidden">0</span>
                            </a>
                            <a href="#" onclick="carregarSecao('relatorios')" class="sidebar-item" id="nav-relatorios">
                                <i data-lucide="bar-chart-3" class="w-5 h-5 mr-3"></i>
                                Gestão de Relatórios
                            </a>
                            <a href="#" onclick="carregarSecao('backup')" class="sidebar-item" id="nav-backup">
                                <i data-lucide="database" class="w-5 h-5 mr-3"></i>
                                Backup
                            </a>
                        </nav>
                        
                        <div class="absolute bottom-0 w-64 p-4">
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="flex items-center">
                                    <div class="h-8 w-8 bg-gray-600 rounded-full flex items-center justify-center">
                                        <i data-lucide="user" class="h-4 w-4 text-gray-300"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-white">${usuarioLogado ? usuarioLogado.nome : 'Usuário'}</p>
                                        <p class="text-xs text-gray-300">${usuarioLogado ? usuarioLogado.email : ''}</p>
                                    </div>
                                </div>
                                <button onclick="fazerLogout()" class="mt-2 w-full text-left text-sm text-red-400 hover:text-red-300">
                                    <i data-lucide="log-out" class="w-4 h-4 inline mr-1"></i>
                                    Sair
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Conteúdo Principal -->
                    <div class="flex-1 flex flex-col overflow-hidden bg-gray-100">
                        <!-- Header -->
                        <header class="bg-white shadow-sm border-b border-gray-200">
                            <div class="px-6 py-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h2 id="tituloSecao" class="text-2xl font-bold text-gray-900">Sistema Legal</h2>
                                        <p id="subtituloSecao" class="text-sm text-gray-600">Visão geral do sistema</p>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100">
                                            <i data-lucide="menu" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </header>
                        
                        <!-- Conteúdo -->
                        <main class="flex-1 overflow-y-auto">
                            <div class="p-6">
                                <div id="conteudoDinamico">
                                    <!-- Conteúdo será carregado aqui -->
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
                
                <!-- Modal Container -->
                <div id="modalContainer"></div>
                
                <!-- Notifications Container -->
                <div id="notificationsContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
            `;
            lucide.createIcons();
        }
        
        // Mostrar modal para criar usuário
        function mostrarCriarUsuario() {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Criar Novo Usuário</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="criarUsuario(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                                        <input type="text" id="novoNome" required 
                                               class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                        <input type="email" id="novoEmail" required 
                                               class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                                        <input type="password" id="novaSenha" required 
                                               class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Usuário</label>
                                        <select id="novoTipo" required 
                                                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                            <option value="admin">Administrador</option>
                                            <option value="usuario">Usuário</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" 
                                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                        Cancelar
                                    </button>
                                    <button type="submit" 
                                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                        Criar Usuário
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
            lucide.createIcons();
        }
        
        // Criar novo usuário
        function criarUsuario(event) {
            event.preventDefault();
            
            const nome = document.getElementById('novoNome').value;
            const email = document.getElementById('novoEmail').value;
            const senha = document.getElementById('novaSenha').value;
            const tipo = document.getElementById('novoTipo').value;
            
            // Verificar se email já existe
            if (usuarios.find(u => u.email === email)) {
                mostrarNotificacao('Email já cadastrado', 'error');
                return;
            }
            
            const novoUsuario = {
                id: Date.now(),
                nome: nome,
                email: email,
                senha: senha,
                tipo: tipo,
                ativo: true,
                dataCriacao: new Date().toISOString()
            };
            
            usuarios.push(novoUsuario);
            salvarUsuarios();
            
            mostrarNotificacao('Usuário criado com sucesso!', 'success');
            fecharModal();
        }
        

        // === SISTEMA DE ANEXOS PARA REGISTOS ===
        
        function abrirAnexosRegisto(registoId) {
            const registo = registos.find(r => r.id === registoId);
            if (!registo) return;
            
            if (!registo.anexos) {
                registo.anexos = [];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos do Registo</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexoRegisto(event, ${registoId})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('registo')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="certidao">Certidão</option>
                                                <option value="documento">Documento</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizadoRegisto" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrição (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descrição do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModal()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${registo.anexos.length})</h4>
                                ${registo.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${registo.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} • ${anexo.tamanho} • ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexoRegisto(${registoId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }
        
        function adicionarAnexoRegisto(event, registoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            const anexo = {
                id: Date.now().toString(),
                nome: nome,
                tipo: tipo,
                descricao: descricao,
                nomeArquivo: arquivo.name,
                tamanho: formatarTamanho(arquivo.size),
                dataUpload: new Date().toISOString(),
                tipoArquivo: arquivo.type,
                dados: 'simulado'
            };
            
            const registo = registos.find(r => r.id === registoId);
            if (registo) {
                if (!registo.anexos) registo.anexos = [];
                registo.anexos.push(anexo);
                salvarDados('registos', registos);
                mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                abrirAnexosRegisto(registoId);
            }
        }
        
        function removerAnexoRegisto(registoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const registo = registos.find(r => r.id === registoId);
                if (registo && registo.anexos) {
                    registo.anexos = registo.anexos.filter(a => a.id !== anexoId);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosRegisto(registoId);
                }
            }
        }

        // === SISTEMA DE ANEXOS PARA PRAZOS ===
        
        function abrirAnexosPrazo(prazoId) {
            const prazo = prazos.find(p => p.id === prazoId);
            if (!prazo) return;
            
            if (!prazo.anexos) {
                prazo.anexos = [];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos do Prazo</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexoPrazo(event, ${prazoId})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('prazo')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="documento">Documento</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="certidao">Certidão</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizadoPrazo" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrição (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descrição do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModal()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${prazo.anexos.length})</h4>
                                ${prazo.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${prazo.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} • ${anexo.tamanho} • ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexoPrazo(${prazoId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }
        
        function adicionarAnexoPrazo(event, prazoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            const anexo = {
                id: Date.now().toString(),
                nome: nome,
                tipo: tipo,
                descricao: descricao,
                nomeArquivo: arquivo.name,
                tamanho: formatarTamanho(arquivo.size),
                dataUpload: new Date().toISOString(),
                tipoArquivo: arquivo.type,
                dados: 'simulado'
            };
            
            const prazo = prazos.find(p => p.id === prazoId);
            if (prazo) {
                if (!prazo.anexos) prazo.anexos = [];
                prazo.anexos.push(anexo);
                salvarDados('prazos', prazos);
                mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                abrirAnexosPrazo(prazoId);
            }
        }
        
        function removerAnexoPrazo(prazoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const prazo = prazos.find(p => p.id === prazoId);
                if (prazo && prazo.anexos) {
                    prazo.anexos = prazo.anexos.filter(a => a.id !== anexoId);
                    salvarDados('prazos', prazos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosPrazo(prazoId);
                }
            }
        }

        // === SISTEMA DE NOTIFICAÇÕES AUTOMÁTICAS ===
        
        function iniciarSistemaNotificacoes() {
            console.log('🔔 Iniciando sistema de notificações');
            verificarHonorariosVencidos();
            verificarPrazosUrgentes();
            atualizarBadgeNotificacoes();
            
            // Verificar a cada 5 minutos
            setInterval(() => {
                verificarHonorariosVencidos();
                verificarPrazosUrgentes();
                atualizarBadgeNotificacoes();
            }, 5 * 60 * 1000);
        }


        function verificarHonorariosVencidos() {
            const hoje = new Date();
            const honorariosVencidos = honorarios.filter(h => {
                try {
                    if (!h.vencimento) return false;
                    const dataVencimento = new Date(h.vencimento);
                    if (isNaN(dataVencimento.getTime())) {
                        console.warn('Data de vencimento inválida no honorário:', h.vencimento);
                        return false;
                    }
                    return dataVencimento < hoje && h.status === 'pendente';
                } catch (error) {
                    console.warn('Erro ao processar honorário:', h.id, error);
                    return false;
                }
            });

            honorariosVencidos.forEach(honorario => {
                // Atualizar status para vencido
                const index = honorarios.findIndex(h => h.id === honorario.id);
                if (index !== -1) {
                    honorarios[index].status = 'vencido';
                }

                // Criar notificação se não existir
                const notificacaoExistente = notificacoes.find(n => 
                    n.tipo === 'honorario' && 
                    n.referenciaId === honorario.id && 
                    n.titulo.includes('Vencido')
                );

                if (!notificacaoExistente) {
                    criarNotificacao({
                        tipo: 'honorario',
                        titulo: 'Honorário Vencido',
                        mensagem: `O honorário de €${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)} do cliente ${honorario.cliente} está vencido desde ${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}`,
                        prioridade: 'alta',
                        referenciaId: honorario.id,
                        acao: 'ver_honorario'
                    });
                    
                }
            });

            salvarDados('honorarios', honorarios);
        }

        function verificarPrazosUrgentes() {
            const hoje = new Date();
            const amanha = new Date(hoje.getTime() + 24 * 60 * 60 * 1000);
            const proximos3Dias = new Date(hoje.getTime() + 3 * 24 * 60 * 60 * 1000);

            prazos.forEach(prazo => {
                try {
                    if (!prazo.dataLimite) return;
                    const dataLimite = new Date(prazo.dataLimite);
                    if (isNaN(dataLimite.getTime())) {
                        console.warn('Data inválida no prazo:', prazo.dataLimite);
                        return;
                    }
                    const diasRestantes = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));

                // Prazos vencidos
                if (dataLimite < hoje && prazo.status === 'ativo') {
                    const notificacaoExistente = notificacoes.find(n => 
                        n.tipo === 'prazo' && 
                        n.referenciaId === prazo.id && 
                        n.titulo.includes('Vencido')
                    );

                    if (!notificacaoExistente) {
                        criarNotificacao({
                            tipo: 'prazo',
                            titulo: 'Prazo Vencido',
                            mensagem: `O prazo "${prazo.descricao}" do cliente ${prazo.clienteNome} venceu em ${dataLimite.toLocaleDateString('pt-PT')}`,
                            prioridade: 'critica',
                            referenciaId: prazo.id,
                            acao: 'ver_prazo'
                        });
                    }
                }
                // Prazos que vencem hoje
                else if (dataLimite.toDateString() === hoje.toDateString() && prazo.status === 'ativo') {
                    const notificacaoExistente = notificacoes.find(n => 
                        n.tipo === 'prazo' && 
                        n.referenciaId === prazo.id && 
                        n.titulo.includes('Hoje')
                    );

                    if (!notificacaoExistente) {
                        criarNotificacao({
                            tipo: 'prazo',
                            titulo: 'Prazo Vence Hoje',
                            mensagem: `O prazo "${prazo.descricao}" do cliente ${prazo.clienteNome} vence hoje!`,
                            prioridade: 'alta',
                            referenciaId: prazo.id,
                            acao: 'ver_prazo'
                        });
                    }
                }
                // Prazos que vencem em 3 dias
                else if (dataLimite <= proximos3Dias && dataLimite > amanha && prazo.status === 'ativo') {
                    const notificacaoExistente = notificacoes.find(n => 
                        n.tipo === 'prazo' && 
                        n.referenciaId === prazo.id && 
                        n.titulo.includes('3 dias')
                    );

                    if (!notificacaoExistente) {
                        criarNotificacao({
                            tipo: 'prazo',
                            titulo: 'Prazo em 3 Dias',
                            mensagem: `O prazo "${prazo.descricao}" do cliente ${prazo.clienteNome} vence em ${diasRestantes} dias`,
                            prioridade: 'media',
                            referenciaId: prazo.id,
                            acao: 'ver_prazo'
                        });
                    }
                }
                } catch (error) {
                    console.warn('Erro ao processar prazo:', prazo.id, error);
                }
            });
        }

        function criarNotificacao(dados) {
            // Verificar se já existe uma notificação similar não lida
            const notificacaoExistente = notificacoes.find(n => 
                n.tipo === dados.tipo && 
                n.referenciaId === dados.referenciaId && 
                !n.lida &&
                n.titulo === dados.titulo
            );

            if (notificacaoExistente) {
                // Se já existe, apenas atualizar a data e mostrar lembrete visual
                notificacaoExistente.dataCriacao = new Date().toISOString();
                salvarDados('notificacoes', notificacoes);
                mostrarLembreteNotificacao(dados.titulo);
                return;
            }

            const notificacao = {
                id: Date.now(),
                tipo: dados.tipo,
                titulo: dados.titulo,
                mensagem: dados.mensagem,
                prioridade: dados.prioridade,
                referenciaId: dados.referenciaId,
                acao: dados.acao,
                lida: false,
                dataCriacao: new Date().toISOString()
            };

            notificacoes.unshift(notificacao);
            salvarDados('notificacoes', notificacoes);
            
            // Mostrar notificação visual
            mostrarNotificacao(notificacao.titulo, 'warning');
        }

        function mostrarLembreteNotificacao(titulo) {
            // Criar lembrete visual no canto superior direito
            const lembrete = document.createElement('div');
            lembrete.className = 'fixed top-4 right-4 bg-orange-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center space-x-2 animate-pulse';
            lembrete.innerHTML = `
                <i data-lucide="bell" class="w-4 h-4"></i>
                <span>Lembrete: ${titulo}</span>
            `;
            
            document.body.appendChild(lembrete);
            lucide.createIcons();
            
            // Remover após 3 segundos
            setTimeout(() => {
                if (lembrete.parentNode) {
                    lembrete.parentNode.removeChild(lembrete);
                }
            }, 3000);
        }

        // === SISTEMA DE TESTE DE NOTIFICAÇÕES ===
        
        function criarNotificacaoTeste() {
            const tipos = ['prazo', 'honorario', 'contrato', 'heranca', 'migracao', 'registo'];
            const titulos = [
                'Prazo Vencido',
                'Honorário Vencido', 
                'Contrato Pendente',
                'Herança em Andamento',
                'Migração Urgente',
                'Registo Pendente'
            ];
            const mensagens = [
                'O prazo para entrega de documentos vence hoje!',
                'O honorário de €500 está vencido há 3 dias',
                'O contrato precisa ser assinado até amanhã',
                'A herança está aguardando documentação',
                'O processo de migração está atrasado',
                'O registo precisa ser finalizado esta semana'
            ];
            
            const tipoAleatorio = tipos[Math.floor(Math.random() * tipos.length)];
            const tituloAleatorio = titulos[Math.floor(Math.random() * titulos.length)];
            const mensagemAleatoria = mensagens[Math.floor(Math.random() * mensagens.length)];
            
            criarNotificacao({
                tipo: tipoAleatorio,
                titulo: tituloAleatorio,
                mensagem: mensagemAleatoria,
                prioridade: 'alta',
                referenciaId: Date.now(),
                acao: 'ver_detalhes'
            });
            
            mostrarNotificacao('Notificação de teste criada!', 'success');
        }
        
        function criarNotificacaoPersonalizada() {
            const titulo = prompt('Digite o título da notificação:');
            if (!titulo) return;
            
            const mensagem = prompt('Digite a mensagem da notificação:');
            if (!mensagem) return;
            
            const tipo = prompt('Digite o tipo (prazo, honorario, contrato, heranca, migracao, registo):');
            if (!tipo) return;
            
            criarNotificacao({
                tipo: tipo,
                titulo: titulo,
                mensagem: mensagem,
                prioridade: 'media',
                referenciaId: Date.now(),
                acao: 'ver_detalhes'
            });
            
            mostrarNotificacao('Notificação personalizada criada!', 'success');
        }

        function atualizarBadgeNotificacoes() {
            const notificacoesNaoLidas = notificacoes.filter(n => !n.lida).length;
            const badge = document.getElementById('badgeNotificacoes');
            
            if (badge) {
                if (notificacoesNaoLidas > 0) {
                    badge.textContent = notificacoesNaoLidas;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        function marcarComoLida(notificacaoId) {
            const notificacao = notificacoes.find(n => n.id === notificacaoId);
            if (notificacao) {
                notificacao.lida = true;
                salvarDados('notificacoes', notificacoes);
                carregarSecao('notificacoes');
                atualizarBadgeNotificacoes();
            }
        }

        function marcarTodasComoLidas() {
            notificacoes.forEach(n => n.lida = true);
            salvarDados('notificacoes', notificacoes);
            carregarSecao('notificacoes');
            atualizarBadgeNotificacoes();
            mostrarNotificacao('Todas as notificações foram marcadas como lidas', 'success');
        }

        function excluirNotificacao(notificacaoId) {
            notificacoes = notificacoes.filter(n => n.id !== notificacaoId);
            salvarDados('notificacoes', notificacoes);
            carregarSecao('notificacoes');
            atualizarBadgeNotificacoes();
        }

        function limparNotificacoes() {
            if (confirm('Tem certeza que deseja limpar todas as notificações?')) {
                notificacoes = [];
                salvarDados('notificacoes', notificacoes);
                carregarSecao('notificacoes');
                atualizarBadgeNotificacoes();
                mostrarNotificacao('Todas as notificações foram removidas', 'success');
            }
        }

        function filtrarPrazos() {
            const busca = document.getElementById('buscaPrazos')?.value.toLowerCase() || '';
            
            const prazosFiltrados = prazos.filter(prazo => {
                return prazo.clienteNome.toLowerCase().includes(busca) || 
                       prazo.tipo.toLowerCase().includes(busca) ||
                       prazo.descricao.toLowerCase().includes(busca);
            });
            
            atualizarListaPrazos(prazosFiltrados);
        }

        function atualizarListaPrazos(prazosFiltrados) {
            const tbody = document.getElementById('listaPrazos');
            if (!tbody) return;
            
            tbody.innerHTML = prazosFiltrados.map(prazo => `
                <tr>
                    <td>${prazo.clienteNome}</td>
                    <td>${prazo.tipo}</td>
                    <td>${prazo.descricao}</td>
                    <td>${prazo.dataLimite ? new Date(prazo.dataLimite).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                    <td><span class="status-badge status-${prazo.prioridade}">${prazo.prioridade}</span></td>
                    <td><span class="status-badge status-${prazo.status}">${prazo.status}</span></td>
                    <td>
                        <button onclick="editarItem('prazo', ${prazo.id})" class="text-blue-600 hover:text-blue-800">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirItem('prazo', ${prazo.id})" class="text-red-600 hover:text-red-800 ml-2">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Inicializar sistema
        document.addEventListener('DOMContentLoaded', () => {
            init();
        });

        // === FUNÇÕES DAS NOVAS SEÇÕES ===

        function gerarHerancas() {
            const totalHerancas = herancas.length;
            const herancasAtivas = herancas.filter(h => h.status === 'em_andamento').length;
            const herancasSuspensas = herancas.filter(h => h.status === 'pendente').length;
            const herancasTerminadas = herancas.filter(h => h.status === 'concluido').length;
            const valorTotalHerancas = herancas.reduce((total, h) => total + (h.valorComIva || h.valor || 0), 0);

            return `
                <div class="space-y-6">
                    <!-- Header único com botões de ação -->
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-3">
                            <button onclick="abrirModalHeranca()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Nova Herança
                            </button>
                        </div>
                    </div>

                    <!-- Estatísticas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${herancasAtivas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Suspensos</p>
                                    <p class="text-2xl font-bold text-gray-900">${herancasSuspensas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Terminados</p>
                                    <p class="text-2xl font-bold text-gray-900">${herancasTerminadas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">€${Number(valorTotalHerancas).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de busca -->
                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaHerancas" placeholder="Buscar heranças..." 
                                   class="search-input" onkeyup="filtrarHerancas()">
                        </div>
                        
                        <!-- Filtros Avançados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusHeranca" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHerancas()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="filtroTipoHeranca" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHerancas()">
                                    <option value="">Todos os tipos</option>
                                    <option value="Aceitação da herança">Aceitação da herança</option>
                                    <option value="Doações">Doações</option>
                                    <option value="Escrituras de partilha">Escrituras de partilha</option>
                                    <option value="Habilitação de herdeiros">Habilitação de herdeiros</option>
                                    <option value="Partilhas em vida">Partilhas em vida</option>
                                    <option value="Partilhas por óbito">Partilhas por óbito</option>
                                    <option value="Processo de inventário">Processo de inventário</option>
                                    <option value="Renúncia à herança">Renúncia à herança</option>
                                    <option value="Testamentos">Testamentos</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor Mínimo</label>
                                <input type="number" id="filtroValorMinHeranca" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHerancas()">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor Máximo</label>
                                <input type="number" id="filtroValorMaxHeranca" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHerancas()">
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosHerancas()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorHerancas">0</span> heranças encontradas
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="overflow-x-auto table-responsive">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Descrição</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Data Início</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="listaHerancas" class="bg-white divide-y divide-gray-200">
                                    ${herancas.map(heranca => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${heranca.clienteNome}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${heranca.tipo}</td>
                                            <td class="px-6 py-4 text-sm text-gray-500">${heranca.descricao}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <div class="flex flex-col">
                                                    <div class="text-sm font-medium text-gray-900">€${(Math.round((parseFloat(heranca.valor) || 0) * 100) / 100).toFixed(2)}</div>
                                                    <div class="text-xs text-gray-500">
                                                        <span class="text-gray-400">+ ${heranca.iva || 0}% IVA:</span>
                                                        <span class="font-medium text-gray-700">€${(Math.round((parseFloat(heranca.valorComIva || heranca.valor) || 0) * 100) / 100).toFixed(2)}</span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="status-badge status-${heranca.status}">${heranca.status === 'concluido' ? 'Concluído' : heranca.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${heranca.dataInicio ? new Date(heranca.dataInicio).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button onclick="editarHerancaDireto(${heranca.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar">
                                                    <i data-lucide="edit" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="abrirAnexosHeranca(${heranca.id})" class="text-green-600 hover:text-green-900 mr-2" title="Documentos">
                                                    <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="excluirHerancaDireto(${heranca.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarMigracao() {
            console.log('🔧 gerarMigracao chamado');
            console.log('🔧 migracoes array:', migracoes);
            console.log('🔧 migracoes length:', migracoes ? migracoes.length : 'undefined');
            
            // Garantir que migracoes existe
            if (!migracoes) {
                migracoes = [];
            }
            
            const totalMigracoes = migracoes.length;
            const migracoesAtivas = migracoes.filter(m => m.status === 'em_andamento').length;
            const migracoesSuspensas = migracoes.filter(m => m.status === 'pendente').length;
            const migracoesTerminadas = migracoes.filter(m => m.status === 'concluido').length;
            const valorTotalMigracoes = migracoes.reduce((total, m) => {
                const valor = parseFloat(m.valor) || 0;
                return total + valor;
            }, 0);

            return `
                <div class="space-y-6">
                    <!-- Header único com botões de ação -->
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-3">
                            <button onclick="abrirModalMigracaoDireto()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Nova Migração
                            </button>
                        </div>
                    </div>

                    <!-- Estatísticas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${migracoesAtivas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Suspensos</p>
                                    <p class="text-2xl font-bold text-gray-900">${migracoesSuspensas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Terminados</p>
                                    <p class="text-2xl font-bold text-gray-900">${migracoesTerminadas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">€${Number(valorTotalMigracoes).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de busca -->
                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaMigracoes" placeholder="Buscar migrações..." 
                                   class="search-input" onkeyup="filtrarMigracoes()">
                        </div>
                        
                        <!-- Filtros Avançados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusMigracao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosMigracoes()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="filtroTipoMigracao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosMigracoes()">
                                    <option value="">Todos os tipos</option>
                                    <option value="Autorização de residência">Autorização de residência</option>
                                    <option value="Certificados de residência permanente">Certificados de residência permanente</option>
                                    <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                    <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                    <option value="Renovação de autorizações">Renovação de autorizações</option>
                                    <option value="Vistos D7">Vistos D7</option>
                                    <option value="Vistos Gold">Vistos Gold</option>
                                    <option value="Vistos para estudantes">Vistos para estudantes</option>
                                    <option value="Vistos para trabalho">Vistos para trabalho</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor Mínimo</label>
                                <input type="number" id="filtroValorMinMigracao" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosMigracoes()">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor Máximo</label>
                                <input type="number" id="filtroValorMaxMigracao" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosMigracoes()">
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosMigracoes()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorMigracoes">0</span> migrações encontradas
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="overflow-x-auto table-responsive">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Descrição</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Data Início</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="listaMigracoes" class="bg-white divide-y divide-gray-200">
                                    ${migracoes.map(migracao => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${migracao.clienteNome || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.tipo || 'N/A'}</td>
                                            <td class="px-6 py-4 text-sm text-gray-500">${migracao.descricao || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <div class="text-sm font-medium">€${(migracao.valor || 0).toFixed(2)}</div>
                                                <div class="text-xs text-green-600 font-semibold">+ IVA: €${((migracao.valor || 0) + ((migracao.valor || 0) * (migracao.iva || 0) / 100)).toFixed(2)}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="status-badge status-${migracao.status}">${migracao.status === 'concluido' ? 'Concluído' : migracao.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.dataInicio ? new Date(migracao.dataInicio).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button onclick="console.log('🔧 Botão editar clicado para ID:', ${migracao.id}); editarMigracaoDireto(${migracao.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar">
                                                    <i data-lucide="edit" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="abrirAnexosMigracao(${migracao.id})" class="text-green-600 hover:text-green-900 mr-2" title="Documentos">
                                                    <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="console.log('🔧 Botão excluir clicado para ID:', ${migracao.id}); excluirMigracaoDireto(${migracao.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarRegistos() {
            const totalRegistos = registos.length;
            const registosAtivos = registos.filter(r => r.status === 'em_andamento').length;
            const registosSuspensos = registos.filter(r => r.status === 'pendente').length;
            const registosTerminados = registos.filter(r => r.status === 'concluido').length;
            const valorTotalRegistos = registos.reduce((total, r) => total + (r.valorComIva || r.valor || 0), 0);

            return `
                <div class="space-y-6">
                    <!-- Header único com botões de ação -->
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-3">
                            <button onclick="abrirModalRegisto()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Novo Registo
                            </button>
                        </div>
                    </div>

                    <!-- Estatísticas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${registosAtivos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Suspensos</p>
                                    <p class="text-2xl font-bold text-gray-900">${registosSuspensos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Terminados</p>
                                    <p class="text-2xl font-bold text-gray-900">${registosTerminados}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">€${Number(valorTotalRegistos).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de busca -->
                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaRegistos" placeholder="Buscar registos..." 
                                   class="search-input" onkeyup="filtrarRegistos()">
                        </div>
                        
                        <!-- Filtros Avançados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusRegisto" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosRegistos()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="filtroTipoRegisto" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosRegistos()">
                                    <option value="">Todos os tipos</option>
                                    <option value="Autenticação de documentos">Autenticação de documentos</option>
                                    <option value="Certificação de fotocópias">Certificação de fotocópias</option>
                                    <option value="Documentos para o estrangeiro">Documentos para o estrangeiro</option>
                                    <option value="Procurações">Procurações</option>
                                    <option value="Reconhecimento presencial de assinaturas">Reconhecimento presencial de assinaturas</option>
                                    <option value="Registos automóveis">Registos automóveis</option>
                                    <option value="Registos comerciais">Registos comerciais</option>
                                    <option value="Registos de propriedade">Registos de propriedade</option>
                                    <option value="Termos de autenticação">Termos de autenticação</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor Mínimo</label>
                                <input type="number" id="filtroValorMinRegisto" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosRegistos()">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor Máximo</label>
                                <input type="number" id="filtroValorMaxRegisto" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosRegistos()">
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosRegistos()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorRegistos">0</span> registos encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="overflow-x-auto table-responsive">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Descrição</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Data Início</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="listaRegistos" class="bg-white divide-y divide-gray-200">
                                    ${registos.map(registo => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${registo.clienteNome}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registo.tipo}</td>
                                            <td class="px-6 py-4 text-sm text-gray-500">${registo.descricao}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <div class="flex flex-col">
                                                    <div class="text-sm font-medium text-gray-900">€${(Math.round((parseFloat(registo.valor) || 0) * 100) / 100).toFixed(2)}</div>
                                                    <div class="text-xs text-gray-500">
                                                        <span class="text-gray-400">+ ${registo.iva || 0}% IVA:</span>
                                                        <span class="font-medium text-gray-700">€${(Math.round((parseFloat(registo.valorComIva || registo.valor) || 0) * 100) / 100).toFixed(2)}</span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="status-badge status-${registo.status}">${registo.status === 'concluido' ? 'Concluído' : registo.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registo.dataInicio ? new Date(registo.dataInicio).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button onclick="editarRegistoDireto(${registo.id})" class="text-blue-600 hover:text-blue-900 mr-3" title="Editar">
                                                    <i data-lucide="edit" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="abrirAnexosRegisto(${registo.id})" class="text-green-600 hover:text-green-900 mr-3" title="Documentos">
                                                    <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="excluirRegistoDireto(${registo.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }


        // === FUNÇÕES DE FILTRO ===

        function filtrarHerancas() {
            aplicarFiltrosHerancas();
        }

        function aplicarFiltrosHerancas() {
            const busca = document.getElementById('buscaHerancas')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusHeranca')?.value || '';
            const tipo = document.getElementById('filtroTipoHeranca')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinHeranca')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxHeranca')?.value) || Infinity;
            
            const herancasFiltradas = herancas.filter(heranca => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    heranca.clienteNome.toLowerCase().includes(busca) || 
                    heranca.tipo.toLowerCase().includes(busca) ||
                    heranca.observacoes.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || heranca.status === status;
                
                // Filtro por tipo
                const matchTipo = !tipo || heranca.tipo === tipo;
                
                // Filtro por valor
                const valor = parseFloat(heranca.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                return matchBusca && matchStatus && matchTipo && matchValor;
            });
            
            atualizarListaHerancas(herancasFiltradas);
            document.getElementById('contadorHerancas').textContent = herancasFiltradas.length;
        }

        function limparFiltrosHerancas() {
            document.getElementById('buscaHerancas').value = '';
            document.getElementById('filtroStatusHeranca').value = '';
            document.getElementById('filtroTipoHeranca').value = '';
            document.getElementById('filtroValorMinHeranca').value = '';
            document.getElementById('filtroValorMaxHeranca').value = '';
            aplicarFiltrosHerancas();
        }

        function filtrarMigracoes() {
            aplicarFiltrosMigracoes();
        }

        function aplicarFiltrosMigracoes() {
            const busca = document.getElementById('buscaMigracoes')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusMigracao')?.value || '';
            const tipo = document.getElementById('filtroTipoMigracao')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinMigracao')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxMigracao')?.value) || Infinity;
            
            const migracoesFiltradas = migracoes.filter(migracao => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    migracao.clienteNome.toLowerCase().includes(busca) || 
                    migracao.tipo.toLowerCase().includes(busca) ||
                    migracao.observacoes.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || migracao.status === status;
                
                // Filtro por tipo
                const matchTipo = !tipo || migracao.tipo === tipo;
                
                // Filtro por valor
                const valor = parseFloat(migracao.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                return matchBusca && matchStatus && matchTipo && matchValor;
            });
            
            atualizarListaMigracoes(migracoesFiltradas);
            document.getElementById('contadorMigracoes').textContent = migracoesFiltradas.length;
        }

        function limparFiltrosMigracoes() {
            document.getElementById('buscaMigracoes').value = '';
            document.getElementById('filtroStatusMigracao').value = '';
            document.getElementById('filtroTipoMigracao').value = '';
            document.getElementById('filtroValorMinMigracao').value = '';
            document.getElementById('filtroValorMaxMigracao').value = '';
            aplicarFiltrosMigracoes();
        }

        function filtrarRegistos() {
            aplicarFiltrosRegistos();
        }

        function aplicarFiltrosRegistos() {
            const busca = document.getElementById('buscaRegistos')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusRegisto')?.value || '';
            const tipo = document.getElementById('filtroTipoRegisto')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinRegisto')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxRegisto')?.value) || Infinity;
            
            const registosFiltrados = registos.filter(registo => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    registo.clienteNome.toLowerCase().includes(busca) || 
                    registo.tipo.toLowerCase().includes(busca) ||
                    registo.observacoes.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || registo.status === status;
                
                // Filtro por tipo
                const matchTipo = !tipo || registo.tipo === tipo;
                
                // Filtro por valor
                const valor = parseFloat(registo.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                return matchBusca && matchStatus && matchTipo && matchValor;
            });
            
            atualizarListaRegistos(registosFiltrados);
            document.getElementById('contadorRegistos').textContent = registosFiltrados.length;
        }

        function limparFiltrosRegistos() {
            document.getElementById('buscaRegistos').value = '';
            document.getElementById('filtroStatusRegisto').value = '';
            document.getElementById('filtroTipoRegisto').value = '';
            document.getElementById('filtroValorMinRegisto').value = '';
            document.getElementById('filtroValorMaxRegisto').value = '';
            aplicarFiltrosRegistos();
        }

        function filtrarPrazos() {
            aplicarFiltrosPrazos();
        }

        function aplicarFiltrosPrazos() {
            const busca = document.getElementById('buscaPrazos')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusPrazo')?.value || '';
            const tipo = document.getElementById('filtroTipoPrazo')?.value || '';
            const vencimento = document.getElementById('filtroVencimentoPrazo')?.value || '';
            const prioridade = document.getElementById('filtroPrioridadePrazo')?.value || '';
            
            const prazosFiltrados = prazos.filter(prazo => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    prazo.clienteNome.toLowerCase().includes(busca) || 
                    prazo.descricao.toLowerCase().includes(busca) ||
                    prazo.tipo.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || prazo.status === status;
                
                // Filtro por tipo
                const matchTipo = !tipo || prazo.tipo === tipo;
                
                // Filtro por vencimento
                let matchVencimento = true;
                if (vencimento && prazo.dataLimite) {
                    const dataLimite = new Date(prazo.dataLimite);
                    const hoje = new Date();
                    
                    switch (vencimento) {
                        case 'hoje':
                            matchVencimento = dataLimite.toDateString() === hoje.toDateString();
                            break;
                        case 'semana':
                            const fimSemana = new Date(hoje);
                            fimSemana.setDate(hoje.getDate() + 7);
                            matchVencimento = dataLimite >= hoje && dataLimite <= fimSemana;
                            break;
                        case 'mes':
                            const fimMes = new Date(hoje);
                            fimMes.setMonth(hoje.getMonth() + 1);
                            matchVencimento = dataLimite >= hoje && dataLimite <= fimMes;
                            break;
                        case 'vencido':
                            matchVencimento = dataLimite < hoje;
                            break;
                    }
                }
                
                // Filtro por prioridade
                const matchPrioridade = !prioridade || prazo.prioridade === prioridade;
                
                return matchBusca && matchStatus && matchTipo && matchVencimento && matchPrioridade;
            });
            
            atualizarListaPrazos(prazosFiltrados);
            document.getElementById('contadorPrazos').textContent = prazosFiltrados.length;
        }

        function limparFiltrosPrazos() {
            document.getElementById('buscaPrazos').value = '';
            document.getElementById('filtroStatusPrazo').value = '';
            document.getElementById('filtroTipoPrazo').value = '';
            document.getElementById('filtroVencimentoPrazo').value = '';
            document.getElementById('filtroPrioridadePrazo').value = '';
            aplicarFiltrosPrazos();
        }

        function atualizarListaPrazos(prazosFiltrados) {
            const tbody = document.getElementById('listaPrazos');
            if (!tbody) return;
            
            tbody.innerHTML = prazosFiltrados.map(prazo => `
                <tr>
                    <td>${prazo.clienteNome}</td>
                    <td>${prazo.tipo}</td>
                    <td>${prazo.descricao}</td>
                    <td>${new Date(prazo.dataLimite).toLocaleDateString('pt-PT')}</td>
                    <td><span class="status-badge status-${prazo.prioridade}">${prazo.prioridade}</span></td>
                    <td><span class="status-badge status-${prazo.status}">${prazo.status === 'concluido' ? 'Concluído' : prazo.status === 'vencido' ? 'Vencido' : prazo.status === 'cancelado' ? 'Cancelado' : 'Ativo'}</span></td>
                    <td>
                        <button onclick="editarItem('prazo', ${prazo.id})" class="text-blue-600 hover:text-blue-800">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirItem('prazo', ${prazo.id})" class="text-red-600 hover:text-red-800 ml-2">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }


        // === FUNÇÕES DE ATUALIZAÇÃO DE LISTAS ===

        function atualizarListaHerancas(herancasFiltradas) {
            const tbody = document.getElementById('listaHerancas');
            if (!tbody) return;
            
            tbody.innerHTML = herancasFiltradas.map(heranca => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${heranca.clienteNome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${heranca.tipo}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${heranca.descricao}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="text-sm">€${(heranca.valor || 0).toFixed(2)}</div>
                        <div class="text-xs text-gray-400">+ IVA: €${(heranca.valorComIva || heranca.valor || 0).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge status-${heranca.status}">${heranca.status === 'concluido' ? 'Concluído' : heranca.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${heranca.dataInicio ? new Date(heranca.dataInicio).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editarHeranca(${heranca.id})" class="text-blue-600 hover:text-blue-900 mr-3" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="abrirAnexosHeranca(${heranca.id})" class="text-green-600 hover:text-green-900 mr-3" title="Documentos">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirHeranca(${heranca.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function atualizarListaMigracoes(migracoesFiltradas) {
            const tbody = document.getElementById('listaMigracoes');
            if (!tbody) return;
            
            tbody.innerHTML = migracoesFiltradas.map(migracao => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${migracao.clienteNome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.tipo}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${migracao.descricao}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="text-sm font-medium">€${(migracao.valor || 0).toFixed(2)}</div>
                        <div class="text-xs text-green-600 font-semibold">+ IVA: €${((migracao.valor || 0) + ((migracao.valor || 0) * (migracao.iva || 0) / 100)).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge status-${migracao.status}">${migracao.status === 'concluido' ? 'Concluído' : migracao.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.dataInicio ? new Date(migracao.dataInicio).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editarMigracaoSimples(${migracao.id})" class="text-blue-600 hover:text-blue-900 mr-3" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="abrirAnexosMigracao(${migracao.id})" class="text-green-600 hover:text-green-900 mr-3" title="Documentos">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirMigracao(${migracao.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function atualizarListaRegistos(registosFiltrados) {
            const tbody = document.getElementById('listaRegistos');
            if (!tbody) return;
            
            tbody.innerHTML = registosFiltrados.map(registo => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${registo.clienteNome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registo.tipo}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${registo.descricao}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="text-sm">€${(registo.valor || 0).toFixed(2)}</div>
                        <div class="text-xs text-gray-400">+ IVA: €${(registo.valorComIva || registo.valor || 0).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge status-${registo.status}">${registo.status === 'concluido' ? 'Concluído' : registo.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registo.dataInicio ? new Date(registo.dataInicio).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editarRegisto(${registo.id})" class="text-blue-600 hover:text-blue-900 mr-3" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="abrirAnexosRegisto(${registo.id})" class="text-green-600 hover:text-green-900 mr-3" title="Documentos">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirRegisto(${registo.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }


        // === FUNÇÕES DE MODAL E CRUD ===

        function abrirModalHeranca() {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Nova Herança</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form id="formHeranca" onsubmit="salvarHeranca(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Aceitação da herança">Aceitação da herança</option>
                                            <option value="Doações">Doações</option>
                                            <option value="Escrituras de partilha">Escrituras de partilha</option>
                                            <option value="Habilitação de herdeiros">Habilitação de herdeiros</option>
                                            <option value="Partilhas em vida">Partilhas em vida</option>
                                            <option value="Partilhas por óbito">Partilhas por óbito</option>
                                            <option value="Processo de inventário">Processo de inventário</option>
                                            <option value="Renúncia à herança">Renúncia à herança</option>
                                            <option value="Testamentos">Testamentos</option>
                                            <option value="Inventário">Inventário</option>
                                            <option value="Partilha">Partilha</option>
                                            <option value="Testamento">Testamento</option>
                                            <option value="Doação">Doação</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select name="iva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0">0% (Isento)</option>
                                                <option value="6">6% (Reduzida)</option>
                                                <option value="13">13% (Intermédia)</option>
                                                <option value="23" selected>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                            <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('heranca')">
                                                <option value="sem">Sem parceria</option>
                                                <option value="empresa">Empresa</option>
                                                <option value="pessoa">Pessoa</option>
                                            </select>
                                        </div>
                                        
                                        <div id="herancaParceriaNomeDiv" style="display: none;">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                            <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                            <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente">Pendente</option>
                                                <option value="em_andamento">Em Andamento</option>
                                                <option value="concluido">Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                            <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre a herança..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Herança
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        function criarModalMigracao() {
            return `
                <div class="modal show" onclick="fecharModal()">
                    <div class="modal-content p-6" style="max-width: 600px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Nova Migração</h3>
                            <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formMigracao" onsubmit="salvarMigracao(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                    <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Autorização de residência">Autorização de residência</option>
                                        <option value="Certificados de residência permanente">Certificados de residência permanente</option>
                                        <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                        <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                        <option value="Renovação de autorizações">Renovação de autorizações</option>
                                        <option value="Vistos D7">Vistos D7</option>
                                        <option value="Vistos Gold">Vistos Gold</option>
                                        <option value="Vistos para estudantes">Vistos para estudantes</option>
                                        <option value="Vistos para trabalho">Vistos para trabalho</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor (€) *</label>
                                        <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="0.00">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <input type="number" name="iva" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="23" value="23">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                                        <select name="status" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente">Pendente</option>
                                            <option value="em_andamento">Em Andamento</option>
                                            <option value="concluido">Concluído</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Início *</label>
                                    <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                    <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre a migração..."></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Migração
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function abrirModalMigracaoDireto() {
            console.log('🔧 abrirModalMigracaoDireto chamado');
            
            // Fechar qualquer modal aberto
            fecharModal();
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalNovaMigracao';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Nova Migração</h3>
                            <button onclick="document.getElementById('modalNovaMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form id="formMigracao" onsubmit="salvarMigracao(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                    <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Autorização de residência">Autorização de residência</option>
                                        <option value="Certificados de residência permanente">Certificados de residência permanente</option>
                                        <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                        <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                        <option value="Renovação de autorizações">Renovação de autorizações</option>
                                        <option value="Vistos D7">Vistos D7</option>
                                        <option value="Vistos Gold">Vistos Gold</option>
                                        <option value="Vistos para estudantes">Vistos para estudantes</option>
                                        <option value="Vistos para trabalho">Vistos para trabalho</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor (€) *</label>
                                        <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="0.00">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <input type="number" name="iva" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="23" value="23">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                                        <select name="status" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente">Pendente</option>
                                            <option value="em_andamento">Em Andamento</option>
                                            <option value="concluido">Concluído</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Início *</label>
                                    <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                    <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('migracao')">
                                        <option value="sem">Sem parceria</option>
                                        <option value="empresa">Empresa</option>
                                        <option value="pessoa">Pessoa</option>
                                    </select>
                                </div>
                                
                                <div id="migracaoParceriaNomeDiv" style="display: none;">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                    <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                    <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                    <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre a migração..."></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="document.getElementById('modalNovaMigracao').remove()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Migração
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('✅ Modal de migração criado e adicionado ao body');
        }
        
        // Tornar função global
        window.abrirModalMigracaoDireto = abrirModalMigracaoDireto;

        function abrirModalMigracao() {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Nova Migração</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form id="formMigracao" onsubmit="salvarMigracao(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autorização de residência">Autorização de residência</option>
                                            <option value="Certificados de residência permanente">Certificados de residência permanente</option>
                                            <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                            <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                            <option value="Renovação de autorizações">Renovação de autorizações</option>
                                            <option value="Vistos D7">Vistos D7</option>
                                            <option value="Vistos Gold">Vistos Gold</option>
                                            <option value="Vistos para estudantes">Vistos para estudantes</option>
                                            <option value="Vistos para trabalho">Vistos para trabalho</option>
                                            <option value="Nacionalidade">Nacionalidade</option>
                                            <option value="Residência">Residência</option>
                                            <option value="Visto">Visto</option>
                                            <option value="Reagrupamento">Reagrupamento</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select name="iva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0">0% (Isento)</option>
                                                <option value="6">6% (Reduzida)</option>
                                                <option value="13">13% (Intermédia)</option>
                                                <option value="23" selected>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                            <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('heranca')">
                                                <option value="sem">Sem parceria</option>
                                                <option value="empresa">Empresa</option>
                                                <option value="pessoa">Pessoa</option>
                                            </select>
                                        </div>
                                        
                                        <div id="herancaParceriaNomeDiv" style="display: none;">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                            <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                            <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente">Pendente</option>
                                                <option value="em_andamento">Em Andamento</option>
                                                <option value="concluido">Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                            <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre a migração..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Migração
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        function abrirModalRegisto() {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Novo Registo</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form id="formRegisto" onsubmit="salvarRegisto(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autenticação de documentos">Autenticação de documentos</option>
                                            <option value="Certificação de fotocópias">Certificação de fotocópias</option>
                                            <option value="Documentos para o estrangeiro">Documentos para o estrangeiro</option>
                                            <option value="Procurações">Procurações</option>
                                            <option value="Reconhecimento presencial de assinaturas">Reconhecimento presencial de assinaturas</option>
                                            <option value="Registos automóveis">Registos automóveis</option>
                                            <option value="Registos comerciais">Registos comerciais</option>
                                            <option value="Registos de propriedade">Registos de propriedade</option>
                                            <option value="Termos de autenticação">Termos de autenticação</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select name="iva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0">0% (Isento)</option>
                                                <option value="6">6% (Reduzida)</option>
                                                <option value="13">13% (Intermédia)</option>
                                                <option value="23" selected>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                            <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('heranca')">
                                                <option value="sem">Sem parceria</option>
                                                <option value="empresa">Empresa</option>
                                                <option value="pessoa">Pessoa</option>
                                            </select>
                                        </div>
                                        
                                        <div id="herancaParceriaNomeDiv" style="display: none;">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                            <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                            <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente">Pendente</option>
                                                <option value="em_andamento">Em Andamento</option>
                                                <option value="concluido">Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                            <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre o registo..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Registo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        // === FUNÇÕES DE SALVAMENTO ===

        function salvarHeranca(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const clienteId = parseInt(formData.get('clienteId'));
            const cliente = clientes.find(c => c.id === clienteId);
            
            const valor = parseFloat(formData.get('valor')) || 0;
            const iva = parseFloat(formData.get('iva')) || 0;
            const percentagem = parseFloat(formData.get('percentagem')) || 0;
            const valorComIva = valor + (valor * iva / 100);

            const novaHeranca = {
                id: herancas.length > 0 ? Math.max(...herancas.map(h => h.id)) + 1 : 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
                tipo: formData.get('tipo'),
                descricao: formData.get('descricao'),
                valor: valor,
                iva: iva,
                percentagem: percentagem,
                valorComIva: valorComIva,
                status: formData.get('status'),
                dataInicio: formData.get('dataInicio'),
                observacoes: formData.get('observacoes'),
                dataCriacao: new Date().toISOString()
            };

            herancas.unshift(novaHeranca);
            salvarDados('herancas', herancas);
            
            // Criar prazo automático para a herança
            const prazoHeranca = {
                id: Date.now() + 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
                descricao: `Prazo para ${novaHeranca.tipo} - ${novaHeranca.descricao}`,
                dataLimite: new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 60 dias
                status: 'ativo',
                tipo: 'heranca',
                referenciaId: novaHeranca.id,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoHeranca);
            salvarDados('prazos', prazos);
            
            mostrarNotificacao('Herança e prazo criados com sucesso!', 'success');
            fecharModal();
            carregarSecao('herancas');
        }

        function salvarMigracao(event) {
            try {
            event.preventDefault();
                console.log('🔧 salvarMigracao iniciado');
                console.log('🔧 FormData:', event.target);
                
            const formData = new FormData(event.target);
            const clienteId = parseInt(formData.get('clienteId'));
            const cliente = clientes.find(c => c.id === clienteId);
            
            const valor = parseFloat(formData.get('valor')) || 0;
            const iva = parseFloat(formData.get('iva')) || 0;
            const percentagem = parseFloat(formData.get('percentagem')) || 0;
            const valorComIva = valor + (valor * iva / 100);
                
                console.log('🔧 Valores calculados:');
                console.log('🔧 valor:', valor);
                console.log('🔧 iva:', iva);
                console.log('🔧 valorComIva:', valorComIva);

            const novaMigracao = {
                id: migracoes.length > 0 ? Math.max(...migracoes.map(m => m.id)) + 1 : 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
                tipo: formData.get('tipo'),
                    descricao: '', // Campo não existe no modal de Migração
                valor: valor,
                iva: iva,
                percentagem: percentagem,
                valorComIva: valorComIva,
                status: formData.get('status'),
                dataInicio: formData.get('dataInicio'),
                    parceria: formData.get('parceria'),
                    parceriaNome: formData.get('parceriaNome'),
                observacoes: formData.get('observacoes'),
                dataCriacao: new Date().toISOString()
            };

                console.log('🔧 Nova migração criada:', novaMigracao);
            migracoes.unshift(novaMigracao);
            salvarDados('migracoes', migracoes);
                console.log('🔧 Migração salva no localStorage');
            
            // Criar prazo automático para a migração
            const prazoMigracao = {
                id: Date.now() + 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
                    descricao: `Prazo para ${novaMigracao.tipo}`,
                dataLimite: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 90 dias
                status: 'ativo',
                tipo: 'migracao',
                referenciaId: novaMigracao.id,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoMigracao);
            salvarDados('prazos', prazos);
                console.log('🔧 Prazo criado e salvo');
            
            mostrarNotificacao('Processo de migração e prazo criados com sucesso!', 'success');
            fecharModal();
                
                console.log('🔧 Tentando carregar seção migracoes');
                setTimeout(() => {
                    carregarSecao('migracoes');
                }, 100);
                
            } catch (error) {
                console.error('❌ Erro ao salvar migração:', error);
                mostrarNotificacao('Erro ao salvar migração: ' + error.message, 'error');
            }
        }

        function salvarRegisto(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const clienteId = parseInt(formData.get('clienteId'));
            const cliente = clientes.find(c => c.id === clienteId);
            
            const valor = parseFloat(formData.get('valor')) || 0;
            const iva = parseFloat(formData.get('iva')) || 0;
            const percentagem = parseFloat(formData.get('percentagem')) || 0;
            const valorComIva = valor + (valor * iva / 100);

            const novoRegisto = {
                id: registos.length > 0 ? Math.max(...registos.map(r => r.id)) + 1 : 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
                tipo: formData.get('tipo'),
                descricao: formData.get('descricao'),
                valor: valor,
                iva: iva,
                percentagem: percentagem,
                valorComIva: valorComIva,
                status: formData.get('status'),
                dataInicio: formData.get('dataInicio'),
                observacoes: formData.get('observacoes'),
                dataCriacao: new Date().toISOString()
            };

            registos.unshift(novoRegisto);
            salvarDados('registos', registos);
            
            // Criar prazo automático para o registo
            const prazoRegisto = {
                id: Date.now() + 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
                descricao: `Prazo para ${novoRegisto.tipo} - ${novoRegisto.descricao}`,
                dataLimite: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 15 dias
                status: 'ativo',
                tipo: 'registo',
                referenciaId: novoRegisto.id,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoRegisto);
            salvarDados('prazos', prazos);
            
            mostrarNotificacao('Registo e prazo criados com sucesso!', 'success');
            fecharModal();
            carregarSecao('registos');
        }

        // === FUNÇÕES DE EDIÇÃO E EXCLUSÃO ===

        function editarHeranca(id) {
            const heranca = herancas.find(h => h.id === id);
            if (!heranca) return;

            abrirModalHeranca();
            // Preencher formulário com dados existentes
            setTimeout(() => {
                const form = document.getElementById('formHeranca');
                if (form) {
                    form.clienteId.value = heranca.clienteId;
                    form.tipo.value = heranca.tipo;
                    form.descricao.value = heranca.descricao || '';
                    form.valor.value = heranca.valor || '';
                    form.iva.value = heranca.iva || 23;
                    form.status.value = heranca.status;
                    form.dataInicio.value = heranca.dataInicio || '';
                    form.observacoes.value = heranca.observacoes || '';
                    
                    // Alterar título do modal
                    document.querySelector('#modalContainer h3').textContent = 'Editar Herança';
                    
                    // Adicionar campo hidden para ID
                    const hiddenId = document.createElement('input');
                    hiddenId.type = 'hidden';
                    hiddenId.name = 'id';
                    hiddenId.value = heranca.id;
                    form.appendChild(hiddenId);
                }
            }, 100);
        }

        function editarMigracao(id) {
            const migracao = migracoes.find(m => m.id === id);
            if (!migracao) return;

            abrirModalMigracao();
            setTimeout(() => {
                const form = document.getElementById('formMigracao');
                if (form) {
                    form.clienteId.value = migracao.clienteId;
                    form.tipo.value = migracao.tipo;
                    form.descricao.value = migracao.descricao || '';
                    form.valor.value = migracao.valor || '';
                    form.iva.value = migracao.iva || 23;
                    form.status.value = migracao.status;
                    form.dataInicio.value = migracao.dataInicio || '';
                    form.observacoes.value = migracao.observacoes || '';
                    
                    document.querySelector('#modalContainer h3').textContent = 'Editar Processo de Migração';
                    
                    const hiddenId = document.createElement('input');
                    hiddenId.type = 'hidden';
                    hiddenId.name = 'id';
                    hiddenId.value = migracao.id;
                    form.appendChild(hiddenId);
                }
            }, 100);
        }

        function editarRegisto(id) {
            const registo = registos.find(r => r.id === id);
            if (!registo) return;

            abrirModalRegisto();
            setTimeout(() => {
                const form = document.getElementById('formRegisto');
                if (form) {
                    form.clienteId.value = registo.clienteId;
                    form.tipo.value = registo.tipo;
                    form.descricao.value = registo.descricao || '';
                    form.valor.value = registo.valor || '';
                    form.iva.value = registo.iva || 23;
                    form.status.value = registo.status;
                    form.dataInicio.value = registo.dataInicio || '';
                    form.observacoes.value = registo.observacoes || '';
                    
                    document.querySelector('#modalContainer h3').textContent = 'Editar Registo';
                    
                    const hiddenId = document.createElement('input');
                    hiddenId.type = 'hidden';
                    hiddenId.name = 'id';
                    hiddenId.value = registo.id;
                    form.appendChild(hiddenId);
                }
            }, 100);
        }

        function excluirHeranca(id) {
            if (confirm('Tem certeza que deseja excluir esta herança?')) {
                herancas = herancas.filter(h => h.id !== id);
                salvarDados('herancas', herancas);
                mostrarNotificacao('Herança excluída com sucesso!', 'success');
                carregarSecao('herancas');
            }
        }

        function excluirMigracao(id) {
            if (confirm('Tem certeza que deseja excluir este processo de migração?')) {
                migracoes = migracoes.filter(m => m.id !== id);
                salvarDados('migracoes', migracoes);
                mostrarNotificacao('Processo de migração excluído com sucesso!', 'success');
                carregarSecao('migracao');
            }
        }

        function excluirRegisto(id) {
            if (confirm('Tem certeza que deseja excluir este registo?')) {
                registos = registos.filter(r => r.id !== id);
                salvarDados('registos', registos);
                mostrarNotificacao('Registo excluído com sucesso!', 'success');
                carregarSecao('registos');
            }
        }

        // === SISTEMA DE ANEXOS DE DOCUMENTOS ===
        
        function abrirAnexosCliente(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) return;
            
            // Inicializar array de anexos se não existir
            if (!cliente.anexos) {
                cliente.anexos = [];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos de ${cliente.nome}</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <!-- Upload de novos documentos -->
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexo(event, ${clienteId})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('cliente')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="identificacao">Identificação</option>
                                                <option value="contrato">Contrato</option>
                                                <option value="certificado">Certificado</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizadoCliente" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrição (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descrição do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModal()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Lista de documentos existentes -->
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${cliente.anexos.length})</h4>
                                ${cliente.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${cliente.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} • ${anexo.tamanho} • ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexo(${clienteId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }
        
        function adicionarAnexo(event, clienteId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            // Usar tipo personalizado se "outro" foi selecionado
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Simular upload (em um sistema real, enviaria para servidor)
            const anexo = {
                id: Date.now().toString(),
                nome: nome,
                tipo: tipo,
                descricao: descricao,
                nomeArquivo: arquivo.name,
                tamanho: formatarTamanho(arquivo.size),
                dataUpload: new Date().toISOString(),
                tipoArquivo: arquivo.type,
                dados: 'simulado' // Em um sistema real, seria o arquivo real
            };
            
            const cliente = clientes.find(c => c.id === clienteId);
            if (cliente) {
                if (!cliente.anexos) cliente.anexos = [];
                cliente.anexos.push(anexo);
                salvarDados('clientes', clientes);
                mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                abrirAnexosCliente(clienteId); // Recarregar modal
            }
        }
        
        function formatarTamanho(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Função para formatar valor com IVA incorporado
        function formatarValorComIva(valor, iva, valorComIva) {
            const valorNum = parseFloat(valor) || 0;
            const ivaNum = parseFloat(iva) || 0;
            const valorComIvaNum = parseFloat(valorComIva) || 0;
            
            // Calcular valor com IVA se não foi fornecido
            const valorComIvaCalculado = valorComIvaNum > 0 ? valorComIvaNum : valorNum + (valorNum * ivaNum / 100);
            
            const valorFormatado = (Math.round(valorNum * 100) / 100).toFixed(2);
            const valorComIvaFormatado = (Math.round(valorComIvaCalculado * 100) / 100).toFixed(2);
            
            return `
                <div class="flex flex-col">
                    <div class="text-sm font-medium text-gray-900">€${valorFormatado}</div>
                    <div class="text-xs text-gray-500">
                        <span class="text-gray-400">+ ${ivaNum}% IVA:</span>
                        <span class="font-medium text-gray-700">€${valorComIvaFormatado}</span>
                    </div>
                </div>
            `;
        }
        
        function visualizarAnexo(anexoId) {
            mostrarNotificacao('Funcionalidade de visualização será implementada', 'info');
        }
        
        function baixarAnexo(anexoId) {
            mostrarNotificacao('Funcionalidade de download será implementada', 'info');
        }
        
        function removerAnexo(clienteId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const cliente = clientes.find(c => c.id === clienteId);
                if (cliente && cliente.anexos) {
                    cliente.anexos = cliente.anexos.filter(a => a.id !== anexoId);
                    salvarDados('clientes', clientes);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosCliente(clienteId); // Recarregar modal
                }
            }
        }

        // === SISTEMA DE ANEXOS PARA ÁREAS DE EXECUÇÃO ===
        
        function abrirAnexosContrato(contratoId) {
            const contrato = contratos.find(c => c.id === contratoId);
            if (!contrato) return;
            
            if (!contrato.anexos) contrato.anexos = [];
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos do Contrato</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexoContrato(event, ${contratoId})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('contrato')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="contrato">Contrato</option>
                                                <option value="anexo">Anexo</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="certificado">Certificado</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizadoContrato" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrição (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descrição do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModal()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${contrato.anexos.length})</h4>
                                ${contrato.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${contrato.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} • ${anexo.tamanho} • ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexoContrato(${contratoId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }
        
        function adicionarAnexoContrato(event, contratoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            // Usar tipo personalizado se "outro" foi selecionado
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            const anexo = {
                id: Date.now().toString(),
                nome: nome,
                tipo: tipo,
                descricao: descricao,
                nomeArquivo: arquivo.name,
                tamanho: formatarTamanho(arquivo.size),
                dataUpload: new Date().toISOString(),
                tipoArquivo: arquivo.type,
                dados: 'simulado'
            };
            
            const contrato = contratos.find(c => c.id === contratoId);
            if (contrato) {
                if (!contrato.anexos) contrato.anexos = [];
                contrato.anexos.push(anexo);
                salvarDados('contratos', contratos);
                mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                abrirAnexosContrato(contratoId);
            }
        }
        
        function removerAnexoContrato(contratoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const contrato = contratos.find(c => c.id === contratoId);
                if (contrato && contrato.anexos) {
                    contrato.anexos = contrato.anexos.filter(a => a.id !== anexoId);
                    salvarDados('contratos', contratos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosContrato(contratoId);
                }
            }
        }

        // === FUNÇÃO PARA CONTROLAR VISIBILIDADE DO TIPO PERSONALIZADO ===
        
        function toggleTipoPersonalizado(area) {
            const select = document.getElementById('tipoDocumento');
            const divPersonalizado = document.getElementById(`tipoPersonalizado${area.charAt(0).toUpperCase() + area.slice(1)}`);
            const inputPersonalizado = document.getElementById('tipoPersonalizadoInput');
            
            if (select && divPersonalizado) {
                if (select.value === 'outro') {
                    divPersonalizado.classList.remove('hidden');
                    if (inputPersonalizado) {
                        inputPersonalizado.required = true;
                        inputPersonalizado.focus();
                    }
                } else {
                    divPersonalizado.classList.add('hidden');
                    if (inputPersonalizado) {
                        inputPersonalizado.required = false;
                        inputPersonalizado.value = '';
                    }
                }
            }
        }

        // === FUNÇÕES PARA PRAZOS ===
        
        function editarItem(tipo, id) {
            if (tipo === 'cliente') {
                const cliente = clientes.find(c => c.id === id);
                if (!cliente) return;
                
                // Abrir modal de cliente e preencher com dados
                abrirModal('cliente');
                setTimeout(() => {
                    document.getElementById('clienteNome').value = cliente.nome || '';
                    document.getElementById('clienteEmail').value = cliente.email || '';
                    document.getElementById('clienteTelefone').value = cliente.telefone || '';
                    document.getElementById('clienteNIF').value = cliente.nif || '';
                    document.getElementById('clienteMorada').value = cliente.morada || '';
                    document.getElementById('clienteNotas').value = cliente.notas || '';
                    
                    // Alterar o título do modal e o botão
                    const modalTitle = document.querySelector('#modalContainer h3');
                    if (modalTitle) modalTitle.textContent = 'Editar Cliente';
                    
                    // Alterar o formulário para modo edição
                    const form = document.getElementById('formCliente');
                    if (form) {
                        form.onsubmit = (e) => {
                            e.preventDefault();
                            atualizarCliente(id);
                        };
                        
                        // Alterar texto do botão
                        const submitBtn = form.querySelector('button[type="submit"]');
                        if (submitBtn) submitBtn.textContent = 'Atualizar Cliente';
                    }
                }, 100);
            }
            else if (tipo === 'prazo') {
                const prazo = prazos.find(p => p.id === id);
                if (!prazo) return;
                
                // Criar modal de edição de prazo
                const modal = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-xl font-bold text-gray-900">Editar Prazo</h3>
                                    <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                        <i data-lucide="x" class="w-6 h-6"></i>
                                    </button>
                                </div>
                                
                                <form onsubmit="atualizarPrazo(event, ${id})">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                                            <input type="text" id="prazoCliente" value="${prazo.clienteNome}" readonly class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                            <input type="text" id="prazoTipo" value="${prazo.tipo}" readonly class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Descrição *</label>
                                            <textarea id="prazoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${prazo.descricao}</textarea>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Limite *</label>
                                                <input type="date" id="prazoDataLimite" value="${prazo.dataLimite}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                                <select id="prazoPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                    <option value="baixa" ${prazo.prioridade === 'baixa' ? 'selected' : ''}>Baixa</option>
                                                    <option value="media" ${prazo.prioridade === 'media' ? 'selected' : ''}>Média</option>
                                                    <option value="alta" ${prazo.prioridade === 'alta' ? 'selected' : ''}>Alta</option>
                                                    <option value="critica" ${prazo.prioridade === 'critica' ? 'selected' : ''}>Crítica</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="prazoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="ativo" ${prazo.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                                <option value="concluido" ${prazo.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                                <option value="vencido" ${prazo.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                                                <option value="cancelado" ${prazo.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-end space-x-3 mt-6">
                                        <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                            Cancelar
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            Salvar Alterações
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('modalContainer').innerHTML = modal;
                lucide.createIcons();
            }
        }
        
        function atualizarCliente(id) {
            const clienteIndex = clientes.findIndex(c => c.id === id);
            if (clienteIndex !== -1) {
                clientes[clienteIndex] = {
                    ...clientes[clienteIndex],
                    nome: document.getElementById('clienteNome').value,
                    email: document.getElementById('clienteEmail').value,
                    telefone: document.getElementById('clienteTelefone').value,
                    nif: document.getElementById('clienteNIF').value,
                    morada: document.getElementById('clienteMorada').value,
                    notas: document.getElementById('clienteNotas').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('clientes', clientes);
                mostrarNotificacao('Cliente atualizado com sucesso!', 'success');
                fecharModal();
                carregarSecao('clientes');
            }
        }
        
        function atualizarPrazo(event, id) {
            event.preventDefault();
            
            const prazoIndex = prazos.findIndex(p => p.id === id);
            if (prazoIndex !== -1) {
                prazos[prazoIndex] = {
                    ...prazos[prazoIndex],
                    descricao: document.getElementById('prazoDescricao').value,
                    dataLimite: document.getElementById('prazoDataLimite').value,
                    prioridade: document.getElementById('prazoPrioridade').value,
                    status: document.getElementById('prazoStatus').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('prazos', prazos);
                mostrarNotificacao('Prazo atualizado com sucesso!', 'success');
                fecharModal();
                carregarSecao('prazos');
            }
        }
        
        function excluirItem(tipo, id) {
            if (tipo === 'prazo') {
                if (confirm('Tem certeza que deseja excluir este prazo?')) {
                    prazos = prazos.filter(p => p.id !== id);
                    salvarDados('prazos', prazos);
                    mostrarNotificacao('Prazo excluído com sucesso!', 'success');
                    carregarSecao('prazos');
                }
            }
        }

        // === FUNÇÕES DE MODAL DE EDIÇÃO ===
        
        function abrirModalEdicaoCliente(cliente) {
            console.log('abrirModalEdicaoCliente chamado com:', cliente);
            
            const modalContainer = document.getElementById('modalContainer');
            if (!modalContainer) {
                console.error('modalContainer não encontrado!');
                return;
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Cliente</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarCliente(event, ${cliente.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                                        <input type="text" id="editarClienteNome" value="${cliente.nome}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                        <input type="email" id="editarClienteEmail" value="${cliente.email}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                                        <input type="tel" id="editarClienteTelefone" value="${cliente.telefone}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">NIF *</label>
                                        <input type="text" id="editarClienteNIF" value="${cliente.nif || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="123456789">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Endereço</label>
                                        <textarea id="editarClienteEndereco" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${cliente.endereco || ''}</textarea>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="editarClienteStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="ativo" ${cliente.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                            <option value="inativo" ${cliente.status === 'inativo' ? 'selected' : ''}>Inativo</option>
                                            <option value="suspenso" ${cliente.status === 'suspenso' ? 'selected' : ''}>Suspenso</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            console.log('Inserindo modal de cliente no container...');
            modalContainer.innerHTML = modal;
            console.log('Modal inserido, criando ícones...');
            lucide.createIcons();
            console.log('Modal de edição de cliente aberto com sucesso!');
        }
        
        function abrirModalEdicaoContrato(contrato) {
            console.log('abrirModalEdicaoContrato chamado com:', contrato);
            
            // Verificar se o modalContainer existe
            const modalContainer = document.getElementById('modalContainer');
            if (!modalContainer) {
                console.error('modalContainer não encontrado!');
                mostrarNotificacao('Erro: Container do modal não encontrado!', 'error');
                return;
            }
            
            // Limpar qualquer conteúdo anterior
            modalContainer.innerHTML = '';
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Contrato</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarContrato(event, ${contrato.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="contratoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === contrato.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="contratoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Compra e Venda" ${contrato.tipo === 'Compra e Venda' ? 'selected' : ''}>Compra e Venda</option>
                                            <option value="Arrendamento" ${contrato.tipo === 'Arrendamento' ? 'selected' : ''}>Arrendamento</option>
                                            <option value="Prestação de Serviços" ${contrato.tipo === 'Prestação de Serviços' ? 'selected' : ''}>Prestação de Serviços</option>
                                            <option value="Empréstimo" ${contrato.tipo === 'Empréstimo' ? 'selected' : ''}>Empréstimo</option>
                                            <option value="Outro" ${contrato.tipo === 'Outro' ? 'selected' : ''}>Outro</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="contratoValor" value="${contrato.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="contratoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${contrato.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${contrato.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${contrato.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                                <option value="23" ${contrato.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="contratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${contrato.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${contrato.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${contrato.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                            <input type="date" id="contratoDataInicio" value="${contrato.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Fim</label>
                                            <input type="date" id="contratoDataFim" value="${contrato.dataFim || ''}" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea id="contratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${contrato.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                console.log('Inserindo modal no container...');
                modalContainer.innerHTML = modal;
                console.log('Modal inserido, criando ícones...');
                lucide.createIcons();
                console.log('Modal de edição de contrato aberto com sucesso!');
                
                // Verificar se o modal foi inserido corretamente
                const modalElement = modalContainer.querySelector('.fixed.inset-0');
                if (modalElement) {
                    console.log('✅ Modal inserido e visível');
                    console.log('Modal element:', modalElement);
                    console.log('Modal styles:', window.getComputedStyle(modalElement));
                    
                    // Forçar visibilidade
                    modalElement.style.display = 'flex';
                    modalElement.style.visibility = 'visible';
                    modalElement.style.opacity = '1';
                    modalElement.style.zIndex = '9999';
                    
                    console.log('Modal forçado a ser visível');
                } else {
                    console.error('❌ Modal não foi inserido corretamente');
                    mostrarNotificacao('Erro ao abrir modal de edição!', 'error');
                }
            } catch (error) {
                console.error('Erro ao inserir modal:', error);
                mostrarNotificacao('Erro ao abrir modal de edição!', 'error');
            }
        }
        
        function abrirModalEdicaoHonorario(honorario) {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Honorário</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarHonorario(event, ${honorario.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <input type="text" id="honorarioCliente" value="${honorario.cliente}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Serviço *</label>
                                        <input type="text" id="honorarioServico" value="${honorario.servico}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="honorarioValor" value="${honorario.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="honorarioStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${honorario.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="pago" ${honorario.status === 'pago' ? 'selected' : ''}>Pago</option>
                                                <option value="vencido" ${honorario.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento *</label>
                                        <input type="date" id="honorarioVencimento" value="${honorario.vencimento}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        function abrirModalEdicaoHeranca(heranca) {
            console.log('🔧 abrirModalEdicaoHeranca chamado com:', heranca);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoHeranca';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = fecharModal;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Herança</h3>
                            <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form onsubmit="atualizarHeranca(event, ${heranca.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="herancaClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === heranca.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                    <select id="herancaTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Aceitação da herança" ${heranca.tipo === 'Aceitação da herança' ? 'selected' : ''}>Aceitação da herança</option>
                                        <option value="Doações" ${heranca.tipo === 'Doações' ? 'selected' : ''}>Doações</option>
                                        <option value="Escrituras de partilha" ${heranca.tipo === 'Escrituras de partilha' ? 'selected' : ''}>Escrituras de partilha</option>
                                        <option value="Habilitação de herdeiros" ${heranca.tipo === 'Habilitação de herdeiros' ? 'selected' : ''}>Habilitação de herdeiros</option>
                                        <option value="Partilhas em vida" ${heranca.tipo === 'Partilhas em vida' ? 'selected' : ''}>Partilhas em vida</option>
                                        <option value="Partilhas por óbito" ${heranca.tipo === 'Partilhas por óbito' ? 'selected' : ''}>Partilhas por óbito</option>
                                        <option value="Processo de inventário" ${heranca.tipo === 'Processo de inventário' ? 'selected' : ''}>Processo de inventário</option>
                                        <option value="Renúncia à herança" ${heranca.tipo === 'Renúncia à herança' ? 'selected' : ''}>Renúncia à herança</option>
                                        <option value="Testamentos" ${heranca.tipo === 'Testamentos' ? 'selected' : ''}>Testamentos</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="herancaValor" value="${heranca.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="herancaIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0" ${heranca.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                            <option value="6" ${heranca.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                            <option value="13" ${heranca.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                            <option value="23" ${heranca.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="herancaStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente" ${heranca.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                            <option value="em_andamento" ${heranca.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                            <option value="concluido" ${heranca.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                    <input type="date" id="herancaDataInicio" value="${heranca.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                    <textarea id="herancaObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${heranca.observacoes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Alterações
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            const modalAnterior = document.getElementById('modalEdicaoHeranca');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            // Adicionar ao body
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('✅ Modal de edição de herança criado e adicionado ao body!');
        }

        function abrirModalEdicaoMigracao(migracao) {
            console.log('🔧 abrirModalEdicaoMigracao chamado com:', migracao);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoMigracao';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = fecharModal;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Migração</h3>
                            <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form onsubmit="atualizarMigracao(event, ${migracao.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="migracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                    <select id="migracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Autorização de residência" ${migracao.tipo === 'Autorização de residência' ? 'selected' : ''}>Autorização de residência</option>
                                        <option value="Certificados de residência permanente" ${migracao.tipo === 'Certificados de residência permanente' ? 'selected' : ''}>Certificados de residência permanente</option>
                                        <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                        <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                        <option value="Renovação de autorizações" ${migracao.tipo === 'Renovação de autorizações' ? 'selected' : ''}>Renovação de autorizações</option>
                                        <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                        <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                        <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                        <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="migracaoValor" value="${migracao.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="migracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                            <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                            <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                            <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="migracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                            <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                            <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                    <input type="date" id="migracaoDataInicio" value="${migracao.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                    <textarea id="migracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Alterações
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            const modalAnterior = document.getElementById('modalEdicaoMigracao');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            // Adicionar ao body
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('✅ Modal de edição de migração criado e adicionado ao body!');
        }

        function abrirModalEdicaoRegisto(registo) {
            console.log('🔧 abrirModalEdicaoRegisto chamado com:', registo);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoRegisto';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = fecharModal;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Registo</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarRegisto(event, ${registo.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="registoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === registo.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="registoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autenticação de documentos" ${registo.tipo === 'Autenticação de documentos' ? 'selected' : ''}>Autenticação de documentos</option>
                                            <option value="Certificação de fotocópias" ${registo.tipo === 'Certificação de fotocópias' ? 'selected' : ''}>Certificação de fotocópias</option>
                                            <option value="Documentos para o estrangeiro" ${registo.tipo === 'Documentos para o estrangeiro' ? 'selected' : ''}>Documentos para o estrangeiro</option>
                                            <option value="Procurações" ${registo.tipo === 'Procurações' ? 'selected' : ''}>Procurações</option>
                                            <option value="Reconhecimento presencial de assinaturas" ${registo.tipo === 'Reconhecimento presencial de assinaturas' ? 'selected' : ''}>Reconhecimento presencial de assinaturas</option>
                                            <option value="Registos automóveis" ${registo.tipo === 'Registos automóveis' ? 'selected' : ''}>Registos automóveis</option>
                                            <option value="Registos comerciais" ${registo.tipo === 'Registos comerciais' ? 'selected' : ''}>Registos comerciais</option>
                                            <option value="Registos de propriedade" ${registo.tipo === 'Registos de propriedade' ? 'selected' : ''}>Registos de propriedade</option>
                                            <option value="Termos de autenticação" ${registo.tipo === 'Termos de autenticação' ? 'selected' : ''}>Termos de autenticação</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="registoValor" value="${registo.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="registoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${registo.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${registo.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${registo.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                                <option value="23" ${registo.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="registoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${registo.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${registo.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${registo.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                        <input type="date" id="registoDataInicio" value="${registo.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea id="registoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${registo.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            const modalAnterior = document.getElementById('modalEdicaoRegisto');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            // Adicionar ao body
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('✅ Modal de edição de registo criado e adicionado ao body!');
        }

        function abrirModalEdicaoPrazo(prazo) {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Prazo</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarPrazo(event, ${prazo.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                                        <input type="text" id="prazoCliente" value="${prazo.clienteNome}" readonly class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                        <input type="text" id="prazoTipo" value="${prazo.tipo}" readonly class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrição *</label>
                                        <textarea id="prazoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${prazo.descricao}</textarea>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Limite *</label>
                                            <input type="date" id="prazoDataLimite" value="${prazo.dataLimite}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                            <select id="prazoPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="baixa" ${prazo.prioridade === 'baixa' ? 'selected' : ''}>Baixa</option>
                                                <option value="media" ${prazo.prioridade === 'media' ? 'selected' : ''}>Média</option>
                                                <option value="alta" ${prazo.prioridade === 'alta' ? 'selected' : ''}>Alta</option>
                                                <option value="critica" ${prazo.prioridade === 'critica' ? 'selected' : ''}>Crítica</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="prazoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="ativo" ${prazo.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                            <option value="concluido" ${prazo.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                            <option value="vencido" ${prazo.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                                            <option value="cancelado" ${prazo.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        // === FUNÇÕES DE ATUALIZAÇÃO ===
        
        function atualizarContrato(event, id) {
            event.preventDefault();
            
            const contratoIndex = contratos.findIndex(c => c.id === id);
            if (contratoIndex !== -1) {
                const clienteId = document.getElementById('contratoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                contratos[contratoIndex] = {
                    ...contratos[contratoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : contratos[contratoIndex].clienteNome,
                    tipo: document.getElementById('contratoTipo').value,
                    valor: document.getElementById('contratoValor').value,
                    iva: document.getElementById('contratoIva').value,
                    status: document.getElementById('contratoStatus').value,
                    dataInicio: document.getElementById('contratoDataInicio').value,
                    dataFim: document.getElementById('contratoDataFim').value,
                    observacoes: document.getElementById('contratoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('contratos', contratos);
                mostrarNotificacao('Contrato atualizado com sucesso!', 'success');
                fecharModal();
                carregarSecao('contratos');
            }
        }
        
        function atualizarHonorario(event, id) {
            event.preventDefault();
            
            const honorarioIndex = honorarios.findIndex(h => h.id === id);
            if (honorarioIndex !== -1) {
                honorarios[honorarioIndex] = {
                    ...honorarios[honorarioIndex],
                    cliente: document.getElementById('honorarioCliente').value,
                    servico: document.getElementById('honorarioServico').value,
                    valor: document.getElementById('honorarioValor').value,
                    status: document.getElementById('honorarioStatus').value,
                    vencimento: document.getElementById('honorarioVencimento').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('honorarios', honorarios);
                mostrarNotificacao('Honorário atualizado com sucesso!', 'success');
                fecharModal();
                carregarSecao('honorarios');
            }
        }

        function atualizarHeranca(event, id) {
            console.log('🔧 atualizarHeranca chamado com ID:', id);
            event.preventDefault();
            
            // Buscar heranças do localStorage
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) {
                herancas = JSON.parse(herancasSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const herancaIndex = herancas.findIndex(h => h.id === id);
            if (herancaIndex !== -1) {
                const clienteId = document.getElementById('herancaClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                herancas[herancaIndex] = {
                    ...herancas[herancaIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : herancas[herancaIndex].clienteNome,
                    tipo: document.getElementById('herancaTipo').value,
                    valor: document.getElementById('herancaValor').value,
                    iva: document.getElementById('herancaIva').value,
                    status: document.getElementById('herancaStatus').value,
                    dataInicio: document.getElementById('herancaDataInicio').value,
                    observacoes: document.getElementById('herancaObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('herancas', herancas);
                mostrarNotificacao('Herança atualizada com sucesso!', 'success');
                
                // Fechar modal explicitamente
                console.log('🔧 Fechando modal de herança...');
                fecharModal();
                
                // Aguardar um pouco antes de recarregar
                setTimeout(() => {
                    carregarSecao('herancas');
                }, 100);
                
                console.log('✅ Herança atualizada com sucesso!');
            } else {
                console.error('❌ Herança não encontrada com ID:', id);
                mostrarNotificacao('Erro: Herança não encontrada!', 'error');
            }
        }
        
        // Tornar função global
        window.atualizarHeranca = atualizarHeranca;

        function atualizarMigracao(event, id) {
            console.log('🔧 atualizarMigracao chamado com ID:', id);
            event.preventDefault();
            
            // Buscar migrações do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const migracaoIndex = migracoes.findIndex(m => m.id === id);
            if (migracaoIndex !== -1) {
                const clienteId = document.getElementById('migracaoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                migracoes[migracaoIndex] = {
                    ...migracoes[migracaoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : migracoes[migracaoIndex].clienteNome,
                    tipo: document.getElementById('migracaoTipo').value,
                    valor: document.getElementById('migracaoValor').value,
                    iva: document.getElementById('migracaoIva').value,
                    status: document.getElementById('migracaoStatus').value,
                    dataInicio: document.getElementById('migracaoDataInicio').value,
                    observacoes: document.getElementById('migracaoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('migracoes', migracoes);
                mostrarNotificacao('Migração atualizada com sucesso!', 'success');
                
                // Fechar modal explicitamente
                console.log('🔧 Fechando modal de migração...');
                fecharModal();
                
                // Aguardar um pouco antes de recarregar
                setTimeout(() => {
                    carregarSecao('migracoes');
                }, 100);
                
                console.log('✅ Migração atualizada com sucesso!');
            } else {
                console.error('❌ Migração não encontrada com ID:', id);
                mostrarNotificacao('Erro: Migração não encontrada!', 'error');
            }
        }
        
        // Tornar função global
        window.atualizarMigracao = atualizarMigracao;

        function atualizarRegisto(event, id) {
            console.log('🔧 atualizarRegisto chamado com ID:', id);
            event.preventDefault();
            
            // Buscar registos do localStorage
            const registosSalvos = localStorage.getItem('registos');
            let registos = [];
            if (registosSalvos) {
                registos = JSON.parse(registosSalvos);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const registoIndex = registos.findIndex(r => r.id === id);
            if (registoIndex !== -1) {
                const clienteId = document.getElementById('registoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                registos[registoIndex] = {
                    ...registos[registoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : registos[registoIndex].clienteNome,
                    tipo: document.getElementById('registoTipo').value,
                    valor: document.getElementById('registoValor').value,
                    iva: document.getElementById('registoIva').value,
                    status: document.getElementById('registoStatus').value,
                    dataInicio: document.getElementById('registoDataInicio').value,
                    observacoes: document.getElementById('registoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('registos', registos);
                mostrarNotificacao('Registo atualizado com sucesso!', 'success');
                
                // Fechar modal explicitamente
                console.log('🔧 Fechando modal de registo...');
                fecharModal();
                
                // Aguardar um pouco antes de recarregar
                setTimeout(() => {
                    carregarSecao('registos');
                }, 100);
                
                console.log('✅ Registo atualizado com sucesso!');
            } else {
                console.error('❌ Registo não encontrado com ID:', id);
                mostrarNotificacao('Erro: Registo não encontrado!', 'error');
            }
        }
        
        // Tornar função global
        window.atualizarRegisto = atualizarRegisto;
        
        // === FUNÇÃO SIMPLES PARA SALVAR HERANÇA EDITADA ===
        function salvarHerancaEditada(event, id) {
            event.preventDefault();
            
            // Buscar heranças do localStorage
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) {
                herancas = JSON.parse(herancasSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Encontrar a herança
            const herancaIndex = herancas.findIndex(h => h.id === id);
            if (herancaIndex !== -1) {
                const clienteId = document.getElementById('editClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                // Atualizar os dados
                herancas[herancaIndex] = {
                    ...herancas[herancaIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : herancas[herancaIndex].clienteNome,
                    tipo: document.getElementById('editTipo').value,
                    valor: document.getElementById('editValor').value,
                    iva: document.getElementById('editIva').value,
                    status: document.getElementById('editStatus').value,
                    dataInicio: document.getElementById('editDataInicio').value,
                    observacoes: document.getElementById('editObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('herancas', JSON.stringify(herancas));
                mostrarNotificacao('Herança atualizada com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoHeranca');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar seção
                carregarSecao('herancas');
            }
        }
        
        // Tornar função global
        window.salvarHerancaEditada = salvarHerancaEditada;
        
        // === FUNÇÃO PARA SALVAR MIGRAÇÃO EDITADA ===
        function salvarMigracaoEditada(event, id) {
            event.preventDefault();
            
            // Buscar migrações do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Encontrar a migração
            const migracaoIndex = migracoes.findIndex(m => m.id === id);
            if (migracaoIndex !== -1) {
                const clienteId = document.getElementById('editMigracaoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                // Atualizar os dados
                migracoes[migracaoIndex] = {
                    ...migracoes[migracaoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : migracoes[migracaoIndex].clienteNome,
                    tipo: document.getElementById('editMigracaoTipo').value,
                    valor: document.getElementById('editMigracaoValor').value,
                    iva: document.getElementById('editMigracaoIva').value,
                    status: document.getElementById('editMigracaoStatus').value,
                    dataInicio: document.getElementById('editMigracaoDataInicio').value,
                    observacoes: document.getElementById('editMigracaoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('migracoes', JSON.stringify(migracoes));
                mostrarNotificacao('Migração atualizada com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoMigracao');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar seção após um pequeno delay
                setTimeout(() => {
                    carregarSecao('migracoes');
                }, 100);
            }
        }
        
        // Tornar função global
        window.salvarMigracaoEditada = salvarMigracaoEditada;
        
        // === FUNÇÃO PARA SALVAR REGISTO EDITADO ===
        function salvarRegistoEditado(event, id) {
            event.preventDefault();
            
            // Buscar registos do localStorage
            const registosSalvos = localStorage.getItem('registos');
            let registos = [];
            if (registosSalvos) {
                registos = JSON.parse(registosSalvos);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Encontrar o registo
            const registoIndex = registos.findIndex(r => r.id === id);
            if (registoIndex !== -1) {
                const clienteId = document.getElementById('editRegistoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                // Atualizar os dados
                registos[registoIndex] = {
                    ...registos[registoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : registos[registoIndex].clienteNome,
                    tipo: document.getElementById('editRegistoTipo').value,
                    valor: document.getElementById('editRegistoValor').value,
                    iva: document.getElementById('editRegistoIva').value,
                    status: document.getElementById('editRegistoStatus').value,
                    dataInicio: document.getElementById('editRegistoDataInicio').value,
                    observacoes: document.getElementById('editRegistoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('registos', JSON.stringify(registos));
                mostrarNotificacao('Registo atualizado com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoRegisto');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar seção após um pequeno delay
                setTimeout(() => {
                    carregarSecao('registos');
                }, 100);
            }
        }
        
        // Tornar função global
        window.salvarRegistoEditado = salvarRegistoEditado;

        // === FUNÇÃO PARA CONTROLAR MENU MOBILE ===
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }
        
        // Fechar sidebar ao clicar fora (mobile)
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            
            if (window.innerWidth <= 1024) {
                if (!sidebar.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                    sidebar.classList.remove('open');
                }
            }
        });
        
        // Fechar sidebar ao redimensionar para desktop
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth > 1024) {
                sidebar.classList.remove('open');
            }
        });

        // === FUNÇÃO PARA CONTROLAR VISIBILIDADE DO NOME DA PARCERIA ===
        
        function toggleParceriaNome(tipo) {
            const parceriaSelect = document.getElementById(`${tipo}Parceria`) || document.querySelector(`select[name="parceria"]`);
            const nomeDiv = document.getElementById(`${tipo}ParceriaNomeDiv`) || document.getElementById(`${tipo}ParceriaNomeDiv`);
            
            if (parceriaSelect && nomeDiv) {
                if (parceriaSelect.value === 'empresa' || parceriaSelect.value === 'pessoa') {
                    nomeDiv.style.display = 'block';
                } else {
                    nomeDiv.style.display = 'none';
                }
            }
        }

        // === FUNÇÕES ESPECÍFICAS DE EDIÇÃO E EXCLUSÃO PARA ÁREAS DE ATUAÇÃO ===
        
        function editarHeranca(id) {
            // Buscar herança diretamente do localStorage
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) {
                herancas = JSON.parse(herancasSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const heranca = herancas.find(h => h.id === id);
            if (heranca) {
                // Fechar qualquer modal aberto
                fecharModal();
                
                // Criar modal com layout original
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoHeranca';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Herança</h3>
                                <button onclick="document.getElementById('modalEdicaoHeranca').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarHerancaEditada(event, ${id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === heranca.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Aceitação da herança" ${heranca.tipo === 'Aceitação da herança' ? 'selected' : ''}>Aceitação da herança</option>
                                            <option value="Doações" ${heranca.tipo === 'Doações' ? 'selected' : ''}>Doações</option>
                                            <option value="Escrituras de partilha" ${heranca.tipo === 'Escrituras de partilha' ? 'selected' : ''}>Escrituras de partilha</option>
                                            <option value="Habilitação de herdeiros" ${heranca.tipo === 'Habilitação de herdeiros' ? 'selected' : ''}>Habilitação de herdeiros</option>
                                            <option value="Partilhas em vida" ${heranca.tipo === 'Partilhas em vida' ? 'selected' : ''}>Partilhas em vida</option>
                                            <option value="Partilhas por óbito" ${heranca.tipo === 'Partilhas por óbito' ? 'selected' : ''}>Partilhas por óbito</option>
                                            <option value="Processo de inventário" ${heranca.tipo === 'Processo de inventário' ? 'selected' : ''}>Processo de inventário</option>
                                            <option value="Renúncia à herança" ${heranca.tipo === 'Renúncia à herança' ? 'selected' : ''}>Renúncia à herança</option>
                                            <option value="Testamentos" ${heranca.tipo === 'Testamentos' ? 'selected' : ''}>Testamentos</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editValor" value="${heranca.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${heranca.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${heranca.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${heranca.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                                <option value="23" ${heranca.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${heranca.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${heranca.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${heranca.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                        <input type="date" id="editDataInicio" value="${heranca.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea id="editObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${heranca.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoHeranca').remove()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
            }
        }

        function excluirHeranca(id) {
            excluirItem('heranca', id);
        }

        function editarMigracao(id) {
            // Buscar migração diretamente do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const migracao = migracoes.find(m => m.id === id);
            if (migracao) {
                // Fechar qualquer modal aberto
                fecharModal();
                
                // Criar modal com layout original
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoMigracao';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Migração</h3>
                                <button onclick="document.getElementById('modalEdicaoMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarMigracaoEditada(event, ${id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editMigracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editMigracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autorização de residência" ${migracao.tipo === 'Autorização de residência' ? 'selected' : ''}>Autorização de residência</option>
                                            <option value="Certificados de residência permanente" ${migracao.tipo === 'Certificados de residência permanente' ? 'selected' : ''}>Certificados de residência permanente</option>
                                            <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                            <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                            <option value="Renovação de autorizações" ${migracao.tipo === 'Renovação de autorizações' ? 'selected' : ''}>Renovação de autorizações</option>
                                            <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                            <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                            <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                            <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editMigracaoValor" value="${migracao.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editMigracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                                <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editMigracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                        <input type="date" id="editMigracaoDataInicio" value="${migracao.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea id="editMigracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoMigracao').remove()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
            }
        }

        function excluirMigracao(id) {
            excluirItem('migracao', id);
        }

        function editarRegisto(id) {
            // Buscar registo diretamente do localStorage
            const registosSalvos = localStorage.getItem('registos');
            let registos = [];
            if (registosSalvos) {
                registos = JSON.parse(registosSalvos);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const registo = registos.find(r => r.id === id);
            if (registo) {
                // Fechar qualquer modal aberto
                fecharModal();
                
                // Criar modal com layout original
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoRegisto';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Registo</h3>
                                <button onclick="document.getElementById('modalEdicaoRegisto').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarRegistoEditado(event, ${id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editRegistoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === registo.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editRegistoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autenticação de documentos" ${registo.tipo === 'Autenticação de documentos' ? 'selected' : ''}>Autenticação de documentos</option>
                                            <option value="Certificação de fotocópias" ${registo.tipo === 'Certificação de fotocópias' ? 'selected' : ''}>Certificação de fotocópias</option>
                                            <option value="Documentos para o estrangeiro" ${registo.tipo === 'Documentos para o estrangeiro' ? 'selected' : ''}>Documentos para o estrangeiro</option>
                                            <option value="Procurações" ${registo.tipo === 'Procurações' ? 'selected' : ''}>Procurações</option>
                                            <option value="Reconhecimento presencial de assinaturas" ${registo.tipo === 'Reconhecimento presencial de assinaturas' ? 'selected' : ''}>Reconhecimento presencial de assinaturas</option>
                                            <option value="Registos automóveis" ${registo.tipo === 'Registos automóveis' ? 'selected' : ''}>Registos automóveis</option>
                                            <option value="Registos comerciais" ${registo.tipo === 'Registos comerciais' ? 'selected' : ''}>Registos comerciais</option>
                                            <option value="Registos de propriedade" ${registo.tipo === 'Registos de propriedade' ? 'selected' : ''}>Registos de propriedade</option>
                                            <option value="Termos de autenticação" ${registo.tipo === 'Termos de autenticação' ? 'selected' : ''}>Termos de autenticação</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editRegistoValor" value="${registo.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editRegistoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${registo.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${registo.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${registo.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                                <option value="23" ${registo.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editRegistoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${registo.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${registo.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${registo.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                        <input type="date" id="editRegistoDataInicio" value="${registo.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea id="editRegistoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${registo.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoRegisto').remove()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
            }
        }

        function excluirRegisto(id) {
            excluirItem('registo', id);
        }
        
        // === FUNÇÕES DE FILTRO PARA MIGRAÇÕES ===
        function filtrarMigracoes() {
            aplicarFiltrosMigracoes();
        }

        function aplicarFiltrosMigracoes() {
            const busca = document.getElementById('buscaMigracoes')?.value.toLowerCase() || '';
            const statusFiltro = document.getElementById('filtroStatusMigracao')?.value || '';
            const tipoFiltro = document.getElementById('filtroTipoMigracao')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinMigracao')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxMigracao')?.value) || Infinity;

            const migracoesFiltradas = migracoes.filter(migracao => {
                const matchBusca = !busca || 
                    (migracao.clienteNome?.toLowerCase().includes(busca)) ||
                    (migracao.tipo?.toLowerCase().includes(busca));
                
                const matchStatus = !statusFiltro || migracao.status === statusFiltro;
                const matchTipo = !tipoFiltro || migracao.tipo === tipoFiltro;
                const valor = parseFloat(migracao.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;

                return matchBusca && matchStatus && matchTipo && matchValor;
            });

            // Atualizar tabela
            const tbody = document.getElementById('listaMigracoes');
            if (tbody) {
                tbody.innerHTML = migracoesFiltradas.map(migracao => `
                    <tr>
                        <td>${migracao.clienteNome || 'N/A'}</td>
                        <td>${migracao.tipo || 'N/A'}</td>
                        <td>€${(Math.round((parseFloat(migracao.valor) || 0) * 100) / 100).toFixed(2)}</td>
                        <td><span class="status-badge status-${migracao.status}">${migracao.status === 'concluido' ? 'Concluído' : migracao.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span></td>
                        <td>${migracao.dataInicio ? new Date(migracao.dataInicio).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                        <td>
                            <button onclick="console.log('🔧 Botão editar clicado para ID:', ${migracao.id}); editarMigracaoDireto(${migracao.id})" class="text-blue-600 hover:text-blue-900 mr-3" title="Editar">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button onclick="abrirAnexosMigracao(${migracao.id})" class="text-green-600 hover:text-green-900 mr-3" title="Documentos">
                                <i data-lucide="paperclip" class="w-4 h-4"></i>
                            </button>
                            <button onclick="console.log('🔧 Botão excluir clicado para ID:', ${migracao.id}); excluirMigracaoDireto(${migracao.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            // Atualizar contador
            const contador = document.getElementById('contadorMigracoes');
            if (contador) {
                contador.textContent = migracoesFiltradas.length;
            }

            // Recriar ícones
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function limparFiltrosMigracoes() {
            const elementos = [
                'buscaMigracoes',
                'filtroStatusMigracao', 
                'filtroTipoMigracao',
                'filtroValorMinMigracao',
                'filtroValorMaxMigracao'
            ];
            
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.value = '';
                }
            });
            
            aplicarFiltrosMigracoes();
        }

        function abrirAnexosMigracao(id) {
            const migracao = migracoes.find(m => m.id === id);
            if (migracao) {
                abrirModalAnexos('migracao', id, migracao.clienteNome || 'Migração');
            }
        }

        // === FUNÇÃO DE EDIÇÃO PADRÃO ===
        function abrirModalEdicaoMigracao(migracao) {
            console.log('🔧 abrirModalEdicaoMigracao chamado com:', migracao);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            console.log('🔧 Clientes encontrados:', clientes.length);
            
            if (migracao) {
                console.log('🔧 Fechando modal...');
                // Fechar qualquer modal aberto
                fecharModal();
                
                console.log('🔧 Criando modal...');
                // Criar modal com layout padrão
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoMigracao';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Migração</h3>
                                <button onclick="document.getElementById('modalEdicaoMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarMigracaoEditada(event, ${id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editMigracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editMigracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autorização de residência" ${migracao.tipo === 'Autorização de residência' ? 'selected' : ''}>Autorização de residência</option>
                                            <option value="Certificados de residência permanente" ${migracao.tipo === 'Certificados de residência permanente' ? 'selected' : ''}>Certificados de residência permanente</option>
                                            <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                            <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                            <option value="Renovação de autorizações" ${migracao.tipo === 'Renovação de autorizações' ? 'selected' : ''}>Renovação de autorizações</option>
                                            <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                            <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                            <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                            <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editMigracaoValor" value="${migracao.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editMigracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                                <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editMigracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                        <input type="date" id="editMigracaoDataInicio" value="${migracao.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea id="editMigracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoMigracao').remove()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
                console.log('🔧 Modal de edição de migração inserido no DOM!');
            } else {
                console.log('🔧 Erro: migração não encontrada!');
            }
        }
        
        // === FUNÇÃO DE SALVAR PADRÃO ===
        function salvarMigracaoEditada(event, id) {
            event.preventDefault();
            console.log('🔧 salvarMigracaoEditada chamado para ID:', id);
            
            // Buscar migrações do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Encontrar a migração
            const migracaoIndex = migracoes.findIndex(m => m.id == id);
            console.log('🔧 Índice da migração encontrado:', migracaoIndex);
            
            if (migracaoIndex !== -1) {
                const clienteId = parseInt(document.getElementById('editMigracaoClienteId').value);
                const cliente = clientes.find(c => c.id === clienteId);
                
                const valor = parseFloat(document.getElementById('editMigracaoValor').value);
                const ivaPercent = parseFloat(document.getElementById('editMigracaoIva').value);
                const valorIVA = (valor * ivaPercent) / 100;
                const valorComIva = valor + valorIVA;
                
                // Atualizar os dados
                migracoes[migracaoIndex] = {
                    ...migracoes[migracaoIndex],
                    clienteId: clienteId,
                    clienteNome: cliente ? cliente.nome : migracoes[migracaoIndex].clienteNome,
                    tipo: document.getElementById('editMigracaoTipo').value,
                    valor: valor,
                    iva: ivaPercent,
                    valorIVA: valorIVA,
                    valorComIva: valorComIva,
                    status: document.getElementById('editMigracaoStatus').value,
                    dataInicio: document.getElementById('editMigracaoDataInicio').value,
                    observacoes: document.getElementById('editMigracaoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                console.log('🔧 Migração atualizada:', migracoes[migracaoIndex]);
                
                // Salvar no localStorage
                localStorage.setItem('migracoes', JSON.stringify(migracoes));
                window.migracoes = migracoes;
                
                mostrarNotificacao('Migração atualizada com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoMigracao');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar seção
                setTimeout(() => {
                    carregarSecao('migracoes');
                }, 100);
            } else {
                console.log('🔧 Migração não encontrada para atualizar!');
                mostrarNotificacao('Erro: Migração não encontrada!', 'error');
            }
        }
        
        // Tornar função global
        window.salvarMigracaoEditada = salvarMigracaoEditada;
        
        // === FUNÇÃO PARA ANEXOS DE CONTRATOS ===
        function abrirAnexosContrato(id) {
            const contrato = contratos.find(c => c.id === id);
            if (contrato) {
                abrirModalAnexos('contrato', id, contrato.clienteNome || 'Contrato');
            }
        }

        // === FUNÇÃO PARA ANEXOS DE HERANÇAS ===
        function abrirAnexosHeranca(id) {
            const heranca = herancas.find(h => h.id === id);
            if (heranca) {
                abrirModalAnexos('heranca', id, heranca.clienteNome || 'Herança');
            }
        }

        // === FUNÇÃO PARA ANEXOS DE MIGRAÇÕES ===
        function abrirAnexosMigracao(id) {
            const migracao = migracoes.find(m => m.id === id);
            if (migracao) {
                abrirModalAnexos('migracao', id, migracao.clienteNome || 'Migração');
            }
        }

        // === FUNÇÃO PARA ANEXOS DE REGISTOS ===
        function abrirAnexosRegisto(id) {
            const registo = registos.find(r => r.id === id);
            if (registo) {
                abrirModalAnexos('registo', id, registo.clienteNome || 'Registo');
            }
        }

        // === FUNÇÃO PRINCIPAL PARA ABRIR MODAL DE ANEXOS ===
        function abrirModalAnexos(tipo, id, nome) {
            console.log('🔧 abrirModalAnexos chamado:', tipo, id, nome);
            
            // Fechar qualquer modal aberto primeiro
            fecharModal();
            
            // Buscar dados do localStorage
            let dados = [];
            let item = null;
            
            if (tipo === 'contrato') {
                const contratosSalvos = localStorage.getItem('contratos');
                if (contratosSalvos) {
                    dados = JSON.parse(contratosSalvos);
                }
                item = dados.find(c => c.id === id);
            } else if (tipo === 'heranca') {
                const herancasSalvas = localStorage.getItem('herancas');
                if (herancasSalvas) {
                    dados = JSON.parse(herancasSalvas);
                }
                item = dados.find(h => h.id === id);
            } else if (tipo === 'migracao') {
                const migracoesSalvas = localStorage.getItem('migracoes');
                if (migracoesSalvas) {
                    dados = JSON.parse(migracoesSalvas);
                }
                item = dados.find(m => m.id === id);
            } else if (tipo === 'registo') {
                const registosSalvos = localStorage.getItem('registos');
                if (registosSalvos) {
                    dados = JSON.parse(registosSalvos);
                }
                item = dados.find(r => r.id === id);
            }
            
            if (!item) {
                mostrarNotificacao('Item não encontrado!', 'error');
                return;
            }
            
            // Inicializar array de anexos se não existir
            if (!item.anexos) {
                item.anexos = [];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos de ${nome}</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <!-- Upload de novos documentos -->
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexo${tipo.charAt(0).toUpperCase() + tipo.slice(1)}(event, ${id})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('${tipo}')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="documento">Documento</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="certificado">Certificado</option>
                                                <option value="contrato">Contrato</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizado${tipo.charAt(0).toUpperCase() + tipo.slice(1)}" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrição (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descrição do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModal()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Lista de documentos existentes -->
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${item.anexos.length})</h4>
                                ${item.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${item.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} • ${anexo.tamanho} • ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexo${tipo.charAt(0).toUpperCase() + tipo.slice(1)}(${id}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Adicionar modal ao body
            const modalElement = document.createElement('div');
            modalElement.innerHTML = modal;
            document.body.appendChild(modalElement.firstElementChild);
            lucide.createIcons();
        }

        // === FUNÇÕES PARA ADICIONAR ANEXOS ===
        function adicionarAnexoContrato(event, contratoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            const anexo = {
                id: Date.now().toString(),
                nome: nome,
                tipo: tipo,
                descricao: descricao,
                nomeArquivo: arquivo.name,
                tamanho: formatarTamanho(arquivo.size),
                dataUpload: new Date().toISOString(),
                tipoArquivo: arquivo.type,
                dados: 'simulado'
            };
            
            const contrato = contratos.find(c => c.id === contratoId);
            if (contrato) {
                if (!contrato.anexos) contrato.anexos = [];
                contrato.anexos.push(anexo);
                salvarDados('contratos', contratos);
                mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                abrirAnexosContrato(contratoId);
            }
        }

        function adicionarAnexoHeranca(event, herancaId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            const anexo = {
                id: Date.now().toString(),
                nome: nome,
                tipo: tipo,
                descricao: descricao,
                nomeArquivo: arquivo.name,
                tamanho: formatarTamanho(arquivo.size),
                dataUpload: new Date().toISOString(),
                tipoArquivo: arquivo.type,
                dados: 'simulado'
            };
            
            const heranca = herancas.find(h => h.id === herancaId);
            if (heranca) {
                if (!heranca.anexos) heranca.anexos = [];
                heranca.anexos.push(anexo);
                salvarDados('herancas', herancas);
                mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                abrirAnexosHeranca(herancaId);
            }
        }

        function adicionarAnexoMigracao(event, migracaoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            const anexo = {
                id: Date.now().toString(),
                nome: nome,
                tipo: tipo,
                descricao: descricao,
                nomeArquivo: arquivo.name,
                tamanho: formatarTamanho(arquivo.size),
                dataUpload: new Date().toISOString(),
                tipoArquivo: arquivo.type,
                dados: 'simulado'
            };
            
            const migracao = migracoes.find(m => m.id === migracaoId);
            if (migracao) {
                if (!migracao.anexos) migracao.anexos = [];
                migracao.anexos.push(anexo);
                salvarDados('migracoes', migracoes);
                mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                abrirAnexosMigracao(migracaoId);
            }
        }

        function adicionarAnexoRegisto(event, registoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            const anexo = {
                id: Date.now().toString(),
                nome: nome,
                tipo: tipo,
                descricao: descricao,
                nomeArquivo: arquivo.name,
                tamanho: formatarTamanho(arquivo.size),
                dataUpload: new Date().toISOString(),
                tipoArquivo: arquivo.type,
                dados: 'simulado'
            };
            
            const registo = registos.find(r => r.id === registoId);
            if (registo) {
                if (!registo.anexos) registo.anexos = [];
                registo.anexos.push(anexo);
                salvarDados('registos', registos);
                mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                abrirAnexosRegisto(registoId);
            }
        }

        // === FUNÇÕES PARA REMOVER ANEXOS ===
        function removerAnexoContrato(contratoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const contrato = contratos.find(c => c.id === contratoId);
                if (contrato && contrato.anexos) {
                    contrato.anexos = contrato.anexos.filter(a => a.id !== anexoId);
                    salvarDados('contratos', contratos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosContrato(contratoId);
                }
            }
        }

        function removerAnexoHeranca(herancaId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const heranca = herancas.find(h => h.id === herancaId);
                if (heranca && heranca.anexos) {
                    heranca.anexos = heranca.anexos.filter(a => a.id !== anexoId);
                    salvarDados('herancas', herancas);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosHeranca(herancaId);
                }
            }
        }

        function removerAnexoMigracao(migracaoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const migracao = migracoes.find(m => m.id === migracaoId);
                if (migracao && migracao.anexos) {
                    migracao.anexos = migracao.anexos.filter(a => a.id !== anexoId);
                    salvarDados('migracoes', migracoes);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosMigracao(migracaoId);
                }
            }
        }

        function removerAnexoRegisto(registoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const registo = registos.find(r => r.id === registoId);
                if (registo && registo.anexos) {
                    registo.anexos = registo.anexos.filter(a => a.id !== anexoId);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosRegisto(registoId);
                }
            }
        }

        // === FUNÇÃO PARA TOGGLE TIPO PERSONALIZADO ===
        function toggleTipoPersonalizado(tipo) {
            const select = document.getElementById('tipoDocumento');
            const divPersonalizado = document.getElementById(`tipoPersonalizado${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
            
            if (select.value === 'outro') {
                divPersonalizado.classList.remove('hidden');
            } else {
                divPersonalizado.classList.add('hidden');
            }
        }

        // === FUNÇÕES DIRETAS PARA CONTRATOS ===
        function editarContratoDireto(id) {
            console.log('🔧 editarContratoDireto chamado com ID:', id);
            const contratosSalvos = localStorage.getItem('contratos');
            let contratos = [];
            if (contratosSalvos) contratos = JSON.parse(contratosSalvos);
            const contrato = contratos.find(c => c.id === id);
            if (contrato) {
                fecharModal();
                setTimeout(() => abrirModalEdicaoContrato(contrato), 100);
            } else {
                mostrarNotificacao('Contrato não encontrado!', 'error');
            }
        }

        function excluirContratoDireto(id) {
            if (confirm('Tem certeza que deseja excluir este contrato? Esta ação não pode ser desfeita.')) {
                const contratosSalvos = localStorage.getItem('contratos');
                let contratos = [];
                if (contratosSalvos) contratos = JSON.parse(contratosSalvos);
                contratos = contratos.filter(c => c.id !== id);
                localStorage.setItem('contratos', JSON.stringify(contratos));
                window.contratos = contratos;
                mostrarNotificacao('Contrato excluído com sucesso!', 'success');
                carregarSecao('contratos');
            }
        }

        // === FUNÇÕES DIRETAS PARA HERANÇAS ===
        function editarHerancaDireto(id) {
            console.log('🔧 editarHerancaDireto chamado com ID:', id);
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
            const heranca = herancas.find(h => h.id === id);
            if (heranca) {
                fecharModal();
                setTimeout(() => abrirModalEdicaoHeranca(heranca), 100);
            } else {
                mostrarNotificacao('Herança não encontrada!', 'error');
            }
        }

        function excluirHerancaDireto(id) {
            if (confirm('Tem certeza que deseja excluir esta herança? Esta ação não pode ser desfeita.')) {
                const herancasSalvas = localStorage.getItem('herancas');
                let herancas = [];
                if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
                herancas = herancas.filter(h => h.id !== id);
                localStorage.setItem('herancas', JSON.stringify(herancas));
                window.herancas = herancas;
                mostrarNotificacao('Herança excluída com sucesso!', 'success');
                carregarSecao('herancas');
            }
        }

        // === FUNÇÕES DIRETAS PARA MIGRAÇÕES ===
        function editarMigracaoDireto(id) {
            console.log('🔧 editarMigracaoDireto chamado com ID:', id);
            
            // Buscar migrações do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            const migracao = migracoes.find(m => m.id == id);
            console.log('🔧 Migração encontrada:', migracao);
            
            if (migracao) {
                // Fechar qualquer modal existente
                fecharModal();
                
                // Criar modal simples de edição
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoMigracao';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                // Buscar clientes do localStorage
                const clientesSalvos = localStorage.getItem('clientes');
                let clientes = [];
                if (clientesSalvos) {
                    clientes = JSON.parse(clientesSalvos);
                }
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Migração</h3>
                                <button onclick="document.getElementById('modalEdicaoMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarMigracaoEditada(event, ${migracao.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editMigracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editMigracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autorização de residência" ${migracao.tipo === 'Autorização de residência' ? 'selected' : ''}>Autorização de residência</option>
                                            <option value="Certificados de residência permanente" ${migracao.tipo === 'Certificados de residência permanente' ? 'selected' : ''}>Certificados de residência permanente</option>
                                            <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                            <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                            <option value="Renovação de autorizações" ${migracao.tipo === 'Renovação de autorizações' ? 'selected' : ''}>Renovação de autorizações</option>
                                            <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                            <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                            <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                            <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editMigracaoValor" value="${migracao.valor || ''}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editMigracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                                <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editMigracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                        <input type="date" id="editMigracaoDataInicio" value="${migracao.dataInicio || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                        <textarea id="editMigracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoMigracao').remove()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
                console.log('🔧 Modal de edição criado e inserido no DOM!');
            } else {
                mostrarNotificacao('Migração não encontrada!', 'error');
            }
        }

        function excluirMigracaoDireto(id) {
            console.log('🔧 excluirMigracaoDireto chamado com ID:', id);
            if (confirm('Tem certeza que deseja excluir esta migração? Esta ação não pode ser desfeita.')) {
                // Buscar migrações do localStorage
                const migracoesSalvas = localStorage.getItem('migracoes');
                let migracoes = [];
                if (migracoesSalvas) {
                    migracoes = JSON.parse(migracoesSalvas);
                }
                
                // Filtrar para remover a migração
                migracoes = migracoes.filter(m => m.id != id);
                
                // Salvar no localStorage
                localStorage.setItem('migracoes', JSON.stringify(migracoes));
                
                // Atualizar array global
                window.migracoes = migracoes;
                
                mostrarNotificacao('Migração excluída com sucesso!', 'success');
                
                // Recarregar seção
                carregarSecao('migracoes');
            }
        }

        // === SISTEMA DE IVA TRIMESTRAL ===
        
        // Função para determinar o trimestre atual
        function obterTrimestreAtual() {
            const agora = new Date();
            const mes = agora.getMonth() + 1; // Janeiro = 1, Dezembro = 12
            
            if (mes >= 1 && mes <= 3) return 1; // 1º Trimestre (Jan-Mar)
            if (mes >= 4 && mes <= 6) return 2; // 2º Trimestre (Abr-Jun)
            if (mes >= 7 && mes <= 9) return 3; // 3º Trimestre (Jul-Set)
            if (mes >= 10 && mes <= 12) return 4; // 4º Trimestre (Out-Dez)
        }
        
        // Função para obter datas de prazo do IVA
        function obterPrazosIVA(trimestre) {
            const ano = new Date().getFullYear();
            const prazos = {
                1: { // 1º Trimestre
                    entrega: `${ano}-05-20`,
                    pagamento: `${ano}-05-25`,
                    periodo: 'Janeiro a Março'
                },
                2: { // 2º Trimestre
                    entrega: `${ano}-07-20`,
                    pagamento: `${ano}-07-25`,
                    periodo: 'Abril a Junho'
                },
                3: { // 3º Trimestre
                    entrega: `${ano}-11-20`,
                    pagamento: `${ano}-11-25`,
                    periodo: 'Julho a Setembro'
                },
                4: { // 4º Trimestre
                    entrega: `${ano + 1}-02-20`,
                    pagamento: `${ano + 1}-02-25`,
                    periodo: 'Outubro a Dezembro'
                }
            };
            return prazos[trimestre];
        }
        
        // Função para calcular IVA acumulado por trimestre
        function calcularIVATrimestral() {
            const trimestreAtual = obterTrimestreAtual();
            const ano = new Date().getFullYear();
            
            // Buscar todos os dados
            const contratosSalvos = localStorage.getItem('contratos');
            const herancasSalvas = localStorage.getItem('herancas');
            const migracoesSalvas = localStorage.getItem('migracoes');
            const registosSalvos = localStorage.getItem('registos');
            
            let contratos = [], herancas = [], migracoes = [], registos = [];
            if (contratosSalvos) contratos = JSON.parse(contratosSalvos);
            if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
            if (migracoesSalvas) migracoes = JSON.parse(migracoesSalvas);
            if (registosSalvos) registos = JSON.parse(registosSalvos);
            
            const todosItens = [...contratos, ...herancas, ...migracoes, ...registos];
            
            // Calcular IVA por trimestre
            const ivaPorTrimestre = {
                1: { valor: 0, itens: 0, periodo: 'Janeiro a Março' },
                2: { valor: 0, itens: 0, periodo: 'Abril a Junho' },
                3: { valor: 0, itens: 0, periodo: 'Julho a Setembro' },
                4: { valor: 0, itens: 0, periodo: 'Outubro a Dezembro' }
            };
            
            todosItens.forEach(item => {
                if (item.dataInicio) {
                    const dataInicio = new Date(item.dataInicio);
                    const mes = dataInicio.getMonth() + 1;
                    
                    let trimestre;
                    if (mes >= 1 && mes <= 3) trimestre = 1;
                    else if (mes >= 4 && mes <= 6) trimestre = 2;
                    else if (mes >= 7 && mes <= 9) trimestre = 3;
                    else if (mes >= 10 && mes <= 12) trimestre = 4;
                    
                    if (trimestre && item.valorIVA) {
                        ivaPorTrimestre[trimestre].valor += parseFloat(item.valorIVA) || 0;
                        ivaPorTrimestre[trimestre].itens += 1;
                    }
                }
            });
            
            return { ivaPorTrimestre, trimestreAtual };
        }
        
        // Função para criar prazos automáticos de IVA
        function criarPrazosIVA() {
            const trimestreAtual = obterTrimestreAtual();
            const prazos = obterPrazosIVA(trimestreAtual);
            
            // Verificar se já existem prazos de IVA para este trimestre
            const prazosSalvos = localStorage.getItem('prazos');
            let prazosExistentes = [];
            if (prazosSalvos) prazosExistentes = JSON.parse(prazosSalvos);
            
            const prazoEntregaExiste = prazosExistentes.some(p => 
                p.tipo === 'iva_entrega' && p.dataLimite === prazos.entrega
            );
            
            const prazoPagamentoExiste = prazosExistentes.some(p => 
                p.tipo === 'iva_pagamento' && p.dataLimite === prazos.pagamento
            );
            
            // Criar prazo de entrega se não existir
            if (!prazoEntregaExiste) {
                const prazoEntrega = {
                    id: Date.now() + 1,
                    clienteId: 0,
                    clienteNome: 'Sistema',
                    descricao: `Entrega da declaração de IVA - ${prazos.periodo}`,
                    dataLimite: prazos.entrega,
                    status: 'ativo',
                    tipo: 'iva_entrega',
                    prioridade: 'alta',
                    referenciaId: null,
                    dataCriacao: new Date().toISOString()
                };
                prazosExistentes.push(prazoEntrega);
            }
            
            // Criar prazo de pagamento se não existir
            if (!prazoPagamentoExiste) {
                const prazoPagamento = {
                    id: Date.now() + 2,
                    clienteId: 0,
                    clienteNome: 'Sistema',
                    descricao: `Pagamento do IVA - ${prazos.periodo}`,
                    dataLimite: prazos.pagamento,
                    status: 'ativo',
                    tipo: 'iva_pagamento',
                    prioridade: 'alta',
                    referenciaId: null,
                    dataCriacao: new Date().toISOString()
                };
                prazosExistentes.push(prazoPagamento);
            }
            
            // Salvar prazos
            localStorage.setItem('prazos', JSON.stringify(prazosExistentes));
            window.prazos = prazosExistentes;
        }
        
        // === FUNÇÕES DE IVA TRIMESTRAL ===
        
        function obterTrimestreAtual() {
            const agora = new Date();
            return Math.floor(agora.getMonth() / 3) + 1;
        }
        
        function calcularIVATrimestral() {
            const anoAtual = new Date().getFullYear();
            const trimestreAtual = obterTrimestreAtual();
            
            const ivaPorTrimestre = {
                1: { valor: 0, itens: 0, periodo: 'Jan-Mar' },
                2: { valor: 0, itens: 0, periodo: 'Abr-Jun' },
                3: { valor: 0, itens: 0, periodo: 'Jul-Set' },
                4: { valor: 0, itens: 0, periodo: 'Out-Dez' }
            };
            
            // Calcular IVA de todas as fontes
            const todasFontes = [
                ...contratos.map(c => ({ ...c, fonte: 'contrato' })),
                ...herancas.map(h => ({ ...h, fonte: 'heranca' })),
                ...migracoes.map(m => ({ ...m, fonte: 'migracao' })),
                ...registos.map(r => ({ ...r, fonte: 'registo' }))
            ];
            
            todasFontes.forEach(item => {
                if (item.dataCriacao) {
                    const data = new Date(item.dataCriacao);
                    const ano = data.getFullYear();
                    
                    if (ano === anoAtual) {
                        const trimestre = Math.floor(data.getMonth() / 3) + 1;
                        const valor = parseFloat(item.valor) || 0;
                        const iva = parseFloat(item.iva) || 0;
                        const valorIVA = (valor * iva) / 100;
                        
                        if (ivaPorTrimestre[trimestre]) {
                            ivaPorTrimestre[trimestre].valor += valorIVA;
                            ivaPorTrimestre[trimestre].itens++;
                        }
                    }
                }
            });
            
            return { ivaPorTrimestre, trimestreAtual };
        }
        
        function obterPrazosIVA(trimestre) {
            const anoAtual = new Date().getFullYear();
            const mesInicio = (trimestre - 1) * 3;
            const mesFim = mesInicio + 2;
            
            // Prazo de entrega: até o dia 10 do segundo mês após o fim do trimestre
            const dataEntrega = new Date(anoAtual, mesFim + 2, 10);
            
            // Prazo de pagamento: até o dia 15 do segundo mês após o fim do trimestre
            const dataPagamento = new Date(anoAtual, mesFim + 2, 15);
            
            const periodos = {
                1: 'Janeiro-Março',
                2: 'Abril-Junho',
                3: 'Julho-Setembro',
                4: 'Outubro-Dezembro'
            };
            
            return {
                trimestre: trimestre,
                periodo: periodos[trimestre],
                entrega: dataEntrega.toISOString(),
                pagamento: dataPagamento.toISOString()
            };
        }
        
        function criarPrazosIVA() {
            const trimestreAtual = obterTrimestreAtual();
            const prazosIVA = obterPrazosIVA(trimestreAtual);
            const { ivaPorTrimestre } = calcularIVATrimestral();
            
            // Verificar se já existe um prazo de IVA para este trimestre
            const prazoExistente = prazos.find(p => 
                p.tipo === 'iva_trimestral' && 
                p.trimestre === trimestreAtual &&
                new Date(p.dataCriacao).getFullYear() === new Date().getFullYear()
            );
            
            if (prazoExistente) {
                mostrarNotificacao('Já existe um prazo de IVA para este trimestre!', 'warning');
                return;
            }
            
            // Criar prazos de entrega e pagamento
            const prazoEntrega = {
                id: Date.now(),
                clienteId: null,
                clienteNome: 'Autoridade Tributária',
                tipo: 'iva_trimestral',
                trimestre: trimestreAtual,
                descricao: `Entrega da Declaração de IVA - ${prazosIVA.periodo}`,
                dataLimite: prazosIVA.entrega.split('T')[0],
                status: 'ativo',
                prioridade: 'alta',
                valorIVA: ivaPorTrimestre[trimestreAtual].valor,
                dataCriacao: new Date().toISOString()
            };
            
            const prazoPagamento = {
                id: Date.now() + 1,
                clienteId: null,
                clienteNome: 'Autoridade Tributária',
                tipo: 'iva_trimestral',
                trimestre: trimestreAtual,
                descricao: `Pagamento do IVA - ${prazosIVA.periodo} (€${ivaPorTrimestre[trimestreAtual].valor.toFixed(2)})`,
                dataLimite: prazosIVA.pagamento.split('T')[0],
                status: 'ativo',
                prioridade: 'alta',
                valorIVA: ivaPorTrimestre[trimestreAtual].valor,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoEntrega, prazoPagamento);
            salvarDados('prazos', prazos);
            
            mostrarNotificacao('Prazos de IVA criados com sucesso!', 'success');
            
            // Recarregar a seção de prazos se estiver ativa
            if (secaoAtiva === 'prazos') {
                carregarSecao('prazos');
            }
        }
        
        // Função para gerar relatório de IVA trimestral
        function gerarRelatorioIVATrimestral() {
            const { ivaPorTrimestre, trimestreAtual } = calcularIVATrimestral();
            const prazos = obterPrazosIVA(trimestreAtual);
            
            return `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Relatório de IVA Trimestral</h2>
                            <p class="text-gray-600">Análise do IVA por trimestre</p>
                        </div>
                        <button onclick="criarPrazosIVA()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i data-lucide="calendar" class="w-4 h-4 mr-2"></i>
                            Criar Prazos IVA
                        </button>
                    </div>
                    
                    <!-- Trimestre Atual -->
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Trimestre Atual (${trimestreAtual}º)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center p-4 bg-blue-50 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600">€${(Math.round(ivaPorTrimestre[trimestreAtual].valor * 100) / 100).toFixed(2)}</div>
                                <div class="text-sm text-gray-600">IVA Acumulado</div>
                            </div>
                            <div class="text-center p-4 bg-green-50 rounded-lg">
                                <div class="text-2xl font-bold text-green-600">${ivaPorTrimestre[trimestreAtual].itens}</div>
                                <div class="text-sm text-gray-600">Itens Processados</div>
                            </div>
                            <div class="text-center p-4 bg-orange-50 rounded-lg">
                                <div class="text-sm font-bold text-orange-600">${prazos.periodo}</div>
                                <div class="text-sm text-gray-600">Período</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Prazos do Trimestre Atual -->
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Prazos do Trimestre Atual</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 border border-yellow-200 rounded-lg bg-yellow-50">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="font-semibold text-yellow-800">Entrega da Declaração</h4>
                                        <p class="text-sm text-yellow-600">${new Date(prazos.entrega).toLocaleDateString('pt-PT')}</p>
                                    </div>
                                    <i data-lucide="file-text" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                            </div>
                            <div class="p-4 border border-red-200 rounded-lg bg-red-50">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="font-semibold text-red-800">Pagamento do Imposto</h4>
                                        <p class="text-sm text-red-600">${new Date(prazos.pagamento).toLocaleDateString('pt-PT')}</p>
                                    </div>
                                    <i data-lucide="credit-card" class="w-6 h-6 text-red-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resumo por Trimestre -->
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Resumo por Trimestre</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            ${Object.entries(ivaPorTrimestre).map(([trimestre, dados]) => `
                                <div class="p-4 border rounded-lg ${trimestre == trimestreAtual ? 'border-blue-200 bg-blue-50' : 'border-gray-200 bg-gray-50'}">
                                    <div class="text-center">
                                        <div class="text-lg font-bold ${trimestre == trimestreAtual ? 'text-blue-600' : 'text-gray-600'}">
                                            ${trimestre}º Trimestre
                                        </div>
                                        <div class="text-sm text-gray-600 mb-2">${dados.periodo}</div>
                                        <div class="text-xl font-bold text-green-600">€${(Math.round(dados.valor * 100) / 100).toFixed(2)}</div>
                                        <div class="text-sm text-gray-500">${dados.itens} itens</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // === FUNÇÕES DIRETAS PARA HONORÁRIOS (COPIA EXATA DAS HERANÇAS) ===
        function editarHonorarioDireto(id) {
            console.log('🔧 editarHonorarioDireto chamado com ID:', id, 'Tipo:', typeof id);
            const honorariosSalvos = localStorage.getItem('honorarios');
            let honorarios = [];
            if (honorariosSalvos) {
                honorarios = JSON.parse(honorariosSalvos);
            }
            
            // Converter ID para number se necessário
            const idNum = typeof id === 'string' ? parseInt(id) : id;
            console.log('🔧 ID convertido:', idNum);
            console.log('🔧 Total de honorários no localStorage:', honorarios.length);
            console.log('🔧 IDs dos honorários:', honorarios.map(h => h.id));
            
            // Tentar diferentes tipos de comparação
            let honorario = honorarios.find(h => h.id == idNum);
            if (!honorario) {
                console.log('🔧 Tentando comparação com string...');
                honorario = honorarios.find(h => h.id == id);
            }
            if (!honorario) {
                console.log('🔧 Tentando comparação com parseInt...');
                honorario = honorarios.find(h => h.id == parseInt(id));
            }
            console.log('🔧 Honorário encontrado:', honorario);
            
            if (honorario) {
                console.log('🔧 Fechando modal existente...');
                fecharModal();
                console.log('🔧 Chamando abrirModalEdicaoHonorario...');
                setTimeout(() => {
                    console.log('🔧 Executando abrirModalEdicaoHonorario...');
                    abrirModalEdicaoHonorario(honorario);
                }, 100);
            } else {
                console.log('❌ Honorário não encontrado!');
                mostrarNotificacao('Honorário não encontrado!', 'error');
            }
        }

        function excluirHonorarioDireto(id) {
            console.log('🔧 excluirHonorarioDireto chamado com ID:', id, 'Tipo:', typeof id);
            if (confirm('Tem certeza que deseja excluir este honorário? Esta ação não pode ser desfeita.')) {
                const honorariosSalvos = localStorage.getItem('honorarios');
                let honorarios = [];
                if (honorariosSalvos) {
                    honorarios = JSON.parse(honorariosSalvos);
                }
                
                // Converter ID para number se necessário
                const idNum = typeof id === 'string' ? parseInt(id) : id;
                console.log('🔧 ID convertido para exclusão:', idNum);
                
                honorarios = honorarios.filter(h => h.id != idNum);
                localStorage.setItem('honorarios', JSON.stringify(honorarios));
                window.honorarios = honorarios;
                
                mostrarNotificacao('Honorário excluído com sucesso!', 'success');
                carregarSecao('honorarios');
            }
        }

        function abrirModalEdicaoHonorario(honorario) {
            console.log('🔧 abrirModalEdicaoHonorario chamado com:', honorario);
            
            // Verificar se já existe um modal
            const modalExistente = document.getElementById('modalEdicaoHonorario');
            if (modalExistente) {
                console.log('🔧 Removendo modal existente...');
                modalExistente.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoHonorario';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            console.log('🔧 Modal criado, buscando clientes...');
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Honorário</h3>
                            <button onclick="document.getElementById('modalEdicaoHonorario').remove()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                <select id="editHonorarioCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Cliente</option>
                                    ${clientes.map(cliente => `<option value="${cliente.nome}" ${cliente.nome === honorario.cliente ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Serviço *</label>
                                <input type="text" id="editHonorarioServico" value="${honorario.servico || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                <input type="number" id="editHonorarioValor" value="${honorario.valor || ''}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="editHonorarioStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="pendente" ${honorario.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="pago" ${honorario.status === 'pago' ? 'selected' : ''}>Pago</option>
                                    <option value="vencido" ${honorario.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                                <input type="date" id="editHonorarioVencimento" value="${honorario.vencimento || ''}" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="document.getElementById('modalEdicaoHonorario').remove()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                Cancelar
                            </button>
                            <button type="button" onclick="console.log('🔧 Botão Salvar clicado!'); alert('Botão clicado!'); salvarHonorarioEditadoSimples('${honorario.id}')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                Salvar Alterações
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            console.log('🔧 Inserindo modal no DOM...');
            document.body.appendChild(modal);
            console.log('🔧 Modal inserido, criando ícones...');
            lucide.createIcons();
            console.log('🔧 Modal de edição de honorário criado e inserido no DOM!');
        }

        function salvarHonorarioEditado(event, id) {
            console.log('🔧 FUNÇÃO salvarHonorarioEditado INICIADA!');
            event.preventDefault();
            console.log('🔧 salvarHonorarioEditado chamado para ID:', id, 'Tipo:', typeof id);
            
            const honorariosSalvos = localStorage.getItem('honorarios');
            let honorarios = [];
            if (honorariosSalvos) {
                honorarios = JSON.parse(honorariosSalvos);
            }
            
            // Converter ID para number se necessário
            const idNum = typeof id === 'string' ? parseInt(id) : id;
            console.log('🔧 ID convertido para salvar:', idNum);
            console.log('🔧 Total de honorários:', honorarios.length);
            console.log('🔧 IDs dos honorários:', honorarios.map(h => h.id));
            
            // Tentar diferentes tipos de comparação
            let honorarioIndex = honorarios.findIndex(h => h.id == idNum);
            if (honorarioIndex === -1) {
                console.log('🔧 Tentando comparação com string...');
                honorarioIndex = honorarios.findIndex(h => h.id == id);
            }
            if (honorarioIndex === -1) {
                console.log('🔧 Tentando comparação com parseInt...');
                honorarioIndex = honorarios.findIndex(h => h.id == parseInt(id));
            }
            
            console.log('🔧 Índice encontrado:', honorarioIndex);
            
            if (honorarioIndex !== -1) {
                honorarios[honorarioIndex] = {
                    ...honorarios[honorarioIndex],
                    cliente: document.getElementById('editHonorarioCliente').value,
                    servico: document.getElementById('editHonorarioServico').value,
                    valor: parseFloat(document.getElementById('editHonorarioValor').value),
                    status: document.getElementById('editHonorarioStatus').value,
                    vencimento: document.getElementById('editHonorarioVencimento').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                localStorage.setItem('honorarios', JSON.stringify(honorarios));
                window.honorarios = honorarios;
                
                mostrarNotificacao('Honorário atualizado com sucesso!', 'success');
                
                const modal = document.getElementById('modalEdicaoHonorario');
                if (modal) {
                    modal.remove();
                }
                
                setTimeout(() => {
                    carregarSecao('honorarios');
                }, 100);
            } else {
                mostrarNotificacao('Erro: Honorário não encontrado!', 'error');
            }
        }

        function salvarHonorarioEditadoSimples(id) {
            console.log('🔧 salvarHonorarioEditadoSimples chamado para ID:', id, 'Tipo:', typeof id);
            
            // Buscar honorários do localStorage
            const honorariosSalvos = localStorage.getItem('honorarios');
            let honorarios = [];
            if (honorariosSalvos) {
                honorarios = JSON.parse(honorariosSalvos);
            }
            
            console.log('🔧 Total de honorários:', honorarios.length);
            console.log('🔧 IDs dos honorários:', honorarios.map(h => h.id));
            
            // Encontrar o honorário
            const honorarioIndex = honorarios.findIndex(h => h.id == id);
            console.log('🔧 Índice encontrado:', honorarioIndex);
            
            if (honorarioIndex !== -1) {
                // Atualizar os dados
                honorarios[honorarioIndex] = {
                    ...honorarios[honorarioIndex],
                    cliente: document.getElementById('editHonorarioCliente').value,
                    servico: document.getElementById('editHonorarioServico').value,
                    valor: parseFloat(document.getElementById('editHonorarioValor').value),
                    status: document.getElementById('editHonorarioStatus').value,
                    vencimento: document.getElementById('editHonorarioVencimento').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('honorarios', JSON.stringify(honorarios));
                window.honorarios = honorarios;
                
                mostrarNotificacao('Honorário atualizado com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoHonorario');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar seção
                setTimeout(() => {
                    carregarSecao('honorarios');
                }, 100);
            } else {
                console.log('🔧 Honorário não encontrado para atualizar!');
                mostrarNotificacao('Erro: Honorário não encontrado!', 'error');
            }
        }

        // === FUNÇÕES DIRETAS PARA REGISTOS ===
        function editarRegistoDireto(id) {
            console.log('🔧 editarRegistoDireto chamado com ID:', id);
            const registosSalvos = localStorage.getItem('registos');
            let registos = [];
            if (registosSalvos) registos = JSON.parse(registosSalvos);
            const registo = registos.find(r => r.id === id);
            if (registo) {
                fecharModal();
                setTimeout(() => abrirModalEdicaoRegisto(registo), 100);
            } else {
                mostrarNotificacao('Registo não encontrado!', 'error');
            }
        }

        function excluirRegistoDireto(id) {
            if (confirm('Tem certeza que deseja excluir este registo? Esta ação não pode ser desfeita.')) {
                const registosSalvos = localStorage.getItem('registos');
                let registos = [];
                if (registosSalvos) registos = JSON.parse(registosSalvos);
                registos = registos.filter(r => r.id !== id);
                localStorage.setItem('registos', JSON.stringify(registos));
                window.registos = registos;
                mostrarNotificacao('Registo excluído com sucesso!', 'success');
                carregarSecao('registos');
            }
        }

        // Tornar funções globais
        window.abrirAnexosContrato = abrirAnexosContrato;
        window.abrirAnexosHeranca = abrirAnexosHeranca;
        window.abrirAnexosMigracao = abrirAnexosMigracao;
        window.abrirAnexosRegisto = abrirAnexosRegisto;
        window.abrirModalAnexos = abrirModalAnexos;
        window.adicionarAnexoContrato = adicionarAnexoContrato;
        window.adicionarAnexoHeranca = adicionarAnexoHeranca;
        window.adicionarAnexoMigracao = adicionarAnexoMigracao;
        window.adicionarAnexoRegisto = adicionarAnexoRegisto;
        window.removerAnexoContrato = removerAnexoContrato;
        window.removerAnexoHeranca = removerAnexoHeranca;
        window.removerAnexoMigracao = removerAnexoMigracao;
        window.removerAnexoRegisto = removerAnexoRegisto;
        window.toggleTipoPersonalizado = toggleTipoPersonalizado;
        window.atualizarContrato = atualizarContrato;
        window.abrirModalEdicaoContrato = abrirModalEdicaoContrato;
        window.editarContratoDireto = editarContratoDireto;
        window.excluirContratoDireto = excluirContratoDireto;
        window.editarHerancaDireto = editarHerancaDireto;
        window.excluirHerancaDireto = excluirHerancaDireto;
        window.editarMigracaoDireto = editarMigracaoDireto;
        window.excluirMigracaoDireto = excluirMigracaoDireto;
        window.editarRegistoDireto = editarRegistoDireto;
        window.excluirRegistoDireto = excluirRegistoDireto;
        window.abrirModalEdicaoMigracao = abrirModalEdicaoMigracao;
        window.salvarMigracaoEditada = salvarMigracaoEditada;
        window.editarHonorarioDireto = editarHonorarioDireto;
        window.excluirHonorarioDireto = excluirHonorarioDireto;
        window.salvarHonorarioEditado = salvarHonorarioEditado;
        window.calcularIVATrimestral = calcularIVATrimestral;
        window.criarPrazosIVA = criarPrazosIVA;
        window.gerarRelatorioIVATrimestral = gerarRelatorioIVATrimestral;
        window.obterTrimestreAtual = obterTrimestreAtual;
        window.obterPrazosIVA = obterPrazosIVA;
        
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function(registration) {
                        console.log('Service Worker registrado com sucesso:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Falha ao registrar Service Worker:', error);
                    });
            });
        }
        
        // Detectar se é PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', function(e) {
            console.log('PWA pode ser instalado');
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar botão de instalação se necessário
            if (deferredPrompt) {
                console.log('PWA pronto para instalação');
            }
        });

    </script>
</body>
</html>
