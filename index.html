<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Legal - Gest√£o Jur√≠dica v73.0</title>
    
    <script>
        // SOLU√á√ÉO ULTRA RADICAL - FOR√áAR ESQUECER TUDO DE FORMA ULTRA RADICAL
        const timestamp = Date.now();
        const randomId = Math.random().toString(36).substring(7);
        const cacheKey = `ultra_radical_${timestamp}_${randomId}`;
        
        // FOR√áAR ESQUECER TUDO DE FORMA ULTRA RADICAL
        if (localStorage.getItem('ultraRadical') !== cacheKey) {
            localStorage.setItem('ultraRadical', cacheKey);
            alert(`üöÄ SOLU√á√ÉO ULTRA RADICAL v73.0 - A P√ÅGINA VAI RECARREGAR!`);
            console.log(`üöÄ Solu√ß√£o ultra radical com timestamp: ${timestamp}`);
            
            // LIMPAR TUDO DO LOCALSTORAGE
            localStorage.clear();
            sessionStorage.clear();
            
            // DESATIVAR SERVICE WORKER
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                        console.log('üßπ Service Worker removido:', registration.scope);
                    }
                });
            }
            
            // LIMPAR CACHE DO SERVICE WORKER
            if ('caches' in window) {
                caches.keys().then(function(cacheNames) {
                    return Promise.all(
                        cacheNames.map(function(cacheName) {
                            console.log('üßπ Removendo cache:', cacheName);
                            return caches.delete(cacheName);
                        })
                    );
                });
            }
            
            // FOR√áAR RELOAD COM PAR√ÇMETROS PARA ULTRA RADICAL
            const url = new URL(window.location);
            url.searchParams.set('v', '73');
            url.searchParams.set('t', timestamp.toString());
            url.searchParams.set('r', randomId);
            url.searchParams.set('ultra', 'radical');
            url.searchParams.set('force', 'true');
            url.searchParams.set('bypass', 'complete');
            url.searchParams.set('clear', 'all');
            
            // FOR√áAR RELOAD PARA ULTRA RADICAL
            window.location.replace(url.toString());
        } else {
            localStorage.removeItem('ultraRadical');
            console.log('‚úÖ Solu√ß√£o ultra radical aplicada com sucesso!');
        }
    </script>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema completo de gest√£o jur√≠dica para Solicitadores">
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Sistema Legal">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzNiODJmNiIvPgo8cGF0aCBkPSJNMTYgOEMxMS41ODE3IDggOCAxMS41ODE3IDggMTZTMTEuNTgxNyAyNCAxNiAyNFMyNCAyMC40MTgzIDI0IDE2UzIwLjQxODMgOCAxNiA4Wk0xNiAyMEMxMy43OTE0IDIwIDEyIDE4LjIwODYgMTIgMTZTMTMuNzkxNCAxMiAxNiAxMlMyMCAxMy43OTE0IDIwIDE2UzE4LjIwODYgMjAgMTYgMjBaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMzYjgyZjYiLz4KPHBhdGggZD0iTTk2IDQ4QzY5LjQ5IDQ4IDQ4IDY5LjQ5IDQ4IDk2UzY5LjQ5IDE0NCA5NiAxNDRTMTQ0IDEyMi41MSAxNDQgOTZTMTIyLjUxIDQ4IDk2IDQ4Wk05NiAxMjhDNzMuOTA5IDEyOCA1NiAxMTAuMDkgNTYgODhTNzMuOTA5IDQ4IDk2IDQ4UzEzNiA2NS45MSAxMzYgODhTMTE4LjA5IDEyOCA5NiAxMjhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #000000;
            --secondary-color: #374151;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #3b82f6;
        }

        /* Modo Escuro */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #1f2937;
                --secondary-color: #4b5563;
            }
        }

        [data-theme="dark"] {
            --primary-color: #1f2937;
            --secondary-color: #4b5563;
        }

        [data-theme="dark"] body {
            background-color: #111827;
            color: #f9fafb;
        }

        [data-theme="dark"] .card {
            background-color: #1f2937;
            border-color: #374151;
            color: #f9fafb;
        }

        [data-theme="dark"] .sidebar {
            background: #111827 !important;
        }

        [data-theme="dark"] .main-content {
            background-color: #111827;
        }

        [data-theme="dark"] .table-responsive {
            background-color: #1f2937;
        }

        [data-theme="dark"] .table-responsive th,
        [data-theme="dark"] .table-responsive td {
            border-color: #374151;
            color: #f9fafb;
        }

        [data-theme="dark"] .modal-content {
            background-color: #1f2937;
            color: #f9fafb;
        }

        [data-theme="dark"] .btn {
            color: #f9fafb;
        }

        [data-theme="dark"] .btn-primary {
            background: #3b82f6;
        }

        [data-theme="dark"] .btn-secondary {
            background: #6b7280;
        }

        [data-theme="dark"] .btn-success {
            background: #10b981;
        }

        [data-theme="dark"] .btn-warning {
            background: #f59e0b;
        }

        [data-theme="dark"] .btn-error {
            background: #ef4444;
        }

        [data-theme="dark"] .btn-info {
            background: #3b82f6;
        }

        .sidebar { 
            background: var(--primary-color) !important; 
            min-height: 100vh !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 280px !important;
            min-width: 280px !important;
            max-width: 280px !important;
            z-index: 1000 !important;
            transition: all 0.3s ease;
            overflow-y: auto;
        }
        
        /* FOR√áAR LARGURA EM DESKTOP */
        @media (min-width: 1025px) {
            .sidebar {
                width: 280px !important;
                min-width: 280px !important;
                max-width: 280px !important;
            }
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
                transform: translateX(-100%);
                overflow-y: auto;
                max-height: 100vh;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 180px;
            }
        }
        
        @media (max-width: 480px) {
            .sidebar {
                width: 160px;
            }
            
            .sidebar-item {
                padding: 6px 8px;
                font-size: 12px;
            }
            
            .sidebar h2 {
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            .sidebar-item i {
                width: 16px;
                height: 16px;
                margin-right: 8px;
            }
        }

        .sidebar-item { 
            color: #ffffff !important; 
            transition: all 0.2s ease;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 4px 8px;
            display: flex;
            align-items: center;
            text-decoration: none;
            cursor: pointer;
        }
        
        @media (max-width: 1024px) {
            .sidebar-item {
                padding: 10px 14px;
                font-size: 14px;
                margin: 2px 6px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar-item {
                padding: 8px 12px;
                font-size: 13px;
                margin: 2px 4px;
            }
        }
        
        @media (max-width: 1024px) {
            .sidebar h2 {
                font-size: 18px;
                padding: 16px 20px 8px 20px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar h2 {
                font-size: 16px;
                padding: 12px 16px 6px 16px;
            }
        }

        .sidebar-item:hover { 
            background: rgba(255, 255, 255, 0.1); 
            transform: translateX(4px);
        }
        
        .sidebar-item.active { 
            background: var(--secondary-color); 
            border-left: 4px solid #6b7280;
        }

        .main-content {
            margin-left: 280px;
            transition: margin-left 0.3s ease;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                margin-left: 0;
            }
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 1024px) {
            .mobile-menu-btn {
                display: block;
            }
        }

        @media (max-width: 1024px) {
            .mobile-menu-btn {
                display: block;
            }
            
            .sidebar {
                transform: translateX(-100%);
                width: 100% !important;
                max-width: 320px !important;
                z-index: 1000;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0 !important;
                padding-top: 80px;
            }
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .main-content {
                padding: 10px;
            }
            
            .card {
                margin-bottom: 16px;
                padding: 16px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            /* Tabelas responsivas */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table-responsive table {
                min-width: 600px;
            }
            
            /* Modais mobile */
            .modal-content {
                margin: 10px;
                max-height: calc(100vh - 20px);
                overflow-y: auto;
            }
            
            /* Bot√µes de a√ß√£o menores */
            .btn-sm {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            /* Grid responsivo */
            .grid-cols-1 {
                grid-template-columns: 1fr !important;
            }
            
            .md\\:grid-cols-3 {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 5px;
            }
            
            .card {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .btn {
                padding: 10px 14px;
                font-size: 13px;
            }
            
            .sidebar-item {
                padding: 10px 12px;
                font-size: 14px;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }

        .card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-error {
            background: var(--error-color);
            color: white;
        }

        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--error-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pendente {
            background: #fef3c7;
            color: #92400e;
        }

        .status-pago {
            background: #d1fae5;
            color: #065f46;
        }

        .status-vencido {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-ativo {
            background: #d1fae5;
            color: #065f46;
        }

        .status-inativo {
            background: #e5e7eb;
            color: #374151;
        }

        .status-suspenso {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Status das √Åreas de Execu√ß√£o */
        .status-pendente {
            background: #fef3c7;
            color: #92400e;
        }

        .status-em_andamento {
            background: #fef3c7;
            color: #92400e;
        }

        .status-concluido {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Status de Prioridade dos Prazos */
        .status-baixa {
            background: #f3f4f6;
            color: #374151;
        }

        .status-media {
            background: #fef3c7;
            color: #92400e;
        }

        .status-alta {
            background: #fed7aa;
            color: #c2410c;
        }

        .status-critica {
            background: #fee2e2;
            color: #991b1b;
        }

        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .table-responsive table {
            width: 100%;
            border-collapse: collapse;
        }

        .table-responsive th,
        .table-responsive td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .table-responsive th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .table-responsive tbody tr:hover {
            background-color: #f9fafb;
        }
        
        /* Corre√ß√£o definitiva para alinhamento das colunas */
        .tabela-migracao th,
        .tabela-migracao td {
            vertical-align: top !important;
        }
        
        .tabela-migracao th:nth-child(1),
        .tabela-migracao td:nth-child(1) {
            width: 20% !important;
            min-width: 150px !important;
        }
        
        .tabela-migracao th:nth-child(2),
        .tabela-migracao td:nth-child(2) {
            width: 15% !important;
            min-width: 120px !important;
        }
        
        .tabela-migracao th:nth-child(3),
        .tabela-migracao td:nth-child(3) {
            width: 20% !important;
            min-width: 150px !important;
        }
        
        .tabela-migracao th:nth-child(4),
        .tabela-migracao td:nth-child(4) {
            width: 15% !important;
            min-width: 120px !important;
        }
        
        .tabela-migracao th:nth-child(5),
        .tabela-migracao td:nth-child(5) {
            width: 12% !important;
            min-width: 100px !important;
        }
        
        .tabela-migracao th:nth-child(6),
        .tabela-migracao td:nth-child(6) {
            width: 10% !important;
            min-width: 100px !important;
        }
        
        .tabela-migracao th:nth-child(7),
        .tabela-migracao td:nth-child(7) {
            width: 8% !important;
            min-width: 80px !important;
        }


        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .space-x-2 > * + * { margin-left: 8px; }
        .space-x-4 > * + * { margin-left: 16px; }
        .text-center { text-align: center; }
        .font-semibold { font-weight: 600; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-800 { color: #1f2937; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Sistema de Notifica√ß√µes -->
    <div id="notificationContainer"></div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()">
        <i data-lucide="menu" class="w-5 h-5"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="p-6">
            <h2 class="text-white text-xl font-bold mb-6">Sistema Legal</h2>
            <nav class="space-y-2">
                <a href="#" onclick="carregarSecao('dashboard')" class="sidebar-item active" id="nav-dashboard">
                    <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                    Vis√£o Geral
                </a>
                <a href="#" onclick="carregarSecao('clientes')" class="sidebar-item" id="nav-clientes">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                    Clientes
                </a>
                <a href="#" onclick="carregarSecao('honorarios')" class="sidebar-item" id="nav-honorarios">
                    <i data-lucide="dollar-sign" class="w-5 h-5 mr-3"></i>
                    Honor√°rios
                </a>
                <a href="#" onclick="carregarSecao('contratos')" class="sidebar-item" id="nav-contratos">
                    <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                    Contratos
                </a>
                <a href="#" onclick="carregarSecao('herancas')" class="sidebar-item" id="nav-herancas">
                    <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                    Heran√ßas
                </a>
                <a href="#" onclick="carregarSecao('migracoes')" class="sidebar-item" id="nav-migracao">
                    <i data-lucide="users-2" class="w-5 h-5 mr-3"></i>
                    Migra√ß√£o
                </a>
                <a href="#" onclick="carregarSecao('registos')" class="sidebar-item" id="nav-registos">
                    <i data-lucide="book-open" class="w-5 h-5 mr-3"></i>
                    Registos
                </a>
                <a href="#" onclick="carregarSecao('prazos')" class="sidebar-item" id="nav-prazos">
                    <i data-lucide="clock" class="w-5 h-5 mr-3"></i>
                    Prazos
                </a>
                <a href="#" onclick="carregarSecao('notificacoes')" class="sidebar-item" id="nav-notificacoes">
                    <i data-lucide="bell" class="w-5 h-5 mr-3"></i>
                    Notifica√ß√µes
                    <span id="badgeNotificacoes" class="hidden bg-red-500 text-white text-xs rounded-full px-2 py-1 ml-2">0</span>
                </a>
            <a href="#" onclick="carregarSecao('relatorios')" class="sidebar-item" id="nav-relatorios">
                <i data-lucide="bar-chart-3" class="w-5 h-5 mr-3"></i>
                Relat√≥rios
            </a>
            <a href="#" onclick="carregarSecao('backup')" class="sidebar-item" id="nav-backup">
                <i data-lucide="database" class="w-5 h-5 mr-3"></i>
                Backup
            </a>
            <a href="#" onclick="carregarSecao('convidados')" class="sidebar-item" id="nav-convidados" style="display: none;">
                <i data-lucide="user-plus" class="w-5 h-5 mr-3"></i>
                Gest√£o de Convidados
            </a>
            </nav>
        </div>
    </div>

    <!-- Menu Mobile -->
    <button id="menuHamburguer" class="fixed top-4 left-4 z-50 lg:hidden bg-black text-white p-2 rounded">
        <i data-lucide="menu" class="w-6 h-6"></i>
    </button>

    <!-- Conte√∫do Principal -->
    <div class="main-content min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Sistema Legal</h1>
                    <div class="flex items-center space-x-4">
                        <button onclick="debugPWA()" class="btn btn-warning" id="debugPWABtn">
                            <i data-lucide="bug" class="w-4 h-4"></i>
                            Debug PWA
                        </button>
                        <button onclick="exportarDados()" class="btn btn-primary">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Exportar
                        </button>
                        <button onclick="importarDados()" class="btn btn-success">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                            Importar
                        </button>
                        <button onclick="logout()" class="btn btn-danger">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conte√∫do Din√¢mico -->
        <main class="p-6">
            <div id="conteudoDinamico">
                <!-- Dashboard ser√° carregado aqui -->
            </div>
        </main>
    </div>

    <!-- Modais -->
    <div id="modalContainer"></div>

    <script>
        // === SISTEMA LEGAL CORRIGIDO ===
        
        // SISTEMA DE LOGIN
        const USUARIO_PADRAO = 'admin';
        const SENHA_PADRAO = 'APM2024!';
        
        function verificarLogin() {
            const usuarioLogado = localStorage.getItem('usuarioLogado');
            if (!usuarioLogado) {
                mostrarTelaLogin();
                return false;
            }
            return true;
        }
        
        function mostrarTelaLogin() {
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex items-center justify-center">
                    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-900">Sistema Legal</h1>
                            <p class="text-lg font-semibold text-blue-600 mt-2">ANA PAULA MEDINA</p>
                            <p class="text-gray-600 mt-2">Selecione o tipo de acesso</p>
                        </div>
                        
                        <div class="space-y-4">
                            <button onclick="mostrarLoginAdmin()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center justify-center">
                                <i data-lucide="shield-check" class="w-5 h-5 mr-2"></i>
                                Administrador
                            </button>
                            
                            <button onclick="mostrarLoginConvidado()" class="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 flex items-center justify-center">
                                <i data-lucide="user" class="w-5 h-5 mr-2"></i>
                                Convidado
                            </button>
                        </div>
                        
                        <div class="mt-6 text-center text-sm text-gray-600">
                            <p><strong>Administrador:</strong> Acesso total ao sistema</p>
                            <p><strong>Convidado:</strong> Acesso limitado a clientes autorizados</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Renderizar √≠cones
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }
        
        function mostrarLoginAdmin() {
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex items-center justify-center">
                    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-900">Sistema Legal</h1>
                            <p class="text-lg font-semibold text-blue-600 mt-2">ANA PAULA MEDINA</p>
                            <p class="text-gray-600 mt-2">Login Administrador - Acesso total ao sistema</p>
                        </div>
                        
                        <form id="formLoginAdmin" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Usu√°rio</label>
                                <input type="text" id="usuario" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite seu usu√°rio" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                                <input type="password" id="senha" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite sua senha" required>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button type="button" onclick="mostrarTelaLogin()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                                    Voltar
                                </button>
                                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                    Entrar
                                </button>
                            </div>
                        </form>
                        
                        <div class="mt-6 text-center text-sm text-gray-600">
                            <p><strong>üîí Acesso Restrito</strong></p>
                            <p>Entre em contato com o administrador para obter as credenciais</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('formLoginAdmin').addEventListener('submit', function(e) {
                e.preventDefault();
                const usuario = document.getElementById('usuario').value;
                const senha = document.getElementById('senha').value;
                
                if (usuario === USUARIO_PADRAO && senha === SENHA_PADRAO) {
                    localStorage.setItem('usuarioLogado', 'true');
                    localStorage.setItem('usuarioNome', usuario);
                    localStorage.setItem('tipoUsuario', 'admin');
                    location.reload();
                } else {
                    alert('Usu√°rio ou senha incorretos!');
                }
            });
        }
        
        function mostrarLoginConvidado() {
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex items-center justify-center">
                    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-900">Sistema Legal</h1>
                            <p class="text-lg font-semibold text-blue-600 mt-2">ANA PAULA MEDINA</p>
                            <p class="text-gray-600 mt-2">Login Convidado - Acesso limitado a clientes autorizados</p>
                        </div>
                        
                        <form id="formLoginConvidado" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Convidado</label>
                                <input type="text" id="nomeConvidado" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Digite seu nome" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">C√≥digo de Acesso</label>
                                <input type="text" id="codigoAcesso" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Digite o c√≥digo de acesso" required>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button type="button" onclick="mostrarTelaLogin()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                                    Voltar
                                </button>
                                <button type="submit" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                                    Entrar
                                </button>
                            </div>
                        </form>
                        
                        <div class="mt-6 text-center text-sm text-gray-600">
                            <p>Pe√ßa o c√≥digo de acesso ao administrador</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('formLoginConvidado').addEventListener('submit', function(e) {
                e.preventDefault();
                const nome = document.getElementById('nomeConvidado').value;
                const codigo = document.getElementById('codigoAcesso').value;
                
                // Verificar se o c√≥digo existe e est√° ativo
                const convidados = JSON.parse(localStorage.getItem('convidados') || '[]');
                const convidado = convidados.find(c => c.codigo === codigo && c.ativo);
                
                if (convidado) {
                    localStorage.setItem('usuarioLogado', 'true');
                    localStorage.setItem('usuarioNome', nome);
                    localStorage.setItem('tipoUsuario', 'convidado');
                    localStorage.setItem('convidadoId', convidado.id);
                    location.reload();
                } else {
                    alert('C√≥digo de acesso inv√°lido ou inativo!');
                }
            });
        }
        
        function logout() {
            localStorage.removeItem('usuarioLogado');
            localStorage.removeItem('usuarioNome');
            localStorage.removeItem('tipoUsuario');
            localStorage.removeItem('convidadoId');
            location.reload();
        }
        
        // FUN√á√ÉO PARA GERAR C√ìDIGOS DE ACESSO SEGUROS
        function gerarCodigoAcesso() {
            const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let codigo = '';
            for (let i = 0; i < 8; i++) {
                codigo += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
            }
            return codigo;
        }
        
        // FUN√á√ÉO PARA LIMPEZA PROFISSIONAL
        function limparDadosParaUsoProfissional() {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° APAGAR TODOS os dados do sistema!\n\nIsso inclui:\n- Todos os clientes\n- Todos os honor√°rios\n- Todos os contratos\n- Todas as heran√ßas\n- Todas as migra√ß√µes\n- Todos os registos\n- Todos os convidados\n\nTem certeza que deseja continuar?')) {
                if (confirm('üö® CONFIRMA√á√ÉO FINAL:\n\nEsta a√ß√£o √© IRREVERS√çVEL!\n\nTodos os dados ser√£o permanentemente apagados.\n\nDeseja realmente continuar?')) {
                    // Limpar todos os dados do localStorage
                    localStorage.removeItem('clientes');
                    localStorage.removeItem('honorarios');
                    localStorage.removeItem('contratos');
                    localStorage.removeItem('herancas');
                    localStorage.removeItem('migracoes');
                    localStorage.removeItem('registos');
                    localStorage.removeItem('convidados');
                    localStorage.removeItem('prazos');
                    localStorage.removeItem('notificacoes');
                    
                    // Limpar vari√°veis globais
                    clientes = [];
                    honorarios = [];
                    contratos = [];
                    herancas = [];
                    migracoes = [];
                    registos = [];
                    prazos = [];
                    notificacoes = [];
                    
                    mostrarNotificacao('‚úÖ Sistema limpo com sucesso! Pronto para uso profissional.', 'success');
                    
                    // Recarregar p√°gina ap√≥s 2 segundos
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }
            }
        }
        
        // SISTEMA DE GEST√ÉO DE CONVIDADOS
        function criarConvidado(nome, clientesAutorizados) {
            const convidados = JSON.parse(localStorage.getItem('convidados') || '[]');
            const codigo = gerarCodigoAcesso(); // Usar fun√ß√£o de c√≥digo seguro
            
            const novoConvidado = {
                id: Date.now(),
                nome: nome,
                codigo: codigo,
                clientesAutorizados: clientesAutorizados || [],
                ativo: true,
                dataCriacao: new Date().toISOString()
            };
            
            convidados.push(novoConvidado);
            localStorage.setItem('convidados', JSON.stringify(convidados));
            
            return novoConvidado;
        }
        
        function obterConvidados() {
            return JSON.parse(localStorage.getItem('convidados') || '[]');
        }
        
        function ativarDesativarConvidado(id, ativo) {
            const convidados = obterConvidados();
            const convidado = convidados.find(c => c.id === id);
            if (convidado) {
                convidado.ativo = ativo;
                localStorage.setItem('convidados', JSON.stringify(convidados));
            }
        }
        
        // FUN√á√ÉO RECRIADA PARA CORRIGIR PROBLEMA
        function editarPermissoesConvidado(id, clientesAutorizados) {
            console.log('üöÄ IN√çCIO da fun√ß√£o editarPermissoesConvidado');
            console.log('üîß Par√¢metros recebidos:', { id, clientesAutorizados });
            
            // Carregar convidados diretamente
            const convidados = JSON.parse(localStorage.getItem('convidados') || '[]');
            console.log('üîß Convidados carregados:', convidados.length);
            
            // Buscar convidado
            const convidado = convidados.find(c => c.id === id);
            console.log('üîß Buscando convidado com ID:', id);
            
            if (convidado) {
                console.log('üîß Convidado encontrado:', convidado.nome);
                console.log('üîß Clientes autorizados antes:', convidado.clientesAutorizados);
                
                // Verificar se h√° novos clientes autorizados
                const clientesAntigos = convidado.clientesAutorizados || [];
                const novosClientes = clientesAutorizados.filter(id => !clientesAntigos.includes(id));
                
                // Atualizar permiss√µes
                convidado.clientesAutorizados = clientesAutorizados;
                localStorage.setItem('convidados', JSON.stringify(convidados));
                
                console.log('üîß Clientes autorizados depois:', convidado.clientesAutorizados);
                console.log('üîß Dados salvos no localStorage');
                
                // Criar notifica√ß√µes autom√°ticas para novos clientes
                if (novosClientes.length > 0) {
                    const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
                    novosClientes.forEach(clienteId => {
                        const cliente = clientes.find(c => c.id === clienteId);
                        if (cliente) {
                            criarNotificacao({
                                tipo: 'cliente_autorizado',
                                titulo: 'Novo Cliente Autorizado',
                                mensagem: `O cliente "${cliente.nome}" foi autorizado para voc√™.`,
                                prioridade: 'media',
                                referenciaId: clienteId,
                                destinatarioId: id,
                                acao: 'ver_cliente'
                            });
                        }
                    });
                }
                
                // Recarregar se√ß√£o
                setTimeout(() => {
                    console.log('üîß Recarregando se√ß√£o convidados...');
                    carregarSecao('convidados');
                }, 100);
            } else {
                console.error('‚ùå Convidado n√£o encontrado com ID:', id);
                console.log('üîß IDs dispon√≠veis:', convidados.map(c => c.id));
            }
        }
        
        // VERIFICA√á√ÉO DE PERMISS√ïES
        function verificarPermissaoCliente(clienteId) {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            
            if (tipoUsuario === 'admin') {
                return true; // Admin tem acesso total
            }
            
            if (tipoUsuario === 'convidado') {
                const convidadoId = localStorage.getItem('convidadoId');
                const convidados = obterConvidados();
                const convidado = convidados.find(c => c.id === parseInt(convidadoId));
                
                if (convidado && convidado.ativo) {
                    return convidado.clientesAutorizados.includes(parseInt(clienteId));
                }
            }
            
            return false;
        }
        
        // Verificar login ap√≥s o DOM estar carregado
        document.addEventListener('DOMContentLoaded', function() {
            if (!verificarLogin()) {
                // A p√°gina ser√° substitu√≠da pela tela de login
                // O resto do c√≥digo n√£o ser√° executado
                return;
            }
            // Se login OK, configurar interface baseada no tipo de usu√°rio
            configurarInterfaceUsuario();
            // For√ßar largura do sidebar
            forcarLarguraSidebar();
            // Aplicar novamente ap√≥s um delay
            setTimeout(forcarLarguraSidebar, 1000);
            setTimeout(forcarLarguraSidebar, 2000);
            // Inicializar sistema normalmente
            init();
        });
        
        function forcarLarguraSidebar() {
            // Tentar m√∫ltiplas formas de encontrar o sidebar
            const sidebar = document.getElementById('sidebar');
            const sidebarClass = document.querySelector('.sidebar');
            
            if (sidebar) {
                sidebar.style.width = '300px';
                sidebar.style.minWidth = '300px';
                sidebar.style.maxWidth = '300px';
                sidebar.style.setProperty('width', '300px', 'important');
                sidebar.style.setProperty('min-width', '300px', 'important');
                sidebar.style.setProperty('max-width', '300px', 'important');
                console.log('üîß Largura do sidebar for√ßada para 300px (ID)');
            }
            
            if (sidebarClass) {
                sidebarClass.style.width = '300px';
                sidebarClass.style.minWidth = '300px';
                sidebarClass.style.maxWidth = '300px';
                sidebarClass.style.setProperty('width', '300px', 'important');
                sidebarClass.style.setProperty('min-width', '300px', 'important');
                sidebarClass.style.setProperty('max-width', '300px', 'important');
                console.log('üîß Largura do sidebar for√ßada para 300px (CLASS)');
            }
            
            // Aplicar tamb√©m no conte√∫do principal
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.style.marginLeft = '300px';
                mainContent.style.setProperty('margin-left', '300px', 'important');
                console.log('üîß Margem do conte√∫do principal ajustada para 300px');
            }
        }
        
        function configurarInterfaceUsuario() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const navConvidados = document.getElementById('nav-convidados');
            
            if (tipoUsuario === 'admin' && navConvidados) {
                navConvidados.style.display = 'block';
            } else if (navConvidados) {
                navConvidados.style.display = 'none';
            }
            
            // OCULTAR SE√á√ïES PARA CONVIDADOS
            if (tipoUsuario === 'convidado') {
                ocultarSecoesConvidado();
            } else {
                mostrarTodasSecoes();
            }
        }
        
        function ocultarSecoesConvidado() {
            // Ocultar todas as se√ß√µes exceto clientes
            const secoesParaOcultar = [
                'nav-dashboard',
                'nav-honorarios',
                'nav-contratos', 
                'nav-herancas',
                'nav-migracao',
                'nav-registos',
                'nav-prazos',
                'nav-relatorios',
                'nav-backup',
                'nav-convidados'
            ];
            
            secoesParaOcultar.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.style.display = 'none';
                }
            });
            
            // Manter apenas a se√ß√£o de clientes vis√≠vel
            const navClientes = document.getElementById('nav-clientes');
            if (navClientes) {
                navClientes.style.display = 'block';
            }
        }
        
        function mostrarTodasSecoes() {
            // Mostrar todas as se√ß√µes para administradores
            const todasSecoes = [
                'nav-honorarios',
                'nav-contratos', 
                'nav-herancas',
                'nav-migracao',
                'nav-registos',
                'nav-relatorios',
                'nav-backup',
                'nav-convidados'
            ];
            
            todasSecoes.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.style.display = 'block';
                }
            });
        }
        
        // Dados globais
        let clientes = [];
        let honorarios = [];
        let contratos = [];
        let prazos = [];
        let notificacoes = [];
        let herancas = [];
        let migracoes = [];
        let registos = [];
        let secaoAtiva = 'dashboard';
        
        // Garantir que as vari√°veis est√£o definidas globalmente
        window.clientes = clientes;
        window.honorarios = honorarios;
        window.contratos = contratos;
        window.prazos = prazos;
        window.notificacoes = notificacoes;
        window.herancas = herancas;
        window.migracoes = migracoes;
        window.registos = registos;

        // === FUN√á√ÉO DE TESTE ===
        function testarBotao() {
            alert('BOT√ÉO FUNCIONANDO!');
            console.log('BOT√ÉO FUNCIONANDO!');
        }

        // === FUN√á√ïES DE EDI√á√ÉO DIRETA ===
        function editarContratoDireto(id) {
            console.log('üîß EDITANDO CONTRATO ID:', id);
            alert('EDITANDO CONTRATO ID: ' + id);
            
            const contrato = contratos.find(c => c.id === id);
            if (contrato) {
                console.log('‚úÖ Contrato encontrado:', contrato);
                alert('Contrato encontrado: ' + contrato.clienteNome);
                
                // Fechar qualquer modal aberto primeiro
                fecharModal();
                
                // Aguardar um pouco para garantir que o modal anterior foi fechado
                setTimeout(() => {
                    console.log('üöÄ Abrindo modal de edi√ß√£o...');
                    abrirModalEdicaoContrato(contrato);
                }, 200);
            } else {
                console.error('‚ùå Contrato n√£o encontrado com ID:', id);
                alert('‚ùå Contrato n√£o encontrado com ID: ' + id);
                mostrarNotificacao('Contrato n√£o encontrado!', 'error');
            }
        }

        function editarHonorarioDireto(id) {
            console.log('üîß EDITANDO HONOR√ÅRIO ID:', id);
            alert('EDITANDO HONOR√ÅRIO ID: ' + id);
            
            const honorario = honorarios.find(h => h.id === id);
            if (honorario) {
                console.log('‚úÖ Honor√°rio encontrado:', honorario);
                alert('Honor√°rio encontrado: ' + honorario.cliente);
                
                // Fechar qualquer modal aberto primeiro
                fecharModal();
                
                // Aguardar um pouco para garantir que o modal anterior foi fechado
                setTimeout(() => {
                    console.log('üöÄ Abrindo modal de edi√ß√£o...');
                    abrirModalEdicaoHonorario(honorario);
                }, 200);
            } else {
                console.error('‚ùå Honor√°rio n√£o encontrado com ID:', id);
                alert('‚ùå Honor√°rio n√£o encontrado com ID: ' + id);
                mostrarNotificacao('Honor√°rio n√£o encontrado!', 'error');
            }
        }

        function editarClienteDireto(id) {
            console.log('EDITANDO CLIENTE ID:', id);
            
            const cliente = clientes.find(c => c.id === id);
            if (cliente) {
                console.log('Cliente encontrado:', cliente);
                
                // Fechar qualquer modal aberto primeiro
                fecharModal();
                
                // Aguardar um pouco para garantir que o modal anterior foi fechado
                setTimeout(() => {
                    abrirModalEdicaoCliente(cliente);
                }, 100);
            } else {
                console.error('Cliente n√£o encontrado com ID:', id);
                mostrarNotificacao('Cliente n√£o encontrado!', 'error');
            }
        }

        // Inicializa√ß√£o
        function init() {
            console.log('üöÄ TESTE RADICAL v67.0 - CACHE FOR√áADO!');
            
            // LIMPAR CACHE AP√ìS INICIALIZA√á√ÉO
            try {
                localStorage.clear();
                console.log('üßπ localStorage limpo completamente');
            } catch (error) {
                console.log('‚ùå Erro ao limpar localStorage:', error);
            }
            
            carregarDados();
            carregarDadosExemplo();
            
            // Verificar tipo de usu√°rio para carregar se√ß√£o apropriada
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            if (tipoUsuario === 'convidado') {
                carregarSecao('clientes');
            } else {
                carregarSecao('dashboard');
            }
            
            configurarEventos();
            atualizarInterface();
            iniciarSistemaNotificacoes();
            iniciarSistemaBackup();
            
            // Inicializar PWA e funcionalidades mobile
            inicializarPWA();
            // inicializarModoEscuro(); // REMOVIDO
            inicializarGestosTouch();
            
            
            // Calcular juros autom√°ticos na inicializa√ß√£o
            // calcularJurosAutomaticos(); // REMOVIDO
        }

        // PWA - Service Worker Registration
        function inicializarPWA() {
            console.log('üîß Inicializando PWA...');
            
            if ('serviceWorker' in navigator) {
                // Tentar registrar o service worker com fallback
                const swPath = './service-worker.js';
                
                navigator.serviceWorker.register(swPath)
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registrado:', registration);
                        
                        // Verificar atualiza√ß√µes
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    mostrarNotificacao('Nova vers√£o dispon√≠vel! Recarregue a p√°gina.', 'info');
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.warn('‚ö†Ô∏è Service Worker n√£o encontrado, continuando sem PWA:', error.message);
                        // Continuar sem PWA se o service worker n√£o estiver dispon√≠vel
                    });
            } else {
                console.log('‚ùå Service Worker n√£o suportado');
            }

            // PWA Install Prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('üîß beforeinstallprompt disparado');
                e.preventDefault();
                window.deferredPrompt = e;
                
                // Mostrar bot√£o de instala√ß√£o
                mostrarBotaoInstalacao();
            });

            // PWA Installed
            window.addEventListener('appinstalled', () => {
                console.log('‚úÖ PWA instalado com sucesso');
                mostrarNotificacao('Aplica√ß√£o instalada com sucesso!', 'success');
                deferredPrompt = null;
            });

            // Verificar se j√° est√° instalado
            if (window.matchMedia('(display-mode: standalone)').matches) {
                console.log('‚úÖ PWA j√° est√° instalado');
            }
            
            // Verificar crit√©rios de instala√ß√£o
            verificarCriteriosInstalacao();
        }

        function verificarCriteriosInstalacao() {
            console.log('üîß Verificando crit√©rios de instala√ß√£o PWA...');
            
            // Verificar HTTPS
            const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';
            console.log('üîß HTTPS:', isHTTPS);
            
            // Verificar Service Worker
            const hasSW = 'serviceWorker' in navigator;
            console.log('üîß Service Worker suportado:', hasSW);
            
            // Verificar Manifest
            const hasManifest = document.querySelector('link[rel="manifest"]');
            console.log('üîß Manifest encontrado:', !!hasManifest);
            
            // Verificar √≠cones
            const hasIcons = document.querySelectorAll('link[rel="icon"], link[rel="apple-touch-icon"]');
            console.log('üîß √çcones encontrados:', hasIcons.length);
            
            // Verificar se √© instal√°vel
            const isInstallable = isHTTPS && hasSW && hasManifest && hasIcons.length > 0;
            console.log('üîß PWA instal√°vel:', isInstallable);
            
            if (!isInstallable) {
                console.log('‚ùå PWA n√£o atende aos crit√©rios de instala√ß√£o');
                mostrarNotificacao('PWA n√£o est√° pronto para instala√ß√£o', 'warning');
            }
        }

        function debugPWA() {
            console.log('üîß === DEBUG PWA ===');
            
            // Informa√ß√µes do navegador
            console.log('üîß User Agent:', navigator.userAgent);
            console.log('üîß URL:', location.href);
            console.log('üîß Protocolo:', location.protocol);
            console.log('üîß Hostname:', location.hostname);
            
            // Verificar crit√©rios
            verificarCriteriosInstalacao();
            
            // Verificar deferredPrompt
            console.log('üîß deferredPrompt dispon√≠vel:', !!window.deferredPrompt);
            
            // Verificar se j√° est√° instalado
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            console.log('üîß Modo standalone:', isStandalone);
            
            // Verificar Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    console.log('üîß Service Worker registrado:', !!registration);
                    if (registration) {
                        console.log('üîß Service Worker ativo:', registration.active ? 'SIM' : 'N√ÉO');
                    }
                });
            }
            
            // Mostrar informa√ß√µes na tela
            const info = `
üîß DEBUG PWA:
‚Ä¢ URL: ${location.href}
‚Ä¢ Protocolo: ${location.protocol}
‚Ä¢ Service Worker: ${'serviceWorker' in navigator ? 'SIM' : 'N√ÉO'}
‚Ä¢ Manifest: ${document.querySelector('link[rel="manifest"]') ? 'SIM' : 'N√ÉO'}
‚Ä¢ √çcones: ${document.querySelectorAll('link[rel="icon"], link[rel="apple-touch-icon"]').length}
‚Ä¢ deferredPrompt: ${window.deferredPrompt ? 'SIM' : 'N√ÉO'}
‚Ä¢ Standalone: ${isStandalone ? 'SIM' : 'N√ÉO'}
            `;
            
            alert(info);
            console.log('üîß === FIM DEBUG PWA ===');
        }

        function mostrarBotaoInstalacao() {
            console.log('üîß Mostrando bot√£o de instala√ß√£o...');
            
            // Verificar se j√° existe
            const existingBtn = document.getElementById('installBtn');
            if (existingBtn) {
                console.log('üîß Bot√£o j√° existe, removendo...');
                existingBtn.remove();
            }
            
            const installBtn = document.createElement('button');
            installBtn.id = 'installBtn';
            installBtn.className = 'btn btn-info';
            installBtn.innerHTML = '<i data-lucide="download" class="w-4 h-4"></i> Instalar App';
            installBtn.onclick = () => {
                console.log('üîß Bot√£o de instala√ß√£o clicado');
                
                if (window.deferredPrompt) {
                    console.log('üîß Chamando prompt de instala√ß√£o...');
                    window.deferredPrompt.prompt();
                    
                    window.deferredPrompt.userChoice.then((choiceResult) => {
                        console.log('üîß Resultado da escolha:', choiceResult.outcome);
                        if (choiceResult.outcome === 'accepted') {
                            console.log('‚úÖ Usu√°rio aceitou instala√ß√£o');
                            mostrarNotificacao('Instalando aplica√ß√£o...', 'info');
                        } else {
                            console.log('‚ùå Usu√°rio rejeitou instala√ß√£o');
                            mostrarNotificacao('Instala√ß√£o cancelada', 'warning');
                        }
                        window.deferredPrompt = null;
                        installBtn.remove();
                    });
                } else {
                    console.log('‚ùå deferredPrompt n√£o dispon√≠vel');
                    mostrarNotificacao('Instala√ß√£o n√£o dispon√≠vel no momento', 'error');
                }
            };
            
            const header = document.querySelector('header .flex');
            if (header) {
                header.insertBefore(installBtn, header.firstChild);
                console.log('‚úÖ Bot√£o de instala√ß√£o adicionado ao header');
            } else {
                console.log('‚ùå Header n√£o encontrado');
            }
        }

        // Modo Escuro
        function inicializarModoEscuro_REMOVED() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                ativarModoEscuro();
            } else {
                desativarModoEscuro();
            }
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            
            if (isDark) {
                desativarModoEscuro();
            } else {
                ativarModoEscuro();
            }
        }

        function ativarModoEscuro() {
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
            
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            
            if (icon) icon.setAttribute('data-lucide', 'sun');
            if (text) text.textContent = 'Modo Claro';
            
            // Re-renderizar √≠cones
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        function desativarModoEscuro() {
            document.documentElement.removeAttribute('data-theme');
            localStorage.setItem('theme', 'light');
            
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            
            if (icon) icon.setAttribute('data-lucide', 'moon');
            if (text) text.textContent = 'Modo Escuro';
            
            // Re-renderizar √≠cones
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        // Gestos Touch
        function inicializarGestosTouch() {
            let startX, startY, endX, endY;
            
            document.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            });
            
            document.addEventListener('touchend', (e) => {
                endX = e.changedTouches[0].clientX;
                endY = e.changedTouches[0].clientY;
                
                const deltaX = endX - startX;
                const deltaY = endY - startY;
                
                // Swipe horizontal (mudan√ßa de se√ß√£o)
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                    if (deltaX > 0) {
                        // Swipe direita - se√ß√£o anterior
                        navegarSecaoAnterior();
                    } else {
                        // Swipe esquerda - pr√≥xima se√ß√£o
                        navegarProximaSecao();
                    }
                }
                
                // Swipe vertical (fechar modais)
                if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > 100) {
                    if (deltaY > 0) {
                        // Swipe para baixo - fechar modal
                        fecharModal();
                    }
                }
            });
            
            // Pull to refresh
            let pullStartY = 0;
            let isPulling = false;
            
            document.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0) {
                    pullStartY = e.touches[0].clientY;
                    isPulling = true;
                }
            });
            
            document.addEventListener('touchmove', (e) => {
                if (isPulling && window.scrollY === 0) {
                    const pullDistance = e.touches[0].clientY - pullStartY;
                    if (pullDistance > 100) {
                        // Pull to refresh
                        window.location.reload();
                        isPulling = false;
                    }
                }
            });
        }

        function navegarSecaoAnterior() {
            const secoes = ['dashboard', 'clientes', 'honorarios', 'contratos', 'herancas', 'migracoes', 'registos', 'prazos', 'notificacoes'];
            const indiceAtual = secoes.indexOf(secaoAtiva);
            if (indiceAtual > 0) {
                carregarSecao(secoes[indiceAtual - 1]);
            }
        }

        function navegarProximaSecao() {
            const secoes = ['dashboard', 'clientes', 'honorarios', 'contratos', 'herancas', 'migracoes', 'registos', 'prazos', 'notificacoes'];
            const indiceAtual = secoes.indexOf(secaoAtiva);
            if (indiceAtual < secoes.length - 1) {
                carregarSecao(secoes[indiceAtual + 1]);
            }
        }

        // Notifica√ß√µes Push
        function solicitarPermissaoNotificacoes() {
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then((permission) => {
                        if (permission === 'granted') {
                            console.log('‚úÖ Permiss√£o para notifica√ß√µes concedida');
                            mostrarNotificacao('Notifica√ß√µes ativadas!', 'success');
                        }
                    });
                }
            }
        }

        function enviarNotificacaoPush(titulo, corpo, icone) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(titulo, {
                    body: corpo,
                    icon: icone || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMzYjgyZjYiLz4KPHBhdGggZD0iTTk2IDQ4QzY5LjQ5IDQ4IDQ4IDY5LjQ5IDQ4IDk2UzY5LjQ5IDE0NCA5NiAxNDRTMTQ0IDEyMi41MSAxNDQgOTZTMTIyLjUxIDQ4IDk2IDQ4Wk05NiAxMjhDNzMuOTA5IDEyOCA1NiAxMTAuMDkgNTYgODhTNzMuOTA5IDQ4IDk2IDQ4UzEzNiA2NS45MSAxMzYgODhTMTE4LjA5IDEyOCA5NiAxMjhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K',
                    badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTYiIGhlaWdodD0iOTYiIHZpZXdCb3g9IjAgMCA5NiA5NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9Ijk2IiBoZWlnaHQ9Ijk2IiByeD0iMTIiIGZpbGw9IiNmNTk5MGIiLz4KPHBhdGggZD0iTTQ4IDI0QzM0Ljc0IDI0IDI0IDM0Ljc0IDI0IDQ4UzM0Ljc0IDcyIDQ4IDcyUzcyIDYxLjI2IDcyIDQ4UzYxLjI2IDI0IDQ4IDI0Wk00OCA2NEM0MC4yNyA2NCAzNCA1Ny43MyAzNCA1MFM0MC4yNyAzNiA0OCAzNlM2MiA0Mi4yNyA2MiA1MFM1NS73MyA2NCA0OCA2NFoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',
                    vibrate: [200, 100, 200],
                    requireInteraction: true
                });

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
        }





        function calcularJurosAutomaticos_REMOVED() {
            console.log('üîß Fun√ß√£o calcularJurosAutomaticos chamada');
            console.log('üí∞ Calculando juros autom√°ticos...');
            
            const honorariosVencidos = honorarios.filter(h => {
                if (h.status === 'pago') return false;
                const dataVencimento = new Date(h.vencimento);
                return dataVencimento < new Date();
            });
            
            honorariosVencidos.forEach(honorario => {
                const diasAtraso = Math.ceil((new Date() - new Date(honorario.vencimento)) / (1000 * 60 * 60 * 24));
                const taxaJuros = 0.0005; // 0.05% ao dia
                const juros = parseFloat(honorario.valor) * taxaJuros * diasAtraso;
                
                if (juros > 0) {
                    honorario.jurosCalculados = juros;
                    honorario.diasAtraso = diasAtraso;
                    honorario.valorComJuros = parseFloat(honorario.valor) + juros;
                    
                    // Criar notifica√ß√£o de juros
                    criarNotificacao({
                        titulo: `Juros calculados - ${honorario.clienteNome}`,
                        descricao: `Juros de ‚Ç¨${juros.toFixed(2)} calculados (${diasAtraso} dias de atraso)`,
                        tipo: 'warning',
                        categoria: 'juros_calculados',
                        referenciaId: honorario.clienteId
                    });
                }
            });
            
            // Verificar se a fun√ß√£o existe antes de chamar
            if (typeof salvarHonorarios === 'function') {
                console.log('üîß Chamando salvarHonorarios...');
                salvarHonorarios();
            } else {
                console.error('‚ùå Fun√ß√£o salvarHonorarios n√£o encontrada!');
                // Fallback: salvar diretamente
                try {
                    localStorage.setItem('honorarios', JSON.stringify(honorarios));
                    console.log('‚úÖ Honor√°rios salvos via fallback');
                } catch (error) {
                    console.error('‚ùå Erro no fallback:', error);
                }
            }
        }

        // 3. GERA√á√ÉO AUTOM√ÅTICA DE FATURAS
        function gerarFaturaAutomatica(honorarioId) {
            const honorario = honorarios.find(h => h.id === honorarioId);
            if (!honorario) return;
            
            const cliente = clientes.find(c => c.id === honorario.clienteId);
            if (!cliente) return;
            
            const fatura = {
                id: Date.now(),
                numero: `FAT-${new Date().getFullYear()}-${String(Date.now()).slice(-6)}`,
                clienteId: honorario.clienteId,
                clienteNome: honorario.clienteNome,
                honorarioId: honorarioId,
                data: new Date().toISOString().split('T')[0],
                valor: honorario.valorComJuros || honorario.valor,
                juros: honorario.jurosCalculados || 0,
                status: 'pendente',
                observacoes: `Fatura gerada automaticamente para ${honorario.descricao}`
            };
            
            // Adicionar fatura
            const faturas = obterFaturas();
            faturas.push(fatura);
            localStorage.setItem('faturas', JSON.stringify(faturas));
            
            // Criar notifica√ß√£o
            criarNotificacao({
                titulo: `Fatura gerada - ${cliente.nome}`,
                descricao: `Fatura ${fatura.numero} gerada automaticamente`,
                tipo: 'success',
                categoria: 'fatura_gerada',
                referenciaId: cliente.id
            });
            
            console.log('üìÑ Fatura gerada automaticamente:', fatura);
            return fatura;
        }

        // 4. SINCRONIZA√á√ÉO COM CALEND√ÅRIO
        function sincronizarComCalendario_REMOVED() {
            console.log('üîß Fun√ß√£o sincronizarComCalendario chamada');
            console.log('üìÖ Sincronizando com calend√°rio...');
            
            const eventos = [];
            
            // Adicionar prazos
            prazos.forEach(prazo => {
                if (prazo.status === 'ativo' && prazo.dataLimite) {
                    eventos.push({
                        titulo: `üìã Prazo: ${prazo.descricao}`,
                        data: prazo.dataLimite,
                        tipo: 'prazo',
                        cliente: prazo.clienteNome,
                        descricao: prazo.observacoes || 'Prazo importante do Sistema Legal'
                    });
                }
            });
            
            // Adicionar vencimentos de honor√°rios
            honorarios.forEach(honorario => {
                if (honorario.status === 'pendente' && honorario.vencimento) {
                    eventos.push({
                        titulo: `üí∞ Vencimento: ${honorario.descricao}`,
                        data: honorario.vencimento,
                        tipo: 'vencimento',
                        cliente: honorario.clienteNome,
                        valor: honorario.valor,
                        descricao: `Honor√°rio de ‚Ç¨${parseFloat(honorario.valor).toFixed(2)}`
                    });
                }
            });
            
            // Adicionar contratos com vencimento
            contratos.forEach(contrato => {
                if (contrato.vencimento) {
                    eventos.push({
                        titulo: `üìÑ Contrato: ${contrato.descricao}`,
                        data: contrato.vencimento,
                        tipo: 'contrato',
                        cliente: contrato.clienteNome,
                        descricao: `Contrato - ${contrato.tipo}`
                    });
                }
            });
            
            // Adicionar heran√ßas com prazo
            herancas.forEach(heranca => {
                if (heranca.prazo) {
                    eventos.push({
                        titulo: `‚öñÔ∏è Heran√ßa: ${heranca.descricao}`,
                        data: heranca.prazo,
                        tipo: 'heranca',
                        cliente: heranca.clienteNome,
                        descricao: `Processo de heran√ßa - ${heranca.tipo}`
                    });
                }
            });
            
            console.log('üìÖ Eventos encontrados:', eventos.length);
            
            if (eventos.length === 0) {
                mostrarNotificacao('Nenhum evento encontrado para exportar!', 'info');
                return;
            }
            
            // Gerar arquivo ICS para importar no calend√°rio
            gerarArquivoICS(eventos);
        }

        function gerarArquivoICS(eventos) {
            console.log('üìÖ Gerando arquivo ICS com', eventos.length, 'eventos');
            
            // Fun√ß√£o para formatar data no formato ICS
            function formatarDataICS(data) {
                return data.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            }
            
            // Fun√ß√£o para escapar texto para ICS
            function escaparTextoICS(texto) {
                return texto
                    .replace(/\\/g, '\\\\')
                    .replace(/;/g, '\\;')
                    .replace(/,/g, '\\,')
                    .replace(/\n/g, '\\n')
                    .replace(/\r/g, '');
            }
            
            let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Sistema Legal//Sistema Legal//PT
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:Sistema Legal - Prazos e Vencimentos
X-WR-CALDESC:Calend√°rio do Sistema Legal com prazos e vencimentos
X-WR-TIMEZONE:Europe/Lisbon`;

            eventos.forEach((evento, index) => {
                const dataInicio = new Date(evento.data);
                const dataFim = new Date(dataInicio.getTime() + (24 * 60 * 60 * 1000)); // +1 dia
                
                // Gerar UID √∫nico
                const uid = `sistema-legal-${Date.now()}-${index}@sistemalegal.com`;
                
                // Formatar datas
                const dtstart = formatarDataICS(dataInicio);
                const dtend = formatarDataICS(dataFim);
                const dtstamp = formatarDataICS(new Date());
                
                // Escapar textos
                const summary = escaparTextoICS(evento.titulo);
                const description = escaparTextoICS(`Cliente: ${evento.cliente}${evento.valor ? `\\nValor: ‚Ç¨${evento.valor}` : ''}\\n\\nSistema Legal - ANA PAULA MEDINA`);
                const location = escaparTextoICS('Sistema Legal');
                
                icsContent += `
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dtstamp}
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:${summary}
DESCRIPTION:${description}
LOCATION:${location}
STATUS:CONFIRMED
TRANSP:OPAQUE
SEQUENCE:0
END:VEVENT`;
            });

            icsContent += `
END:VCALENDAR`;

            console.log('üìÖ Conte√∫do ICS gerado:', icsContent.substring(0, 200) + '...');
            
            // Criar e baixar arquivo
            const blob = new Blob([icsContent], { 
                type: 'text/calendar;charset=utf-8',
                endings: 'native'
            });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Sistema_Legal_Calendario_${new Date().toISOString().split('T')[0]}.ics`;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao(`Arquivo de calend√°rio gerado com sucesso! (${eventos.length} eventos)`, 'success');
        }

        // 5. INTEGRA√á√ÉO COM SISTEMAS EXTERNOS
        function inicializarIntegracoes() {
            console.log('üîó Inicializando integra√ß√µes externas...');
            
            // Verificar se h√° integra√ß√µes configuradas
            const integracoes = obterIntegracoes();
            
            integracoes.forEach(integracao => {
                if (integracao.ativa) {
                    switch(integracao.tipo) {
                        case 'email':
                            configurarIntegracaoEmail(integracao);
                            break;
                        case 'calendario':
                            configurarIntegracaoCalendario(integracao);
                            break;
                        case 'contabilidade':
                            configurarIntegracaoContabilidade(integracao);
                            break;
                    }
                }
            });
        }

        function configurarIntegracaoEmail(config) {
            console.log('üìß Configurando integra√ß√£o de email:', config);
            // Aqui voc√™ integraria com Gmail API, Outlook API, etc.
        }

        function configurarIntegracaoCalendario(config) {
            console.log('üìÖ Configurando integra√ß√£o de calend√°rio:', config);
            // Aqui voc√™ integraria com Google Calendar, Outlook Calendar, etc.
        }

        function configurarIntegracaoContabilidade(config) {
            console.log('üí∞ Configurando integra√ß√£o de contabilidade:', config);
            // Aqui voc√™ integraria com sistemas de contabilidade
        }



        function obterFaturas() {
            console.log('üîß Fun√ß√£o obterFaturas chamada');
            const faturas = localStorage.getItem('faturas');
            const resultado = faturas ? JSON.parse(faturas) : [];
            console.log('üîß Faturas obtidas:', resultado.length);
            return resultado;
        }

        function obterIntegracoes() {
            console.log('üîß Fun√ß√£o obterIntegracoes chamada');
            const integracoes = localStorage.getItem('integracoes');
            const resultado = integracoes ? JSON.parse(integracoes) : [];
            console.log('üîß Integra√ß√µes obtidas:', resultado.length);
            return resultado;
        }

        function salvarIntegracoes(integracoes) {
            localStorage.setItem('integracoes', JSON.stringify(integracoes));
        }

        // Fun√ß√£o para salvar honor√°rios (CORRIGIDA - v2.0)
        function salvarHonorarios() {
            console.log('üîß Fun√ß√£o salvarHonorarios chamada - v2.0');
            try {
                localStorage.setItem('honorarios', JSON.stringify(honorarios));
                console.log('‚úÖ Honor√°rios salvos com sucesso - v2.0');
            } catch (error) {
                console.error('‚ùå Erro ao salvar honor√°rios:', error);
                mostrarNotificacao('Erro ao salvar honor√°rios!', 'error');
            }
        }





        function gerarFaturasAutomaticas() {
            console.log('üîß Fun√ß√£o gerarFaturasAutomaticas chamada');
            const honorariosComJuros = honorarios.filter(h => h.jurosCalculados && h.jurosCalculados > 0);
            
            if (honorariosComJuros.length === 0) {
                mostrarNotificacao('Nenhum honor√°rio com juros encontrado!', 'info');
                return;
            }
            
            let faturasGeradas = 0;
            honorariosComJuros.forEach(honorario => {
                if (!obterFaturas().find(f => f.honorarioId === honorario.id)) {
                    gerarFaturaAutomatica(honorario.id);
                    faturasGeradas++;
                }
            });
            
            mostrarNotificacao(`${faturasGeradas} faturas geradas automaticamente!`, 'success');
            carregarSecao('dashboard');
        }

        // Fun√ß√µes para gerenciar lembretes
        function editarLembrete(lembreteId) {
            const lembretes = obterLembretes();
            const lembrete = lembretes.find(l => l.id === lembreteId);
            
            if (!lembrete) {
                mostrarNotificacao('Lembrete n√£o encontrado!', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Editar Lembrete</h3>
                        <button onclick="fecharModal()" class="btn btn-sm btn-secondary">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <form onsubmit="atualizarLembrete(event, ${lembreteId})">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Cliente</label>
                                <select name="clienteId" required class="w-full p-2 border rounded-lg">
                                    <option value="">Selecione um cliente</option>
                                    ${clientes.map(c => `<option value="${c.id}" ${c.id === lembrete.clienteId ? 'selected' : ''}>${c.nome}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">T√≠tulo</label>
                                <input type="text" name="titulo" required class="w-full p-2 border rounded-lg" 
                                       value="${lembrete.titulo}" placeholder="T√≠tulo do lembrete">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Data/Hora</label>
                                <input type="datetime-local" name="data" required class="w-full p-2 border rounded-lg" 
                                       value="${lembrete.data}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Descri√ß√£o</label>
                                <textarea name="descricao" class="w-full p-2 border rounded-lg" rows="3" 
                                          placeholder="Descri√ß√£o do lembrete">${lembrete.descricao}</textarea>
                            </div>
                            <div class="flex space-x-3">
                                <button type="submit" class="btn btn-primary">Atualizar Lembrete</button>
                                <button type="button" onclick="fecharModal()" class="btn btn-secondary">Cancelar</button>
                            </div>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function atualizarLembrete(event, lembreteId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const lembretes = obterLembretes();
            const lembreteIndex = lembretes.findIndex(l => l.id === lembreteId);
            
            if (lembreteIndex === -1) {
                mostrarNotificacao('Lembrete n√£o encontrado!', 'error');
                return;
            }
            
            lembretes[lembreteIndex] = {
                ...lembretes[lembreteIndex],
                clienteId: parseInt(formData.get('clienteId')),
                titulo: formData.get('titulo'),
                data: formData.get('data'),
                descricao: formData.get('descricao'),
                atualizadoEm: new Date().toISOString()
            };
            
            localStorage.setItem('lembretes', JSON.stringify(lembretes));
            
            fecharModal();
            mostrarNotificacao('Lembrete atualizado com sucesso!', 'success');
            carregarSecao('dashboard');
        }

        function desativarLembrete(lembreteId) {
            if (!confirm('Tem certeza que deseja desativar este lembrete?')) {
                return;
            }
            
            const lembretes = obterLembretes();
            const lembreteIndex = lembretes.findIndex(l => l.id === lembreteId);
            
            if (lembreteIndex === -1) {
                mostrarNotificacao('Lembrete n√£o encontrado!', 'error');
                return;
            }
            
            lembretes[lembreteIndex].ativo = false;
            lembretes[lembreteIndex].desativadoEm = new Date().toISOString();
            
            localStorage.setItem('lembretes', JSON.stringify(lembretes));
            
            mostrarNotificacao('Lembrete desativado com sucesso!', 'success');
            carregarSecao('dashboard');
        }

        // Fun√ß√£o para configurar integra√ß√µes
        function configurarIntegracoes() {
            console.log('üîß Fun√ß√£o configurarIntegracoes chamada');
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Configurar Integra√ß√µes</h3>
                        <button onclick="fecharModal()" class="btn btn-sm btn-secondary">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Integra√ß√£o de Email -->
                        <div class="card p-4">
                            <h4 class="font-semibold mb-3">üìß Integra√ß√£o de Email</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Servidor SMTP</label>
                                    <input type="text" id="smtpServer" class="w-full p-2 border rounded-lg" 
                                           placeholder="smtp.gmail.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Porta</label>
                                    <input type="number" id="smtpPort" class="w-full p-2 border rounded-lg" 
                                           placeholder="587" value="587">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Email</label>
                                    <input type="email" id="smtpEmail" class="w-full p-2 border rounded-lg" 
                                           placeholder="seu@email.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Senha</label>
                                    <input type="password" id="smtpPassword" class="w-full p-2 border rounded-lg" 
                                           placeholder="Senha do email">
                                </div>
                                <button onclick="salvarIntegracaoEmail()" class="btn btn-primary">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                    Salvar Configura√ß√£o
                                </button>
                            </div>
                        </div>

                        <!-- Integra√ß√£o de Calend√°rio -->
                        <div class="card p-4">
                            <h4 class="font-semibold mb-3">üìÖ Integra√ß√£o de Calend√°rio</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Tipo de Calend√°rio</label>
                                    <select id="calendarioTipo" class="w-full p-2 border rounded-lg">
                                        <option value="google">Google Calendar</option>
                                        <option value="outlook">Outlook Calendar</option>
                                        <option value="apple">Apple Calendar</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">API Key</label>
                                    <input type="text" id="calendarioApiKey" class="w-full p-2 border rounded-lg" 
                                           placeholder="Chave da API">
                                </div>
                                <button onclick="salvarIntegracaoCalendario()" class="btn btn-primary">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                    Salvar Configura√ß√£o
                                </button>
                            </div>
                        </div>

                        <!-- Integra√ß√£o de Contabilidade -->
                        <div class="card p-4">
                            <h4 class="font-semibold mb-3">üí∞ Integra√ß√£o de Contabilidade</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Sistema</label>
                                    <select id="contabilidadeSistema" class="w-full p-2 border rounded-lg">
                                        <option value="sap">SAP</option>
                                        <option value="oracle">Oracle</option>
                                        <option value="custom">Sistema Personalizado</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">URL da API</label>
                                    <input type="url" id="contabilidadeUrl" class="w-full p-2 border rounded-lg" 
                                           placeholder="https://api.exemplo.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Token de Acesso</label>
                                    <input type="text" id="contabilidadeToken" class="w-full p-2 border rounded-lg" 
                                           placeholder="Token de autentica√ß√£o">
                                </div>
                                <button onclick="salvarIntegracaoContabilidade()" class="btn btn-primary">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                    Salvar Configura√ß√£o
                                </button>
                            </div>
                        </div>

                        <div class="flex space-x-3">
                            <button onclick="fecharModal()" class="btn btn-secondary">Fechar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function salvarIntegracaoEmail() {
            const config = {
                tipo: 'email',
                servidor: document.getElementById('smtpServer').value,
                porta: document.getElementById('smtpPort').value,
                email: document.getElementById('smtpEmail').value,
                senha: document.getElementById('smtpPassword').value,
                ativa: true,
                configuradaEm: new Date().toISOString()
            };
            
            const integracoes = obterIntegracoes();
            const index = integracoes.findIndex(i => i.tipo === 'email');
            
            if (index >= 0) {
                integracoes[index] = config;
            } else {
                integracoes.push(config);
            }
            
            salvarIntegracoes(integracoes);
            mostrarNotificacao('Configura√ß√£o de email salva com sucesso!', 'success');
        }

        function salvarIntegracaoCalendario() {
            const config = {
                tipo: 'calendario',
                sistema: document.getElementById('calendarioTipo').value,
                apiKey: document.getElementById('calendarioApiKey').value,
                ativa: true,
                configuradaEm: new Date().toISOString()
            };
            
            const integracoes = obterIntegracoes();
            const index = integracoes.findIndex(i => i.tipo === 'calendario');
            
            if (index >= 0) {
                integracoes[index] = config;
            } else {
                integracoes.push(config);
            }
            
            salvarIntegracoes(integracoes);
            mostrarNotificacao('Configura√ß√£o de calend√°rio salva com sucesso!', 'success');
        }

        function salvarIntegracaoContabilidade() {
            const config = {
                tipo: 'contabilidade',
                sistema: document.getElementById('contabilidadeSistema').value,
                url: document.getElementById('contabilidadeUrl').value,
                token: document.getElementById('contabilidadeToken').value,
                ativa: true,
                configuradaEm: new Date().toISOString()
            };
            
            const integracoes = obterIntegracoes();
            const index = integracoes.findIndex(i => i.tipo === 'contabilidade');
            
            if (index >= 0) {
                integracoes[index] = config;
            } else {
                integracoes.push(config);
            }
            
            salvarIntegracoes(integracoes);
            mostrarNotificacao('Configura√ß√£o de contabilidade salva com sucesso!', 'success');
        }

        function carregarDados() {
            try {
                const clientesSalvos = localStorage.getItem('clientes');
                if (clientesSalvos) {
                    clientes = JSON.parse(clientesSalvos);
                    window.clientes = clientes;
                }

                const honorariosSalvos = localStorage.getItem('honorarios');
                if (honorariosSalvos) {
                    honorarios = JSON.parse(honorariosSalvos);
                    window.honorarios = honorarios;
                }

                const contratosSalvos = localStorage.getItem('contratos');
                if (contratosSalvos) {
                    contratos = JSON.parse(contratosSalvos);
                    window.contratos = contratos;
                }

                const prazosSalvos = localStorage.getItem('prazos');
                if (prazosSalvos) {
                    prazos = JSON.parse(prazosSalvos);
                    window.prazos = prazos;
                }

                const notificacoesSalvas = localStorage.getItem('notificacoes');
                if (notificacoesSalvas) {
                    notificacoes = JSON.parse(notificacoesSalvas);
                    window.notificacoes = notificacoes;
                }

                const herancasSalvas = localStorage.getItem('herancas');
                if (herancasSalvas) {
                    herancas = JSON.parse(herancasSalvas);
                    window.herancas = herancas;
                }

                const migracoesSalvas = localStorage.getItem('migracoes');
                if (migracoesSalvas) {
                    migracoes = JSON.parse(migracoesSalvas);
                    window.migracoes = migracoes;
                }

                const registosSalvos = localStorage.getItem('registos');
                if (registosSalvos) {
                    registos = JSON.parse(registosSalvos);
                    window.registos = registos;
                }

                console.log('‚úÖ Dados carregados com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                mostrarNotificacao('Erro ao carregar dados salvos', 'error');
            }
        }

        function carregarDadosExemplo() {
            if (clientes.length === 0) {
                clientes = [
                    {
                        id: 1,
                        nome: 'Jo√£o Silva',
                        email: 'joao@email.com',
                        telefone: '123456789',
                        nif: '123456789',
                        endereco: 'Rua das Flores, 123',
                        status: 'ativo',
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        nome: 'Maria Santos',
                        email: 'maria@email.com',
                        telefone: '987654321',
                        nif: '987654321',
                        endereco: 'Av. Principal, 456',
                        status: 'ativo',
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('clientes', clientes);
            }

            if (honorarios.length === 0) {
                honorarios = [
                    {
                        id: 1,
                        cliente: 'Jo√£o Silva',
                        servico: 'Consulta Jur√≠dica',
                        valor: 150.00,
                        status: 'pago',
                        vencimento: new Date().toISOString().split('T')[0],
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        cliente: 'Maria Santos',
                        servico: 'Elabora√ß√£o de Contrato',
                        valor: 300.00,
                        status: 'pendente',
                        vencimento: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('honorarios', honorarios);
            }

            if (contratos.length === 0) {
                contratos = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'Jo√£o Silva',
                        tipo: 'Presta√ß√£o de Servi√ßos',
                        descricao: 'Assessoria jur√≠dica empresarial',
                        valor: 5000.00,
                        iva: 23,
                        valorIVA: 1150.00,
                        valorTotal: 6150.00,
                        dataInicio: new Date().toISOString().split('T')[0],
                        dataFim: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'ativo',
                        observacoes: 'Contrato de assessoria jur√≠dica anual',
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Consultoria',
                        descricao: 'Consultoria em direito trabalhista',
                        valor: 2500.00,
                        iva: 23,
                        valorIVA: 575.00,
                        valorTotal: 3075.00,
                        dataInicio: new Date().toISOString().split('T')[0],
                        dataFim: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'ativo',
                        observacoes: 'Consultoria espec√≠fica para quest√µes trabalhistas',
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('contratos', contratos);
            }

            if (prazos.length === 0) {
                prazos = [
                    {
                        id: 1,
                        honorarioId: 1,
                        clienteId: 1,
                        clienteNome: 'Jo√£o Silva',
                        tipo: 'Vencimento',
                        descricao: 'Vencimento de honor√°rio - Consultoria jur√≠dica',
                        dataLimite: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
                        status: 'ativo',
                        prioridade: 'alta',
                        notificacoes: [],
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        honorarioId: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Lembrete',
                        descricao: 'Lembrete de pagamento - Elabora√ß√£o de contrato',
                        dataLimite: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                        status: 'ativo',
                        prioridade: 'media',
                        notificacoes: [],
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('prazos', prazos);
            }

            if (notificacoes.length === 0) {
                notificacoes = [];
                salvarDados('notificacoes', notificacoes);
            }

            if (herancas.length === 0) {
                herancas = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'Jo√£o Silva',
                        tipo: 'Invent√°rio',
                        descricao: 'Processo de invent√°rio de bens',
                        valor: 15000.00,
                        iva: 23,
                        valorComIva: 18450.00,
                        status: 'em_andamento',
                        dataInicio: new Date().toISOString().split('T')[0],
                        observacoes: 'Invent√°rio de bens m√≥veis e im√≥veis',
                        parceria: false,
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Partilha',
                        descricao: 'Processo de partilha de heran√ßa',
                        valor: 25000.00,
                        iva: 23,
                        valorComIva: 30750.00,
                        status: 'concluido',
                        dataInicio: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        observacoes: 'Partilha entre 3 herdeiros',
                        parceria: true,
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('herancas', herancas);
            }

            if (migracoes.length === 0) {
                migracoes = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'Jo√£o Silva',
                        tipo: 'Nacionalidade',
                        descricao: 'Processo de aquisi√ß√£o de nacionalidade portuguesa',
                        valor: 500.00,
                        iva: 23,
                        valorComIva: 615.00,
                        status: 'em_andamento',
                        dataInicio: new Date().toISOString().split('T')[0],
                        observacoes: 'Processo via casamento',
                        parceria: false,
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Resid√™ncia',
                        descricao: 'Renova√ß√£o de autoriza√ß√£o de resid√™ncia',
                        valor: 300.00,
                        iva: 23,
                        valorComIva: 369.00,
                        status: 'pendente',
                        dataInicio: new Date().toISOString().split('T')[0],
                        observacoes: 'Renova√ß√£o por trabalho',
                        parceria: true,
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('migracoes', migracoes);
            }

            if (registos.length === 0) {
                registos = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'Jo√£o Silva',
                        tipo: 'Nascimento',
                        descricao: 'Registo de nascimento de filho',
                        valor: 150.00,
                        iva: 23,
                        valorComIva: 184.50,
                        status: 'concluido',
                        dataInicio: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        observacoes: 'Registo no consulado',
                        parceria: false,
                        dataCriacao: new Date().toISOString()
                    },
                    {
                        id: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Casamento',
                        descricao: 'Registo de casamento civil',
                        valor: 200.00,
                        iva: 23,
                        valorComIva: 246.00,
                        status: 'em_andamento',
                        dataInicio: new Date().toISOString().split('T')[0],
                        observacoes: 'Casamento com cidad√£o portugu√™s',
                        parceria: true,
                        dataCriacao: new Date().toISOString()
                    }
                ];
                salvarDados('registos', registos);
            }

        }

        function salvarDados(chave, dados) {
            console.log('üîß salvarDados chamado:', chave, dados);
            try {
                // Verificar se os dados s√£o v√°lidos
                if (!dados || !Array.isArray(dados)) {
                    console.error('‚ùå Dados inv√°lidos para salvar:', dados);
                    mostrarNotificacao('Erro: Dados inv√°lidos', 'error');
                    return;
                }
                
                // Salvar no localStorage
                const dadosString = JSON.stringify(dados);
                localStorage.setItem(chave, dadosString);
                console.log('‚úÖ Dados salvos no localStorage:', chave, dadosString.length, 'caracteres');
                
                // Atualizar vari√°veis globais
                if (chave === 'clientes') {
                    clientes = dados;
                    window.clientes = clientes;
                } else if (chave === 'honorarios') {
                    honorarios = dados;
                    window.honorarios = honorarios;
                } else if (chave === 'contratos') {
                    contratos = dados;
                    window.contratos = contratos;
                } else if (chave === 'prazos') {
                    prazos = dados;
                    window.prazos = prazos;
                } else if (chave === 'notificacoes') {
                    notificacoes = dados;
                    window.notificacoes = notificacoes;
                } else if (chave === 'herancas') {
                    herancas = dados;
                    window.herancas = herancas;
                } else if (chave === 'migracoes') {
                    migracoes = dados;
                    window.migracoes = migracoes;
                } else if (chave === 'registos') {
                    registos = dados;
                    window.registos = registos;
                }
                
                console.log(`‚úÖ Dados ${chave} salvos com sucesso - ${dados.length} itens`);
                
                // Verificar se foi salvo corretamente
                const dadosSalvos = localStorage.getItem(chave);
                if (dadosSalvos) {
                    console.log('‚úÖ Verifica√ß√£o: Dados confirmados no localStorage');
                } else {
                    console.error('‚ùå Verifica√ß√£o: Dados n√£o encontrados no localStorage');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar dados:', error);
                mostrarNotificacao('Erro ao salvar dados: ' + error.message, 'error');
            }
        }

        function configurarEventos() {
            document.getElementById('menuHamburguer')?.addEventListener('click', () => {
                toggleSidebar();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    fecharModal();
                }
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
        }

        function carregarSecao(secao) {
            console.log('üîß carregarSecao chamado para:', secao);
            
            // Verificar se √© convidado e redirecionar para clientes se necess√°rio
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            if (tipoUsuario === 'convidado') {
                const secoesPermitidas = ['clientes', 'notificacoes'];
                if (!secoesPermitidas.includes(secao)) {
                    secao = 'clientes'; // Redirecionar para clientes
                }
            }
            
            // Fechar qualquer modal aberto antes de carregar nova se√ß√£o
            fecharModal();
            
            // Recarregar dados do localStorage antes de gerar conte√∫do
            carregarDados();
            
            secaoAtiva = secao;
            atualizarNavegacao();
            atualizarTitulo(secao);
            
            const conteudo = gerarConteudoSecao(secao);
            console.log('üîß Conte√∫do gerado:', conteudo ? 'SIM' : 'N√ÉO');
            const conteudoElement = document.getElementById('conteudoDinamico');
            if (conteudoElement) {
                conteudoElement.innerHTML = conteudo;
                console.log('‚úÖ Conte√∫do inserido no DOM');
                
                // Atualizar badge de notifica√ß√µes se for a se√ß√£o de notifica√ß√µes
                if (secao === 'notificacoes') {
                    atualizarBadgeNotificacoes();
                }
            } else {
                console.error('‚ùå Elemento conteudoDinamico n√£o encontrado');
            }
            
            inicializarSecao(secao);
            
            // Inicializar filtros para se√ß√µes espec√≠ficas
            if (secao === 'migracoes') {
                setTimeout(() => {
                    aplicarFiltrosMigracoes();
                }, 100);
            }
            
            if (secao === 'contratos') {
                setTimeout(() => {
                    aplicarFiltrosContratos();
                }, 100);
            }
            
            if (secao === 'honorarios') {
                setTimeout(() => {
                    aplicarFiltrosHonorarios();
                }, 100);
            }
            
            if (secao === 'herancas') {
                console.log('üîß Carregando se√ß√£o herancas');
                console.log('üîß herancas array:', herancas);
                console.log('üîß herancas length:', herancas ? herancas.length : 'undefined');
                setTimeout(() => {
                    if (typeof atualizarListaHerancas === 'function') {
                        console.log('üîß Chamando atualizarListaHerancas');
                        atualizarListaHerancas(herancas);
                    } else {
                        console.log('‚ùå atualizarListaHerancas n√£o √© uma fun√ß√£o');
                    }
                }, 100);
                
                // FOR√áAR CHAMADA ADICIONAL
                setTimeout(() => {
                    console.log('üîß FOR√áANDO CHAMADA ADICIONAL atualizarListaHerancas');
                    if (typeof atualizarListaHerancas === 'function') {
                        atualizarListaHerancas(herancas);
                    }
                }, 500);
                
                // TESTE DIRETO NO CONSOLE
                console.log('üîß TESTE: Executando atualizarListaHerancas diretamente');
                if (typeof atualizarListaHerancas === 'function') {
                    try {
                        atualizarListaHerancas(herancas);
                        console.log('‚úÖ atualizarListaHerancas executado com sucesso');
                    } catch (error) {
                        console.error('‚ùå ERRO ao executar atualizarListaHerancas:', error);
                    }
                } else {
                    console.error('‚ùå atualizarListaHerancas n√£o √© uma fun√ß√£o');
                }
            }
            
            if (secao === 'registos') {
                console.log('üîß Carregando se√ß√£o registos');
                console.log('üîß registos array:', registos);
                console.log('üîß registos length:', registos ? registos.length : 'undefined');
                
                // FOR√áAR CHAMADA IMEDIATA
                console.log('üîß FOR√áANDO CHAMADA IMEDIATA atualizarListaRegistos');
                console.log('üîß registos dispon√≠veis:', registos);
                if (typeof atualizarListaRegistos === 'function') {
                    try {
                        atualizarListaRegistos(registos);
                        console.log('‚úÖ atualizarListaRegistos executado imediatamente');
                    } catch (error) {
                        console.error('‚ùå ERRO ao executar atualizarListaRegistos:', error);
                    }
                } else {
                    console.error('‚ùå atualizarListaRegistos n√£o √© uma fun√ß√£o!');
                }
                
                setTimeout(() => {
                    if (typeof atualizarListaRegistos === 'function') {
                        console.log('üîß Chamando atualizarListaRegistos');
                        atualizarListaRegistos(registos);
                    } else {
                        console.log('‚ùå atualizarListaRegistos n√£o √© uma fun√ß√£o');
                    }
                }, 100);
                
                // FOR√áAR CHAMADA ADICIONAL
                setTimeout(() => {
                    console.log('üîß FOR√áANDO CHAMADA ADICIONAL atualizarListaRegistos');
                    if (typeof atualizarListaRegistos === 'function') {
                        atualizarListaRegistos(registos);
                    }
                }, 500);
                
                // TESTE DIRETO NO CONSOLE
                console.log('üîß TESTE: Executando atualizarListaRegistos diretamente');
                if (typeof atualizarListaRegistos === 'function') {
                    try {
                        atualizarListaRegistos(registos);
                        console.log('‚úÖ atualizarListaRegistos executado com sucesso');
                    } catch (error) {
                        console.error('‚ùå ERRO ao executar atualizarListaRegistos:', error);
                    }
                } else {
                    console.error('‚ùå atualizarListaRegistos n√£o √© uma fun√ß√£o');
                }
            }
            
            console.log('‚úÖ Se√ß√£o carregada:', secao);
            
            // FOR√áAR EXECU√á√ÉO IMEDIATA PARA TESTE
            if (secao === 'herancas') {
                console.log('üîß FOR√áANDO EXECU√á√ÉO IMEDIATA PARA HERAN√áAS');
                
                // CRIAR DADOS DE TESTE SE N√ÉO EXISTIREM
                if (!herancas || herancas.length === 0) {
                    console.log('üîß CRIANDO DADOS DE TESTE PARA HERAN√áAS');
                    herancas = [{
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'TESTE HERAN√áA',
                        tipo: 'TESTE',
                        descricao: 'TESTE PARA VERIFICAR A√á√ïES',
                        valor: 1000,
                        iva: 23,
                        valorComIva: 1230,
                        status: 'em_andamento',
                        dataInicio: new Date().toISOString().split('T')[0]
                    }];
                }
                
                setTimeout(() => {
                    console.log('üîß EXECUTANDO atualizarListaHerancas IMEDIATAMENTE');
                    if (typeof atualizarListaHerancas === 'function') {
                        try {
                            atualizarListaHerancas(herancas);
                            console.log('‚úÖ atualizarListaHerancas FOR√áADO executado');
                        } catch (error) {
                            console.error('‚ùå ERRO FOR√áADO atualizarListaHerancas:', error);
                        }
                    }
                }, 1000);
            }
            
            if (secao === 'registos') {
                console.log('üîß FOR√áANDO EXECU√á√ÉO IMEDIATA PARA REGISTOS');
                
                // CRIAR DADOS DE TESTE SE N√ÉO EXISTIREM
                if (!registos || registos.length === 0) {
                    console.log('üîß CRIANDO DADOS DE TESTE PARA REGISTOS');
                    registos = [{
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'TESTE REGISTO',
                        tipo: 'TESTE',
                        descricao: 'TESTE PARA VERIFICAR A√á√ïES',
                        valor: 500,
                        iva: 23,
                        valorComIva: 615,
                        status: 'em_andamento',
                        dataInicio: new Date().toISOString().split('T')[0]
                    }];
                }
                
                setTimeout(() => {
                    console.log('üîß EXECUTANDO atualizarListaRegistos IMEDIATAMENTE');
                    if (typeof atualizarListaRegistos === 'function') {
                        try {
                            atualizarListaRegistos(registos);
                            console.log('‚úÖ atualizarListaRegistos FOR√áADO executado');
                        } catch (error) {
                            console.error('‚ùå ERRO FOR√áADO atualizarListaRegistos:', error);
                        }
                    }
                }, 1000);
            }
            
            // S√≥ tentar fechar sidebar se estiver no sistema principal
            if (window.innerWidth <= 1024 && document.getElementById('sidebar')) {
                toggleSidebar();
            }
            
            // Criar gr√°ficos avan√ßados se for a se√ß√£o dashboard
            if (secao === 'dashboard') {
                setTimeout(() => {
                    criarGraficosAvancados();
                }, 500);
            }
        }

        function atualizarNavegacao() {
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            if (sidebarItems.length > 0) {
                sidebarItems.forEach(item => {
                    item.classList.remove('active');
                });
                const activeItem = document.getElementById(`nav-${secaoAtiva}`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }
        }

        function atualizarTitulo(secao) {
            console.log('üîß atualizarTitulo chamado para:', secao);
            
            const titulos = {
                dashboard: 'Vis√£o Geral',
                clientes: 'Gest√£o de Clientes',
                honorarios: 'Gest√£o de Honor√°rios',
                contratos: 'Gest√£o de Contratos',
                prazos: 'Gest√£o de Prazos',
                notificacoes: 'Central de Notifica√ß√µes',
                herancas: 'Gest√£o de Heran√ßas',
                migracoes: 'Gest√£o de Migra√ß√£o',
                registos: 'Gest√£o de Registos',
                relatorios: 'Gest√£o de Relat√≥rios',
                backup: 'Sistema de Backup',
            };
            
            const tituloElement = document.getElementById('tituloSecao');
            const subtituloElement = document.getElementById('subtituloSecao');
            const pageTitleElement = document.getElementById('pageTitle');
            
            console.log('üîß Elementos encontrados:', {
                tituloSecao: tituloElement ? 'SIM' : 'N√ÉO',
                subtituloSecao: subtituloElement ? 'SIM' : 'N√ÉO',
                pageTitle: pageTitleElement ? 'SIM' : 'N√ÉO'
            });
            
            const titulo = titulos[secao] || 'Sistema Legal';
            
            if (tituloElement) {
                tituloElement.textContent = titulo;
                console.log('‚úÖ tituloSecao atualizado para:', titulo);
            }
            if (subtituloElement) {
                subtituloElement.textContent = 'Vis√£o geral do sistema';
            }
            if (pageTitleElement) {
                pageTitleElement.textContent = titulo;
                console.log('‚úÖ pageTitle atualizado para:', titulo);
            }
        }

        function gerarConteudoSecao(secao) {
            console.log('üîß gerarConteudoSecao chamado para:', secao);
            console.log('üîß migracoes array antes:', migracoes);
            
            
            // Garantir que migracoes existe
            if (!migracoes) {
                migracoes = [];
                console.log('üîß migracoes inicializado como array vazio');
            }
            
            const conteudos = {
                dashboard: gerarDashboard(),
                clientes: gerarClientes(),
                honorarios: gerarHonorarios(),
                contratos: gerarContratos(),
                prazos: gerarPrazos(),
                notificacoes: gerarNotificacoes(),
                herancas: gerarHerancas(),
                convidados: gerarConvidados(),
                migracoes: gerarMigracao(),
                registos: gerarRegistos(),
                relatorios: gerarRelatorios(),
                backup: gerarBackup(),
            };
            
            console.log('üîß Conte√∫dos dispon√≠veis:', Object.keys(conteudos));
            console.log('üîß Conte√∫do para migracoes:', conteudos.migracoes ? 'EXISTE' : 'N√ÉO EXISTE');
            console.log('üîß Conte√∫do migracoes:', conteudos.migracoes);
            
            
            return conteudos[secao] || '<p>Se√ß√£o n√£o encontrada</p>';
        }

        function gerarRelatorioCompleto() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            let clientesParaMostrar = clientes;
            let honorariosParaMostrar = honorarios;
            let herancasParaMostrar = herancas;
            let migracoesParaMostrar = migracoes;
            let registosParaMostrar = registos;
            let contratosParaMostrar = contratos;
            
            // Filtrar dados para convidados
            if (tipoUsuario === 'convidado') {
                const convidadoId = localStorage.getItem('convidadoId');
                const convidados = obterConvidados();
                const convidado = convidados.find(c => c.id === parseInt(convidadoId));
                
                if (convidado && convidado.ativo) {
                    const clientesAutorizados = convidado.clientesAutorizados;
                    clientesParaMostrar = clientes.filter(c => clientesAutorizados.includes(c.id));
                    honorariosParaMostrar = honorarios.filter(h => clientesAutorizados.includes(h.clienteId));
                    herancasParaMostrar = herancas.filter(h => clientesAutorizados.includes(h.clienteId));
                    migracoesParaMostrar = migracoes.filter(m => clientesAutorizados.includes(m.clienteId));
                    registosParaMostrar = registos.filter(r => clientesAutorizados.includes(r.clienteId));
                    contratosParaMostrar = contratos.filter(c => clientesAutorizados.includes(c.clienteId));
                } else {
                    clientesParaMostrar = [];
                    honorariosParaMostrar = [];
                    herancasParaMostrar = [];
                    migracoesParaMostrar = [];
                    registosParaMostrar = [];
                    contratosParaMostrar = [];
                }
            }
            
            const valorTotalHonorarios = honorariosParaMostrar.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            const valorTotalHerancas = herancasParaMostrar.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            const valorTotalMigracoes = migracoesParaMostrar.reduce((sum, m) => sum + (parseFloat(m.valor) || 0), 0);
            const valorTotalRegistos = registosParaMostrar.reduce((sum, r) => sum + (parseFloat(r.valor) || 0), 0);
            const valorTotalContratos = contratosParaMostrar.reduce((sum, c) => sum + (parseFloat(c.valor) || 0), 0);
            const valorTotalGeral = valorTotalHonorarios + valorTotalHerancas + valorTotalMigracoes + valorTotalRegistos + valorTotalContratos;
            
            const relatorio = `
RELAT√ìRIO COMPLETO - SISTEMA LEGAL
Data: ${new Date().toLocaleDateString('pt-PT')} ${new Date().toLocaleTimeString('pt-PT')}

=== RESUMO GERAL ===
Total de Clientes: ${clientesParaMostrar.length}
Total de Honor√°rios: ${honorariosParaMostrar.length}
Total de Heran√ßas: ${herancasParaMostrar.length}
Total de Migra√ß√µes: ${migracoesParaMostrar.length}
Total de Registos: ${registosParaMostrar.length}
Total de Contratos: ${contratosParaMostrar.length}

=== RESUMO FINANCEIRO ===
Valor Total Honor√°rios: ‚Ç¨${(Math.round(valorTotalHonorarios * 100) / 100).toFixed(2)}
Valor Total Heran√ßas: ‚Ç¨${(Math.round(valorTotalHerancas * 100) / 100).toFixed(2)}
Valor Total Migra√ß√µes: ‚Ç¨${(Math.round(valorTotalMigracoes * 100) / 100).toFixed(2)}
Valor Total Registos: ‚Ç¨${(Math.round(valorTotalRegistos * 100) / 100).toFixed(2)}
Valor Total Contratos: ‚Ç¨${(Math.round(valorTotalContratos * 100) / 100).toFixed(2)}
VALOR TOTAL GERAL: ‚Ç¨${(Math.round(valorTotalGeral * 100) / 100).toFixed(2)}

=== STATUS DOS HONOR√ÅRIOS ===
Pagos: ${honorariosParaMostrar.filter(h => h.status === 'pago').length}
Pendentes: ${honorariosParaMostrar.filter(h => h.status === 'pendente').length}
Vencidos: ${honorariosParaMostrar.filter(h => {
                if (!h.vencimento) return false;
                const dataVencimento = new Date(h.vencimento);
                const hoje = new Date();
                return dataVencimento < hoje && h.status === 'pendente';
            }).length}

=== PRAZOS PR√ìXIMOS (7 dias) ===
${prazos.filter(p => {
                if (!p.dataLimite) return false;
                const dataLimite = new Date(p.dataLimite);
                const hoje = new Date();
                const diferencaDias = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));
                return diferencaDias <= 7 && diferencaDias >= 0 && p.status === 'ativo';
            }).map(p => `- ${p.descricao} (${p.clienteNome}) - ${p.tipo} - ${Math.ceil((new Date(p.dataLimite) - new Date()) / (1000 * 60 * 60 * 24))} dias`).join('\n') || 'Nenhum prazo pr√≥ximo'}

=== TOP 5 CLIENTES POR VALOR ===
${clientesParaMostrar.map(cliente => {
                const valorCliente = honorariosParaMostrar
                    .filter(h => h.clienteId === cliente.id)
                    .reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
                return { ...cliente, valorTotal: valorCliente };
            }).sort((a, b) => b.valorTotal - a.valorTotal).slice(0, 5).map((cliente, index) => 
                `${index + 1}. ${cliente.nome} - ‚Ç¨${(Math.round(cliente.valorTotal * 100) / 100).toFixed(2)}`
            ).join('\n')}

=== RELAT√ìRIO GERADO AUTOMATICAMENTE ===
Sistema Legal - ANA PAULA MEDINA
            `;
            
            // Criar e baixar arquivo
            const blob = new Blob([relatorio], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `relatorio_completo_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('Relat√≥rio completo gerado com sucesso!', 'success');
        }

        function gerarDashboard() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            let clientesParaMostrar = clientes;
            let honorariosParaMostrar = honorarios;
            let herancasParaMostrar = herancas;
            let migracoesParaMostrar = migracoes;
            let registosParaMostrar = registos;
            
            // Filtrar dados para convidados
            if (tipoUsuario === 'convidado') {
                const convidadoId = localStorage.getItem('convidadoId');
                const convidados = obterConvidados();
                const convidado = convidados.find(c => c.id === parseInt(convidadoId));
                
                if (convidado && convidado.ativo) {
                    const clientesAutorizados = convidado.clientesAutorizados;
                    clientesParaMostrar = clientes.filter(c => clientesAutorizados.includes(c.id));
                    honorariosParaMostrar = honorarios.filter(h => clientesAutorizados.includes(h.clienteId));
                    herancasParaMostrar = herancas.filter(h => clientesAutorizados.includes(h.clienteId));
                    migracoesParaMostrar = migracoes.filter(m => clientesAutorizados.includes(m.clienteId));
                    registosParaMostrar = registos.filter(r => clientesAutorizados.includes(r.clienteId));
                } else {
                    // Se n√£o h√° permiss√µes, mostrar dados vazios
                    clientesParaMostrar = [];
                    honorariosParaMostrar = [];
                    herancasParaMostrar = [];
                    migracoesParaMostrar = [];
                    registosParaMostrar = [];
                }
            }
            
            const totalClientes = clientesParaMostrar.length;
            const totalHonorarios = honorariosParaMostrar.length;
            const valorTotal = honorariosParaMostrar.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            const honorariosPagos = honorariosParaMostrar.filter(h => h.status === 'pago').length;
            const honorariosPendentes = honorariosParaMostrar.filter(h => h.status === 'pendente').length;
            const totalHerancas = herancasParaMostrar.length;
            const totalMigracoes = migracoesParaMostrar.length;
            const totalRegistos = registosParaMostrar.length;
            
            // Calcular IVA acumulado trimestral
            const agora = new Date();
            const trimestreAtual = Math.floor(agora.getMonth() / 3);
            const anoAtual = agora.getFullYear();
            const inicioTrimestre = new Date(anoAtual, trimestreAtual * 3, 1);
            const fimTrimestre = new Date(anoAtual, (trimestreAtual + 1) * 3, 0);
            
            // Calcular IVA de todos os itens do trimestre atual
            let ivaAcumuladoTrimestral = 0;
            
            // IVA dos honor√°rios do trimestre
            const honorariosTrimestre = honorarios.filter(h => {
                const dataHonorario = new Date(h.dataCriacao);
                return dataHonorario >= inicioTrimestre && dataHonorario <= fimTrimestre;
            });
            honorariosTrimestre.forEach(h => {
                const valor = parseFloat(h.valor) || 0;
                const iva = parseFloat(h.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            // IVA dos contratos do trimestre
            const contratosTrimestre = contratos.filter(c => {
                const dataContrato = new Date(c.dataCriacao);
                return dataContrato >= inicioTrimestre && dataContrato <= fimTrimestre;
            });
            contratosTrimestre.forEach(c => {
                const valor = parseFloat(c.valor) || 0;
                const iva = parseFloat(c.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            // IVA das heran√ßas do trimestre
            const herancasTrimestre = herancas.filter(h => {
                const dataHeranca = new Date(h.dataCriacao);
                return dataHeranca >= inicioTrimestre && dataHeranca <= fimTrimestre;
            });
            herancasTrimestre.forEach(h => {
                const valor = parseFloat(h.valor) || 0;
                const iva = parseFloat(h.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            // IVA das migra√ß√µes do trimestre
            const migracoesTrimestre = migracoes.filter(m => {
                const dataMigracao = new Date(m.dataCriacao);
                return dataMigracao >= inicioTrimestre && dataMigracao <= fimTrimestre;
            });
            migracoesTrimestre.forEach(m => {
                const valor = parseFloat(m.valor) || 0;
                const iva = parseFloat(m.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            // IVA dos registos do trimestre
            const registosTrimestre = registos.filter(r => {
                const dataRegisto = new Date(r.dataCriacao);
                return dataRegisto >= inicioTrimestre && dataRegisto <= fimTrimestre;
            });
            registosTrimestre.forEach(r => {
                const valor = parseFloat(r.valor) || 0;
                const iva = parseFloat(r.iva) || 0;
                ivaAcumuladoTrimestral += (valor * iva / 100);
            });
            
            const nomeTrimestre = ['1¬∫ Trimestre', '2¬∫ Trimestre', '3¬∫ Trimestre', '4¬∫ Trimestre'][trimestreAtual];

            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Clientes</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalClientes}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Honor√°rios</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalHonorarios}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Pagos</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosPagos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-purple-100 rounded-lg">
                                    <i data-lucide="trending-up" class="w-6 h-6 text-purple-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${(Math.round(valorTotal * 100) / 100).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="receipt" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">IVA Acumulado ${nomeTrimestre}</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${Number(ivaAcumuladoTrimestral).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- M√©tricas Avan√ßadas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-indigo-100 rounded-lg">
                                    <i data-lucide="target" class="w-6 h-6 text-indigo-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Taxa de Convers√£o</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalClientes > 0 ? Math.round((honorariosParaMostrar.filter(h => h.clienteId).length / totalClientes) * 100) : 0}%</p>
                                    <div class="flex items-center mt-1">
                                        <i data-lucide="trending-up" class="w-4 h-4 text-green-500 mr-1"></i>
                                        <span class="text-xs text-green-600">+5.2% vs m√™s anterior</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-teal-100 rounded-lg">
                                    <i data-lucide="calculator" class="w-6 h-6 text-teal-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">M√©dia por Cliente</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${totalClientes > 0 ? (Math.round((valorTotal / totalClientes) * 100) / 100).toFixed(2) : '0.00'}</p>
                                    <div class="flex items-center mt-1">
                                        <i data-lucide="trending-up" class="w-4 h-4 text-green-500 mr-1"></i>
                                        <span class="text-xs text-green-600">+12.3% vs m√™s anterior</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-orange-100 rounded-lg">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-orange-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Honor√°rios Vencidos</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosParaMostrar.filter(h => {
                                        if (!h.vencimento) return false;
                                        const dataVencimento = new Date(h.vencimento);
                                        const hoje = new Date();
                                        return dataVencimento < hoje && h.status === 'pendente';
                                    }).length}</p>
                                    <div class="flex items-center mt-1">
                                        <i data-lucide="trending-down" class="w-4 h-4 text-red-500 mr-1"></i>
                                        <span class="text-xs text-red-600">-2.1% vs m√™s anterior</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-pink-100 rounded-lg">
                                    <i data-lucide="clock" class="w-6 h-6 text-pink-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Prazos Pr√≥ximos</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazos.filter(p => {
                                        if (!p.dataLimite) return false;
                                        const dataLimite = new Date(p.dataLimite);
                                        const hoje = new Date();
                                        const diferencaDias = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));
                                        return diferencaDias <= 7 && diferencaDias >= 0 && p.status === 'ativo';
                                    }).length}</p>
                                    <div class="flex items-center mt-1">
                                        <i data-lucide="trending-up" class="w-4 h-4 text-blue-500 mr-1"></i>
                                        <span class="text-xs text-blue-600">+3.7% vs m√™s anterior</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alertas e Resumos Inteligentes -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">üö® Alertas Urgentes</h3>
                            <div class="space-y-3">
                                ${honorariosParaMostrar.filter(h => {
                                    if (!h.vencimento) return false;
                                    const dataVencimento = new Date(h.vencimento);
                                    const hoje = new Date();
                                    return dataVencimento < hoje && h.status === 'pendente';
                                }).slice(0, 3).map(honorario => `
                                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border-l-4 border-red-500">
                                        <div>
                                            <p class="text-sm font-medium text-red-800">${honorario.cliente}</p>
                                            <p class="text-xs text-red-600">Vencido em ${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}</p>
                                        </div>
                                        <span class="text-red-600 font-bold">‚Ç¨${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</span>
                                    </div>
                                `).join('')}
                                ${honorariosParaMostrar.filter(h => {
                                    if (!h.vencimento) return false;
                                    const dataVencimento = new Date(h.vencimento);
                                    const hoje = new Date();
                                    return dataVencimento < hoje && h.status === 'pendente';
                                }).length === 0 ? `
                                    <div class="text-center py-4">
                                        <i data-lucide="check-circle" class="w-8 h-8 text-green-500 mx-auto mb-2"></i>
                                        <p class="text-sm text-green-600">Nenhum honor√°rio vencido!</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">‚è∞ Prazos Pr√≥ximos</h3>
                            <div class="space-y-3">
                                ${prazos.filter(p => {
                                    if (!p.dataLimite) return false;
                                    const dataLimite = new Date(p.dataLimite);
                                    const hoje = new Date();
                                    const diferencaDias = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));
                                    return diferencaDias <= 7 && diferencaDias >= 0 && p.status === 'ativo';
                                }).slice(0, 3).map(prazo => `
                                    <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                                        <div>
                                            <p class="text-sm font-medium text-yellow-800">${prazo.descricao}</p>
                                            <p class="text-xs text-yellow-600">${prazo.clienteNome} - ${Math.ceil((new Date(prazo.dataLimite) - new Date()) / (1000 * 60 * 60 * 24))} dias</p>
                                        </div>
                                        <span class="text-yellow-600 font-bold">${prazo.tipo}</span>
                                    </div>
                                `).join('')}
                                ${prazos.filter(p => {
                                    if (!p.dataLimite) return false;
                                    const dataLimite = new Date(p.dataLimite);
                                    const hoje = new Date();
                                    const diferencaDias = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));
                                    return diferencaDias <= 7 && diferencaDias >= 0 && p.status === 'ativo';
                                }).length === 0 ? `
                                    <div class="text-center py-4">
                                        <i data-lucide="check-circle" class="w-8 h-8 text-green-500 mx-auto mb-2"></i>
                                        <p class="text-sm text-green-600">Nenhum prazo pr√≥ximo!</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">üìä Resumo Financeiro</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                    <span class="text-green-800 font-medium">Honor√°rios Pagos</span>
                                    <span class="text-green-600 font-bold">${honorariosPagos}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                                    <span class="text-yellow-800 font-medium">Honor√°rios Pendentes</span>
                                    <span class="text-yellow-600 font-bold">${honorariosPendentes}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                    <span class="text-blue-800 font-medium">Valor Total</span>
                                    <span class="text-blue-600 font-bold">‚Ç¨${(Math.round(valorTotal * 100) / 100).toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                                    <span class="text-purple-800 font-medium">Taxa de Convers√£o</span>
                                    <span class="text-purple-600 font-bold">${totalClientes > 0 ? Math.round((honorariosParaMostrar.filter(h => h.clienteId).length / totalClientes) * 100) : 0}%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°ficos Avan√ßados -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">üìä Evolu√ß√£o Temporal dos Honor√°rios</h3>
                            <div class="chart-container">
                                <canvas id="chartEvolucaoTemporal"></canvas>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">üìà Compara√ß√£o Mensal</h3>
                            <div class="chart-container">
                                <canvas id="chartComparacaoMensal"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">ü•ß Distribui√ß√£o por Tipo</h3>
                            <div class="chart-container">
                                <canvas id="chartDistribuicaoTipo"></canvas>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">üìà Top 5 Clientes por Valor</h3>
                            <div class="space-y-3">
                                ${clientesParaMostrar.map(cliente => {
                                    const valorCliente = honorariosParaMostrar
                                        .filter(h => h.clienteId === cliente.id)
                                        .reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
                                    return { ...cliente, valorTotal: valorCliente };
                                }).sort((a, b) => b.valorTotal - a.valorTotal).slice(0, 5).map((cliente, index) => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div class="flex items-center">
                                            <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded-full mr-3">${index + 1}</span>
                                            <div>
                                                <p class="font-medium text-gray-800">${cliente.nome}</p>
                                                <p class="text-xs text-gray-600">${cliente.email}</p>
                                            </div>
                                        </div>
                                        <span class="text-blue-600 font-bold">‚Ç¨${(Math.round(cliente.valorTotal * 100) / 100).toFixed(2)}</span>
                                    </div>
                                `).join('')}
                                ${clientesParaMostrar.length === 0 ? `
                                    <div class="text-center py-4">
                                        <i data-lucide="users" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                                        <p class="text-sm text-gray-500">Nenhum cliente encontrado</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">√öltimos Clientes</h3>
                            <div class="space-y-3">
                                ${clientes.slice(-3).map(cliente => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium">${cliente.nome}</p>
                                            <p class="text-sm text-gray-600">${cliente.email}</p>
                                        </div>
                                        <span class="status-badge status-${cliente.status || 'ativo'}">${cliente.status || 'Ativo'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">√öltimos Honor√°rios</h3>
                            <div class="space-y-3">
                                ${honorarios.slice(-3).map(honorario => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium">${honorario.cliente}</p>
                                            <p class="text-sm text-gray-600">‚Ç¨${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</p>
                                        </div>
                                        <span class="status-badge status-${honorario.status}">${honorario.status}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- A√ß√µes R√°pidas -->
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">‚ö° A√ß√µes R√°pidas</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button onclick="carregarSecao('honorarios')" class="flex items-center justify-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg border border-blue-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-blue-800">Criar Honor√°rio</p>
                                </div>
                            </button>
                            
                            <button onclick="carregarSecao('prazos')" class="flex items-center justify-center p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg border border-yellow-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="clock" class="w-6 h-6 text-yellow-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-yellow-800">Ver Prazos</p>
                                </div>
                            </button>
                            
                            <button onclick="carregarSecao('clientes')" class="flex items-center justify-center p-4 bg-green-50 hover:bg-green-100 rounded-lg border border-green-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="user-plus" class="w-6 h-6 text-green-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-green-800">Novo Cliente</p>
                                </div>
                            </button>
                            
                            <button onclick="gerarRelatorioCompleto()" class="flex items-center justify-center p-4 bg-purple-50 hover:bg-purple-100 rounded-lg border border-purple-200 transition-colors">
                                <div class="text-center">
                                    <i data-lucide="download" class="w-6 h-6 text-purple-600 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium text-purple-800">Relat√≥rio</p>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Novas Se√ß√µes -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="home" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Heran√ßas</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalHerancas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-orange-100 rounded-lg">
                                    <i data-lucide="users-2" class="w-6 h-6 text-orange-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Migra√ß√µes</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalMigracoes}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-indigo-100 rounded-lg">
                                    <i data-lucide="book-open" class="w-6 h-6 text-indigo-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Registos</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalRegistos}</p>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            `;
        }

        function criarGraficosAvancados() {
            // Dados para os gr√°ficos
            const dadosEvolucaoTemporal = calcularEvolucaoTemporal();
            const dadosComparacaoMensal = calcularComparacaoMensal();
            const dadosDistribuicaoTipo = calcularDistribuicaoTipo();
            
            // Gr√°fico de Evolu√ß√£o Temporal
            const ctxEvolucao = document.getElementById('chartEvolucaoTemporal');
            if (ctxEvolucao) {
                new Chart(ctxEvolucao, {
                    type: 'line',
                    data: {
                        labels: dadosEvolucaoTemporal.labels,
                        datasets: [{
                            label: 'Honor√°rios (‚Ç¨)',
                            data: dadosEvolucaoTemporal.valores,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '‚Ç¨' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico de Compara√ß√£o Mensal
            const ctxComparacao = document.getElementById('chartComparacaoMensal');
            if (ctxComparacao) {
                new Chart(ctxComparacao, {
                    type: 'bar',
                    data: {
                        labels: dadosComparacaoMensal.labels,
                        datasets: [{
                            label: 'Honor√°rios',
                            data: dadosComparacaoMensal.honorarios,
                            backgroundColor: 'rgba(34, 197, 94, 0.8)'
                        }, {
                            label: 'Heran√ßas',
                            data: dadosComparacaoMensal.herancas,
                            backgroundColor: 'rgba(249, 115, 22, 0.8)'
                        }, {
                            label: 'Migra√ß√µes',
                            data: dadosComparacaoMensal.migracoes,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '‚Ç¨' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico de Distribui√ß√£o por Tipo
            const ctxDistribuicao = document.getElementById('chartDistribuicaoTipo');
            if (ctxDistribuicao) {
                new Chart(ctxDistribuicao, {
                    type: 'doughnut',
                    data: {
                        labels: dadosDistribuicaoTipo.labels,
                        datasets: [{
                            data: dadosDistribuicaoTipo.valores,
                            backgroundColor: [
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(249, 115, 22, 0.8)',
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(168, 85, 247, 0.8)',
                                'rgba(236, 72, 153, 0.8)'
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        function calcularEvolucaoTemporal() {
            const agora = new Date();
            const ultimos6Meses = [];
            
            for (let i = 5; i >= 0; i--) {
                const data = new Date(agora.getFullYear(), agora.getMonth() - i, 1);
                ultimos6Meses.push(data);
            }
            
            const labels = ultimos6Meses.map(data => 
                data.toLocaleDateString('pt-PT', { month: 'short', year: 'numeric' })
            );
            
            const valores = ultimos6Meses.map(data => {
                const inicioMes = new Date(data.getFullYear(), data.getMonth(), 1);
                const fimMes = new Date(data.getFullYear(), data.getMonth() + 1, 0);
                
                return window.honorarios ? window.honorarios.filter(h => {
                    const dataHonorario = new Date(h.dataCriacao);
                    return dataHonorario >= inicioMes && dataHonorario <= fimMes;
                }).reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
            });
            
            return { labels, valores };
        }

        function calcularComparacaoMensal() {
            const agora = new Date();
            const ultimos3Meses = [];
            
            for (let i = 2; i >= 0; i--) {
                const data = new Date(agora.getFullYear(), agora.getMonth() - i, 1);
                ultimos3Meses.push(data);
            }
            
            const labels = ultimos3Meses.map(data => 
                data.toLocaleDateString('pt-PT', { month: 'short', year: 'numeric' })
            );
            
            const valoresHonorarios = ultimos3Meses.map(data => {
                const inicioMes = new Date(data.getFullYear(), data.getMonth(), 1);
                const fimMes = new Date(data.getFullYear(), data.getMonth() + 1, 0);
                
                return window.honorarios ? window.honorarios.filter(h => {
                    const dataHonorario = new Date(h.dataCriacao);
                    return dataHonorario >= inicioMes && dataHonorario <= fimMes;
                }).reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
            });
            
            const valoresHerancas = ultimos3Meses.map(data => {
                const inicioMes = new Date(data.getFullYear(), data.getMonth(), 1);
                const fimMes = new Date(data.getFullYear(), data.getMonth() + 1, 0);
                
                return window.herancas ? window.herancas.filter(h => {
                    const dataHeranca = new Date(h.dataCriacao);
                    return dataHeranca >= inicioMes && dataHeranca <= fimMes;
                }).reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
            });
            
            const valoresMigracoes = ultimos3Meses.map(data => {
                const inicioMes = new Date(data.getFullYear(), data.getMonth(), 1);
                const fimMes = new Date(data.getFullYear(), data.getMonth() + 1, 0);
                
                return window.migracoes ? window.migracoes.filter(m => {
                    const dataMigracao = new Date(m.dataCriacao);
                    return dataMigracao >= inicioMes && dataMigracao <= fimMes;
                }).reduce((sum, m) => sum + (parseFloat(m.valor) || 0), 0) : 0;
            });
            
            return { labels, honorarios: valoresHonorarios, herancas: valoresHerancas, migracoes: valoresMigracoes };
        }

        function calcularDistribuicaoTipo() {
            const valorHonorarios = window.honorarios ? window.honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
            const valorHerancas = window.herancas ? window.herancas.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
            const valorMigracoes = window.migracoes ? window.migracoes.reduce((sum, m) => sum + (parseFloat(m.valor) || 0), 0) : 0;
            const valorRegistos = window.registos ? window.registos.reduce((sum, r) => sum + (parseFloat(r.valor) || 0), 0) : 0;
            const valorContratos = window.contratos ? window.contratos.reduce((sum, c) => sum + (parseFloat(c.valor) || 0), 0) : 0;
            
            return {
                labels: ['Honor√°rios', 'Heran√ßas', 'Migra√ß√µes', 'Registos', 'Contratos'],
                valores: [valorHonorarios, valorHerancas, valorMigracoes, valorRegistos, valorContratos]
            };
        }

        function gerarClientes() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            let clientesParaMostrar = clientes;
            
            // Filtrar clientes para convidados
            if (tipoUsuario === 'convidado') {
                const convidadoId = localStorage.getItem('convidadoId');
                const convidados = obterConvidados();
                const convidado = convidados.find(c => c.id === parseInt(convidadoId));
                
                console.log('üîß Convidado encontrado:', convidado);
                console.log('üîß Clientes autorizados:', convidado?.clientesAutorizados);
                console.log('üîß Total de clientes:', clientes.length);
                
                if (convidado && convidado.ativo) {
                    // Permitir que convidados vejam clientes autorizados E clientes que eles criaram
                    const clientesAutorizados = convidado.clientesAutorizados || [];
                    const clientesCriadosPeloConvidado = clientes.filter(cliente => 
                        cliente.criadoPorConvidado === parseInt(convidadoId)
                    );
                    
                    clientesParaMostrar = clientes.filter(cliente => 
                        clientesAutorizados.includes(cliente.id) || 
                        cliente.criadoPorConvidado === parseInt(convidadoId)
                    );
                    
                    console.log('üîß Clientes para mostrar:', clientesParaMostrar.length);
                } else {
                    clientesParaMostrar = []; // Nenhum cliente se n√£o h√° permiss√µes
                }
            }
            
            const botaoNovoCliente = `
                <button onclick="abrirModal('cliente')" class="btn btn-primary">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Novo Cliente
                </button>
            `;
            
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        ${botaoNovoCliente}
                    </div>

                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaClientes" placeholder="Buscar clientes..." 
                                   class="search-input" onkeyup="filtrarClientes()">
                        </div>
                        
                        <!-- Filtros Avan√ßados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosClientes()">
                                    <option value="">Todos os status</option>
                                    <option value="ativo">Ativo</option>
                                    <option value="inativo">Inativo</option>
                                    <option value="suspenso">Suspenso</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Cria√ß√£o</label>
                                <select id="filtroDataCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosClientes()">
                                    <option value="">Todas as datas</option>
                                    <option value="hoje">Hoje</option>
                                    <option value="semana">Esta semana</option>
                                    <option value="mes">Este m√™s</option>
                                    <option value="ano">Este ano</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Buscar por NIF</label>
                                <input type="text" id="buscaNifClientes" placeholder="Digite o NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onkeyup="aplicarFiltrosClientes()">
                                <!-- CACHE UPDATE: Campo NIF adicionado -->
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosClientes()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorClientes">0</span> clientes encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="p-6">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Email</th>
                                            <th>Telefone</th>
                                            <th>NIF</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaClientes">
                                        ${clientesParaMostrar.map(cliente => `
                                            <tr>
                                                <td>${cliente.nome}</td>
                                                <td>${cliente.email}</td>
                                                <td>${cliente.telefone}</td>
                                                <td>${cliente.nif || '-'}</td>
                                                <td><span class="status-badge status-${cliente.status || 'ativo'}">${cliente.status || 'Ativo'}</span></td>
                                                <td>
                                                    <button onclick="editarItem('cliente', ${cliente.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="abrirAnexosCliente(${cliente.id})" class="text-green-600 hover:text-green-800" title="Documentos">
                                                        <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarHonorarios() {
            const honorariosPagos = honorarios.filter(h => h.status === 'pago').length;
            const honorariosPendentes = honorarios.filter(h => h.status === 'pendente').length;
            const honorariosVencidos = honorarios.filter(h => h.status === 'vencido').length;
            const valorTotal = honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <button onclick="abrirModal('honorario')" class="btn btn-primary">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Novo Honor√°rio
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Pagos</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosPagos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="clock" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Pendentes</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosPendentes}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="alert-circle" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Vencidos</p>
                                    <p class="text-2xl font-bold text-gray-900">${honorariosVencidos}</p>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${(Math.round(valorTotal * 100) / 100).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaHonorarios" placeholder="Buscar honor√°rios..." 
                                   class="search-input" onkeyup="filtrarHonorarios()">
                        </div>
                        
                        <!-- Filtros Avan√ßados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusHonorario" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="pago">Pago</option>
                                    <option value="vencido">Vencido</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor M√≠nimo</label>
                                <input type="number" id="filtroValorMinHonorario" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor M√°ximo</label>
                                <input type="number" id="filtroValorMaxHonorario" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                                <select id="filtroVencimentoHonorario" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                                    <option value="">Todas as datas</option>
                                    <option value="hoje">Vence hoje</option>
                                    <option value="semana">Esta semana</option>
                                    <option value="mes">Este m√™s</option>
                                    <option value="vencido">Vencidos</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosHonorarios()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorHonorarios">0</span> honor√°rios encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="p-6">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Servi√ßo</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>Vencimento</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaHonorarios">
                                        ${honorarios.map(honorario => `
                                            <tr>
                                                <td>${honorario.cliente}</td>
                                                <td>${honorario.servico}</td>
                                                <td>‚Ç¨${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</td>
                                                <td><span class="status-badge status-${honorario.status}">${honorario.status}</span></td>
                                                <td>${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}</td>
                                                <td>
                                                    <button onclick="editarItem('honorario', ${honorario.id})" class="text-blue-600 hover:text-blue-800">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="excluirItem('honorario', ${honorario.id})" class="text-red-600 hover:text-red-800 ml-2">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarContratos() {
            const contratosAtivos = contratos.filter(c => c.status === 'ativo').length;
            const contratosSuspensos = contratos.filter(c => c.status === 'suspenso').length;
            const contratosTerminados = contratos.filter(c => c.status === 'terminado').length;
            const valorTotalContratos = contratos.reduce((sum, c) => {
                const valor = parseFloat(c.valor) || 0;
                return sum + valor;
            }, 0);

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <button onclick="abrirModal('contrato')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                            Novo Contrato
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${contratosAtivos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Suspensos</p>
                                    <p class="text-2xl font-bold text-gray-900">${contratosSuspensos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Terminados</p>
                                    <p class="text-2xl font-bold text-gray-900">${contratosTerminados}</p>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${Math.round(valorTotalContratos * 100) / 100}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaContratos" placeholder="Buscar contratos..." 
                                   class="search-input" onkeyup="filtrarContratos()">
                        </div>
                        
                        <!-- Filtros Avan√ßados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusContrato" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosContratos()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Conclu√≠do</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                                <select id="filtroClienteContrato" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosContratos()">
                                    <option value="">Todos os clientes</option>
                                    ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIF</label>
                                <input type="text" id="filtroNifContrato" placeholder="Buscar por NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosContratos()">
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosContratos()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorContratos">0</span> contratos encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="p-6">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th class="font-bold">Cliente</th>
                                            <th class="font-bold">Tipo</th>
                                            <th class="font-bold">Descri√ß√£o</th>
                                            <th class="font-bold">Valor</th>
                                            <th class="font-bold">Status</th>
                                            <th class="font-bold">Data In√≠cio</th>
                                            <th class="font-bold">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaContratos">
                                        ${contratos.map(contrato => `
                                            <tr>
                                                <td>${contrato.clienteNome}</td>
                                                <td>${contrato.tipo}</td>
                                                <td>${contrato.descricao}</td>
                                                <td>
                                                    <div class="flex flex-col">
                                                        <div class="text-sm font-medium text-gray-900">‚Ç¨${(Math.round((parseFloat(contrato.valor) || 0) * 100) / 100).toFixed(2)}</div>
                                                        <div class="text-xs text-gray-500">
                                                            <span class="text-gray-400">+ ${contrato.iva || 0}% IVA:</span>
                                                            <span class="font-medium text-gray-700">‚Ç¨${(Math.round((parseFloat(contrato.valorTotal || contrato.valor) || 0) * 100) / 100).toFixed(2)}</span>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td><span class="status-badge status-${contrato.status}">${contrato.status === 'concluido' ? 'Conclu√≠do' : contrato.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span></td>
                                                <td>${new Date(contrato.dataInicio).toLocaleDateString('pt-PT')}</td>
                                                <td>
                                                    <button onclick="editarContratoDireto(${contrato.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="abrirAnexosContrato(${contrato.id})" class="text-green-600 hover:text-green-800 mr-2" title="Documentos">
                                                        <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="excluirContratoDireto(${contrato.id})" class="text-red-600 hover:text-red-800" title="Excluir">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarPrazos() {
            const prazosAtivos = prazos.filter(p => p.status === 'ativo').length;
            const prazosVencidos = prazos.filter(p => p.status === 'vencido').length;
            const prazosUrgentes = prazos.filter(p => p.prioridade === 'alta' || p.prioridade === 'critica').length;
            const prazosHoje = prazos.filter(p => {
                try {
                    if (!p.dataLimite) return false;
                    const hoje = new Date().toISOString().split('T')[0];
                    const dataLimite = new Date(p.dataLimite).toISOString().split('T')[0];
                    return dataLimite === hoje && p.status === 'ativo';
                } catch (error) {
                    console.warn('Erro ao processar data do prazo:', p.dataLimite);
                    return false;
                }
            }).length;

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600 bg-blue-50 px-3 py-2 rounded-lg">
                            <i data-lucide="info" class="w-4 h-4 inline mr-2"></i>
                            Prazos criados automaticamente pelas √°reas de execu√ß√£o
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="clock" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosAtivos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Vencidos</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosVencidos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-orange-100 rounded-lg">
                                    <i data-lucide="zap" class="w-6 h-6 text-orange-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Urgentes</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosUrgentes}</p>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="calendar" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Hoje</p>
                                    <p class="text-2xl font-bold text-gray-900">${prazosHoje}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informa√ß√£o sobre prazos autom√°ticos -->
                    <div class="card p-6 bg-blue-50 border-l-4 border-blue-400">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i data-lucide="clock" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-blue-800">Prazos Autom√°ticos</h3>
                                <div class="mt-2 text-sm text-blue-700">
                                    <p>Os prazos s√£o criados automaticamente quando voc√™ adiciona itens nas √°reas de execu√ß√£o:</p>
                                    <ul class="mt-2 list-disc list-inside space-y-1">
                                        <li><strong>Contratos:</strong> Prazo de 30 dias</li>
                                        <li><strong>Heran√ßas:</strong> Prazo de 60 dias</li>
                                        <li><strong>Migra√ß√£o:</strong> Prazo de 90 dias</li>
                                        <li><strong>Registos:</strong> Prazo de 15 dias</li>
                                    </ul>
                                    <p class="mt-2 text-xs text-blue-600">Voc√™ pode editar ou excluir prazos conforme necess√°rio.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaPrazos" placeholder="Buscar prazos..." 
                                   class="search-input" onkeyup="filtrarPrazos()">
                        </div>
                        
                        <!-- Filtros Avan√ßados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Conclu√≠do</option>
                                    <option value="vencido">Vencido</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="filtroTipoPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                                    <option value="">Todos os tipos</option>
                                    <option value="contrato">Contrato</option>
                                    <option value="heranca">Heran√ßa</option>
                                    <option value="migracao">Migra√ß√£o</option>
                                    <option value="registo">Registo</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                                <select id="filtroVencimentoPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                                    <option value="">Todas as datas</option>
                                    <option value="hoje">Vence hoje</option>
                                    <option value="semana">Esta semana</option>
                                    <option value="mes">Este m√™s</option>
                                    <option value="vencido">Vencidos</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                <select id="filtroPrioridadePrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                                    <option value="">Todas as prioridades</option>
                                    <option value="baixa">Baixa</option>
                                    <option value="media">M√©dia</option>
                                    <option value="alta">Alta</option>
                                    <option value="urgente">Urgente</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosPrazos()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorPrazos">0</span> prazos encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="p-6">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Tipo</th>
                                            <th>Descri√ß√£o</th>
                                            <th>Data Limite</th>
                                            <th>Prioridade</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaPrazos">
                                        ${prazos.map(prazo => `
                                            <tr>
                                                <td>${prazo.clienteNome}</td>
                                                <td>${prazo.tipo}</td>
                                                <td>${prazo.descricao}</td>
                                                <td>${prazo.dataLimite ? new Date(prazo.dataLimite).toLocaleDateString('pt-PT') : 'Data n√£o definida'}</td>
                                                <td><span class="status-badge status-${prazo.prioridade}">${prazo.prioridade}</span></td>
                                                <td><span class="status-badge status-${prazo.status}">${prazo.status}</span></td>
                                                <td>
                                                    <button onclick="editarItem('prazo', ${prazo.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="abrirAnexosPrazo(${prazo.id})" class="text-green-600 hover:text-green-800 mr-2">
                                                        <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="excluirItem('prazo', ${prazo.id})" class="text-red-600 hover:text-red-800">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarNotificacoes() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const convidadoId = localStorage.getItem('convidadoId');
            
            // Filtrar notifica√ß√µes baseado no tipo de usu√°rio
            let notificacoesFiltradas = notificacoes;
            
            if (tipoUsuario === 'convidado') {
                // Para convidados: apenas notifica√ß√µes direcionadas a eles
                notificacoesFiltradas = notificacoes.filter(n => 
                    n.destinatarioId === parseInt(convidadoId) || 
                    n.destinatarioId === 'todos' ||
                    n.tipo === 'cliente_autorizado' ||
                    n.tipo === 'documento_anexado' ||
                    n.tipo === 'prazo_proximo'
                );
            }
            
            const notificacoesNaoLidas = notificacoesFiltradas.filter(n => !n.lida).length;
            const notificacoesHoje = notificacoesFiltradas.filter(n => {
                try {
                    if (!n.dataCriacao) return false;
                    const hoje = new Date().toISOString().split('T')[0];
                    const dataNotificacao = new Date(n.dataCriacao).toISOString().split('T')[0];
                    return dataNotificacao === hoje;
                } catch (error) {
                    console.warn('Erro ao processar data da notifica√ß√£o:', n.dataCriacao);
                    return false;
                }
            }).length;

            return `
                <div class="space-y-6">
            <div class="flex justify-between items-center">
                <div class="flex space-x-3">
                    ${tipoUsuario === 'admin' ? `
                        <button onclick="criarNotificacaoTeste()" class="btn btn-info">
                            <i data-lucide="test-tube" class="w-4 h-4"></i>
                            Teste Aleat√≥rio
                        </button>
                        <button onclick="criarNotificacaoPersonalizada()" class="btn btn-warning">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                            Criar Personalizada
                        </button>
                        <button onclick="enviarMensagemConvidado()" class="btn btn-primary">
                            <i data-lucide="send" class="w-4 h-4"></i>
                            Enviar para Convidado
                        </button>
                        <button onclick="verConversas()" class="btn btn-info">
                            <i data-lucide="message-circle" class="w-4 h-4"></i>
                            Ver Conversas
                        </button>
                    ` : `
                        <div class="text-sm text-gray-600">
                            <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                            Suas notifica√ß√µes autom√°ticas e mensagens do administrador
                        </div>
                    `}
                </div>
                <div class="flex space-x-3">
                    <button onclick="marcarTodasComoLidas()" class="btn btn-secondary">
                        <i data-lucide="check" class="w-4 h-4"></i>
                        Marcar Todas como Lidas
                    </button>
                    ${tipoUsuario === 'admin' ? `
                        <button onclick="limparNotificacoes()" class="btn btn-error">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            Limpar Todas
                        </button>
                    ` : ''}
                </div>
            </div>
            
            <!-- Filtros Inteligentes -->
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Filtros Inteligentes</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                        <select id="filtroPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosNotificacoes()">
                            <option value="">Todas as prioridades</option>
                            <option value="alta">Alta</option>
                            <option value="media">M√©dia</option>
                            <option value="baixa">Baixa</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                        <select id="filtroTipo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosNotificacoes()">
                            <option value="">Todos os tipos</option>
                            <option value="mensagem_admin">Mensagem do Admin</option>
                            <option value="resposta_convidado">Resposta do Convidado</option>
                            <option value="cliente_autorizado">Cliente Autorizado</option>
                            <option value="documento_anexado">Documento Anexado</option>
                            <option value="prazo_proximo">Prazo Pr√≥ximo</option>
                            <option value="honorario">Honor√°rio</option>
                            <option value="prazo">Prazo</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="filtroStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosNotificacoes()">
                            <option value="">Todas</option>
                            <option value="nao_lida">N√£o Lidas</option>
                            <option value="lida">Lidas</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Per√≠odo</label>
                        <select id="filtroPeriodo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosNotificacoes()">
                            <option value="">Todos</option>
                            <option value="hoje">Hoje</option>
                            <option value="semana">Esta Semana</option>
                            <option value="mes">Este M√™s</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-4">
                    <button onclick="limparFiltrosNotificacoes()" class="btn btn-secondary">
                        <i data-lucide="x" class="w-4 h-4"></i>
                        Limpar Filtros
                    </button>
                    <div class="text-sm text-gray-600">
                        <span id="contadorFiltros">${notificacoesFiltradas.length} notifica√ß√µes encontradas</span>
                    </div>
                </div>
            </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <i data-lucide="bell" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">N√£o Lidas</p>
                                    <p class="text-2xl font-bold text-gray-900">${notificacoesNaoLidas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="calendar" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Hoje</p>
                                    <p class="text-2xl font-bold text-gray-900">${notificacoesHoje}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total</p>
                                    <p class="text-2xl font-bold text-gray-900">${notificacoesFiltradas.length}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        ${notificacoesFiltradas.length === 0 ? `
                            <div class="card p-8 text-center">
                                <i data-lucide="bell-off" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                                <h3 class="text-lg font-semibold text-gray-600 mb-2">Nenhuma notifica√ß√£o</h3>
                                <p class="text-gray-500">Voc√™ est√° em dia! N√£o h√° notifica√ß√µes pendentes.</p>
                            </div>
                        ` : notificacoesFiltradas.map(notificacao => `
                            <div class="card p-4 ${notificacao.lida ? 'opacity-60' : 'border-l-4 border-blue-500'}">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="status-badge status-${notificacao.tipo}">${notificacao.tipo}</span>
                                            ${notificacao.prioridade === 'alta' ? '<span class="status-badge status-alta">Urgente</span>' : ''}
                                            ${notificacao.origem === 'admin' ? '<span class="status-badge status-info">Admin</span>' : ''}
                                            ${notificacao.origem === 'convidado' ? '<span class="status-badge status-success">Convidado</span>' : ''}
                                        </div>
                                        <h4 class="font-semibold text-gray-800">${notificacao.titulo}</h4>
                                        <p class="text-gray-600 text-sm mt-1">${notificacao.mensagem}</p>
                                        <p class="text-gray-400 text-xs mt-2">${notificacao.dataCriacao ? new Date(notificacao.dataCriacao).toLocaleString('pt-PT') : 'Data n√£o dispon√≠vel'}</p>
                                        
                                        ${notificacao.origem === 'admin' && tipoUsuario === 'convidado' ? `
                                            <div class="mt-3 pt-3 border-t border-gray-200">
                                                <button onclick="responderMensagem(${notificacao.id})" class="btn btn-sm btn-primary">
                                                    <i data-lucide="reply" class="w-4 h-4"></i>
                                                    Responder
                                                </button>
                                            </div>
                                        ` : ''}
                                        
                                        ${notificacao.respostas && notificacao.respostas.length > 0 ? `
                                            <div class="mt-3">
                                                <h5 class="text-sm font-medium text-gray-700 mb-2">Respostas (${notificacao.respostas.length})</h5>
                                                ${notificacao.respostas.map(resposta => `
                                                    <div class="bg-gray-50 p-3 rounded-lg mb-2">
                                                        <div class="flex items-center justify-between mb-1">
                                                            <span class="text-xs font-medium text-gray-600">${resposta.origem === 'admin' ? 'Admin' : 'Voc√™'}</span>
                                                            <span class="text-xs text-gray-400">${new Date(resposta.dataCriacao).toLocaleString('pt-PT')}</span>
                                                        </div>
                                                        <p class="text-sm text-gray-800">${resposta.mensagem}</p>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        ${!notificacao.lida ? `
                                            <button onclick="marcarComoLida(${notificacao.id})" class="text-blue-600 hover:text-blue-800">
                                                <i data-lucide="check" class="w-4 h-4"></i>
                                            </button>
                                        ` : ''}
                                        <button onclick="excluirNotificacao(${notificacao.id})" class="text-red-600 hover:text-red-800">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function gerarRelatorios() {
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Relat√≥rios</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Relat√≥rio de Clientes</h3>
                            <p class="text-gray-600 mb-4">Relat√≥rio completo de clientes cadastrados</p>
                            <button onclick="gerarRelatorioClientes()" class="btn btn-info">
                                <i data-lucide="users" class="w-4 h-4"></i>
                                Gerar
                            </button>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Relat√≥rio Financeiro</h3>
                            <p class="text-gray-600 mb-4">Relat√≥rio de honor√°rios e receitas</p>
                            <button onclick="gerarRelatorioFinanceiro()" class="btn btn-success">
                                <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                                Gerar
                            </button>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Relat√≥rio Geral</h3>
                            <p class="text-gray-600 mb-4">Relat√≥rio completo do sistema</p>
                            <button onclick="gerarRelatorioCompleto()" class="btn btn-primary">
                                <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                                Gerar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function inicializarSecao(secao) {
            lucide.createIcons();
            
            if (secao === 'dashboard') {
                setTimeout(() => {
                    criarGraficoHonorarios();
                }, 100);
            }
        }

        function criarGraficoHonorarios() {
            const ctx = document.getElementById('chartHonorarios');
            if (!ctx) return;

            const honorariosPagos = honorarios.filter(h => h.status === 'pago').length;
            const honorariosPendentes = honorarios.filter(h => h.status === 'pendente').length;
            const honorariosVencidos = honorarios.filter(h => h.status === 'vencido').length;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pagos', 'Pendentes', 'Vencidos'],
                    datasets: [{
                        data: [honorariosPagos, honorariosPendentes, honorariosVencidos],
                        backgroundColor: [
                            '#10b981',
                            '#f59e0b',
                            '#ef4444'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function abrirModal(tipo) {
            const modal = criarModal(tipo);
            document.getElementById('modalContainer').innerHTML = modal;
            document.getElementById('modalContainer').classList.add('show');
            lucide.createIcons();
        }

        function abrirModalEdicaoCliente(cliente) {
            const modal = criarModalEdicaoCliente(cliente);
            document.getElementById('modalContainer').innerHTML = modal;
            document.getElementById('modalContainer').classList.add('show');
            lucide.createIcons();
        }

        function abrirModalEdicaoContrato(contrato) {
            console.log('üîß abrirModalEdicaoContrato chamado com:', contrato);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoContrato';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = fecharModal;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Contrato</h3>
                            <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form onsubmit="atualizarContrato(event, ${contrato.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="editarContratoCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `
                                            <option value="${cliente.id}" data-nome="${cliente.nome}" ${cliente.id === contrato.clienteId ? 'selected' : ''}>${cliente.nome}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Servi√ßo *</label>
                                    <select id="editarContratoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Altera√ß√£o de pactos sociais" ${contrato.tipo === 'Altera√ß√£o de pactos sociais' ? 'selected' : ''}>Altera√ß√£o de pactos sociais</option>
                                        <option value="An√°lise e revis√£o de contratos" ${contrato.tipo === 'An√°lise e revis√£o de contratos' ? 'selected' : ''}>An√°lise e revis√£o de contratos</option>
                                        <option value="Cess√£o de quotas" ${contrato.tipo === 'Cess√£o de quotas' ? 'selected' : ''}>Cess√£o de quotas</option>
                                        <option value="Constitui√ß√£o de sociedades" ${contrato.tipo === 'Constitui√ß√£o de sociedades' ? 'selected' : ''}>Constitui√ß√£o de sociedades</option>
                                        <option value="Contratos de arrendamento" ${contrato.tipo === 'Contratos de arrendamento' ? 'selected' : ''}>Contratos de arrendamento</option>
                                        <option value="Contratos de compra e venda" ${contrato.tipo === 'Contratos de compra e venda' ? 'selected' : ''}>Contratos de compra e venda</option>
                                        <option value="Contratos de presta√ß√£o de servi√ßos" ${contrato.tipo === 'Contratos de presta√ß√£o de servi√ßos' ? 'selected' : ''}>Contratos de presta√ß√£o de servi√ßos</option>
                                        <option value="Contratos de trabalho" ${contrato.tipo === 'Contratos de trabalho' ? 'selected' : ''}>Contratos de trabalho</option>
                                        <option value="Pactos sociais" ${contrato.tipo === 'Pactos sociais' ? 'selected' : ''}>Pactos sociais</option>
                                        <option value="Consultoria" ${contrato.tipo === 'Consultoria' ? 'selected' : ''}>Consultoria</option>
                                        <option value="Assessoria" ${contrato.tipo === 'Assessoria' ? 'selected' : ''}>Assessoria</option>
                                        <option value="Representa√ß√£o" ${contrato.tipo === 'Representa√ß√£o' ? 'selected' : ''}>Representa√ß√£o</option>
                                        <option value="Outro" ${contrato.tipo === 'Outro' ? 'selected' : ''}>Outro</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o *</label>
                                    <textarea id="editarContratoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descreva os servi√ßos a serem prestados...">${contrato.descricao || ''}</textarea>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="editarContratoValor" step="0.01" value="${contrato.valor || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="editarContratoIVA" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0" ${contrato.iva === 0 ? 'selected' : ''}>0% (Isento)</option>
                                            <option value="6" ${contrato.iva === 6 ? 'selected' : ''}>6% (Reduzida)</option>
                                            <option value="13" ${contrato.iva === 13 ? 'selected' : ''}>13% (Interm√©dia)</option>
                                            <option value="23" ${contrato.iva === 23 ? 'selected' : ''}>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="editarContratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente" ${contrato.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                            <option value="em_andamento" ${contrato.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                            <option value="concluido" ${contrato.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de In√≠cio *</label>
                                        <input type="date" id="editarContratoDataInicio" value="${contrato.dataInicio || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                    <textarea id="editarContratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observa√ß√µes adicionais sobre o contrato...">${contrato.observacoes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Altera√ß√µes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Adicionar ao body
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('‚úÖ Modal de edi√ß√£o de contrato criado e adicionado ao body!');
        }

        function fecharModal() {
            console.log('üîß fecharModal chamado');
            
            // Limpar modalContainer
            const modalContainer = document.getElementById('modalContainer');
            if (modalContainer) {
                modalContainer.classList.remove('show');
                modalContainer.innerHTML = '';
                console.log('‚úÖ modalContainer limpo');
            }
            
            // Remover qualquer modal que possa estar no body
            const modalsNoBody = document.querySelectorAll('.fixed.inset-0');
            modalsNoBody.forEach(modal => {
                console.log('üîß Removendo modal do body:', modal.id);
                modal.remove();
            });
            
            // Remover modais espec√≠ficos
            const modalHeranca = document.getElementById('modalEdicaoHeranca');
            if (modalHeranca) {
                console.log('üîß Removendo modalEdicaoHeranca');
                modalHeranca.remove();
            }
            
            const modalMigracao = document.getElementById('modalEdicaoMigracao');
            if (modalMigracao) {
                console.log('üîß Removendo modalEdicaoMigracao');
                modalMigracao.remove();
            }
            
            const modalRegisto = document.getElementById('modalEdicaoRegisto');
            if (modalRegisto) {
                console.log('üîß Removendo modalEdicaoRegisto');
                modalRegisto.remove();
            }
            
            // Remover qualquer modal de edi√ß√£o
            const modaisEdicao = document.querySelectorAll('[id^="modalEdicao"]');
            modaisEdicao.forEach(modal => {
                console.log('üîß Removendo modal de edi√ß√£o:', modal.id);
                modal.remove();
            });
            
            console.log('‚úÖ fecharModal conclu√≠do');
        }

        function criarModal(tipo) {
            const modais = {
                cliente: criarModalCliente(),
                honorario: criarModalHonorario(),
                contrato: criarModalContrato(),
                migracao: criarModalMigracao()
            };
            return modais[tipo] || '<div class="modal-content p-6">Modal n√£o encontrado</div>';
        }

        function criarModalEdicaoCliente(cliente) {
            return `
                <div class="modal show" onclick="fecharModal()">
                    <div class="modal-content p-6" style="max-width: 500px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Editar Cliente</h3>
                            <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formEditarCliente" onsubmit="atualizarCliente(event, ${cliente.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                                    <input type="text" id="editarClienteNome" value="${cliente.nome}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                    <input type="email" id="editarClienteEmail" value="${cliente.email}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                                    <input type="tel" id="editarClienteTelefone" value="${cliente.telefone}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NIF *</label>
                                    <input type="text" id="editarClienteNIF" value="${cliente.nif || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="123456789">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Endere√ßo</label>
                                    <textarea id="editarClienteEndereco" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${cliente.endereco || ''}</textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="editarClienteStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="ativo" ${cliente.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                        <option value="inativo" ${cliente.status === 'inativo' ? 'selected' : ''}>Inativo</option>
                                        <option value="suspenso" ${cliente.status === 'suspenso' ? 'selected' : ''}>Suspenso</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-between mt-6">
                                <div class="flex space-x-3">
                                    <button type="button" onclick="excluirCliente(${cliente.id})" class="btn btn-error">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        Excluir
                                    </button>
                                </div>
                                <div class="flex space-x-3">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i data-lucide="save" class="w-4 h-4"></i>
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function criarModalCliente() {
            return `
                <div class="modal show" onclick="fecharModal()">
                    <div class="modal-content p-6" style="max-width: 500px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Novo Cliente</h3>
                            <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formCliente" onsubmit="salvarCliente(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                                    <input type="text" id="clienteNome" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                    <input type="email" id="clienteEmail" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                                    <input type="tel" id="clienteTelefone" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NIF *</label>
                                    <input type="text" id="clienteNIF" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="123456789">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Endere√ßo</label>
                                    <textarea id="clienteEndereco" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="clienteStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="ativo">Ativo</option>
                                        <option value="inativo">Inativo</option>
                                        <option value="suspenso">Suspenso</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Cliente
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function criarModalHonorario() {
            return `
                <div class="modal show">
                    <div class="modal-content p-6" style="max-width: 500px;">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Novo Honor√°rio</h3>
                            <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formHonorario" onsubmit="salvarHonorario(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="honorarioCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `
                                            <option value="${cliente.nome}">${cliente.nome}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Servi√ßo *</label>
                                    <input type="text" id="honorarioServico" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                    <input type="number" id="honorarioValor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="honorarioStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="pendente">Pendente</option>
                                        <option value="pago">Pago</option>
                                        <option value="vencido">Vencido</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                                    <input type="date" id="honorarioVencimento" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Honor√°rio
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function criarModalContrato() {
            return `
                <div class="modal show" onclick="fecharModal()">
                    <div class="modal-content p-6" style="max-width: 600px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Novo Contrato</h3>
                            <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formContrato" onsubmit="salvarContrato(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="contratoCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `
                                            <option value="${cliente.id}" data-nome="${cliente.nome}">${cliente.nome}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Servi√ßo *</label>
                                    <select id="contratoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Altera√ß√£o de pactos sociais">Altera√ß√£o de pactos sociais</option>
                                        <option value="An√°lise e revis√£o de contratos">An√°lise e revis√£o de contratos</option>
                                        <option value="Cess√£o de quotas">Cess√£o de quotas</option>
                                        <option value="Constitui√ß√£o de sociedades">Constitui√ß√£o de sociedades</option>
                                        <option value="Contratos de arrendamento">Contratos de arrendamento</option>
                                        <option value="Contratos de compra e venda">Contratos de compra e venda</option>
                                        <option value="Contratos de presta√ß√£o de servi√ßos">Contratos de presta√ß√£o de servi√ßos</option>
                                        <option value="Contratos de trabalho">Contratos de trabalho</option>
                                        <option value="Pactos sociais">Pactos sociais</option>
                                        <option value="Consultoria">Consultoria</option>
                                        <option value="Assessoria">Assessoria</option>
                                        <option value="Representa√ß√£o">Representa√ß√£o</option>
                                        <option value="Outro">Outro</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="contratoValor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="contratoIVA" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0">0% (Isento)</option>
                                            <option value="6">6% (Reduzida)</option>
                                            <option value="13">13% (Interm√©dia)</option>
                                            <option value="23" selected>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                        <select id="contratoParceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('contrato')">
                                            <option value="sem">Sem parceria</option>
                                            <option value="empresa">Empresa</option>
                                            <option value="pessoa">Pessoa</option>
                                        </select>
                                    </div>
                                    
                                    <div id="contratoParceriaNomeDiv" style="display: none;">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                        <input type="text" id="contratoParceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                        <input type="number" id="contratoPercentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="contratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente">Pendente</option>
                                            <option value="em_andamento">Em Andamento</option>
                                            <option value="concluido">Conclu√≠do</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de In√≠cio *</label>
                                        <input type="date" id="contratoDataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                    <textarea id="contratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observa√ß√µes adicionais sobre o contrato..."></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Contrato
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function criarModalEdicaoContrato(contrato) {
            return `
                <div class="modal show" onclick="fecharModal()">
                    <div class="modal-content p-6" style="max-width: 600px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Editar Contrato</h3>
                            <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formEditarContrato" onsubmit="atualizarContrato(event, ${contrato.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="editarContratoCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `
                                            <option value="${cliente.id}" data-nome="${cliente.nome}" ${cliente.id === contrato.clienteId ? 'selected' : ''}>${cliente.nome}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Servi√ßo *</label>
                                    <select id="editarContratoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Altera√ß√£o de pactos sociais" ${contrato.tipo === 'Altera√ß√£o de pactos sociais' ? 'selected' : ''}>Altera√ß√£o de pactos sociais</option>
                                        <option value="An√°lise e revis√£o de contratos" ${contrato.tipo === 'An√°lise e revis√£o de contratos' ? 'selected' : ''}>An√°lise e revis√£o de contratos</option>
                                        <option value="Cess√£o de quotas" ${contrato.tipo === 'Cess√£o de quotas' ? 'selected' : ''}>Cess√£o de quotas</option>
                                        <option value="Constitui√ß√£o de sociedades" ${contrato.tipo === 'Constitui√ß√£o de sociedades' ? 'selected' : ''}>Constitui√ß√£o de sociedades</option>
                                        <option value="Contratos de arrendamento" ${contrato.tipo === 'Contratos de arrendamento' ? 'selected' : ''}>Contratos de arrendamento</option>
                                        <option value="Contratos de compra e venda" ${contrato.tipo === 'Contratos de compra e venda' ? 'selected' : ''}>Contratos de compra e venda</option>
                                        <option value="Contratos de presta√ß√£o de servi√ßos" ${contrato.tipo === 'Contratos de presta√ß√£o de servi√ßos' ? 'selected' : ''}>Contratos de presta√ß√£o de servi√ßos</option>
                                        <option value="Contratos de trabalho" ${contrato.tipo === 'Contratos de trabalho' ? 'selected' : ''}>Contratos de trabalho</option>
                                        <option value="Pactos sociais" ${contrato.tipo === 'Pactos sociais' ? 'selected' : ''}>Pactos sociais</option>
                                        <option value="Consultoria" ${contrato.tipo === 'Consultoria' ? 'selected' : ''}>Consultoria</option>
                                        <option value="Assessoria" ${contrato.tipo === 'Assessoria' ? 'selected' : ''}>Assessoria</option>
                                        <option value="Representa√ß√£o" ${contrato.tipo === 'Representa√ß√£o' ? 'selected' : ''}>Representa√ß√£o</option>
                                        <option value="Outro" ${contrato.tipo === 'Outro' ? 'selected' : ''}>Outro</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o *</label>
                                    <textarea id="editarContratoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descreva os servi√ßos a serem prestados...">${contrato.descricao || ''}</textarea>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="editarContratoValor" step="0.01" value="${contrato.valor || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="editarContratoIVA" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0" ${contrato.iva === 0 ? 'selected' : ''}>0% (Isento)</option>
                                            <option value="6" ${contrato.iva === 6 ? 'selected' : ''}>6% (Reduzida)</option>
                                            <option value="13" ${contrato.iva === 13 ? 'selected' : ''}>13% (Interm√©dia)</option>
                                            <option value="23" ${contrato.iva === 23 ? 'selected' : ''}>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="editarContratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="ativo" ${contrato.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                            <option value="suspenso" ${contrato.status === 'suspenso' ? 'selected' : ''}>Suspenso</option>
                                            <option value="terminado" ${contrato.status === 'terminado' ? 'selected' : ''}>Terminado</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de In√≠cio *</label>
                                        <input type="date" id="editarContratoDataInicio" value="${contrato.dataInicio || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                    <textarea id="editarContratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observa√ß√µes adicionais sobre o contrato...">${contrato.observacoes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-between mt-6">
                                <div class="flex space-x-3">
                                    <button type="button" onclick="excluirContrato(${contrato.id})" class="btn btn-error">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        Excluir
                                    </button>
                                </div>
                                <div class="flex space-x-3">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i data-lucide="save" class="w-4 h-4"></i>
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function salvarCliente(event) {
            event.preventDefault();
            
            console.log('üîß salvarCliente chamado');
            console.log('üîß clientes antes:', clientes.length);
            
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const convidadoId = localStorage.getItem('convidadoId');
            
            // Validar dados √∫nicos
            const nome = document.getElementById('clienteNome').value;
            const email = document.getElementById('clienteEmail').value;
            const telefone = document.getElementById('clienteTelefone').value;
            const nif = document.getElementById('clienteNIF').value;
            
            // Verificar se j√° existe cliente com os mesmos dados
            const clienteExistente = clientes.find(c => 
                c.nome.toLowerCase() === nome.toLowerCase() ||
                (email && c.email && c.email.toLowerCase() === email.toLowerCase()) ||
                (telefone && c.telefone && c.telefone === telefone) ||
                (nif && c.nif && c.nif === nif)
            );
            
            if (clienteExistente) {
                let mensagemErro = 'J√° existe um cliente com:';
                if (clienteExistente.nome.toLowerCase() === nome.toLowerCase()) {
                    mensagemErro += ' ‚Ä¢ Nome igual';
                }
                if (email && clienteExistente.email && clienteExistente.email.toLowerCase() === email.toLowerCase()) {
                    mensagemErro += ' ‚Ä¢ Email igual';
                }
                if (telefone && clienteExistente.telefone && clienteExistente.telefone === telefone) {
                    mensagemErro += ' ‚Ä¢ Telefone igual';
                }
                if (nif && clienteExistente.nif && clienteExistente.nif === nif) {
                    mensagemErro += ' ‚Ä¢ NIF igual';
                }
                
                mostrarNotificacao(mensagemErro, 'error');
                return;
            }
            
            const cliente = {
                id: Date.now(),
                nome: nome,
                email: email,
                telefone: telefone,
                nif: nif,
                endereco: document.getElementById('clienteEndereco').value,
                status: document.getElementById('clienteStatus').value,
                dataCriacao: new Date().toISOString(),
                criadoPorConvidado: tipoUsuario === 'convidado' ? parseInt(convidadoId) : null
            };
            
            console.log('üîß Novo cliente criado:', cliente);
            
            clientes.push(cliente);
            console.log('üîß clientes ap√≥s push:', clientes.length);
            
            salvarDados('clientes', clientes);
            mostrarNotificacao('Cliente salvo com sucesso!', 'success');
            
            // Fechar modal imediatamente
            fecharModal();
            
            // Recarregar se√ß√£o ap√≥s um pequeno delay
            setTimeout(() => {
                console.log('üîß Recarregando se√ß√£o clientes...');
                carregarSecao('clientes');
            }, 100);
        }

        function salvarHonorario(event) {
            event.preventDefault();
            
            const honorario = {
                id: Date.now(),
                cliente: document.getElementById('honorarioCliente').value,
                servico: document.getElementById('honorarioServico').value,
                valor: parseFloat(document.getElementById('honorarioValor').value),
                status: document.getElementById('honorarioStatus').value,
                vencimento: document.getElementById('honorarioVencimento').value,
                dataCriacao: new Date().toISOString()
            };
            
            honorarios.push(honorario);
            salvarDados('honorarios', honorarios);
            mostrarNotificacao('Honor√°rio salvo com sucesso!', 'success');
            
            // Fechar modal imediatamente
            fecharModal();
            
            // Recarregar se√ß√£o ap√≥s um pequeno delay
            setTimeout(() => {
                carregarSecao('honorarios');
            }, 100);
        }

        function salvarContrato(event) {
            event.preventDefault();
            
            const clienteId = parseInt(document.getElementById('contratoCliente').value);
            const clienteSelecionado = clientes.find(c => c.id === clienteId);
            
            const valor = parseFloat(document.getElementById('contratoValor').value);
            const ivaPercent = parseFloat(document.getElementById('contratoIVA').value);
            const percentagem = parseFloat(document.getElementById('contratoPercentagem').value) || 0;
            const valorIVA = (valor * ivaPercent) / 100;
            const valorTotal = valor + valorIVA;

            const contrato = {
                id: Date.now(),
                clienteId: clienteId,
                clienteNome: clienteSelecionado ? clienteSelecionado.nome : '',
                tipo: document.getElementById('contratoTipo').value,
                valor: valor,
                iva: ivaPercent,
                percentagem: percentagem,
                valorIVA: valorIVA,
                valorTotal: valorTotal,
                status: document.getElementById('contratoStatus').value,
                dataInicio: document.getElementById('contratoDataInicio').value,
                observacoes: document.getElementById('contratoObservacoes').value,
                dataCriacao: new Date().toISOString()
            };
            
            contratos.push(contrato);
            salvarDados('contratos', contratos);
            
            // Criar prazo autom√°tico para o contrato
            const prazoContrato = {
                id: Date.now() + 1,
                clienteId: clienteId,
                clienteNome: clienteSelecionado ? clienteSelecionado.nome : '',
                descricao: `Prazo para ${contrato.tipo}`,
                dataLimite: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30 dias
                status: 'ativo',
                tipo: 'contrato',
                referenciaId: contrato.id,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoContrato);
            salvarDados('prazos', prazos);
            
            mostrarNotificacao('Contrato e prazo criados com sucesso!', 'success');
            
            // Fechar modal imediatamente
            fecharModal();
            
            // Recarregar se√ß√£o ap√≥s um pequeno delay
            setTimeout(() => {
                carregarSecao('contratos');
            }, 100);
        }

        function atualizarCliente(event, id) {
            event.preventDefault();
            
            const clienteIndex = clientes.findIndex(c => c.id === id);
            if (clienteIndex !== -1) {
                // Validar dados √∫nicos
                const nome = document.getElementById('editarClienteNome').value;
                const email = document.getElementById('editarClienteEmail').value;
                const telefone = document.getElementById('editarClienteTelefone').value;
                const nif = document.getElementById('editarClienteNIF').value;
                
                // Verificar se j√° existe outro cliente com os mesmos dados (excluindo o cliente atual)
                const clienteExistente = clientes.find(c => 
                    c.id !== id && (
                        c.nome.toLowerCase() === nome.toLowerCase() ||
                        (email && c.email && c.email.toLowerCase() === email.toLowerCase()) ||
                        (telefone && c.telefone && c.telefone === telefone) ||
                        (nif && c.nif && c.nif === nif)
                    )
                );
                
                if (clienteExistente) {
                    let mensagemErro = 'J√° existe outro cliente com:';
                    if (clienteExistente.nome.toLowerCase() === nome.toLowerCase()) {
                        mensagemErro += ' ‚Ä¢ Nome igual';
                    }
                    if (email && clienteExistente.email && clienteExistente.email.toLowerCase() === email.toLowerCase()) {
                        mensagemErro += ' ‚Ä¢ Email igual';
                    }
                    if (telefone && clienteExistente.telefone && clienteExistente.telefone === telefone) {
                        mensagemErro += ' ‚Ä¢ Telefone igual';
                    }
                    if (nif && clienteExistente.nif && clienteExistente.nif === nif) {
                        mensagemErro += ' ‚Ä¢ NIF igual';
                    }
                    
                    mostrarNotificacao(mensagemErro, 'error');
                    return;
                }
                
                clientes[clienteIndex] = {
                    ...clientes[clienteIndex],
                    nome: nome,
                    email: email,
                    telefone: telefone,
                    nif: nif,
                    endereco: document.getElementById('editarClienteEndereco').value,
                    status: document.getElementById('editarClienteStatus').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('clientes', clientes);
                mostrarNotificacao('Cliente atualizado com sucesso!', 'success');
                
                // Fechar modal imediatamente
                fecharModal();
                
                // Recarregar se√ß√£o ap√≥s um pequeno delay
                setTimeout(() => {
                    carregarSecao('clientes');
                }, 100);
            }
        }

        function excluirCliente(id) {
            if (confirm('Tem certeza que deseja excluir este cliente? Esta a√ß√£o n√£o pode ser desfeita.')) {
                clientes = clientes.filter(c => c.id !== id);
                salvarDados('clientes', clientes);
                mostrarNotificacao('Cliente exclu√≠do com sucesso!', 'success');
                
                // Fechar modal imediatamente
                fecharModal();
                
                // Recarregar se√ß√£o ap√≥s um pequeno delay
                setTimeout(() => {
                    carregarSecao('clientes');
                }, 100);
            }
        }

        function atualizarContrato(event, id) {
            console.log('üîß atualizarContrato chamado com ID:', id);
            event.preventDefault();
            
            const contratoIndex = contratos.findIndex(c => c.id === id);
            console.log('üîß Contrato encontrado no √≠ndice:', contratoIndex);
            
            if (contratoIndex !== -1) {
                const clienteId = parseInt(document.getElementById('editarContratoCliente').value);
                const clienteSelecionado = clientes.find(c => c.id === clienteId);
                console.log('üîß Cliente selecionado:', clienteSelecionado);
                
                const valor = parseFloat(document.getElementById('editarContratoValor').value);
                const ivaPercent = parseFloat(document.getElementById('editarContratoIVA').value);
                const valorIVA = (valor * ivaPercent) / 100;
                const valorTotal = valor + valorIVA;

                contratos[contratoIndex] = {
                    ...contratos[contratoIndex],
                    clienteId: clienteId,
                    clienteNome: clienteSelecionado ? clienteSelecionado.nome : '',
                    tipo: document.getElementById('editarContratoTipo').value,
                    descricao: document.getElementById('editarContratoDescricao').value,
                    valor: valor,
                    iva: ivaPercent,
                    valorIVA: valorIVA,
                    valorTotal: valorTotal,
                    status: document.getElementById('editarContratoStatus').value,
                    dataInicio: document.getElementById('editarContratoDataInicio').value,
                    observacoes: document.getElementById('editarContratoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                console.log('üîß Contrato atualizado:', contratos[contratoIndex]);
                salvarDados('contratos', contratos);
                mostrarNotificacao('Contrato atualizado com sucesso!', 'success');
                
                // Fechar modal imediatamente
                fecharModal();
                
                // Recarregar se√ß√£o ap√≥s um pequeno delay
                setTimeout(() => {
                    carregarSecao('contratos');
                }, 100);
            } else {
                console.error('‚ùå Contrato n√£o encontrado com ID:', id);
                mostrarNotificacao('Contrato n√£o encontrado!', 'error');
            }
        }

        function excluirContrato(id) {
            if (confirm('Tem certeza que deseja excluir este contrato? Esta a√ß√£o n√£o pode ser desfeita.')) {
                contratos = contratos.filter(c => c.id !== id);
                salvarDados('contratos', contratos);
                mostrarNotificacao('Contrato exclu√≠do com sucesso!', 'success');
                
                // Fechar modal imediatamente
                fecharModal();
                
                // Recarregar se√ß√£o ap√≥s um pequeno delay
                setTimeout(() => {
                    carregarSecao('contratos');
                }, 100);
            }
        }

        function filtrarClientes() {
            aplicarFiltrosClientes();
        }

        function aplicarFiltrosClientes() {
            const busca = document.getElementById('buscaClientes')?.value.toLowerCase() || '';
            const buscaNif = document.getElementById('buscaNifClientes')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusCliente')?.value || '';
            const dataFiltro = document.getElementById('filtroDataCliente')?.value || '';
            
            const clientesFiltrados = clientes.filter(cliente => {
                // Filtro por busca de texto (nome, email, telefone)
                const matchBusca = !busca || 
                    cliente.nome.toLowerCase().includes(busca) || 
                    cliente.email.toLowerCase().includes(busca) ||
                    cliente.telefone.toLowerCase().includes(busca);
                
                // Filtro por NIF
                const matchNif = !buscaNif || 
                    (cliente.nif && cliente.nif.toLowerCase().includes(buscaNif));
                
                // Filtro por status
                const matchStatus = !status || cliente.status === status;
                
                // Filtro por data
                let matchData = true;
                if (dataFiltro) {
                    const dataCliente = new Date(cliente.dataCriacao);
                    const hoje = new Date();
                    
                    switch (dataFiltro) {
                        case 'hoje':
                            matchData = dataCliente.toDateString() === hoje.toDateString();
                            break;
                        case 'semana':
                            const inicioSemana = new Date(hoje);
                            inicioSemana.setDate(hoje.getDate() - hoje.getDay());
                            matchData = dataCliente >= inicioSemana;
                            break;
                        case 'mes':
                            matchData = dataCliente.getMonth() === hoje.getMonth() && 
                                        dataCliente.getFullYear() === hoje.getFullYear();
                            break;
                        case 'ano':
                            matchData = dataCliente.getFullYear() === hoje.getFullYear();
                            break;
                    }
                }
                
                return matchBusca && matchNif && matchStatus && matchData;
            });
            
            atualizarListaClientes(clientesFiltrados);
            document.getElementById('contadorClientes').textContent = clientesFiltrados.length;
        }

        function limparFiltrosClientes() {
            document.getElementById('buscaClientes').value = '';
            document.getElementById('buscaNifClientes').value = '';
            document.getElementById('filtroStatusCliente').value = '';
            document.getElementById('filtroDataCliente').value = '';
            aplicarFiltrosClientes();
        }

        function filtrarHonorarios() {
            aplicarFiltrosHonorarios();
        }

        function aplicarFiltrosHonorarios() {
            console.log('üîß aplicarFiltrosHonorarios chamado');
            const busca = document.getElementById('buscaHonorarios')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusHonorario')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinHonorario')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxHonorario')?.value) || Infinity;
            const vencimento = document.getElementById('filtroVencimentoHonorario')?.value || '';
            
            console.log('üîß Filtros aplicados:', { busca, status, valorMin, valorMax, vencimento });
            console.log('üîß Total de honor√°rios:', honorarios.length);
            
            const honorariosFiltrados = honorarios.filter(honorario => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    honorario.cliente.toLowerCase().includes(busca) || 
                    honorario.servico.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || honorario.status === status;
                
                // Filtro por valor
                const valor = parseFloat(honorario.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                // Filtro por vencimento
                let matchVencimento = true;
                if (vencimento && honorario.vencimento) {
                    const dataVencimento = new Date(honorario.vencimento);
                    const hoje = new Date();
                    
                    switch (vencimento) {
                        case 'hoje':
                            matchVencimento = dataVencimento.toDateString() === hoje.toDateString();
                            break;
                        case 'semana':
                            const fimSemana = new Date(hoje);
                            fimSemana.setDate(hoje.getDate() + 7);
                            matchVencimento = dataVencimento >= hoje && dataVencimento <= fimSemana;
                            break;
                        case 'mes':
                            const fimMes = new Date(hoje);
                            fimMes.setMonth(hoje.getMonth() + 1);
                            matchVencimento = dataVencimento >= hoje && dataVencimento <= fimMes;
                            break;
                        case 'vencido':
                            matchVencimento = dataVencimento < hoje;
                            break;
                    }
                }
                
                return matchBusca && matchStatus && matchValor && matchVencimento;
            });
            
            console.log('üîß Honor√°rios filtrados:', honorariosFiltrados.length);
            atualizarListaHonorarios(honorariosFiltrados);
            
            const contador = document.getElementById('contadorHonorarios');
            if (contador) {
                contador.textContent = honorariosFiltrados.length;
            }
            
            // Reinicializar √≠cones Lucide ap√≥s aplicar filtros
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('üîß √çcones Lucide reinicializados para Honor√°rios');
                }
            }, 100);
        }

        function limparFiltrosHonorarios() {
            document.getElementById('buscaHonorarios').value = '';
            document.getElementById('filtroStatusHonorario').value = '';
            document.getElementById('filtroValorMinHonorario').value = '';
            document.getElementById('filtroValorMaxHonorario').value = '';
            document.getElementById('filtroVencimentoHonorario').value = '';
            aplicarFiltrosHonorarios();
        }

        function filtrarContratos() {
            aplicarFiltrosContratos();
        }

        function aplicarFiltrosContratos() {
            console.log('üîß aplicarFiltrosContratos chamado');
            const busca = document.getElementById('buscaContratos')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusContrato')?.value || '';
            const clienteId = document.getElementById('filtroClienteContrato')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinContrato')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxContrato')?.value) || Infinity;
            const nif = document.getElementById('filtroNifContrato')?.value || '';
            
            console.log('üîß Filtros aplicados:', { busca, status, clienteId, valorMin, valorMax });
            console.log('üîß Total de contratos:', contratos.length);
            
            const contratosFiltrados = contratos.filter(contrato => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    contrato.clienteNome.toLowerCase().includes(busca) || 
                    contrato.tipo.toLowerCase().includes(busca) ||
                    (contrato.observacoes && contrato.observacoes.toLowerCase().includes(busca));
                
                // Filtro por status
                const matchStatus = !status || contrato.status === status;
                
                // Filtro por cliente
                const matchCliente = !clienteId || contrato.clienteId == clienteId;
                
                // Filtro por valor
                const valor = parseFloat(contrato.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                // Filtro por NIF
                const cliente = clientes.find(c => c.id === contrato.clienteId);
                const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));
                
                return matchBusca && matchStatus && matchCliente && matchValor && matchNif;
            });
            
            console.log('üîß Contratos filtrados:', contratosFiltrados.length);
            atualizarListaContratos(contratosFiltrados);
            
            const contador = document.getElementById('contadorContratos');
            if (contador) {
                contador.textContent = contratosFiltrados.length;
            }
            
            // Reinicializar √≠cones Lucide ap√≥s aplicar filtros
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('üîß √çcones Lucide reinicializados para Contratos');
                }
            }, 100);
        }

        function limparFiltrosContratos() {
            document.getElementById('buscaContratos').value = '';
            document.getElementById('filtroStatusContrato').value = '';
            document.getElementById('filtroClienteContrato').value = '';
            document.getElementById('filtroValorMinContrato').value = '';
            document.getElementById('filtroValorMaxContrato').value = '';
            document.getElementById('filtroNifContrato').value = '';
            aplicarFiltrosContratos();
        }

        function atualizarListaClientes(clientesFiltrados) {
            const tbody = document.getElementById('listaClientes');
            if (!tbody) return;
            
            tbody.innerHTML = clientesFiltrados.map(cliente => `
                <tr>
                    <td>${cliente.nome}</td>
                    <td>${cliente.email}</td>
                    <td>${cliente.telefone}</td>
                    <td>${cliente.nif || '-'}</td>
                    <td><span class="status-badge status-${cliente.status || 'ativo'}">${cliente.status || 'Ativo'}</span></td>
                    <td>
                        <button onclick="editarClienteDireto(${cliente.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirItem('cliente', ${cliente.id})" class="text-red-600 hover:text-red-800" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Reinicializar √≠cones Lucide
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            }, 50);
        }

        function atualizarListaHonorarios(honorariosFiltrados) {
            const tbody = document.getElementById('listaHonorarios');
            if (!tbody) return;
            
            tbody.innerHTML = honorariosFiltrados.map(honorario => `
                <tr>
                    <td>${honorario.cliente}</td>
                    <td>${honorario.servico}</td>
                    <td>‚Ç¨${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</td>
                    <td><span class="status-badge status-${honorario.status}">${honorario.status}</span></td>
                    <td>${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}</td>
                    <td>
                        <button class="btn-editar-honorario text-blue-600 hover:text-blue-800 mr-2" data-id="${honorario.id}" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button class="btn-excluir-honorario text-red-600 hover:text-red-800" data-id="${honorario.id}" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Adicionar event listeners
            tbody.querySelectorAll('.btn-editar-honorario').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    console.log('üîß ID do bot√£o editar:', id, 'Tipo:', typeof id);
                    editarHonorarioDireto(id);
                });
            });
            
            tbody.querySelectorAll('.btn-excluir-honorario').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    console.log('üîß ID do bot√£o excluir:', id, 'Tipo:', typeof id);
                    excluirHonorarioDireto(id);
                });
            });
            
            // Reinicializar √≠cones Lucide
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            }, 50);
        }

        function atualizarListaContratos(contratosFiltrados) {
            const tbody = document.getElementById('listaContratos');
            if (!tbody) return;
            
            tbody.innerHTML = contratosFiltrados.map(contrato => `
                <tr>
                    <td>${contrato.clienteNome}</td>
                    <td>${contrato.tipo}</td>
                    <td>${contrato.descricao || '-'}</td>
                    <td>
                        <div class="text-sm font-bold text-black">‚Ç¨${(Math.round((parseFloat(contrato.valor) || 0) * 100) / 100).toFixed(2)}</div>
                        <div class="text-xs font-bold text-red-600">+ IVA: ‚Ç¨${((contrato.valor || 0) + ((contrato.valor || 0) * (contrato.iva || 0) / 100)).toFixed(2)}</div>
                    </td>
                    <td><span class="status-badge status-${contrato.status}">${contrato.status === 'concluido' ? 'Conclu√≠do' : contrato.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span></td>
                    <td>${contrato.dataInicio ? new Date(contrato.dataInicio).toLocaleDateString('pt-PT') : '-'}</td>
                    <td>
                        <button onclick="editarContratoDireto(${contrato.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="abrirAnexosContrato(${contrato.id})" class="text-green-600 hover:text-green-800 mr-2" title="Documentos">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirContratoDireto(${contrato.id})" class="text-red-600 hover:text-red-800" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Reinicializar √≠cones Lucide ap√≥s atualizar a lista
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('üîß √çcones Lucide reinicializados na lista de Contratos');
                }
            }, 100);
        }

        function mostrarNotificacao(mensagem, tipo = 'info') {
            const container = document.getElementById('notificationsContainer');
            if (!container) {
                // Se n√£o h√° container, criar notifica√ß√£o tempor√°ria
                const notificacao = document.createElement('div');
                notificacao.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300`;
                
                const cores = {
                    success: 'bg-green-500 text-white',
                    error: 'bg-red-500 text-white',
                    warning: 'bg-yellow-500 text-white',
                    info: 'bg-blue-500 text-white'
                };
                
                notificacao.className += ` ${cores[tipo] || cores.info}`;
                notificacao.textContent = mensagem;
                
                document.body.appendChild(notificacao);
                
                // Remover ap√≥s 5 segundos
                setTimeout(() => {
                    if (notificacao.parentNode) {
                        notificacao.parentNode.removeChild(notificacao);
                    }
                }, 5000);
                return;
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            notification.textContent = mensagem;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function atualizarInterface() {
            lucide.createIcons();
        }

        function fecharModal() {
            console.log('üîß fecharModal chamado');
            
            // Limpar modalContainer
            const modalContainer = document.getElementById('modalContainer');
            if (modalContainer) {
                modalContainer.classList.remove('show');
                modalContainer.innerHTML = '';
                console.log('‚úÖ modalContainer limpo');
            }
            
            // Remover qualquer modal que possa estar no body
            const modalsNoBody = document.querySelectorAll('.fixed.inset-0');
            modalsNoBody.forEach(modal => {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                    console.log('‚úÖ Modal removido do body');
                }
            });
            
            // Remover modais espec√≠ficos por ID
            const modalIds = ['modalEdicaoContrato', 'modalEdicaoHeranca', 'modalEdicaoMigracao', 'modalEdicaoRegisto'];
            modalIds.forEach(id => {
                const modal = document.getElementById(id);
                if (modal && modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                    console.log(`‚úÖ Modal ${id} removido`);
                }
            });
        }

        function editarItem(tipo, id) {
            console.log('üîß editarItem chamado:', tipo, id);
            
            // Fechar qualquer modal aberto primeiro
            fecharModal();
            
            if (tipo === 'cliente') {
                const cliente = clientes.find(c => c.id === id);
                if (cliente) {
                    abrirModalEdicaoCliente(cliente);
                }
            } else if (tipo === 'contrato') {
                const contrato = contratos.find(c => c.id === id);
                console.log('Contrato encontrado:', contrato);
                if (contrato) {
                    // Aguardar um pouco para garantir que o modal anterior foi fechado
                    setTimeout(() => {
                        abrirModalEdicaoContrato(contrato);
                    }, 100);
                } else {
                    console.error('Contrato n√£o encontrado com ID:', id);
                    mostrarNotificacao('Contrato n√£o encontrado!', 'error');
                }
            } else if (tipo === 'honorario') {
                const honorario = honorarios.find(h => h.id === id);
                if (honorario) {
                    abrirModalEdicaoHonorario(honorario);
                }
            } else if (tipo === 'heranca') {
                const heranca = herancas.find(h => h.id === id);
                if (heranca) {
                    abrirModalEdicaoHeranca(heranca);
                }
            } else if (tipo === 'migracao') {
                const migracao = migracoes.find(m => m.id === id);
                if (migracao) {
                    abrirModalEdicaoMigracao(migracao);
                }
            } else if (tipo === 'registo') {
                const registo = registos.find(r => r.id === id);
                if (registo) {
                    abrirModalEdicaoRegisto(registo);
                }
            } else if (tipo === 'prazo') {
                const prazo = prazos.find(p => p.id === id);
                if (prazo) {
                    abrirModalEdicaoPrazo(prazo);
                }
            } else {
                mostrarNotificacao('Funcionalidade de edi√ß√£o em desenvolvimento', 'info');
            }
        }

        function excluirItem(tipo, id) {
            console.log('üîß excluirItem chamado:', tipo, id);
            
            if (confirm('Tem certeza que deseja excluir este item?')) {
                if (tipo === 'cliente') {
                    clientes = clientes.filter(item => item.id !== id);
                    salvarDados('clientes', clientes);
                    console.log('‚úÖ Cliente exclu√≠do');
                } else if (tipo === 'honorario') {
                    honorarios = honorarios.filter(item => item.id !== id);
                    salvarDados('honorarios', honorarios);
                    console.log('‚úÖ Honor√°rio exclu√≠do');
                } else if (tipo === 'contrato') {
                    console.log('üîß Excluindo contrato com ID:', id);
                    console.log('üîß Contratos antes:', contratos.length);
                    contratos = contratos.filter(item => item.id !== id);
                    console.log('üîß Contratos depois:', contratos.length);
                    salvarDados('contratos', contratos);
                    console.log('‚úÖ Contrato exclu√≠do');
                } else if (tipo === 'heranca') {
                    herancas = herancas.filter(item => item.id !== id);
                    salvarDados('herancas', herancas);
                    console.log('‚úÖ Heran√ßa exclu√≠da');
                } else if (tipo === 'migracao') {
                    migracoes = migracoes.filter(item => item.id !== id);
                    salvarDados('migracoes', migracoes);
                    console.log('‚úÖ Migra√ß√£o exclu√≠da');
                } else if (tipo === 'registo') {
                    registos = registos.filter(item => item.id !== id);
                    salvarDados('registos', registos);
                    console.log('‚úÖ Registo exclu√≠do');
                } else if (tipo === 'prazo') {
                    prazos = prazos.filter(item => item.id !== id);
                    salvarDados('prazos', prazos);
                    console.log('‚úÖ Prazo exclu√≠do');
                }
                mostrarNotificacao('Item exclu√≠do com sucesso!', 'success');
                carregarSecao(secaoAtiva);
            }
        }

        function exportarDados() {
            const dados = {
                exportadoEm: new Date().toISOString(),
                versao: '38.0',
                dados: { clientes, honorarios, contratos }
            };
            
            const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sistema_legal_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('Dados exportados com sucesso!', 'success');
        }

        function importarDados() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const dados = JSON.parse(e.target.result);
                            if (dados.dados) {
                                clientes = dados.dados.clientes || [];
                                honorarios = dados.dados.honorarios || [];
                                contratos = dados.dados.contratos || [];
                                salvarDados('clientes', clientes);
                                salvarDados('honorarios', honorarios);
                                salvarDados('contratos', contratos);
                                mostrarNotificacao('Dados importados com sucesso!', 'success');
                                carregarSecao(secaoAtiva);
                            }
                        } catch (error) {
                            mostrarNotificacao('Erro ao importar dados', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function gerarRelatorioClientes() {
            const relatorio = `
RELAT√ìRIO DE CLIENTES
====================
Data: ${new Date().toLocaleDateString('pt-PT')}

Total de Clientes: ${clientes.length}

CLIENTES CADASTRADOS:
${clientes.map((cliente, index) => `
${index + 1}. ${cliente.nome}
   Email: ${cliente.email}
   Telefone: ${cliente.telefone}
   Status: ${cliente.status}
   Data: ${new Date(cliente.dataCriacao).toLocaleDateString('pt-PT')}
`).join('')}
            `;
            
            downloadRelatorio(relatorio, 'relatorio_clientes.txt');
        }

        function gerarRelatorioFinanceiro() {
            const valorTotal = honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            const honorariosPagos = honorarios.filter(h => h.status === 'pago');
            const valorPago = honorariosPagos.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
            
            const relatorio = `
RELAT√ìRIO FINANCEIRO
====================
Data: ${new Date().toLocaleDateString('pt-PT')}

RESUMO FINANCEIRO:
- Total de Honor√°rios: ${honorarios.length}
- Valor Total: ‚Ç¨${(Math.round(valorTotal * 100) / 100).toFixed(2)}
- Valor Pago: ‚Ç¨${Number(valorPago).toFixed(2)}
- Valor Pendente: ‚Ç¨${Number(valorTotal - valorPago).toFixed(2)}

HONOR√ÅRIOS POR STATUS:
- Pagos: ${honorarios.filter(h => h.status === 'pago').length}
- Pendentes: ${honorarios.filter(h => h.status === 'pendente').length}
- Vencidos: ${honorarios.filter(h => h.status === 'vencido').length}

DETALHES DOS HONOR√ÅRIOS:
${honorarios.map((honorario, index) => `
${index + 1}. ${honorario.cliente} - ${honorario.servico}
   Valor: ‚Ç¨${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}
   Status: ${honorario.status}
   Vencimento: ${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}
`).join('')}
            `;
            
            downloadRelatorio(relatorio, 'relatorio_financeiro.txt');
        }

        function gerarRelatorioCompleto() {
            const relatorio = `
RELAT√ìRIO COMPLETO DO SISTEMA
============================
Data: ${new Date().toLocaleDateString('pt-PT')}
Vers√£o: 38.0

ESTAT√çSTICAS GERAIS:
- Clientes: ${clientes.length}
- Honor√°rios: ${honorarios.length}

RESUMO FINANCEIRO:
- Valor Total: ‚Ç¨${Number(honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0)).toFixed(2)}
- Honor√°rios Pagos: ${honorarios.filter(h => h.status === 'pago').length}
- Honor√°rios Pendentes: ${honorarios.filter(h => h.status === 'pendente').length}

CLIENTES:
${clientes.map((cliente, index) => `
${index + 1}. ${cliente.nome} (${cliente.status})
`).join('')}

HONOR√ÅRIOS:
${honorarios.map((honorario, index) => `
${index + 1}. ${honorario.cliente} - ‚Ç¨${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)} (${honorario.status})
`).join('')}
            `;
            
            downloadRelatorio(relatorio, 'relatorio_completo.txt');
        }

        function downloadRelatorio(conteudo, nomeArquivo) {
            const blob = new Blob([conteudo], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('Relat√≥rio gerado com sucesso!', 'success');
        }

        // === SISTEMA DE BACKUP AUTOM√ÅTICO ===
        
        let backupInterval;
        let ultimoBackup = null;
        
        function iniciarSistemaBackup() {
            console.log('üíæ Iniciando sistema de backup autom√°tico');
            
            // Backup inicial
            criarBackupAutomatico();
            
            // Backup a cada 5 minutos
            backupInterval = setInterval(() => {
                criarBackupAutomatico();
            }, 5 * 60 * 1000);
            
            // Backup antes de fechar a p√°gina
            window.addEventListener('beforeunload', () => {
                criarBackupAutomatico();
            });
        }
        
        function criarBackupAutomatico() {
            try {
                const backup = {
                    timestamp: new Date().toISOString(),
                    dados: {
                        clientes: clientes,
                        honorarios: honorarios,
                        contratos: contratos,
                        prazos: prazos,
                        notificacoes: notificacoes,
                        herancas: herancas,
                        migracoes: migracoes,
                        registos: registos
                    },
                    versao: '1.0',
                    tipo: 'automatico'
                };
                
                // Salvar backup no localStorage
                const backupKey = `backup_${Date.now()}`;
                localStorage.setItem(backupKey, JSON.stringify(backup));
                
                // Manter apenas os √∫ltimos 10 backups
                limparBackupsAntigos();
                
                ultimoBackup = backup.timestamp;
                console.log('‚úÖ Backup autom√°tico criado:', new Date(backup.timestamp).toLocaleString('pt-PT'));
                
            } catch (error) {
                console.error('‚ùå Erro ao criar backup autom√°tico:', error);
            }
        }
        
        function limparBackupsAntigos() {
            const chaves = Object.keys(localStorage);
            const backups = chaves.filter(chave => chave.startsWith('backup_'));
            
            if (backups.length > 10) {
                // Ordenar por timestamp (mais antigos primeiro)
                const backupsOrdenados = backups.sort((a, b) => {
                    const timestampA = parseInt(a.split('_')[1]);
                    const timestampB = parseInt(b.split('_')[1]);
                    return timestampA - timestampB;
                });
                
                // Remover os mais antigos
                const paraRemover = backupsOrdenados.slice(0, backups.length - 10);
                paraRemover.forEach(chave => {
                    localStorage.removeItem(chave);
                });
                
                console.log(`üóëÔ∏è Removidos ${paraRemover.length} backups antigos`);
            }
        }
        
        function exportarDadosCompletos() {
            try {
                const dadosCompletos = {
                    timestamp: new Date().toISOString(),
                    versao: '1.0',
                    dados: {
                        clientes: clientes,
                        honorarios: honorarios,
                        contratos: contratos,
                        prazos: prazos,
                        notificacoes: notificacoes,
                        herancas: herancas,
                        migracoes: migracoes,
                        registos: registos
                    },
                    estatisticas: {
                        totalClientes: clientes.length,
                        totalHonorarios: honorarios.length,
                        totalContratos: contratos.length,
                        totalPrazos: prazos.length,
                        totalNotificacoes: notificacoes.length,
                        totalHerancas: herancas.length,
                        totalMigracoes: migracoes.length,
                        totalRegistos: registos.length
                    }
                };
                
                const blob = new Blob([JSON.stringify(dadosCompletos, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_sistema_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                mostrarNotificacao('Backup exportado com sucesso!', 'success');
                
            } catch (error) {
                console.error('‚ùå Erro ao exportar dados:', error);
                mostrarNotificacao('Erro ao exportar backup', 'error');
            }
        }
        
        function importarDadosCompletos() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (event) => {
                const arquivo = event.target.files[0];
                if (!arquivo) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const dadosImportados = JSON.parse(e.target.result);
                        
                        // Validar estrutura do arquivo
                        if (!dadosImportados.dados || !dadosImportados.versao) {
                            throw new Error('Arquivo de backup inv√°lido');
                        }
                        
                        // Confirmar importa√ß√£o
                        if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° substituir TODOS os dados atuais!\n\nTem certeza que deseja continuar?')) {
                            
                            // Criar backup antes de importar
                            criarBackupAutomatico();
                            
                            // Importar dados
                            clientes = dadosImportados.dados.clientes || [];
                            honorarios = dadosImportados.dados.honorarios || [];
                            contratos = dadosImportados.dados.contratos || [];
                            prazos = dadosImportados.dados.prazos || [];
                            notificacoes = dadosImportados.dados.notificacoes || [];
                            herancas = dadosImportados.dados.herancas || [];
                            migracoes = dadosImportados.dados.migracoes || [];
                            registos = dadosImportados.dados.registos || [];
                            
                            // Salvar dados importados
                            salvarDados('clientes', clientes);
                            salvarDados('honorarios', honorarios);
                            salvarDados('contratos', contratos);
                            salvarDados('prazos', prazos);
                            salvarDados('notificacoes', notificacoes);
                            salvarDados('herancas', herancas);
                            salvarDados('migracoes', migracoes);
                            salvarDados('registos', registos);
                            
                            mostrarNotificacao('Dados importados com sucesso!', 'success');
                            
                            // Recarregar se√ß√£o atual
                            carregarSecao(secaoAtiva);
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao importar dados:', error);
                        mostrarNotificacao('Erro ao importar backup: ' + error.message, 'error');
                    }
                };
                reader.readAsText(arquivo);
            };
            input.click();
        }
        
        function gerarBackup() {
            const chaves = Object.keys(localStorage);
            const backups = chaves.filter(chave => chave.startsWith('backup_'));
            const ultimoBackupTexto = ultimoBackup ? new Date(ultimoBackup).toLocaleString('pt-PT') : 'Nunca';
            
            return `
                <div class="space-y-6">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Status do Sistema de Backup</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">√öltimo backup autom√°tico:</span>
                                <span class="font-medium">${ultimoBackupTexto}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total de backups:</span>
                                <span class="font-medium">${backups.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Frequ√™ncia:</span>
                                <span class="font-medium">A cada 5 minutos</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">A√ß√µes de Backup</h3>
                        <div class="space-y-3">
                            <button onclick="criarBackupAutomatico(); mostrarNotificacao('Backup manual criado!', 'success')" 
                                    class="w-full btn btn-primary">
                                <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                Criar Backup Manual
                            </button>
                            <button onclick="exportarDadosCompletos()" 
                                    class="w-full btn btn-success">
                                <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                Exportar Backup Completo
                            </button>
                            <button onclick="importarDadosCompletos()" 
                                    class="w-full btn btn-warning">
                                <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                                Importar Backup
                            </button>
                        </div>
                    </div>
                    
                    <div class="card p-6 border-red-200 bg-red-50">
                        <h3 class="text-lg font-semibold mb-4 text-red-800">‚ö†Ô∏è Limpeza Profissional</h3>
                        <p class="text-sm text-red-700 mb-4">
                            Use esta fun√ß√£o para limpar todos os dados de teste e preparar o sistema para uso profissional com clientes reais.
                        </p>
                        <button onclick="limparDadosParaUsoProfissional()" 
                                class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 flex items-center justify-center">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                            Limpar Todos os Dados
                        </button>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Informa√ß√µes do Sistema</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Clientes:</span>
                                <span class="font-medium">${clientes.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Contratos:</span>
                                <span class="font-medium">${contratos.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Honor√°rios:</span>
                                <span class="font-medium">${honorarios.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Prazos:</span>
                                <span class="font-medium">${prazos.length}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        // === SISTEMA RESTAURADO - SEM LOGIN ===
        
        
        // Carregar usu√°rios do localStorage
        
        
        // Sistema restaurado - sem login
        
        
        
        
        // Processar login
        function processarLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;
            
            if (fazerLogin(email, senha)) {
                // Login bem-sucedido
            }
        }
        
        // Mostrar sistema principal
        function mostrarSistema() {
            document.body.innerHTML = `
                <div class="flex h-screen bg-gray-900">
                    <!-- Sidebar -->
                    <div id="sidebar" class="w-64 bg-gray-800 shadow-lg">
                        <div class="p-6">
                            <div class="flex items-center">
                                <div class="h-8 w-8 bg-blue-600 rounded-lg flex items-center justify-center">
                                    <i data-lucide="scale" class="h-5 w-5 text-white"></i>
                                </div>
                                <h1 class="ml-3 text-xl font-bold text-white">Sistema Jur√≠dico</h1>
                            </div>
                        </div>
                        
                        <nav class="mt-6">
                            <a href="#" onclick="carregarSecao('dashboard')" class="sidebar-item" id="nav-dashboard">
                                <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                                Dashboard
                            </a>
                            <a href="#" onclick="carregarSecao('clientes')" class="sidebar-item" id="nav-clientes">
                                <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                                Gest√£o de Clientes
                            </a>
                            <a href="#" onclick="carregarSecao('honorarios')" class="sidebar-item" id="nav-honorarios">
                                <i data-lucide="dollar-sign" class="w-5 h-5 mr-3"></i>
                                Gest√£o de Honor√°rios
                            </a>
                            <a href="#" onclick="carregarSecao('contratos')" class="sidebar-item" id="nav-contratos">
                                <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                                Gest√£o de Contratos
                            </a>
                            <a href="#" onclick="carregarSecao('herancas')" class="sidebar-item" id="nav-herancas">
                                <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                                Gest√£o de Heran√ßas
                            </a>
                            <a href="#" onclick="carregarSecao('migracao')" class="sidebar-item" id="nav-migracao">
                                <i data-lucide="globe" class="w-5 h-5 mr-3"></i>
                                Gest√£o de Migra√ß√£o
                            </a>
                            <a href="#" onclick="carregarSecao('registos')" class="sidebar-item" id="nav-registos">
                                <i data-lucide="clipboard" class="w-5 h-5 mr-3"></i>
                                Gest√£o de Registos
                            </a>
                            <a href="#" onclick="carregarSecao('prazos')" class="sidebar-item" id="nav-prazos">
                                <i data-lucide="calendar" class="w-5 h-5 mr-3"></i>
                                Gest√£o de Prazos
                            </a>
                            <a href="#" onclick="carregarSecao('notificacoes')" class="sidebar-item" id="nav-notificacoes">
                                <i data-lucide="bell" class="w-5 h-5 mr-3"></i>
                                Notifica√ß√µes
                                <span id="badgeNotificacoes" class="badge hidden">0</span>
                            </a>
                            <a href="#" onclick="carregarSecao('relatorios')" class="sidebar-item" id="nav-relatorios">
                                <i data-lucide="bar-chart-3" class="w-5 h-5 mr-3"></i>
                                Gest√£o de Relat√≥rios
                            </a>
                            <a href="#" onclick="carregarSecao('backup')" class="sidebar-item" id="nav-backup">
                                <i data-lucide="database" class="w-5 h-5 mr-3"></i>
                                Backup
                            </a>
                        </nav>
                        
                        <div class="absolute bottom-0 w-64 p-4">
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="flex items-center">
                                    <div class="h-8 w-8 bg-gray-600 rounded-full flex items-center justify-center">
                                        <i data-lucide="user" class="h-4 w-4 text-gray-300"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-white">${usuarioLogado ? usuarioLogado.nome : 'Usu√°rio'}</p>
                                        <p class="text-xs text-gray-300">${usuarioLogado ? usuarioLogado.email : ''}</p>
                                    </div>
                                </div>
                                <button onclick="fazerLogout()" class="mt-2 w-full text-left text-sm text-red-400 hover:text-red-300">
                                    <i data-lucide="log-out" class="w-4 h-4 inline mr-1"></i>
                                    Sair
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Conte√∫do Principal -->
                    <div class="flex-1 flex flex-col overflow-hidden bg-gray-100">
                        <!-- Header -->
                        <header class="bg-white shadow-sm border-b border-gray-200">
                            <div class="px-6 py-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h2 id="tituloSecao" class="text-2xl font-bold text-gray-900">Sistema Legal</h2>
                                        <p id="subtituloSecao" class="text-sm text-gray-600">Vis√£o geral do sistema</p>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100">
                                            <i data-lucide="menu" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </header>
                        
                        <!-- Conte√∫do -->
                        <main class="flex-1 overflow-y-auto">
                            <div class="p-6">
                                <div id="conteudoDinamico">
                                    <!-- Conte√∫do ser√° carregado aqui -->
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
                
                <!-- Modal Container -->
                <div id="modalContainer"></div>
                
                <!-- Notifications Container -->
                <div id="notificationsContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
            `;
            lucide.createIcons();
        }
        
        // Mostrar modal para criar usu√°rio
        function mostrarCriarUsuario() {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Criar Novo Usu√°rio</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="criarUsuario(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                                        <input type="text" id="novoNome" required 
                                               class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                        <input type="email" id="novoEmail" required 
                                               class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                                        <input type="password" id="novaSenha" required 
                                               class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Usu√°rio</label>
                                        <select id="novoTipo" required 
                                                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                            <option value="admin">Administrador</option>
                                            <option value="usuario">Usu√°rio</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" 
                                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                        Cancelar
                                    </button>
                                    <button type="submit" 
                                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                        Criar Usu√°rio
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
            lucide.createIcons();
        }
        
        // Criar novo usu√°rio
        function criarUsuario(event) {
            event.preventDefault();
            
            const nome = document.getElementById('novoNome').value;
            const email = document.getElementById('novoEmail').value;
            const senha = document.getElementById('novaSenha').value;
            const tipo = document.getElementById('novoTipo').value;
            
            // Verificar se email j√° existe
            if (usuarios.find(u => u.email === email)) {
                mostrarNotificacao('Email j√° cadastrado', 'error');
                return;
            }
            
            const novoUsuario = {
                id: Date.now(),
                nome: nome,
                email: email,
                senha: senha,
                tipo: tipo,
                ativo: true,
                dataCriacao: new Date().toISOString()
            };
            
            usuarios.push(novoUsuario);
            salvarUsuarios();
            
            mostrarNotificacao('Usu√°rio criado com sucesso!', 'success');
            fecharModal();
        }
        

        // === FUN√á√ÉO GEN√âRICA PARA CONVERTER ARQUIVO ===
        function converterArquivoParaBase64(arquivo, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                callback(e.target.result);
            };
            reader.readAsDataURL(arquivo);
        }
        
        // === FUN√á√ÉO ESPEC√çFICA PARA REGISTOS ===
        function adicionarAnexoRegistoReal(event, registoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const registo = registos.find(r => r.id === registoId);
                if (registo) {
                    if (!registo.anexos) registo.anexos = [];
                    registo.anexos.push(anexo);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    abrirAnexosRegisto(registoId);
                }
            });
        }
        
        // === SISTEMA DE ANEXOS PARA REGISTOS ===
        
        function abrirAnexosRegisto(registoId) {
            const registo = registos.find(r => r.id === registoId);
            if (!registo) return;
            
            if (!registo.anexos) {
                registo.anexos = [];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos do Registo</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexoRegisto(event, ${registoId})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('registo')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="certidao">Certid√£o</option>
                                                <option value="documento">Documento</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizadoRegisto" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descri√ß√£o do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModal()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${registo.anexos.length})</h4>
                                ${registo.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${registo.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} ‚Ä¢ ${anexo.tamanho} ‚Ä¢ ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexoRegisto(${registoId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }
        
        function adicionarAnexoRegisto(event, registoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const registo = registos.find(r => r.id === registoId);
                if (registo) {
                    if (!registo.anexos) registo.anexos = [];
                    registo.anexos.push(anexo);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    abrirAnexosRegisto(registoId);
                }
            });
        }
        
        function removerAnexoRegisto(registoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const registo = registos.find(r => r.id === registoId);
                if (registo && registo.anexos) {
                    registo.anexos = registo.anexos.filter(a => a.id !== anexoId);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosRegisto(registoId);
                }
            }
        }

        // === SISTEMA DE ANEXOS PARA PRAZOS ===
        
        function abrirAnexosPrazo(prazoId) {
            const prazo = prazos.find(p => p.id === prazoId);
            if (!prazo) return;
            
            if (!prazo.anexos) {
                prazo.anexos = [];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos do Prazo</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexoPrazo(event, ${prazoId})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('prazo')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="documento">Documento</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="certidao">Certid√£o</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizadoPrazo" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descri√ß√£o do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModal()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${prazo.anexos.length})</h4>
                                ${prazo.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${prazo.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} ‚Ä¢ ${anexo.tamanho} ‚Ä¢ ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexoPrazo(${prazoId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }
        
        function adicionarAnexoPrazo(event, prazoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            const anexo = {
                id: Date.now().toString(),
                nome: nome,
                tipo: tipo,
                descricao: descricao,
                nomeArquivo: arquivo.name,
                tamanho: formatarTamanho(arquivo.size),
                dataUpload: new Date().toISOString(),
                tipoArquivo: arquivo.type,
                conteudo: 'CONVERSAO_REAL_IMPLEMENTADA_FINAL...'
            };
            
            const prazo = prazos.find(p => p.id === prazoId);
            if (prazo) {
                if (!prazo.anexos) prazo.anexos = [];
                prazo.anexos.push(anexo);
                salvarDados('prazos', prazos);
                mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                abrirAnexosPrazo(prazoId);
            }
        }
        
        function removerAnexoPrazo(prazoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const prazo = prazos.find(p => p.id === prazoId);
                if (prazo && prazo.anexos) {
                    prazo.anexos = prazo.anexos.filter(a => a.id !== anexoId);
                    salvarDados('prazos', prazos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosPrazo(prazoId);
                }
            }
        }

        // === SISTEMA DE NOTIFICA√á√ïES AUTOM√ÅTICAS ===
        
        function iniciarSistemaNotificacoes() {
            console.log('üîî Iniciando sistema de notifica√ß√µes');
            verificarHonorariosVencidos();
            verificarPrazosUrgentes();
            atualizarBadgeNotificacoes();
            
            // Verificar a cada 5 minutos
            setInterval(() => {
                verificarHonorariosVencidos();
                verificarPrazosUrgentes();
                atualizarBadgeNotificacoes();
            }, 5 * 60 * 1000);
        }


        function verificarHonorariosVencidos() {
            const hoje = new Date();
            const honorariosVencidos = honorarios.filter(h => {
                try {
                    if (!h.vencimento) return false;
                    const dataVencimento = new Date(h.vencimento);
                    if (isNaN(dataVencimento.getTime())) {
                        console.warn('Data de vencimento inv√°lida no honor√°rio:', h.vencimento);
                        return false;
                    }
                    return dataVencimento < hoje && h.status === 'pendente';
                } catch (error) {
                    console.warn('Erro ao processar honor√°rio:', h.id, error);
                    return false;
                }
            });

            honorariosVencidos.forEach(honorario => {
                // Atualizar status para vencido
                const index = honorarios.findIndex(h => h.id === honorario.id);
                if (index !== -1) {
                    honorarios[index].status = 'vencido';
                }

                // Criar notifica√ß√£o se n√£o existir
                const notificacaoExistente = notificacoes.find(n => 
                    n.tipo === 'honorario' && 
                    n.referenciaId === honorario.id && 
                    n.titulo.includes('Vencido')
                );

                if (!notificacaoExistente) {
                    criarNotificacao({
                        tipo: 'honorario',
                        titulo: 'Honor√°rio Vencido',
                        mensagem: `O honor√°rio de ‚Ç¨${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)} do cliente ${honorario.cliente} est√° vencido desde ${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}`,
                        prioridade: 'alta',
                        referenciaId: honorario.id,
                        acao: 'ver_honorario'
                    });
                    
                }
            });

            salvarDados('honorarios', honorarios);
        }

        function verificarPrazosUrgentes() {
            const hoje = new Date();
            const amanha = new Date(hoje.getTime() + 24 * 60 * 60 * 1000);
            const proximos3Dias = new Date(hoje.getTime() + 3 * 24 * 60 * 60 * 1000);

            prazos.forEach(prazo => {
                try {
                    if (!prazo.dataLimite) return;
                    const dataLimite = new Date(prazo.dataLimite);
                    if (isNaN(dataLimite.getTime())) {
                        console.warn('Data inv√°lida no prazo:', prazo.dataLimite);
                        return;
                    }
                    const diasRestantes = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));

                // Prazos vencidos
                if (dataLimite < hoje && prazo.status === 'ativo') {
                    const notificacaoExistente = notificacoes.find(n => 
                        n.tipo === 'prazo' && 
                        n.referenciaId === prazo.id && 
                        n.titulo.includes('Vencido')
                    );

                    if (!notificacaoExistente) {
                        criarNotificacao({
                            tipo: 'prazo',
                            titulo: 'Prazo Vencido',
                            mensagem: `O prazo "${prazo.descricao}" do cliente ${prazo.clienteNome} venceu em ${dataLimite.toLocaleDateString('pt-PT')}`,
                            prioridade: 'critica',
                            referenciaId: prazo.id,
                            acao: 'ver_prazo'
                        });
                    }
                }
                // Prazos que vencem hoje
                else if (dataLimite.toDateString() === hoje.toDateString() && prazo.status === 'ativo') {
                    const notificacaoExistente = notificacoes.find(n => 
                        n.tipo === 'prazo' && 
                        n.referenciaId === prazo.id && 
                        n.titulo.includes('Hoje')
                    );

                    if (!notificacaoExistente) {
                        criarNotificacao({
                            tipo: 'prazo',
                            titulo: 'Prazo Vence Hoje',
                            mensagem: `O prazo "${prazo.descricao}" do cliente ${prazo.clienteNome} vence hoje!`,
                            prioridade: 'alta',
                            referenciaId: prazo.id,
                            acao: 'ver_prazo'
                        });
                    }
                }
                // Prazos que vencem em 3 dias
                else if (dataLimite <= proximos3Dias && dataLimite > amanha && prazo.status === 'ativo') {
                    const notificacaoExistente = notificacoes.find(n => 
                        n.tipo === 'prazo' && 
                        n.referenciaId === prazo.id && 
                        n.titulo.includes('3 dias')
                    );

                    if (!notificacaoExistente) {
                        criarNotificacao({
                            tipo: 'prazo',
                            titulo: 'Prazo em 3 Dias',
                            mensagem: `O prazo "${prazo.descricao}" do cliente ${prazo.clienteNome} vence em ${diasRestantes} dias`,
                            prioridade: 'media',
                            referenciaId: prazo.id,
                            acao: 'ver_prazo'
                        });
                    }
                }
                } catch (error) {
                    console.warn('Erro ao processar prazo:', prazo.id, error);
                }
            });
        }

        function criarNotificacao(dados) {
            // Verificar se j√° existe uma notifica√ß√£o similar n√£o lida
            const notificacaoExistente = notificacoes.find(n => 
                n.tipo === dados.tipo && 
                n.referenciaId === dados.referenciaId && 
                !n.lida &&
                n.titulo === dados.titulo
            );

            if (notificacaoExistente) {
                // Se j√° existe, apenas atualizar a data e mostrar lembrete visual
                notificacaoExistente.dataCriacao = new Date().toISOString();
                salvarDados('notificacoes', notificacoes);
                mostrarLembreteNotificacao(dados.titulo);
                return;
            }

            const notificacao = {
                id: Date.now(),
                tipo: dados.tipo,
                titulo: dados.titulo,
                mensagem: dados.mensagem,
                prioridade: dados.prioridade,
                referenciaId: dados.referenciaId,
                acao: dados.acao,
                destinatarioId: dados.destinatarioId || 'todos',
                origem: dados.origem || 'sistema',
                lida: false,
                dataCriacao: new Date().toISOString()
            };

            notificacoes.unshift(notificacao);
            salvarDados('notificacoes', notificacoes);
            
            // Mostrar notifica√ß√£o visual
            mostrarNotificacao(notificacao.titulo, 'warning');
        }

        function mostrarLembreteNotificacao(titulo) {
            // Criar lembrete visual no canto superior direito
            const lembrete = document.createElement('div');
            lembrete.className = 'fixed top-4 right-4 bg-orange-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center space-x-2 animate-pulse';
            lembrete.innerHTML = `
                <i data-lucide="bell" class="w-4 h-4"></i>
                <span>Lembrete: ${titulo}</span>
            `;
            
            document.body.appendChild(lembrete);
            lucide.createIcons();
            
            // Remover ap√≥s 3 segundos
            setTimeout(() => {
                if (lembrete.parentNode) {
                    lembrete.parentNode.removeChild(lembrete);
                }
            }, 3000);
        }

        // === SISTEMA DE TESTE DE NOTIFICA√á√ïES ===
        
        function criarNotificacaoTeste() {
            const tipos = ['prazo', 'honorario', 'contrato', 'heranca', 'migracao', 'registo'];
            const titulos = [
                'Prazo Vencido',
                'Honor√°rio Vencido', 
                'Contrato Pendente',
                'Heran√ßa em Andamento',
                'Migra√ß√£o Urgente',
                'Registo Pendente'
            ];
            const mensagens = [
                'O prazo para entrega de documentos vence hoje!',
                'O honor√°rio de ‚Ç¨500 est√° vencido h√° 3 dias',
                'O contrato precisa ser assinado at√© amanh√£',
                'A heran√ßa est√° aguardando documenta√ß√£o',
                'O processo de migra√ß√£o est√° atrasado',
                'O registo precisa ser finalizado esta semana'
            ];
            
            const tipoAleatorio = tipos[Math.floor(Math.random() * tipos.length)];
            const tituloAleatorio = titulos[Math.floor(Math.random() * titulos.length)];
            const mensagemAleatoria = mensagens[Math.floor(Math.random() * mensagens.length)];
            
            criarNotificacao({
                tipo: tipoAleatorio,
                titulo: tituloAleatorio,
                mensagem: mensagemAleatoria,
                prioridade: 'alta',
                referenciaId: Date.now(),
                acao: 'ver_detalhes'
            });
            
            mostrarNotificacao('Notifica√ß√£o de teste criada!', 'success');
        }
        
        function criarNotificacaoPersonalizada() {
            const titulo = prompt('Digite o t√≠tulo da notifica√ß√£o:');
            if (!titulo) return;
            
            const mensagem = prompt('Digite a mensagem da notifica√ß√£o:');
            if (!mensagem) return;
            
            const tipo = prompt('Digite o tipo (prazo, honorario, contrato, heranca, migracao, registo):');
            if (!tipo) return;
            
            criarNotificacao({
                tipo: tipo,
                titulo: titulo,
                mensagem: mensagem,
                prioridade: 'media',
                referenciaId: Date.now(),
                acao: 'ver_detalhes'
            });
            
            mostrarNotificacao('Notifica√ß√£o personalizada criada!', 'success');
        }

        function atualizarBadgeNotificacoes() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const convidadoId = localStorage.getItem('convidadoId');
            
            // Filtrar notifica√ß√µes baseado no tipo de usu√°rio (igual ao gerarNotificacoes)
            let notificacoesFiltradas = notificacoes;
            
            if (tipoUsuario === 'convidado') {
                notificacoesFiltradas = notificacoes.filter(n => 
                    n.destinatarioId === parseInt(convidadoId) || 
                    n.destinatarioId === 'todos' ||
                    n.tipo === 'cliente_autorizado' ||
                    n.tipo === 'documento_anexado' ||
                    n.tipo === 'prazo_proximo'
                );
            }
            
            const notificacoesNaoLidas = notificacoesFiltradas.filter(n => !n.lida).length;
            const badge = document.getElementById('badgeNotificacoes');
            
            if (badge) {
                if (notificacoesNaoLidas > 0) {
                    badge.textContent = notificacoesNaoLidas;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        function marcarComoLida(notificacaoId) {
            const notificacao = notificacoes.find(n => n.id === notificacaoId);
            if (notificacao) {
                notificacao.lida = true;
                salvarDados('notificacoes', notificacoes);
                carregarSecao('notificacoes');
                atualizarBadgeNotificacoes();
            }
        }

        function marcarTodasComoLidas() {
            notificacoes.forEach(n => n.lida = true);
            salvarDados('notificacoes', notificacoes);
            carregarSecao('notificacoes');
            atualizarBadgeNotificacoes();
            mostrarNotificacao('Todas as notifica√ß√µes foram marcadas como lidas', 'success');
        }

        function excluirNotificacao(notificacaoId) {
            notificacoes = notificacoes.filter(n => n.id !== notificacaoId);
            salvarDados('notificacoes', notificacoes);
            carregarSecao('notificacoes');
            atualizarBadgeNotificacoes();
        }

        function limparNotificacoes() {
            if (confirm('Tem certeza que deseja limpar todas as notifica√ß√µes?')) {
                notificacoes = [];
                salvarDados('notificacoes', notificacoes);
                carregarSecao('notificacoes');
                atualizarBadgeNotificacoes();
                mostrarNotificacao('Todas as notifica√ß√µes foram removidas', 'success');
            }
        }

        // === SISTEMA H√çBRIDO DE NOTIFICA√á√ïES ===
        
        function enviarMensagemConvidado() {
            const convidados = obterConvidados();
            const convidadosAtivos = convidados.filter(c => c.ativo);
            
            if (convidadosAtivos.length === 0) {
                mostrarNotificacao('Nenhum convidado ativo encontrado!', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <h3 class="text-lg font-semibold mb-4">Enviar Mensagem para Convidado</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Destinat√°rio</label>
                            <select id="convidadoDestinatario" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecione um convidado</option>
                                ${convidadosAtivos.map(c => `
                                    <option value="${c.id}">${c.nome} (${c.email})</option>
                                `).join('')}
                                <option value="todos">Todos os Convidados</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo</label>
                            <input type="text" id="mensagemTitulo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="T√≠tulo da mensagem">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem</label>
                            <textarea id="mensagemConteudo" rows="4" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite sua mensagem..."></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                            <select id="mensagemPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="baixa">Baixa</option>
                                <option value="media" selected>M√©dia</option>
                                <option value="alta">Alta</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="fecharModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button onclick="enviarMensagemConfirmar()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Enviar Mensagem
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function enviarMensagemConfirmar() {
            const destinatarioId = document.getElementById('convidadoDestinatario').value;
            const titulo = document.getElementById('mensagemTitulo').value;
            const conteudo = document.getElementById('mensagemConteudo').value;
            const prioridade = document.getElementById('mensagemPrioridade').value;
            
            if (!destinatarioId || !titulo || !conteudo) {
                mostrarNotificacao('Preencha todos os campos!', 'error');
                return;
            }
            
            const notificacao = {
                id: Date.now(),
                tipo: 'mensagem_admin',
                titulo: titulo,
                mensagem: conteudo,
                prioridade: prioridade,
                destinatarioId: destinatarioId === 'todos' ? 'todos' : parseInt(destinatarioId),
                lida: false,
                dataCriacao: new Date().toISOString(),
                origem: 'admin'
            };
            
            notificacoes.unshift(notificacao);
            salvarDados('notificacoes', notificacoes);
            
            mostrarNotificacao('Mensagem enviada com sucesso!', 'success');
            fecharModal();
            carregarSecao('notificacoes');
        }

        // === FILTROS INTELIGENTES DE NOTIFICA√á√ïES ===
        
        function aplicarFiltrosNotificacoes() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const convidadoId = localStorage.getItem('convidadoId');
            
            // Obter filtros
            const filtroPrioridade = document.getElementById('filtroPrioridade')?.value || '';
            const filtroTipo = document.getElementById('filtroTipo')?.value || '';
            const filtroStatus = document.getElementById('filtroStatus')?.value || '';
            const filtroPeriodo = document.getElementById('filtroPeriodo')?.value || '';
            
            // Filtrar notifica√ß√µes baseado no tipo de usu√°rio
            let notificacoesFiltradas = notificacoes;
            
            if (tipoUsuario === 'convidado') {
                notificacoesFiltradas = notificacoes.filter(n => 
                    n.destinatarioId === parseInt(convidadoId) || 
                    n.destinatarioId === 'todos' ||
                    n.tipo === 'cliente_autorizado' ||
                    n.tipo === 'documento_anexado' ||
                    n.tipo === 'prazo_proximo'
                );
            }
            
            // Aplicar filtros adicionais
            if (filtroPrioridade) {
                notificacoesFiltradas = notificacoesFiltradas.filter(n => n.prioridade === filtroPrioridade);
            }
            
            if (filtroTipo) {
                notificacoesFiltradas = notificacoesFiltradas.filter(n => n.tipo === filtroTipo);
            }
            
            if (filtroStatus === 'nao_lida') {
                notificacoesFiltradas = notificacoesFiltradas.filter(n => !n.lida);
            } else if (filtroStatus === 'lida') {
                notificacoesFiltradas = notificacoesFiltradas.filter(n => n.lida);
            }
            
            if (filtroPeriodo) {
                const agora = new Date();
                const hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
                const inicioSemana = new Date(hoje);
                inicioSemana.setDate(hoje.getDate() - hoje.getDay());
                const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);
                
                notificacoesFiltradas = notificacoesFiltradas.filter(n => {
                    if (!n.dataCriacao) return false;
                    const dataNotificacao = new Date(n.dataCriacao);
                    
                    switch (filtroPeriodo) {
                        case 'hoje':
                            return dataNotificacao >= hoje;
                        case 'semana':
                            return dataNotificacao >= inicioSemana;
                        case 'mes':
                            return dataNotificacao >= inicioMes;
                        default:
                            return true;
                    }
                });
            }
            
            // Atualizar contador
            const contador = document.getElementById('contadorFiltros');
            if (contador) {
                contador.textContent = `${notificacoesFiltradas.length} notifica√ß√µes encontradas`;
            }
            
            // Recarregar se√ß√£o com filtros aplicados
            carregarSecao('notificacoes');
        }
        
        function limparFiltrosNotificacoes() {
            document.getElementById('filtroPrioridade').value = '';
            document.getElementById('filtroTipo').value = '';
            document.getElementById('filtroStatus').value = '';
            document.getElementById('filtroPeriodo').value = '';
            
            carregarSecao('notificacoes');
        }

        // === SISTEMA DE COMUNICA√á√ÉO BIDIRECIONAL ===
        
        function responderMensagem(notificacaoId) {
            const notificacao = notificacoes.find(n => n.id === notificacaoId);
            if (!notificacao) {
                mostrarNotificacao('Notifica√ß√£o n√£o encontrada!', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <h3 class="text-lg font-semibold mb-4">Responder Mensagem</h3>
                    
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-800">${notificacao.titulo}</h4>
                        <p class="text-sm text-gray-600 mt-1">${notificacao.mensagem}</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sua Resposta</label>
                            <textarea id="respostaMensagem" rows="4" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite sua resposta..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="fecharModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button onclick="enviarResposta(${notificacaoId})" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Enviar Resposta
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function enviarResposta(notificacaoId) {
            const resposta = document.getElementById('respostaMensagem').value;
            
            if (!resposta.trim()) {
                mostrarNotificacao('Digite uma resposta!', 'error');
                return;
            }
            
            const notificacao = notificacoes.find(n => n.id === notificacaoId);
            if (notificacao) {
                // Inicializar array de respostas se n√£o existir
                if (!notificacao.respostas) {
                    notificacao.respostas = [];
                }
                
                // Adicionar resposta
                const novaResposta = {
                    id: Date.now(),
                    mensagem: resposta,
                    origem: 'convidado',
                    dataCriacao: new Date().toISOString(),
                    convidadoId: localStorage.getItem('convidadoId')
                };
                
                notificacao.respostas.push(novaResposta);
                
                // Salvar dados
                salvarDados('notificacoes', notificacoes);
                
                // Criar notifica√ß√£o para o admin sobre a resposta
                const notificacaoAdmin = {
                    id: Date.now(),
                    tipo: 'resposta_convidado',
                    titulo: 'Resposta Recebida',
                    mensagem: `Convidado respondeu: "${resposta.substring(0, 50)}${resposta.length > 50 ? '...' : ''}"`,
                    prioridade: 'media',
                    destinatarioId: 'admin',
                    referenciaId: notificacaoId,
                    lida: false,
                    dataCriacao: new Date().toISOString(),
                    origem: 'sistema'
                };
                
                notificacoes.unshift(notificacaoAdmin);
                salvarDados('notificacoes', notificacoes);
                
                mostrarNotificacao('Resposta enviada com sucesso!', 'success');
                fecharModal();
                carregarSecao('notificacoes');
            }
        }

        // === VISUALIZA√á√ÉO DE CONVERSAS PARA ADMIN ===
        
        function verConversas() {
            // Filtrar notifica√ß√µes que t√™m respostas
            const conversas = notificacoes.filter(n => 
                n.respostas && n.respostas.length > 0 && 
                (n.origem === 'admin' || n.tipo === 'mensagem_admin')
            );
            
            if (conversas.length === 0) {
                mostrarNotificacao('Nenhuma conversa encontrada!', 'info');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold">Conversas com Convidados</h3>
                        <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        ${conversas.map(conversa => `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-start justify-between mb-3">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">${conversa.titulo}</h4>
                                        <p class="text-sm text-gray-600">${conversa.mensagem}</p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            ${new Date(conversa.dataCriacao).toLocaleString('pt-PT')}
                                        </p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
                                            ${conversa.respostas.length} resposta${conversa.respostas.length > 1 ? 's' : ''}
                                        </span>
                                        <button onclick="responderComoAdmin(${conversa.id})" class="btn btn-sm btn-primary">
                                            <i data-lucide="reply" class="w-4 h-4"></i>
                                            Responder
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="space-y-2">
                                    ${conversa.respostas.map(resposta => `
                                        <div class="bg-gray-50 p-3 rounded-lg">
                                            <div class="flex items-center justify-between mb-1">
                                                <span class="text-sm font-medium text-gray-600">
                                                    ${resposta.origem === 'admin' ? 'Admin' : 'Convidado'}
                                                </span>
                                                <span class="text-xs text-gray-400">
                                                    ${new Date(resposta.dataCriacao).toLocaleString('pt-PT')}
                                                </span>
                                            </div>
                                            <p class="text-sm text-gray-800">${resposta.mensagem}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function responderComoAdmin(notificacaoId) {
            const notificacao = notificacoes.find(n => n.id === notificacaoId);
            if (!notificacao) {
                mostrarNotificacao('Notifica√ß√£o n√£o encontrada!', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <h3 class="text-lg font-semibold mb-4">Responder como Admin</h3>
                    
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-800">${notificacao.titulo}</h4>
                        <p class="text-sm text-gray-600 mt-1">${notificacao.mensagem}</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sua Resposta</label>
                            <textarea id="respostaAdmin" rows="4" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite sua resposta..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="fecharModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button onclick="enviarRespostaAdmin(${notificacaoId})" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Enviar Resposta
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function enviarRespostaAdmin(notificacaoId) {
            const resposta = document.getElementById('respostaAdmin').value;
            
            if (!resposta.trim()) {
                mostrarNotificacao('Digite uma resposta!', 'error');
                return;
            }
            
            const notificacao = notificacoes.find(n => n.id === notificacaoId);
            if (notificacao) {
                // Inicializar array de respostas se n√£o existir
                if (!notificacao.respostas) {
                    notificacao.respostas = [];
                }
                
                // Adicionar resposta do admin
                const novaResposta = {
                    id: Date.now(),
                    mensagem: resposta,
                    origem: 'admin',
                    dataCriacao: new Date().toISOString()
                };
                
                notificacao.respostas.push(novaResposta);
                
                // Salvar dados
                salvarDados('notificacoes', notificacoes);
                
                mostrarNotificacao('Resposta enviada com sucesso!', 'success');
                fecharModal();
                carregarSecao('notificacoes');
            }
        }

        function filtrarPrazos() {
            const busca = document.getElementById('buscaPrazos')?.value.toLowerCase() || '';
            
            const prazosFiltrados = prazos.filter(prazo => {
                return prazo.clienteNome.toLowerCase().includes(busca) || 
                       prazo.tipo.toLowerCase().includes(busca) ||
                       prazo.descricao.toLowerCase().includes(busca);
            });
            
            atualizarListaPrazos(prazosFiltrados);
        }

        function atualizarListaPrazos(prazosFiltrados) {
            const tbody = document.getElementById('listaPrazos');
            if (!tbody) return;
            
            tbody.innerHTML = prazosFiltrados.map(prazo => `
                <tr>
                    <td>${prazo.clienteNome}</td>
                    <td>${prazo.tipo}</td>
                    <td>${prazo.descricao}</td>
                    <td>${prazo.dataLimite ? new Date(prazo.dataLimite).toLocaleDateString('pt-PT') : 'Data n√£o definida'}</td>
                    <td><span class="status-badge status-${prazo.prioridade}">${prazo.prioridade}</span></td>
                    <td><span class="status-badge status-${prazo.status}">${prazo.status}</span></td>
                    <td>
                        <button onclick="editarItem('prazo', ${prazo.id})" class="text-blue-600 hover:text-blue-800">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirItem('prazo', ${prazo.id})" class="text-red-600 hover:text-red-800 ml-2">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Sistema de inicializa√ß√£o movido para dentro da verifica√ß√£o de login

        // === FUN√á√ïES DAS NOVAS SE√á√ïES ===

        function gerarHerancas() {
            const totalHerancas = herancas.length;
            const herancasAtivas = herancas.filter(h => h.status === 'em_andamento').length;
            const herancasSuspensas = herancas.filter(h => h.status === 'pendente').length;
            const herancasTerminadas = herancas.filter(h => h.status === 'concluido').length;
            const valorTotalHerancas = herancas.reduce((total, h) => total + (h.valorComIva || h.valor || 0), 0);

            return `
                <div class="space-y-6">
                    <!-- Header √∫nico com bot√µes de a√ß√£o -->
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-3">
                            <button onclick="abrirModalHeranca()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Nova Heran√ßa
                            </button>
                        </div>
                    </div>

                    <!-- Estat√≠sticas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${herancasAtivas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Suspensos</p>
                                    <p class="text-2xl font-bold text-gray-900">${herancasSuspensas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Terminados</p>
                                    <p class="text-2xl font-bold text-gray-900">${herancasTerminadas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${Number(valorTotalHerancas).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de busca -->
                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaHerancas" placeholder="Buscar heran√ßas..." 
                                   class="search-input" onkeyup="filtrarHerancas()">
                        </div>
                        
                        <!-- Filtros Avan√ßados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusHeranca" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHerancas()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Conclu√≠do</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="filtroTipoHeranca" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHerancas()">
                                    <option value="">Todos os tipos</option>
                                    <option value="Aceita√ß√£o da heran√ßa">Aceita√ß√£o da heran√ßa</option>
                                    <option value="Doa√ß√µes">Doa√ß√µes</option>
                                    <option value="Escrituras de partilha">Escrituras de partilha</option>
                                    <option value="Habilita√ß√£o de herdeiros">Habilita√ß√£o de herdeiros</option>
                                    <option value="Partilhas em vida">Partilhas em vida</option>
                                    <option value="Partilhas por √≥bito">Partilhas por √≥bito</option>
                                    <option value="Processo de invent√°rio">Processo de invent√°rio</option>
                                    <option value="Ren√∫ncia √† heran√ßa">Ren√∫ncia √† heran√ßa</option>
                                    <option value="Testamentos">Testamentos</option>
                                </select>
                            </div>
                            
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIF</label>
                                <input type="text" id="filtroNifHeranca" placeholder="Buscar por NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHerancas()">
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosHerancas()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorHerancas">0</span> heran√ßas encontradas
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="overflow-x-auto table-responsive">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Descri√ß√£o</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Data In√≠cio</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                    </tr>
                                </thead>
                <tbody id="listaHerancas" class="bg-white divide-y divide-gray-200">
                    <!-- DADOS DE TESTE DIRETOS PARA VERIFICAR A√á√ïES -->
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">TESTE HERAN√áA DIRETO</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">TESTE</td>
                        <td class="px-6 py-4 text-sm text-gray-500">TESTE PARA VERIFICAR A√á√ïES</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div class="text-sm font-bold text-black">‚Ç¨1000.00</div>
                            <div class="text-xs font-bold text-red-600">+ IVA: ‚Ç¨1230.00</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-badge status-em_andamento">Em Andamento</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">15/10/2025</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="console.log('üîß Bot√£o EDITAR clicado'); editarHerancaDireto(1)" style="background: blue; color: white; padding: 8px; border: none; border-radius: 4px; margin: 2px; cursor: pointer; font-weight: bold; display: inline-block; width: 80px; height: 40px; position: relative; z-index: 9999; visibility: visible; opacity: 1; !important">
                                EDITAR
                            </button>
                            <button onclick="console.log('üîß Bot√£o ANEXAR clicado'); abrirAnexosHeranca(1)" style="background: green; color: white; padding: 8px; border: none; border-radius: 4px; margin: 2px; cursor: pointer; font-weight: bold; display: inline-block; width: 80px; height: 40px; position: relative; z-index: 9999; visibility: visible; opacity: 1; !important">
                                ANEXAR
                            </button>
                            <button onclick="console.log('üîß Bot√£o ELIMINAR clicado'); excluirHerancaDireto(1)" style="background: red; color: white; padding: 8px; border: none; border-radius: 4px; margin: 2px; cursor: pointer; font-weight: bold; display: inline-block; width: 80px; height: 40px; position: relative; z-index: 9999; visibility: visible; opacity: 1; !important">
                                ELIMINAR
                            </button>
                        </td>
                    </tr>
                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarConvidados() {
            const convidados = obterConvidados();
            const convidadosAtivos = convidados.filter(c => c.ativo).length;
            const convidadosInativos = convidados.filter(c => !c.ativo).length;
            const totalConvidados = convidados.length;

            return `
                <div class="space-y-6">
                    <!-- Header com bot√µes de a√ß√£o -->
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-3">
                            <button onclick="abrirModalNovoConvidado()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
                                Novo Convidado
                            </button>
                        </div>
                    </div>

                    <!-- Estat√≠sticas -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalConvidados}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${convidadosAtivos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="user-x" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Inativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${convidadosInativos}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Convidados -->
                    <div class="card">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Lista de Convidados</h3>
                            
                            <div class="table-responsive">
                                <table class="w-full">
                                    <thead>
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√≥digo</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clientes Autorizados</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Cria√ß√£o</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaConvidados">
                                        ${convidados.map(convidado => `
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${convidado.nome}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${convidado.codigo}</td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="status-badge status-${convidado.ativo ? 'ativo' : 'inativo'}">${convidado.ativo ? 'Ativo' : 'Inativo'}</span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${convidado.clientesAutorizados.length} cliente(s)</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(convidado.dataCriacao).toLocaleDateString('pt-PT')}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                    <button onclick="abrirModalEditarPermissoes(${convidado.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar Permiss√µes">
                                                        <i data-lucide="settings" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="ativarDesativarConvidado(${convidado.id}, ${!convidado.ativo})" class="text-${convidado.ativo ? 'red' : 'green'}-600 hover:text-${convidado.ativo ? 'red' : 'green'}-900 mr-2" title="${convidado.ativo ? 'Desativar' : 'Ativar'}">
                                                        <i data-lucide="${convidado.ativo ? 'user-x' : 'user-check'}" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="copiarCodigoConvidado('${convidado.codigo}')" class="text-gray-600 hover:text-gray-900" title="Copiar C√≥digo">
                                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // FUN√á√ïES AUXILIARES PARA GEST√ÉO DE CONVIDADOS
        function abrirModalNovoConvidado() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">Novo Convidado</h3>
                            <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formNovoConvidado" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Convidado</label>
                                <input type="text" id="nomeConvidado" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite o nome" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Clientes Autorizados</label>
                                <div id="listaClientesConvidado" class="space-y-2 max-h-40 overflow-y-auto">
                                    <!-- Lista de clientes ser√° carregada aqui -->
                                </div>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button type="button" onclick="fecharModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                                    Cancelar
                                </button>
                                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                    Criar Convidado
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Carregar lista de clientes
            carregarClientesParaConvidado();
            
            document.getElementById('formNovoConvidado').addEventListener('submit', function(e) {
                e.preventDefault();
                const nome = document.getElementById('nomeConvidado').value;
                const clientesSelecionados = Array.from(document.querySelectorAll('#listaClientesConvidado input[type="checkbox"]:checked'))
                    .map(cb => parseInt(cb.value));
                
                const novoConvidado = criarConvidado(nome, clientesSelecionados);
                mostrarNotificacao(`Convidado criado! C√≥digo: ${novoConvidado.codigo}`, 'success');
                fecharModal();
                carregarSecao('convidados');
            });
        }
        
        function carregarClientesParaConvidado() {
            const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
            const container = document.getElementById('listaClientesConvidado');
            
            if (clientes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum cliente cadastrado</p>';
                return;
            }
            
            container.innerHTML = clientes.map(cliente => `
                <label class="flex items-center space-x-2">
                    <input type="checkbox" value="${cliente.id}" class="rounded border-gray-300">
                    <span class="text-sm text-gray-700">${cliente.nome}</span>
                </label>
            `).join('');
        }
        
        function abrirModalEditarPermissoes(id) {
            const convidados = obterConvidados();
            const convidado = convidados.find(c => c.id === id);
            
            if (!convidado) {
                mostrarNotificacao('Convidado n√£o encontrado!', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">Editar Permiss√µes - ${convidado.nome}</h3>
                            <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formEditarPermissoes" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Clientes Autorizados</label>
                                <div id="listaClientesEdicao" class="space-y-2 max-h-40 overflow-y-auto">
                                    <!-- Lista de clientes ser√° carregada aqui -->
                                </div>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button type="button" onclick="fecharModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                                    Cancelar
                                </button>
                                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                    Salvar Permiss√µes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Carregar lista de clientes com sele√ß√µes atuais
            carregarClientesParaEdicao(convidado.clientesAutorizados);
            
            document.getElementById('formEditarPermissoes').addEventListener('submit', function(e) {
                e.preventDefault();
                const clientesSelecionados = Array.from(document.querySelectorAll('#listaClientesEdicao input[type="checkbox"]:checked'))
                    .map(cb => parseInt(cb.value));
                
                console.log('üîß Formul√°rio submetido, clientes selecionados:', clientesSelecionados);
                console.log('üîß ID do convidado:', id);
                console.log('üîß Chamando editarPermissoesConvidado...');
                
                editarPermissoesConvidado(id, clientesSelecionados);
                console.log('üîß editarPermissoesConvidado chamado com sucesso');
                mostrarNotificacao('Permiss√µes atualizadas com sucesso!', 'success');
                fecharModal();
            });
        }
        
        function carregarClientesParaEdicao(clientesAutorizados) {
            const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
            const container = document.getElementById('listaClientesEdicao');
            
            if (clientes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum cliente cadastrado</p>';
                return;
            }
            
            container.innerHTML = clientes.map(cliente => `
                <label class="flex items-center space-x-2">
                    <input type="checkbox" value="${cliente.id}" ${clientesAutorizados.includes(cliente.id) ? 'checked' : ''} class="rounded border-gray-300">
                    <span class="text-sm text-gray-700">${cliente.nome}</span>
                </label>
            `).join('');
        }
        
        function ativarDesativarConvidado(id, ativo) {
            ativarDesativarConvidado(id, ativo);
            mostrarNotificacao(`Convidado ${ativo ? 'ativado' : 'desativado'} com sucesso!`, 'success');
            carregarSecao('convidados');
        }
        
        function copiarCodigoConvidado(codigo) {
            navigator.clipboard.writeText(codigo).then(() => {
                mostrarNotificacao('C√≥digo copiado para a √°rea de transfer√™ncia!', 'success');
            }).catch(() => {
                // Fallback para navegadores mais antigos
                const textArea = document.createElement('textarea');
                textArea.value = codigo;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                mostrarNotificacao('C√≥digo copiado para a √°rea de transfer√™ncia!', 'success');
            });
        }

        function gerarMigracao() {
            console.log('üîß gerarMigracao chamado');
            console.log('üîß migracoes array:', migracoes);
            console.log('üîß migracoes length:', migracoes ? migracoes.length : 'undefined');
            
            // FOR√áAR CRIA√á√ÉO DE MIGRA√á√ÉO DE TESTE APENAS SE N√ÉO H√Å MIGRA√á√ïES
            if (!migracoes || migracoes.length === 0) {
                console.log('üîß FOR√áANDO CRIA√á√ÉO DE MIGRA√á√ÉO DE TESTE');
                migracoes = [{
                    id: 999,
                    clienteId: 1,
                    clienteNome: 'TESTE IVA DEFINITIVO',
                    tipo: 'TESTE IVA',
                    descricao: 'TESTE PARA VERIFICAR IVA',
                    valor: 1000,
                    iva: 23,
                    valorComIva: 1230,
                    status: 'em_andamento',
                    dataInicio: new Date().toISOString().split('T')[0]
                }];
                console.log('üîß MIGRA√á√ÉO DE TESTE CRIADA:', migracoes[0]);
            }
            
            // Garantir que migracoes existe
            if (!migracoes) {
                migracoes = [];
            }
            
            const totalMigracoes = migracoes.length;
            const migracoesAtivas = migracoes.filter(m => m.status === 'em_andamento').length;
            const migracoesSuspensas = migracoes.filter(m => m.status === 'pendente').length;
            const migracoesTerminadas = migracoes.filter(m => m.status === 'concluido').length;
            const valorTotalMigracoes = migracoes.reduce((total, m) => {
                const valor = parseFloat(m.valor) || 0;
                return total + valor;
            }, 0);

            return `
                <div class="space-y-6">
                    <!-- Header √∫nico com bot√µes de a√ß√£o -->
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-3">
                            <button onclick="abrirModalMigracaoDireto()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Nova Migra√ß√£o
                            </button>
                        </div>
                    </div>

                    <!-- Estat√≠sticas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${migracoesAtivas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Suspensos</p>
                                    <p class="text-2xl font-bold text-gray-900">${migracoesSuspensas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Terminados</p>
                                    <p class="text-2xl font-bold text-gray-900">${migracoesTerminadas}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${Number(valorTotalMigracoes).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de busca -->
                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaMigracoes" placeholder="Buscar migra√ß√µes..." 
                                   class="search-input" onkeyup="filtrarMigracoes()">
                        </div>
                        
                        <!-- Filtros Avan√ßados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusMigracao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosMigracoes()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Conclu√≠do</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="filtroTipoMigracao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosMigracoes()">
                                    <option value="">Todos os tipos</option>
                                    <option value="Autoriza√ß√£o de resid√™ncia">Autoriza√ß√£o de resid√™ncia</option>
                                    <option value="Certificados de resid√™ncia permanente">Certificados de resid√™ncia permanente</option>
                                    <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                    <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                    <option value="Renova√ß√£o de autoriza√ß√µes">Renova√ß√£o de autoriza√ß√µes</option>
                                    <option value="Vistos D7">Vistos D7</option>
                                    <option value="Vistos Gold">Vistos Gold</option>
                                    <option value="Vistos para estudantes">Vistos para estudantes</option>
                                    <option value="Vistos para trabalho">Vistos para trabalho</option>
                                </select>
                            </div>
                            
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIF</label>
                                <input type="text" id="filtroNifMigracao" placeholder="Buscar por NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosMigracoes()">
                                <!-- Campo NIF adicionado -->
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosMigracoes()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorMigracoes">0</span> migra√ß√µes encontradas
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="overflow-x-auto table-responsive">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Descri√ß√£o</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Data In√≠cio</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="listaMigracoes" class="bg-white divide-y divide-gray-200">
                                    ${migracoes.map(migracao => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${migracao.clienteNome || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.tipo || 'N/A'}</td>
                                            <td class="px-6 py-4 text-sm text-gray-500">${migracao.descricao || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <div class="text-sm font-bold text-black">‚Ç¨${(migracao.valor || 0).toFixed(2)}</div>
                                                <div class="text-xs font-bold text-red-600">+ IVA: ‚Ç¨${((migracao.valor || 0) + ((migracao.valor || 0) * (migracao.iva || 0) / 100)).toFixed(2)}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="status-badge status-${migracao.status}">${migracao.status === 'concluido' ? 'Conclu√≠do' : migracao.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.dataInicio ? new Date(migracao.dataInicio).toLocaleDateString('pt-PT') : 'Data n√£o definida'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button onclick="console.log('üîß Bot√£o editar clicado para ID:', ${migracao.id}); editarMigracaoDireto(${migracao.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar">
                                                    <i data-lucide="edit" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="abrirAnexosMigracao(${migracao.id})" class="text-green-600 hover:text-green-900 mr-2" title="Documentos">
                                                    <i data-lucide="paperclip" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="console.log('üîß Bot√£o excluir clicado para ID:', ${migracao.id}); excluirMigracaoDireto(${migracao.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarRegistos() {
            const totalRegistos = registos.length;
            const registosAtivos = registos.filter(r => r.status === 'em_andamento').length;
            const registosSuspensos = registos.filter(r => r.status === 'pendente').length;
            const registosTerminados = registos.filter(r => r.status === 'concluido').length;
            const valorTotalRegistos = registos.reduce((total, r) => total + (r.valorComIva || r.valor || 0), 0);

            return `
                <div class="space-y-6">
                    <!-- Header √∫nico com bot√µes de a√ß√£o -->
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-3">
                            <button onclick="abrirModalRegisto()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Novo Registo
                            </button>
                        </div>
                    </div>

                    <!-- Estat√≠sticas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900">${registosAtivos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Suspensos</p>
                                    <p class="text-2xl font-bold text-gray-900">${registosSuspensos}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Terminados</p>
                                    <p class="text-2xl font-bold text-gray-900">${registosTerminados}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Valor Total</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${Number(valorTotalRegistos).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de busca -->
                    <div class="card p-6">
                        <div class="search-container mb-4">
                            <i data-lucide="search" class="search-icon w-4 h-4"></i>
                            <input type="text" id="buscaRegistos" placeholder="Buscar registos..." 
                                   class="search-input" onkeyup="filtrarRegistos()">
                        </div>
                        
                        <!-- Filtros Avan√ßados -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="filtroStatusRegisto" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosRegistos()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Conclu√≠do</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="filtroTipoRegisto" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosRegistos()">
                                    <option value="">Todos os tipos</option>
                                    <option value="Autentica√ß√£o de documentos">Autentica√ß√£o de documentos</option>
                                    <option value="Certifica√ß√£o de fotoc√≥pias">Certifica√ß√£o de fotoc√≥pias</option>
                                    <option value="Documentos para o estrangeiro">Documentos para o estrangeiro</option>
                                    <option value="Procura√ß√µes">Procura√ß√µes</option>
                                    <option value="Reconhecimento presencial de assinaturas">Reconhecimento presencial de assinaturas</option>
                                    <option value="Registos autom√≥veis">Registos autom√≥veis</option>
                                    <option value="Registos comerciais">Registos comerciais</option>
                                    <option value="Registos de propriedade">Registos de propriedade</option>
                                    <option value="Termos de autentica√ß√£o">Termos de autentica√ß√£o</option>
                                </select>
                            </div>
                            
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIF</label>
                                <input type="text" id="filtroNifRegisto" placeholder="Buscar por NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosRegistos()">
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="limparFiltrosRegistos()" class="btn btn-secondary">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                Limpar Filtros
                            </button>
                            <div class="text-sm text-gray-600">
                                <span id="contadorRegistos">0</span> registos encontrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="overflow-x-auto table-responsive">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Descri√ß√£o</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Data In√≠cio</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                    </tr>
                                </thead>
                <tbody id="listaRegistos" class="bg-white divide-y divide-gray-200">
                    <!-- Conte√∫do ser√° carregado via atualizarListaRegistos() -->
                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }


        // === FUN√á√ïES DE FILTRO ===

        function filtrarHerancas() {
            aplicarFiltrosHerancas();
        }

        function aplicarFiltrosHerancas() {
            const busca = document.getElementById('buscaHerancas')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusHeranca')?.value || '';
            const tipo = document.getElementById('filtroTipoHeranca')?.value || '';
            const nif = document.getElementById('filtroNifHeranca')?.value || '';
            
            const herancasFiltradas = herancas.filter(heranca => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    heranca.clienteNome.toLowerCase().includes(busca) || 
                    heranca.tipo.toLowerCase().includes(busca) ||
                    heranca.observacoes.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || heranca.status === status;
                
                // Filtro por tipo
                const matchTipo = !tipo || heranca.tipo === tipo;
                
                
                // Filtro por NIF
                const cliente = clientes.find(c => c.id === heranca.clienteId);
                const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));
                
                return matchBusca && matchStatus && matchTipo && matchNif;
            });
            
            atualizarListaHerancas(herancasFiltradas);
            document.getElementById('contadorHerancas').textContent = herancasFiltradas.length;
        }

        function limparFiltrosHerancas() {
            document.getElementById('buscaHerancas').value = '';
            document.getElementById('filtroStatusHeranca').value = '';
            document.getElementById('filtroTipoHeranca').value = '';
            document.getElementById('filtroValorMinHeranca').value = '';
            document.getElementById('filtroValorMaxHeranca').value = '';
            document.getElementById('filtroNifHeranca').value = '';
            aplicarFiltrosHerancas();
        }

        function filtrarMigracoes() {
            aplicarFiltrosMigracoes();
        }

        function aplicarFiltrosMigracoes() {
            const busca = document.getElementById('buscaMigracoes')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusMigracao')?.value || '';
            const tipo = document.getElementById('filtroTipoMigracao')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinMigracao')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxMigracao')?.value) || Infinity;
            const nif = document.getElementById('filtroNifMigracao')?.value || '';
            
            const migracoesFiltradas = migracoes.filter(migracao => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    migracao.clienteNome.toLowerCase().includes(busca) || 
                    migracao.tipo.toLowerCase().includes(busca) ||
                    migracao.observacoes.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || migracao.status === status;
                
                // Filtro por tipo
                const matchTipo = !tipo || migracao.tipo === tipo;
                
                // Filtro por valor
                const valor = parseFloat(migracao.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                // Filtro por NIF
                const cliente = clientes.find(c => c.id === migracao.clienteId);
                const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));
                
                return matchBusca && matchStatus && matchTipo && matchValor && matchNif;
            });
            
            atualizarListaMigracoes(migracoesFiltradas);
            document.getElementById('contadorMigracoes').textContent = migracoesFiltradas.length;
        }

        function limparFiltrosMigracoes() {
            document.getElementById('buscaMigracoes').value = '';
            document.getElementById('filtroStatusMigracao').value = '';
            document.getElementById('filtroTipoMigracao').value = '';
            document.getElementById('filtroValorMinMigracao').value = '';
            document.getElementById('filtroValorMaxMigracao').value = '';
            document.getElementById('filtroNifMigracao').value = '';
            aplicarFiltrosMigracoes();
        }

        function filtrarRegistos() {
            aplicarFiltrosRegistos();
        }

        function aplicarFiltrosRegistos() {
            const busca = document.getElementById('buscaRegistos')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusRegisto')?.value || '';
            const tipo = document.getElementById('filtroTipoRegisto')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinRegisto')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxRegisto')?.value) || Infinity;
            const nif = document.getElementById('filtroNifRegisto')?.value || '';
            
            const registosFiltrados = registos.filter(registo => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    registo.clienteNome.toLowerCase().includes(busca) || 
                    registo.tipo.toLowerCase().includes(busca) ||
                    registo.observacoes.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || registo.status === status;
                
                // Filtro por tipo
                const matchTipo = !tipo || registo.tipo === tipo;
                
                // Filtro por valor
                const valor = parseFloat(registo.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;
                
                // Filtro por NIF
                const cliente = clientes.find(c => c.id === registo.clienteId);
                const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));
                
                return matchBusca && matchStatus && matchTipo && matchValor && matchNif;
            });
            
            atualizarListaRegistos(registosFiltrados);
            document.getElementById('contadorRegistos').textContent = registosFiltrados.length;
        }

        function limparFiltrosRegistos() {
            document.getElementById('buscaRegistos').value = '';
            document.getElementById('filtroStatusRegisto').value = '';
            document.getElementById('filtroTipoRegisto').value = '';
            document.getElementById('filtroValorMinRegisto').value = '';
            document.getElementById('filtroValorMaxRegisto').value = '';
            document.getElementById('filtroNifRegisto').value = '';
            aplicarFiltrosRegistos();
        }

        function filtrarPrazos() {
            aplicarFiltrosPrazos();
        }

        function aplicarFiltrosPrazos() {
            const busca = document.getElementById('buscaPrazos')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatusPrazo')?.value || '';
            const tipo = document.getElementById('filtroTipoPrazo')?.value || '';
            const vencimento = document.getElementById('filtroVencimentoPrazo')?.value || '';
            const prioridade = document.getElementById('filtroPrioridadePrazo')?.value || '';
            
            const prazosFiltrados = prazos.filter(prazo => {
                // Filtro por busca de texto
                const matchBusca = !busca || 
                    prazo.clienteNome.toLowerCase().includes(busca) || 
                    prazo.descricao.toLowerCase().includes(busca) ||
                    prazo.tipo.toLowerCase().includes(busca);
                
                // Filtro por status
                const matchStatus = !status || prazo.status === status;
                
                // Filtro por tipo
                const matchTipo = !tipo || prazo.tipo === tipo;
                
                // Filtro por vencimento
                let matchVencimento = true;
                if (vencimento && prazo.dataLimite) {
                    const dataLimite = new Date(prazo.dataLimite);
                    const hoje = new Date();
                    
                    switch (vencimento) {
                        case 'hoje':
                            matchVencimento = dataLimite.toDateString() === hoje.toDateString();
                            break;
                        case 'semana':
                            const fimSemana = new Date(hoje);
                            fimSemana.setDate(hoje.getDate() + 7);
                            matchVencimento = dataLimite >= hoje && dataLimite <= fimSemana;
                            break;
                        case 'mes':
                            const fimMes = new Date(hoje);
                            fimMes.setMonth(hoje.getMonth() + 1);
                            matchVencimento = dataLimite >= hoje && dataLimite <= fimMes;
                            break;
                        case 'vencido':
                            matchVencimento = dataLimite < hoje;
                            break;
                    }
                }
                
                // Filtro por prioridade
                const matchPrioridade = !prioridade || prazo.prioridade === prioridade;
                
                return matchBusca && matchStatus && matchTipo && matchVencimento && matchPrioridade;
            });
            
            atualizarListaPrazos(prazosFiltrados);
            document.getElementById('contadorPrazos').textContent = prazosFiltrados.length;
        }

        function limparFiltrosPrazos() {
            document.getElementById('buscaPrazos').value = '';
            document.getElementById('filtroStatusPrazo').value = '';
            document.getElementById('filtroTipoPrazo').value = '';
            document.getElementById('filtroVencimentoPrazo').value = '';
            document.getElementById('filtroPrioridadePrazo').value = '';
            aplicarFiltrosPrazos();
        }

        function atualizarListaPrazos(prazosFiltrados) {
            const tbody = document.getElementById('listaPrazos');
            if (!tbody) return;
            
            tbody.innerHTML = prazosFiltrados.map(prazo => `
                <tr>
                    <td>${prazo.clienteNome}</td>
                    <td>${prazo.tipo}</td>
                    <td>${prazo.descricao}</td>
                    <td>${new Date(prazo.dataLimite).toLocaleDateString('pt-PT')}</td>
                    <td><span class="status-badge status-${prazo.prioridade}">${prazo.prioridade}</span></td>
                    <td><span class="status-badge status-${prazo.status}">${prazo.status === 'concluido' ? 'Conclu√≠do' : prazo.status === 'vencido' ? 'Vencido' : prazo.status === 'cancelado' ? 'Cancelado' : 'Ativo'}</span></td>
                    <td>
                        <button onclick="editarItem('prazo', ${prazo.id})" class="text-blue-600 hover:text-blue-800">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirItem('prazo', ${prazo.id})" class="text-red-600 hover:text-red-800 ml-2">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }


        // === FUN√á√ïES DE ATUALIZA√á√ÉO DE LISTAS ===

        function atualizarListaHerancas(herancasFiltradas) {
            console.log('üîß atualizarListaHerancas REABILITADO - carregando heran√ßas reais');
            console.log('üîß herancasFiltradas:', herancasFiltradas);
            console.log('üîß herancasFiltradas.length:', herancasFiltradas ? herancasFiltradas.length : 'undefined');
            
            const tbody = document.getElementById('listaHerancas');
            if (!tbody) {
                console.log('‚ùå tbody listaHerancas n√£o encontrado');
                return;
            }
            console.log('‚úÖ tbody listaHerancas encontrado');
            
            const html = herancasFiltradas.map(heranca => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${heranca.clienteNome || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${heranca.tipo || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${heranca.descricao || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="text-sm font-bold text-black">‚Ç¨${Number(heranca.valor || 0).toFixed(2)}</div>
                        <div class="text-xs font-bold text-red-600">+ IVA: ‚Ç¨${(Number(heranca.valor || 0) + (Number(heranca.valor || 0) * Number(heranca.iva || 0) / 100)).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge status-${heranca.status || 'pendente'}">${heranca.status || 'Pendente'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${heranca.dataInicio || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editarHerancaDireto(${heranca.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="abrirAnexosHeranca(${heranca.id})" class="text-green-600 hover:text-green-900 mr-2" title="Documentos">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirHerancaDireto(${heranca.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html;
            console.log('‚úÖ HTML inserido no tbody listaHerancas');
            console.log('üîß TESTE: Verificando se tbody tem conte√∫do:', tbody.innerHTML.length);
            
            // FOR√áAR RENDERIZA√á√ÉO DOS √çCONES
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('üîß √çcones Lucide renderizados');
                }
            }, 100);
        }

        function atualizarListaMigracoes(migracoesFiltradas) {
            const tbody = document.getElementById('listaMigracoes');
            if (!tbody) return;
            
            tbody.innerHTML = migracoesFiltradas.map(migracao => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${migracao.clienteNome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.tipo}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${migracao.descricao}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="text-sm font-bold text-black">‚Ç¨${(migracao.valor || 0).toFixed(2)}</div>
                        <div class="text-xs font-bold text-red-600">+ IVA: ‚Ç¨${((migracao.valor || 0) + ((migracao.valor || 0) * (migracao.iva || 0) / 100)).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge status-${migracao.status}">${migracao.status === 'concluido' ? 'Conclu√≠do' : migracao.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.dataInicio ? new Date(migracao.dataInicio).toLocaleDateString('pt-PT') : 'Data n√£o definida'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editarMigracaoSimples(${migracao.id})" class="text-blue-600 hover:text-blue-900 mr-3" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="abrirAnexosMigracao(${migracao.id})" class="text-green-600 hover:text-green-900 mr-3" title="Documentos">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirMigracao(${migracao.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function atualizarListaRegistos(registosFiltrados) {
            console.log('üîß atualizarListaRegistos REABILITADO - carregando registos reais');
            console.log('üîß registosFiltrados:', registosFiltrados);
            console.log('üîß registosFiltrados.length:', registosFiltrados ? registosFiltrados.length : 'undefined');
            
            const tbody = document.getElementById('listaRegistos');
            if (!tbody) {
                console.log('‚ùå tbody listaRegistos n√£o encontrado');
                return;
            }
            console.log('‚úÖ tbody listaRegistos encontrado');
            
            const html = registosFiltrados.map(registo => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${registo.clienteNome || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registo.tipo || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${registo.descricao || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="text-sm font-bold text-black">‚Ç¨${Number(registo.valor || 0).toFixed(2)}</div>
                        <div class="text-xs font-bold text-red-600">+ IVA: ‚Ç¨${(Number(registo.valor || 0) + (Number(registo.valor || 0) * Number(registo.iva || 0) / 100)).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge status-${registo.status || 'pendente'}">${registo.status || 'Pendente'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registo.dataInicio || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editarRegistoDireto(${registo.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="abrirAnexosRegisto(${registo.id})" class="text-green-600 hover:text-green-900 mr-2" title="Documentos">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirRegistoDireto(${registo.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html;
            console.log('‚úÖ HTML inserido no tbody listaRegistos');
            console.log('üîß TESTE: Verificando se tbody tem conte√∫do:', tbody.innerHTML.length);
            console.log('üîß HTML gerado:', html.substring(0, 500) + '...');
            
            // FOR√áAR RENDERIZA√á√ÉO DOS √çCONES
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                    console.log('üîß √çcones Lucide renderizados');
                }
            }, 100);
        }


        // === FUN√á√ïES DE MODAL E CRUD ===

        function abrirModalHeranca() {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Nova Heran√ßa</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form id="formHeranca" onsubmit="salvarHeranca(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Aceita√ß√£o da heran√ßa">Aceita√ß√£o da heran√ßa</option>
                                            <option value="Doa√ß√µes">Doa√ß√µes</option>
                                            <option value="Escrituras de partilha">Escrituras de partilha</option>
                                            <option value="Habilita√ß√£o de herdeiros">Habilita√ß√£o de herdeiros</option>
                                            <option value="Partilhas em vida">Partilhas em vida</option>
                                            <option value="Partilhas por √≥bito">Partilhas por √≥bito</option>
                                            <option value="Processo de invent√°rio">Processo de invent√°rio</option>
                                            <option value="Ren√∫ncia √† heran√ßa">Ren√∫ncia √† heran√ßa</option>
                                            <option value="Testamentos">Testamentos</option>
                                            <option value="Invent√°rio">Invent√°rio</option>
                                            <option value="Partilha">Partilha</option>
                                            <option value="Testamento">Testamento</option>
                                            <option value="Doa√ß√£o">Doa√ß√£o</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select name="iva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0">0% (Isento)</option>
                                                <option value="6">6% (Reduzida)</option>
                                                <option value="13">13% (Interm√©dia)</option>
                                                <option value="23" selected>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                            <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('heranca')">
                                                <option value="sem">Sem parceria</option>
                                                <option value="empresa">Empresa</option>
                                                <option value="pessoa">Pessoa</option>
                                            </select>
                                        </div>
                                        
                                        <div id="herancaParceriaNomeDiv" style="display: none;">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                            <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                            <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente">Pendente</option>
                                                <option value="em_andamento">Em Andamento</option>
                                                <option value="concluido">Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                            <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observa√ß√µes adicionais sobre a heran√ßa..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Heran√ßa
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        function criarModalMigracao() {
            return `
                <div class="modal show" onclick="fecharModal()">
                    <div class="modal-content p-6" style="max-width: 600px;" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Nova Migra√ß√£o</h3>
                            <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <form id="formMigracao" onsubmit="salvarMigracao(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                    <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Autoriza√ß√£o de resid√™ncia">Autoriza√ß√£o de resid√™ncia</option>
                                        <option value="Certificados de resid√™ncia permanente">Certificados de resid√™ncia permanente</option>
                                        <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                        <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                        <option value="Renova√ß√£o de autoriza√ß√µes">Renova√ß√£o de autoriza√ß√µes</option>
                                        <option value="Vistos D7">Vistos D7</option>
                                        <option value="Vistos Gold">Vistos Gold</option>
                                        <option value="Vistos para estudantes">Vistos para estudantes</option>
                                        <option value="Vistos para trabalho">Vistos para trabalho</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor (‚Ç¨) *</label>
                                        <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="0.00">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <input type="number" name="iva" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="23" value="23">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                                        <select name="status" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente">Pendente</option>
                                            <option value="em_andamento">Em Andamento</option>
                                            <option value="concluido">Conclu√≠do</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de In√≠cio *</label>
                                    <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                    <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observa√ß√µes adicionais sobre a migra√ß√£o..."></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Migra√ß√£o
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function abrirModalMigracaoDireto() {
            console.log('üîß abrirModalMigracaoDireto chamado');
            
            // Fechar qualquer modal aberto
            fecharModal();
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalNovaMigracao';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Nova Migra√ß√£o</h3>
                            <button onclick="document.getElementById('modalNovaMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form id="formMigracao" onsubmit="salvarMigracao(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                    <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Autoriza√ß√£o de resid√™ncia">Autoriza√ß√£o de resid√™ncia</option>
                                        <option value="Certificados de resid√™ncia permanente">Certificados de resid√™ncia permanente</option>
                                        <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                        <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                        <option value="Renova√ß√£o de autoriza√ß√µes">Renova√ß√£o de autoriza√ß√µes</option>
                                        <option value="Vistos D7">Vistos D7</option>
                                        <option value="Vistos Gold">Vistos Gold</option>
                                        <option value="Vistos para estudantes">Vistos para estudantes</option>
                                        <option value="Vistos para trabalho">Vistos para trabalho</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor (‚Ç¨) *</label>
                                        <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="0.00">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <input type="number" name="iva" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="23" value="23">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                                        <select name="status" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente">Pendente</option>
                                            <option value="em_andamento">Em Andamento</option>
                                            <option value="concluido">Conclu√≠do</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de In√≠cio *</label>
                                    <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                    <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('migracao')">
                                        <option value="sem">Sem parceria</option>
                                        <option value="empresa">Empresa</option>
                                        <option value="pessoa">Pessoa</option>
                                    </select>
                                </div>
                                
                                <div id="migracaoParceriaNomeDiv" style="display: none;">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                    <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                    <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                    <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observa√ß√µes adicionais sobre a migra√ß√£o..."></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="document.getElementById('modalNovaMigracao').remove()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Migra√ß√£o
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('‚úÖ Modal de migra√ß√£o criado e adicionado ao body');
        }
        
        // Tornar fun√ß√£o global
        window.abrirModalMigracaoDireto = abrirModalMigracaoDireto;

        function abrirModalMigracao() {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Nova Migra√ß√£o</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form id="formMigracao" onsubmit="salvarMigracao(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autoriza√ß√£o de resid√™ncia">Autoriza√ß√£o de resid√™ncia</option>
                                            <option value="Certificados de resid√™ncia permanente">Certificados de resid√™ncia permanente</option>
                                            <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                            <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                            <option value="Renova√ß√£o de autoriza√ß√µes">Renova√ß√£o de autoriza√ß√µes</option>
                                            <option value="Vistos D7">Vistos D7</option>
                                            <option value="Vistos Gold">Vistos Gold</option>
                                            <option value="Vistos para estudantes">Vistos para estudantes</option>
                                            <option value="Vistos para trabalho">Vistos para trabalho</option>
                                            <option value="Nacionalidade">Nacionalidade</option>
                                            <option value="Resid√™ncia">Resid√™ncia</option>
                                            <option value="Visto">Visto</option>
                                            <option value="Reagrupamento">Reagrupamento</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select name="iva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0">0% (Isento)</option>
                                                <option value="6">6% (Reduzida)</option>
                                                <option value="13">13% (Interm√©dia)</option>
                                                <option value="23" selected>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                            <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('heranca')">
                                                <option value="sem">Sem parceria</option>
                                                <option value="empresa">Empresa</option>
                                                <option value="pessoa">Pessoa</option>
                                            </select>
                                        </div>
                                        
                                        <div id="herancaParceriaNomeDiv" style="display: none;">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                            <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                            <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente">Pendente</option>
                                                <option value="em_andamento">Em Andamento</option>
                                                <option value="concluido">Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                            <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observa√ß√µes adicionais sobre a migra√ß√£o..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Migra√ß√£o
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        function abrirModalRegisto() {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Novo Registo</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form id="formRegisto" onsubmit="salvarRegisto(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autentica√ß√£o de documentos">Autentica√ß√£o de documentos</option>
                                            <option value="Certifica√ß√£o de fotoc√≥pias">Certifica√ß√£o de fotoc√≥pias</option>
                                            <option value="Documentos para o estrangeiro">Documentos para o estrangeiro</option>
                                            <option value="Procura√ß√µes">Procura√ß√µes</option>
                                            <option value="Reconhecimento presencial de assinaturas">Reconhecimento presencial de assinaturas</option>
                                            <option value="Registos autom√≥veis">Registos autom√≥veis</option>
                                            <option value="Registos comerciais">Registos comerciais</option>
                                            <option value="Registos de propriedade">Registos de propriedade</option>
                                            <option value="Termos de autentica√ß√£o">Termos de autentica√ß√£o</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select name="iva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0">0% (Isento)</option>
                                                <option value="6">6% (Reduzida)</option>
                                                <option value="13">13% (Interm√©dia)</option>
                                                <option value="23" selected>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                            <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('heranca')">
                                                <option value="sem">Sem parceria</option>
                                                <option value="empresa">Empresa</option>
                                                <option value="pessoa">Pessoa</option>
                                            </select>
                                        </div>
                                        
                                        <div id="herancaParceriaNomeDiv" style="display: none;">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                            <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                            <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente">Pendente</option>
                                                <option value="em_andamento">Em Andamento</option>
                                                <option value="concluido">Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                            <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observa√ß√µes adicionais sobre o registo..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Registo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        // === FUN√á√ïES DE SALVAMENTO ===

        function salvarHeranca(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const clienteId = parseInt(formData.get('clienteId'));
            const cliente = clientes.find(c => c.id === clienteId);
            
            const valor = parseFloat(formData.get('valor')) || 0;
            const iva = parseFloat(formData.get('iva')) || 0;
            const percentagem = parseFloat(formData.get('percentagem')) || 0;
            const valorComIva = valor + (valor * iva / 100);

            const novaHeranca = {
                id: herancas.length > 0 ? Math.max(...herancas.map(h => h.id)) + 1 : 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente n√£o encontrado',
                tipo: formData.get('tipo'),
                descricao: formData.get('descricao'),
                valor: valor,
                iva: iva,
                percentagem: percentagem,
                valorComIva: valorComIva,
                status: formData.get('status'),
                dataInicio: formData.get('dataInicio'),
                observacoes: formData.get('observacoes'),
                dataCriacao: new Date().toISOString()
            };

            herancas.unshift(novaHeranca);
            salvarDados('herancas', herancas);
            
            // Criar prazo autom√°tico para a heran√ßa
            const prazoHeranca = {
                id: Date.now() + 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente n√£o encontrado',
                descricao: `Prazo para ${novaHeranca.tipo} - ${novaHeranca.descricao}`,
                dataLimite: new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 60 dias
                status: 'ativo',
                tipo: 'heranca',
                referenciaId: novaHeranca.id,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoHeranca);
            salvarDados('prazos', prazos);
            
            mostrarNotificacao('Heran√ßa e prazo criados com sucesso!', 'success');
            fecharModal();
            carregarSecao('herancas');
            
            // Atualizar lista ap√≥s salvar
            setTimeout(() => {
                if (typeof atualizarListaHerancas === 'function') {
                    atualizarListaHerancas(herancas);
                }
            }, 200);
        }

        function salvarMigracao(event) {
            try {
            event.preventDefault();
                console.log('üîß salvarMigracao iniciado');
                console.log('üîß FormData:', event.target);
                
            const formData = new FormData(event.target);
            const clienteId = parseInt(formData.get('clienteId'));
            const cliente = clientes.find(c => c.id === clienteId);
            
            const valor = parseFloat(formData.get('valor')) || 0;
            const iva = parseFloat(formData.get('iva')) || 0;
            const percentagem = parseFloat(formData.get('percentagem')) || 0;
            const valorComIva = valor + (valor * iva / 100);
                
                console.log('üîß Valores calculados:');
                console.log('üîß valor:', valor);
                console.log('üîß iva:', iva);
                console.log('üîß valorComIva:', valorComIva);

            const novaMigracao = {
                id: migracoes.length > 0 ? Math.max(...migracoes.map(m => m.id)) + 1 : 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente n√£o encontrado',
                tipo: formData.get('tipo'),
                    descricao: '', // Campo n√£o existe no modal de Migra√ß√£o
                valor: valor,
                iva: iva,
                percentagem: percentagem,
                valorComIva: valorComIva,
                status: formData.get('status'),
                dataInicio: formData.get('dataInicio'),
                    parceria: formData.get('parceria'),
                    parceriaNome: formData.get('parceriaNome'),
                observacoes: formData.get('observacoes'),
                dataCriacao: new Date().toISOString()
            };

                console.log('üîß Nova migra√ß√£o criada:', novaMigracao);
            migracoes.unshift(novaMigracao);
            salvarDados('migracoes', migracoes);
                console.log('üîß Migra√ß√£o salva no localStorage');
            
            // Criar prazo autom√°tico para a migra√ß√£o
            const prazoMigracao = {
                id: Date.now() + 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente n√£o encontrado',
                    descricao: `Prazo para ${novaMigracao.tipo}`,
                dataLimite: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 90 dias
                status: 'ativo',
                tipo: 'migracao',
                referenciaId: novaMigracao.id,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoMigracao);
            salvarDados('prazos', prazos);
                console.log('üîß Prazo criado e salvo');
            
            mostrarNotificacao('Processo de migra√ß√£o e prazo criados com sucesso!', 'success');
            fecharModal();
                
                console.log('üîß Tentando carregar se√ß√£o migracoes');
                console.log('üîß Migra√ß√µes ap√≥s salvar:', migracoes);
                setTimeout(() => {
                    carregarSecao('migracoes');
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar migra√ß√£o:', error);
                mostrarNotificacao('Erro ao salvar migra√ß√£o: ' + error.message, 'error');
            }
        }

        function salvarRegisto(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const clienteId = parseInt(formData.get('clienteId'));
            const cliente = clientes.find(c => c.id === clienteId);
            
            const valor = parseFloat(formData.get('valor')) || 0;
            const iva = parseFloat(formData.get('iva')) || 0;
            const percentagem = parseFloat(formData.get('percentagem')) || 0;
            const valorComIva = valor + (valor * iva / 100);

            const novoRegisto = {
                id: registos.length > 0 ? Math.max(...registos.map(r => r.id)) + 1 : 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente n√£o encontrado',
                tipo: formData.get('tipo'),
                descricao: formData.get('descricao'),
                valor: valor,
                iva: iva,
                percentagem: percentagem,
                valorComIva: valorComIva,
                status: formData.get('status'),
                dataInicio: formData.get('dataInicio'),
                observacoes: formData.get('observacoes'),
                dataCriacao: new Date().toISOString()
            };

            registos.unshift(novoRegisto);
            salvarDados('registos', registos);
            
            // Criar prazo autom√°tico para o registo
            const prazoRegisto = {
                id: Date.now() + 1,
                clienteId: clienteId,
                clienteNome: cliente ? cliente.nome : 'Cliente n√£o encontrado',
                descricao: `Prazo para ${novoRegisto.tipo} - ${novoRegisto.descricao}`,
                dataLimite: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 15 dias
                status: 'ativo',
                tipo: 'registo',
                referenciaId: novoRegisto.id,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoRegisto);
            salvarDados('prazos', prazos);
            
            mostrarNotificacao('Registo e prazo criados com sucesso!', 'success');
            fecharModal();
            
            // FOR√áAR RECARREGAMENTO IMEDIATO
            console.log('üîß FOR√áANDO RECARREGAMENTO AP√ìS SALVAR REGISTO');
            console.log('üîß registos ap√≥s salvar:', registos);
            
            // Recarregar se√ß√£o
            setTimeout(() => {
                carregarSecao('registos');
            }, 100);
            
            // Atualizar lista ap√≥s salvar
            setTimeout(() => {
                console.log('üîß CHAMANDO atualizarListaRegistos ap√≥s salvar');
                if (typeof atualizarListaRegistos === 'function') {
                    atualizarListaRegistos(registos);
                    console.log('‚úÖ atualizarListaRegistos executado ap√≥s salvar');
                } else {
                    console.error('‚ùå atualizarListaRegistos n√£o √© uma fun√ß√£o ap√≥s salvar');
                }
            }, 300);
        }

        // === FUN√á√ïES DE EDI√á√ÉO E EXCLUS√ÉO ===

        function editarHeranca(id) {
            const heranca = herancas.find(h => h.id === id);
            if (!heranca) return;

            abrirModalHeranca();
            // Preencher formul√°rio com dados existentes
            setTimeout(() => {
                const form = document.getElementById('formHeranca');
                if (form) {
                    form.clienteId.value = heranca.clienteId;
                    form.tipo.value = heranca.tipo;
                    form.descricao.value = heranca.descricao || '';
                    form.valor.value = heranca.valor || '';
                    form.iva.value = heranca.iva || 23;
                    form.status.value = heranca.status;
                    form.dataInicio.value = heranca.dataInicio || '';
                    form.observacoes.value = heranca.observacoes || '';
                    
                    // Alterar t√≠tulo do modal
                    document.querySelector('#modalContainer h3').textContent = 'Editar Heran√ßa';
                    
                    // Adicionar campo hidden para ID
                    const hiddenId = document.createElement('input');
                    hiddenId.type = 'hidden';
                    hiddenId.name = 'id';
                    hiddenId.value = heranca.id;
                    form.appendChild(hiddenId);
                }
            }, 100);
        }

        function editarMigracao(id) {
            const migracao = migracoes.find(m => m.id === id);
            if (!migracao) return;

            abrirModalMigracao();
            setTimeout(() => {
                const form = document.getElementById('formMigracao');
                if (form) {
                    form.clienteId.value = migracao.clienteId;
                    form.tipo.value = migracao.tipo;
                    form.descricao.value = migracao.descricao || '';
                    form.valor.value = migracao.valor || '';
                    form.iva.value = migracao.iva || 23;
                    form.status.value = migracao.status;
                    form.dataInicio.value = migracao.dataInicio || '';
                    form.observacoes.value = migracao.observacoes || '';
                    
                    document.querySelector('#modalContainer h3').textContent = 'Editar Processo de Migra√ß√£o';
                    
                    const hiddenId = document.createElement('input');
                    hiddenId.type = 'hidden';
                    hiddenId.name = 'id';
                    hiddenId.value = migracao.id;
                    form.appendChild(hiddenId);
                }
            }, 100);
        }

        function editarRegisto(id) {
            const registo = registos.find(r => r.id === id);
            if (!registo) return;

            abrirModalRegisto();
            setTimeout(() => {
                const form = document.getElementById('formRegisto');
                if (form) {
                    form.clienteId.value = registo.clienteId;
                    form.tipo.value = registo.tipo;
                    form.descricao.value = registo.descricao || '';
                    form.valor.value = registo.valor || '';
                    form.iva.value = registo.iva || 23;
                    form.status.value = registo.status;
                    form.dataInicio.value = registo.dataInicio || '';
                    form.observacoes.value = registo.observacoes || '';
                    
                    document.querySelector('#modalContainer h3').textContent = 'Editar Registo';
                    
                    const hiddenId = document.createElement('input');
                    hiddenId.type = 'hidden';
                    hiddenId.name = 'id';
                    hiddenId.value = registo.id;
                    form.appendChild(hiddenId);
                }
            }, 100);
        }

        function excluirHeranca(id) {
            if (confirm('Tem certeza que deseja excluir esta heran√ßa?')) {
                herancas = herancas.filter(h => h.id !== id);
                salvarDados('herancas', herancas);
                mostrarNotificacao('Heran√ßa exclu√≠da com sucesso!', 'success');
                carregarSecao('herancas');
            }
        }

        function excluirMigracao(id) {
            if (confirm('Tem certeza que deseja excluir este processo de migra√ß√£o?')) {
                migracoes = migracoes.filter(m => m.id !== id);
                salvarDados('migracoes', migracoes);
                mostrarNotificacao('Processo de migra√ß√£o exclu√≠do com sucesso!', 'success');
                carregarSecao('migracao');
            }
        }

        function excluirRegisto(id) {
            if (confirm('Tem certeza que deseja excluir este registo?')) {
                registos = registos.filter(r => r.id !== id);
                salvarDados('registos', registos);
                mostrarNotificacao('Registo exclu√≠do com sucesso!', 'success');
                carregarSecao('registos');
            }
        }

        // === SISTEMA DE ANEXOS DE DOCUMENTOS ===
        
        function abrirAnexosCliente(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) return;
            
            // Inicializar array de anexos se n√£o existir
            if (!cliente.anexos) {
                cliente.anexos = [];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos de ${cliente.nome}</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <!-- Upload de novos documentos -->
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexo(event, ${clienteId})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('cliente')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="identificacao">Identifica√ß√£o</option>
                                                <option value="contrato">Contrato</option>
                                                <option value="certificado">Certificado</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizadoCliente" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descri√ß√£o do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModal()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Lista de documentos existentes -->
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${cliente.anexos.length})</h4>
                                ${cliente.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${cliente.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} ‚Ä¢ ${anexo.tamanho} ‚Ä¢ ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexo(${clienteId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }
        
        function adicionarAnexo(event, clienteId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            // Usar tipo personalizado se "outro" foi selecionado
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const cliente = clientes.find(c => c.id === clienteId);
                if (cliente) {
                    if (!cliente.anexos) cliente.anexos = [];
                    cliente.anexos.push(anexo);
                    salvarDados('clientes', clientes);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    abrirAnexosCliente(clienteId); // Recarregar modal
                }
            });
        }
        
        function formatarTamanho(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Fun√ß√£o para formatar valor com IVA incorporado
        function formatarValorComIva(valor, iva, valorComIva) {
            const valorNum = parseFloat(valor) || 0;
            const ivaNum = parseFloat(iva) || 0;
            const valorComIvaNum = parseFloat(valorComIva) || 0;
            
            // Calcular valor com IVA se n√£o foi fornecido
            const valorComIvaCalculado = valorComIvaNum > 0 ? valorComIvaNum : valorNum + (valorNum * ivaNum / 100);
            
            const valorFormatado = (Math.round(valorNum * 100) / 100).toFixed(2);
            const valorComIvaFormatado = (Math.round(valorComIvaCalculado * 100) / 100).toFixed(2);
            
            return `
                <div class="flex flex-col">
                    <div class="text-sm font-medium text-gray-900">‚Ç¨${valorFormatado}</div>
                    <div class="text-xs text-gray-500">
                        <span class="text-gray-400">+ ${ivaNum}% IVA:</span>
                        <span class="font-medium text-gray-700">‚Ç¨${valorComIvaFormatado}</span>
                    </div>
                </div>
            `;
        }
        
        function visualizarAnexo(anexoId) {
            console.log('üîß visualizarAnexo chamado com ID:', anexoId);
            
            // Buscar anexo em todas as fontes
            let anexo = null;
            let tipo = '';
            
            // Buscar em contratos
            const contratosSalvos = localStorage.getItem('contratos');
            if (contratosSalvos) {
                const contratos = JSON.parse(contratosSalvos);
                for (const contrato of contratos) {
                    if (contrato.anexos) {
                        anexo = contrato.anexos.find(a => a.id === anexoId);
                        if (anexo) {
                            tipo = 'contrato';
                            break;
                        }
                    }
                }
            }
            
            // Buscar em heran√ßas
            if (!anexo) {
                const herancasSalvas = localStorage.getItem('herancas');
                if (herancasSalvas) {
                    const herancas = JSON.parse(herancasSalvas);
                    for (const heranca of herancas) {
                        if (heranca.anexos) {
                            anexo = heranca.anexos.find(a => a.id === anexoId);
                            if (anexo) {
                                tipo = 'heranca';
                                break;
                            }
                        }
                    }
                }
            }
            
            // Buscar em migra√ß√µes
            if (!anexo) {
                const migracoesSalvas = localStorage.getItem('migracoes');
                if (migracoesSalvas) {
                    const migracoes = JSON.parse(migracoesSalvas);
                    for (const migracao of migracoes) {
                        if (migracao.anexos) {
                            anexo = migracao.anexos.find(a => a.id === anexoId);
                            if (anexo) {
                                tipo = 'migracao';
                                break;
                            }
                        }
                    }
                }
            }
            
            // Buscar em registos
            if (!anexo) {
                const registosSalvos = localStorage.getItem('registos');
                if (registosSalvos) {
                    const registos = JSON.parse(registosSalvos);
                    for (const registo of registos) {
                        if (registo.anexos) {
                            anexo = registo.anexos.find(a => a.id === anexoId);
                            if (anexo) {
                                tipo = 'registo';
                                break;
                            }
                        }
                    }
                }
            }
            
            // Buscar em clientes
            if (!anexo) {
                const clientesSalvos = localStorage.getItem('clientes');
                if (clientesSalvos) {
                    const clientes = JSON.parse(clientesSalvos);
                    for (const cliente of clientes) {
                        if (cliente.anexos) {
                            anexo = cliente.anexos.find(a => a.id === anexoId);
                            if (anexo) {
                                tipo = 'cliente';
                                break;
                            }
                        }
                    }
                }
            }
            
            if (!anexo) {
                mostrarNotificacao('Documento n√£o encontrado!', 'error');
                return;
            }
            
            // Determinar tipo de arquivo
            const extensao = anexo.nome.split('.').pop().toLowerCase();
            const isImagem = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extensao);
            const isPDF = extensao === 'pdf';
            const isDocumento = ['doc', 'docx', 'txt', 'rtf'].includes(extensao);
            
            // Criar modal de visualiza√ß√£o
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-900">${anexo.nome}</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <div class="mb-4 text-sm text-gray-600">
                                <p><strong>Tipo:</strong> ${anexo.tipo}</p>
                                <p><strong>Tamanho:</strong> ${anexo.tamanho}</p>
                                <p><strong>Data:</strong> ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                ${anexo.descricao ? `<p><strong>Descri√ß√£o:</strong> ${anexo.descricao}</p>` : ''}
                            </div>
                            
                            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                ${isImagem ? `
                                    <div class="text-center">
                                        <img src="${anexo.conteudo}" alt="${anexo.nome}" class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg">
                                    </div>
                                ` : isPDF ? `
                                    <div class="text-center">
                                        <iframe src="${anexo.conteudo}" width="100%" height="500px" class="rounded-lg border-0"></iframe>
                                    </div>
                                ` : isDocumento ? `
                                    <div class="text-center py-8">
                                        <i data-lucide="file-text" class="w-16 h-16 mx-auto mb-4 text-blue-600"></i>
                                        <p class="text-gray-600 mb-4">Visualiza√ß√£o n√£o dispon√≠vel para este tipo de arquivo</p>
                                        <button onclick="baixarAnexo('${anexoId}')" class="btn btn-primary">
                                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                            Baixar Documento
                                        </button>
                                    </div>
                                ` : `
                                    <div class="text-center py-8">
                                        <i data-lucide="file" class="w-16 h-16 mx-auto mb-4 text-gray-600"></i>
                                        <p class="text-gray-600 mb-4">Visualiza√ß√£o n√£o dispon√≠vel para este tipo de arquivo</p>
                                        <button onclick="baixarAnexo('${anexoId}')" class="btn btn-primary">
                                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                            Baixar Arquivo
                                        </button>
                                    </div>
                                `}
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-4">
                                <button onclick="baixarAnexo('${anexoId}')" class="btn btn-secondary">
                                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                    Baixar
                                </button>
                                <button onclick="fecharModal()" class="btn btn-primary">
                                    <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                    Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Adicionar modal ao body
            const modalElement = document.createElement('div');
            modalElement.innerHTML = modal;
            document.body.appendChild(modalElement.firstElementChild);
            lucide.createIcons();
        }
        
        function baixarAnexo(anexoId) {
            console.log('üîß baixarAnexo chamado com ID:', anexoId);
            console.log('üîß Buscando anexo com ID:', anexoId);
            
            // Buscar anexo em todas as fontes
            let anexo = null;
            
            // Buscar em contratos
            const contratosSalvos = localStorage.getItem('contratos');
            if (contratosSalvos) {
                const contratos = JSON.parse(contratosSalvos);
                for (const contrato of contratos) {
                    if (contrato.anexos) {
                        anexo = contrato.anexos.find(a => a.id === anexoId);
                        if (anexo) break;
                    }
                }
            }
            
            // Buscar em heran√ßas
            if (!anexo) {
                const herancasSalvas = localStorage.getItem('herancas');
                if (herancasSalvas) {
                    const herancas = JSON.parse(herancasSalvas);
                    for (const heranca of herancas) {
                        if (heranca.anexos) {
                            anexo = heranca.anexos.find(a => a.id === anexoId);
                            if (anexo) break;
                        }
                    }
                }
            }
            
            // Buscar em migra√ß√µes
            if (!anexo) {
                const migracoesSalvas = localStorage.getItem('migracoes');
                if (migracoesSalvas) {
                    const migracoes = JSON.parse(migracoesSalvas);
                    for (const migracao of migracoes) {
                        if (migracao.anexos) {
                            anexo = migracao.anexos.find(a => a.id === anexoId);
                            if (anexo) break;
                        }
                    }
                }
            }
            
            // Buscar em registos
            if (!anexo) {
                const registosSalvos = localStorage.getItem('registos');
                if (registosSalvos) {
                    const registos = JSON.parse(registosSalvos);
                    for (const registo of registos) {
                        if (registo.anexos) {
                            anexo = registo.anexos.find(a => a.id === anexoId);
                            if (anexo) break;
                        }
                    }
                }
            }
            
            // Buscar em clientes
            if (!anexo) {
                const clientesSalvos = localStorage.getItem('clientes');
                if (clientesSalvos) {
                    const clientes = JSON.parse(clientesSalvos);
                    for (const cliente of clientes) {
                        if (cliente.anexos) {
                            anexo = cliente.anexos.find(a => a.id === anexoId);
                            if (anexo) break;
                        }
                    }
                }
            }
            
            if (!anexo) {
                console.error('‚ùå Anexo n√£o encontrado com ID:', anexoId);
                mostrarNotificacao('Documento n√£o encontrado!', 'error');
                return;
            }
            
            console.log('üîß Anexo encontrado:', anexo);
            console.log('üîß Tipo de arquivo:', anexo.tipo || 'desconhecido');
            console.log('üîß Nome do arquivo:', anexo.nome || 'sem nome');
            console.log('üîß Campos dispon√≠veis:', Object.keys(anexo));
            console.log('üîß Conte√∫do (conteudo):', anexo.conteudo ? anexo.conteudo.substring(0, 50) + '...' : 'N/A');
            console.log('üîß Conte√∫do (dataURL):', anexo.dataURL ? anexo.dataURL.substring(0, 50) + '...' : 'N/A');
            console.log('üîß Conte√∫do (dados):', anexo.dados ? anexo.dados.substring(0, 50) + '...' : 'N/A');
            
            try {
                console.log('üîß Iniciando convers√£o Base64 para Blob...');
                
                // Verificar qual campo cont√©m o conte√∫do
                let conteudoBase64 = anexo.conteudo || anexo.dataURL || anexo.dados;
                
                // Validar se o conte√∫do Base64 √© v√°lido
                if (!conteudoBase64 || typeof conteudoBase64 !== 'string' || conteudoBase64 === 'simulado') {
                    throw new Error('Conte√∫do do anexo n√£o encontrado ou inv√°lido');
                }
                
                // Verificar se √© um data URL v√°lido
                let base64Content = conteudoBase64;
                if (base64Content.startsWith('data:')) {
                    // Extrair apenas a parte Base64 do data URL
                    base64Content = base64Content.split(',')[1];
                }
                
                // Validar formato Base64
                const base64Regex = /^[A-Za-z0-9+/]*={0,2}$/;
                if (!base64Regex.test(base64Content)) {
                    throw new Error('Formato Base64 inv√°lido');
                }
                
                console.log('üîß Base64 validado, iniciando decodifica√ß√£o...');
                // Converter base64 para blob
                const byteCharacters = atob(base64Content);
                console.log('üîß Base64 decodificado, tamanho:', byteCharacters.length);
                
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                console.log('üîß ByteArray criado, tamanho:', byteArray.length);
                
                // Detectar tipo MIME baseado na extens√£o do arquivo
                let mimeType = anexo.tipoMime || anexo.tipoArquivo || 'application/octet-stream';
                
                // Se n√£o temos tipo MIME, detectar pela extens√£o
                if (!anexo.tipoMime && !anexo.tipoArquivo) {
                    const extensao = anexo.nomeArquivo ? anexo.nomeArquivo.split('.').pop().toLowerCase() : '';
                    const mimeTypes = {
                        'jpg': 'image/jpeg',
                        'jpeg': 'image/jpeg',
                        'png': 'image/png',
                        'gif': 'image/gif',
                        'bmp': 'image/bmp',
                        'webp': 'image/webp',
                        'pdf': 'application/pdf',
                        'doc': 'application/msword',
                        'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                        'xls': 'application/vnd.ms-excel',
                        'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                        'ppt': 'application/vnd.ms-powerpoint',
                        'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                        'txt': 'text/plain',
                        'rtf': 'application/rtf',
                        'zip': 'application/zip',
                        'rar': 'application/x-rar-compressed',
                        '7z': 'application/x-7z-compressed'
                    };
                    
                    mimeType = mimeTypes[extensao] || 'application/octet-stream';
                }
                
                console.log('üîß Tipo MIME detectado:', mimeType);
                
                const blob = new Blob([byteArray], { type: mimeType });
                console.log('üîß Blob criado, tamanho:', blob.size, 'tipo:', blob.type);
                
                // Criar link de download
                const url = window.URL.createObjectURL(blob);
                console.log('üîß URL do objeto criada:', url);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = anexo.nomeArquivo || anexo.nome;
                console.log('üîß Link criado, href:', link.href, 'download:', link.download);
                
                document.body.appendChild(link);
                console.log('üîß Link adicionado ao body, clicando...');
                link.click();
                console.log('üîß Link clicado, removendo do body...');
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                console.log('üîß URL revogada, download deve ter iniciado');
                
                mostrarNotificacao('Download iniciado com sucesso!', 'success');
            } catch (error) {
                console.error('‚ùå Erro ao baixar arquivo:', error);
                console.error('‚ùå Detalhes do erro:', error.message);
                console.error('‚ùå Conte√∫do do anexo (primeiros 100 chars):', anexo.conteudo ? anexo.conteudo.substring(0, 100) : 'N/A');
                
                let mensagemErro = 'Erro ao baixar arquivo!';
                if (error.message.includes('Base64')) {
                    mensagemErro = 'Arquivo corrompido - Base64 inv√°lido. Tente fazer upload novamente.';
                } else if (error.message.includes('conte√∫do')) {
                    mensagemErro = 'Conte√∫do do arquivo n√£o encontrado.';
                }
                
                mostrarNotificacao(mensagemErro, 'error');
            }
        }
        
        function removerAnexo(clienteId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const cliente = clientes.find(c => c.id === clienteId);
                if (cliente && cliente.anexos) {
                    cliente.anexos = cliente.anexos.filter(a => a.id !== anexoId);
                    salvarDados('clientes', clientes);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosCliente(clienteId); // Recarregar modal
                }
            }
        }

        // === SISTEMA DE ANEXOS PARA √ÅREAS DE EXECU√á√ÉO ===
        
        function abrirAnexosContrato(contratoId) {
            const contrato = contratos.find(c => c.id === contratoId);
            if (!contrato) return;
            
            if (!contrato.anexos) contrato.anexos = [];
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos do Contrato</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexoContrato(event, ${contratoId})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('contrato')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="contrato">Contrato</option>
                                                <option value="anexo">Anexo</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="certificado">Certificado</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizadoContrato" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descri√ß√£o do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModal()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${contrato.anexos.length})</h4>
                                ${contrato.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${contrato.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} ‚Ä¢ ${anexo.tamanho} ‚Ä¢ ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexoContrato(${contratoId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }
        
        function adicionarAnexoContrato(event, contratoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            // Usar tipo personalizado se "outro" foi selecionado
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const contrato = contratos.find(c => c.id === contratoId);
                if (contrato) {
                    if (!contrato.anexos) contrato.anexos = [];
                    contrato.anexos.push(anexo);
                    salvarDados('contratos', contratos);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    abrirAnexosContrato(contratoId);
                }
            });
        }
        
        function removerAnexoContrato(contratoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const contrato = contratos.find(c => c.id === contratoId);
                if (contrato && contrato.anexos) {
                    contrato.anexos = contrato.anexos.filter(a => a.id !== anexoId);
                    salvarDados('contratos', contratos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosContrato(contratoId);
                }
            }
        }

        // === FUN√á√ÉO PARA CONTROLAR VISIBILIDADE DO TIPO PERSONALIZADO ===
        
        function toggleTipoPersonalizado(area) {
            console.log('üîß toggleTipoPersonalizado chamado para √°rea:', area);
            const select = document.getElementById('tipoDocumento');
            const divPersonalizado = document.getElementById(`tipoPersonalizado${area.charAt(0).toUpperCase() + area.slice(1)}`);
            const inputPersonalizado = document.getElementById('tipoPersonalizadoInput');
            
            console.log('üîß Select encontrado:', !!select);
            console.log('üîß Div personalizado encontrado:', !!divPersonalizado);
            console.log('üîß Input personalizado encontrado:', !!inputPersonalizado);
            
            if (select && divPersonalizado) {
                if (select.value === 'outro') {
                    console.log('üîß Mostrando campo personalizado');
                    divPersonalizado.classList.remove('hidden');
                    if (inputPersonalizado) {
                        inputPersonalizado.required = true;
                        inputPersonalizado.focus();
                    }
                } else {
                    console.log('üîß Ocultando campo personalizado');
                    divPersonalizado.classList.add('hidden');
                    if (inputPersonalizado) {
                        inputPersonalizado.required = false;
                        inputPersonalizado.value = '';
                    }
                }
            } else {
                console.error('‚ùå Elementos n√£o encontrados:', { select: !!select, divPersonalizado: !!divPersonalizado });
            }
        }

        // === FUN√á√ïES PARA PRAZOS ===
        
        function editarItem(tipo, id) {
            if (tipo === 'cliente') {
                const cliente = clientes.find(c => c.id === id);
                if (!cliente) return;
                
                // Abrir modal de cliente e preencher com dados
                abrirModal('cliente');
                setTimeout(() => {
                    document.getElementById('clienteNome').value = cliente.nome || '';
                    document.getElementById('clienteEmail').value = cliente.email || '';
                    document.getElementById('clienteTelefone').value = cliente.telefone || '';
                    document.getElementById('clienteNIF').value = cliente.nif || '';
                    document.getElementById('clienteMorada').value = cliente.morada || '';
                    document.getElementById('clienteNotas').value = cliente.notas || '';
                    
                    // Alterar o t√≠tulo do modal e o bot√£o
                    const modalTitle = document.querySelector('#modalContainer h3');
                    if (modalTitle) modalTitle.textContent = 'Editar Cliente';
                    
                    // Alterar o formul√°rio para modo edi√ß√£o
                    const form = document.getElementById('formCliente');
                    if (form) {
                        form.onsubmit = (e) => {
                            e.preventDefault();
                            atualizarCliente(id);
                        };
                        
                        // Alterar texto do bot√£o
                        const submitBtn = form.querySelector('button[type="submit"]');
                        if (submitBtn) submitBtn.textContent = 'Atualizar Cliente';
                    }
                }, 100);
            }
            else if (tipo === 'prazo') {
                const prazo = prazos.find(p => p.id === id);
                if (!prazo) return;
                
                // Criar modal de edi√ß√£o de prazo
                const modal = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-xl font-bold text-gray-900">Editar Prazo</h3>
                                    <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                        <i data-lucide="x" class="w-6 h-6"></i>
                                    </button>
                                </div>
                                
                                <form onsubmit="atualizarPrazo(event, ${id})">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                                            <input type="text" id="prazoCliente" value="${prazo.clienteNome}" readonly class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                            <input type="text" id="prazoTipo" value="${prazo.tipo}" readonly class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o *</label>
                                            <textarea id="prazoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${prazo.descricao}</textarea>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Limite *</label>
                                                <input type="date" id="prazoDataLimite" value="${prazo.dataLimite}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                                <select id="prazoPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                    <option value="baixa" ${prazo.prioridade === 'baixa' ? 'selected' : ''}>Baixa</option>
                                                    <option value="media" ${prazo.prioridade === 'media' ? 'selected' : ''}>M√©dia</option>
                                                    <option value="alta" ${prazo.prioridade === 'alta' ? 'selected' : ''}>Alta</option>
                                                    <option value="critica" ${prazo.prioridade === 'critica' ? 'selected' : ''}>Cr√≠tica</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="prazoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="ativo" ${prazo.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                                <option value="concluido" ${prazo.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                                <option value="vencido" ${prazo.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                                                <option value="cancelado" ${prazo.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-end space-x-3 mt-6">
                                        <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                            Cancelar
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            Salvar Altera√ß√µes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('modalContainer').innerHTML = modal;
                lucide.createIcons();
            }
        }
        
        function atualizarCliente(id) {
            const clienteIndex = clientes.findIndex(c => c.id === id);
            if (clienteIndex !== -1) {
                clientes[clienteIndex] = {
                    ...clientes[clienteIndex],
                    nome: document.getElementById('clienteNome').value,
                    email: document.getElementById('clienteEmail').value,
                    telefone: document.getElementById('clienteTelefone').value,
                    nif: document.getElementById('clienteNIF').value,
                    morada: document.getElementById('clienteMorada').value,
                    notas: document.getElementById('clienteNotas').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('clientes', clientes);
                mostrarNotificacao('Cliente atualizado com sucesso!', 'success');
                fecharModal();
                carregarSecao('clientes');
            }
        }
        
        function atualizarPrazo(event, id) {
            event.preventDefault();
            
            const prazoIndex = prazos.findIndex(p => p.id === id);
            if (prazoIndex !== -1) {
                prazos[prazoIndex] = {
                    ...prazos[prazoIndex],
                    descricao: document.getElementById('prazoDescricao').value,
                    dataLimite: document.getElementById('prazoDataLimite').value,
                    prioridade: document.getElementById('prazoPrioridade').value,
                    status: document.getElementById('prazoStatus').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('prazos', prazos);
                mostrarNotificacao('Prazo atualizado com sucesso!', 'success');
                fecharModal();
                carregarSecao('prazos');
            }
        }
        
        function excluirItem(tipo, id) {
            if (tipo === 'prazo') {
                if (confirm('Tem certeza que deseja excluir este prazo?')) {
                    prazos = prazos.filter(p => p.id !== id);
                    salvarDados('prazos', prazos);
                    mostrarNotificacao('Prazo exclu√≠do com sucesso!', 'success');
                    carregarSecao('prazos');
                }
            }
        }

        // === FUN√á√ïES DE MODAL DE EDI√á√ÉO ===
        
        function abrirModalEdicaoCliente(cliente) {
            console.log('abrirModalEdicaoCliente chamado com:', cliente);
            
            const modalContainer = document.getElementById('modalContainer');
            if (!modalContainer) {
                console.error('modalContainer n√£o encontrado!');
                return;
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Cliente</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarCliente(event, ${cliente.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                                        <input type="text" id="editarClienteNome" value="${cliente.nome}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                        <input type="email" id="editarClienteEmail" value="${cliente.email}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                                        <input type="tel" id="editarClienteTelefone" value="${cliente.telefone}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">NIF *</label>
                                        <input type="text" id="editarClienteNIF" value="${cliente.nif || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="123456789">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Endere√ßo</label>
                                        <textarea id="editarClienteEndereco" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${cliente.endereco || ''}</textarea>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="editarClienteStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="ativo" ${cliente.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                            <option value="inativo" ${cliente.status === 'inativo' ? 'selected' : ''}>Inativo</option>
                                            <option value="suspenso" ${cliente.status === 'suspenso' ? 'selected' : ''}>Suspenso</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            console.log('Inserindo modal de cliente no container...');
            modalContainer.innerHTML = modal;
            console.log('Modal inserido, criando √≠cones...');
            lucide.createIcons();
            console.log('Modal de edi√ß√£o de cliente aberto com sucesso!');
        }
        
        function abrirModalEdicaoContrato(contrato) {
            console.log('abrirModalEdicaoContrato chamado com:', contrato);
            
            // Verificar se o modalContainer existe
            const modalContainer = document.getElementById('modalContainer');
            if (!modalContainer) {
                console.error('modalContainer n√£o encontrado!');
                mostrarNotificacao('Erro: Container do modal n√£o encontrado!', 'error');
                return;
            }
            
            // Limpar qualquer conte√∫do anterior
            modalContainer.innerHTML = '';
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Contrato</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarContrato(event, ${contrato.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="contratoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === contrato.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="contratoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Compra e Venda" ${contrato.tipo === 'Compra e Venda' ? 'selected' : ''}>Compra e Venda</option>
                                            <option value="Arrendamento" ${contrato.tipo === 'Arrendamento' ? 'selected' : ''}>Arrendamento</option>
                                            <option value="Presta√ß√£o de Servi√ßos" ${contrato.tipo === 'Presta√ß√£o de Servi√ßos' ? 'selected' : ''}>Presta√ß√£o de Servi√ßos</option>
                                            <option value="Empr√©stimo" ${contrato.tipo === 'Empr√©stimo' ? 'selected' : ''}>Empr√©stimo</option>
                                            <option value="Outro" ${contrato.tipo === 'Outro' ? 'selected' : ''}>Outro</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="contratoValor" value="${contrato.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="contratoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${contrato.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${contrato.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${contrato.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                                <option value="23" ${contrato.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="contratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${contrato.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${contrato.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${contrato.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                            <input type="date" id="contratoDataInicio" value="${contrato.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Fim</label>
                                            <input type="date" id="contratoDataFim" value="${contrato.dataFim || ''}" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea id="contratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${contrato.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                console.log('Inserindo modal no container...');
                modalContainer.innerHTML = modal;
                console.log('Modal inserido, criando √≠cones...');
                lucide.createIcons();
                console.log('Modal de edi√ß√£o de contrato aberto com sucesso!');
                
                // Verificar se o modal foi inserido corretamente
                const modalElement = modalContainer.querySelector('.fixed.inset-0');
                if (modalElement) {
                    console.log('‚úÖ Modal inserido e vis√≠vel');
                    console.log('Modal element:', modalElement);
                    console.log('Modal styles:', window.getComputedStyle(modalElement));
                    
                    // For√ßar visibilidade
                    modalElement.style.display = 'flex';
                    modalElement.style.visibility = 'visible';
                    modalElement.style.opacity = '1';
                    modalElement.style.zIndex = '9999';
                    
                    console.log('Modal for√ßado a ser vis√≠vel');
                } else {
                    console.error('‚ùå Modal n√£o foi inserido corretamente');
                    mostrarNotificacao('Erro ao abrir modal de edi√ß√£o!', 'error');
                }
            } catch (error) {
                console.error('Erro ao inserir modal:', error);
                mostrarNotificacao('Erro ao abrir modal de edi√ß√£o!', 'error');
            }
        }
        
        function abrirModalEdicaoHonorario(honorario) {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Honor√°rio</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarHonorario(event, ${honorario.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <input type="text" id="honorarioCliente" value="${honorario.cliente}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Servi√ßo *</label>
                                        <input type="text" id="honorarioServico" value="${honorario.servico}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="honorarioValor" value="${honorario.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="honorarioStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${honorario.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="pago" ${honorario.status === 'pago' ? 'selected' : ''}>Pago</option>
                                                <option value="vencido" ${honorario.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento *</label>
                                        <input type="date" id="honorarioVencimento" value="${honorario.vencimento}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        function abrirModalEdicaoHeranca(heranca) {
            console.log('üîß abrirModalEdicaoHeranca chamado com:', heranca);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoHeranca';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = fecharModal;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Heran√ßa</h3>
                            <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form onsubmit="atualizarHeranca(event, ${heranca.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="herancaClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === heranca.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                    <select id="herancaTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Aceita√ß√£o da heran√ßa" ${heranca.tipo === 'Aceita√ß√£o da heran√ßa' ? 'selected' : ''}>Aceita√ß√£o da heran√ßa</option>
                                        <option value="Doa√ß√µes" ${heranca.tipo === 'Doa√ß√µes' ? 'selected' : ''}>Doa√ß√µes</option>
                                        <option value="Escrituras de partilha" ${heranca.tipo === 'Escrituras de partilha' ? 'selected' : ''}>Escrituras de partilha</option>
                                        <option value="Habilita√ß√£o de herdeiros" ${heranca.tipo === 'Habilita√ß√£o de herdeiros' ? 'selected' : ''}>Habilita√ß√£o de herdeiros</option>
                                        <option value="Partilhas em vida" ${heranca.tipo === 'Partilhas em vida' ? 'selected' : ''}>Partilhas em vida</option>
                                        <option value="Partilhas por √≥bito" ${heranca.tipo === 'Partilhas por √≥bito' ? 'selected' : ''}>Partilhas por √≥bito</option>
                                        <option value="Processo de invent√°rio" ${heranca.tipo === 'Processo de invent√°rio' ? 'selected' : ''}>Processo de invent√°rio</option>
                                        <option value="Ren√∫ncia √† heran√ßa" ${heranca.tipo === 'Ren√∫ncia √† heran√ßa' ? 'selected' : ''}>Ren√∫ncia √† heran√ßa</option>
                                        <option value="Testamentos" ${heranca.tipo === 'Testamentos' ? 'selected' : ''}>Testamentos</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="herancaValor" value="${heranca.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="herancaIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0" ${heranca.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                            <option value="6" ${heranca.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                            <option value="13" ${heranca.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                            <option value="23" ${heranca.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="herancaStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente" ${heranca.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                            <option value="em_andamento" ${heranca.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                            <option value="concluido" ${heranca.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                    <input type="date" id="herancaDataInicio" value="${heranca.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                    <textarea id="herancaObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${heranca.observacoes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Altera√ß√µes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            const modalAnterior = document.getElementById('modalEdicaoHeranca');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            // Adicionar ao body
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('‚úÖ Modal de edi√ß√£o de heran√ßa criado e adicionado ao body!');
        }

        function abrirModalEdicaoMigracao(migracao) {
            console.log('üîß abrirModalEdicaoMigracao chamado com:', migracao);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoMigracao';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = fecharModal;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Migra√ß√£o</h3>
                            <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <form onsubmit="atualizarMigracao(event, ${migracao.id})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                    <select id="migracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Cliente</option>
                                        ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                    <select id="migracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecionar Tipo</option>
                                        <option value="Autoriza√ß√£o de resid√™ncia" ${migracao.tipo === 'Autoriza√ß√£o de resid√™ncia' ? 'selected' : ''}>Autoriza√ß√£o de resid√™ncia</option>
                                        <option value="Certificados de resid√™ncia permanente" ${migracao.tipo === 'Certificados de resid√™ncia permanente' ? 'selected' : ''}>Certificados de resid√™ncia permanente</option>
                                        <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                        <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                        <option value="Renova√ß√£o de autoriza√ß√µes" ${migracao.tipo === 'Renova√ß√£o de autoriza√ß√µes' ? 'selected' : ''}>Renova√ß√£o de autoriza√ß√µes</option>
                                        <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                        <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                        <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                        <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                        <input type="number" id="migracaoValor" value="${migracao.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                        <select id="migracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                            <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                            <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                            <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="migracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                            <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                            <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                    <input type="date" id="migracaoDataInicio" value="${migracao.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                    <textarea id="migracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Salvar Altera√ß√µes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            const modalAnterior = document.getElementById('modalEdicaoMigracao');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            // Adicionar ao body
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('‚úÖ Modal de edi√ß√£o de migra√ß√£o criado e adicionado ao body!');
        }

        function abrirModalEdicaoRegisto(registo) {
            console.log('üîß abrirModalEdicaoRegisto chamado com:', registo);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Criar modal diretamente no body
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoRegisto';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = fecharModal;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Registo</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarRegisto(event, ${registo.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="registoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === registo.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="registoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autentica√ß√£o de documentos" ${registo.tipo === 'Autentica√ß√£o de documentos' ? 'selected' : ''}>Autentica√ß√£o de documentos</option>
                                            <option value="Certifica√ß√£o de fotoc√≥pias" ${registo.tipo === 'Certifica√ß√£o de fotoc√≥pias' ? 'selected' : ''}>Certifica√ß√£o de fotoc√≥pias</option>
                                            <option value="Documentos para o estrangeiro" ${registo.tipo === 'Documentos para o estrangeiro' ? 'selected' : ''}>Documentos para o estrangeiro</option>
                                            <option value="Procura√ß√µes" ${registo.tipo === 'Procura√ß√µes' ? 'selected' : ''}>Procura√ß√µes</option>
                                            <option value="Reconhecimento presencial de assinaturas" ${registo.tipo === 'Reconhecimento presencial de assinaturas' ? 'selected' : ''}>Reconhecimento presencial de assinaturas</option>
                                            <option value="Registos autom√≥veis" ${registo.tipo === 'Registos autom√≥veis' ? 'selected' : ''}>Registos autom√≥veis</option>
                                            <option value="Registos comerciais" ${registo.tipo === 'Registos comerciais' ? 'selected' : ''}>Registos comerciais</option>
                                            <option value="Registos de propriedade" ${registo.tipo === 'Registos de propriedade' ? 'selected' : ''}>Registos de propriedade</option>
                                            <option value="Termos de autentica√ß√£o" ${registo.tipo === 'Termos de autentica√ß√£o' ? 'selected' : ''}>Termos de autentica√ß√£o</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="registoValor" value="${registo.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="registoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${registo.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${registo.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${registo.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                                <option value="23" ${registo.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="registoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${registo.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${registo.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${registo.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                        <input type="date" id="registoDataInicio" value="${registo.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea id="registoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${registo.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            const modalAnterior = document.getElementById('modalEdicaoRegisto');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            // Adicionar ao body
            document.body.appendChild(modal);
            lucide.createIcons();
            console.log('‚úÖ Modal de edi√ß√£o de registo criado e adicionado ao body!');
        }

        function abrirModalEdicaoPrazo(prazo) {
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Prazo</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="atualizarPrazo(event, ${prazo.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                                        <input type="text" id="prazoCliente" value="${prazo.clienteNome}" readonly class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                        <input type="text" id="prazoTipo" value="${prazo.tipo}" readonly class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o *</label>
                                        <textarea id="prazoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${prazo.descricao}</textarea>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Limite *</label>
                                            <input type="date" id="prazoDataLimite" value="${prazo.dataLimite}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                            <select id="prazoPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="baixa" ${prazo.prioridade === 'baixa' ? 'selected' : ''}>Baixa</option>
                                                <option value="media" ${prazo.prioridade === 'media' ? 'selected' : ''}>M√©dia</option>
                                                <option value="alta" ${prazo.prioridade === 'alta' ? 'selected' : ''}>Alta</option>
                                                <option value="critica" ${prazo.prioridade === 'critica' ? 'selected' : ''}>Cr√≠tica</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="prazoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="ativo" ${prazo.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                            <option value="concluido" ${prazo.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                            <option value="vencido" ${prazo.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                                            <option value="cancelado" ${prazo.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="fecharModal()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            lucide.createIcons();
        }

        // === FUN√á√ïES DE ATUALIZA√á√ÉO ===
        
        function atualizarContrato(event, id) {
            event.preventDefault();
            
            const contratoIndex = contratos.findIndex(c => c.id === id);
            if (contratoIndex !== -1) {
                const clienteId = document.getElementById('contratoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                contratos[contratoIndex] = {
                    ...contratos[contratoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : contratos[contratoIndex].clienteNome,
                    tipo: document.getElementById('contratoTipo').value,
                    valor: document.getElementById('contratoValor').value,
                    iva: document.getElementById('contratoIva').value,
                    status: document.getElementById('contratoStatus').value,
                    dataInicio: document.getElementById('contratoDataInicio').value,
                    dataFim: document.getElementById('contratoDataFim').value,
                    observacoes: document.getElementById('contratoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('contratos', contratos);
                mostrarNotificacao('Contrato atualizado com sucesso!', 'success');
                fecharModal();
                carregarSecao('contratos');
            }
        }
        
        function atualizarHonorario(event, id) {
            event.preventDefault();
            
            const honorarioIndex = honorarios.findIndex(h => h.id === id);
            if (honorarioIndex !== -1) {
                honorarios[honorarioIndex] = {
                    ...honorarios[honorarioIndex],
                    cliente: document.getElementById('honorarioCliente').value,
                    servico: document.getElementById('honorarioServico').value,
                    valor: document.getElementById('honorarioValor').value,
                    status: document.getElementById('honorarioStatus').value,
                    vencimento: document.getElementById('honorarioVencimento').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('honorarios', honorarios);
                mostrarNotificacao('Honor√°rio atualizado com sucesso!', 'success');
                fecharModal();
                carregarSecao('honorarios');
            }
        }

        function atualizarHeranca(event, id) {
            console.log('üîß atualizarHeranca chamado com ID:', id);
            event.preventDefault();
            
            // Buscar heran√ßas do localStorage
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) {
                herancas = JSON.parse(herancasSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const herancaIndex = herancas.findIndex(h => h.id === id);
            if (herancaIndex !== -1) {
                const clienteId = document.getElementById('herancaClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                herancas[herancaIndex] = {
                    ...herancas[herancaIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : herancas[herancaIndex].clienteNome,
                    tipo: document.getElementById('herancaTipo').value,
                    valor: document.getElementById('herancaValor').value,
                    iva: document.getElementById('herancaIva').value,
                    status: document.getElementById('herancaStatus').value,
                    dataInicio: document.getElementById('herancaDataInicio').value,
                    observacoes: document.getElementById('herancaObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('herancas', herancas);
                mostrarNotificacao('Heran√ßa atualizada com sucesso!', 'success');
                
                // Fechar modal explicitamente
                console.log('üîß Fechando modal de heran√ßa...');
                fecharModal();
                
                // Aguardar um pouco antes de recarregar
                setTimeout(() => {
                    carregarSecao('herancas');
                }, 100);
                
                console.log('‚úÖ Heran√ßa atualizada com sucesso!');
            } else {
                console.error('‚ùå Heran√ßa n√£o encontrada com ID:', id);
                mostrarNotificacao('Erro: Heran√ßa n√£o encontrada!', 'error');
            }
        }
        
        // Tornar fun√ß√£o global
        window.atualizarHeranca = atualizarHeranca;

        function atualizarMigracao(event, id) {
            console.log('üîß atualizarMigracao chamado com ID:', id);
            event.preventDefault();
            
            // Buscar migra√ß√µes do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const migracaoIndex = migracoes.findIndex(m => m.id === id);
            if (migracaoIndex !== -1) {
                const clienteId = document.getElementById('migracaoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                migracoes[migracaoIndex] = {
                    ...migracoes[migracaoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : migracoes[migracaoIndex].clienteNome,
                    tipo: document.getElementById('migracaoTipo').value,
                    valor: document.getElementById('migracaoValor').value,
                    iva: document.getElementById('migracaoIva').value,
                    status: document.getElementById('migracaoStatus').value,
                    dataInicio: document.getElementById('migracaoDataInicio').value,
                    observacoes: document.getElementById('migracaoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('migracoes', migracoes);
                mostrarNotificacao('Migra√ß√£o atualizada com sucesso!', 'success');
                
                // Fechar modal explicitamente
                console.log('üîß Fechando modal de migra√ß√£o...');
                fecharModal();
                
                // Aguardar um pouco antes de recarregar
                setTimeout(() => {
                    carregarSecao('migracoes');
                }, 100);
                
                console.log('‚úÖ Migra√ß√£o atualizada com sucesso!');
            } else {
                console.error('‚ùå Migra√ß√£o n√£o encontrada com ID:', id);
                mostrarNotificacao('Erro: Migra√ß√£o n√£o encontrada!', 'error');
            }
        }
        
        // Tornar fun√ß√£o global
        window.atualizarMigracao = atualizarMigracao;

        function atualizarRegisto(event, id) {
            console.log('üîß atualizarRegisto chamado com ID:', id);
            event.preventDefault();
            
            // Buscar registos do localStorage
            const registosSalvos = localStorage.getItem('registos');
            let registos = [];
            if (registosSalvos) {
                registos = JSON.parse(registosSalvos);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const registoIndex = registos.findIndex(r => r.id === id);
            if (registoIndex !== -1) {
                const clienteId = document.getElementById('registoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                registos[registoIndex] = {
                    ...registos[registoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : registos[registoIndex].clienteNome,
                    tipo: document.getElementById('registoTipo').value,
                    valor: document.getElementById('registoValor').value,
                    iva: document.getElementById('registoIva').value,
                    status: document.getElementById('registoStatus').value,
                    dataInicio: document.getElementById('registoDataInicio').value,
                    observacoes: document.getElementById('registoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                salvarDados('registos', registos);
                mostrarNotificacao('Registo atualizado com sucesso!', 'success');
                
                // Fechar modal explicitamente
                console.log('üîß Fechando modal de registo...');
                fecharModal();
                
                // Aguardar um pouco antes de recarregar
                setTimeout(() => {
                    carregarSecao('registos');
                }, 100);
                
                console.log('‚úÖ Registo atualizado com sucesso!');
            } else {
                console.error('‚ùå Registo n√£o encontrado com ID:', id);
                mostrarNotificacao('Erro: Registo n√£o encontrado!', 'error');
            }
        }
        
        // Tornar fun√ß√£o global
        window.atualizarRegisto = atualizarRegisto;
        
        // === FUN√á√ÉO SIMPLES PARA SALVAR HERAN√áA EDITADA ===
        function salvarHerancaEditada(event, id) {
            event.preventDefault();
            
            // Buscar heran√ßas do localStorage
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) {
                herancas = JSON.parse(herancasSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Encontrar a heran√ßa
            const herancaIndex = herancas.findIndex(h => h.id === id);
            if (herancaIndex !== -1) {
                const clienteId = document.getElementById('editClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                // Atualizar os dados
                herancas[herancaIndex] = {
                    ...herancas[herancaIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : herancas[herancaIndex].clienteNome,
                    tipo: document.getElementById('editTipo').value,
                    valor: document.getElementById('editValor').value,
                    iva: document.getElementById('editIva').value,
                    status: document.getElementById('editStatus').value,
                    dataInicio: document.getElementById('editDataInicio').value,
                    observacoes: document.getElementById('editObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('herancas', JSON.stringify(herancas));
                mostrarNotificacao('Heran√ßa atualizada com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoHeranca');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar se√ß√£o
                carregarSecao('herancas');
            }
        }
        
        // Tornar fun√ß√£o global
        window.salvarHerancaEditada = salvarHerancaEditada;
        
        // === FUN√á√ÉO PARA SALVAR MIGRA√á√ÉO EDITADA ===
        function salvarMigracaoEditada(event, id) {
            event.preventDefault();
            
            // Buscar migra√ß√µes do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Encontrar a migra√ß√£o
            const migracaoIndex = migracoes.findIndex(m => m.id === id);
            if (migracaoIndex !== -1) {
                const clienteId = document.getElementById('editMigracaoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                // Atualizar os dados
                migracoes[migracaoIndex] = {
                    ...migracoes[migracaoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : migracoes[migracaoIndex].clienteNome,
                    tipo: document.getElementById('editMigracaoTipo').value,
                    valor: document.getElementById('editMigracaoValor').value,
                    iva: document.getElementById('editMigracaoIva').value,
                    status: document.getElementById('editMigracaoStatus').value,
                    dataInicio: document.getElementById('editMigracaoDataInicio').value,
                    observacoes: document.getElementById('editMigracaoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('migracoes', JSON.stringify(migracoes));
                mostrarNotificacao('Migra√ß√£o atualizada com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoMigracao');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar se√ß√£o ap√≥s um pequeno delay
                setTimeout(() => {
                    carregarSecao('migracoes');
                }, 100);
            }
        }
        
        // Tornar fun√ß√£o global
        window.salvarMigracaoEditada = salvarMigracaoEditada;
        
        // === FUN√á√ÉO PARA SALVAR REGISTO EDITADO ===
        function salvarRegistoEditado(event, id) {
            event.preventDefault();
            
            // Buscar registos do localStorage
            const registosSalvos = localStorage.getItem('registos');
            let registos = [];
            if (registosSalvos) {
                registos = JSON.parse(registosSalvos);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Encontrar o registo
            const registoIndex = registos.findIndex(r => r.id === id);
            if (registoIndex !== -1) {
                const clienteId = document.getElementById('editRegistoClienteId').value;
                const cliente = clientes.find(c => c.id === parseInt(clienteId));
                
                // Atualizar os dados
                registos[registoIndex] = {
                    ...registos[registoIndex],
                    clienteId: parseInt(clienteId),
                    clienteNome: cliente ? cliente.nome : registos[registoIndex].clienteNome,
                    tipo: document.getElementById('editRegistoTipo').value,
                    valor: document.getElementById('editRegistoValor').value,
                    iva: document.getElementById('editRegistoIva').value,
                    status: document.getElementById('editRegistoStatus').value,
                    dataInicio: document.getElementById('editRegistoDataInicio').value,
                    observacoes: document.getElementById('editRegistoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('registos', JSON.stringify(registos));
                mostrarNotificacao('Registo atualizado com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoRegisto');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar se√ß√£o ap√≥s um pequeno delay
                setTimeout(() => {
                    carregarSecao('registos');
                    // For√ßar atualiza√ß√£o da lista
                    if (typeof atualizarListaRegistos === 'function') {
                        atualizarListaRegistos(registos);
                    }
                }, 100);
            }
        }
        
        // Tornar fun√ß√£o global
        window.salvarRegistoEditado = salvarRegistoEditado;

        // === FUN√á√ÉO PARA CONTROLAR MENU MOBILE ===
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
        }
        
        // Fechar sidebar ao clicar fora (mobile)
        document.addEventListener('click', function(event) {
            try {
                const sidebar = document.getElementById('sidebar');
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                
                if (window.innerWidth <= 1024 && sidebar && mobileMenuBtn) {
                    if (!sidebar.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                        sidebar.classList.remove('open');
                    }
                }
            } catch (error) {
                console.log('Erro no evento de click:', error);
            }
        });
        
        // Fechar sidebar ao redimensionar para desktop
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar && window.innerWidth > 1024) {
                sidebar.classList.remove('open');
            }
        });

        // === FUN√á√ÉO PARA CONTROLAR VISIBILIDADE DO NOME DA PARCERIA ===
        
        function toggleParceriaNome(tipo) {
            const parceriaSelect = document.getElementById(`${tipo}Parceria`) || document.querySelector(`select[name="parceria"]`);
            const nomeDiv = document.getElementById(`${tipo}ParceriaNomeDiv`) || document.getElementById(`${tipo}ParceriaNomeDiv`);
            
            if (parceriaSelect && nomeDiv) {
                if (parceriaSelect.value === 'empresa' || parceriaSelect.value === 'pessoa') {
                    nomeDiv.style.display = 'block';
                } else {
                    nomeDiv.style.display = 'none';
                }
            }
        }

        // === FUN√á√ïES ESPEC√çFICAS DE EDI√á√ÉO E EXCLUS√ÉO PARA √ÅREAS DE ATUA√á√ÉO ===
        
        function editarHeranca(id) {
            // Buscar heran√ßa diretamente do localStorage
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) {
                herancas = JSON.parse(herancasSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const heranca = herancas.find(h => h.id === id);
            if (heranca) {
                // Fechar qualquer modal aberto
                fecharModal();
                
                // Criar modal com layout original
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoHeranca';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Heran√ßa</h3>
                                <button onclick="document.getElementById('modalEdicaoHeranca').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarHerancaEditada(event, ${id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === heranca.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Aceita√ß√£o da heran√ßa" ${heranca.tipo === 'Aceita√ß√£o da heran√ßa' ? 'selected' : ''}>Aceita√ß√£o da heran√ßa</option>
                                            <option value="Doa√ß√µes" ${heranca.tipo === 'Doa√ß√µes' ? 'selected' : ''}>Doa√ß√µes</option>
                                            <option value="Escrituras de partilha" ${heranca.tipo === 'Escrituras de partilha' ? 'selected' : ''}>Escrituras de partilha</option>
                                            <option value="Habilita√ß√£o de herdeiros" ${heranca.tipo === 'Habilita√ß√£o de herdeiros' ? 'selected' : ''}>Habilita√ß√£o de herdeiros</option>
                                            <option value="Partilhas em vida" ${heranca.tipo === 'Partilhas em vida' ? 'selected' : ''}>Partilhas em vida</option>
                                            <option value="Partilhas por √≥bito" ${heranca.tipo === 'Partilhas por √≥bito' ? 'selected' : ''}>Partilhas por √≥bito</option>
                                            <option value="Processo de invent√°rio" ${heranca.tipo === 'Processo de invent√°rio' ? 'selected' : ''}>Processo de invent√°rio</option>
                                            <option value="Ren√∫ncia √† heran√ßa" ${heranca.tipo === 'Ren√∫ncia √† heran√ßa' ? 'selected' : ''}>Ren√∫ncia √† heran√ßa</option>
                                            <option value="Testamentos" ${heranca.tipo === 'Testamentos' ? 'selected' : ''}>Testamentos</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editValor" value="${heranca.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${heranca.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${heranca.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${heranca.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                                <option value="23" ${heranca.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${heranca.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${heranca.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${heranca.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                        <input type="date" id="editDataInicio" value="${heranca.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea id="editObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${heranca.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoHeranca').remove()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
            }
        }

        function excluirHeranca(id) {
            excluirItem('heranca', id);
        }

        function editarMigracao(id) {
            // Buscar migra√ß√£o diretamente do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const migracao = migracoes.find(m => m.id === id);
            if (migracao) {
                // Fechar qualquer modal aberto
                fecharModal();
                
                // Criar modal com layout original
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoMigracao';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Migra√ß√£o</h3>
                                <button onclick="document.getElementById('modalEdicaoMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarMigracaoEditada(event, ${id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editMigracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editMigracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autoriza√ß√£o de resid√™ncia" ${migracao.tipo === 'Autoriza√ß√£o de resid√™ncia' ? 'selected' : ''}>Autoriza√ß√£o de resid√™ncia</option>
                                            <option value="Certificados de resid√™ncia permanente" ${migracao.tipo === 'Certificados de resid√™ncia permanente' ? 'selected' : ''}>Certificados de resid√™ncia permanente</option>
                                            <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                            <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                            <option value="Renova√ß√£o de autoriza√ß√µes" ${migracao.tipo === 'Renova√ß√£o de autoriza√ß√µes' ? 'selected' : ''}>Renova√ß√£o de autoriza√ß√µes</option>
                                            <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                            <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                            <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                            <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editMigracaoValor" value="${migracao.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editMigracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                                <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editMigracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                        <input type="date" id="editMigracaoDataInicio" value="${migracao.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea id="editMigracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoMigracao').remove()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
            }
        }

        function excluirMigracao(id) {
            excluirItem('migracao', id);
        }

        function editarRegisto(id) {
            // Buscar registo diretamente do localStorage
            const registosSalvos = localStorage.getItem('registos');
            let registos = [];
            if (registosSalvos) {
                registos = JSON.parse(registosSalvos);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            const registo = registos.find(r => r.id === id);
            if (registo) {
                // Fechar qualquer modal aberto
                fecharModal();
                
                // Criar modal com layout original
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoRegisto';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Registo</h3>
                                <button onclick="document.getElementById('modalEdicaoRegisto').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarRegistoEditado(event, ${id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editRegistoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === registo.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editRegistoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autentica√ß√£o de documentos" ${registo.tipo === 'Autentica√ß√£o de documentos' ? 'selected' : ''}>Autentica√ß√£o de documentos</option>
                                            <option value="Certifica√ß√£o de fotoc√≥pias" ${registo.tipo === 'Certifica√ß√£o de fotoc√≥pias' ? 'selected' : ''}>Certifica√ß√£o de fotoc√≥pias</option>
                                            <option value="Documentos para o estrangeiro" ${registo.tipo === 'Documentos para o estrangeiro' ? 'selected' : ''}>Documentos para o estrangeiro</option>
                                            <option value="Procura√ß√µes" ${registo.tipo === 'Procura√ß√µes' ? 'selected' : ''}>Procura√ß√µes</option>
                                            <option value="Reconhecimento presencial de assinaturas" ${registo.tipo === 'Reconhecimento presencial de assinaturas' ? 'selected' : ''}>Reconhecimento presencial de assinaturas</option>
                                            <option value="Registos autom√≥veis" ${registo.tipo === 'Registos autom√≥veis' ? 'selected' : ''}>Registos autom√≥veis</option>
                                            <option value="Registos comerciais" ${registo.tipo === 'Registos comerciais' ? 'selected' : ''}>Registos comerciais</option>
                                            <option value="Registos de propriedade" ${registo.tipo === 'Registos de propriedade' ? 'selected' : ''}>Registos de propriedade</option>
                                            <option value="Termos de autentica√ß√£o" ${registo.tipo === 'Termos de autentica√ß√£o' ? 'selected' : ''}>Termos de autentica√ß√£o</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editRegistoValor" value="${registo.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editRegistoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${registo.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${registo.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${registo.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                                <option value="23" ${registo.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editRegistoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${registo.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${registo.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${registo.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                        <input type="date" id="editRegistoDataInicio" value="${registo.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea id="editRegistoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${registo.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoRegisto').remove()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
            }
        }

        function excluirRegisto(id) {
            excluirItem('registo', id);
        }
        
        // === FUN√á√ïES DE FILTRO PARA MIGRA√á√ïES ===
        function filtrarMigracoes() {
            aplicarFiltrosMigracoes();
        }

        function aplicarFiltrosMigracoes() {
            const busca = document.getElementById('buscaMigracoes')?.value.toLowerCase() || '';
            const statusFiltro = document.getElementById('filtroStatusMigracao')?.value || '';
            const tipoFiltro = document.getElementById('filtroTipoMigracao')?.value || '';
            const valorMin = parseFloat(document.getElementById('filtroValorMinMigracao')?.value) || 0;
            const valorMax = parseFloat(document.getElementById('filtroValorMaxMigracao')?.value) || Infinity;
            const nif = document.getElementById('filtroNifMigracao')?.value || '';

            const migracoesFiltradas = migracoes.filter(migracao => {
                const matchBusca = !busca || 
                    (migracao.clienteNome?.toLowerCase().includes(busca)) ||
                    (migracao.tipo?.toLowerCase().includes(busca));
                
                const matchStatus = !statusFiltro || migracao.status === statusFiltro;
                const matchTipo = !tipoFiltro || migracao.tipo === tipoFiltro;
                const valor = parseFloat(migracao.valor) || 0;
                const matchValor = valor >= valorMin && valor <= valorMax;

                // Filtro por NIF
                const cliente = clientes.find(c => c.id === migracao.clienteId);
                const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));

                return matchBusca && matchStatus && matchTipo && matchValor && matchNif;
            });

            // Atualizar tabela
            const tbody = document.getElementById('listaMigracoes');
            if (tbody) {
                tbody.innerHTML = migracoesFiltradas.map(migracao => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${migracao.clienteNome || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.tipo || 'N/A'}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${migracao.descricao || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div class="text-sm font-bold text-black">‚Ç¨${(migracao.valor || 0).toFixed(2)}</div>
                            <div class="text-xs font-bold text-red-600">+ IVA: ‚Ç¨${((migracao.valor || 0) + ((migracao.valor || 0) * (migracao.iva || 0) / 100)).toFixed(2)}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-badge status-${migracao.status}">${migracao.status === 'concluido' ? 'Conclu√≠do' : migracao.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.dataInicio ? new Date(migracao.dataInicio).toLocaleDateString('pt-PT') : 'Data n√£o definida'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="console.log('üîß Bot√£o editar clicado para ID:', ${migracao.id}); editarMigracaoDireto(${migracao.id})" class="text-blue-600 hover:text-blue-900 mr-3" title="Editar">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button onclick="abrirAnexosMigracao(${migracao.id})" class="text-green-600 hover:text-green-900 mr-3" title="Documentos">
                                <i data-lucide="paperclip" class="w-4 h-4"></i>
                            </button>
                            <button onclick="console.log('üîß Bot√£o excluir clicado para ID:', ${migracao.id}); excluirMigracaoDireto(${migracao.id})" class="text-red-600 hover:text-red-900" title="Excluir">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            // Atualizar contador
            const contador = document.getElementById('contadorMigracoes');
            if (contador) {
                contador.textContent = migracoesFiltradas.length;
            }

            // Recriar √≠cones
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function limparFiltrosMigracoes() {
            const elementos = [
                'buscaMigracoes',
                'filtroStatusMigracao', 
                'filtroTipoMigracao',
                'filtroValorMinMigracao',
                'filtroValorMaxMigracao',
                'filtroNifMigracao'
            ];
            
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.value = '';
                }
            });
            
            aplicarFiltrosMigracoes();
        }

        function abrirAnexosMigracao(id) {
            const migracao = migracoes.find(m => m.id === id);
            if (migracao) {
                abrirModalAnexos('migracao', id, migracao.clienteNome || 'Migra√ß√£o');
            }
        }

        // === FUN√á√ÉO DE EDI√á√ÉO PADR√ÉO ===
        function abrirModalEdicaoMigracao(migracao) {
            console.log('üîß abrirModalEdicaoMigracao chamado com:', migracao);
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            console.log('üîß Clientes encontrados:', clientes.length);
            
            if (migracao) {
                console.log('üîß Fechando modal...');
                // Fechar qualquer modal aberto
                fecharModal();
                
                console.log('üîß Criando modal...');
                // Criar modal com layout padr√£o
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoMigracao';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Migra√ß√£o</h3>
                                <button onclick="document.getElementById('modalEdicaoMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarMigracaoEditada(event, ${id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editMigracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editMigracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autoriza√ß√£o de resid√™ncia" ${migracao.tipo === 'Autoriza√ß√£o de resid√™ncia' ? 'selected' : ''}>Autoriza√ß√£o de resid√™ncia</option>
                                            <option value="Certificados de resid√™ncia permanente" ${migracao.tipo === 'Certificados de resid√™ncia permanente' ? 'selected' : ''}>Certificados de resid√™ncia permanente</option>
                                            <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                            <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                            <option value="Renova√ß√£o de autoriza√ß√µes" ${migracao.tipo === 'Renova√ß√£o de autoriza√ß√µes' ? 'selected' : ''}>Renova√ß√£o de autoriza√ß√µes</option>
                                            <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                            <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                            <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                            <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editMigracaoValor" value="${migracao.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editMigracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                                <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editMigracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                        <input type="date" id="editMigracaoDataInicio" value="${migracao.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea id="editMigracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoMigracao').remove()" class="btn btn-secondary">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
                console.log('üîß Modal de edi√ß√£o de migra√ß√£o inserido no DOM!');
            } else {
                console.log('üîß Erro: migra√ß√£o n√£o encontrada!');
            }
        }
        
        // === FUN√á√ÉO DE SALVAR PADR√ÉO ===
        function salvarMigracaoEditada(event, id) {
            event.preventDefault();
            console.log('üîß salvarMigracaoEditada chamado para ID:', id);
            
            // Buscar migra√ß√µes do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            // Encontrar a migra√ß√£o
            const migracaoIndex = migracoes.findIndex(m => m.id == id);
            console.log('üîß √çndice da migra√ß√£o encontrado:', migracaoIndex);
            
            if (migracaoIndex !== -1) {
                const clienteId = parseInt(document.getElementById('editMigracaoClienteId').value);
                const cliente = clientes.find(c => c.id === clienteId);
                
                const valor = parseFloat(document.getElementById('editMigracaoValor').value);
                const ivaPercent = parseFloat(document.getElementById('editMigracaoIva').value);
                const valorIVA = (valor * ivaPercent) / 100;
                const valorComIva = valor + valorIVA;
                
                // Atualizar os dados
                migracoes[migracaoIndex] = {
                    ...migracoes[migracaoIndex],
                    clienteId: clienteId,
                    clienteNome: cliente ? cliente.nome : migracoes[migracaoIndex].clienteNome,
                    tipo: document.getElementById('editMigracaoTipo').value,
                    valor: valor,
                    iva: ivaPercent,
                    valorIVA: valorIVA,
                    valorComIva: valorComIva,
                    status: document.getElementById('editMigracaoStatus').value,
                    dataInicio: document.getElementById('editMigracaoDataInicio').value,
                    observacoes: document.getElementById('editMigracaoObservacoes').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                console.log('üîß Migra√ß√£o atualizada:', migracoes[migracaoIndex]);
                
                // Salvar no localStorage
                localStorage.setItem('migracoes', JSON.stringify(migracoes));
                window.migracoes = migracoes;
                
                mostrarNotificacao('Migra√ß√£o atualizada com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoMigracao');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar se√ß√£o
                setTimeout(() => {
                    carregarSecao('migracoes');
                }, 100);
            } else {
                console.log('üîß Migra√ß√£o n√£o encontrada para atualizar!');
                mostrarNotificacao('Erro: Migra√ß√£o n√£o encontrada!', 'error');
            }
        }
        
        // Tornar fun√ß√£o global
        window.salvarMigracaoEditada = salvarMigracaoEditada;
        
        // === FUN√á√ÉO PARA ANEXOS DE CONTRATOS ===
        function abrirAnexosContrato(id) {
            const contrato = contratos.find(c => c.id === id);
            if (contrato) {
                abrirModalAnexos('contrato', id, contrato.clienteNome || 'Contrato');
            }
        }

        // === FUN√á√ÉO PARA ANEXOS DE HERAN√áAS ===
        function abrirAnexosHeranca(id) {
            const heranca = herancas.find(h => h.id === id);
            if (heranca) {
                abrirModalAnexos('heranca', id, heranca.clienteNome || 'Heran√ßa');
            }
        }

        // === FUN√á√ÉO PARA ANEXOS DE MIGRA√á√ïES ===
        function abrirAnexosMigracao(id) {
            const migracao = migracoes.find(m => m.id === id);
            if (migracao) {
                abrirModalAnexos('migracao', id, migracao.clienteNome || 'Migra√ß√£o');
            }
        }

        // === FUN√á√ÉO PARA ANEXOS DE REGISTOS ===
        function abrirAnexosRegisto(id) {
            const registo = registos.find(r => r.id === id);
            if (registo) {
                abrirModalAnexos('registo', id, registo.clienteNome || 'Registo');
            }
        }

        // === FUN√á√ÉO PRINCIPAL PARA ABRIR MODAL DE ANEXOS ===
        function abrirModalAnexos(tipo, id, nome) {
            console.log('üîß abrirModalAnexos chamado:', tipo, id, nome);
            
            // Fechar qualquer modal aberto primeiro
            fecharModal();
            
            // Buscar dados do localStorage
            let dados = [];
            let item = null;
            
            if (tipo === 'contrato') {
                const contratosSalvos = localStorage.getItem('contratos');
                if (contratosSalvos) {
                    dados = JSON.parse(contratosSalvos);
                }
                item = dados.find(c => c.id === id);
            } else if (tipo === 'heranca') {
                const herancasSalvas = localStorage.getItem('herancas');
                if (herancasSalvas) {
                    dados = JSON.parse(herancasSalvas);
                }
                item = dados.find(h => h.id === id);
            } else if (tipo === 'migracao') {
                const migracoesSalvas = localStorage.getItem('migracoes');
                if (migracoesSalvas) {
                    dados = JSON.parse(migracoesSalvas);
                }
                item = dados.find(m => m.id === id);
            } else if (tipo === 'registo') {
                const registosSalvos = localStorage.getItem('registos');
                if (registosSalvos) {
                    dados = JSON.parse(registosSalvos);
                }
                item = dados.find(r => r.id === id);
            }
            
            if (!item) {
                mostrarNotificacao('Item n√£o encontrado!', 'error');
                return;
            }
            
            // Inicializar array de anexos se n√£o existir
            if (!item.anexos) {
                item.anexos = [];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModal()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Documentos de ${nome}</h3>
                                <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <!-- Upload de novos documentos -->
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                                <form onsubmit="adicionarAnexo${tipo.charAt(0).toUpperCase() + tipo.slice(1)}(event, ${id})" enctype="multipart/form-data">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                            <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                            <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('${tipo}')">
                                                <option value="">Selecione o tipo</option>
                                                <option value="documento">Documento</option>
                                                <option value="comprovativo">Comprovativo</option>
                                                <option value="certificado">Certificado</option>
                                                <option value="contrato">Contrato</option>
                                                <option value="outro">Outro</option>
                                            </select>
                                            <div id="tipoPersonalizado${tipo.charAt(0).toUpperCase() + tipo.slice(1)}" class="mt-2 hidden">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                                <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                        <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o (opcional)</label>
                                        <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descri√ß√£o do documento..."></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-4">
                                        <button type="button" onclick="fecharModal()" class="btn btn-secondary">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Lista de documentos existentes -->
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${item.anexos.length})</h4>
                                ${item.anexos.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                        <p>Nenhum documento anexado ainda</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${item.anexos.map(anexo => `
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div class="flex items-center space-x-3">
                                                    <div class="p-2 bg-blue-100 rounded-lg">
                                                        <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                        <p class="text-sm text-gray-500">${anexo.tipo} ‚Ä¢ ${anexo.tamanho} ‚Ä¢ ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                        ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removerAnexo${tipo.charAt(0).toUpperCase() + tipo.slice(1)}(${id}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Adicionar modal ao body
            const modalElement = document.createElement('div');
            modalElement.innerHTML = modal;
            document.body.appendChild(modalElement.firstElementChild);
            lucide.createIcons();
        }

        // === FUN√á√ïES PARA ADICIONAR ANEXOS ===
        function adicionarAnexoContrato(event, contratoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const contrato = contratos.find(c => c.id === contratoId);
                if (contrato) {
                    if (!contrato.anexos) contrato.anexos = [];
                    contrato.anexos.push(anexo);
                    salvarDados('contratos', contratos);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    abrirAnexosContrato(contratoId);
                }
            });
        }

        function adicionarAnexoHeranca(event, herancaId) {
            console.log('üîß adicionarAnexoHeranca chamado com ID:', herancaId);
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            console.log('üîß Dados do formul√°rio:', { nome, tipoSelecionado, arquivo: arquivo?.name, descricao });
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const heranca = herancas.find(h => h.id === herancaId);
                console.log('üîß Heran√ßa encontrada:', heranca);
                if (heranca) {
                    if (!heranca.anexos) heranca.anexos = [];
                    heranca.anexos.push(anexo);
                    console.log('üîß Anexo adicionado:', anexo);
                    console.log('üîß Heran√ßa atualizada:', heranca);
                    salvarDados('herancas', herancas);
                    console.log('‚úÖ Dados salvos no localStorage');
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    abrirAnexosHeranca(herancaId);
                } else {
                    console.error('‚ùå Heran√ßa n√£o encontrada com ID:', herancaId);
                    mostrarNotificacao('Heran√ßa n√£o encontrada!', 'error');
                }
            });
        }

        function adicionarAnexoMigracao(event, migracaoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const migracao = migracoes.find(m => m.id === migracaoId);
                if (migracao) {
                    if (!migracao.anexos) migracao.anexos = [];
                    migracao.anexos.push(anexo);
                    salvarDados('migracoes', migracoes);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    abrirAnexosMigracao(migracaoId);
                }
            });
        }

        function adicionarAnexoRegisto(event, registoId) {
            event.preventDefault();
            
            const nome = document.getElementById('nomeDocumento').value;
            const tipoSelecionado = document.getElementById('tipoDocumento').value;
            const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
            const arquivo = document.getElementById('arquivoDocumento').files[0];
            const descricao = document.getElementById('descricaoDocumento').value;
            
            if (!arquivo) {
                mostrarNotificacao('Por favor, selecione um arquivo', 'error');
                return;
            }
            
            const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
            
            if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
                mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
                return;
            }
            
            // Converter arquivo para Base64
            converterArquivoParaBase64(arquivo, function(base64Content) {
                const anexo = {
                    id: Date.now().toString(),
                    nome: nome,
                    tipo: tipo,
                    descricao: descricao,
                    nomeArquivo: arquivo.name,
                    tamanho: formatarTamanho(arquivo.size),
                    dataUpload: new Date().toISOString(),
                    tipoArquivo: arquivo.type,
                    conteudo: base64Content
                };
                
                const registo = registos.find(r => r.id === registoId);
                if (registo) {
                    if (!registo.anexos) registo.anexos = [];
                    registo.anexos.push(anexo);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento adicionado com sucesso!', 'success');
                    abrirAnexosRegisto(registoId);
                }
            });
        }

        // === FUN√á√ïES PARA REMOVER ANEXOS ===
        function removerAnexoContrato(contratoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const contrato = contratos.find(c => c.id === contratoId);
                if (contrato && contrato.anexos) {
                    contrato.anexos = contrato.anexos.filter(a => a.id !== anexoId);
                    salvarDados('contratos', contratos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosContrato(contratoId);
                }
            }
        }

        function removerAnexoHeranca(herancaId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const heranca = herancas.find(h => h.id === herancaId);
                if (heranca && heranca.anexos) {
                    heranca.anexos = heranca.anexos.filter(a => a.id !== anexoId);
                    salvarDados('herancas', herancas);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosHeranca(herancaId);
                }
            }
        }

        function removerAnexoMigracao(migracaoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const migracao = migracoes.find(m => m.id === migracaoId);
                if (migracao && migracao.anexos) {
                    migracao.anexos = migracao.anexos.filter(a => a.id !== anexoId);
                    salvarDados('migracoes', migracoes);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosMigracao(migracaoId);
                }
            }
        }

        function removerAnexoRegisto(registoId, anexoId) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                const registo = registos.find(r => r.id === registoId);
                if (registo && registo.anexos) {
                    registo.anexos = registo.anexos.filter(a => a.id !== anexoId);
                    salvarDados('registos', registos);
                    mostrarNotificacao('Documento removido com sucesso!', 'success');
                    abrirAnexosRegisto(registoId);
                }
            }
        }

        // === FUN√á√ÉO PARA TOGGLE TIPO PERSONALIZADO ===
        function toggleTipoPersonalizado(tipo) {
            const select = document.getElementById('tipoDocumento');
            const divPersonalizado = document.getElementById(`tipoPersonalizado${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
            
            if (select.value === 'outro') {
                divPersonalizado.classList.remove('hidden');
            } else {
                divPersonalizado.classList.add('hidden');
            }
        }

        // === FUN√á√ïES DIRETAS PARA CONTRATOS ===
        function editarContratoDireto(id) {
            console.log('üîß editarContratoDireto chamado com ID:', id);
            const contratosSalvos = localStorage.getItem('contratos');
            let contratos = [];
            if (contratosSalvos) contratos = JSON.parse(contratosSalvos);
            const contrato = contratos.find(c => c.id === id);
            if (contrato) {
                fecharModal();
                setTimeout(() => abrirModalEdicaoContrato(contrato), 100);
            } else {
                mostrarNotificacao('Contrato n√£o encontrado!', 'error');
            }
        }

        function excluirContratoDireto(id) {
            if (confirm('Tem certeza que deseja excluir este contrato? Esta a√ß√£o n√£o pode ser desfeita.')) {
                const contratosSalvos = localStorage.getItem('contratos');
                let contratos = [];
                if (contratosSalvos) contratos = JSON.parse(contratosSalvos);
                contratos = contratos.filter(c => c.id !== id);
                localStorage.setItem('contratos', JSON.stringify(contratos));
                window.contratos = contratos;
                mostrarNotificacao('Contrato exclu√≠do com sucesso!', 'success');
                carregarSecao('contratos');
            }
        }

        // === FUN√á√ïES DIRETAS PARA HERAN√áAS ===
        function editarHerancaDireto(id) {
            console.log('üîß editarHerancaDireto chamado com ID:', id);
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
            const heranca = herancas.find(h => h.id === id);
            if (heranca) {
                fecharModal();
                setTimeout(() => abrirModalEdicaoHeranca(heranca), 100);
            } else {
                mostrarNotificacao('Heran√ßa n√£o encontrada!', 'error');
            }
        }

        function excluirHerancaDireto(id) {
            if (confirm('Tem certeza que deseja excluir esta heran√ßa? Esta a√ß√£o n√£o pode ser desfeita.')) {
                const herancasSalvas = localStorage.getItem('herancas');
                let herancas = [];
                if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
                herancas = herancas.filter(h => h.id !== id);
                localStorage.setItem('herancas', JSON.stringify(herancas));
                window.herancas = herancas;
                mostrarNotificacao('Heran√ßa exclu√≠da com sucesso!', 'success');
                carregarSecao('herancas');
            }
        }

        // === FUN√á√ïES DIRETAS PARA MIGRA√á√ïES ===
        function editarMigracaoDireto(id) {
            console.log('üîß editarMigracaoDireto chamado com ID:', id);
            
            // Buscar migra√ß√µes do localStorage
            const migracoesSalvas = localStorage.getItem('migracoes');
            let migracoes = [];
            if (migracoesSalvas) {
                migracoes = JSON.parse(migracoesSalvas);
            }
            
            const migracao = migracoes.find(m => m.id == id);
            console.log('üîß Migra√ß√£o encontrada:', migracao);
            
            if (migracao) {
                // Fechar qualquer modal existente
                fecharModal();
                
                // Criar modal simples de edi√ß√£o
                const modal = document.createElement('div');
                modal.id = 'modalEdicaoMigracao';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
                // Buscar clientes do localStorage
                const clientesSalvos = localStorage.getItem('clientes');
                let clientes = [];
                if (clientesSalvos) {
                    clientes = JSON.parse(clientesSalvos);
                }
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Editar Migra√ß√£o</h3>
                                <button onclick="document.getElementById('modalEdicaoMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="salvarMigracaoEditada(event, ${migracao.id})">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                        <select id="editMigracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Cliente</option>
                                            ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                        <select id="editMigracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                            <option value="">Selecionar Tipo</option>
                                            <option value="Autoriza√ß√£o de resid√™ncia" ${migracao.tipo === 'Autoriza√ß√£o de resid√™ncia' ? 'selected' : ''}>Autoriza√ß√£o de resid√™ncia</option>
                                            <option value="Certificados de resid√™ncia permanente" ${migracao.tipo === 'Certificados de resid√™ncia permanente' ? 'selected' : ''}>Certificados de resid√™ncia permanente</option>
                                            <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                            <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                            <option value="Renova√ß√£o de autoriza√ß√µes" ${migracao.tipo === 'Renova√ß√£o de autoriza√ß√µes' ? 'selected' : ''}>Renova√ß√£o de autoriza√ß√µes</option>
                                            <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                            <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                            <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                            <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                            <input type="number" id="editMigracaoValor" value="${migracao.valor || ''}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                            <select id="editMigracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                                <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                                <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Interm√©dia)</option>
                                                <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                            <select id="editMigracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                                <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio *</label>
                                        <input type="date" id="editMigracaoDataInicio" value="${migracao.dataInicio || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                                        <textarea id="editMigracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="document.getElementById('modalEdicaoMigracao').remove()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                        Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
                console.log('üîß Modal de edi√ß√£o criado e inserido no DOM!');
            } else {
                mostrarNotificacao('Migra√ß√£o n√£o encontrada!', 'error');
            }
        }

        function excluirMigracaoDireto(id) {
            console.log('üîß excluirMigracaoDireto chamado com ID:', id);
            if (confirm('Tem certeza que deseja excluir esta migra√ß√£o? Esta a√ß√£o n√£o pode ser desfeita.')) {
                // Buscar migra√ß√µes do localStorage
                const migracoesSalvas = localStorage.getItem('migracoes');
                let migracoes = [];
                if (migracoesSalvas) {
                    migracoes = JSON.parse(migracoesSalvas);
                }
                
                // Filtrar para remover a migra√ß√£o
                migracoes = migracoes.filter(m => m.id != id);
                
                // Salvar no localStorage
                localStorage.setItem('migracoes', JSON.stringify(migracoes));
                
                // Atualizar array global
                window.migracoes = migracoes;
                
                mostrarNotificacao('Migra√ß√£o exclu√≠da com sucesso!', 'success');
                
                // Recarregar se√ß√£o
                carregarSecao('migracoes');
            }
        }

        // === SISTEMA DE IVA TRIMESTRAL ===
        
        // Fun√ß√£o para determinar o trimestre atual
        function obterTrimestreAtual() {
            const agora = new Date();
            const mes = agora.getMonth() + 1; // Janeiro = 1, Dezembro = 12
            
            if (mes >= 1 && mes <= 3) return 1; // 1¬∫ Trimestre (Jan-Mar)
            if (mes >= 4 && mes <= 6) return 2; // 2¬∫ Trimestre (Abr-Jun)
            if (mes >= 7 && mes <= 9) return 3; // 3¬∫ Trimestre (Jul-Set)
            if (mes >= 10 && mes <= 12) return 4; // 4¬∫ Trimestre (Out-Dez)
        }
        
        // Fun√ß√£o para obter datas de prazo do IVA
        function obterPrazosIVA(trimestre) {
            const ano = new Date().getFullYear();
            const prazos = {
                1: { // 1¬∫ Trimestre
                    entrega: `${ano}-05-20`,
                    pagamento: `${ano}-05-25`,
                    periodo: 'Janeiro a Mar√ßo'
                },
                2: { // 2¬∫ Trimestre
                    entrega: `${ano}-07-20`,
                    pagamento: `${ano}-07-25`,
                    periodo: 'Abril a Junho'
                },
                3: { // 3¬∫ Trimestre
                    entrega: `${ano}-11-20`,
                    pagamento: `${ano}-11-25`,
                    periodo: 'Julho a Setembro'
                },
                4: { // 4¬∫ Trimestre
                    entrega: `${ano + 1}-02-20`,
                    pagamento: `${ano + 1}-02-25`,
                    periodo: 'Outubro a Dezembro'
                }
            };
            return prazos[trimestre];
        }
        
        // Fun√ß√£o para calcular IVA acumulado por trimestre
        function calcularIVATrimestral_REMOVED() {
            const trimestreAtual = obterTrimestreAtual();
            const ano = new Date().getFullYear();
            
            // Buscar todos os dados
            const contratosSalvos = localStorage.getItem('contratos');
            const herancasSalvas = localStorage.getItem('herancas');
            const migracoesSalvas = localStorage.getItem('migracoes');
            const registosSalvos = localStorage.getItem('registos');
            
            let contratos = [], herancas = [], migracoes = [], registos = [];
            if (contratosSalvos) contratos = JSON.parse(contratosSalvos);
            if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
            if (migracoesSalvas) migracoes = JSON.parse(migracoesSalvas);
            if (registosSalvos) registos = JSON.parse(registosSalvos);
            
            const todosItens = [...contratos, ...herancas, ...migracoes, ...registos];
            
            // Calcular IVA por trimestre
            const ivaPorTrimestre = {
                1: { valor: 0, itens: 0, periodo: 'Janeiro a Mar√ßo' },
                2: { valor: 0, itens: 0, periodo: 'Abril a Junho' },
                3: { valor: 0, itens: 0, periodo: 'Julho a Setembro' },
                4: { valor: 0, itens: 0, periodo: 'Outubro a Dezembro' }
            };
            
            todosItens.forEach(item => {
                if (item.dataInicio) {
                    const dataInicio = new Date(item.dataInicio);
                    const mes = dataInicio.getMonth() + 1;
                    
                    let trimestre;
                    if (mes >= 1 && mes <= 3) trimestre = 1;
                    else if (mes >= 4 && mes <= 6) trimestre = 2;
                    else if (mes >= 7 && mes <= 9) trimestre = 3;
                    else if (mes >= 10 && mes <= 12) trimestre = 4;
                    
                    if (trimestre && item.valorIVA) {
                        ivaPorTrimestre[trimestre].valor += parseFloat(item.valorIVA) || 0;
                        ivaPorTrimestre[trimestre].itens += 1;
                    }
                }
            });
            
            return { ivaPorTrimestre, trimestreAtual };
        }
        
        // Fun√ß√£o para criar prazos autom√°ticos de IVA
        function criarPrazosIVA() {
            const trimestreAtual = obterTrimestreAtual();
            const prazos = obterPrazosIVA(trimestreAtual);
            
            // Verificar se j√° existem prazos de IVA para este trimestre
            const prazosSalvos = localStorage.getItem('prazos');
            let prazosExistentes = [];
            if (prazosSalvos) prazosExistentes = JSON.parse(prazosSalvos);
            
            const prazoEntregaExiste = prazosExistentes.some(p => 
                p.tipo === 'iva_entrega' && p.dataLimite === prazos.entrega
            );
            
            const prazoPagamentoExiste = prazosExistentes.some(p => 
                p.tipo === 'iva_pagamento' && p.dataLimite === prazos.pagamento
            );
            
            // Criar prazo de entrega se n√£o existir
            if (!prazoEntregaExiste) {
                const prazoEntrega = {
                    id: Date.now() + 1,
                    clienteId: 0,
                    clienteNome: 'Sistema',
                    descricao: `Entrega da declara√ß√£o de IVA - ${prazos.periodo}`,
                    dataLimite: prazos.entrega,
                    status: 'ativo',
                    tipo: 'iva_entrega',
                    prioridade: 'alta',
                    referenciaId: null,
                    dataCriacao: new Date().toISOString()
                };
                prazosExistentes.push(prazoEntrega);
            }
            
            // Criar prazo de pagamento se n√£o existir
            if (!prazoPagamentoExiste) {
                const prazoPagamento = {
                    id: Date.now() + 2,
                    clienteId: 0,
                    clienteNome: 'Sistema',
                    descricao: `Pagamento do IVA - ${prazos.periodo}`,
                    dataLimite: prazos.pagamento,
                    status: 'ativo',
                    tipo: 'iva_pagamento',
                    prioridade: 'alta',
                    referenciaId: null,
                    dataCriacao: new Date().toISOString()
                };
                prazosExistentes.push(prazoPagamento);
            }
            
            // Salvar prazos
            localStorage.setItem('prazos', JSON.stringify(prazosExistentes));
            window.prazos = prazosExistentes;
        }
        
        // === FUN√á√ïES DE IVA TRIMESTRAL ===
        
        function obterTrimestreAtual() {
            const agora = new Date();
            return Math.floor(agora.getMonth() / 3) + 1;
        }
        
        function calcularIVATrimestral_REMOVED() {
            const anoAtual = new Date().getFullYear();
            const trimestreAtual = obterTrimestreAtual();
            
            const ivaPorTrimestre = {
                1: { valor: 0, itens: 0, periodo: 'Jan-Mar' },
                2: { valor: 0, itens: 0, periodo: 'Abr-Jun' },
                3: { valor: 0, itens: 0, periodo: 'Jul-Set' },
                4: { valor: 0, itens: 0, periodo: 'Out-Dez' }
            };
            
            // Calcular IVA de todas as fontes
            const todasFontes = [
                ...contratos.map(c => ({ ...c, fonte: 'contrato' })),
                ...herancas.map(h => ({ ...h, fonte: 'heranca' })),
                ...migracoes.map(m => ({ ...m, fonte: 'migracao' })),
                ...registos.map(r => ({ ...r, fonte: 'registo' }))
            ];
            
            todasFontes.forEach(item => {
                if (item.dataCriacao) {
                    const data = new Date(item.dataCriacao);
                    const ano = data.getFullYear();
                    
                    if (ano === anoAtual) {
                        const trimestre = Math.floor(data.getMonth() / 3) + 1;
                        const valor = parseFloat(item.valor) || 0;
                        const iva = parseFloat(item.iva) || 0;
                        const valorIVA = (valor * iva) / 100;
                        
                        if (ivaPorTrimestre[trimestre]) {
                            ivaPorTrimestre[trimestre].valor += valorIVA;
                            ivaPorTrimestre[trimestre].itens++;
                        }
                    }
                }
            });
            
            return { ivaPorTrimestre, trimestreAtual };
        }
        
        function obterPrazosIVA(trimestre) {
            const anoAtual = new Date().getFullYear();
            const mesInicio = (trimestre - 1) * 3;
            const mesFim = mesInicio + 2;
            
            // Prazo de entrega: at√© o dia 10 do segundo m√™s ap√≥s o fim do trimestre
            const dataEntrega = new Date(anoAtual, mesFim + 2, 10);
            
            // Prazo de pagamento: at√© o dia 15 do segundo m√™s ap√≥s o fim do trimestre
            const dataPagamento = new Date(anoAtual, mesFim + 2, 15);
            
            const periodos = {
                1: 'Janeiro-Mar√ßo',
                2: 'Abril-Junho',
                3: 'Julho-Setembro',
                4: 'Outubro-Dezembro'
            };
            
            return {
                trimestre: trimestre,
                periodo: periodos[trimestre],
                entrega: dataEntrega.toISOString(),
                pagamento: dataPagamento.toISOString()
            };
        }
        
        function criarPrazosIVA() {
            const trimestreAtual = obterTrimestreAtual();
            const prazosIVA = obterPrazosIVA(trimestreAtual);
            // const { ivaPorTrimestre } = calcularIVATrimestral(); // REMOVIDO
            
            // Verificar se j√° existe um prazo de IVA para este trimestre
            const prazoExistente = prazos.find(p => 
                p.tipo === 'iva_trimestral' && 
                p.trimestre === trimestreAtual &&
                new Date(p.dataCriacao).getFullYear() === new Date().getFullYear()
            );
            
            if (prazoExistente) {
                mostrarNotificacao('J√° existe um prazo de IVA para este trimestre!', 'warning');
                return;
            }
            
            // Criar prazos de entrega e pagamento
            const prazoEntrega = {
                id: Date.now(),
                clienteId: null,
                clienteNome: 'Autoridade Tribut√°ria',
                tipo: 'iva_trimestral',
                trimestre: trimestreAtual,
                descricao: `Entrega da Declara√ß√£o de IVA - ${prazosIVA.periodo}`,
                dataLimite: prazosIVA.entrega.split('T')[0],
                status: 'ativo',
                prioridade: 'alta',
                valorIVA: ivaPorTrimestre[trimestreAtual].valor,
                dataCriacao: new Date().toISOString()
            };
            
            const prazoPagamento = {
                id: Date.now() + 1,
                clienteId: null,
                clienteNome: 'Autoridade Tribut√°ria',
                tipo: 'iva_trimestral',
                trimestre: trimestreAtual,
                descricao: `Pagamento do IVA - ${prazosIVA.periodo} (‚Ç¨${ivaPorTrimestre[trimestreAtual].valor.toFixed(2)})`,
                dataLimite: prazosIVA.pagamento.split('T')[0],
                status: 'ativo',
                prioridade: 'alta',
                valorIVA: ivaPorTrimestre[trimestreAtual].valor,
                dataCriacao: new Date().toISOString()
            };
            
            prazos.push(prazoEntrega, prazoPagamento);
            salvarDados('prazos', prazos);
            
            mostrarNotificacao('Prazos de IVA criados com sucesso!', 'success');
            
            // Recarregar a se√ß√£o de prazos se estiver ativa
            if (secaoAtiva === 'prazos') {
                carregarSecao('prazos');
            }
        }
        
        // Fun√ß√£o para gerar relat√≥rio de IVA trimestral

        // === FUN√á√ïES DIRETAS PARA HONOR√ÅRIOS (COPIA EXATA DAS HERAN√áAS) ===
        function editarHonorarioDireto(id) {
            console.log('üîß editarHonorarioDireto chamado com ID:', id, 'Tipo:', typeof id);
            const honorariosSalvos = localStorage.getItem('honorarios');
            let honorarios = [];
            if (honorariosSalvos) {
                honorarios = JSON.parse(honorariosSalvos);
            }
            
            // Converter ID para number se necess√°rio
            const idNum = typeof id === 'string' ? parseInt(id) : id;
            console.log('üîß ID convertido:', idNum);
            console.log('üîß Total de honor√°rios no localStorage:', honorarios.length);
            console.log('üîß IDs dos honor√°rios:', honorarios.map(h => h.id));
            
            // Tentar diferentes tipos de compara√ß√£o
            let honorario = honorarios.find(h => h.id == idNum);
            if (!honorario) {
                console.log('üîß Tentando compara√ß√£o com string...');
                honorario = honorarios.find(h => h.id == id);
            }
            if (!honorario) {
                console.log('üîß Tentando compara√ß√£o com parseInt...');
                honorario = honorarios.find(h => h.id == parseInt(id));
            }
            console.log('üîß Honor√°rio encontrado:', honorario);
            
            if (honorario) {
                console.log('üîß Fechando modal existente...');
                fecharModal();
                console.log('üîß Chamando abrirModalEdicaoHonorario...');
                setTimeout(() => {
                    console.log('üîß Executando abrirModalEdicaoHonorario...');
                    abrirModalEdicaoHonorario(honorario);
                }, 100);
            } else {
                console.log('‚ùå Honor√°rio n√£o encontrado!');
                mostrarNotificacao('Honor√°rio n√£o encontrado!', 'error');
            }
        }

        function excluirHonorarioDireto(id) {
            console.log('üîß excluirHonorarioDireto chamado com ID:', id, 'Tipo:', typeof id);
            if (confirm('Tem certeza que deseja excluir este honor√°rio? Esta a√ß√£o n√£o pode ser desfeita.')) {
                const honorariosSalvos = localStorage.getItem('honorarios');
                let honorarios = [];
                if (honorariosSalvos) {
                    honorarios = JSON.parse(honorariosSalvos);
                }
                
                // Converter ID para number se necess√°rio
                const idNum = typeof id === 'string' ? parseInt(id) : id;
                console.log('üîß ID convertido para exclus√£o:', idNum);
                
                honorarios = honorarios.filter(h => h.id != idNum);
                localStorage.setItem('honorarios', JSON.stringify(honorarios));
                window.honorarios = honorarios;
                
                mostrarNotificacao('Honor√°rio exclu√≠do com sucesso!', 'success');
                carregarSecao('honorarios');
            }
        }

        function abrirModalEdicaoHonorario(honorario) {
            console.log('üîß abrirModalEdicaoHonorario chamado com:', honorario);
            
            // Verificar se j√° existe um modal
            const modalExistente = document.getElementById('modalEdicaoHonorario');
            if (modalExistente) {
                console.log('üîß Removendo modal existente...');
                modalExistente.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'modalEdicaoHonorario';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            console.log('üîß Modal criado, buscando clientes...');
            
            // Buscar clientes do localStorage
            const clientesSalvos = localStorage.getItem('clientes');
            let clientes = [];
            if (clientesSalvos) {
                clientes = JSON.parse(clientesSalvos);
            }
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Editar Honor√°rio</h3>
                            <button onclick="document.getElementById('modalEdicaoHonorario').remove()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                <select id="editHonorarioCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Cliente</option>
                                    ${clientes.map(cliente => `<option value="${cliente.nome}" ${cliente.nome === honorario.cliente ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Servi√ßo *</label>
                                <input type="text" id="editHonorarioServico" value="${honorario.servico || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                <input type="number" id="editHonorarioValor" value="${honorario.valor || ''}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="editHonorarioStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="pendente" ${honorario.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="pago" ${honorario.status === 'pago' ? 'selected' : ''}>Pago</option>
                                    <option value="vencido" ${honorario.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                                <input type="date" id="editHonorarioVencimento" value="${honorario.vencimento || ''}" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="document.getElementById('modalEdicaoHonorario').remove()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                Cancelar
                            </button>
                            <button type="button" onclick="console.log('üîß Bot√£o Salvar clicado!'); alert('Bot√£o clicado!'); salvarHonorarioEditadoSimples('${honorario.id}')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                Salvar Altera√ß√µes
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            console.log('üîß Inserindo modal no DOM...');
            document.body.appendChild(modal);
            console.log('üîß Modal inserido, criando √≠cones...');
            lucide.createIcons();
            console.log('üîß Modal de edi√ß√£o de honor√°rio criado e inserido no DOM!');
        }

        function salvarHonorarioEditado(event, id) {
            console.log('üîß FUN√á√ÉO salvarHonorarioEditado INICIADA!');
            event.preventDefault();
            console.log('üîß salvarHonorarioEditado chamado para ID:', id, 'Tipo:', typeof id);
            
            const honorariosSalvos = localStorage.getItem('honorarios');
            let honorarios = [];
            if (honorariosSalvos) {
                honorarios = JSON.parse(honorariosSalvos);
            }
            
            // Converter ID para number se necess√°rio
            const idNum = typeof id === 'string' ? parseInt(id) : id;
            console.log('üîß ID convertido para salvar:', idNum);
            console.log('üîß Total de honor√°rios:', honorarios.length);
            console.log('üîß IDs dos honor√°rios:', honorarios.map(h => h.id));
            
            // Tentar diferentes tipos de compara√ß√£o
            let honorarioIndex = honorarios.findIndex(h => h.id == idNum);
            if (honorarioIndex === -1) {
                console.log('üîß Tentando compara√ß√£o com string...');
                honorarioIndex = honorarios.findIndex(h => h.id == id);
            }
            if (honorarioIndex === -1) {
                console.log('üîß Tentando compara√ß√£o com parseInt...');
                honorarioIndex = honorarios.findIndex(h => h.id == parseInt(id));
            }
            
            console.log('üîß √çndice encontrado:', honorarioIndex);
            
            if (honorarioIndex !== -1) {
                honorarios[honorarioIndex] = {
                    ...honorarios[honorarioIndex],
                    cliente: document.getElementById('editHonorarioCliente').value,
                    servico: document.getElementById('editHonorarioServico').value,
                    valor: parseFloat(document.getElementById('editHonorarioValor').value),
                    status: document.getElementById('editHonorarioStatus').value,
                    vencimento: document.getElementById('editHonorarioVencimento').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                localStorage.setItem('honorarios', JSON.stringify(honorarios));
                window.honorarios = honorarios;
                
                mostrarNotificacao('Honor√°rio atualizado com sucesso!', 'success');
                
                const modal = document.getElementById('modalEdicaoHonorario');
                if (modal) {
                    modal.remove();
                }
                
                setTimeout(() => {
                    carregarSecao('honorarios');
                }, 100);
            } else {
                mostrarNotificacao('Erro: Honor√°rio n√£o encontrado!', 'error');
            }
        }

        function salvarHonorarioEditadoSimples(id) {
            console.log('üîß salvarHonorarioEditadoSimples chamado para ID:', id, 'Tipo:', typeof id);
            
            // Buscar honor√°rios do localStorage
            const honorariosSalvos = localStorage.getItem('honorarios');
            let honorarios = [];
            if (honorariosSalvos) {
                honorarios = JSON.parse(honorariosSalvos);
            }
            
            console.log('üîß Total de honor√°rios:', honorarios.length);
            console.log('üîß IDs dos honor√°rios:', honorarios.map(h => h.id));
            
            // Encontrar o honor√°rio
            const honorarioIndex = honorarios.findIndex(h => h.id == id);
            console.log('üîß √çndice encontrado:', honorarioIndex);
            
            if (honorarioIndex !== -1) {
                // Atualizar os dados
                honorarios[honorarioIndex] = {
                    ...honorarios[honorarioIndex],
                    cliente: document.getElementById('editHonorarioCliente').value,
                    servico: document.getElementById('editHonorarioServico').value,
                    valor: parseFloat(document.getElementById('editHonorarioValor').value),
                    status: document.getElementById('editHonorarioStatus').value,
                    vencimento: document.getElementById('editHonorarioVencimento').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('honorarios', JSON.stringify(honorarios));
                window.honorarios = honorarios;
                
                mostrarNotificacao('Honor√°rio atualizado com sucesso!', 'success');
                
                // Fechar modal
                const modal = document.getElementById('modalEdicaoHonorario');
                if (modal) {
                    modal.remove();
                }
                
                // Recarregar se√ß√£o
                setTimeout(() => {
                    carregarSecao('honorarios');
                }, 100);
            } else {
                console.log('üîß Honor√°rio n√£o encontrado para atualizar!');
                mostrarNotificacao('Erro: Honor√°rio n√£o encontrado!', 'error');
            }
        }

        // === FUN√á√ïES DIRETAS PARA REGISTOS ===
        function editarRegistoDireto(id) {
            console.log('üîß editarRegistoDireto chamado com ID:', id);
            console.log('üîß Tipo do ID:', typeof id);
            
            // Converter ID para n√∫mero se necess√°rio
            const idNumerico = parseInt(id);
            console.log('üîß ID convertido para n√∫mero:', idNumerico);
            
            if (isNaN(idNumerico)) {
                console.error('‚ùå ID inv√°lido:', id);
                mostrarNotificacao('ID inv√°lido!', 'error');
                return;
            }
            
            // Carregar dados do registo
            const registosSalvos = localStorage.getItem('registos');
            let registos = [];
            if (registosSalvos) registos = JSON.parse(registosSalvos);
            
            // Se n√£o h√° registos, criar dados de teste
            if (!registos || registos.length === 0) {
                console.log('üîß Criando dados de teste para registos');
                registos = [
                    {
                        id: 1,
                        clienteId: 1,
                        clienteNome: 'Jo√£o Silva',
                        tipo: 'Documentos',
                        descricao: 'Documentos para o estrangeiro',
                        valor: 100,
                        iva: 23,
                        valorComIva: 123,
                        status: 'pendente',
                        dataInicio: '2025-10-24'
                    },
                    {
                        id: 2,
                        clienteId: 2,
                        clienteNome: 'Maria Santos',
                        tipo: 'Certid√µes',
                        descricao: 'Certid√£o de nascimento',
                        valor: 50,
                        iva: 23,
                        valorComIva: 61.5,
                        status: 'concluido',
                        dataInicio: '2025-10-23'
                    }
                ];
                localStorage.setItem('registos', JSON.stringify(registos));
                window.registos = registos;
            }
            
            console.log('üîß Registos dispon√≠veis:', registos);
            console.log('üîß Procurando registo com ID:', idNumerico);
            
            const registo = registos.find(r => r.id === idNumerico);
            if (!registo) {
                console.error('‚ùå Registo n√£o encontrado com ID:', idNumerico);
                mostrarNotificacao('Registo n√£o encontrado!', 'error');
                return;
            }
            
            console.log('‚úÖ Registo encontrado:', registo);
            // Abrir modal de edi√ß√£o
            abrirModalEdicaoRegisto(registo);
        }

        function abrirAnexosRegisto(id) {
            console.log('üîß abrirAnexosRegisto chamado com ID:', id);
            const registo = registos.find(r => r.id === parseInt(id));
            console.log('üîß Registo encontrado:', registo);
            if (registo) {
                console.log('üîß Chamando abrirModalAnexos para registo');
                abrirModalAnexos('registo', id, registo.clienteNome || 'Registo');
            } else {
                console.error('‚ùå Registo n√£o encontrado com ID:', id);
                mostrarNotificacao('Registo n√£o encontrado!', 'error');
            }
        }

        function excluirRegistoDireto(id) {
            console.log('üîß excluirRegistoDireto chamado com ID:', id);
            
            if (confirm('Tem certeza que deseja excluir este registo? Esta a√ß√£o n√£o pode ser desfeita.')) {
                // Carregar dados do registo
                const registosSalvos = localStorage.getItem('registos');
                let registos = [];
                if (registosSalvos) registos = JSON.parse(registosSalvos);
                
                // Filtrar registo a ser exclu√≠do
                const registosAtualizados = registos.filter(r => r.id !== parseInt(id));
                
                // Salvar dados atualizados
                localStorage.setItem('registos', JSON.stringify(registosAtualizados));
                window.registos = registosAtualizados;
                
                mostrarNotificacao('Registo exclu√≠do com sucesso!', 'success');
                
                // Recarregar se√ß√£o
                setTimeout(() => {
                    carregarSecao('registos');
                    if (typeof atualizarListaRegistos === 'function') {
                        atualizarListaRegistos(registosAtualizados);
                    }
                }, 100);
            }
        }

        // === FUN√á√ïES PARA HERAN√áAS ===
        function editarHerancaDireto(id) {
            console.log('üîß editarHerancaDireto chamado com ID:', id);
            
            // Carregar dados da heran√ßa
            const herancasSalvas = localStorage.getItem('herancas');
            let herancas = [];
            if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
            
            const heranca = herancas.find(h => h.id === parseInt(id));
            if (!heranca) {
                mostrarNotificacao('Heran√ßa n√£o encontrada!', 'error');
                return;
            }
            
            console.log('‚úÖ Heran√ßa encontrada:', heranca);
            // Abrir modal de edi√ß√£o
            abrirModalEdicaoHeranca(heranca);
        }

        function abrirAnexosHeranca(id) {
            console.log('üîß abrirAnexosHeranca chamado com ID:', id);
            const heranca = herancas.find(h => h.id === parseInt(id));
            console.log('üîß Heran√ßa encontrada:', heranca);
            if (heranca) {
                console.log('üîß Chamando abrirModalAnexos para heran√ßa');
                abrirModalAnexos('heranca', id, heranca.clienteNome || 'Heran√ßa');
            } else {
                console.error('‚ùå Heran√ßa n√£o encontrada com ID:', id);
                mostrarNotificacao('Heran√ßa n√£o encontrada!', 'error');
            }
        }

        function excluirHerancaDireto(id) {
            console.log('üîß excluirHerancaDireto chamado com ID:', id);
            
            if (confirm('Tem certeza que deseja excluir esta heran√ßa? Esta a√ß√£o n√£o pode ser desfeita.')) {
                console.log('üîß Usu√°rio confirmou exclus√£o');
                
                // Carregar dados da heran√ßa
                const herancasSalvas = localStorage.getItem('herancas');
                let herancas = [];
                if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
                
                console.log('üîß Heran√ßas antes da exclus√£o:', herancas.length);
                
                // Filtrar heran√ßa a ser exclu√≠da
                const herancasAtualizadas = herancas.filter(h => h.id !== parseInt(id));
                
                console.log('üîß Heran√ßas ap√≥s exclus√£o:', herancasAtualizadas.length);
                
                // Salvar dados atualizados
                localStorage.setItem('herancas', JSON.stringify(herancasAtualizadas));
                window.herancas = herancasAtualizadas;
                
                console.log('‚úÖ Heran√ßas salvas no localStorage');
                
                mostrarNotificacao('Heran√ßa exclu√≠da com sucesso!', 'success');
                
                // Recarregar se√ß√£o
                setTimeout(() => {
                    console.log('üîß Recarregando se√ß√£o heran√ßas');
                    carregarSecao('herancas');
                    if (typeof atualizarListaHerancas === 'function') {
                        console.log('üîß Chamando atualizarListaHerancas');
                        atualizarListaHerancas(herancasAtualizadas);
                    }
                }, 100);
            }
        }


        // Tornar fun√ß√µes globais
        window.abrirAnexosContrato = abrirAnexosContrato;
        window.abrirAnexosHeranca = abrirAnexosHeranca;
        window.abrirAnexosMigracao = abrirAnexosMigracao;
        window.abrirAnexosRegisto = abrirAnexosRegisto;
        window.abrirModalAnexos = abrirModalAnexos;
        window.visualizarAnexo = visualizarAnexo;
        window.baixarAnexo = baixarAnexo;
        window.adicionarAnexoContrato = adicionarAnexoContrato;
        window.adicionarAnexoHeranca = adicionarAnexoHeranca;
        window.adicionarAnexoMigracao = adicionarAnexoMigracao;
        window.adicionarAnexoRegisto = adicionarAnexoRegisto;
        window.removerAnexoContrato = removerAnexoContrato;
        window.removerAnexoHeranca = removerAnexoHeranca;
        window.removerAnexoMigracao = removerAnexoMigracao;
        
        // VERIFICAR SE FUN√á√ïES EST√ÉO DEFINIDAS
        console.log('üîß VERIFICA√á√ÉO DE FUN√á√ïES:');
        console.log('üîß editarRegistoDireto:', typeof editarRegistoDireto);
        console.log('üîß abrirAnexosRegisto:', typeof abrirAnexosRegisto);
        console.log('üîß excluirRegistoDireto:', typeof excluirRegistoDireto);
        console.log('üîß visualizarAnexo:', typeof visualizarAnexo);
        console.log('üîß baixarAnexo:', typeof baixarAnexo);
        
        // TESTAR FUN√á√ïES DIRETAMENTE
        console.log('üîß TESTANDO FUN√á√ïES:');
        if (typeof editarRegistoDireto === 'function') {
            console.log('‚úÖ editarRegistoDireto est√° definida');
        } else {
            console.error('‚ùå editarRegistoDireto N√ÉO est√° definida');
        }
        
        if (typeof abrirAnexosRegisto === 'function') {
            console.log('‚úÖ abrirAnexosRegisto est√° definida');
        } else {
            console.error('‚ùå abrirAnexosRegisto N√ÉO est√° definida');
        }
        
        if (typeof excluirRegistoDireto === 'function') {
            console.log('‚úÖ excluirRegistoDireto est√° definida');
        } else {
            console.error('‚ùå excluirRegistoDireto N√ÉO est√° definida');
        }
        window.removerAnexoRegisto = removerAnexoRegisto;
        window.toggleTipoPersonalizado = toggleTipoPersonalizado;
        window.atualizarContrato = atualizarContrato;
        window.abrirModalEdicaoContrato = abrirModalEdicaoContrato;
        window.editarContratoDireto = editarContratoDireto;
        window.excluirContratoDireto = excluirContratoDireto;
        window.editarHerancaDireto = editarHerancaDireto;
        window.excluirHerancaDireto = excluirHerancaDireto;
        window.editarMigracaoDireto = editarMigracaoDireto;
        window.excluirMigracaoDireto = excluirMigracaoDireto;
        window.editarRegistoDireto = editarRegistoDireto;
        window.excluirRegistoDireto = excluirRegistoDireto;
        window.abrirModalEdicaoMigracao = abrirModalEdicaoMigracao;
        window.salvarMigracaoEditada = salvarMigracaoEditada;
        window.editarHonorarioDireto = editarHonorarioDireto;
        window.excluirHonorarioDireto = excluirHonorarioDireto;
        window.salvarHonorarioEditado = salvarHonorarioEditado;
        
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function(registration) {
                        console.log('Service Worker registrado com sucesso:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Falha ao registrar Service Worker:', error);
                    });
            });
        }
        
        // Detectar se √© PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', function(e) {
            console.log('PWA pode ser instalado');
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar bot√£o de instala√ß√£o se necess√°rio
            if (deferredPrompt) {
                console.log('PWA pronto para instala√ß√£o');
            }
        });

    </script>
</body>
</html>
